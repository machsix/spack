

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contribution Guide &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=832b3b9f"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Packaging Guide" href="packaging_guide.html" />
    <link rel="prev" title="Using External GPU Support" href="gpu_configuration.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Contribution Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#branches">Branches</a></li>
<li class="toctree-l2"><a class="reference internal" href="#continuous-integration">Continuous Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#style-tests">Style Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#documentation-tests">Documentation Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gitlab-ci">GitLab CI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-cache-stacks">Build Cache Stacks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registering-runners">Registering Runners</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#coverage">Coverage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#git-workflows">Git Workflows</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#branching">Branching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cherry-picking">Cherry-Picking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rebasing">Rebasing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rebasing-with-cherry-pick">Rebasing with cherry-pick</a></li>
<li class="toctree-l3"><a class="reference internal" href="#re-writing-history">Re-writing History</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Contribution Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/contribution_guide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="contribution-guide">
<span id="id1"></span><h1>Contribution Guide<a class="headerlink" href="#contribution-guide" title="Link to this heading"></a></h1>
<p>This guide is intended for developers or administrators who want to
contribute a new package, feature, or bugfix to Spack.
It assumes that you have at least some familiarity with Git VCS and Github.
The guide will show a few examples of contributing workflows and discuss
the granularity of pull-requests (PRs). It will also discuss the tests your
PR must pass in order to be accepted into Spack.</p>
<p>First, what is a PR? Quoting <a class="reference external" href="https://www.atlassian.com/git/tutorials/making-a-pull-request/">Bitbucket’s tutorials</a>:</p>
<blockquote>
<div><p>Pull requests are a mechanism for a developer to notify team members that
they have <strong>completed a feature</strong>. The pull request is more than just a
notification—it’s a dedicated forum for discussing the proposed feature.</p>
</div></blockquote>
<p>Important is <strong>completed feature</strong>. The changes one proposes in a PR should
correspond to one feature/bugfix/extension/etc. One can create PRs with
changes relevant to different ideas, however reviewing such PRs becomes tedious
and error prone. If possible, try to follow the <strong>one-PR-one-package/feature</strong> rule.</p>
<section id="branches">
<h2>Branches<a class="headerlink" href="#branches" title="Link to this heading"></a></h2>
<p>Spack’s <code class="docutils literal notranslate"><span class="pre">develop</span></code> branch has the latest contributions. Nearly all pull
requests should start from <code class="docutils literal notranslate"><span class="pre">develop</span></code> and target <code class="docutils literal notranslate"><span class="pre">develop</span></code>.</p>
<p>There is a branch for each major release series. Release branches
originate from <code class="docutils literal notranslate"><span class="pre">develop</span></code> and have tags for each point release in the
series. For example, <code class="docutils literal notranslate"><span class="pre">releases/v0.14</span></code> has tags for <code class="docutils literal notranslate"><span class="pre">0.14.0</span></code>,
<code class="docutils literal notranslate"><span class="pre">0.14.1</span></code>, <code class="docutils literal notranslate"><span class="pre">0.14.2</span></code>, etc. versions of Spack. We backport important bug
fixes to these branches, but we do not advance the package versions or
make other changes that would change the way Spack concretizes
dependencies. Currently, the maintainers manage these branches by
cherry-picking from <code class="docutils literal notranslate"><span class="pre">develop</span></code>. See <a class="reference internal" href="developer_guide.html#releases"><span class="std std-ref">Releases</span></a> for more
information.</p>
</section>
<section id="continuous-integration">
<h2>Continuous Integration<a class="headerlink" href="#continuous-integration" title="Link to this heading"></a></h2>
<p>Spack uses <a class="reference external" href="https://docs.github.com/en/actions">Github Actions</a> for Continuous Integration
testing. This means that every time you submit a pull request, a series of tests will
be run to make sure you didn’t accidentally introduce any bugs into Spack. <strong>Your PR
will not be accepted until it passes all of these tests.</strong> While you can certainly wait
for the results of these tests after submitting a PR, we recommend that you run them
locally to speed up the review process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Oftentimes, CI will fail for reasons other than a problem with your PR.
For example, apt-get, pip, or homebrew will fail to download one of the
dependencies for the test suite, or a transient bug will cause the unit tests
to timeout. If any job fails, click the “Details” link and click on the test(s)
that is failing. If it doesn’t look like it is failing for reasons related to
your PR, you have two options. If you have write permissions for the Spack
repository, you should see a “Restart workflow” button on the right-hand side. If
not, you can close and reopen your PR to rerun all of the tests. If the same
test keeps failing, there may be a problem with your PR. If you notice that
every recent PR is failing with the same error message, it may be that an issue
occurred with the CI infrastructure or one of Spack’s dependencies put out a
new release that is causing problems. If this is the case, please file an issue.</p>
</div>
<p>We currently test against Python 2.7 and 3.6-3.10 on both macOS and Linux and
perform 3 types of tests:</p>
<section id="unit-tests">
<span id="cmd-spack-unit-test"></span><h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Link to this heading"></a></h3>
<p>Unit tests ensure that core Spack features like fetching or spec resolution are
working as expected. If your PR only adds new packages or modifies existing ones,
there’s very little chance that your changes could cause the unit tests to fail.
However, if you make changes to Spack’s core libraries, you should run the unit
tests to make sure you didn’t break anything.</p>
<p>Since they test things like fetching from VCS repos, the unit tests require
<a class="reference external" href="https://git-scm.com/">git</a>, <a class="reference external" href="https://www.mercurial-scm.org/">mercurial</a>,
and <a class="reference external" href="https://subversion.apache.org/">subversion</a> to run. Make sure these are
installed on your system and can be found in your <code class="docutils literal notranslate"><span class="pre">PATH</span></code>. All of these can be
installed with Spack or with your system package manager.</p>
<p>To run <em>all</em> of the unit tests, use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>unit-test
</pre></div>
</div>
<p>These tests may take several minutes to complete. If you know you are
only modifying a single Spack feature, you can run subsets of tests at a
time.  For example, this would run all the tests in
<code class="docutils literal notranslate"><span class="pre">lib/spack/spack/test/architecture.py</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>unit-test<span class="w"> </span>lib/spack/spack/test/architecture.py
</pre></div>
</div>
<p>And this would run the <code class="docutils literal notranslate"><span class="pre">test_platform</span></code> test from that file:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>unit-test<span class="w"> </span>lib/spack/spack/test/architecture.py::test_platform
</pre></div>
</div>
<p>This allows you to develop iteratively: make a change, test that change,
make another change, test that change, etc.  We use <a class="reference external" href="http://pytest.org/">pytest</a> as our tests framework, and these types of
arguments are just passed to the <code class="docutils literal notranslate"><span class="pre">pytest</span></code> command underneath. See <a class="reference external" href="https://doc.pytest.org/en/latest/how-to/usage.html#specifying-which-tests-to-run">the
pytest docs</a>
for more details on test selection syntax.</p>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">unit-test</span></code> has a few special options that can help you
understand what tests are available.  To get a list of all available
unit test files, run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack unit-test --list
==&gt; Fetching https://ghcr.io/v2/spack/bootstrap-buildcache-v1/blobs/sha256:9ac106d746fc9830acbb2e6b135a5c1748482df8fe115bee2deb1ed02e5189c4
==&gt; Fetching https://ghcr.io/v2/spack/bootstrap-buildcache-v1/blobs/sha256:6599ac06ade0cb3e80695f36492ea94a306f8bde0537482521510076c5981aa0
==&gt; Installing &quot;clingo-bootstrap@=spack%gcc@=10.2.1~docs+ipo+optimized+python+static_libstdcpp build_system=cmake build_type=Release generator=make patches=bebb819,ec99431 arch=linux-centos7-x86_64&quot; from a buildcache
lib/spack/spack/test/abi_splicing.py                      lib/spack/spack/test/cray_manifest.py
lib/spack/spack/test/architecture.py                      lib/spack/spack/test/cvs_fetch.py
...
</pre></div>
</div>
<p>To see a more detailed list of available unit tests, use <code class="docutils literal notranslate"><span class="pre">spack</span>
<span class="pre">unit-test</span> <span class="pre">--list-long</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack unit-test --list-long
lib/spack/spack/test/abi_splicing.py::
    test_double_splice                             test_splice_build_splice_node
    test_external_splice_same_name                 test_splice_installed_hash
    test_manyvariant_limited_matching              test_spliced_build_deps_only_in_build_spec
    test_manyvariant_star_matching_variant_splice  test_spliced_transitive_dependency
    test_simple_dep_reuse                          test_virtual_multi_can_be_spliced
    test_simple_reuse                              test_virtual_multi_splices_in

lib/spack/spack/test/architecture.py::
    test_arch_spec_container_semantic  test_operating_system_conversion_to_dict          test_user_input_combination
...
</pre></div>
</div>
<p>And to see the fully qualified names of all tests, use <code class="docutils literal notranslate"><span class="pre">--list-names</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack unit-test --list-names
lib/spack/spack/test/abi_splicing.py::test_double_splice
lib/spack/spack/test/abi_splicing.py::test_external_splice_same_name
lib/spack/spack/test/abi_splicing.py::test_manyvariant_limited_matching
lib/spack/spack/test/abi_splicing.py::test_manyvariant_star_matching_variant_splice
lib/spack/spack/test/abi_splicing.py::test_simple_dep_reuse
...
</pre></div>
</div>
<p>You can combine these with <code class="docutils literal notranslate"><span class="pre">pytest</span></code> arguments to restrict which tests
you want to know about.  For example, to see just the tests in
<code class="docutils literal notranslate"><span class="pre">architecture.py</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack unit-test --list-long lib/spack/spack/test/architecture.py
lib/spack/spack/test/architecture.py::
    test_arch_spec_container_semantic  test_operating_system_conversion_to_dict          test_user_input_combination
    test_concretize_target_ranges      test_platform
    test_default_os_and_target         test_satisfy_strict_constraint_when_not_concrete
</pre></div>
</div>
<p>You can also combine any of these options with a <code class="docutils literal notranslate"><span class="pre">pytest</span></code> keyword
search.  See the <a class="reference external" href="https://doc.pytest.org/en/latest/how-to/usage.html#specifying-which-tests-to-run">pytest usage docs</a>
for more details on test selection syntax. For example, to see the names of all tests that have “spec”
or “concretize” somewhere in their names:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack unit-test --list-names -k &quot;spec and concretize&quot;
lib/spack/spack/test/cmd/build_env.py::test_concretize_user_specs_together
lib/spack/spack/test/cmd/build_env.py::test_roundtrip_spack_yaml_with_comments
lib/spack/spack/test/cmd/build_env.py::test_virtual_spec_concretize_together
lib/spack/spack/test/cmd/mirror.py::TestMirrorCreate::test_all_specs_with_all_versions_dont_concretize
lib/spack/spack/test/cmd/spec.py::test_spec_concretizer_args
lib/spack/spack/test/concretization/core.py::TestConcretize::test_best_effort_coconcretize
lib/spack/spack/test/concretization/core.py::TestConcretize::test_best_effort_coconcretize_preferences
lib/spack/spack/test/concretization/core.py::TestConcretize::test_concrete_specs_are_not_modified_on_reuse
lib/spack/spack/test/concretization/core.py::TestConcretize::test_concretize_propagate_specified_variant
lib/spack/spack/test/concretization/core.py::TestConcretize::test_conflicts_in_spec
lib/spack/spack/test/concretization/core.py::TestConcretize::test_exclude_specs_from_reuse
lib/spack/spack/test/concretization/core.py::TestConcretize::test_external_package_versions
lib/spack/spack/test/concretization/core.py::TestConcretize::test_git_ref_version_is_equivalent_to_specified_version
lib/spack/spack/test/concretization/core.py::TestConcretize::test_include_specs_from_externals_and_libcs
lib/spack/spack/test/concretization/core.py::TestConcretize::test_installed_specs_disregard_conflicts
lib/spack/spack/test/concretization/core.py::TestConcretize::test_mv_variants_disjoint_sets_from_spec
lib/spack/spack/test/concretization/core.py::TestConcretize::test_no_conflict_in_external_specs
lib/spack/spack/test/concretization/core.py::TestConcretize::test_no_matching_compiler_specs
lib/spack/spack/test/concretization/core.py::TestConcretize::test_result_specs_is_not_empty
lib/spack/spack/test/concretization/core.py::TestConcretize::test_reuse_does_not_overwrite_dev_specs
lib/spack/spack/test/concretization/core.py::TestConcretize::test_reuse_specs_from_non_available_compilers
lib/spack/spack/test/concretization/core.py::TestConcretize::test_simultaneous_concretization_of_specs
lib/spack/spack/test/concretization/core.py::TestConcretize::test_spec_flags_maintain_order
lib/spack/spack/test/concretization/core.py::TestConcretize::test_spec_with_build_dep_from_json
lib/spack/spack/test/concretization/core.py::TestConcretize::test_unsolved_specs_raises_error
lib/spack/spack/test/concretization/core.py::TestConcretizeSeparately::test_specifying_different_versions_build_deps
lib/spack/spack/test/spec_dag.py::TestSpecDag::test_concretize_deptypes
lib/spack/spack/test/spec_dag.py::TestSpecDag::test_copy_concretized
lib/spack/spack/test/spec_semantics.py::test_concretize_partial_old_dag_hash_spec
lib/spack/spack/test/spec_semantics.py::test_intersects_and_satisfies_on_concretized_spec
</pre></div>
</div>
<p>By default, <code class="docutils literal notranslate"><span class="pre">pytest</span></code> captures the output of all unit tests, and it will
print any captured output for failed tests. Sometimes it’s helpful to see
your output interactively, while the tests run (e.g., if you add print
statements to a unit tests).  To see the output <em>live</em>, use the <code class="docutils literal notranslate"><span class="pre">-s</span></code>
argument to <code class="docutils literal notranslate"><span class="pre">pytest</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>unit-test<span class="w"> </span>-s<span class="w"> </span>--list-long<span class="w"> </span>lib/spack/spack/test/architecture.py::test_platform
</pre></div>
</div>
<p>Unit tests are crucial to making sure bugs aren’t introduced into
Spack. If you are modifying core Spack libraries or adding new
functionality, please add new unit tests for your feature, and consider
strengthening existing tests.  You will likely be asked to do this if you
submit a pull request to the Spack project on GitHub.  Check out the
<a class="reference external" href="http://pytest.org/">pytest docs</a> and feel free to ask for guidance on
how to write tests!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may notice the <code class="docutils literal notranslate"><span class="pre">share/spack/qa/run-unit-tests</span></code> script in the
repository.  This script is designed for CI.  It runs the unit
tests and reports coverage statistics back to Codecov. If you want to
run the unit tests yourself, we suggest you use <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">unit-test</span></code>.</p>
</div>
</section>
<section id="style-tests">
<h3>Style Tests<a class="headerlink" href="#style-tests" title="Link to this heading"></a></h3>
<p>Spack uses <a class="reference external" href="http://flake8.pycqa.org/en/latest/">Flake8</a> to test for
<a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP 8</a> conformance and
<a class="reference external" href="https://mypy.readthedocs.io/en/stable/">mypy</a> for type checking. PEP 8 is
a series of style guides for Python that provide suggestions for everything
from variable naming to indentation. In order to limit the number of PRs that
were mostly style changes, we decided to enforce PEP 8 conformance. Your PR
needs to comply with PEP 8 in order to be accepted, and if it modifies the
spack library it needs to successfully type-check with mypy as well.</p>
<p>Testing for compliance with spack’s style is easy. Simply run the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">style</span></code>
command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>style
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">style</span></code> has a couple advantages over running the tools by hand:</p>
<ol class="arabic simple">
<li><p>It only tests files that you have modified since branching off of
<code class="docutils literal notranslate"><span class="pre">develop</span></code>.</p></li>
<li><p>It works regardless of what directory you are in.</p></li>
<li><p>It automatically adds approved exemptions from the <code class="docutils literal notranslate"><span class="pre">flake8</span></code>
checks. For example, URLs are often longer than 80 characters, so we
exempt them from line length checks. We also exempt lines that start
with “homepage”, “url”, “version”, “variant”, “depends_on”, and
“extends” in <code class="docutils literal notranslate"><span class="pre">package.py</span></code> files.  This is now also possible when directly
running flake8 if you can use the <code class="docutils literal notranslate"><span class="pre">spack</span></code> formatter plugin included with
spack.</p></li>
</ol>
<p>More approved flake8 exemptions can be found
<a class="reference external" href="https://github.com/spack/spack/blob/develop/.flake8">here</a>.</p>
<p>If all is well, you’ll see something like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>run-flake8-tests
<span class="go">Dependencies found.</span>
<span class="go">=======================================================</span>
<span class="go">flake8: running flake8 code checks on spack.</span>

<span class="go">Modified files:</span>

<span class="go">  var/spack/repos/builtin/packages/hdf5/package.py</span>
<span class="go">  var/spack/repos/builtin/packages/hdf/package.py</span>
<span class="go">  var/spack/repos/builtin/packages/netcdf/package.py</span>
<span class="go">=======================================================</span>
<span class="go">Flake8 checks were clean.</span>
</pre></div>
</div>
<p>However, if you aren’t compliant with PEP 8, flake8 will complain:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">var/spack/repos/builtin/packages/netcdf/package.py:26: [F401] &#39;os&#39; imported but unused</span>
<span class="go">var/spack/repos/builtin/packages/netcdf/package.py:61: [E303] too many blank lines (2)</span>
<span class="go">var/spack/repos/builtin/packages/netcdf/package.py:106: [E501] line too long (92 &gt; 79 characters)</span>
<span class="go">Flake8 found errors.</span>
</pre></div>
</div>
<p>Most of the error messages are straightforward, but if you don’t understand what
they mean, just ask questions about them when you submit your PR. The line numbers
will change if you add or delete lines, so simply run <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">style</span></code> again
to update them.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Try fixing flake8 errors in reverse order. This eliminates the need for
multiple runs of <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">style</span></code> just to re-compute line numbers and
makes it much easier to fix errors directly off of the CI output.</p>
</div>
</section>
<section id="documentation-tests">
<h3>Documentation Tests<a class="headerlink" href="#documentation-tests" title="Link to this heading"></a></h3>
<p>Spack uses <a class="reference external" href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> to build its
documentation. In order to prevent things like broken links and missing imports,
we added documentation tests that build the documentation and fail if there
are any warning or error messages.</p>
<p>Building the documentation requires several dependencies:</p>
<ul class="simple">
<li><p>sphinx</p></li>
<li><p>sphinxcontrib-programoutput</p></li>
<li><p>sphinx-rtd-theme</p></li>
<li><p>graphviz</p></li>
<li><p>git</p></li>
<li><p>mercurial</p></li>
<li><p>subversion</p></li>
</ul>
<p>All of these can be installed with Spack, e.g.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>py-sphinx<span class="w"> </span>py-sphinxcontrib-programoutput<span class="w"> </span>py-sphinx-rtd-theme<span class="w"> </span>graphviz<span class="w"> </span>git<span class="w"> </span>mercurial<span class="w"> </span>subversion
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Sphinx has <a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/py-sphinx/package.py">several required dependencies</a>.
If you’re using a <code class="docutils literal notranslate"><span class="pre">python</span></code> from Spack and you installed
<code class="docutils literal notranslate"><span class="pre">py-sphinx</span></code> and friends, you need to make them available to your
<code class="docutils literal notranslate"><span class="pre">python</span></code>. The easiest way to do this is to run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>load<span class="w"> </span>py-sphinx<span class="w"> </span>py-sphinx-rtd-theme<span class="w"> </span>py-sphinxcontrib-programoutput
</pre></div>
</div>
<p>so that all of the dependencies are added to PYTHONPATH.  If you see an error message
like:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Extension error:</span>
<span class="go">Could not import extension sphinxcontrib.programoutput (exception: No module named sphinxcontrib.programoutput)</span>
<span class="go">make: *** [html] Error 1</span>
</pre></div>
</div>
<p>that means Sphinx couldn’t find <code class="docutils literal notranslate"><span class="pre">py-sphinxcontrib-programoutput</span></code> in your
<code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code>.</p>
</div>
<p>Once all of the dependencies are installed, you can try building the documentation:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>path/to/spack/lib/spack/docs/
<span class="gp">$ </span>make<span class="w"> </span>clean
<span class="gp">$ </span>make
</pre></div>
</div>
<p>If you see any warning or error messages, you will have to correct those before your PR
is accepted. If you are editing the documentation, you should be running the
documentation tests to make sure there are no errors. Documentation changes can result
in some obfuscated warning messages. If you don’t understand what they mean, feel free
to ask when you submit your PR.</p>
</section>
<section id="gitlab-ci">
<span id="spack-builders-and-pipelines"></span><h3>GitLab CI<a class="headerlink" href="#gitlab-ci" title="Link to this heading"></a></h3>
<section id="build-cache-stacks">
<h4>Build Cache Stacks<a class="headerlink" href="#build-cache-stacks" title="Link to this heading"></a></h4>
<p>Spack welcomes the contribution of software stacks of interest to the community. These
stacks are used to test package recipes and generate publicly available build caches.
Spack uses GitLab CI for managing the orchestration of build jobs.</p>
<section id="gitlab-entry-point">
<h5>GitLab Entry Point<a class="headerlink" href="#gitlab-entry-point" title="Link to this heading"></a></h5>
<p>Add stack entrypoint to the <code class="docutils literal notranslate"><span class="pre">share/spack/gitlab/cloud_pipelines/.gitlab-ci.yml</span></code>. There
are two stages required for each new stack, the generation stage and the build stage.</p>
<p>The generate stage is defined using the job template <code class="docutils literal notranslate"><span class="pre">.generate</span></code> configured with
environment variables defining the name of the stack in <code class="docutils literal notranslate"><span class="pre">SPACK_CI_STACK_NAME</span></code> and the
platform (<code class="docutils literal notranslate"><span class="pre">SPACK_TARGET_PLATFORM</span></code>) and architecture (<code class="docutils literal notranslate"><span class="pre">SPACK_TARGET_ARCH</span></code>) configuration,
and the tags associated with the class of runners to build on.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SPACK_CI_STACK_NAME</span></code> must match the name of the directory containing the
stacks <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The platform and architecture variables are specified in order to select the
correct configurations from the generic configurations used in Spack CI. The
configurations currently available are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.cray_rhel_zen4</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.cray_sles_zen4</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.darwin_aarch64</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.darwin_x86_64</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_aarch64</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_icelake</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_neoverse_n1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_neoverse_v1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_neoverse_v2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_power</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_skylake</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_x86_64</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.linux_x86_64_v4</span></code></p></li>
</ul>
<p>New configurations can be added to accommodate new platforms and architectures.</p>
</div>
<p>The build stage is defined as a trigger job that consumes the GitLab CI pipeline generated in
the generate stage for this stack. Build stage jobs use the <code class="docutils literal notranslate"><span class="pre">.build</span></code> job template which
handles the basic configuration.</p>
<p>An example entry point for a new stack called <code class="docutils literal notranslate"><span class="pre">my-super-cool-stack</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">.my-super-cool-stack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extends</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;.linux_x86_64_v3&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">SPACK_CI_STACK_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-super-cool-stack</span>
<span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;tags&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;your&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;job&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;needs&quot;</span><span class="p p-Indicator">]</span>

<span class="nt">my-super-cool-stack-generate</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extends</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;.generate&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;.my-super-cool-stack&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-super-cool-stack-image:0.0.1</span>

<span class="nt">my-super-cool-stack-build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extends</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;.build&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;.my-super-cool-stack&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">trigger</span><span class="p">:</span>
<span class="w">    </span><span class="nt">include</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">artifact</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jobs_scratch_dir/cloud-ci-pipeline.yml</span>
<span class="w">        </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-super-cool-stack-generate</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">depend</span>
<span class="w">  </span><span class="nt">needs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">artifacts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">      </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-super-cool-stack-generate</span>
</pre></div>
</div>
</section>
<section id="stack-configuration">
<h5>Stack Configuration<a class="headerlink" href="#stack-configuration" title="Link to this heading"></a></h5>
<p>The stack configuration is a spack environment file with two additional sections added.
Stack configurations should be located in <code class="docutils literal notranslate"><span class="pre">share/spack/gitlab/cloud_pipelines/stacks/&lt;stack_name&gt;/spack.yaml</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ci</span></code> section is generally used to define stack specific mappings such as image or tags.
For more information on what can go into the <code class="docutils literal notranslate"><span class="pre">ci</span></code> section refer to the docs on pipelines.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cdash</span></code> section is used for defining where to upload the results of builds. Spack configures
most of the details for posting pipeline results to
<a class="reference external" href="https://cdash.spack.io/index.php?project=Spack+Testing">cdash.spack.io</a>. The only
requirement in the stack configuration is to define a <code class="docutils literal notranslate"><span class="pre">build-group</span></code> that is unique,
this is usually the long name of the stack.</p>
<p>An example stack that builds <code class="docutils literal notranslate"><span class="pre">zlib</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">packages</span><span class="p">:</span>
<span class="w">    </span><span class="nt">all</span><span class="p">:</span>
<span class="w">      </span><span class="nt">require</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;%gcc&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;target=x86_64_v3&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib</span>

<span class="w">  </span><span class="nt">ci</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">pipeline-gen</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">- build-job</span><span class="p p-Indicator">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-super-cool-stack-image:0.0.1</span>

<span class="w">  </span><span class="nt">cdash</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build-group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">My Super Cool Stack</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">image</span></code> used in the <code class="docutils literal notranslate"><span class="pre">*-generate</span></code> job must match exactly the <code class="docutils literal notranslate"><span class="pre">image</span></code> used in the <code class="docutils literal notranslate"><span class="pre">build-job</span></code>.
When the images do not match the build job may fail.</p>
</div>
</section>
</section>
<section id="registering-runners">
<h4>Registering Runners<a class="headerlink" href="#registering-runners" title="Link to this heading"></a></h4>
<p>Contributing computational resources to Spack’s CI build farm is one way to help expand the
capabilities and offerings of the public Spack build caches. Currently, Spack utilizes linux runners
from AWS, Google, and the University of Oregon (UO).</p>
<p>Runners require three key peices:
* Runner Registration Token
* Accurate tags
* OIDC Authentication script
* GPG keys</p>
<p>Minimum GitLab Runner Version: <code class="docutils literal notranslate"><span class="pre">16.1.0</span></code>
<a class="reference external" href="https://docs.gitlab.com/runner/install/">Intallation instructions</a></p>
<section id="registration-token">
<h5>Registration Token<a class="headerlink" href="#registration-token" title="Link to this heading"></a></h5>
<p>The first step to contribute new runners is to open an issue in the <a class="reference external" href="https://github.com/spack/spack-infrastructure/issues/new?assignees=&amp;labels=runner-registration&amp;projects=&amp;template=runner_registration.yml">spack infrastructure</a>
project. This will be reported to the spack infrastructure team who will guide users through the process
of registering new runners for Spack CI.</p>
<p>The information needed to register a runner is the motivation for the new resources, a semi-detailed description of
the runner, and finallly the point of contact for maintaining the software on the runner.</p>
<p>The point of contact will then work with the infrastruture team to obtain runner registration token(s) for interacting with
with Spack’s GitLab instance. Once the runner is active, this point of contact will also be responsible for updating the
GitLab runner software to keep pace with Spack’s Gitlab.</p>
</section>
<section id="tagging">
<h5>Tagging<a class="headerlink" href="#tagging" title="Link to this heading"></a></h5>
<p>In the initial stages of runner registration it is important to <strong>exclude</strong> the special tag <code class="docutils literal notranslate"><span class="pre">spack</span></code>. This will prevent
the new runner(s) from being picked up for production CI jobs while it is configured and evaluated. Once it is determined
that the runner is ready for production use the <code class="docutils literal notranslate"><span class="pre">spack</span></code> tag will be added.</p>
<p>Because gitlab has no concept of tag exclustion, runners that provide specialized resource also require specialized tags.
For example, a basic CPU only x86_64 runner may have a tag <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> associated with it. However, a runner containing an
CUDA capable GPU may have the tag <code class="docutils literal notranslate"><span class="pre">x86_64-cuda</span></code> to denote that it should only be used for packages that will benefit from
a CUDA capable resource.</p>
</section>
<section id="oidc">
<h5>OIDC<a class="headerlink" href="#oidc" title="Link to this heading"></a></h5>
<p>Spack runners use OIDC authentication for connecting to the appropriate AWS bucket
which is used for coordinating the communication of binaries between build jobs. In
order to configure OIDC authentication, Spack CI runners use a python script with minimal
dependencies. This script can be configured for runners as seen here using the <code class="docutils literal notranslate"><span class="pre">pre_build_script</span></code>.</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[[runners]]</span>
<span class="w">  </span><span class="n">pre_build_script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  echo &#39;Executing Spack pre-build setup script&#39;</span>

<span class="s2">  for cmd in &quot;${PY3:-}&quot; python3 python; do</span>
<span class="s2">    if command -v &gt; /dev/null &quot;$cmd&quot;; then</span>
<span class="s2">      export PY3=&quot;$(command -v &quot;$cmd&quot;)&quot;</span>
<span class="s2">      break</span>
<span class="s2">    fi</span>
<span class="s2">  done</span>

<span class="s2">  if [ -z &quot;${PY3:-}&quot; ]; then</span>
<span class="s2">    echo &quot;Unable to find python3 executable&quot;</span>
<span class="s2">    exit 1</span>
<span class="s2">  fi</span>

<span class="s2">  $PY3 -c &quot;import urllib.request;urllib.request.urlretrieve(&#39;https://raw.githubusercontent.com/spack/spack-infrastructure/main/scripts/gitlab_runner_pre_build/pre_build.py&#39;, &#39;pre_build.py&#39;)&quot;</span>
<span class="s2">  $PY3 pre_build.py &gt; envvars</span>

<span class="s2">  . ./envvars</span>
<span class="s2">  rm -f envvars</span>
<span class="s2">  unset GITLAB_OIDC_TOKEN</span>
<span class="s2">  &quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="gpg-keys">
<h5>GPG Keys<a class="headerlink" href="#gpg-keys" title="Link to this heading"></a></h5>
<p>Runners that may be utilized for <code class="docutils literal notranslate"><span class="pre">protected</span></code> CI require the registration of an intermediate signing key that
can be used to sign packages. For more information on package signing read <a class="reference internal" href="signing.html#key-architecture"><span class="std std-ref">Key Architecture</span></a>.</p>
</section>
</section>
</section>
</section>
<section id="coverage">
<h2>Coverage<a class="headerlink" href="#coverage" title="Link to this heading"></a></h2>
<p>Spack uses <a class="reference external" href="https://codecov.io/">Codecov</a> to generate and report unit test
coverage. This helps us tell what percentage of lines of code in Spack are
covered by unit tests. Although code covered by unit tests can still contain
bugs, it is much less error prone than code that is not covered by unit tests.</p>
<p>Codecov provides <a class="reference external" href="https://github.com/codecov/sourcegraph-codecov">browser extensions</a>
for Google Chrome and Firefox. These extensions integrate with GitHub
and allow you to see coverage line-by-line when viewing the Spack repository.
If you are new to Spack, a great way to get started is to write unit tests to
increase coverage!</p>
<p>Unlike with CI on Github Actions Codecov tests are not required to pass in order for your
PR to be merged. If you modify core Spack libraries, we would greatly
appreciate unit tests that cover these changed lines. Otherwise, we have no
way of knowing whether or not your changes introduce a bug. If you make
substantial changes to the core, we may request unit tests to increase coverage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the only files you modified are package files, we do not care about
coverage on your PR. You may notice that the Codecov tests fail even though
you didn’t modify any core files. This means that Spack’s overall coverage
has increased since you branched off of develop. This is a good thing!
If you really want to get the Codecov tests to pass, you can rebase off of
the latest develop, but again, this is not required.</p>
</div>
</section>
<section id="git-workflows">
<h2>Git Workflows<a class="headerlink" href="#git-workflows" title="Link to this heading"></a></h2>
<p>Spack is still in the beta stages of development. Most of our users run off of
the develop branch, and fixes and new features are constantly being merged. So
how do you keep up-to-date with upstream while maintaining your own local
differences and contributing PRs to Spack?</p>
<section id="branching">
<h3>Branching<a class="headerlink" href="#branching" title="Link to this heading"></a></h3>
<p>The easiest way to contribute a pull request is to make all of your changes on
new branches. Make sure your <code class="docutils literal notranslate"><span class="pre">develop</span></code> is up-to-date and create a new branch
off of it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>pull<span class="w"> </span>upstream<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>branch<span class="w"> </span>&lt;descriptive_branch_name&gt;
<span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>&lt;descriptive_branch_name&gt;
</pre></div>
</div>
<p>Here we assume that the local <code class="docutils literal notranslate"><span class="pre">develop</span></code> branch tracks the upstream develop
branch of Spack. This is not a requirement and you could also do the same with
remote branches. But for some it is more convenient to have a local branch that
tracks upstream.</p>
<p>Normally we prefer that commits pertaining to a package <code class="docutils literal notranslate"><span class="pre">&lt;package-name&gt;</span></code> have
a message <code class="docutils literal notranslate"><span class="pre">&lt;package-name&gt;:</span> <span class="pre">descriptive</span> <span class="pre">message</span></code>. It is important to add
descriptive message so that others, who might be looking at your changes later
(in a year or maybe two), would understand the rationale behind them.</p>
<p>Now, you can make your changes while keeping the <code class="docutils literal notranslate"><span class="pre">develop</span></code> branch pure.
Edit a few files and commit them by running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>&lt;files_to_be_part_of_the_commit&gt;
<span class="gp">$ </span>git<span class="w"> </span>commit<span class="w"> </span>--message<span class="w"> </span>&lt;descriptive_message_of_this_particular_commit&gt;
</pre></div>
</div>
<p>Next, push it to your remote fork and create a PR:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>&lt;descriptive_branch_name&gt;<span class="w"> </span>--set-upstream
</pre></div>
</div>
<p>GitHub provides a <a class="reference external" href="https://help.github.com/articles/about-pull-requests/">tutorial</a>
on how to file a pull request. When you send the request, make <code class="docutils literal notranslate"><span class="pre">develop</span></code> the
destination branch.</p>
<p>If you need this change immediately and don’t have time to wait for your PR to
be merged, you can always work on this branch. But if you have multiple PRs,
another option is to maintain a Frankenstein branch that combines all of your
other branches:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>co<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>branch<span class="w"> </span>&lt;your_modified_develop_branch&gt;
<span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>&lt;your_modified_develop_branch&gt;
<span class="gp">$ </span>git<span class="w"> </span>merge<span class="w"> </span>&lt;descriptive_branch_name&gt;
</pre></div>
</div>
<p>This can be done with each new PR you submit. Just make sure to keep this local
branch up-to-date with upstream <code class="docutils literal notranslate"><span class="pre">develop</span></code> too.</p>
</section>
<section id="cherry-picking">
<h3>Cherry-Picking<a class="headerlink" href="#cherry-picking" title="Link to this heading"></a></h3>
<p>What if you made some changes to your local modified develop branch and already
committed them, but later decided to contribute them to Spack? You can use
cherry-picking to create a new branch with only these commits.</p>
<p>First, check out your local modified develop branch:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>&lt;your_modified_develop_branch&gt;
</pre></div>
</div>
<p>Now, get the hashes of the commits you want from the output of:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>log
</pre></div>
</div>
<p>Next, create a new branch off of upstream <code class="docutils literal notranslate"><span class="pre">develop</span></code> and copy the commits
that you want in your PR:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>pull<span class="w"> </span>upstream<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>branch<span class="w"> </span>&lt;descriptive_branch_name&gt;
<span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>&lt;descriptive_branch_name&gt;
<span class="gp">$ </span>git<span class="w"> </span>cherry-pick<span class="w"> </span>&lt;hash&gt;
<span class="gp">$ </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>&lt;descriptive_branch_name&gt;<span class="w"> </span>--set-upstream
</pre></div>
</div>
<p>Now you can create a PR from the web-interface of GitHub. The net result is as
follows:</p>
<ol class="arabic simple">
<li><p>You patched your local version of Spack and can use it further.</p></li>
<li><p>You “cherry-picked” these changes in a stand-alone branch and submitted it
as a PR upstream.</p></li>
</ol>
<p>Should you have several commits to contribute, you could follow the same
procedure by getting hashes of all of them and cherry-picking to the PR branch.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important that whenever you change something that might be of
importance upstream, create a pull request as soon as possible. Do not wait
for weeks/months to do this, because:</p>
<ol class="arabic simple">
<li><p>you might forget why you modified certain files</p></li>
<li><p>it could get difficult to isolate this change into a stand-alone clean PR.</p></li>
</ol>
</div>
</section>
<section id="rebasing">
<h3>Rebasing<a class="headerlink" href="#rebasing" title="Link to this heading"></a></h3>
<p>Other developers are constantly making contributions to Spack, possibly on the
same files that your PR changed. If their PR is merged before yours, it can
create a merge conflict. This means that your PR can no longer be automatically
merged without a chance of breaking your changes. In this case, you will be
asked to rebase on top of the latest upstream <code class="docutils literal notranslate"><span class="pre">develop</span></code>.</p>
<p>First, make sure your develop branch is up-to-date:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>pull<span class="w"> </span>upstream<span class="w"> </span>develop
</pre></div>
</div>
<p>Now, we need to switch to the branch you submitted for your PR and rebase it
on top of develop:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>&lt;descriptive_branch_name&gt;
<span class="gp">$ </span>git<span class="w"> </span>rebase<span class="w"> </span>develop
</pre></div>
</div>
<p>Git will likely ask you to resolve conflicts. Edit the file that it says can’t
be merged automatically and resolve the conflict. Then, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>&lt;file_that_could_not_be_merged&gt;
<span class="gp">$ </span>git<span class="w"> </span>rebase<span class="w"> </span>--continue
</pre></div>
</div>
<p>You may have to repeat this process multiple times until all conflicts are resolved.
Once this is done, simply force push your rebased branch to your remote fork:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>push<span class="w"> </span>--force<span class="w"> </span>origin<span class="w"> </span>&lt;descriptive_branch_name&gt;
</pre></div>
</div>
</section>
<section id="rebasing-with-cherry-pick">
<h3>Rebasing with cherry-pick<a class="headerlink" href="#rebasing-with-cherry-pick" title="Link to this heading"></a></h3>
<p>You can also perform a rebase using <code class="docutils literal notranslate"><span class="pre">cherry-pick</span></code>. First, create a temporary
backup branch:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>&lt;descriptive_branch_name&gt;
<span class="gp">$ </span>git<span class="w"> </span>branch<span class="w"> </span>tmp
</pre></div>
</div>
<p>If anything goes wrong, you can always go back to your <code class="docutils literal notranslate"><span class="pre">tmp</span></code> branch.
Now, look at the logs and save the hashes of any commits you would like to keep:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>log
</pre></div>
</div>
<p>Next, go back to the original branch and reset it to <code class="docutils literal notranslate"><span class="pre">develop</span></code>.
Before doing so, make sure that you local <code class="docutils literal notranslate"><span class="pre">develop</span></code> branch is up-to-date
with upstream:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>pull<span class="w"> </span>upstream<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>&lt;descriptive_branch_name&gt;
<span class="gp">$ </span>git<span class="w"> </span>reset<span class="w"> </span>--hard<span class="w"> </span>develop
</pre></div>
</div>
<p>Now you can cherry-pick relevant commits:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>cherry-pick<span class="w"> </span>&lt;hash1&gt;
<span class="gp">$ </span>git<span class="w"> </span>cherry-pick<span class="w"> </span>&lt;hash2&gt;
</pre></div>
</div>
<p>Push the modified branch to your fork:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>push<span class="w"> </span>--force<span class="w"> </span>origin<span class="w"> </span>&lt;descriptive_branch_name&gt;
</pre></div>
</div>
<p>If everything looks good, delete the backup branch:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>branch<span class="w"> </span>--delete<span class="w"> </span>--force<span class="w"> </span>tmp
</pre></div>
</div>
</section>
<section id="re-writing-history">
<h3>Re-writing History<a class="headerlink" href="#re-writing-history" title="Link to this heading"></a></h3>
<p>Sometimes you may end up on a branch that has diverged so much from develop
that it cannot easily be rebased. If the current commits history is more of
an experimental nature and only the net result is important, you may rewrite
the history.</p>
<p>First, merge upstream <code class="docutils literal notranslate"><span class="pre">develop</span></code> and reset you branch to it. On the branch
in question, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>merge<span class="w"> </span>develop
<span class="gp">$ </span>git<span class="w"> </span>reset<span class="w"> </span>develop
</pre></div>
</div>
<p>At this point your branch will point to the same commit as develop and
thereby the two are indistinguishable. However, all the files that were
previously modified will stay as such. In other words, you do not lose the
changes you made. Changes can be reviewed by looking at diffs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>status
<span class="gp">$ </span>git<span class="w"> </span>diff
</pre></div>
</div>
<p>The next step is to rewrite the history by adding files and creating commits:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>&lt;files_to_be_part_of_commit&gt;
<span class="gp">$ </span>git<span class="w"> </span>commit<span class="w"> </span>--message<span class="w"> </span>&lt;descriptive_message&gt;
</pre></div>
</div>
<p>After all changed files are committed, you can push the branch to your fork
and create a PR:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>--set-upstream
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="gpu_configuration.html" class="btn btn-neutral float-left" title="Using External GPU Support" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="packaging_guide.html" class="btn btn-neutral float-right" title="Packaging Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>