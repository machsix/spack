

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Environments (spack.yaml, spack.lock) &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=832b3b9f"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Container Images" href="containers.html" />
    <link rel="prev" title="Concretization Settings (concretizer.yaml)" href="build_settings.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Environments (spack.yaml, spack.lock)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-environments">Using Environments</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-managed-environment">Creating a managed Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#activating-an-environment">Activating an Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#independent-environments">Independent Environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-aware-commands">Environment-Aware Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-abstract-specs">Adding Abstract Specs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#concretizing">Concretizing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-an-environment">Installing an Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#developing-packages-in-a-spack-environment">Developing Packages in a Spack Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loading">Loading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#included-concrete-environments">Included Concrete Environments</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-included-environments">Creating included environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-an-included-environment">Updating an included environment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-environments">Configuring Environments</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inline-configurations">Inline configurations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#included-configurations">Included configurations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-precedence">Configuration precedence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#manually-editing-the-specs-list">Manually Editing the Specs List</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spec-concretization">Spec concretization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-matrices">Spec Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-list-references">Spec List References</a></li>
<li class="toctree-l3"><a class="reference internal" href="#speclists-as-constraints">SpecLists as Constraints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#environment-views">Environment Views</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#minimal-view-configuration">Minimal view configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-view-configuration">Advanced view configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#view-projections">View Projections</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#activating-environment-views">Activating environment views</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#generating-depfiles-from-environments">Generating Depfiles from Environments</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#specifying-dependencies-on-generated-make-targets">Specifying dependencies on generated <code class="docutils literal notranslate"><span class="pre">make</span></code> targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-a-subset-of-the-environment">Building a subset of the environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-post-install-hooks">Adding post-install hooks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Environments (spack.yaml, spack.lock)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/environments.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="environments-spack-yaml-spack-lock">
<span id="environments"></span><h1>Environments (spack.yaml, spack.lock)<a class="headerlink" href="#environments-spack-yaml-spack-lock" title="Link to this heading"></a></h1>
<p>An environment is used to group a set of specs intended for some purpose
to be built, rebuilt, and deployed in a coherent fashion. Environments
define aspects of the installation of the software, such as:</p>
<ol class="arabic simple">
<li><p><em>which</em> specs to install;</p></li>
<li><p><em>how</em> those specs are configured; and</p></li>
<li><p><em>where</em> the concretized software will be installed.</p></li>
</ol>
<p>Aggregating this information into an environment for processing has advantages
over the <em>à la carte</em> approach of building and loading individual Spack modules.</p>
<p>With environments, you concretize, install, or load (activate) all of the
specs with a single command. Concretization fully configures the specs
and dependencies of the environment in preparation for installing the
software. This is a more robust solution than ad-hoc installation scripts.
And you can share an environment or even re-use it on a different computer.</p>
<p>Environment definitions, especially <em>how</em> specs are configured, allow the
software to remain stable and repeatable even when Spack packages are upgraded. Changes are only picked up when the environment is explicitly re-concretized.</p>
<p>Defining <em>where</em> specs are installed supports a filesystem view of the
environment. Yet Spack maintains a single installation of the software that
can be re-used across multiple environments.</p>
<p>Activating an environment determines <em>when</em> all of the associated (and
installed) specs are loaded so limits the software loaded to those specs
actually needed by the environment. Spack can even generate a script to
load all modules related to an environment.</p>
<p>Other packaging systems also provide environments that are similar in
some ways to Spack environments; for example, <a class="reference external" href="https://conda.io/docs/user-guide/tasks/manage-environments.html">Conda environments</a> or
<a class="reference external" href="https://docs.python.org/3/tutorial/venv.html">Python Virtual Environments</a>.  Spack environments
provide some distinctive features though:</p>
<ol class="arabic simple">
<li><p>A spec installed “in” an environment is no different from the same
spec installed anywhere else in Spack.</p></li>
<li><p>Spack environments may contain more than one spec of the same
package.</p></li>
</ol>
<p>Spack uses a “manifest and lock” model similar to <a class="reference external" href="https://bundler.io/man/gemfile.5.html">Bundler gemfiles</a> and other package managers.
The environment’s user input file (or manifest), is named <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>.
The lock file, which contains the fully configured and concretized specs,
is named <code class="docutils literal notranslate"><span class="pre">spack.lock</span></code>.</p>
<section id="using-environments">
<span id="environments-using"></span><h2>Using Environments<a class="headerlink" href="#using-environments" title="Link to this heading"></a></h2>
<p>Here we follow a typical use case of creating, concretizing,
installing and loading an environment.</p>
<section id="creating-a-managed-environment">
<h3>Creating a managed Environment<a class="headerlink" href="#creating-a-managed-environment" title="Link to this heading"></a></h3>
<p>An environment is created by:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>myenv
</pre></div>
</div>
<p>The directory <code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/var/spack/environments/myenv</span></code> is created
to manage the environment.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All managed environments by default are stored in the
<code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/var/spack/environments</span></code> folder. This location can be changed
by setting the <code class="docutils literal notranslate"><span class="pre">environments_root</span></code> variable in <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code>.</p>
</div>
<p>Spack creates the file <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>, hidden directory <code class="docutils literal notranslate"><span class="pre">.spack-env</span></code>, and
<code class="docutils literal notranslate"><span class="pre">spack.lock</span></code> file under <code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/var/spack/environments/myenv</span></code>. User
interaction occurs through the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file and the Spack commands
that affect it. Metadata and, by default, the view are stored in the
<code class="docutils literal notranslate"><span class="pre">.spack-env</span></code> directory. When the environment is concretized, Spack creates
the <code class="docutils literal notranslate"><span class="pre">spack.lock</span></code> file with the fully configured specs and dependencies for
the environment.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.spack-env</span></code> subdirectory also contains:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">repo/</span></code>: A subdirectory acting as the repo consisting of the Spack
packages used in the environment. It allows the environment to build
the same, in theory, even on different versions of Spack with different
packages!</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logs/</span></code>: A subdirectory containing the build logs for the packages
in this environment.</p></li>
</ul>
</div></blockquote>
<p>Spack Environments can also be created from either the user input, or
manifest, file or the lockfile. Create an environment from a manifest using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>myenv<span class="w"> </span>spack.yaml
</pre></div>
</div>
<p>The resulting environment is guaranteed to have the same root specs as
the original but may concretize differently in the presence of different
explicit or default configuration settings (e.g., a different version of
Spack or for a different user account).</p>
<p>Create an environment from a <code class="docutils literal notranslate"><span class="pre">spack.lock</span></code> file using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>myenv<span class="w"> </span>spack.lock
</pre></div>
</div>
<p>The resulting environment, when on the same or a compatible machine, is
guaranteed to initially have the same concrete specs as the original.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Environment creation also accepts a full path to the file.</p>
<p>If the path is not under the <code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/var/spack/environments</span></code>
directory then the source is referred to as an
<a class="reference internal" href="#independent-environments"><span class="std std-ref">independent environment</span></a>.</p>
</div>
</section>
<section id="activating-an-environment">
<h3>Activating an Environment<a class="headerlink" href="#activating-an-environment" title="Link to this heading"></a></h3>
<p>To activate an environment, use the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>myenv
</pre></div>
</div>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">activate</span></code> will load the view associated
with the environment into the user environment. The <code class="docutils literal notranslate"><span class="pre">-v,</span>
<span class="pre">--with-view</span></code> argument ensures this behavior, and the <code class="docutils literal notranslate"><span class="pre">-V,</span>
<span class="pre">--without-view</span></code> argument activates the environment without changing
the user environment variables.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-p</span></code> option to the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">activate</span></code> command modifies the
user’s prompt to begin with the environment name in brackets.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>-p<span class="w"> </span>myenv
<span class="gp">[myenv] $ </span>...
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">activate</span></code> command can also be used to create a new environment, if it is
not already defined, by adding the <code class="docutils literal notranslate"><span class="pre">--create</span></code> flag. Managed and independent
environments can both be created using the same flags that <cite>spack env create</cite>
accepts.  If an environment already exists then spack will simply activate it
and ignore the create-specific flags.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>--create<span class="w"> </span>-p<span class="w"> </span>myenv
<span class="gp"># </span>...
<span class="gp"># </span><span class="o">[</span>creates<span class="w"> </span><span class="k">if</span><span class="w"> </span>myenv<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist<span class="w"> </span>yet<span class="o">]</span>
<span class="gp"># </span>...
<span class="gp">[myenv] $ </span>...
</pre></div>
</div>
<p>To deactivate an environment, use the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>deactivate
</pre></div>
</div>
<p>or the shortcut alias</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>despacktivate
</pre></div>
</div>
<p>If the environment was activated with its view, deactivating the
environment will remove the view from the user environment.</p>
</section>
<section id="independent-environments">
<span id="id1"></span><h3>Independent Environments<a class="headerlink" href="#independent-environments" title="Link to this heading"></a></h3>
<p>Independent environments can be located in any directory outside of Spack.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When uninstalling packages, Spack asks the user to confirm the removal of packages
that are still used in a managed environment. This is not the case for independent
environments.</p>
</div>
<p>To create an independent environment, use one of the following commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>--dir<span class="w"> </span>my_env
<span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>./my_env
</pre></div>
</div>
<p>As a shorthand, you can also create an independent environment upon activation if it does not
already exist:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>--create<span class="w"> </span>./my_env
</pre></div>
</div>
<p>For convenience, Spack can also place an independent environment in a temporary directory for you:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>--temp
</pre></div>
</div>
</section>
<section id="environment-aware-commands">
<h3>Environment-Aware Commands<a class="headerlink" href="#environment-aware-commands" title="Link to this heading"></a></h3>
<p>Spack commands are environment-aware. For example, the <code class="docutils literal notranslate"><span class="pre">find</span></code>
command shows only the specs in the active environment if an
environment has been activated. Otherwise it shows all specs in
the Spack instance. The same rule applies to the <code class="docutils literal notranslate"><span class="pre">install</span></code> and
<code class="docutils literal notranslate"><span class="pre">uninstall</span></code> commands.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>find
<span class="go">==&gt; 0 installed packages</span>

<span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>zlib@1.2.11
<span class="go">==&gt; Installing zlib-1.2.11-q6cqrdto4iktfg6qyqcc5u4vmfmwb7iv</span>
<span class="go">==&gt; No binary for zlib-1.2.11-q6cqrdto4iktfg6qyqcc5u4vmfmwb7iv found: installing from source</span>
<span class="go">==&gt; zlib: Executing phase: &#39;install&#39;</span>
<span class="go">[+] ~/spack/opt/spack/linux-rhel7-broadwell/gcc-8.1.0/zlib-1.2.11-q6cqrdto4iktfg6qyqcc5u4vmfmwb7iv</span>

<span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>myenv

<span class="gp">$ </span>spack<span class="w"> </span>find
<span class="go">==&gt; In environment myenv</span>
<span class="go">==&gt; No root specs</span>
<span class="go">==&gt; 0 installed packages</span>

<span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>zlib@1.2.8
<span class="go">==&gt; Installing zlib-1.2.8-yfc7epf57nsfn2gn4notccaiyxha6z7x</span>
<span class="go">==&gt; No binary for zlib-1.2.8-yfc7epf57nsfn2gn4notccaiyxha6z7x found: installing from source</span>
<span class="go">==&gt; zlib: Executing phase: &#39;install&#39;</span>
<span class="go">[+] ~/spack/opt/spack/linux-rhel7-broadwell/gcc-8.1.0/zlib-1.2.8-yfc7epf57nsfn2gn4notccaiyxha6z7x</span>
<span class="go">==&gt; Updating view at ~/spack/var/spack/environments/myenv/.spack-env/view</span>

<span class="gp">$ </span>spack<span class="w"> </span>find
<span class="go">==&gt; In environment myenv</span>
<span class="go">==&gt; Root specs</span>
<span class="go">zlib@1.2.8</span>

<span class="go">==&gt; 1 installed package</span>
<span class="go">-- linux-rhel7-broadwell / gcc@8.1.0 ----------------------------</span>
<span class="go">zlib@1.2.8</span>

<span class="gp">$ </span>despacktivate

<span class="gp">$ </span>spack<span class="w"> </span>find
<span class="go">==&gt; 2 installed packages</span>
<span class="go">-- linux-rhel7-broadwell / gcc@8.1.0 ----------------------------</span>
<span class="go">zlib@1.2.8  zlib@1.2.11</span>
</pre></div>
</div>
<p>Note that when we installed the abstract spec <code class="docutils literal notranslate"><span class="pre">zlib&#64;1.2.8</span></code>, it was
presented as a root of the environment. All explicitly installed
packages will be listed as roots of the environment.</p>
<p>All of the Spack commands that act on the list of installed specs are
environment-aware in this way, including <code class="docutils literal notranslate"><span class="pre">install</span></code>,
<code class="docutils literal notranslate"><span class="pre">uninstall</span></code>, <code class="docutils literal notranslate"><span class="pre">find</span></code>, <code class="docutils literal notranslate"><span class="pre">extensions</span></code>, etcetera. In the
<a class="reference internal" href="#environment-configuration"><span class="std std-ref">Configuring Environments</span></a> section we will discuss
environment-aware commands further.</p>
</section>
<section id="adding-abstract-specs">
<h3>Adding Abstract Specs<a class="headerlink" href="#adding-abstract-specs" title="Link to this heading"></a></h3>
<p>An abstract spec is the user-specified spec before Spack applies
defaults or dependency information.</p>
<p>Users can add abstract specs to an environment using the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">add</span></code>
command. The most important component of an environment is a list of
abstract specs.</p>
<p>Adding a spec adds it as a root spec of the environment in the user
input file (<code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>). It does not affect the concrete specs
in the lock file (<code class="docutils literal notranslate"><span class="pre">spack.lock</span></code>) and it does not install the spec.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">add</span></code> command is environment-aware. It adds the spec to the
currently active environment. An error is generated if there isn’t an
active environment. All environment-aware commands can also
be called using the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">-e</span></code> flag to specify the environment.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>myenv
<span class="gp">$ </span>spack<span class="w"> </span>add<span class="w"> </span>mpileaks
</pre></div>
</div>
<p>or</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>add<span class="w"> </span>python
</pre></div>
</div>
</section>
<section id="concretizing">
<span id="environments-concretization"></span><h3>Concretizing<a class="headerlink" href="#concretizing" title="Link to this heading"></a></h3>
<p>Once user specs have been added to an environment, they can be concretized.
There are three different modes of operation to concretize an environment,
explained in detail in <a class="reference internal" href="#environments-concretization-config"><span class="std std-ref">Spec concretization</span></a>.
Regardless of which mode of operation is chosen, the following
command will ensure all of the root specs are concretized according to the
constraints that are prescribed in the configuration:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[myenv]$ </span>spack<span class="w"> </span>concretize
</pre></div>
</div>
<p>In the case of specs that are not concretized together, the command
above will concretize only the specs that were added and not yet
concretized. Forcing a re-concretization of all of the specs can be done
by adding the <code class="docutils literal notranslate"><span class="pre">-f</span></code> option:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[myenv]$ </span>spack<span class="w"> </span>concretize<span class="w"> </span>-f
</pre></div>
</div>
<p>Without the option, Spack guarantees that already concretized specs are
unchanged in the environment.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">concretize</span></code> command does not install any packages. For packages
that have already been installed outside of the environment, the
process of adding the spec and concretizing is identical to installing
the spec assuming it concretizes to the exact spec that was installed
outside of the environment.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">find</span></code> command can show concretized specs separately from
installed specs using the <code class="docutils literal notranslate"><span class="pre">-c</span></code> (<code class="docutils literal notranslate"><span class="pre">--concretized</span></code>) flag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[myenv]$ </span>spack<span class="w"> </span>add<span class="w"> </span>zlib
<span class="gp">[myenv]$ </span>spack<span class="w"> </span>concretize
<span class="gp">[myenv]$ </span>spack<span class="w"> </span>find<span class="w"> </span>-c
<span class="go">==&gt; In environment myenv</span>
<span class="go">==&gt; Root specs</span>
<span class="go">zlib</span>

<span class="go">==&gt; Concretized roots</span>
<span class="go">-- linux-rhel7-x86_64 / gcc@4.9.3 -------------------------------</span>
<span class="go">zlib@1.2.11</span>

<span class="go">==&gt; 0 installed packages</span>
</pre></div>
</div>
</section>
<section id="installing-an-environment">
<span id="installing-environment"></span><h3>Installing an Environment<a class="headerlink" href="#installing-an-environment" title="Link to this heading"></a></h3>
<p>In addition to adding individual specs to an environment, one
can install the entire environment at once using the command</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[myenv]$ </span>spack<span class="w"> </span>install
</pre></div>
</div>
<p>If the environment has been concretized, Spack will install the
concretized specs. Otherwise, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> will concretize
the environment before installing the concretized specs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Every <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> process builds one package at a time with multiple build
jobs, controlled by the <code class="docutils literal notranslate"><span class="pre">-j</span></code> flag and the <code class="docutils literal notranslate"><span class="pre">config:build_jobs</span></code> option
(see <a class="reference internal" href="config_yaml.html#build-jobs"><span class="std std-ref">build_jobs</span></a>). To speed up environment builds further, independent
packages can be installed in parallel by launching more Spack instances. For
example, the following will build at most four packages in parallel using
three background jobs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[myenv]$ </span>spack<span class="w"> </span>install<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>spack<span class="w"> </span>install<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>spack<span class="w"> </span>install<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>spack<span class="w"> </span>install
</pre></div>
</div>
<p>Another option is to generate a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> and run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">-j&lt;N&gt;</span></code> to control
the number of parallel install processes. See <a class="reference internal" href="#env-generate-depfile"><span class="std std-ref">Generating Depfiles from Environments</span></a>
for details.</p>
</div>
<p>As it installs, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> creates symbolic links in the
<code class="docutils literal notranslate"><span class="pre">logs/</span></code> directory in the environment, allowing for easy inspection
of build logs related to that environment. The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code>
command also stores a Spack repo containing the <code class="docutils literal notranslate"><span class="pre">package.py</span></code> file
used at install time for each package in the <code class="docutils literal notranslate"><span class="pre">repos/</span></code> directory in
the environment.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--no-add</span></code> option can be used in a concrete environment to tell
spack to install specs already present in the environment but not to
add any new root specs to the environment.  For root specs provided
to <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> on the command line, <code class="docutils literal notranslate"><span class="pre">--no-add</span></code> is the default,
while for dependency specs, it is optional.  In other
words, if there is an unambiguous match in the active concrete environment
for a root spec provided to <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> on the command line, spack
does not require you to specify the <code class="docutils literal notranslate"><span class="pre">--no-add</span></code> option to prevent the spec
from being added again.  At the same time, a spec that already exists in the
environment, but only as a dependency, will be added to the environment as a
root spec without the <code class="docutils literal notranslate"><span class="pre">--no-add</span></code> option.</p>
</section>
<section id="developing-packages-in-a-spack-environment">
<h3>Developing Packages in a Spack Environment<a class="headerlink" href="#developing-packages-in-a-spack-environment" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">develop</span></code> command allows one to develop Spack packages in
an environment. It requires a spec containing a concrete version, and
will configure Spack to install the package from local source. 
If a version is not provided from the command line interface then spack 
will automatically pick the highest version the package has defined.
This means any infinity versions (<code class="docutils literal notranslate"><span class="pre">develop</span></code>, <code class="docutils literal notranslate"><span class="pre">main</span></code>, <code class="docutils literal notranslate"><span class="pre">stable</span></code>) will be
preferred in this selection process.
By default, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">develop</span></code> will also clone the package to a subdirectory in the
environment for the local source. This package will have a special variant <code class="docutils literal notranslate"><span class="pre">dev_path</span></code>
set, and Spack will ensure the package and its dependents are rebuilt
any time the environment is installed if the package’s local source
code has been modified. Spack’s native implementation to check for modifications
is to check if <code class="docutils literal notranslate"><span class="pre">mtime</span></code> is newer than the installation.
A custom check can be created by overriding the <code class="docutils literal notranslate"><span class="pre">detect_dev_src_change</span></code> method 
in your package class. This is particularly useful for projects using custom spack repo’s 
to drive development and want to optimize performance.</p>
<p>Spack ensures that all instances of a
developed package in the environment are concretized to match the
version (and other constraints) passed as the spec argument to the
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">develop</span></code> command.</p>
<p>For packages with <code class="docutils literal notranslate"><span class="pre">git</span></code> attributes, git branches, tags, and commits can
also be used as valid concrete versions (see <a class="reference internal" href="basic_usage.html#version-specifier"><span class="std std-ref">Version specifier</span></a>).
This means that for a package <code class="docutils literal notranslate"><span class="pre">foo</span></code>, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">develop</span> <span class="pre">foo&#64;git.main</span></code> will clone
the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch of the package, and <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> will install from
that git clone if <code class="docutils literal notranslate"><span class="pre">foo</span></code> is in the environment.
Further development on <code class="docutils literal notranslate"><span class="pre">foo</span></code> can be tested by re-installing the environment,
and eventually committed and pushed to the upstream git repo.</p>
<p>If the package being developed supports out-of-source builds then users can use the
<code class="docutils literal notranslate"><span class="pre">--build_directory</span></code> flag to control the location and name of the build directory. 
This is a shortcut to set the <code class="docutils literal notranslate"><span class="pre">package_attributes:build_directory</span></code> in the
<code class="docutils literal notranslate"><span class="pre">packages</span></code> configuration (see <a class="reference internal" href="packages_yaml.html#assigning-package-attributes"><span class="std std-ref">Assigning Package Attributes</span></a>).
The supplied location will become the build-directory for that package in all future builds.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<dl class="simple">
<dt>Potential pitfalls of setting the build directory</dt><dd><p>Spack does not check for out-of-source build compatibility with the packages and
so the onerous of making sure the package supports out-of-source builds is on
the user.
For example, most <code class="docutils literal notranslate"><span class="pre">autotool</span></code> and <code class="docutils literal notranslate"><span class="pre">makefile</span></code> packages do not support out-of-source builds
while all <code class="docutils literal notranslate"><span class="pre">CMake</span></code> packages do.
Understanding these nuances are on the software developers and we strongly encourage
developers to only redirect the build directory if they understand their package’s
build-system.</p>
</dd>
</dl>
</div>
</section>
<section id="loading">
<h3>Loading<a class="headerlink" href="#loading" title="Link to this heading"></a></h3>
<p>Once an environment has been installed, the following creates a load
script for it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>loads<span class="w"> </span>-r
</pre></div>
</div>
<p>This creates a file called <code class="docutils literal notranslate"><span class="pre">loads</span></code> in the environment directory.
Sourcing that file in Bash will make the environment available to the
user; and can be included in <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> files, etc.  The <code class="docutils literal notranslate"><span class="pre">loads</span></code>
file may also be copied out of the environment, renamed, etc.</p>
</section>
</section>
<section id="included-concrete-environments">
<span id="environment-include-concrete"></span><h2>Included Concrete Environments<a class="headerlink" href="#included-concrete-environments" title="Link to this heading"></a></h2>
<p>Spack environments can create an environment based off of information in already
established environments. You can think of it as a combination of existing
environments. It will gather information from the existing environment’s
<code class="docutils literal notranslate"><span class="pre">spack.lock</span></code> and use that during the creation of this included concrete
environment. When an included concrete environment is created it will generate
a <code class="docutils literal notranslate"><span class="pre">spack.lock</span></code> file for the newly created environment.</p>
<section id="creating-included-environments">
<h3>Creating included environments<a class="headerlink" href="#creating-included-environments" title="Link to this heading"></a></h3>
<p>To create a combined concrete environment, you must have at least one existing
concrete environment. You will use the command <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">create</span></code> with the
argument <code class="docutils literal notranslate"><span class="pre">--include-concrete</span></code> followed by the name or path of the environment
you’d like to include. Here is an example of how to create a combined environment
from the command line.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>myenv
<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>add<span class="w"> </span>python
<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>concretize
<span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>--include-concrete<span class="w"> </span>myenv<span class="w"> </span>included_env
</pre></div>
</div>
<p>You can also include an environment directly in the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file. It
involves adding the <code class="docutils literal notranslate"><span class="pre">include_concrete</span></code> heading in the yaml followed by the
absolute path to the independent environments.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">  </span><span class="nt">concretizer</span><span class="p">:</span>
<span class="w">      </span><span class="nt">unify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">include_concrete</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/absolute/path/to/environment1</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/absolute/path/to/environment2</span>
</pre></div>
</div>
<p>Once the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> has been updated you must concretize the environment to
get the concrete specs from the included environments.</p>
</section>
<section id="updating-an-included-environment">
<h3>Updating an included environment<a class="headerlink" href="#updating-an-included-environment" title="Link to this heading"></a></h3>
<p>If changes were made to the base environment and you want that reflected in the
included environment you will need to reconcretize both the base environment and the
included environment for the change to be implemented. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>myenv
<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>add<span class="w"> </span>python
<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>concretize
<span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>--include-concrete<span class="w"> </span>myenv<span class="w"> </span>included_env


<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>find
<span class="go">==&gt; In environment myenv</span>
<span class="go">==&gt; Root specs</span>
<span class="go">python</span>

<span class="go">==&gt; 0 installed packages</span>


<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>included_env<span class="w"> </span>find
<span class="go">==&gt; In environment included_env</span>
<span class="go">==&gt; No root specs</span>
<span class="go">==&gt; Included specs</span>
<span class="go">python</span>

<span class="go">==&gt; 0 installed packages</span>
</pre></div>
</div>
<p>Here we see that <code class="docutils literal notranslate"><span class="pre">included_env</span></code> has access to the python package through
the <code class="docutils literal notranslate"><span class="pre">myenv</span></code> environment. But if we were to add another spec to <code class="docutils literal notranslate"><span class="pre">myenv</span></code>,
<code class="docutils literal notranslate"><span class="pre">included_env</span></code> will not be able to access the new information.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>add<span class="w"> </span>perl
<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>concretize
<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>myenv<span class="w"> </span>find
<span class="go">==&gt; In environment myenv</span>
<span class="go">==&gt; Root specs</span>
<span class="go">perl  python</span>

<span class="go">==&gt; 0 installed packages</span>


<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>included_env<span class="w"> </span>find
<span class="go">==&gt; In environment included_env</span>
<span class="go">==&gt; No root specs</span>
<span class="go">==&gt; Included specs</span>
<span class="go">python</span>

<span class="go">==&gt; 0 installed packages</span>
</pre></div>
</div>
<p>It isn’t until you run the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">concretize</span></code> command that the combined
environment will get the updated information from the reconcretized base environmennt.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>included_env<span class="w"> </span>concretize
<span class="gp">$ </span>spack<span class="w"> </span>-e<span class="w"> </span>included_env<span class="w"> </span>find
<span class="go">==&gt; In environment included_env</span>
<span class="go">==&gt; No root specs</span>
<span class="go">==&gt; Included specs</span>
<span class="go">perl  python</span>

<span class="go">==&gt; 0 installed packages</span>
</pre></div>
</div>
</section>
</section>
<section id="configuring-environments">
<span id="environment-configuration"></span><h2>Configuring Environments<a class="headerlink" href="#configuring-environments" title="Link to this heading"></a></h2>
<p>A variety of Spack behaviors are changed through Spack configuration
files, covered in more detail in the <a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">Configuration Files</span></a>
section.</p>
<p>Spack Environments provide an additional level of configuration scope
between the custom scope and the user scope discussed in the
configuration documentation.</p>
<p>There are two ways to include configuration information in a Spack Environment:</p>
<ol class="arabic simple">
<li><p>Inline in the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file</p></li>
<li><p>Included in the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file from another file.</p></li>
</ol>
<p>Many Spack commands also affect configuration information in files
automatically. Those commands take a <code class="docutils literal notranslate"><span class="pre">--scope</span></code> argument, and the
environment can be specified by <code class="docutils literal notranslate"><span class="pre">env:NAME</span></code> (to affect environment
<code class="docutils literal notranslate"><span class="pre">foo</span></code>, set <code class="docutils literal notranslate"><span class="pre">--scope</span> <span class="pre">env:foo</span></code>). These commands will automatically
manipulate configuration inline in the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file.</p>
<section id="inline-configurations">
<h3>Inline configurations<a class="headerlink" href="#inline-configurations" title="Link to this heading"></a></h3>
<p>Inline environment-scope configuration is done using the same yaml
format as standard Spack configuration scopes, covered in the
<a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">Configuration Files</span></a> section. Each section is contained under a
top-level yaml object with it’s name. For example, a <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>
manifest file containing some package preference configuration (as in
a <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code> file) could contain:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">packages</span><span class="p">:</span>
<span class="w">    </span><span class="nt">all</span><span class="p">:</span>
<span class="w">      </span><span class="nt">compiler</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">intel</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="c1"># ...</span>
</pre></div>
</div>
<p>This configuration sets the default compiler for all packages to
<code class="docutils literal notranslate"><span class="pre">intel</span></code>.</p>
</section>
<section id="included-configurations">
<h3>Included configurations<a class="headerlink" href="#included-configurations" title="Link to this heading"></a></h3>
<p>Spack environments allow an <code class="docutils literal notranslate"><span class="pre">include</span></code> heading in their yaml
schema. This heading pulls in external configuration files and applies
them to the environment.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">include</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">relative/path/to/config.yaml</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/path/to/raw/config/compilers.yaml</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/absolute/path/to/packages.yaml</span>
</pre></div>
</div>
<p>Environments can include files or URLs. File paths can be relative or
absolute. URLs include the path to the text for individual files or
can be the path to a directory containing configuration files.
Spack supports <code class="docutils literal notranslate"><span class="pre">file</span></code>, <code class="docutils literal notranslate"><span class="pre">http</span></code>, <code class="docutils literal notranslate"><span class="pre">https</span></code> and <code class="docutils literal notranslate"><span class="pre">ftp</span></code> protocols (or
schemes). Spack-specific, environment and user path variables may be
used in these paths. See <a class="reference internal" href="configuration.html#config-file-variables"><span class="std std-ref">Config File Variables</span></a> for more information.</p>
</section>
<section id="configuration-precedence">
<h3>Configuration precedence<a class="headerlink" href="#configuration-precedence" title="Link to this heading"></a></h3>
<p>Inline configurations take precedence over included configurations, so
you don’t have to change shared configuration files to make small changes
to an individual environment. Included configurations listed earlier will
have higher precedence, as the included configs are applied in reverse order.</p>
</section>
</section>
<section id="manually-editing-the-specs-list">
<h2>Manually Editing the Specs List<a class="headerlink" href="#manually-editing-the-specs-list" title="Link to this heading"></a></h2>
<p>The list of abstract/root specs in the environment is maintained in
the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> manifest under the heading <code class="docutils literal notranslate"><span class="pre">specs</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">    </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ncview</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netcdf</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nco</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">py-sphinx</span>
</pre></div>
</div>
<p>Appending to this list in the yaml is identical to using the <code class="docutils literal notranslate"><span class="pre">spack</span>
<span class="pre">add</span></code> command from the command line. However, there is more power
available from the yaml file.</p>
<section id="spec-concretization">
<span id="environments-concretization-config"></span><h3>Spec concretization<a class="headerlink" href="#spec-concretization" title="Link to this heading"></a></h3>
<p>An environment can be concretized in three different modes and the behavior active under
any environment is determined by the <code class="docutils literal notranslate"><span class="pre">concretizer:unify</span></code> configuration option.</p>
<p>The <em>default</em> mode is to unify all specs:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">    </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hdf5+mpi</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib@1.2.8</span>
<span class="w">    </span><span class="nt">concretizer</span><span class="p">:</span>
<span class="w">      </span><span class="nt">unify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>This means that any package in the environment corresponds to a single concrete spec. In
the above example, when <code class="docutils literal notranslate"><span class="pre">hdf5</span></code> depends down the line of <code class="docutils literal notranslate"><span class="pre">zlib</span></code>, it is required to
take <code class="docutils literal notranslate"><span class="pre">zlib&#64;1.2.8</span></code> instead of a newer version. This mode of concretization is
particularly useful when environment views are used: if every package occurs in
only one flavor, it is usually possible to merge all install directories into a view.</p>
<p>A downside of unified concretization is that it can be overly strict. For example, a
concretization error would happen when both <code class="docutils literal notranslate"><span class="pre">hdf5+mpi</span></code> and <code class="docutils literal notranslate"><span class="pre">hdf5~mpi</span></code> are specified
in an environment.</p>
<p>The second mode is to <em>unify when possible</em>: this makes concretization of root specs
more independendent. Instead of requiring reuse of dependencies across different root
specs, it is only maximized:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">    </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hdf5~mpi</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hdf5+mpi</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib@1.2.8</span>
<span class="w">    </span><span class="nt">concretizer</span><span class="p">:</span>
<span class="w">      </span><span class="nt">unify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_possible</span>
</pre></div>
</div>
<p>This means that both <code class="docutils literal notranslate"><span class="pre">hdf5</span></code> installations will use <code class="docutils literal notranslate"><span class="pre">zlib&#64;1.2.8</span></code> as a dependency even
if newer versions of that library are available.</p>
<p>The third mode of operation is to concretize root specs entirely independently by
disabling unified concretization:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">    </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hdf5~mpi</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hdf5+mpi</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib@1.2.8</span>
<span class="w">    </span><span class="nt">concretizer</span><span class="p">:</span>
<span class="w">      </span><span class="nt">unify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<p>In this example <code class="docutils literal notranslate"><span class="pre">hdf5</span></code> is concretized separately, and does not consider <code class="docutils literal notranslate"><span class="pre">zlib&#64;1.2.8</span></code>
as a constraint or preference. Instead, it will take the latest possible version.</p>
<p>The last two concretization options are typically useful for system administrators and
user support groups providing a large software stack for their HPC center.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">concretizer:unify</span></code> config option was introduced in Spack 0.18 to
replace the <code class="docutils literal notranslate"><span class="pre">concretization</span></code> property. For reference,
<code class="docutils literal notranslate"><span class="pre">concretization:</span> <span class="pre">together</span></code> is replaced by <code class="docutils literal notranslate"><span class="pre">concretizer:unify:true</span></code>,
and <code class="docutils literal notranslate"><span class="pre">concretization:</span> <span class="pre">separately</span></code> is replaced by <code class="docutils literal notranslate"><span class="pre">concretizer:unify:false</span></code>.</p>
</div>
<div class="admonition-re-concretization-of-user-specs admonition">
<p class="admonition-title">Re-concretization of user specs</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">concretize</span></code> command without additional arguments will <em>not</em> change any
previously concretized specs. This may prevent it from finding a solution when using
<code class="docutils literal notranslate"><span class="pre">unify:</span> <span class="pre">true</span></code>, and it may prevent it from finding a minimal solution when using
<code class="docutils literal notranslate"><span class="pre">unify:</span> <span class="pre">when_possible</span></code>. You can force Spack to ignore the existing concrete environment
with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">concretize</span> <span class="pre">-f</span></code>.</p>
</div>
</section>
<section id="spec-matrices">
<h3>Spec Matrices<a class="headerlink" href="#spec-matrices" title="Link to this heading"></a></h3>
<p>Entries in the <code class="docutils literal notranslate"><span class="pre">specs</span></code> list can be individual abstract specs or a
spec matrix.</p>
<p>A spec matrix is a yaml object containing multiple lists of specs, and
evaluates to the cross-product of those specs. Spec matrices also
contain an <code class="docutils literal notranslate"><span class="pre">excludes</span></code> directive, which eliminates certain
combinations from the evaluated result.</p>
<p>The following two environment manifests are identical:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib %gcc@7.1.0</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib %gcc@4.9.3</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libelf %gcc@7.1.0</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libelf %gcc@4.9.3</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libdwarf %gcc@7.1.0</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake</span>

<span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">zlib</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">libelf</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">libdwarf</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;%gcc@7.1.0&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;%gcc@4.9.3&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">exclude</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libdwarf%gcc@4.9.3</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake</span>
</pre></div>
</div>
<p>Spec matrices can be used to install swaths of software across various
toolchains.</p>
</section>
<section id="spec-list-references">
<h3>Spec List References<a class="headerlink" href="#spec-list-references" title="Link to this heading"></a></h3>
<p>The last type of possible entry in the specs list is a reference.</p>
<p>The Spack Environment manifest yaml schema contains an additional
heading <code class="docutils literal notranslate"><span class="pre">definitions</span></code>. Under definitions is an array of yaml
objects. Each object has one or two fields. The one required field is
a name, and the optional field is a <code class="docutils literal notranslate"><span class="pre">when</span></code> clause.</p>
<p>The named field is a spec list. The spec list uses the same syntax as
the <code class="docutils literal notranslate"><span class="pre">specs</span></code> entry. Each entry in the spec list can be a spec, a spec
matrix, or a reference to an earlier named list. References are
specified using the <code class="docutils literal notranslate"><span class="pre">$</span></code> sigil, and are “splatted” into place
(i.e. the elements of the referent are at the same level as the
elements listed separately). As an example, the following two manifest
files are identical.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">definitions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">first</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">libelf</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">libdwarf</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">compilers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;%gcc&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;%intel&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">second</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$first</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">zlib</span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">$compilers</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$second</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake</span>

<span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libelf</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libdwarf</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib%gcc</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zlib%intel</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Named spec lists in the definitions section may only refer
to a named list defined above itself. Order matters.</p>
</div>
<p>In short files like the example, it may be easier to simply list the
included specs. However for more complicated examples involving many
packages across many toolchains, separately factored lists make
environments substantially more manageable.</p>
<p>Additionally, the <code class="docutils literal notranslate"><span class="pre">-l</span></code> option to the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">add</span></code> command allows
one to add to named lists in the definitions section of the manifest
file directly from the command line.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">when</span></code> directive can be used to conditionally add specs to a
named list. The <code class="docutils literal notranslate"><span class="pre">when</span></code> directive takes a string of Python code
referring to a restricted set of variables, and evaluates to a
boolean. The specs listed are appended to the named list if the
<code class="docutils literal notranslate"><span class="pre">when</span></code> string evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>. In the following snippet, the
named list <code class="docutils literal notranslate"><span class="pre">compilers</span></code> is <code class="docutils literal notranslate"><span class="pre">['%gcc',</span> <span class="pre">'%clang',</span> <span class="pre">'%intel']</span></code> on
<code class="docutils literal notranslate"><span class="pre">x86_64</span></code> systems and <code class="docutils literal notranslate"><span class="pre">['%gcc',</span> <span class="pre">'%clang']</span></code> on all other systems.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">definitions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">compilers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;%gcc&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;%clang&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arch.satisfies(&#39;target=x86_64:&#39;)</span>
<span class="w">      </span><span class="nt">compilers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;%intel&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any definitions with the same named list with true <code class="docutils literal notranslate"><span class="pre">when</span></code>
clauses (or absent <code class="docutils literal notranslate"><span class="pre">when</span></code> clauses) will be appended together</p>
</div>
<p>The valid variables for a <code class="docutils literal notranslate"><span class="pre">when</span></code> clause are:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">platform</span></code>. The platform string of the default Spack
architecture on the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">os</span></code>. The os string of the default Spack architecture on
the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target</span></code>. The target string of the default Spack
architecture on the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">architecture</span></code> or <code class="docutils literal notranslate"><span class="pre">arch</span></code>. A Spack spec satisfying the default Spack
architecture on the system. This supports querying via the <code class="docutils literal notranslate"><span class="pre">satisfies</span></code>
method, as shown above.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arch_str</span></code>. The architecture string of the default Spack architecture
on the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">re</span></code>. The standard regex module in Python.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">env</span></code>. The user environment (usually <code class="docutils literal notranslate"><span class="pre">os.environ</span></code> in Python).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hostname</span></code>. The hostname of the system (if <code class="docutils literal notranslate"><span class="pre">hostname</span></code> is an
executable in the user’s PATH).</p></li>
</ol>
</section>
<section id="speclists-as-constraints">
<h3>SpecLists as Constraints<a class="headerlink" href="#speclists-as-constraints" title="Link to this heading"></a></h3>
<p>Dependencies and compilers in Spack can be both packages in an
environment and constraints on other packages. References to SpecLists
allow a shorthand to treat packages in a list as either a compiler or
a dependency using the <code class="docutils literal notranslate"><span class="pre">$%</span></code> or <code class="docutils literal notranslate"><span class="pre">$^</span></code> syntax respectively.</p>
<p>For example, the following environment has three root packages:
<code class="docutils literal notranslate"><span class="pre">gcc&#64;8.1.0</span></code>, <code class="docutils literal notranslate"><span class="pre">mvapich2&#64;2.3.1</span> <span class="pre">%gcc&#64;8.1.0</span></code>, and <code class="docutils literal notranslate"><span class="pre">hdf5+mpi</span>
<span class="pre">%gcc&#64;8.1.0</span> <span class="pre">^mvapich2&#64;2.3.1</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">definitions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">compilers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">gcc@8.1.0</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mpis</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">mvapich2@2.3.1</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">packages</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">hdf5+mpi</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="nt">specs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$compilers</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">$mpis</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">$%compilers</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">$packages</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">$^mpis</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">$%compilers</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>This allows for a much-needed reduction in redundancy between packages
and constraints.</p>
</section>
</section>
<section id="environment-views">
<h2>Environment Views<a class="headerlink" href="#environment-views" title="Link to this heading"></a></h2>
<p>Spack Environments can have an associated filesystem view, which is a directory
with a more traditional structure <code class="docutils literal notranslate"><span class="pre">&lt;view&gt;/bin</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;view&gt;/lib</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;view&gt;/include</span></code>
in which all files of the installed packages are linked.</p>
<p>By default a view is created for each environment, thanks to the <code class="docutils literal notranslate"><span class="pre">view:</span> <span class="pre">true</span></code>
option in the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> manifest file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">perl</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">python</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>The view is created in a hidden directory <code class="docutils literal notranslate"><span class="pre">.spack-env/view</span></code> relative to the environment.
If you’ve used <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">activate</span></code>, you may have already interacted with this view. Spack
prepends its <code class="docutils literal notranslate"><span class="pre">&lt;view&gt;/bin</span></code> dir to <code class="docutils literal notranslate"><span class="pre">PATH</span></code> when the environment is activated, so that
you can directly run executables from all installed packages in the environment.</p>
<p>Views are highly customizable: you can control where they are put, modify their structure,
include and exclude specs, change how files are linked, and you can even generate multiple
views for a single environment.</p>
<section id="minimal-view-configuration">
<span id="configuring-environment-views"></span><h3>Minimal view configuration<a class="headerlink" href="#minimal-view-configuration" title="Link to this heading"></a></h3>
<p>The minimal configuration</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>lets Spack generate a single view with default settings under the
<code class="docutils literal notranslate"><span class="pre">.spack-env/view</span></code> directory of the environment.</p>
<p>Another short way to configure a view is to specify just where to put it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/view</span>
</pre></div>
</div>
<p>Views can also be disabled by setting <code class="docutils literal notranslate"><span class="pre">view:</span> <span class="pre">false</span></code>.</p>
</section>
<section id="advanced-view-configuration">
<h3>Advanced view configuration<a class="headerlink" href="#advanced-view-configuration" title="Link to this heading"></a></h3>
<p>One or more <strong>view descriptors</strong> can be defined under <code class="docutils literal notranslate"><span class="pre">view</span></code>, keyed by a name.
The example from the previous section with <code class="docutils literal notranslate"><span class="pre">view:</span> <span class="pre">/path/to/view</span></code> is equivalent
to defining a view descriptor named <code class="docutils literal notranslate"><span class="pre">default</span></code> with a <code class="docutils literal notranslate"><span class="pre">root</span></code> attribute:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w">  </span><span class="c1"># name of the view</span>
<span class="w">      </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/view</span><span class="w">  </span><span class="c1"># view descriptor attribute</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">default</span></code> view descriptor name is special: when you <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">activate</span></code> your
environment, this view will be used to update (among other things) your <code class="docutils literal notranslate"><span class="pre">PATH</span></code>
variable.</p>
<p>View descriptors must contain the root of the view, and optionally projections,
<code class="docutils literal notranslate"><span class="pre">select</span></code> and <code class="docutils literal notranslate"><span class="pre">exclude</span></code> lists and link information via <code class="docutils literal notranslate"><span class="pre">link</span></code> and
<code class="docutils literal notranslate"><span class="pre">link_type</span></code>.</p>
<p>As a more advanced example, in the following manifest
file snippet we define a view named <code class="docutils literal notranslate"><span class="pre">mpis</span></code>, rooted at
<code class="docutils literal notranslate"><span class="pre">/path/to/view</span></code> in which all projections use the package name,
version, and compiler name to determine the path for a given
package. This view selects all packages that depend on MPI, and
excludes those built with the PGI compiler at version 18.5.
The root specs with their (transitive) link and run type dependencies
will be put in the view due to the  <code class="docutils literal notranslate"><span class="pre">link:</span> <span class="pre">all</span></code> option,
and the files in the view will be symlinks to the spack install
directories.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mpis</span><span class="p">:</span>
<span class="w">      </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/view</span>
<span class="w">      </span><span class="nt">select</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">^mpi</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">exclude</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;%pgi@18.5&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">projections</span><span class="p">:</span>
<span class="w">        </span><span class="nt">all</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{name}/{version}-{compiler.name}&#39;</span>
<span class="w">      </span><span class="nt">link</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<span class="w">      </span><span class="nt">link_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">symlink</span>
</pre></div>
</div>
<p>The default for the <code class="docutils literal notranslate"><span class="pre">select</span></code> and
<code class="docutils literal notranslate"><span class="pre">exclude</span></code> values is to select everything and exclude nothing. The
default projection is the default view projection (<code class="docutils literal notranslate"><span class="pre">{}</span></code>). The <code class="docutils literal notranslate"><span class="pre">link</span></code>
attribute allows the following values:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">link:</span> <span class="pre">all</span></code> include root specs with their transitive run and link type
dependencies (default);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">link:</span> <span class="pre">run</span></code> include root specs with their transitive run type dependencies;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">link:</span> <span class="pre">roots</span></code> include root specs without their dependencies.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">link_type</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">symlink</span></code> but can also take the value
of <code class="docutils literal notranslate"><span class="pre">hardlink</span></code> or <code class="docutils literal notranslate"><span class="pre">copy</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The option <code class="docutils literal notranslate"><span class="pre">link:</span> <span class="pre">run</span></code> can be used to create small environment views for
Python packages. Python will be able to import packages <em>inside</em> of the view even
when the environment is not activated, and linked libraries will be located
<em>outside</em> of the view thanks to rpaths.</p>
</div>
<p>From the command line, the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">create</span></code> command takes an
argument <code class="docutils literal notranslate"><span class="pre">--with-view</span> <span class="pre">[PATH]</span></code> that sets the path for a single, default
view. If no path is specified, the default path is used (<code class="docutils literal notranslate"><span class="pre">view:</span>
<span class="pre">true</span></code>). The argument <code class="docutils literal notranslate"><span class="pre">--without-view</span></code> can be used to create an
environment without any view configured.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">view</span></code> command can be used to change the manage views
of an environment. The subcommand <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">view</span> <span class="pre">enable</span></code> will add a
view named <code class="docutils literal notranslate"><span class="pre">default</span></code> to an environment. It takes an optional
argument to specify the path for the new default view. The subcommand
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">view</span> <span class="pre">disable</span></code> will remove the view named <code class="docutils literal notranslate"><span class="pre">default</span></code> from
an environment if one exists. The subcommand <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">view</span>
<span class="pre">regenerate</span></code> will regenerate the views for the environment. This will
apply any updates in the environment configuration that have not yet
been applied.</p>
<section id="view-projections">
<span id="id2"></span><h4>View Projections<a class="headerlink" href="#view-projections" title="Link to this heading"></a></h4>
<p>The default projection into a view is to link every package into the
root of the view. The projections attribute is a mapping of partial specs to
spec format strings, defined by the <a class="reference internal" href="spack.html#spack.spec.Spec.format" title="spack.spec.Spec.format"><code class="xref py py-meth docutils literal notranslate"><span class="pre">format()</span></code></a>
function, as shown in the example below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">projections</span><span class="p">:</span>
<span class="w">  </span><span class="nt">zlib</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{name}-{version}&quot;</span>
<span class="w">  </span><span class="nt">^mpi</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{name}-{version}/{^mpi.name}-{^mpi.version}-{compiler.name}-{compiler.version}&quot;</span>
<span class="w">  </span><span class="nt">all</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{name}-{version}/{compiler.name}-{compiler.version}&quot;</span>
</pre></div>
</div>
<p>Projections also permit environment and spack configuration variable
expansions as shown below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">projections</span><span class="p">:</span>
<span class="w">  </span><span class="nt">all</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{name}-{version}/{compiler.name}-{compiler.version}/$date/$SYSTEM_ENV_VARIBLE&quot;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">$date</span></code> is the spack configuration variable that will expand with the <code class="docutils literal notranslate"><span class="pre">YYYY-MM-DD</span></code>
format and <code class="docutils literal notranslate"><span class="pre">$SYSTEM_ENV_VARIABLE</span></code> is an environment variable defined in the shell.</p>
<p>The entries in the projections configuration file must all be either
specs or the keyword <code class="docutils literal notranslate"><span class="pre">all</span></code>. For each spec, the projection used will
be the first non-<code class="docutils literal notranslate"><span class="pre">all</span></code> entry that the spec satisfies, or <code class="docutils literal notranslate"><span class="pre">all</span></code> if
there is an entry for <code class="docutils literal notranslate"><span class="pre">all</span></code> and no other entry is satisfied by the
spec. Where the keyword <code class="docutils literal notranslate"><span class="pre">all</span></code> appears in the file does not
matter.</p>
<p>Given the example above, the spec <code class="docutils literal notranslate"><span class="pre">zlib&#64;1.2.8</span></code>
will be linked into <code class="docutils literal notranslate"><span class="pre">/my/view/zlib-1.2.8/</span></code>, the spec
<code class="docutils literal notranslate"><span class="pre">hdf5&#64;1.8.10+mpi</span> <span class="pre">%gcc&#64;4.9.3</span> <span class="pre">^mvapich2&#64;2.2</span></code> will be linked into
<code class="docutils literal notranslate"><span class="pre">/my/view/hdf5-1.8.10/mvapich2-2.2-gcc-4.9.3</span></code>, and the spec
<code class="docutils literal notranslate"><span class="pre">hdf5&#64;1.8.10~mpi</span> <span class="pre">%gcc&#64;4.9.3</span></code> will be linked into
<code class="docutils literal notranslate"><span class="pre">/my/view/hdf5-1.8.10/gcc-4.9.3</span></code>.</p>
<p>If the keyword <code class="docutils literal notranslate"><span class="pre">all</span></code> does not appear in the projections
configuration file, any spec that does not satisfy any entry in the
file will be linked into the root of the view as in a single-prefix
view. Any entries that appear below the keyword <code class="docutils literal notranslate"><span class="pre">all</span></code> in the
projections configuration file will not be used, as all specs will use
the projection under <code class="docutils literal notranslate"><span class="pre">all</span></code> before reaching those entries.</p>
</section>
</section>
<section id="activating-environment-views">
<h3>Activating environment views<a class="headerlink" href="#activating-environment-views" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">activate</span> <span class="pre">&lt;env&gt;</span></code> has two effects:</p>
<ol class="arabic simple">
<li><p>It activates the environment so that further Spack commands such
as <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> will run in the context of the environment.</p></li>
<li><p>It activates the view so that environment variables such as
<code class="docutils literal notranslate"><span class="pre">PATH</span></code> are updated to include the view.</p></li>
</ol>
<p>Without further arguments, the <code class="docutils literal notranslate"><span class="pre">default</span></code> view of the environment is
activated. If a view with a different name has to be activated,
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">activate</span> <span class="pre">--with-view</span> <span class="pre">&lt;name&gt;</span> <span class="pre">&lt;env&gt;</span></code> can be
used instead. You can also activate the environment without modifying
further environment variables using <code class="docutils literal notranslate"><span class="pre">--without-view</span></code>.</p>
<p>The environment variables affected by the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">activate</span></code>
command and the paths that are used to update them are determined by
the <a class="reference internal" href="module_file_support.html#customize-env-modifications"><span class="std std-ref">prefix inspections</span></a> defined in
your modules configuration; the defaults are summarized in the following
table.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Paths</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PATH</p></td>
<td><p>bin</p></td>
</tr>
<tr class="row-odd"><td><p>MANPATH</p></td>
<td><p>man, share/man</p></td>
</tr>
<tr class="row-even"><td><p>ACLOCAL_PATH</p></td>
<td><p>share/aclocal</p></td>
</tr>
<tr class="row-odd"><td><p>PKG_CONFIG_PATH</p></td>
<td><p>lib/pkgconfig, lib64/pkgconfig, share/pkgconfig</p></td>
</tr>
<tr class="row-even"><td><p>CMAKE_PREFIX_PATH</p></td>
<td><p>.</p></td>
</tr>
</tbody>
</table>
<p>Each of these paths are appended to the view root, and added to the
relevant variable if the path exists. For this reason, it is not
recommended to use non-default projections with the default view of an
environment.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">env</span> <span class="pre">deactivate</span></code> command will remove the active view of
the Spack environment from the user’s environment variables.</p>
</section>
</section>
<section id="generating-depfiles-from-environments">
<span id="env-generate-depfile"></span><h2>Generating Depfiles from Environments<a class="headerlink" href="#generating-depfiles-from-environments" title="Link to this heading"></a></h2>
<p>Spack can generate <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s to make it easier to build multiple
packages in an environment in parallel. Generated <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s expose
targets that can be included in existing <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s, to allow
other targets to depend on the environment installation.</p>
<p>A typical workflow is as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">spack env create -d .</span>
<span class="go">spack -e . add perl</span>
<span class="go">spack -e . concretize</span>
<span class="go">spack -e . env depfile -o Makefile</span>
<span class="go">make -j64</span>
</pre></div>
</div>
<p>This generates a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> from a concretized environment in the
current working directory, and <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">-j64</span></code> installs the environment,
exploiting parallelism across packages as much as possible. Spack
respects the Make jobserver and forwards it to the build environment
of packages, meaning that a single <code class="docutils literal notranslate"><span class="pre">-j</span></code> flag is enough to control the
load, even when packages are built in parallel.</p>
<p>By default the following phony convenience targets are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span></code>: installs the environment (default target);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code>: cleans files used by make, but does not uninstall packages.</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>GNU Make version 4.3 and above have great support for output synchronization
through the <code class="docutils literal notranslate"><span class="pre">-O</span></code> and <code class="docutils literal notranslate"><span class="pre">--output-sync</span></code> flags, which ensure that output is
printed orderly per package install. To get synchronized output with colors,
use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">-j&lt;N&gt;</span> <span class="pre">SPACK_COLOR=always</span> <span class="pre">--output-sync=recurse</span></code>.</p>
</div>
<section id="specifying-dependencies-on-generated-make-targets">
<h3>Specifying dependencies on generated <code class="docutils literal notranslate"><span class="pre">make</span></code> targets<a class="headerlink" href="#specifying-dependencies-on-generated-make-targets" title="Link to this heading"></a></h3>
<p>An interesting question is how to include generated <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s in your own
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s. This comes up when you want to install an environment that provides
executables required in a command for a make target of your own.</p>
<p>The example below shows how to accomplish this: the <code class="docutils literal notranslate"><span class="pre">env</span></code> target specifies
the generated <code class="docutils literal notranslate"><span class="pre">spack/env</span></code> target as a prerequisite, meaning that the environment
gets installed and is available for use in the <code class="docutils literal notranslate"><span class="pre">env</span></code> target.</p>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">SPACK</span><span class="w"> </span><span class="o">?=</span><span class="w"> </span>spack

<span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">all</span> <span class="n">clean</span> <span class="n">env</span>

<span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">env</span>

<span class="nf">spack.lock</span><span class="o">:</span><span class="w"> </span><span class="n">spack</span>.<span class="n">yaml</span>
<span class="w">	</span><span class="k">$(</span>SPACK<span class="k">)</span><span class="w"> </span>-e<span class="w"> </span>.<span class="w"> </span>concretize<span class="w"> </span>-f

<span class="nf">env.mk</span><span class="o">:</span><span class="w"> </span><span class="n">spack</span>.<span class="n">lock</span>
<span class="w">	</span><span class="k">$(</span>SPACK<span class="k">)</span><span class="w"> </span>-e<span class="w"> </span>.<span class="w"> </span>env<span class="w"> </span>depfile<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>--make-prefix<span class="w"> </span>spack

<span class="nf">env</span><span class="o">:</span><span class="w"> </span><span class="n">spack</span>/<span class="n">env</span>
<span class="w">	</span><span class="k">$(</span>info<span class="w"> </span>environment<span class="w"> </span>installed!<span class="k">)</span>

<span class="nf">clean</span><span class="o">:</span>
<span class="w">	</span>rm<span class="w"> </span>-rf<span class="w"> </span>spack.lock<span class="w"> </span>env.mk<span class="w"> </span>spack/

<span class="cp">ifeq (,$(filter clean,$(MAKECMDGOALS)))</span>
<span class="cp">include env.mk</span>
<span class="cp">endif</span>
</pre></div>
</div>
<p>This works as follows: when <code class="docutils literal notranslate"><span class="pre">make</span></code> is invoked, it first “remakes” the missing
include <code class="docutils literal notranslate"><span class="pre">env.mk</span></code> as there is a target for it. This triggers concretization of
the environment and makes spack output <code class="docutils literal notranslate"><span class="pre">env.mk</span></code>. At that point the
generated target <code class="docutils literal notranslate"><span class="pre">spack/env</span></code> becomes available through <code class="docutils literal notranslate"><span class="pre">include</span> <span class="pre">env.mk</span></code>.</p>
<p>As it is typically undesirable to remake <code class="docutils literal notranslate"><span class="pre">env.mk</span></code> as part of <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code>,
the include is conditional.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When including generated <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s, it is important to use
the <code class="docutils literal notranslate"><span class="pre">--make-prefix</span></code> flag and use the non-phony target
<code class="docutils literal notranslate"><span class="pre">&lt;prefix&gt;/env</span></code> as prerequisite, instead of the phony target
<code class="docutils literal notranslate"><span class="pre">&lt;prefix&gt;/all</span></code>.</p>
</div>
</section>
<section id="building-a-subset-of-the-environment">
<h3>Building a subset of the environment<a class="headerlink" href="#building-a-subset-of-the-environment" title="Link to this heading"></a></h3>
<p>The generated <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s contain install targets for each spec, identified
by <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;-&lt;version&gt;-&lt;hash&gt;</span></code>. This allows you to install only a subset of the
packages in the environment. When packages are unique in the environment, it’s
enough to know the name and let tab-completion fill out the version and hash.</p>
<p>The following phony targets are available: <code class="docutils literal notranslate"><span class="pre">install/&lt;spec&gt;</span></code> to install the
spec with its dependencies, and <code class="docutils literal notranslate"><span class="pre">install-deps/&lt;spec&gt;</span></code> to <em>only</em> install
its dependencies. This can be useful when certain flags should only apply to
dependencies. Below we show a use case where a spec is installed with verbose
output (<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">--verbose</span></code>) while its dependencies are installed silently:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>depfile<span class="w"> </span>-o<span class="w"> </span>Makefile

<span class="gp"># </span>Install<span class="w"> </span>dependencies<span class="w"> </span><span class="k">in</span><span class="w"> </span>parallel,<span class="w"> </span>only<span class="w"> </span>show<span class="w"> </span>a<span class="w"> </span>log<span class="w"> </span>on<span class="w"> </span>error.
<span class="gp">$ </span>make<span class="w"> </span>-j16<span class="w"> </span>install-deps/python-3.11.0-&lt;hash&gt;<span class="w"> </span><span class="nv">SPACK_INSTALL_FLAGS</span><span class="o">=</span>--show-log-on-error

<span class="gp"># </span>Install<span class="w"> </span>the<span class="w"> </span>root<span class="w"> </span>spec<span class="w"> </span>with<span class="w"> </span>verbose<span class="w"> </span>output.
<span class="gp">$ </span>make<span class="w"> </span>-j16<span class="w"> </span>install/python-3.11.0-&lt;hash&gt;<span class="w"> </span><span class="nv">SPACK_INSTALL_FLAGS</span><span class="o">=</span>--verbose
</pre></div>
</div>
</section>
<section id="adding-post-install-hooks">
<h3>Adding post-install hooks<a class="headerlink" href="#adding-post-install-hooks" title="Link to this heading"></a></h3>
<p>Another advanced use-case of generated <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s is running a post-install
command for each package. These “hooks” could be anything from printing a
post-install message, running tests, or pushing just-built binaries to a buildcache.</p>
<p>This can be accomplished through the generated <code class="docutils literal notranslate"><span class="pre">[&lt;prefix&gt;/]SPACK_PACKAGE_IDS</span></code>
variable. Assuming we have an active and concrete environment, we generate the
associated <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> with a prefix <code class="docutils literal notranslate"><span class="pre">example</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>env<span class="w"> </span>depfile<span class="w"> </span>-o<span class="w"> </span>env.mk<span class="w"> </span>--make-prefix<span class="w"> </span>example
</pre></div>
</div>
<p>And we now include it in a different <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, in which we create a target
<code class="docutils literal notranslate"><span class="pre">example/push/%</span></code> with <code class="docutils literal notranslate"><span class="pre">%</span></code> referring to a package identifier. This target
depends on the particular package installation. In this target we automatically
have the target-specific <code class="docutils literal notranslate"><span class="pre">HASH</span></code> and <code class="docutils literal notranslate"><span class="pre">SPEC</span></code> variables at our disposal. They
are respectively the spec hash (excluding leading <code class="docutils literal notranslate"><span class="pre">/</span></code>), and a human-readable spec.
Finally, we have an entrypoint target <code class="docutils literal notranslate"><span class="pre">push</span></code> that will update the buildcache
index once every package is pushed. Note how this target uses the generated
<code class="docutils literal notranslate"><span class="pre">example/SPACK_PACKAGE_IDS</span></code> variable to define its prerequisites.</p>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">SPACK</span><span class="w"> </span><span class="o">?=</span><span class="w"> </span>spack
<span class="nv">BUILDCACHE_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>CURDIR<span class="k">)</span>/tarballs

<span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">all</span>

<span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">push</span>

<span class="cp">include env.mk</span>

<span class="nf">example/push/%</span><span class="o">:</span><span class="w"> </span><span class="n">example</span>/<span class="n">install</span>/%
<span class="w">	</span>@mkdir<span class="w"> </span>-p<span class="w"> </span><span class="k">$(</span>dir<span class="w"> </span><span class="nv">$@</span><span class="k">)</span>
<span class="w">	</span><span class="k">$(</span>info<span class="w"> </span>About<span class="w"> </span>to<span class="w"> </span>push<span class="w"> </span><span class="k">$(</span>SPEC<span class="k">)</span><span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span>buildcache<span class="k">)</span>
<span class="w">	</span><span class="k">$(</span>SPACK<span class="k">)</span><span class="w"> </span>-e<span class="w"> </span>.<span class="w"> </span>buildcache<span class="w"> </span>push<span class="w"> </span>--only<span class="o">=</span>package<span class="w"> </span><span class="k">$(</span>BUILDCACHE_DIR<span class="k">)</span><span class="w"> </span>/<span class="k">$(</span>HASH<span class="k">)</span>
<span class="w">	</span>@touch<span class="w"> </span><span class="nv">$@</span>

<span class="nf">push</span><span class="o">:</span><span class="w"> </span><span class="k">$(</span><span class="nv">addprefix</span> <span class="nv">example</span>/<span class="nv">push</span>/,<span class="k">$(</span><span class="nv">example</span>/<span class="nv">SPACK_PACKAGE_IDS</span><span class="k">))</span>
<span class="w">	</span><span class="k">$(</span>info<span class="w"> </span>Updating<span class="w"> </span>the<span class="w"> </span>buildcache<span class="w"> </span>index<span class="k">)</span>
<span class="w">	</span><span class="k">$(</span>SPACK<span class="k">)</span><span class="w"> </span>-e<span class="w"> </span>.<span class="w"> </span>buildcache<span class="w"> </span>update-index<span class="w"> </span><span class="k">$(</span>BUILDCACHE_DIR<span class="k">)</span>
<span class="w">	</span><span class="k">$(</span>info<span class="w"> </span>Done!<span class="k">)</span>
<span class="w">	</span>@touch<span class="w"> </span><span class="nv">$@</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="build_settings.html" class="btn btn-neutral float-left" title="Concretization Settings (concretizer.yaml)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="containers.html" class="btn btn-neutral float-right" title="Container Images" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>