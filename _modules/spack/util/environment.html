

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.util.environment &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.util.environment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.util.environment</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="sd">&quot;&quot;&quot;Set, unset or modify environment variables.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">llnl.path</span> <span class="kn">import</span> <span class="n">path_to_os_path</span><span class="p">,</span> <span class="n">system_path_filter</span>
<span class="kn">from</span> <span class="nn">llnl.util</span> <span class="kn">import</span> <span class="n">tty</span>
<span class="kn">from</span> <span class="nn">llnl.util.lang</span> <span class="kn">import</span> <span class="n">dedupe</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
    <span class="n">SYSTEM_PATHS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Program Files&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Program Files (x86)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Users&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">ProgramData&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">SUFFIXES</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">SYSTEM_PATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;/usr&quot;</span><span class="p">,</span> <span class="s2">&quot;/usr/local&quot;</span><span class="p">]</span>
    <span class="n">SUFFIXES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;bin64&quot;</span><span class="p">,</span> <span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;lib64&quot;</span><span class="p">]</span>

<span class="n">SYSTEM_DIRS</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SUFFIXES</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">SYSTEM_PATHS</span><span class="p">]</span> <span class="o">+</span> <span class="n">SYSTEM_PATHS</span>

<span class="c1">#: used in the compiler wrapper&#39;s `/usr/lib|/usr/lib64|...)` case entry</span>
<span class="n">SYSTEM_DIR_CASE_ENTRY</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">d</span><span class="si">}{</span><span class="n">suff</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">SYSTEM_DIRS</span> <span class="k">for</span> <span class="n">suff</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)))</span>

<span class="n">_SHELL_SET_STRINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sh&quot;</span><span class="p">:</span> <span class="s2">&quot;export </span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;csh&quot;</span><span class="p">:</span> <span class="s2">&quot;setenv </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fish&quot;</span><span class="p">:</span> <span class="s2">&quot;set -gx </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bat&quot;</span><span class="p">:</span> <span class="s1">&#39;set &quot;</span><span class="si">{0}</span><span class="s1">=</span><span class="si">{1}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pwsh&quot;</span><span class="p">:</span> <span class="s2">&quot;$Env:</span><span class="si">{0}</span><span class="s2">=&#39;</span><span class="si">{1}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">_SHELL_UNSET_STRINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sh&quot;</span><span class="p">:</span> <span class="s2">&quot;unset </span><span class="si">{0}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;csh&quot;</span><span class="p">:</span> <span class="s2">&quot;unsetenv </span><span class="si">{0}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fish&quot;</span><span class="p">:</span> <span class="s2">&quot;set -e </span><span class="si">{0}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bat&quot;</span><span class="p">:</span> <span class="s1">&#39;set &quot;</span><span class="si">{0}</span><span class="s1">=&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pwsh&quot;</span><span class="p">:</span> <span class="s2">&quot;Set-Item -Path Env:</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">TRACING_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">Path</span> <span class="o">=</span> <span class="nb">str</span>
<span class="n">ModificationList</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;NameModifier&quot;</span><span class="p">,</span> <span class="s2">&quot;NameValueModifier&quot;</span><span class="p">]]</span>


<div class="viewcode-block" id="system_env_normalize">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.system_env_normalize">[docs]</a>
<span class="k">def</span> <span class="nf">system_env_normalize</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator wrapping calls to system env modifications,</span>
<span class="sd">    converting all env variable names to all upper case on Windows, no-op</span>
<span class="sd">    on other platforms before calling env modification method.</span>

<span class="sd">    Windows, due to a DOS holdover, treats all env variable names case</span>
<span class="sd">    insensitively, however Spack&#39;s env modification class does not,</span>
<span class="sd">    meaning setting `Path` and `PATH` would be distinct env operations</span>
<span class="sd">    for Spack, but would cause a collision when actually performing the</span>
<span class="sd">    env modification operations on the env.</span>
<span class="sd">    Normalize all env names to all caps to prevent this collision from the</span>
<span class="sd">    Spack side.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">case_insensitive_modification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">case_insensitive_modification</span></div>



<div class="viewcode-block" id="is_system_path">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.is_system_path">[docs]</a>
<span class="k">def</span> <span class="nf">is_system_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if the argument is a system path, False otherwise.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">SYSTEM_DIRS</span><span class="p">)</span></div>



<div class="viewcode-block" id="filter_system_paths">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.filter_system_paths">[docs]</a>
<span class="k">def</span> <span class="nf">filter_system_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a copy of the input where system paths are filtered out.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_system_path</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span></div>



<div class="viewcode-block" id="deprioritize_system_paths">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.deprioritize_system_paths">[docs]</a>
<span class="k">def</span> <span class="nf">deprioritize_system_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reorders input paths by putting system paths at the end of the list, otherwise</span>
<span class="sd">    preserving order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">is_system_path</span><span class="p">))</span></div>



<div class="viewcode-block" id="prune_duplicate_paths">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.prune_duplicate_paths">[docs]</a>
<span class="k">def</span> <span class="nf">prune_duplicate_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the input list with duplicates removed, otherwise preserving order.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dedupe</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_path">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.get_path">[docs]</a>
<span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given the name of an environment variable containing multiple</span>
<span class="sd">    paths separated by &#39;os.pathsep&#39;, returns a list of the paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="env_flag">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.env_flag">[docs]</a>
<span class="k">def</span> <span class="nf">env_flag</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given the name of an environment variable, returns True if it is set to</span>
<span class="sd">    &#39;true&#39; or to &#39;1&#39;, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="path_set">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.path_set">[docs]</a>
<span class="k">def</span> <span class="nf">path_set</span><span class="p">(</span><span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">directories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets the variable passed as input to the `os.pathsep` joined list of directories.&quot;&quot;&quot;</span>
    <span class="n">path_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span> <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_str</span></div>



<div class="viewcode-block" id="path_put_first">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.path_put_first">[docs]</a>
<span class="k">def</span> <span class="nf">path_put_first</span><span class="p">(</span><span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">directories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Puts the provided directories first in the path, adding them</span>
<span class="sd">    if they&#39;re not already there.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

    <span class="n">new_path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path_set</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span></div>



<span class="n">BASH_FUNCTION_FINDER</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;BASH_FUNC_(.*?)\(\)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_win_env_var_to_set_line</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">is_pwsh</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_SHELL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pwsh&quot;</span>
    <span class="n">env_set_phrase</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$Env:</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">is_pwsh</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;set &quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    <span class="k">return</span> <span class="n">env_set_phrase</span>


<span class="k">def</span> <span class="nf">_nix_env_var_to_source_line</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;BASH_FUNC&quot;</span><span class="p">):</span>
        <span class="n">source_line</span> <span class="o">=</span> <span class="s2">&quot;function </span><span class="si">{fname}{decl}</span><span class="s2">; export -f </span><span class="si">{fname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">fname</span><span class="o">=</span><span class="n">BASH_FUNCTION_FINDER</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span> <span class="n">decl</span><span class="o">=</span><span class="n">val</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">source_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2">; export </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">source_line</span>


<span class="k">def</span> <span class="nf">_env_var_to_source_line</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_win_env_var_to_set_line</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_nix_env_var_to_source_line</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>


<div class="viewcode-block" id="dump_environment">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.dump_environment">[docs]</a>
<span class="nd">@system_path_filter</span><span class="p">(</span><span class="n">arg_slice</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">dump_environment</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dump an environment dictionary to a source-able file.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: path of the file to write</span>
<span class="sd">        environment: environment to be writte. If None os.environ is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">use_env</span> <span class="o">=</span> <span class="n">environment</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="n">hidden_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PS1&quot;</span><span class="p">,</span> <span class="s2">&quot;PWD&quot;</span><span class="p">,</span> <span class="s2">&quot;OLDPWD&quot;</span><span class="p">,</span> <span class="s2">&quot;TERM_SESSION_ID&quot;</span><span class="p">}</span>

    <span class="n">file_descriptor</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">,</span> <span class="mo">0o600</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">file_descriptor</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">use_env</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;#&quot;</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">hidden_vars</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">_env_var_to_source_line</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="pickle_environment">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.pickle_environment">[docs]</a>
<span class="nd">@system_path_filter</span><span class="p">(</span><span class="n">arg_slice</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">pickle_environment</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pickle an environment dictionary to a file.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">environment</span> <span class="k">if</span> <span class="n">environment</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">),</span> <span class="n">pickle_file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="set_env">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.set_env">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">set_env</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Temporarily sets and restores environment variables.</span>

<span class="sd">    Variables can be set as keyword arguments to this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saved</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">saved</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">yield</span>

    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">saved</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span></div>



<div class="viewcode-block" id="Trace">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.Trace">[docs]</a>
<span class="k">class</span> <span class="nc">Trace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trace information on a function call&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;lineno&quot;</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">lineno</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Trace(filename=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">, lineno=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">, context=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">)&quot;</span></div>



<div class="viewcode-block" id="NameModifier">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.NameModifier">[docs]</a>
<span class="k">class</span> <span class="nc">NameModifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for modifiers that act on the environment variable as a whole, and thus</span>
<span class="sd">    store just its name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;separator&quot;</span><span class="p">,</span> <span class="s2">&quot;trace&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trace</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="n">separator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NameModifier</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="NameModifier.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.NameModifier.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the modification to the mapping passed as input&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;must be implemented by derived classes&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="NameValueModifier">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.NameValueModifier">[docs]</a>
<span class="k">class</span> <span class="nc">NameValueModifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for modifiers that modify the value of an environment variable.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;separator&quot;</span><span class="p">,</span> <span class="s2">&quot;trace&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trace</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="n">separator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NameValueModifier</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">separator</span>
        <span class="p">)</span>

<div class="viewcode-block" id="NameValueModifier.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.NameValueModifier.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the modification to the mapping passed as input&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;must be implemented by derived classes&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SetEnv">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.SetEnv">[docs]</a>
<span class="k">class</span> <span class="nc">SetEnv</span><span class="p">(</span><span class="n">NameValueModifier</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">trace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trace</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">force</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span>

<div class="viewcode-block" id="SetEnv.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.SetEnv.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SetEnv: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="AppendFlagsEnv">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.AppendFlagsEnv">[docs]</a>
<span class="k">class</span> <span class="nc">AppendFlagsEnv</span><span class="p">(</span><span class="n">NameValueModifier</span><span class="p">):</span>
<div class="viewcode-block" id="AppendFlagsEnv.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.AppendFlagsEnv.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AppendFlagsEnv: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">env</span> <span class="ow">and</span> <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
            <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="UnsetEnv">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.UnsetEnv">[docs]</a>
<span class="k">class</span> <span class="nc">UnsetEnv</span><span class="p">(</span><span class="n">NameModifier</span><span class="p">):</span>
<div class="viewcode-block" id="UnsetEnv.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.UnsetEnv.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UnsetEnv: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># Avoid throwing if the variable was not set</span>
        <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RemoveFlagsEnv">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.RemoveFlagsEnv">[docs]</a>
<span class="k">class</span> <span class="nc">RemoveFlagsEnv</span><span class="p">(</span><span class="n">NameValueModifier</span><span class="p">):</span>
<div class="viewcode-block" id="RemoveFlagsEnv.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.RemoveFlagsEnv.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RemoveFlagsEnv: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">environment_value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">environment_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span> <span class="k">if</span> <span class="n">environment_value</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flags</span> <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SetPath">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.SetPath">[docs]</a>
<span class="k">class</span> <span class="nc">SetPath</span><span class="p">(</span><span class="n">NameValueModifier</span><span class="p">):</span>
<div class="viewcode-block" id="SetPath.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.SetPath.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">string_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SetPath: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">string_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_path</span></div>
</div>



<div class="viewcode-block" id="AppendPath">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.AppendPath">[docs]</a>
<span class="k">class</span> <span class="nc">AppendPath</span><span class="p">(</span><span class="n">NameValueModifier</span><span class="p">):</span>
<div class="viewcode-block" id="AppendPath.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.AppendPath.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AppendPath: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">environment_value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">environment_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span> <span class="k">if</span> <span class="n">environment_value</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_to_os_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PrependPath">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.PrependPath">[docs]</a>
<span class="k">class</span> <span class="nc">PrependPath</span><span class="p">(</span><span class="n">NameValueModifier</span><span class="p">):</span>
<div class="viewcode-block" id="PrependPath.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.PrependPath.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PrependPath: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">environment_value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">environment_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span> <span class="k">if</span> <span class="n">environment_value</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_os_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()]</span> <span class="o">+</span> <span class="n">directories</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RemovePath">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.RemovePath">[docs]</a>
<span class="k">class</span> <span class="nc">RemovePath</span><span class="p">(</span><span class="n">NameValueModifier</span><span class="p">):</span>
<div class="viewcode-block" id="RemovePath.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.RemovePath.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RemovePath: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">environment_value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">environment_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">path_to_os_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">directories</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">path_to_os_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DeprioritizeSystemPaths">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.DeprioritizeSystemPaths">[docs]</a>
<span class="k">class</span> <span class="nc">DeprioritizeSystemPaths</span><span class="p">(</span><span class="n">NameModifier</span><span class="p">):</span>
<div class="viewcode-block" id="DeprioritizeSystemPaths.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.DeprioritizeSystemPaths.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DeprioritizeSystemPaths: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">environment_value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">environment_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span> <span class="k">if</span> <span class="n">environment_value</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">deprioritize_system_paths</span><span class="p">(</span>
            <span class="p">[</span><span class="n">path_to_os_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PruneDuplicatePaths">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.PruneDuplicatePaths">[docs]</a>
<span class="k">class</span> <span class="nc">PruneDuplicatePaths</span><span class="p">(</span><span class="n">NameModifier</span><span class="p">):</span>
<div class="viewcode-block" id="PruneDuplicatePaths.execute">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.PruneDuplicatePaths.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PruneDuplicatePaths: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">environment_value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">environment_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span> <span class="k">if</span> <span class="n">environment_value</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">prune_duplicate_paths</span><span class="p">(</span>
            <span class="p">[</span><span class="n">path_to_os_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EnvironmentModifications">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications">[docs]</a>
<span class="k">class</span> <span class="nc">EnvironmentModifications</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keeps track of requests to modify the current environment.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;EnvironmentModifications&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">traced</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a new instance, copying commands from &#39;other&#39;</span>
<span class="sd">        if it is not None.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: list of environment modifications to be extended (optional)</span>
<span class="sd">            traced: enable or disable stack trace inspection to log the origin</span>
<span class="sd">                of the environment modifications</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traced</span> <span class="o">=</span> <span class="n">TRACING_ENABLED</span> <span class="k">if</span> <span class="n">traced</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">traced</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">NameModifier</span><span class="p">,</span> <span class="n">NameValueModifier</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="p">)</span>

<div class="viewcode-block" id="EnvironmentModifications.extend">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.extend">[docs]</a>
    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;EnvironmentModifications&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_other</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">env_modifications</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_other</span><span class="p">(</span><span class="n">other</span><span class="p">:</span> <span class="s2">&quot;EnvironmentModifications&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">EnvironmentModifications</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;other must be an instance of EnvironmentModifications&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trace</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a trace object if tracing is enabled, else None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">traced</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;index must be an integer&quot;</span>
            <span class="n">current_context</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;unknown context&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;unknown file&quot;</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">current_context</span> <span class="o">=</span> <span class="s2">&quot;unknown context&quot;</span>

        <span class="k">return</span> <span class="n">Trace</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">current_context</span><span class="p">)</span>

<div class="viewcode-block" id="EnvironmentModifications.set">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.set">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to set an environment variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            value: value of the environment variable</span>
<span class="sd">            force: if True, audit will not consider this modification a warning</span>
<span class="sd">            raw: if True, format of value string is skipped</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">SetEnv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.append_flags">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.append_flags">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">append_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to append &#39;flags&#39; to an environment variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            value: flags to be appended</span>
<span class="sd">            sep: separator for the flags (default: &quot; &quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">AppendFlagsEnv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.unset">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.unset">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to unset an environment variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">UnsetEnv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.remove_flags">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.remove_flags">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">remove_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to remove flags from an environment variable</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            value: flags to be removed</span>
<span class="sd">            sep: separator for the flags (default: &quot; &quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">RemoveFlagsEnv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.set_path">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.set_path">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">set_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to set an environment variable to a list of paths,</span>
<span class="sd">        separated by a character defined in input.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            elements: ordered list paths</span>
<span class="sd">            separator: separator for the paths (default: os.pathsep)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">SetPath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.append_path">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.append_path">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">append_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to append a path to list of paths.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            path: path to be appended</span>
<span class="sd">            separator: separator for the paths (default: os.pathsep)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">AppendPath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.prepend_path">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.prepend_path">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">prepend_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to prepend a path to list of paths.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            path: path to be prepended</span>
<span class="sd">            separator: separator for the paths (default: os.pathsep)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">PrependPath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.remove_path">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.remove_path">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">remove_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to remove a path from a list of paths.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            path: path to be removed</span>
<span class="sd">            separator: separator for the paths (default: os.pathsep)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">RemovePath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.deprioritize_system_paths">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.deprioritize_system_paths">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">deprioritize_system_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to deprioritize system paths in a path list,</span>
<span class="sd">        otherwise preserving the order.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            separator: separator for the paths (default: os.pathsep)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">DeprioritizeSystemPaths</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.prune_duplicate_paths">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.prune_duplicate_paths">[docs]</a>
    <span class="nd">@system_env_normalize</span>
    <span class="k">def</span> <span class="nf">prune_duplicate_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores a request to remove duplicates from a path list, otherwise</span>
<span class="sd">        preserving the order.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of the environment variable</span>
<span class="sd">            separator: separator for the paths (default: os.pathsep)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">PruneDuplicatePaths</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.group_by_name">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.group_by_name">[docs]</a>
    <span class="k">def</span> <span class="nf">group_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModificationList</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dict of the current modifications keyed by variable name.&quot;&quot;&quot;</span>
        <span class="n">modifications</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">modifications</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">modifications</span></div>


<div class="viewcode-block" id="EnvironmentModifications.drop">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.drop">[docs]</a>
    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop all modifications to the variable with the given name.&quot;&quot;&quot;</span>
        <span class="n">old_mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span>
        <span class="n">new_mods</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span> <span class="o">=</span> <span class="n">new_mods</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_mods</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_mods</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.is_unset">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.is_unset">[docs]</a>
    <span class="k">def</span> <span class="nf">is_unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the last modification to a variable is to unset it, False otherwise.&quot;&quot;&quot;</span>
        <span class="n">modifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">variable_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># The last modification must unset the variable for it to be considered unset</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modifications</span><span class="p">[</span><span class="n">variable_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">UnsetEnv</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.clear">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clears the current list of modifications.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="EnvironmentModifications.reversed">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.reversed">[docs]</a>
    <span class="k">def</span> <span class="nf">reversed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EnvironmentModifications&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the EnvironmentModifications object that will reverse self</span>

<span class="sd">        Only creates reversals for additions to the environment, as reversing</span>
<span class="sd">        ``unset`` and ``remove_path`` modifications is impossible.</span>

<span class="sd">        Reversable operations are set(), prepend_path(), append_path(),</span>
<span class="sd">        set_path(), and append_flags().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rev</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">envmod</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_modifications</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">envmod</span><span class="p">,</span> <span class="n">SetEnv</span><span class="p">):</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reversing `Set` environment operation may lose the original value&quot;</span><span class="p">)</span>
                <span class="n">rev</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">envmod</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">envmod</span><span class="p">,</span> <span class="n">AppendPath</span><span class="p">):</span>
                <span class="n">rev</span><span class="o">.</span><span class="n">remove_path</span><span class="p">(</span><span class="n">envmod</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">envmod</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">envmod</span><span class="p">,</span> <span class="n">PrependPath</span><span class="p">):</span>
                <span class="n">rev</span><span class="o">.</span><span class="n">remove_path</span><span class="p">(</span><span class="n">envmod</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">envmod</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">envmod</span><span class="p">,</span> <span class="n">SetPath</span><span class="p">):</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reversing `SetPath` environment operation may lose the original value&quot;</span><span class="p">)</span>
                <span class="n">rev</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">envmod</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">envmod</span><span class="p">,</span> <span class="n">AppendFlagsEnv</span><span class="p">):</span>
                <span class="n">rev</span><span class="o">.</span><span class="n">remove_flags</span><span class="p">(</span><span class="n">envmod</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">envmod</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Skipping reversal of irreversible operation </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">envmod</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">envmod</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">rev</span></div>


<div class="viewcode-block" id="EnvironmentModifications.apply_modifications">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.apply_modifications">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_modifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the modifications and clears the list.</span>

<span class="sd">        Args:</span>
<span class="sd">            env: environment to be modified. If None, os.environ will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">env</span>

        <span class="n">modifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by_name</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">modifications</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">modifier</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="n">modifier</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">env</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.shell_modifications">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.shell_modifications">[docs]</a>
    <span class="k">def</span> <span class="nf">shell_modifications</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shell</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sh&quot;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;win32&quot;</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_SHELL&quot;</span><span class="p">,</span> <span class="s2">&quot;bat&quot;</span><span class="p">),</span>
        <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return shell code to apply the modifications and clears the list.&quot;&quot;&quot;</span>
        <span class="n">modifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by_name</span><span class="p">()</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">env</span>
        <span class="n">new_env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">modifications</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">modifier</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="n">modifier</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">new_env</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;MANPATH&quot;</span> <span class="ow">in</span> <span class="n">new_env</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_env</span><span class="p">[</span><span class="s2">&quot;MANPATH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
            <span class="n">new_env</span><span class="p">[</span><span class="s2">&quot;MANPATH&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span>

        <span class="n">cmds</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">modifications</span><span class="p">)):</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">explicit</span> <span class="ow">or</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">old</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cmds</span> <span class="o">+=</span> <span class="n">_SHELL_UNSET_STRINGS</span><span class="p">[</span><span class="n">shell</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">new_env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">shell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bat&quot;</span><span class="p">,</span> <span class="s2">&quot;pwsh&quot;</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">_SHELL_SET_STRINGS</span><span class="p">[</span><span class="n">shell</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">cmds</span> <span class="o">+=</span> <span class="n">cmd</span>
        <span class="k">return</span> <span class="n">cmds</span></div>


<div class="viewcode-block" id="EnvironmentModifications.from_sourcing_file">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.from_sourcing_file">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_sourcing_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EnvironmentModifications&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the environment modifications that have the same effect as</span>
<span class="sd">        sourcing the input file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: the file to be sourced</span>
<span class="sd">            *arguments: arguments to pass on the command line</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            shell (str): the shell to use (default: ``bash``)</span>
<span class="sd">            shell_options (str): options passed to the shell (default: ``-c``)</span>
<span class="sd">            source_command (str): the command to run (default: ``source``)</span>
<span class="sd">            suppress_output (str): redirect used to suppress output of command</span>
<span class="sd">                (default: ``&amp;&gt; /dev/null``)</span>
<span class="sd">            concatenate_on_success (str): operator used to execute a command</span>
<span class="sd">                only when the previous command succeeds (default: ``&amp;&amp;``)</span>
<span class="sd">            exclude ([str or re.Pattern[str]]): ignore any modifications of these</span>
<span class="sd">                variables (default: [])</span>
<span class="sd">            include ([str or re.Pattern[str]]): always respect modifications of these</span>
<span class="sd">                variables (default: []). Supersedes any excluded variables.</span>
<span class="sd">            clean (bool): in addition to removing empty entries,</span>
<span class="sd">                also remove duplicate entries (default: False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EnvironmentModifications.from_sourcing_file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Check if the file actually exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Trying to source non-existing file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Prepare include and exclude lists of environment variable names</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">include</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">clean</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Other variables unrelated to sourcing a file</span>
        <span class="n">exclude</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="c1"># Bash internals</span>
                <span class="s2">&quot;SHLVL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;PWD&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OLDPWD&quot;</span><span class="p">,</span>
                <span class="s2">&quot;PS1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;PS2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ENV&quot;</span><span class="p">,</span>
                <span class="c1"># Environment Modules or Lmod</span>
                <span class="s2">&quot;LOADEDMODULES&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_LMFILES_&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MODULEPATH&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MODULERCFILE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;BASH_FUNC_ml()&quot;</span><span class="p">,</span>
                <span class="s2">&quot;BASH_FUNC_module()&quot;</span><span class="p">,</span>
                <span class="c1"># Environment Modules-specific configuration</span>
                <span class="s2">&quot;MODULESHOME&quot;</span><span class="p">,</span>
                <span class="s2">&quot;BASH_FUNC__module_raw()&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;MODULES_(.*)&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;__MODULES_(.*)&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;(\w*)_mod(quar|share)&quot;</span><span class="p">,</span>
                <span class="c1"># Lmod-specific configuration</span>
                <span class="sa">r</span><span class="s2">&quot;LMOD_(.*)&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Compute the environments before and after sourcing</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">sanitize</span><span class="p">(</span>
            <span class="n">environment_after_sourcing_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
            <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">file_and_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">filename</span><span class="p">,)</span> <span class="o">+</span> <span class="n">arguments</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">sanitize</span><span class="p">(</span>
            <span class="n">environment_after_sourcing_files</span><span class="p">(</span><span class="n">file_and_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
            <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Delegate to the other factory</span>
        <span class="k">return</span> <span class="n">EnvironmentModifications</span><span class="o">.</span><span class="n">from_environment_diff</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">clean</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentModifications.from_environment_diff">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.EnvironmentModifications.from_environment_diff">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_environment_diff</span><span class="p">(</span>
        <span class="n">before</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">after</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EnvironmentModifications&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs the environment modifications from the diff of two environments.</span>

<span class="sd">        Args:</span>
<span class="sd">            before: environment before the modifications are applied</span>
<span class="sd">            after: environment after the modifications are applied</span>
<span class="sd">            clean: in addition to removing empty entries, also remove duplicate entries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fill the EnvironmentModifications instance</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span>
        <span class="c1"># New variables</span>
        <span class="n">new_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">before</span><span class="p">))</span>
        <span class="c1"># Variables that have been unset</span>
        <span class="n">unset_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">before</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="p">))</span>
        <span class="c1"># Variables that have been modified</span>
        <span class="n">common_variables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">before</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="p">))</span>
        <span class="n">modified_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">common_variables</span> <span class="k">if</span> <span class="n">before</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">after</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
        <span class="c1"># Consistent output order - looks nicer, easier comparison...</span>
        <span class="n">new_variables</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">unset_variables</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">modified_variables</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">return_separator_if_any</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">separators</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span>
            <span class="k">for</span> <span class="n">separator</span> <span class="ow">in</span> <span class="n">separators</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">separator</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">separator</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Add variables to env.</span>
        <span class="c1"># Assume that variables with &#39;PATH&#39; in the name or that contain</span>
        <span class="c1"># separators like &#39;:&#39; or &#39;;&#39; are more likely to be paths</span>
        <span class="k">for</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">new_variables</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">return_separator_if_any</span><span class="p">(</span><span class="n">after</span><span class="p">[</span><span class="n">variable_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sep</span><span class="p">:</span>
                <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">after</span><span class="p">[</span><span class="n">variable_name</span><span class="p">],</span> <span class="n">separator</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;PATH&quot;</span> <span class="ow">in</span> <span class="n">variable_name</span><span class="p">:</span>
                <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">after</span><span class="p">[</span><span class="n">variable_name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We just need to set the variable to the new value</span>
                <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">after</span><span class="p">[</span><span class="n">variable_name</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">unset_variables</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">variable_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">modified_variables</span><span class="p">:</span>
            <span class="n">value_before</span> <span class="o">=</span> <span class="n">before</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span>
            <span class="n">value_after</span> <span class="o">=</span> <span class="n">after</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">return_separator_if_any</span><span class="p">(</span><span class="n">value_before</span><span class="p">,</span> <span class="n">value_after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sep</span><span class="p">:</span>
                <span class="n">before_list</span> <span class="o">=</span> <span class="n">value_before</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
                <span class="n">after_list</span> <span class="o">=</span> <span class="n">value_after</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

                <span class="c1"># Filter out empty strings</span>
                <span class="n">before_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">before_list</span><span class="p">))</span>
                <span class="n">after_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">after_list</span><span class="p">))</span>

                <span class="c1"># Remove duplicate entries (worse matching, bloats env)</span>
                <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
                    <span class="n">before_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dedupe</span><span class="p">(</span><span class="n">before_list</span><span class="p">))</span>
                    <span class="n">after_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dedupe</span><span class="p">(</span><span class="n">after_list</span><span class="p">))</span>
                    <span class="c1"># The reassembled cleaned entries</span>
                    <span class="n">value_before</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">before_list</span><span class="p">)</span>
                    <span class="n">value_after</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">after_list</span><span class="p">)</span>

                <span class="c1"># Paths that have been removed</span>
                <span class="n">remove_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">before_list</span> <span class="k">if</span> <span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">after_list</span><span class="p">]</span>
                <span class="c1"># Check that nothing has been added in the middle of</span>
                <span class="c1"># before_list</span>
                <span class="n">remaining_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">before_list</span> <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">after_list</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">after_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">remaining_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">after_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">remaining_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">search</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">after_list</span><span class="p">[</span><span class="n">start</span> <span class="p">:</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">value_after</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">search</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value_before</span><span class="p">:</span>
                    <span class="c1"># We just need to set the variable to the new value</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">value_after</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">prepend_list</span> <span class="o">=</span> <span class="n">after_list</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span>
                        <span class="n">prepend_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>  <span class="c1"># Preserve order after prepend</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">prepend_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">append_list</span> <span class="o">=</span> <span class="n">after_list</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">append_list</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">remove_list</span><span class="p">:</span>
                        <span class="n">env</span><span class="o">.</span><span class="n">remove_path</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">append_list</span><span class="p">:</span>
                        <span class="n">env</span><span class="o">.</span><span class="n">append_path</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prepend_list</span><span class="p">:</span>
                        <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We just need to set the variable to the new value</span>
                <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">value_after</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">env</span></div>
</div>



<span class="k">def</span> <span class="nf">_set_or_unset_not_first</span><span class="p">(</span>
    <span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">changes</span><span class="p">:</span> <span class="n">ModificationList</span><span class="p">,</span> <span class="n">errstream</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if we are going to set or unset something after other</span>
<span class="sd">    modifications have already been requested.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ii</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">SetEnv</span><span class="p">,</span> <span class="n">UnsetEnv</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">indexes</span><span class="p">:</span>
        <span class="n">good</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">    </span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="n">nogood</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">---&gt;</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="n">errstream</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Different requests to set/unset &#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&#39; have been found&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">changes</span><span class="p">):</span>
            <span class="n">print_format</span> <span class="o">=</span> <span class="n">nogood</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indexes</span> <span class="k">else</span> <span class="n">good</span>
            <span class="n">errstream</span><span class="p">(</span><span class="n">print_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">trace</span><span class="p">))</span>


<div class="viewcode-block" id="validate">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.validate">[docs]</a>
<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n">EnvironmentModifications</span><span class="p">,</span> <span class="n">errstream</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates the environment modifications to check for the presence of</span>
<span class="sd">    suspicious patterns. Prompts a warning for everything that was found.</span>

<span class="sd">    Current checks:</span>
<span class="sd">    - set or unset variables after other changes on the same variable</span>

<span class="sd">    Args:</span>
<span class="sd">        env: list of environment modifications</span>
<span class="sd">        errstream: callable to log error messages</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">traced</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">modifications</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">group_by_name</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">list_of_changes</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">modifications</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">_set_or_unset_not_first</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">list_of_changes</span><span class="p">,</span> <span class="n">errstream</span><span class="p">)</span></div>



<div class="viewcode-block" id="inspect_path">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.inspect_path">[docs]</a>
<span class="k">def</span> <span class="nf">inspect_path</span><span class="p">(</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">inspections</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Path</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvironmentModifications</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inspects ``root`` to search for the subdirectories in ``inspections``.</span>
<span class="sd">    Adds every path found to a list of prepend-path commands and returns it.</span>

<span class="sd">    Args:</span>
<span class="sd">        root: absolute path where to search for subdirectories</span>
<span class="sd">        inspections: maps relative paths to a list of environment</span>
<span class="sd">            variables that will be modified if the path exists. The</span>
<span class="sd">            modifications are not performed immediately, but stored in a</span>
<span class="sd">            command object that is returned to client</span>
<span class="sd">        exclude: optional callable. If present it must accept an</span>
<span class="sd">            absolute path and return True if it should be excluded from the</span>
<span class="sd">            inspection</span>

<span class="sd">    Examples:</span>

<span class="sd">    The following lines execute an inspection in ``/usr`` to search for</span>
<span class="sd">    ``/usr/include`` and ``/usr/lib64``. If found we want to prepend</span>
<span class="sd">    ``/usr/include`` to ``CPATH`` and ``/usr/lib64`` to ``MY_LIB64_PATH``.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # Set up the dictionary containing the inspection</span>
<span class="sd">            inspections = {</span>
<span class="sd">                &#39;include&#39;: [&#39;CPATH&#39;],</span>
<span class="sd">                &#39;lib64&#39;: [&#39;MY_LIB64_PATH&#39;]</span>
<span class="sd">            }</span>

<span class="sd">            # Get back the list of command needed to modify the environment</span>
<span class="sd">            env = inspect_path(&#39;/usr&#39;, inspections)</span>

<span class="sd">            # Eventually execute the commands</span>
<span class="sd">            env.apply_modifications()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">False</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span>
    <span class="c1"># Inspect the prefix to check for the existence of common directories</span>
    <span class="k">for</span> <span class="n">relative_path</span><span class="p">,</span> <span class="n">variables</span> <span class="ow">in</span> <span class="n">inspections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">relative_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">env</span></div>



<div class="viewcode-block" id="preserve_environment">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.preserve_environment">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">preserve_environment</span><span class="p">(</span><span class="o">*</span><span class="n">variables</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensures that the value of the environment variables passed as</span>
<span class="sd">    arguments is the same before entering to the context manager and after</span>
<span class="sd">    exiting it.</span>

<span class="sd">    Variables that are unset before entering the context manager will be</span>
<span class="sd">    explicitly unset on exit.</span>

<span class="sd">    Args:</span>
<span class="sd">        variables: list of environment variables to be preserved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="c1"># The environment variable to be preserved might not be there.</span>
        <span class="c1"># In that case store None as a placeholder.</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">yield</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;[PRESERVE_ENVIRONMENT]&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Print a debug statement if the value changed</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> was unset, will be reset to &quot;</span><span class="si">{1}</span><span class="s1">&quot;&#39;</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> was set to &quot;</span><span class="si">{1}</span><span class="s1">&quot;, will be reset to &quot;</span><span class="si">{2}</span><span class="s1">&quot;&#39;</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">value</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> was set to &quot;</span><span class="si">{1}</span><span class="s1">&quot;, will be unset&#39;</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]))</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span></div>



<div class="viewcode-block" id="environment_after_sourcing_files">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.environment_after_sourcing_files">[docs]</a>
<span class="k">def</span> <span class="nf">environment_after_sourcing_files</span><span class="p">(</span>
    <span class="o">*</span><span class="n">files</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a dictionary with the environment that one would have</span>
<span class="sd">    after sourcing the files passed as argument.</span>

<span class="sd">    Args:</span>
<span class="sd">        *files: each item can either be a string containing the path</span>
<span class="sd">            of the file to be sourced or a sequence, where the first element</span>
<span class="sd">            is the file to be sourced and the remaining are arguments to be</span>
<span class="sd">            passed to the command line</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        env (dict): the initial environment (default: current environment)</span>
<span class="sd">        shell (str): the shell to use (default: ``/bin/bash`` or ``cmd.exe`` (Windows))</span>
<span class="sd">        shell_options (str): options passed to the shell (default: ``-c`` or ``/C`` (Windows))</span>
<span class="sd">        source_command (str): the command to run (default: ``source``)</span>
<span class="sd">        suppress_output (str): redirect used to suppress output of command</span>
<span class="sd">            (default: ``&amp;&gt; /dev/null``)</span>
<span class="sd">        concatenate_on_success (str): operator used to execute a command</span>
<span class="sd">            only when the previous command succeeds (default: ``&amp;&amp;``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set the shell executable that will be used to source files</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="n">shell_cmd</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd.exe&quot;</span><span class="p">)</span>
        <span class="n">shell_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shell_options&quot;</span><span class="p">,</span> <span class="s2">&quot;/C&quot;</span><span class="p">)</span>
        <span class="n">suppress_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suppress_output&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">source_command</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_command&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shell_cmd</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;/bin/bash&quot;</span><span class="p">)</span>
        <span class="n">shell_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shell_options&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">)</span>
        <span class="n">suppress_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suppress_output&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&gt; /dev/null&quot;</span><span class="p">)</span>
        <span class="n">source_command</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_command&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">)</span>
    <span class="n">concatenate_on_success</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concatenate_on_success&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_source_single_file</span><span class="p">(</span><span class="n">file_and_args</span><span class="p">,</span> <span class="n">environment</span><span class="p">):</span>
        <span class="n">shell_options_list</span> <span class="o">=</span> <span class="n">shell_options</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="n">source_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_command</span><span class="p">]</span>
        <span class="n">source_file</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">file_and_args</span><span class="p">)</span>
        <span class="n">source_file</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>

        <span class="n">dump_cmd</span> <span class="o">=</span> <span class="s2">&quot;import os, json; print(json.dumps(dict(os.environ)))&quot;</span>
        <span class="n">dump_environment_cmd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; -E -c &quot;</span><span class="si">{</span><span class="n">dump_cmd</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

        <span class="c1"># Try to source the file</span>
        <span class="n">source_file_arguments</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">source_file</span><span class="p">,</span> <span class="n">suppress_output</span><span class="p">,</span> <span class="n">concatenate_on_success</span><span class="p">,</span> <span class="n">dump_environment_cmd</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="n">shell_cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">shell_options_list</span><span class="p">,</span> <span class="n">source_file_arguments</span><span class="p">],</span>
            <span class="n">env</span><span class="o">=</span><span class="n">environment</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">shell</span><span class="p">:</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="n">current_environment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="c1"># Normalize the input to the helper function</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="p">(</span><span class="n">file</span><span class="p">,)</span>

        <span class="n">current_environment</span> <span class="o">=</span> <span class="n">_source_single_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">current_environment</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">current_environment</span></div>



<div class="viewcode-block" id="sanitize">
<a class="viewcode-back" href="../../../spack.util.html#spack.util.environment.sanitize">[docs]</a>
<span class="k">def</span> <span class="nf">sanitize</span><span class="p">(</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">exclude</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">include</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a copy of the input dictionary where all the keys that</span>
<span class="sd">    match an excluded pattern and don&#39;t match an included pattern are</span>
<span class="sd">    removed.</span>

<span class="sd">    Args:</span>
<span class="sd">        environment (dict): input dictionary</span>
<span class="sd">        exclude (list): literals or regex patterns to be excluded</span>
<span class="sd">        include (list): literals or regex patterns to be included</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">set_intersection</span><span class="p">(</span><span class="n">fullset</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># A set intersection using string literals and regexs</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;[$()*?[]^{|}&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">fullset</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># As literal</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fullset</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                        <span class="n">subset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subset</span>

    <span class="c1"># Don&#39;t modify input, make a copy instead</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>

    <span class="c1"># include supersedes any excluded items</span>
    <span class="n">prune</span> <span class="o">=</span> <span class="n">set_intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">environment</span><span class="p">),</span> <span class="o">*</span><span class="n">exclude</span><span class="p">)</span>
    <span class="n">prune</span> <span class="o">-=</span> <span class="n">set_intersection</span><span class="p">(</span><span class="n">prune</span><span class="p">,</span> <span class="o">*</span><span class="n">include</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">prune</span><span class="p">:</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">environment</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>