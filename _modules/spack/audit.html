

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.audit &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.audit</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.audit</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="sd">&quot;&quot;&quot;Classes and functions to register audit checks for various parts of</span>
<span class="sd">Spack and run them on-demand.</span>

<span class="sd">To register a new class of sanity checks (e.g. sanity checks for</span>
<span class="sd">compilers.yaml), the first action required is to create a new AuditClass</span>
<span class="sd">object:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   audit_cfgcmp = AuditClass(</span>
<span class="sd">       tag=&#39;CFG-COMPILER&#39;,</span>
<span class="sd">       description=&#39;Sanity checks on compilers.yaml&#39;,</span>
<span class="sd">       kwargs=()</span>
<span class="sd">   )</span>

<span class="sd">This object is to be used as a decorator to register functions</span>
<span class="sd">that will perform each a single check:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   @audit_cfgcmp</span>
<span class="sd">   def _search_duplicate_compilers(error_cls):</span>
<span class="sd">       pass</span>

<span class="sd">These functions need to take as argument the keywords declared when</span>
<span class="sd">creating the decorator object plus an ``error_cls`` argument at the</span>
<span class="sd">end, acting as a factory to create Error objects. It should return a</span>
<span class="sd">(possibly empty) list of errors.</span>

<span class="sd">Calls to each of these functions are triggered by the ``run`` method of</span>
<span class="sd">the decorator object, that will forward the keyword arguments passed</span>
<span class="sd">as input.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>

<span class="kn">import</span> <span class="nn">llnl.util.lang</span>
<span class="kn">from</span> <span class="nn">llnl.string</span> <span class="kn">import</span> <span class="n">plural</span>

<span class="kn">import</span> <span class="nn">spack.builder</span>
<span class="kn">import</span> <span class="nn">spack.config</span>
<span class="kn">import</span> <span class="nn">spack.fetch_strategy</span>
<span class="kn">import</span> <span class="nn">spack.patch</span>
<span class="kn">import</span> <span class="nn">spack.repo</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.util.crypto</span>
<span class="kn">import</span> <span class="nn">spack.util.spack_yaml</span> <span class="k">as</span> <span class="nn">syaml</span>
<span class="kn">import</span> <span class="nn">spack.variant</span>

<span class="c1">#: Map an audit tag to a list of callables implementing checks</span>
<span class="n">CALLBACKS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">#: Map a group of checks to the list of related audit tags</span>
<span class="n">GROUPS</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>


<div class="viewcode-block" id="Error">
<a class="viewcode-back" href="../../spack.html#spack.audit.Error">[docs]</a>
<span class="k">class</span> <span class="nc">Error</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Information on an error reported in a test.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">summary</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">details</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="AuditClass">
<a class="viewcode-back" href="../../spack.html#spack.audit.AuditClass">[docs]</a>
<span class="k">class</span> <span class="nc">AuditClass</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an object that acts as a decorator to register functions</span>
<span class="sd">        associated with a specific class of sanity checks.</span>

<span class="sd">        Args:</span>
<span class="sd">            group (str): group in which this check is to be inserted</span>
<span class="sd">            tag (str): tag uniquely identifying the class of sanity checks</span>
<span class="sd">            description (str): description of the sanity checks performed</span>
<span class="sd">                by this tag</span>
<span class="sd">            kwargs (tuple of str): keyword arguments that each registered</span>
<span class="sd">                function needs to accept</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">CALLBACKS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;audit class &quot;</span><span class="si">{0}</span><span class="s1">&quot; already registered&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Init the list of hooks</span>
        <span class="n">CALLBACKS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Update the list of tags in the group</span>
        <span class="n">GROUPS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span>

<div class="viewcode-block" id="AuditClass.run">
<a class="viewcode-back" href="../../spack.html#spack.audit.AuditClass.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;please pass &quot;</span><span class="si">{0}</span><span class="s1">&quot; as keyword arguments&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">msg</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;error_cls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Error</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">errors</span></div>
</div>



<div class="viewcode-block" id="run_group">
<a class="viewcode-back" href="../../spack.html#spack.audit.run_group">[docs]</a>
<span class="k">def</span> <span class="nf">run_group</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the checks that are part of the group passed as argument.</span>

<span class="sd">    Args:</span>
<span class="sd">        group (str): group of checks to be run</span>
<span class="sd">        **kwargs: keyword arguments forwarded to the checks</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of (tag, errors) that failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">GROUPS</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">run_check</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">check</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">reports</span></div>



<div class="viewcode-block" id="run_check">
<a class="viewcode-back" href="../../spack.html#spack.audit.run_check">[docs]</a>
<span class="k">def</span> <span class="nf">run_check</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the checks associated with a single tag.</span>

<span class="sd">    Args:</span>
<span class="sd">        tag (str): tag of the check</span>
<span class="sd">        **kwargs: keyword arguments forwarded to the checks</span>

<span class="sd">    Returns:</span>
<span class="sd">        Errors occurred during the checks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CALLBACKS</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="c1"># TODO: For the generic check to be useful for end users,</span>
<span class="c1"># TODO: we need to implement hooks like described in</span>
<span class="c1"># TODO: https://github.com/spack/spack/pull/23053/files#r630265011</span>
<span class="c1">#: Generic checks relying on global state</span>
<span class="n">generic</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;generic&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;GENERIC&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generic checks relying on global variables&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">(),</span>
<span class="p">)</span>


<span class="c1">#: Sanity checks on compilers.yaml</span>
<span class="n">config_compiler</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;configs&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;CFG-COMPILER&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks on compilers.yaml&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">()</span>
<span class="p">)</span>


<span class="nd">@config_compiler</span>
<span class="k">def</span> <span class="nf">_search_duplicate_compilers</span><span class="p">(</span><span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Report compilers with the same spec and two different definitions&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">compilers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compilers&quot;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;compiler&quot;</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">compilers</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;compiler&quot;</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">]):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Compiler defined multiple times: </span><span class="si">{0}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_start_mark</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="c1">#: Sanity checks on packages.yaml</span>
<span class="n">config_packages</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;configs&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;CFG-PACKAGES&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks on packages.yaml&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1">#: Sanity checks on packages.yaml</span>
<span class="n">config_repos</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;configs&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;CFG-REPOS&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks on repositories&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">()</span>
<span class="p">)</span>


<span class="nd">@config_packages</span>
<span class="k">def</span> <span class="nf">_search_duplicate_specs_in_externals</span><span class="p">(</span><span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for duplicate specs declared as externals&quot;&quot;&quot;</span>
    <span class="n">errors</span><span class="p">,</span> <span class="n">externals</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">packages_yaml</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pkg_config</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># No externals can be declared under all</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="s2">&quot;externals&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pkg_config</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">current_externals</span> <span class="o">=</span> <span class="n">pkg_config</span><span class="p">[</span><span class="s2">&quot;externals&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">current_externals</span><span class="p">:</span>
            <span class="c1"># Ask for the string representation of the spec to normalize</span>
            <span class="c1"># aspects of the spec that may be represented in multiple ways</span>
            <span class="c1"># e.g. +foo or foo=true</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]))</span>
            <span class="n">externals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">entries</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">externals</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># If there&#39;s a single external for a spec we are fine</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Otherwise wwe need to report an error</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Multiple externals share the same spec: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_start_mark</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;Please remove all but one of the following entries:&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">lines</span>
                <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;as they might result in non-deterministic hashes&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@config_packages</span>
<span class="k">def</span> <span class="nf">_avoid_mismatched_variants</span><span class="p">(</span><span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Warns if variant preferences have mismatched types or names.&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">packages_yaml</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="p">:</span>
        <span class="c1"># &#39;all:&#39; must be more forgiving, since it is setting defaults for everything</span>
        <span class="k">if</span> <span class="n">pkg_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="s2">&quot;variants&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="n">preferences</span> <span class="o">=</span> <span class="n">packages_yaml</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">][</span><span class="s2">&quot;variants&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preferences</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">preferences</span> <span class="o">=</span> <span class="p">[</span><span class="n">preferences</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">variants</span> <span class="ow">in</span> <span class="n">preferences</span><span class="p">:</span>
            <span class="n">current_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">variants</span><span class="p">)</span>
            <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">current_spec</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># Variant does not exist at all</span>
                <span class="k">if</span> <span class="n">variant</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">variant_names</span><span class="p">():</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Setting a preference for the &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39; package to the &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;non-existing variant &#39;</span><span class="si">{</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_make_config_error</span><span class="p">(</span><span class="n">preferences</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="c1"># Variant cannot accept this value</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">prevalidate_variant_value</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Setting the variant &#39;</span><span class="si">{</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; of the &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39; package &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;to the invalid value &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_make_config_error</span><span class="p">(</span><span class="n">preferences</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@config_packages</span>
<span class="k">def</span> <span class="nf">_wrongly_named_spec</span><span class="p">(</span><span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Warns if the wrong name is used for an external spec&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">packages_yaml</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pkg_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">externals</span> <span class="o">=</span> <span class="n">packages_yaml</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;externals&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">is_virtual</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">externals</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span>
            <span class="n">regular_pkg_is_wrong</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_virtual</span> <span class="ow">and</span> <span class="n">pkg_name</span> <span class="o">!=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span>
            <span class="n">virtual_pkg_is_wrong</span> <span class="o">=</span> <span class="n">is_virtual</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">providers_for</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">regular_pkg_is_wrong</span> <span class="ow">or</span> <span class="n">virtual_pkg_is_wrong</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Wrong external spec detected for &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_make_config_error</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@config_packages</span>
<span class="k">def</span> <span class="nf">_ensure_all_virtual_packages_have_default_providers</span><span class="p">(</span><span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All virtual packages must have a default provider explicitly set.&quot;&quot;&quot;</span>
    <span class="n">configuration</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;defaults&quot;</span><span class="p">)</span>
    <span class="n">default_providers</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">]</span>
    <span class="n">virtuals</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">provider_index</span><span class="o">.</span><span class="n">providers</span>
    <span class="n">default_providers_filename</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">scopes</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_section_filename</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">error_cls</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">virtual</span><span class="si">}</span><span class="s2">&#39; must have a default provider in </span><span class="si">{</span><span class="n">default_providers_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">virtual</span> <span class="ow">in</span> <span class="n">virtuals</span>
        <span class="k">if</span> <span class="n">virtual</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_providers</span>
    <span class="p">]</span>


<span class="nd">@config_repos</span>
<span class="k">def</span> <span class="nf">_ensure_no_folders_without_package_py</span><span class="p">(</span><span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that we don&#39;t leave any folder without a package.py in repos&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">repository</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">repos</span><span class="p">:</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">packages_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">package_py</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">package_file_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">package_py</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">repository</span><span class="o">.</span><span class="n">namespace</span><span class="si">}</span><span class="s2">&#39; repository misses a package.py file&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; in the following folders&quot;</span>
            <span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">errors</span>


<span class="k">def</span> <span class="nf">_make_config_error</span><span class="p">(</span><span class="n">config_data</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Occurring in the following file:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">syaml</span><span class="o">.</span><span class="n">dump_config</span><span class="p">(</span><span class="n">config_data</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">blame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()])</span>


<span class="c1">#: Sanity checks on package directives</span>
<span class="n">package_directives</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;packages&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;PKG-DIRECTIVES&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks on specs used in directives&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pkgs&quot;</span><span class="p">,),</span>
<span class="p">)</span>

<span class="n">package_attributes</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;packages&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;PKG-ATTRIBUTES&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks on reserved attributes of packages&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pkgs&quot;</span><span class="p">,),</span>
<span class="p">)</span>


<span class="n">package_deprecated_attributes</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;packages&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;PKG-DEPRECATED-ATTRIBUTES&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks to preclude use of deprecated package attributes&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pkgs&quot;</span><span class="p">,),</span>
<span class="p">)</span>


<span class="n">package_properties</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;packages&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;PKG-PROPERTIES&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks on properties a package should maintain&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pkgs&quot;</span><span class="p">,),</span>
<span class="p">)</span>


<span class="c1">#: Sanity checks on linting</span>
<span class="c1"># This can take some time, so it&#39;s run separately from packages</span>
<span class="n">package_https_directives</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;packages-https&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;PKG-HTTPS-DIRECTIVES&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks on https checks of package urls, etc.&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pkgs&quot;</span><span class="p">,),</span>
<span class="p">)</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_check_build_test_callbacks</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure stand-alone test methods are not included in build-time callbacks.</span>

<span class="sd">    Test methods are for checking the installed software as stand-alone tests.</span>
<span class="sd">    They could also be called during the post-install phase of a build.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">test_callbacks</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="s2">&quot;build_time_test_callbacks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">has_test_method</span> <span class="o">=</span> <span class="n">test_callbacks</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">test_callbacks</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">has_test_method</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Package </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2"> includes stand-alone test methods in build-time checks.&quot;</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_callbacks</span><span class="p">)</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Remove the following from &#39;build_time_test_callbacks&#39;: </span><span class="si">{</span><span class="n">callbacks</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">),</span> <span class="p">[</span><span class="n">instr</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_directives</span>
<span class="k">def</span> <span class="nf">_check_patch_urls</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that patches fetched from GitHub and GitLab have stable sha256</span>
<span class="sd">    hashes.&quot;&quot;&quot;</span>
    <span class="n">github_patch_url_re</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^https?://(?:patch-diff\.)?github(?:usercontent)?\.com/&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;.+/.+/(?:commit|pull)/[a-fA-F0-9]+\.(?:patch|diff)&quot;</span>
    <span class="p">)</span>
    <span class="n">github_pull_commits_re</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^https?://(?:patch-diff\.)?github(?:usercontent)?\.com/&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;.+/.+/pull/\d+/commits/[a-fA-F0-9]+\.(?:patch|diff)&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Only .diff URLs have stable/full hashes:</span>
    <span class="c1"># https://forum.gitlab.com/t/patches-with-full-index/29313</span>
    <span class="n">gitlab_patch_url_re</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^https?://(?:.+)?gitlab(?:.+)/&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;.+/.+/-/(?:commit|merge_requests)/[a-fA-F0-9]+\.(?:patch|diff)&quot;</span>
    <span class="p">)</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">condition</span><span class="p">,</span> <span class="n">patches</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">UrlPatch</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">github_pull_commits_re</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/pull/\d+/commits/&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;/commit/&quot;</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*)(?&lt;!full_index=1)$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1?full_index=1&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">error_cls</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;patch URL in package </span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="o">+</span> <span class="s2">&quot;must not be a pull request commit; &quot;</span>
                            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;instead use </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">github_patch_url_re</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
                    <span class="n">full_index_arg</span> <span class="o">=</span> <span class="s2">&quot;?full_index=1&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">full_index_arg</span><span class="p">):</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">error_cls</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;patch URL in package </span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;must end with </span><span class="si">{</span><span class="n">full_index_arg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">gitlab_patch_url_re</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.diff&quot;</span><span class="p">):</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">error_cls</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;patch URL in package </span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> must end with .diff&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">patch</span><span class="o">.</span><span class="n">url</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_attributes</span>
<span class="k">def</span> <span class="nf">_search_for_reserved_attributes_names_in_packages</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that packages don&#39;t override reserved names&quot;&quot;&quot;</span>
    <span class="n">RESERVED_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">name_definitions</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cls_item</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">RESERVED_NAMES</span><span class="p">:</span>
                <span class="n">current_value</span> <span class="o">=</span> <span class="n">cls_item</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">name_definitions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cls_item</span><span class="p">,</span> <span class="n">current_value</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">RESERVED_NAMES</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_definitions</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Package &#39;</span><span class="si">{}</span><span class="s2">&#39; overrides the &#39;</span><span class="si">{}</span><span class="s2">&#39; attribute or method, &quot;</span>
                <span class="s2">&quot;which is reserved for Spack internal use&quot;</span>
            <span class="p">)</span>
            <span class="n">definitions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;defined in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">name_definitions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">definitions</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_deprecated_attributes</span>
<span class="k">def</span> <span class="nf">_search_for_deprecated_package_methods</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure the package doesn&#39;t define or use deprecated methods&quot;&quot;&quot;</span>
    <span class="n">DEPRECATED_METHOD</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;a name starting with &#39;test_&#39;&quot;</span><span class="p">),)</span>
    <span class="n">DEPRECATED_USE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;self.cache_extra_test_sources(&quot;</span><span class="p">,</span> <span class="s2">&quot;cache_extra_test_sources(self, ..)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;self.install_test_root(&quot;</span><span class="p">,</span> <span class="s2">&quot;install_test_root(self, ..)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;self.run_test(&quot;</span><span class="p">,</span> <span class="s2">&quot;test_part(self, ..)&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">method_errors</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">deprecated_name</span><span class="p">,</span> <span class="n">alternate</span> <span class="ow">in</span> <span class="n">DEPRECATED_METHOD</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">deprecated_name</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rename &#39;</span><span class="si">{</span><span class="n">deprecated_name</span><span class="si">}</span><span class="s2">&#39; method to </span><span class="si">{</span><span class="n">alternate</span><span class="si">}</span><span class="s2"> instead.&quot;</span>
                    <span class="n">method_errors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">deprecated_name</span><span class="p">,</span> <span class="n">alternate</span> <span class="ow">in</span> <span class="n">DEPRECATED_USE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">deprecated_name</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Change &#39;</span><span class="si">{</span><span class="n">deprecated_name</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">alternate</span><span class="si">}</span><span class="s2">&#39; in &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; method.&quot;</span>
                    <span class="n">method_errors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">num_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_methods</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="n">plural</span><span class="p">(</span><span class="n">num_methods</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">show_n</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Package &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39; implements or uses unsupported deprecated </span><span class="si">{</span><span class="n">methods</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Make changes to &#39;</span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">method_errors</span><span class="p">):</span>
                <span class="n">instr</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">method_errors</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">instr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_all_package_names_are_lowercase</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure package names are lowercase and consistent&quot;&quot;&quot;</span>
    <span class="n">badname_regex</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[_A-Z]&quot;</span><span class="p">),</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">badname_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Package name &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39; should be lowercase and must not contain &#39;_&#39;&quot;</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_packages_are_pickeleable</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that package objects are pickleable&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg_cls</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Package &#39;</span><span class="si">{}</span><span class="s2">&#39; failed to pickle&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))]</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">details</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_packages_are_unparseable</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that all packages can unparse and that unparsed code is valid Python&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spack.util.package_hash</span> <span class="k">as</span> <span class="nn">ph</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">canonical_source</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">filter_multimethods</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Package &#39;</span><span class="si">{}</span><span class="s2">&#39; failed to unparse&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))]</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">details</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">PyCF_ONLY_AST</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;The unparsed package &#39;</span><span class="si">{}</span><span class="s2">&#39; failed to compile&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))]</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">details</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_all_versions_can_produce_a_fetcher</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure all versions in a package can produce a fetcher&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg_cls</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">fetch_strategy</span><span class="o">.</span><span class="n">check_pkg_attributes</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">spack</span><span class="o">.</span><span class="n">fetch_strategy</span><span class="o">.</span><span class="n">for_package_version</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;The package &#39;</span><span class="si">{}</span><span class="s2">&#39; cannot produce a fetcher for some of its versions&quot;</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))]</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">),</span> <span class="n">details</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_docstring_and_no_fixme</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure the package has a docstring and no fixmes&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fixme_regexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;remove this boilerplate&quot;</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;FIXME: Put&quot;</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;FIXME: Add&quot;</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;example.com&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">filename_for_package_name</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">package_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">package_file</span><span class="p">):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fixme_regexes</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="p">:</span>
                    <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">: boilerplate needs to be removed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Package &#39;</span><span class="si">{}</span><span class="s2">&#39; contains boilerplate that need to be removed&quot;</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">),</span> <span class="n">details</span><span class="p">))</span>

        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Package &#39;</span><span class="si">{}</span><span class="s2">&#39; miss a docstring&quot;</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">),</span> <span class="p">[]))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_all_packages_use_sha256_checksums</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure no packages use md5 checksums&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">manual_download</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg_cls</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">invalid_sha256_digest</span><span class="p">(</span><span class="n">fetcher</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fetcher</span><span class="p">,</span> <span class="s2">&quot;digest&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">hash_algo_for_digest</span><span class="p">(</span><span class="n">fetcher</span><span class="o">.</span><span class="n">digest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">h</span> <span class="o">!=</span> <span class="s2">&quot;sha256&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">h</span><span class="p">,</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Package &#39;</span><span class="si">{}</span><span class="s2">&#39; does not use sha256 checksum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fetcher</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">fetch_strategy</span><span class="o">.</span><span class="n">for_package_version</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">digest</span><span class="p">,</span> <span class="n">is_bad</span> <span class="o">=</span> <span class="n">invalid_sha256_digest</span><span class="p">(</span><span class="n">fetcher</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_bad</span><span class="p">:</span>
                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2"> uses </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">digest</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">resources</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="n">digest</span><span class="p">,</span> <span class="n">is_bad</span> <span class="o">=</span> <span class="n">invalid_sha256_digest</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">fetcher</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_bad</span><span class="p">:</span>
                    <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Resource in &#39;</span><span class="si">{}</span><span class="s2">&#39; uses </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">digest</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">details</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_env_methods_are_ported_to_builders</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that methods modifying the build environment are ported to builder classes.&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

        <span class="c1"># values are either ConditionalValue objects or the values themselves</span>
        <span class="n">build_system_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">ConditionalValue</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">variant_definitions</span><span class="p">(</span><span class="s2">&quot;build_system&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="n">builder_cls_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">BUILDER_CLS</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">build_system_names</span><span class="p">]</span>

        <span class="n">has_builders_in_package_py</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_builder_class</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">builder_cls_names</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_builders_in_package_py</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;setup_build_environment&quot;</span><span class="p">,</span> <span class="s2">&quot;setup_dependent_build_environment&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">method_name</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Package &#39;</span><span class="si">{}</span><span class="s2">&#39; need to move the &#39;</span><span class="si">{}</span><span class="s2">&#39; method from the package class to the&quot;</span>
                    <span class="s2">&quot; appropriate builder class&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="k">return</span> <span class="n">errors</span>


<div class="viewcode-block" id="DeprecatedMagicGlobals">
<a class="viewcode-back" href="../../spack.html#spack.audit.DeprecatedMagicGlobals">[docs]</a>
<span class="k">class</span> <span class="nc">DeprecatedMagicGlobals</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magic_globals</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">magic_globals</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">magic_globals</span><span class="p">)</span>

        <span class="c1"># State to track whether we&#39;re in a class function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span>

        <span class="c1"># Defined locals in the current function (heuristically at least)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># List of (name, lineno) tuples for references to magic globals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">references_to_globals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DeprecatedMagicGlobals.descend_in_function_def">
<a class="viewcode-back" href="../../spack.html#spack.audit.DeprecatedMagicGlobals.descend_in_function_def">[docs]</a>
    <span class="k">def</span> <span class="nf">descend_in_function_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">]):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_function</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_function</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="DeprecatedMagicGlobals.generic_visit">
<a class="viewcode-back" href="../../spack.html#spack.audit.DeprecatedMagicGlobals.generic_visit">[docs]</a>
    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Recurse into function definitions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend_in_function_def</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_function</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Global</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">magic_globals</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">references_to_globals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
            <span class="c1"># visit the rhs before lhs</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">magic_globals</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">references_to_globals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>
</div>



<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_uses_deprecated_globals</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that packages do not use deprecated globals&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="c1"># some packages scheduled to be removed in v0.23 are not worth fixing.</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">continue</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">filename_for_package_name</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">DeprecatedMagicGlobals</span><span class="p">((</span><span class="s2">&quot;std_cmake_args&quot;</span><span class="p">,</span> <span class="s2">&quot;std_meson_args&quot;</span><span class="p">,</span> <span class="s2">&quot;std_pip_args&quot;</span><span class="p">))</span>
        <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">visitor</span><span class="o">.</span><span class="n">references_to_globals</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">error_cls</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Package &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39; uses deprecated globals&quot;</span><span class="p">,</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2"> references &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">visitor</span><span class="o">.</span><span class="n">references_to_globals</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_test_docstring</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure stand-alone test methods have a docstring.</span>

<span class="sd">    The docstring of a test method is implicitly used as the description of</span>
<span class="sd">    the corresponding test part during test results reporting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doc_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\s+(&quot;&quot;&quot;[^&quot;]+&quot;&quot;&quot;)&#39;</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">test_fn</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Ensure the test method has a docstring</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">test_fn</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">doc_regex</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">num_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_methods</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="n">plural</span><span class="p">(</span><span class="n">num_methods</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">show_n</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">docstrings</span> <span class="o">=</span> <span class="n">plural</span><span class="p">(</span><span class="n">num_methods</span><span class="p">,</span> <span class="s2">&quot;docstring&quot;</span><span class="p">,</span> <span class="n">show_n</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Package </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2"> has test </span><span class="si">{</span><span class="n">methods</span><span class="si">}</span><span class="s2"> with empty or missing </span><span class="si">{</span><span class="n">docstrings</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Docstrings are used as descriptions in test outputs.&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Add a concise summary to the following </span><span class="si">{</span><span class="n">methods</span><span class="si">}</span><span class="s2"> in &#39;</span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">instr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_properties</span>
<span class="k">def</span> <span class="nf">_ensure_test_implemented</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure stand-alone test methods are implemented.</span>

<span class="sd">    The test method is also required to be non-empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">skip</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ln</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;pass&quot;</span> <span class="ow">in</span> <span class="n">ln</span>

    <span class="n">doc_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\s+(&quot;&quot;&quot;[^&quot;]+&quot;&quot;&quot;)&#39;</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">test_fn</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">test_fn</span><span class="p">)</span>

            <span class="c1"># Attempt to ensure the test method is implemented.</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">doc_regex</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">impl</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">(</span><span class="n">ln</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">num_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_methods</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="n">plural</span><span class="p">(</span><span class="n">num_methods</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">show_n</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Package </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2"> has empty or missing test </span><span class="si">{</span><span class="n">methods</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;Implement or remove the following </span><span class="si">{</span><span class="n">methods</span><span class="si">}</span><span class="s2"> from &#39;</span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">]</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">instr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_https_directives</span>
<span class="k">def</span> <span class="nf">_linting_package_file</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for correctness of links&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

        <span class="c1"># Does the homepage have http, and if so, does https work?</span>
        <span class="k">if</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">homepage</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">):</span>
            <span class="n">https</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">homepage</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">https</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error with attempting https for &quot;</span><span class="si">{0}</span><span class="s1">&quot;: &#39;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Package &quot;</span><span class="si">{0}</span><span class="s1">&quot; uses http but has a valid https endpoint.&#39;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">dedupe</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>


<span class="nd">@package_directives</span>
<span class="k">def</span> <span class="nf">_unknown_variants_in_directives</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Report unknown or wrong variants in directives for this package&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

        <span class="c1"># Check &quot;conflicts&quot; directive</span>
        <span class="k">for</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">conflicts</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">conflicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">conflict</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
                <span class="n">vrn</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">conflict</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vrn</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># If one of the conflict/trigger includes a platform and the other</span>
                    <span class="c1"># includes an os or target, the constraint will fail if the current</span>
                    <span class="c1"># platform is not the plataform in the conflict/trigger. Audit the</span>
                    <span class="c1"># conflict and trigger separately in that case.</span>
                    <span class="c1"># When os and target constraints can be created independently of</span>
                    <span class="c1"># the platform, TODO change this back to add an error.</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">_analyze_variants_in_directive</span><span class="p">(</span>
                            <span class="n">pkg_cls</span><span class="p">,</span>
                            <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">trigger</span><span class="p">),</span>
                            <span class="n">directive</span><span class="o">=</span><span class="s2">&quot;conflicts&quot;</span><span class="p">,</span>
                            <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">_analyze_variants_in_directive</span><span class="p">(</span>
                        <span class="n">pkg_cls</span><span class="p">,</span> <span class="n">vrn</span><span class="p">,</span> <span class="n">directive</span><span class="o">=</span><span class="s2">&quot;conflicts&quot;</span><span class="p">,</span> <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Check &quot;depends_on&quot; directive</span>
        <span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="n">vrn</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">_analyze_variants_in_directive</span><span class="p">(</span>
                    <span class="n">pkg_cls</span><span class="p">,</span> <span class="n">vrn</span><span class="p">,</span> <span class="n">directive</span><span class="o">=</span><span class="s2">&quot;depends_on&quot;</span><span class="p">,</span> <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Check &quot;provides&quot; directive</span>
        <span class="k">for</span> <span class="n">when_spec</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">provided</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">_analyze_variants_in_directive</span><span class="p">(</span>
                    <span class="n">pkg_cls</span><span class="p">,</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">directive</span><span class="o">=</span><span class="s2">&quot;provides&quot;</span><span class="p">,</span> <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Check &quot;resource&quot; directive</span>
        <span class="k">for</span> <span class="n">vrn</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">_analyze_variants_in_directive</span><span class="p">(</span>
                    <span class="n">pkg_cls</span><span class="p">,</span> <span class="n">vrn</span><span class="p">,</span> <span class="n">directive</span><span class="o">=</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">error_cls</span><span class="o">=</span><span class="n">error_cls</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">dedupe</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>


<span class="nd">@package_directives</span>
<span class="k">def</span> <span class="nf">_issues_in_depends_on_directive</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reports issues with &#39;depends_on&#39; directives.</span>

<span class="sd">    Issues might be unknown dependencies, unknown variants or variant values, or declaration</span>
<span class="sd">    of nested dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">filename_for_package_name</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">deps_by_name</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">dep_name</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps_by_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check if there are nested dependencies declared. We don&#39;t want directives like:</span>
                <span class="c1">#</span>
                <span class="c1">#     depends_on(&#39;foo+bar ^fee+baz&#39;)</span>
                <span class="c1">#</span>
                <span class="c1"># but we&#39;d like to have two dependencies listed instead.</span>
                <span class="n">nested_dependencies</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">nested_dependencies</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: nested dependency declaration &#39;</span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="n">ndir</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nested_dependencies</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;split depends_on(&#39;</span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&#39;, when=&#39;</span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&#39;) into </span><span class="si">{</span><span class="n">ndir</span><span class="si">}</span><span class="s2"> directives&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>

                <span class="k">def</span> <span class="nf">check_virtual_with_variants</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">virtual</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">error_cls</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;remove variants from &#39;</span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">&#39; in depends_on directive in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

                <span class="n">check_virtual_with_variants</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;virtual dependency cannot have variants&quot;</span><span class="p">)</span>
                <span class="n">check_virtual_with_variants</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;virtual when= spec cannot have variants&quot;</span><span class="p">)</span>

                <span class="c1"># No need to analyze virtual packages</span>
                <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">dep_name</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># check for unknown dependencies</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dependency_pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">dep_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">UnknownPackageError</span><span class="p">:</span>
                    <span class="c1"># This dependency is completely missing, so report</span>
                    <span class="c1"># and continue the analysis</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: unknown package &#39;</span><span class="si">{</span><span class="n">dep_name</span><span class="si">}</span><span class="s2">&#39; in &#39;depends_on&#39; directive&quot;</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot; in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="c1"># Check for self-referential specs similar to:</span>
                <span class="c1">#</span>
                <span class="c1"># depends_on(&quot;foo@X.Y&quot;, when=&quot;^foo+bar&quot;)</span>
                <span class="c1">#</span>
                <span class="c1"># That would allow clingo to choose whether to have foo@X.Y+bar in the graph.</span>
                <span class="n">problematic_edges</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">when</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">(</span><span class="n">dep_name</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">virtuals</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">problematic_edges</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dep</span><span class="o">.</span><span class="n">patches</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: dependency on &#39;</span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&#39; when &#39;</span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&#39; is self-referential&quot;</span>
                    <span class="p">)</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot; please specify better using &#39;^[virtuals=...] </span><span class="si">{</span><span class="n">dep_name</span><span class="si">}</span><span class="s2">&#39;, or &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;substitute with an equivalent condition on &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                        <span class="p">),</span>
                        <span class="sa">f</span><span class="s2">&quot; in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="c1"># check variants</span>
                <span class="n">dependency_variants</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">dependency_variants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">prevalidate_variant_value</span><span class="p">(</span>
                            <span class="n">dependency_pkg_cls</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: wrong variant used for dependency in &#39;depends_on()&#39;&quot;</span>
                        <span class="p">)</span>

                        <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;variant </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> does not exist in package </span><span class="si">{</span><span class="n">dep_name</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot; in package &#39;</span><span class="si">{</span><span class="n">dep_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                            <span class="p">)</span>

                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">[</span><span class="n">error_msg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
                        <span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_directives</span>
<span class="k">def</span> <span class="nf">_ensure_variant_defaults_are_parsable</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensures that variant defaults are present and parsable from cli&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">check_variant</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">vname</span><span class="p">):</span>
        <span class="c1"># bool is a subclass of int in python. Permitting a default that is an instance</span>
        <span class="c1"># of &#39;int&#39; means both foo=false and foo=0 are accepted. Other falsish values are</span>
        <span class="c1"># not allowed, since they can&#39;t be parsed from CLI (&#39;foo=&#39;)</span>
        <span class="n">default_is_parsable</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">variant</span><span class="o">.</span><span class="n">default</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">default_is_parsable</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Variant &#39;</span><span class="si">{</span><span class="n">vname</span><span class="si">}</span><span class="s2">&#39; of package &#39;</span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has an unparsable default value&quot;</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">[])]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">vspec</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">make_default</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">MultipleValuesInExclusiveVariantError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Can&#39;t create default value for variant &#39;</span><span class="si">{</span><span class="n">vname</span><span class="si">}</span><span class="s2">&#39; in package &#39;</span><span class="si">{</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">[])]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">variant</span><span class="o">.</span><span class="n">validate_or_raise</span><span class="p">(</span><span class="n">vspec</span><span class="p">,</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">InvalidVariantValueError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Default value of variant &#39;</span><span class="si">{vname}</span><span class="s2">&#39; in package &#39;</span><span class="si">{pkg.name}</span><span class="s2">&#39; is invalid&quot;</span>
            <span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;Is it among the allowed values?&quot;</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">[</span><span class="n">question</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">variant_names</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">variant_def</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">variant_definitions</span><span class="p">(</span><span class="n">vname</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">check_variant</span><span class="p">(</span><span class="n">pkg_cls</span><span class="p">,</span> <span class="n">variant_def</span><span class="p">,</span> <span class="n">vname</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_directives</span>
<span class="k">def</span> <span class="nf">_ensure_variants_have_descriptions</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensures that all variants have a description.&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">variant_names</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">variant_definitions</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">variant</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Variant &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; in package &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39; is missing a description&quot;</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_directives</span>
<span class="k">def</span> <span class="nf">_version_constraints_are_satisfiable_by_some_version_in_repo</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Report if version constraints used in directives are not satisfiable&quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">filename_for_package_name</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

        <span class="n">dependencies_to_check</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">deps_by_name</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">dep_name</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps_by_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Skip virtual dependencies for the time being, check on</span>
                <span class="c1"># their versions can be added later</span>
                <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">dep_name</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">dependencies_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">host_architecture</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">ArchSpec</span><span class="o">.</span><span class="n">default_arch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">dependencies_to_check</span><span class="p">:</span>
            <span class="n">dependency_pkg_cls</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dependency_pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># Some packages have hacks that might cause failures on some platform</span>
                <span class="c1"># Allow to explicitly set conditions to skip version checks in that case</span>
                <span class="n">skip_conditions</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dependency_pkg_cls</span><span class="p">,</span> <span class="s2">&quot;skip_version_audit&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">skip_version_check</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">skip_conditions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">host_architecture</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="o">.</span><span class="n">architecture</span><span class="p">):</span>
                        <span class="n">skip_version_check</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">assert</span> <span class="n">skip_version_check</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">versions</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dependency_pkg_cls</span><span class="o">.</span><span class="n">versions</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: dependency on </span><span class="si">{1}</span><span class="s2"> cannot be satisfied by known versions of </span><span class="si">{1.name}</span><span class="s2">&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;happening in &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dependency_pkg_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;known versions of </span><span class="si">{0.name}</span><span class="s2"> are </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dependency_pkg_cls</span><span class="o">.</span><span class="n">versions</span><span class="p">])</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="k">def</span> <span class="nf">_analyze_variants_in_directive</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variant_names</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">variant_names</span><span class="p">()</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: wrong variant in &#39;</span><span class="si">{</span><span class="n">directive</span><span class="si">}</span><span class="s2">&#39; directive&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">filename_for_package_name</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">constraint</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variant_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;variant </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist in </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">[</span><span class="n">msg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]))</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">prevalidate_variant_value</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">InconsistentValidationError</span><span class="p">,</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">MultipleValuesInExclusiveVariantError</span><span class="p">,</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">InvalidVariantValueError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">[</span><span class="n">msg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">errors</span>


<span class="nd">@package_directives</span>
<span class="k">def</span> <span class="nf">_named_specs_in_when_arguments</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reports named specs in the &#39;when=&#39; attribute of a directive.</span>

<span class="sd">    Note that &#39;conflicts&#39; is the only directive allowing that.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_refers_to_pkg</span><span class="p">(</span><span class="n">when</span><span class="p">):</span>
            <span class="n">when_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">when_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">when_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">pkg_name</span>

        <span class="k">def</span> <span class="nf">_error_items</span><span class="p">(</span><span class="n">when_dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">elts</span> <span class="ow">in</span> <span class="n">when_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_refers_to_pkg</span><span class="p">(</span><span class="n">when</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">when</span><span class="p">,</span> <span class="n">elts</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;using &#39;</span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&#39;, should be &#39;^</span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_extracts_errors</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
            <span class="n">_errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">triggers</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_refers_to_pkg</span><span class="p">(</span><span class="n">trigger</span><span class="p">):</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;using &#39;</span><span class="si">{</span><span class="n">trigger</span><span class="si">}</span><span class="s2">&#39;, should be &#39;^</span><span class="si">{</span><span class="n">trigger</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">]</span>
                    <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_errors</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">dnames</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">_error_items</span><span class="p">(</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">dependencies</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">error_cls</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: wrong &#39;when=&#39; condition for &#39;</span><span class="si">{</span><span class="n">dname</span><span class="si">}</span><span class="s2">&#39; dependency&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="n">dnames</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">variants_by_name</span> <span class="ow">in</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants_by_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: wrong &#39;when=&#39; condition for the &#39;</span><span class="si">{</span><span class="n">vname</span><span class="si">}</span><span class="s2">&#39; variant&quot;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_extracts_errors</span><span class="p">([</span><span class="n">when</span><span class="p">],</span> <span class="n">summary</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">providers</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">_error_items</span><span class="p">(</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">provided</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">error_cls</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: wrong &#39;when=&#39; condition for &#39;</span><span class="si">{</span><span class="n">provided</span><span class="si">}</span><span class="s2">&#39; virtual&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">provided</span> <span class="ow">in</span> <span class="n">providers</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">_error_items</span><span class="p">(</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">requirements</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">error_cls</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: wrong &#39;when=&#39; condition in &#39;requires&#39; directive&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">_error_items</span><span class="p">(</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">patches</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">error_cls</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: wrong &#39;when=&#39; condition in &#39;patch&#39; directives&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">_error_items</span><span class="p">(</span><span class="n">pkg_cls</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">error_cls</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: wrong &#39;when=&#39; condition in &#39;resource&#39; directives&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">dedupe</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>


<span class="c1">#: Sanity checks on package directives</span>
<span class="n">external_detection</span> <span class="o">=</span> <span class="n">AuditClass</span><span class="p">(</span>
    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;externals&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;PKG-EXTERNALS&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sanity checks for external software detection&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pkgs&quot;</span><span class="p">,</span> <span class="s2">&quot;debug_log&quot;</span><span class="p">),</span>
<span class="p">)</span>


<div class="viewcode-block" id="packages_with_detection_tests">
<a class="viewcode-back" href="../../spack.html#spack.audit.packages_with_detection_tests">[docs]</a>
<span class="k">def</span> <span class="nf">packages_with_detection_tests</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the list of packages with a corresponding detection_test.yaml file.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spack.config</span>
    <span class="kn">import</span> <span class="nn">spack.util.path</span>

    <span class="n">to_be_tested</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">current_repo</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">repos</span><span class="p">:</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">current_repo</span><span class="o">.</span><span class="n">namespace</span>
        <span class="n">packages_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">(</span><span class="n">current_repo</span><span class="o">.</span><span class="n">packages_path</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">packages_dir</span> <span class="o">/</span> <span class="s2">&quot;**&quot;</span> <span class="o">/</span> <span class="s2">&quot;detection_test.yaml&quot;</span>
        <span class="n">pkgs_with_tests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">to_be_tested</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pkgs_with_tests</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">to_be_tested</span></div>



<span class="nd">@external_detection</span>
<span class="k">def</span> <span class="nf">_test_detection_by_executable</span><span class="p">(</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">debug_log</span><span class="p">,</span> <span class="n">error_cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test drive external detection for packages&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spack.detection</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Filter the packages and retain only the ones with detection tests</span>
    <span class="n">pkgs_with_tests</span> <span class="o">=</span> <span class="n">packages_with_detection_tests</span><span class="p">()</span>
    <span class="n">selected_pkgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">current_package</span> <span class="ow">in</span> <span class="n">pkgs_with_tests</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">unqualified_name</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">partition_package_name</span><span class="p">(</span><span class="n">current_package</span><span class="p">)</span>
        <span class="c1"># Check for both unqualified name and qualified name</span>
        <span class="k">if</span> <span class="n">unqualified_name</span> <span class="ow">in</span> <span class="n">pkgs</span> <span class="ow">or</span> <span class="n">current_package</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
            <span class="n">selected_pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_package</span><span class="p">)</span>
    <span class="n">selected_pkgs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_pkgs</span><span class="p">:</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;No detection test to run&quot;</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;  &quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot; has no detection test&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">summary</span><span class="p">]</span> <span class="o">+</span> <span class="n">details</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errors</span>

    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">selected_pkgs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">test_runner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="n">detection_tests</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">debug_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="vm">__file__</span><span class="si">}</span><span class="s2">]: running test </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> for package </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="n">test_runner</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">expected_specs</span> <span class="o">=</span> <span class="n">test_runner</span><span class="o">.</span><span class="n">expected_specs</span>

            <span class="n">not_detected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_specs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">not_detected</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">pkg_name</span> <span class="o">+</span> <span class="s2">&quot;: cannot detect some specs&quot;</span>
                <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&quot; was not detected [test_id=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">not_detected</span><span class="p">)]</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>

            <span class="n">not_expected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_specs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">not_expected</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">pkg_name</span> <span class="o">+</span> <span class="s2">&quot;: detected unexpected specs&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; was detected, but was not expected [test_id=</span><span class="si">{1}</span><span class="s1">]&#39;</span>
                <span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">not_expected</span><span class="p">)]</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>

            <span class="n">matched_detection</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">expected_specs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
                    <span class="n">matched_detection</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">candidate</span><span class="p">,</span> <span class="n">specs</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">pass</span>

            <span class="k">def</span> <span class="nf">_compare_extra_attribute</span><span class="p">(</span><span class="n">_expected</span><span class="p">,</span> <span class="n">_detected</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">_spec</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># If they are string expected is a regex</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_expected</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_detected</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_expected</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                        <span class="n">_summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s1">: illegal regex in &quot;</span><span class="si">{</span><span class="n">_spec</span><span class="si">}</span><span class="s1">&quot; extra attributes&#39;</span>
                        <span class="n">_details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_expected</span><span class="si">}</span><span class="s2"> is not a valid regex&quot;</span><span class="p">]</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">_summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">_details</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">_detected</span><span class="p">):</span>
                        <span class="n">_summary</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s1">: error when trying to match &quot;</span><span class="si">{</span><span class="n">_expected</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                            <span class="sa">f</span><span class="s2">&quot;in extra attributes&quot;</span>
                        <span class="p">)</span>
                        <span class="n">_details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_detected</span><span class="si">}</span><span class="s2"> does not match the regex&quot;</span><span class="p">]</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">_summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">_details</span><span class="p">)]</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_expected</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_detected</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">_not_detected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_expected</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_detected</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">_not_detected</span><span class="p">:</span>
                        <span class="n">_summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: cannot detect some attributes for spec </span><span class="si">{</span><span class="n">_spec</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">_details</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">_expected</span><span class="si">}</span><span class="s1">&quot; was expected&#39;</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">_detected</span><span class="si">}</span><span class="s1">&quot; was detected&#39;</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;attribute &quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&quot; was not detected&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_not_detected</span><span class="p">)]</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">_summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">_details</span><span class="p">))</span>

                    <span class="n">_common</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_expected</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">_detected</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">_common</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                            <span class="n">_compare_extra_attribute</span><span class="p">(</span><span class="n">_expected</span><span class="p">[</span><span class="n">_key</span><span class="p">],</span> <span class="n">_detected</span><span class="p">[</span><span class="n">_key</span><span class="p">],</span> <span class="n">_spec</span><span class="o">=</span><span class="n">_spec</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s1">: error when trying to detect &quot;</span><span class="si">{</span><span class="n">_expected</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                    <span class="n">_details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_detected</span><span class="si">}</span><span class="s2"> was detected instead&quot;</span><span class="p">]</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">_summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">_details</span><span class="p">)]</span>

                <span class="k">return</span> <span class="n">result</span>

            <span class="k">for</span> <span class="n">expected</span><span class="p">,</span> <span class="n">detected</span> <span class="ow">in</span> <span class="n">matched_detection</span><span class="p">:</span>
                <span class="c1"># We might not want to test all attributes, so avoid not_expected</span>
                <span class="n">not_detected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">extra_attributes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">detected</span><span class="o">.</span><span class="n">extra_attributes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">not_detected</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: cannot detect some attributes for spec </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&quot; was not detected [test_id=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">not_detected</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_cls</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>

                <span class="n">common</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">extra_attributes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">detected</span><span class="o">.</span><span class="n">extra_attributes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">common</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">_compare_extra_attribute</span><span class="p">(</span>
                            <span class="n">expected</span><span class="o">.</span><span class="n">extra_attributes</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                            <span class="n">detected</span><span class="o">.</span><span class="n">extra_attributes</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                            <span class="n">_spec</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>