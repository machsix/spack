

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.solver.asp &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.solver.asp</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.solver.asp</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">archspec.cpu</span>

<span class="kn">import</span> <span class="nn">llnl.util.lang</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>
<span class="kn">from</span> <span class="nn">llnl.util.lang</span> <span class="kn">import</span> <span class="n">elide_list</span>

<span class="kn">import</span> <span class="nn">spack</span>
<span class="kn">import</span> <span class="nn">spack.binary_distribution</span>
<span class="kn">import</span> <span class="nn">spack.compilers</span>
<span class="kn">import</span> <span class="nn">spack.concretize</span>
<span class="kn">import</span> <span class="nn">spack.config</span>
<span class="kn">import</span> <span class="nn">spack.deptypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">spack.environment</span> <span class="k">as</span> <span class="nn">ev</span>
<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.package_base</span>
<span class="kn">import</span> <span class="nn">spack.package_prefs</span>
<span class="kn">import</span> <span class="nn">spack.platforms</span>
<span class="kn">import</span> <span class="nn">spack.repo</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.store</span>
<span class="kn">import</span> <span class="nn">spack.util.crypto</span>
<span class="kn">import</span> <span class="nn">spack.util.libc</span>
<span class="kn">import</span> <span class="nn">spack.util.path</span>
<span class="kn">import</span> <span class="nn">spack.util.timer</span>
<span class="kn">import</span> <span class="nn">spack.variant</span> <span class="k">as</span> <span class="nn">vt</span>
<span class="kn">import</span> <span class="nn">spack.version</span> <span class="k">as</span> <span class="nn">vn</span>
<span class="kn">import</span> <span class="nn">spack.version.git_ref_lookup</span>
<span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="n">traverse</span>
<span class="kn">from</span> <span class="nn">spack.config</span> <span class="kn">import</span> <span class="n">get_mark_from_yaml_data</span>
<span class="kn">from</span> <span class="nn">spack.error</span> <span class="kn">import</span> <span class="n">SpecSyntaxError</span>

<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AspFunction</span><span class="p">,</span>
    <span class="n">AspVar</span><span class="p">,</span>
    <span class="n">NodeArgument</span><span class="p">,</span>
    <span class="n">ast_sym</span><span class="p">,</span>
    <span class="n">ast_type</span><span class="p">,</span>
    <span class="n">clingo</span><span class="p">,</span>
    <span class="n">clingo_cffi</span><span class="p">,</span>
    <span class="n">extract_args</span><span class="p">,</span>
    <span class="n">fn</span><span class="p">,</span>
    <span class="n">parse_files</span><span class="p">,</span>
    <span class="n">parse_term</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.counter</span> <span class="kn">import</span> <span class="n">FullDuplicatesCounter</span><span class="p">,</span> <span class="n">MinimalDuplicatesCounter</span><span class="p">,</span> <span class="n">NoDuplicatesCounter</span>
<span class="kn">from</span> <span class="nn">.version_order</span> <span class="kn">import</span> <span class="n">concretization_version_order</span>

<span class="n">GitOrStandardVersion</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">GitVersion</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">StandardVersion</span><span class="p">]</span>

<span class="n">TransformFunction</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">AspFunction</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">AspFunction</span><span class="p">]]</span>

<span class="c1">#: Enable the addition of a runtime node</span>
<span class="n">WITH_RUNTIME</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;win32&quot;</span>

<span class="c1">#: Data class that contain configuration on what a</span>
<span class="c1">#: clingo solve should output.</span>
<span class="c1">#:</span>
<span class="c1">#: Args:</span>
<span class="c1">#:     timers (bool):  Print out coarse timers for different solve phases.</span>
<span class="c1">#:     stats (bool): Whether to output Clingo&#39;s internal solver statistics.</span>
<span class="c1">#:     out: Optional output stream for the generated ASP program.</span>
<span class="c1">#:     setup_only (bool): if True, stop after setup and don&#39;t solve (default False).</span>
<span class="n">OutputConfiguration</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;OutputConfiguration&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;timers&quot;</span><span class="p">,</span> <span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;setup_only&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1">#: Default output configuration for a solve</span>
<span class="n">DEFAULT_OUTPUT_CONFIGURATION</span> <span class="o">=</span> <span class="n">OutputConfiguration</span><span class="p">(</span>
    <span class="n">timers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setup_only</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>


<div class="viewcode-block" id="default_clingo_control">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.default_clingo_control">[docs]</a>
<span class="k">def</span> <span class="nf">default_clingo_control</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a control object with the default settings used in Spack&quot;&quot;&quot;</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">clingo</span><span class="p">()</span><span class="o">.</span><span class="n">Control</span><span class="p">()</span>
    <span class="n">control</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="s2">&quot;tweety&quot;</span>
    <span class="n">control</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">heuristic</span> <span class="o">=</span> <span class="s2">&quot;Domain&quot;</span>
    <span class="n">control</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">opt_strategy</span> <span class="o">=</span> <span class="s2">&quot;usc,one&quot;</span>
    <span class="k">return</span> <span class="n">control</span></div>



<div class="viewcode-block" id="Provenance">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Provenance">[docs]</a>
<span class="k">class</span> <span class="nc">Provenance</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration of the possible provenances of a version.&quot;&quot;&quot;</span>

    <span class="c1"># A spec literal</span>
    <span class="n">SPEC</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># A dev spec literal</span>
    <span class="n">DEV_SPEC</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># An external spec declaration</span>
    <span class="n">EXTERNAL</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># The &#39;packages&#39; section of the configuration</span>
    <span class="n">PACKAGES_YAML</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># A package requirement</span>
    <span class="n">PACKAGE_REQUIREMENT</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># A &#39;package.py&#39; file</span>
    <span class="n">PACKAGE_PY</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># An installed spec</span>
    <span class="n">INSTALLED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># lower provenance for installed git refs so concretizer prefers StandardVersion installs</span>
    <span class="n">INSTALLED_GIT_VERSION</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># A runtime injected from another package (e.g. a compiler)</span>
    <span class="n">RUNTIME</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="named_spec">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.named_spec">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">named_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager to temporarily set the name of a spec&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">spec</span>
        <span class="k">return</span>

    <span class="n">old_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span>
    <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">spec</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">old_name</span></div>



<div class="viewcode-block" id="RequirementKind">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementKind">[docs]</a>
<span class="k">class</span> <span class="nc">RequirementKind</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Purpose / provenance of a requirement&quot;&quot;&quot;</span>

    <span class="c1">#: Default requirement expressed under the &#39;all&#39; attribute of packages.yaml</span>
    <span class="n">DEFAULT</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1">#: Requirement expressed on a virtual package</span>
    <span class="n">VIRTUAL</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1">#: Requirement expressed on a specific package</span>
    <span class="n">PACKAGE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>



<div class="viewcode-block" id="DeclaredVersion">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.DeclaredVersion">[docs]</a>
<span class="k">class</span> <span class="nc">DeclaredVersion</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data class to contain information on declared versions used in the solve&quot;&quot;&quot;</span>

    <span class="c1">#: String representation of the version</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1">#: Unique index assigned to this version</span>
    <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1">#: Provenance of the version</span>
    <span class="n">origin</span><span class="p">:</span> <span class="n">Provenance</span></div>



<span class="c1"># Below numbers are used to map names of criteria to the order</span>
<span class="c1"># they appear in the solution. See concretize.lp</span>

<span class="c1"># The space of possible priorities for optimization targets</span>
<span class="c1"># is partitioned in the following ranges:</span>
<span class="c1">#</span>
<span class="c1"># [0-100) Optimization criteria for software being reused</span>
<span class="c1"># [100-200) Fixed criteria that are higher priority than reuse, but lower than build</span>
<span class="c1"># [200-300) Optimization criteria for software being built</span>
<span class="c1"># [300-1000) High-priority fixed criteria</span>
<span class="c1"># [1000-inf) Error conditions</span>
<span class="c1">#</span>
<span class="c1"># Each optimization target is a minimization with optimal value 0.</span>

<span class="c1">#: High fixed priority offset for criteria that supersede all build criteria</span>
<span class="n">high_fixed_priority_offset</span> <span class="o">=</span> <span class="mi">300</span>

<span class="c1">#: Priority offset for &quot;build&quot; criteria (regular criterio shifted to</span>
<span class="c1">#: higher priority for specs we have to build)</span>
<span class="n">build_priority_offset</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1">#: Priority offset of &quot;fixed&quot; criteria (those w/o build criteria)</span>
<span class="n">fixed_priority_offset</span> <span class="o">=</span> <span class="mi">100</span>


<div class="viewcode-block" id="build_criteria_names">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.build_criteria_names">[docs]</a>
<span class="k">def</span> <span class="nf">build_criteria_names</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="n">arg_tuples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct an ordered mapping from criteria names to costs.&quot;&quot;&quot;</span>
    <span class="c1"># pull optimization criteria names out of the solution</span>
    <span class="n">priorities_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">num_fixed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_high_fixed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_tuples</span><span class="p">:</span>
        <span class="n">priority</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>

        <span class="c1"># add the priority of this opt criterion and its name</span>
        <span class="n">priorities_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="c1"># if the priority is less than fixed_priority_offset, then it</span>
        <span class="c1"># has an associated build priority -- the same criterion but for</span>
        <span class="c1"># nodes that we have to build.</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="o">&lt;</span> <span class="n">fixed_priority_offset</span><span class="p">:</span>
            <span class="n">build_priority</span> <span class="o">=</span> <span class="n">priority</span> <span class="o">+</span> <span class="n">build_priority_offset</span>
            <span class="n">priorities_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">build_priority</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">priority</span> <span class="o">&gt;=</span> <span class="n">high_fixed_priority_offset</span><span class="p">:</span>
            <span class="n">num_high_fixed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_fixed</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># sort the criteria by priority</span>
    <span class="n">priorities_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">priorities_names</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># We only have opt-criterion values for non-error types</span>
    <span class="c1"># error type criteria are excluded (they come first)</span>
    <span class="n">error_criteria</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">priorities_names</span><span class="p">)</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="n">error_criteria</span><span class="p">:]</span>

    <span class="c1"># split list into three parts: build criteria, fixed criteria, non-build criteria</span>
    <span class="n">num_criteria</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">priorities_names</span><span class="p">)</span>
    <span class="n">num_build</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_criteria</span> <span class="o">-</span> <span class="n">num_fixed</span> <span class="o">-</span> <span class="n">num_high_fixed</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="n">build_start_idx</span> <span class="o">=</span> <span class="n">num_high_fixed</span>
    <span class="n">fixed_start_idx</span> <span class="o">=</span> <span class="n">num_high_fixed</span> <span class="o">+</span> <span class="n">num_build</span>
    <span class="n">installed_start_idx</span> <span class="o">=</span> <span class="n">num_high_fixed</span> <span class="o">+</span> <span class="n">num_build</span> <span class="o">+</span> <span class="n">num_fixed</span>

    <span class="n">high_fixed</span> <span class="o">=</span> <span class="n">priorities_names</span><span class="p">[:</span><span class="n">build_start_idx</span><span class="p">]</span>
    <span class="n">build</span> <span class="o">=</span> <span class="n">priorities_names</span><span class="p">[</span><span class="n">build_start_idx</span><span class="p">:</span><span class="n">fixed_start_idx</span><span class="p">]</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">priorities_names</span><span class="p">[</span><span class="n">fixed_start_idx</span><span class="p">:</span><span class="n">installed_start_idx</span><span class="p">]</span>
    <span class="n">installed</span> <span class="o">=</span> <span class="n">priorities_names</span><span class="p">[</span><span class="n">installed_start_idx</span><span class="p">:]</span>

    <span class="c1"># mapping from priority to index in cost list</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">priorities_names</span><span class="p">))</span>

    <span class="c1"># make a list that has each name with its build and non-build costs</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">[(</span><span class="n">cost</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">cost</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">costs</span><span class="p">[:</span><span class="n">build_start_idx</span><span class="p">],</span> <span class="n">high_fixed</span><span class="p">)]</span>
    <span class="n">criteria</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cost</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="n">fixed_start_idx</span><span class="p">:</span><span class="n">installed_start_idx</span><span class="p">],</span> <span class="n">fixed</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">installed</span><span class="p">,</span> <span class="n">build</span><span class="p">):</span>
        <span class="n">criteria</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">costs</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">costs</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">b</span><span class="p">]],</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">criteria</span></div>



<div class="viewcode-block" id="issequence">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.issequence">[docs]</a>
<span class="k">def</span> <span class="nf">issequence</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">))</span></div>



<div class="viewcode-block" id="listify">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.listify">[docs]</a>
<span class="k">def</span> <span class="nf">listify</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">issequence</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<div class="viewcode-block" id="packagize">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.packagize">[docs]</a>
<span class="k">def</span> <span class="nf">packagize</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pkg</span></div>



<div class="viewcode-block" id="specify">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.specify">[docs]</a>
<span class="k">def</span> <span class="nf">specify</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spec</span>
    <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>



<div class="viewcode-block" id="remove_node">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.remove_node">[docs]</a>
<span class="k">def</span> <span class="nf">remove_node</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">facts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AspFunction</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AspFunction</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformation that removes all &quot;node&quot; and &quot;virtual_node&quot; from the input list of facts.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;virtual_node&quot;</span><span class="p">),</span> <span class="n">facts</span><span class="p">))</span></div>



<span class="k">def</span> <span class="nf">_create_counter</span><span class="p">(</span><span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">],</span> <span class="n">tests</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer:duplicates:strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FullDuplicatesCounter</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;minimal&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MinimalDuplicatesCounter</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NoDuplicatesCounter</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">)</span>


<div class="viewcode-block" id="all_libcs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.all_libcs">[docs]</a>
<span class="k">def</span> <span class="nf">all_libcs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a set of all libc specs targeted by any configured compiler. If none, fall back to</span>
<span class="sd">    libc determined from the current Python process if dynamically linked.&quot;&quot;&quot;</span>

    <span class="n">libcs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">c</span><span class="o">.</span><span class="n">default_libc</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">all_compilers_from</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">default_libc</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">libcs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">libcs</span>

    <span class="n">libc</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">libc_from_current_python_process</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">libc</span><span class="p">}</span> <span class="k">if</span> <span class="n">libc</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span></div>



<div class="viewcode-block" id="libc_is_compatible">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.libc_is_compatible">[docs]</a>
<span class="k">def</span> <span class="nf">libc_is_compatible</span><span class="p">(</span><span class="n">lhs</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">lhs</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">name</span>
        <span class="ow">and</span> <span class="n">lhs</span><span class="o">.</span><span class="n">external_path</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">external_path</span>
        <span class="ow">and</span> <span class="n">lhs</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">version</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="using_libc_compatibility">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.using_libc_compatibility">[docs]</a>
<span class="k">def</span> <span class="nf">using_libc_compatibility</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if we are currently using libc compatibility&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">host</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span></div>



<div class="viewcode-block" id="c_compiler_runs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.c_compiler_runs">[docs]</a>
<span class="k">def</span> <span class="nf">c_compiler_runs</span><span class="p">(</span><span class="n">compiler</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">Compiler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compiler_verbose_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="extend_flag_list">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.extend_flag_list">[docs]</a>
<span class="k">def</span> <span class="nf">extend_flag_list</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">new_flags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extend a list of flags, preserving order and precedence.</span>

<span class="sd">    Add new_flags at the end of flag_list.  If any flags in new_flags are</span>
<span class="sd">    already in flag_list, they are moved to the end so that they take</span>
<span class="sd">    higher precedence on the compile line.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">new_flags</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flag_list</span><span class="p">:</span>
            <span class="n">flag_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="n">flag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_packages_exist">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.check_packages_exist">[docs]</a>
<span class="k">def</span> <span class="nf">check_packages_exist</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure all packages mentioned in specs exist.&quot;&quot;&quot;</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span>
    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">check_passed</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">repo_for_pkg</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find package: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">check_passed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_passed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">UnknownPackageError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fullname</span><span class="p">))</span></div>



<div class="viewcode-block" id="Result">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result">[docs]</a>
<span class="k">class</span> <span class="nc">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of an ASP solve.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">asp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp</span> <span class="o">=</span> <span class="n">asp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">satisfiable</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Saved control object for reruns when necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># specs ordered by optimization level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># names of optimization criteria</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Abstract user requests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abstract_specs</span> <span class="o">=</span> <span class="n">specs</span>

        <span class="c1"># Concrete specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs_by_input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsolved_specs</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Result.format_core">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result.format_core">[docs]</a>
    <span class="k">def</span> <span class="nf">format_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format an unsatisfiable core for human readability</span>

<span class="sd">        Returns a list of strings, where each string is the human readable</span>
<span class="sd">        representation of a single fact in the core, including a newline.</span>

<span class="sd">        Modeled after traceback.format_stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Internal Error: ASP Result.control not populated. Please report to the spack&quot;</span>
            <span class="s2">&quot; maintainers&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">,</span> <span class="n">error_msg</span>

        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">literal</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">symbolic_atoms</span><span class="p">)</span>

        <span class="n">core_symbols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">core</span><span class="p">:</span>
            <span class="n">sym</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="n">core_symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">core_symbols</span><span class="p">)</span></div>


<div class="viewcode-block" id="Result.minimize_core">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result.minimize_core">[docs]</a>
    <span class="k">def</span> <span class="nf">minimize_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a subset-minimal subset of the core.</span>

<span class="sd">        Clingo cores may be thousands of lines when two facts are sufficient to</span>
<span class="sd">        ensure unsatisfiability. This algorithm reduces the core to only those</span>
<span class="sd">        essential facts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Internal Error: ASP Result.control not populated. Please report to the spack&quot;</span>
            <span class="s2">&quot; maintainers&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">,</span> <span class="n">error_msg</span>

        <span class="n">min_core</span> <span class="o">=</span> <span class="n">core</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">core</span><span class="p">:</span>
            <span class="c1"># Try solving without this fact</span>
            <span class="n">min_core</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">assumptions</span><span class="o">=</span><span class="n">min_core</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="o">.</span><span class="n">unsatisfiable</span><span class="p">:</span>
                <span class="n">min_core</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">min_core</span></div>


<div class="viewcode-block" id="Result.minimal_cores">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result.minimal_cores">[docs]</a>
    <span class="k">def</span> <span class="nf">minimal_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of subset-minimal unsatisfiable cores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">minimize_core</span><span class="p">(</span><span class="n">core</span><span class="p">)</span> <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">]</span></div>


<div class="viewcode-block" id="Result.format_minimal_cores">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result.format_minimal_cores">[docs]</a>
    <span class="k">def</span> <span class="nf">format_minimal_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of facts for each core</span>

<span class="sd">        Separate cores are separated by an empty line</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">string_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal_cores</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">string_list</span><span class="p">:</span>
                <span class="n">string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">string_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_core</span><span class="p">(</span><span class="n">core</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">string_list</span></div>


<div class="viewcode-block" id="Result.format_cores">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result.format_cores">[docs]</a>
    <span class="k">def</span> <span class="nf">format_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of facts for each core</span>

<span class="sd">        Separate cores are separated by an empty line</span>
<span class="sd">        Cores are not minimized</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">string_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">string_list</span><span class="p">:</span>
                <span class="n">string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">string_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_core</span><span class="p">(</span><span class="n">core</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">string_list</span></div>


<div class="viewcode-block" id="Result.raise_if_unsat">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result.raise_if_unsat">[docs]</a>
    <span class="k">def</span> <span class="nf">raise_if_unsat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise an appropriate error if the result is unsatisfiable.</span>

<span class="sd">        The error is an SolverError, and includes the minimized cores</span>
<span class="sd">        resulting from the solve, formatted to be human readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">satisfiable</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstract_specs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">conflicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_minimal_cores</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">SolverError</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">conflicts</span><span class="o">=</span><span class="n">conflicts</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of concretized specs satisfying the initial</span>
<span class="sd">        abstract request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_specs_from_answer_set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unsolved_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of tuples pairing abstract input specs that were not</span>
<span class="sd">        solved with their associated candidate spec from the solver</span>
<span class="sd">        (if the solve completed).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsolved_specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_specs_from_answer_set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsolved_specs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specs_by_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs_by_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_specs_from_answer_set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs_by_input</span>

    <span class="k">def</span> <span class="nf">_compute_specs_from_answer_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">satisfiable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unsolved_specs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstract_specs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs_by_input</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsolved_specs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs_by_input</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">best</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answers</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">best</span>
        <span class="k">for</span> <span class="n">input_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstract_specs</span><span class="p">:</span>
            <span class="c1"># The specs must be unified to get here, so it is safe to associate any satisfying spec</span>
            <span class="c1"># with the input. Multiple inputs may be matched to the same concrete spec</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">SpecBuilder</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">input_spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">input_spec</span><span class="o">.</span><span class="n">virtual</span><span class="p">:</span>
                <span class="n">providers</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">provides</span><span class="p">(</span><span class="n">input_spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">SpecBuilder</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">providers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">input_spec</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs_by_input</span><span class="p">[</span><span class="n">input_spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">candidate</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">build_spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">input_spec</span><span class="p">):</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;explicit splice configuration has caused the concretized spec&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2"> not to satisfy the input spec </span><span class="si">{</span><span class="n">input_spec</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_specs_by_input</span><span class="p">[</span><span class="n">input_spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unsolved_specs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">candidate</span><span class="p">))</span>

<div class="viewcode-block" id="Result.format_unsolved">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Result.format_unsolved">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">format_unsolved</span><span class="p">(</span><span class="n">unsolved_specs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a message providing info on unsolved user specs and for</span>
<span class="sd">        each one show the associated candidate spec from the solver (if</span>
<span class="sd">        there is one).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unsatisfied input specs:&quot;</span>
        <span class="k">for</span> <span class="n">input_spec</span><span class="p">,</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">unsolved_specs</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Input spec: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">input_spec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">candidate</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Candidate spec: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">(No candidate specs from solver)&quot;</span>
        <span class="k">return</span> <span class="n">msg</span></div>
</div>



<span class="k">def</span> <span class="nf">_normalize_packages_yaml</span><span class="p">(</span><span class="n">packages_yaml</span><span class="p">):</span>
    <span class="n">normalized_yaml</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">packages_yaml</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="p">:</span>
        <span class="n">is_virtual</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkg_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_virtual</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Remove the virtual entry from the normalized configuration</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">normalized_yaml</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="n">is_buildable</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buildable&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_buildable</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">providers_for</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">normalized_yaml</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;buildable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">externals</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;externals&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">def</span> <span class="nf">keyfn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">name</span>

        <span class="k">for</span> <span class="n">provider</span><span class="p">,</span> <span class="n">specs</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">externals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">keyfn</span><span class="p">):</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">normalized_yaml</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;externals&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">normalized_yaml</span>


<span class="k">def</span> <span class="nf">_is_checksummed_git_version</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">GitVersion</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">is_commit</span>


<span class="k">def</span> <span class="nf">_is_checksummed_version</span><span class="p">(</span><span class="n">version_info</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">GitOrStandardVersion</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns true iff the version is not a moving target&quot;&quot;&quot;</span>
    <span class="n">version</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">version_info</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">StandardVersion</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">h</span> <span class="ow">in</span> <span class="n">info</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">hashes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="s2">&quot;checksum&quot;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="s2">&quot;commit&quot;</span> <span class="ow">in</span> <span class="n">info</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;commit&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">40</span>
    <span class="k">return</span> <span class="n">_is_checksummed_git_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_spec_with_default_name</span><span class="p">(</span><span class="n">spec_str</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a spec with a default name if none is provided, used for requirement specs&quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">spec_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">spec</span>


<span class="k">def</span> <span class="nf">_external_config_with_implicit_externals</span><span class="p">(</span><span class="n">configuration</span><span class="p">):</span>
    <span class="c1"># Read packages.yaml and normalize it, so that it will not contain entries referring to</span>
    <span class="c1"># virtual packages.</span>
    <span class="n">packages_yaml</span> <span class="o">=</span> <span class="n">_normalize_packages_yaml</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">))</span>

    <span class="c1"># Add externals for libc from compilers on Linux</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">using_libc_compatibility</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">packages_yaml</span>

    <span class="k">for</span> <span class="n">compiler</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">all_compilers_from</span><span class="p">(</span><span class="n">configuration</span><span class="p">):</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">default_libc</span>
        <span class="k">if</span> <span class="n">libc</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">libc</span><span class="si">}</span><span class="s2"> %</span><span class="si">{</span><span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">libc</span><span class="o">.</span><span class="n">external_path</span><span class="p">}</span>
            <span class="n">packages_yaml</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;externals&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">packages_yaml</span>


<div class="viewcode-block" id="ErrorHandler">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ErrorHandler">[docs]</a>
<span class="k">class</span> <span class="nc">ErrorHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_specs</span> <span class="o">=</span> <span class="n">input_specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_model</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ErrorHandler.multiple_values_error">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ErrorHandler.multiple_values_error">[docs]</a>
    <span class="k">def</span> <span class="nf">multiple_values_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Cannot select a single &quot;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">&quot; for package &quot;</span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>


<div class="viewcode-block" id="ErrorHandler.no_value_error">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ErrorHandler.no_value_error">[docs]</a>
    <span class="k">def</span> <span class="nf">no_value_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Cannot select a single &quot;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">&quot; for package &quot;</span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>


    <span class="k">def</span> <span class="nf">_get_cause_tree</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cause</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">condition_causes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span>
        <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">,</span>
        <span class="n">indent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;        &quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementation of recursion for self.get_cause_tree. Much of this operates on tuples</span>
<span class="sd">        (condition_id, set_id) in which the latter idea means that the condition represented by</span>
<span class="sd">        the former held in the condition set represented by the latter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cause</span><span class="p">)</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">condition_causes</span> <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="n">cause</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">]</span>
        <span class="n">local</span> <span class="o">=</span> <span class="s2">&quot;required because </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">conditions</span><span class="p">[</span><span class="n">cause</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">indent</span> <span class="o">+</span> <span class="n">local</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">c</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cause_tree</span><span class="p">(</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">condition_causes</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>

<div class="viewcode-block" id="ErrorHandler.get_cause_tree">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ErrorHandler.get_cause_tree">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cause_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cause</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the cause tree associated with the given cause.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cause: The root cause of the tree (final condition)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of strings describing the causes, formatted to display tree structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extract_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_model</span><span class="p">,</span> <span class="s2">&quot;condition_reason&quot;</span><span class="p">))</span>
        <span class="n">condition_causes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="p">((</span><span class="n">Effect</span><span class="p">,</span> <span class="n">EID</span><span class="p">),</span> <span class="p">(</span><span class="n">Cause</span><span class="p">,</span> <span class="n">CID</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">Effect</span><span class="p">,</span> <span class="n">EID</span><span class="p">,</span> <span class="n">Cause</span><span class="p">,</span> <span class="n">CID</span> <span class="ow">in</span> <span class="n">extract_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_model</span><span class="p">,</span> <span class="s2">&quot;condition_cause&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cause_tree</span><span class="p">(</span><span class="n">cause</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">condition_causes</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span></div>


<div class="viewcode-block" id="ErrorHandler.handle_error">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ErrorHandler.handle_error">[docs]</a>
    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle an error state derived by the solver.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;multiple_values_error&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_values_error</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;no_value_error&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_value_error</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;startcauses&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">msg_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">causes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">cause_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="n">cause_args_conditions</span> <span class="o">=</span> <span class="n">cause_args</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cause_args_ids</span> <span class="o">=</span> <span class="n">cause_args</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">causes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cause_args_conditions</span><span class="p">,</span> <span class="n">cause_args_ids</span><span class="p">))</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">msg_args</span><span class="p">)</span>

        <span class="c1"># For variant formatting, we sometimes have to construct specs</span>
        <span class="c1"># to format values properly. Find/replace all occurances of</span>
        <span class="c1"># Spec(...) with the string representation of the spec mentioned</span>
        <span class="n">specs_to_construct</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Spec\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spec_str</span> <span class="ow">in</span> <span class="n">specs_to_construct</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Spec(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">spec_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">spec_str</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">cause</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">causes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cause_tree</span><span class="p">(</span><span class="n">cause</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">msg</span></div>


<div class="viewcode-block" id="ErrorHandler.message">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ErrorHandler.message">[docs]</a>
    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_specs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elide_list</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">`&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_specs</span><span class="p">],</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed to concretize </span><span class="si">{</span><span class="n">input_specs</span><span class="si">}</span><span class="s2"> for the following reasons:&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="o">*</span><span class="n">messages</span><span class="p">))</span></div>


<div class="viewcode-block" id="ErrorHandler.raise_if_errors">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ErrorHandler.raise_if_errors">[docs]</a>
    <span class="k">def</span> <span class="nf">raise_if_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">initial_error_args</span> <span class="o">=</span> <span class="n">extract_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_error_args</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">error_causation</span> <span class="o">=</span> <span class="n">clingo</span><span class="p">()</span><span class="o">.</span><span class="n">Control</span><span class="p">()</span>

        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">errors_lp</span> <span class="o">=</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s2">&quot;error_messages.lp&quot;</span>

        <span class="k">def</span> <span class="nf">on_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="n">shown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">error_causation</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                <span class="n">atom_id</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
                <span class="n">backend</span><span class="o">.</span><span class="n">add_rule</span><span class="p">([</span><span class="n">atom_id</span><span class="p">],</span> <span class="p">[],</span> <span class="n">choice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">error_causation</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">errors_lp</span><span class="p">))</span>
            <span class="n">error_causation</span><span class="o">.</span><span class="n">ground</span><span class="p">([(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="p">(</span><span class="s2">&quot;error_messages&quot;</span><span class="p">,</span> <span class="p">[])])</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">error_causation</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">on_model</span><span class="o">=</span><span class="n">on_model</span><span class="p">)</span>

        <span class="c1"># No choices so there will be only one model</span>
        <span class="n">error_args</span> <span class="o">=</span> <span class="n">extract_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_model</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">priority</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">priority</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">error_args</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;unexpected error during concretization [</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please report a bug at https://github.com/spack/spack/issues&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">raise</span> <span class="n">UnsatisfiableSpecError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RequirementRule">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementRule">[docs]</a>
<span class="k">class</span> <span class="nc">RequirementRule</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data class to collect information on a requirement&quot;&quot;&quot;</span>

    <span class="n">pkg_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">policy</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">requirements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]</span>
    <span class="n">condition</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">RequirementKind</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></div>



<div class="viewcode-block" id="KnownCompiler">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.KnownCompiler">[docs]</a>
<span class="k">class</span> <span class="nc">KnownCompiler</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data class to collect information on compilers&quot;&quot;&quot;</span>

    <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span>
    <span class="n">os</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">available</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">compiler_obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;spack.compiler.Compiler&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">KnownCompiler</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_key</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">())</span></div>



<div class="viewcode-block" id="PyclingoDriver">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.PyclingoDriver">[docs]</a>
<span class="k">class</span> <span class="nc">PyclingoDriver</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Driver for the Python clingo interface.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cores (bool): whether to generate unsatisfiable cores for better</span>
<span class="sd">                error reporting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">cores</span>
        <span class="c1"># This attribute will be reset at each call to solve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PyclingoDriver.solve">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.PyclingoDriver.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the input and solve for dependencies of ``specs``.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            setup (SpackSolverSetup): An object to set up the ASP problem.</span>
<span class="sd">            specs (list): List of ``Spec`` objects to solve for.</span>
<span class="sd">            reuse (None or list): list of concrete specs that can be reused</span>
<span class="sd">            output (None or OutputConfiguration): configuration object to set</span>
<span class="sd">                the output of this solve.</span>
<span class="sd">            control (clingo.Control): configuration for the solver. If None,</span>
<span class="sd">                default values will be used</span>
<span class="sd">            allow_deprecated: if True, allow deprecated versions in the solve</span>

<span class="sd">        Return:</span>
<span class="sd">            A tuple of the solve result, the timer for the different phases of the</span>
<span class="sd">            solve, and the internal statistics from clingo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># avoid circular import</span>
        <span class="kn">import</span> <span class="nn">spack.bootstrap.core</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="ow">or</span> <span class="n">DEFAULT_OUTPUT_CONFIGURATION</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>

        <span class="c1"># Initialize the control object for the solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">control</span> <span class="ow">or</span> <span class="n">default_clingo_control</span><span class="p">()</span>

        <span class="c1"># ensure core deps are present on Windows</span>
        <span class="c1"># needs to modify active config scope, so cannot be run within</span>
        <span class="c1"># bootstrap config scope</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ensuring basic dependencies {win-sdk, wgl} available&quot;</span><span class="p">)</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">bootstrap</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">ensure_winsdk_external_or_raise</span><span class="p">()</span>

        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">)</span>
        <span class="n">asp_problem</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="o">=</span><span class="n">allow_deprecated</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">asp_problem</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">setup_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">)</span>

        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">)</span>
        <span class="c1"># Add the problem instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">asp_problem</span><span class="p">)</span>
        <span class="c1"># Load the file itself</span>
        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;concretize.lp&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;heuristic.lp&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;display.lp&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setup</span><span class="o">.</span><span class="n">concretize_everything</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;when_possible.lp&quot;</span><span class="p">))</span>

        <span class="c1"># Binary compatibility is based on libc on Linux, and on the os tag elsewhere</span>
        <span class="k">if</span> <span class="n">using_libc_compatibility</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;libc_compatibility.lp&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;os_compatibility.lp&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">enable_splicing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;splices.lp&quot;</span><span class="p">))</span>

        <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">)</span>

        <span class="c1"># Grounding is the first step in the solve -- it turns our facts</span>
        <span class="c1"># and first-order logic rules into propositional logic.</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;ground&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">ground</span><span class="p">([(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;ground&quot;</span><span class="p">)</span>

        <span class="c1"># With a grounded program, we can run the solve.</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># stable models if things go well</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># unsatisfiable cores if they do not</span>

        <span class="k">def</span> <span class="nf">on_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="n">shown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="n">solve_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;assumptions&quot;</span><span class="p">:</span> <span class="n">setup</span><span class="o">.</span><span class="n">assumptions</span><span class="p">,</span>
            <span class="s2">&quot;on_model&quot;</span><span class="p">:</span> <span class="n">on_model</span><span class="p">,</span>
            <span class="s2">&quot;on_core&quot;</span><span class="p">:</span> <span class="n">cores</span><span class="o">.</span><span class="n">append</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">clingo_cffi</span><span class="p">():</span>
            <span class="n">solve_kwargs</span><span class="p">[</span><span class="s2">&quot;on_unsat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cores</span><span class="o">.</span><span class="n">append</span>

        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;solve&quot;</span><span class="p">)</span>
        <span class="n">solve_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">**</span><span class="n">solve_kwargs</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;solve&quot;</span><span class="p">)</span>

        <span class="c1"># once done, construct the solve result</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">satisfiable</span> <span class="o">=</span> <span class="n">solve_result</span><span class="o">.</span><span class="n">satisfiable</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">satisfiable</span><span class="p">:</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;construct_specs&quot;</span><span class="p">)</span>
            <span class="c1"># get the best model</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">SpecBuilder</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">hash_lookup</span><span class="o">=</span><span class="n">setup</span><span class="o">.</span><span class="n">reusable_and_possible</span><span class="p">)</span>
            <span class="n">min_cost</span><span class="p">,</span> <span class="n">best_model</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

            <span class="c1"># first check for errors</span>
            <span class="n">error_handler</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">specs</span><span class="p">)</span>
            <span class="n">error_handler</span><span class="o">.</span><span class="n">raise_if_errors</span><span class="p">()</span>

            <span class="c1"># build specs from spec attributes in the model</span>
            <span class="n">spec_attrs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rest</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="ow">in</span> <span class="n">extract_args</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="s2">&quot;attr&quot;</span><span class="p">)]</span>
            <span class="n">answers</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build_specs</span><span class="p">(</span><span class="n">spec_attrs</span><span class="p">)</span>

            <span class="c1"># add best spec to the results</span>
            <span class="n">result</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">min_cost</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">answers</span><span class="p">))</span>

            <span class="c1"># get optimization criteria</span>
            <span class="n">criteria_args</span> <span class="o">=</span> <span class="n">extract_args</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="s2">&quot;opt_criterion&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">build_criteria_names</span><span class="p">(</span><span class="n">min_cost</span><span class="p">,</span> <span class="n">criteria_args</span><span class="p">)</span>

            <span class="c1"># record the number of models the solver considered</span>
            <span class="n">result</span><span class="o">.</span><span class="n">nmodels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

            <span class="c1"># record the possible dependencies in the solve</span>
            <span class="n">result</span><span class="o">.</span><span class="n">possible_dependencies</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">pkgs</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;construct_specs&quot;</span><span class="p">)</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">cores</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span>
            <span class="n">result</span><span class="o">.</span><span class="n">cores</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">timers</span><span class="p">:</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">write_tty</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">stats</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Statistics:&quot;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statistics</span><span class="p">)</span>

        <span class="n">result</span><span class="o">.</span><span class="n">raise_if_unsat</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">satisfiable</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">unsolved_specs</span> <span class="ow">and</span> <span class="n">setup</span><span class="o">.</span><span class="n">concretize_everything</span><span class="p">:</span>
            <span class="n">unsolved_str</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="n">format_unsolved</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">unsolved_specs</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InternalConcretizerError</span><span class="p">(</span>
                <span class="s2">&quot;Internal Spack error: the solver completed but produced specs&quot;</span>
                <span class="s2">&quot; that do not satisfy the request. Please report a bug at &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;https://github.com/spack/spack/issues</span><span class="se">\n\t</span><span class="si">{</span><span class="n">unsolved_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">statistics</span></div>
</div>



<div class="viewcode-block" id="ConcreteSpecsByHash">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConcreteSpecsByHash">[docs]</a>
<span class="k">class</span> <span class="nc">ConcreteSpecsByHash</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mapping containing concrete specs keyed by DAG hash.</span>

<span class="sd">    The mapping is ensured to be consistent, i.e. if a spec in the mapping has a dependency with</span>
<span class="sd">    hash X, it is ensured to be the same object in memory as the spec keyed by X.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dag_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">]</span>

<div class="viewcode-block" id="ConcreteSpecsByHash.explicit_items">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConcreteSpecsByHash.explicit_items">[docs]</a>
    <span class="k">def</span> <span class="nf">explicit_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate on items that have been added explicitly, and not just as a dependency</span>
<span class="sd">        of other nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># We need to make an exception for gcc-runtime, until we can splice it.</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;gcc-runtime&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span></div>


<div class="viewcode-block" id="ConcreteSpecsByHash.add">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConcreteSpecsByHash.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a new concrete spec to the mapping. Returns True if the spec was just added,</span>
<span class="sd">        False if the spec was already in the mapping.</span>

<span class="sd">        Calling this function marks the spec as added explicitly.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: spec to be added</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if the spec is not concrete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;trying to store the non-concrete spec &#39;</span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">&#39; in a container &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;that only accepts concrete&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dag_hash</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dag_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dag_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Here we need to iterate on the input and rewire the copy.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nodes_to_reconstruct</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">nodes_to_reconstruct</span><span class="p">:</span>
            <span class="n">input_parent</span> <span class="o">=</span> <span class="n">nodes_to_reconstruct</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">container_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">input_parent</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span>

            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">input_parent</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">():</span>
                <span class="n">input_child</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span>
                <span class="n">container_child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_child</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span>
                <span class="c1"># Copy children that don&#39;t exist yet</span>
                <span class="k">if</span> <span class="n">container_child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">container_child</span> <span class="o">=</span> <span class="n">input_child</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">input_child</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span> <span class="o">=</span> <span class="n">container_child</span>
                    <span class="n">nodes_to_reconstruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_child</span><span class="p">)</span>

                <span class="c1"># Rewire edges</span>
                <span class="n">container_parent</span><span class="o">.</span><span class="n">add_dependency_edge</span><span class="p">(</span>
                    <span class="n">dependency_spec</span><span class="o">=</span><span class="n">container_child</span><span class="p">,</span> <span class="n">depflag</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">depflag</span><span class="p">,</span> <span class="n">virtuals</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">virtuals</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>



<span class="c1"># types for condition caching in solver setup</span>
<span class="n">ConditionSpecKey</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransformFunction</span><span class="p">]]</span>
<span class="n">ConditionIdFunctionPair</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">AspFunction</span><span class="p">]]</span>
<span class="n">ConditionSpecCache</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ConditionSpecKey</span><span class="p">,</span> <span class="n">ConditionIdFunctionPair</span><span class="p">]]</span>


<div class="viewcode-block" id="ConstraintOrigin">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConstraintOrigin">[docs]</a>
<span class="k">class</span> <span class="nc">ConstraintOrigin</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates identifiers that can be pased into the solver attached</span>
<span class="sd">    to constraints, and then later retrieved to determine the origin of</span>
<span class="sd">    those constraints when ``SpecBuilder`` creates Specs from the solve</span>
<span class="sd">    result.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEPENDS_ON</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">REQUIRE</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_SUFFIXES</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;ConstraintOrigin&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">DEPENDS_ON</span><span class="p">:</span> <span class="s2">&quot;_dep&quot;</span><span class="p">,</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">REQUIRE</span><span class="p">:</span> <span class="s2">&quot;_req&quot;</span><span class="p">}</span>

<div class="viewcode-block" id="ConstraintOrigin.append_type_suffix">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConstraintOrigin.append_type_suffix">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">append_type_suffix</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="s2">&quot;ConstraintOrigin&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a package identifier and a constraint kind, generate a string ID.&quot;&quot;&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">_SUFFIXES</span><span class="p">()[</span><span class="n">kind</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="ConstraintOrigin.strip_type_suffix">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConstraintOrigin.strip_type_suffix">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">strip_type_suffix</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a combined package/type ID generated by</span>
<span class="sd">        ``append_type_suffix``, and extract the package ID and</span>
<span class="sd">        an associated weight.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">_SUFFIXES</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">source</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">source</span></div>
</div>



<div class="viewcode-block" id="SourceContext">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SourceContext">[docs]</a>
<span class="k">class</span> <span class="nc">SourceContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tracks context in which a Spec&#39;s clause-set is generated (i.e.</span>
<span class="sd">    with ``SpackSolverSetup.spec_clauses``).</span>

<span class="sd">    Facts generated for the spec may include this context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This can be &quot;literal&quot; for constraints that come from a user</span>
        <span class="c1"># spec (e.g. from the command line); it can be the output of</span>
        <span class="c1"># `ConstraintOrigin.append_type_suffix`; the default is &quot;none&quot;</span>
        <span class="c1"># (which means it isn&#39;t important to keep track of the source</span>
        <span class="c1"># in that case).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span></div>



<div class="viewcode-block" id="ConditionIdContext">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConditionIdContext">[docs]</a>
<span class="k">class</span> <span class="nc">ConditionIdContext</span><span class="p">(</span><span class="n">SourceContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Derived from a ``ConditionContext``: for clause-sets generated by</span>
<span class="sd">    imposed/required specs, stores an associated transform.</span>

<span class="sd">    This is primarily used for tracking whether we are generating clauses</span>
<span class="sd">    in the context of a required spec, or for an imposed spec.</span>

<span class="sd">    Is not a subclass of ``ConditionContext`` because it exists in a</span>
<span class="sd">    lower-level context with less information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="ConditionContext">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConditionContext">[docs]</a>
<span class="k">class</span> <span class="nc">ConditionContext</span><span class="p">(</span><span class="n">SourceContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tracks context in which a condition (i.e. ``SpackSolverSetup.condition``)</span>
<span class="sd">    is generated (e.g. for a `depends_on`).</span>

<span class="sd">    This may modify the required/imposed specs generated as relevant</span>
<span class="sd">    for the context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># transformation applied to facts from the required spec. Defaults</span>
        <span class="c1"># to leave facts as they are.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_required</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># transformation applied to facts from the imposed spec. Defaults</span>
        <span class="c1"># to removing &quot;node&quot; and &quot;virtual_node&quot; facts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_imposed</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ConditionContext.requirement_context">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConditionContext.requirement_context">[docs]</a>
    <span class="k">def</span> <span class="nf">requirement_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConditionIdContext</span><span class="p">:</span>
        <span class="n">ctxt</span> <span class="o">=</span> <span class="n">ConditionIdContext</span><span class="p">()</span>
        <span class="n">ctxt</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="n">ctxt</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_required</span>
        <span class="k">return</span> <span class="n">ctxt</span></div>


<div class="viewcode-block" id="ConditionContext.impose_context">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ConditionContext.impose_context">[docs]</a>
    <span class="k">def</span> <span class="nf">impose_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConditionIdContext</span><span class="p">:</span>
        <span class="n">ctxt</span> <span class="o">=</span> <span class="n">ConditionIdContext</span><span class="p">()</span>
        <span class="n">ctxt</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="n">ctxt</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_imposed</span>
        <span class="k">return</span> <span class="n">ctxt</span></div>
</div>



<div class="viewcode-block" id="SpackSolverSetup">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup">[docs]</a>
<span class="k">class</span> <span class="nc">SpackSolverSetup</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to set up and run a Spack concretization solve.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># these are all initialized in setup()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">:</span> <span class="s2">&quot;ProblemInstanceBuilder&quot;</span> <span class="o">=</span> <span class="n">ProblemInstanceBuilder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">possible_virtuals</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assumptions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;clingo.Symbol&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: ignore[name-defined]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">DeclaredVersion</span><span class="p">]]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">GitOrStandardVersion</span><span class="p">]]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_versions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">GitOrStandardVersion</span><span class="p">]]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span>
            <span class="nb">set</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">possible_compilers</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">possible_oses</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant_values_from_specs</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_constraints</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_constraints</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_targets</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler_version_constraints</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_facts</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant_ids_by_def_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reusable_and_possible</span><span class="p">:</span> <span class="n">ConcreteSpecsByHash</span> <span class="o">=</span> <span class="n">ConcreteSpecsByHash</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_cache</span><span class="p">:</span> <span class="n">ConditionSpecCache</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_effect_cache</span><span class="p">:</span> <span class="n">ConditionSpecCache</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="c1"># Caches to optimize the setup phase of the solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_specs_cache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># whether to add installed/binary hashes to the solve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="n">tests</span>

        <span class="c1"># If False allows for input specs that are not solved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concretize_everything</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Set during the call to setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explicitly_required_namespaces</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># list of unique libc specs targeted by compilers (or an educated guess if no compiler)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libcs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If true, we have to load the code for synthesizing splices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_splicing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer:splice:automatic&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SpackSolverSetup.pkg_version_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.pkg_version_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">pkg_version_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output declared versions of a package.</span>

<span class="sd">        This uses self.declared_versions so that we include any versions</span>
<span class="sd">        that arise from a spec.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">key_fn</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
            <span class="c1"># Origins are sorted by &quot;provenance&quot; first, see the Provenance enumeration above</span>
            <span class="k">return</span> <span class="n">version</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">version</span><span class="o">.</span><span class="n">idx</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_class</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="n">declared_versions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">partially_sorted_versions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">declared_versions</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">key_fn</span><span class="p">)</span>

        <span class="n">most_to_least_preferred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">partially_sorted_versions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key_fn</span><span class="p">):</span>
            <span class="n">most_to_least_preferred</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vn</span><span class="o">.</span><span class="n">ver</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">version</span><span class="p">)))</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">weight</span><span class="p">,</span> <span class="n">declared_version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">most_to_least_preferred</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                <span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span>
                    <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">version_declared</span><span class="p">(</span>
                        <span class="n">declared_version</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">declared_version</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Declare deprecated versions for this package, if any</span>
        <span class="n">deprecated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_versions</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deprecated</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">deprecated_version</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span></div>


<div class="viewcode-block" id="SpackSolverSetup.spec_versions">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.spec_versions">[docs]</a>
    <span class="k">def</span> <span class="nf">spec_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of clauses expressing spec&#39;s version constraints.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">specify</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Internal Error: spec with no name occured. Please report to the spack maintainers.&quot;</span>
        <span class="k">assert</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">versions</span> <span class="o">==</span> <span class="n">vn</span><span class="o">.</span><span class="n">any_version</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># record all version constraints for later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_version_satisfies&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="p">)]</span></div>


<div class="viewcode-block" id="SpackSolverSetup.target_ranges">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.target_ranges">[docs]</a>
    <span class="k">def</span> <span class="nf">target_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">single_target_fn</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">target</span>

        <span class="c1"># Check if the target is a concrete target</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">TARGETS</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">single_target_fn</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_target_satisfies&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)]</span></div>


<div class="viewcode-block" id="SpackSolverSetup.conflict_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.conflict_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">conflict_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">conflict_specs</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">conflicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">when_spec_msg</span> <span class="o">=</span> <span class="s2">&quot;conflict constraint </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">when_spec</span><span class="p">)</span>
            <span class="n">when_spec_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">when_spec_msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">conflict_spec</span><span class="p">,</span> <span class="n">conflict_msg</span> <span class="ow">in</span> <span class="n">conflict_specs</span><span class="p">:</span>
                <span class="n">conflict_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">conflict_spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">conflict_msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">conflict_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: &quot;</span>
                    <span class="k">if</span> <span class="n">when_spec</span> <span class="o">==</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">():</span>
                        <span class="n">conflict_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;conflicts with &#39;</span><span class="si">{</span><span class="n">conflict_spec</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">conflict_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">conflict_spec</span><span class="si">}</span><span class="s2">&#39; conflicts with &#39;</span><span class="si">{</span><span class="n">when_spec</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

                <span class="n">spec_for_msg</span> <span class="o">=</span> <span class="n">conflict_spec</span>
                <span class="k">if</span> <span class="n">conflict_spec</span> <span class="o">==</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">():</span>
                    <span class="n">spec_for_msg</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">conflict_spec_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;conflict is triggered when </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">spec_for_msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">conflict_spec_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
                    <span class="n">conflict_spec</span><span class="p">,</span>
                    <span class="n">required_name</span><span class="o">=</span><span class="n">conflict_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="n">conflict_spec_msg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span>
                        <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">conflict</span><span class="p">(</span><span class="n">conflict_spec_id</span><span class="p">,</span> <span class="n">when_spec_id</span><span class="p">,</span> <span class="n">conflict_msg</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.package_languages">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.package_languages">[docs]</a>
    <span class="k">def</span> <span class="nf">package_languages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">languages</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">condition_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> needs the </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">languages</span><span class="p">))</span><span class="si">}</span><span class="s2"> language&quot;</span>
            <span class="k">if</span> <span class="n">when_spec</span> <span class="o">!=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">():</span>
                <span class="n">condition_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; when </span><span class="si">{</span><span class="n">when_spec</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">condition_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">condition_msg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">languages</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">language</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">language</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.config_compatible_os">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.config_compatible_os">[docs]</a>
    <span class="k">def</span> <span class="nf">config_compatible_os</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Facts about compatible os&#39;s specified in configs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Compatible OS from concretizer config file&quot;</span><span class="p">)</span>
        <span class="n">os_data</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer:os_compatible&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">recent</span><span class="p">,</span> <span class="n">reusable</span> <span class="ow">in</span> <span class="n">os_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">reusable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">os_compatible</span><span class="p">(</span><span class="n">recent</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.compiler_facts">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.compiler_facts">[docs]</a>
    <span class="k">def</span> <span class="nf">compiler_facts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Facts about available compilers.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Available compilers&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_compilers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_id</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_name</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_version</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">os</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_os</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">os</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_target</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compiler_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compiler_obj</span>
                <span class="k">for</span> <span class="n">flag_type</span><span class="p">,</span> <span class="n">flags</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">flag_group</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_flag</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">flag_type</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">flag_group</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">available</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_available</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_weight</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.package_requirement_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.package_requirement_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">package_requirement_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">RequirementParser</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit_facts_from_requirement_rules</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpackSolverSetup.pkg_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.pkg_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">pkg_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">tests</span><span class="p">):</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_class</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># Namespace of the package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">namespace</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">namespace</span><span class="p">)))</span>

        <span class="c1"># versions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_version_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

        <span class="c1"># languages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_languages</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># variants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># conflicts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conflict_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># virtuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_provider_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_dependencies_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># splices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_splicing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">package_splice_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># virtual preferences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtual_preferences</span><span class="p">(</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">provider_preference</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">))),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">package_requirement_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># trigger and effect tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">effect_rules</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.trigger_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.trigger_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">trigger_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flushes all the trigger rules collected so far, and clears the cache.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_cache</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Trigger conditions&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_cache</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">spec_str</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">trigger_id</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">trigger_msg</span><span class="p">(</span><span class="n">spec_str</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">predicate</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">condition_requirement</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="o">*</span><span class="n">predicate</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.effect_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.effect_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">effect_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flushes all the effect rules collected so far, and clears the cache.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_cache</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Imposed requirements&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_cache</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">spec_str</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">effect_id</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">effect_id</span><span class="p">(</span><span class="n">effect_id</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">effect_msg</span><span class="p">(</span><span class="n">spec_str</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">predicate</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">imposed_constraint</span><span class="p">(</span><span class="n">effect_id</span><span class="p">,</span> <span class="o">*</span><span class="n">predicate</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_effect_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_variant">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_variant">[docs]</a>
    <span class="k">def</span> <span class="nf">define_variant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;Type[spack.package_base.PackageBase]&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">when</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
        <span class="n">variant_def</span><span class="p">:</span> <span class="n">vt</span><span class="o">.</span><span class="n">Variant</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">pkg_fact</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

        <span class="c1"># Every variant id has a unique definition (conditional or unconditional), and</span>
        <span class="c1"># higher variant id definitions take precedence when variants intersect.</span>
        <span class="n">vid</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">)</span>

        <span class="c1"># used to find a variant id from its variant definition (for variant values on specs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant_ids_by_def_id</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">variant_def</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vid</span>

        <span class="k">if</span> <span class="n">when</span> <span class="o">==</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">():</span>
            <span class="c1"># unconditional variant</span>
            <span class="n">pkg_fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">variant_definition</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">vid</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># conditional variant</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Package </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has variant &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; when </span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cond_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">pkg_fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">variant_condition</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">vid</span><span class="p">,</span> <span class="n">cond_id</span><span class="p">))</span>

        <span class="c1"># record type so we can construct the variant when we read it back in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">variant_type</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">variant_def</span><span class="o">.</span><span class="n">variant_type</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">variant_def</span><span class="o">.</span><span class="n">sticky</span><span class="p">:</span>
            <span class="n">pkg_fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">variant_sticky</span><span class="p">(</span><span class="n">vid</span><span class="p">))</span>

        <span class="c1"># define defaults for this variant definition</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">variant_def</span><span class="o">.</span><span class="n">make_default</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">variant_def</span><span class="o">.</span><span class="n">multi</span> <span class="k">else</span> <span class="p">[</span><span class="n">variant_def</span><span class="o">.</span><span class="n">default</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">defaults</span><span class="p">):</span>
            <span class="n">pkg_fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">variant_default_value_from_package_py</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

        <span class="c1"># define possible values for this variant definition</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">variant_def</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">DisjointSetsOfValues</span><span class="p">):</span>
            <span class="n">union</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">sets</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">pkg_fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">variant_value_from_disjoint_sets</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">sid</span><span class="p">))</span>
                <span class="n">union</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">union</span>

        <span class="c1"># ensure that every variant has at least one possible value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">variant_def</span><span class="o">.</span><span class="n">default</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="n">pkg_fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">variant_possible_value</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="c1"># we&#39;re done here for unconditional values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">ConditionalValue</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># make a spec indicating whether the variant has this conditional value</span>
            <span class="n">variant_has_value</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">()</span>
            <span class="n">variant_has_value</span><span class="o">.</span><span class="n">variants</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">AbstractVariant</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">when</span><span class="p">:</span>
                <span class="c1"># the conditional value is always &quot;possible&quot;, but it imposes its when condition as</span>
                <span class="c1"># a constraint if the conditional value is taken. This may seem backwards, but it</span>
                <span class="c1"># ensures that the conditional can only occur when its condition holds.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
                    <span class="n">required_spec</span><span class="o">=</span><span class="n">variant_has_value</span><span class="p">,</span>
                    <span class="n">imposed_spec</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">when</span><span class="p">,</span>
                    <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">imposed_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> variant </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has value &#39;</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; when </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vstring</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">=&#39;</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

                <span class="c1"># We know the value is never allowed statically (when was None), but we can&#39;t just</span>
                <span class="c1"># ignore it b/c it could come in as a possible value and we need a good error msg.</span>
                <span class="c1"># So, it&#39;s a conflict -- if the value is somehow used, it&#39;ll trigger an error.</span>
                <span class="n">trigger_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
                    <span class="n">variant_has_value</span><span class="p">,</span>
                    <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;invalid variant value: </span><span class="si">{</span><span class="n">vstring</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">constraint_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
                    <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(),</span>
                    <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;empty (total) conflict constraint&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;variant value </span><span class="si">{</span><span class="n">vstring</span><span class="si">}</span><span class="s2"> is conditionally disabled&quot;</span>
                <span class="n">pkg_fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">conflict</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">constraint_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_auto_variant">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_auto_variant">[docs]</a>
    <span class="k">def</span> <span class="nf">define_auto_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">multi</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h3</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Special variant: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">vid</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">auto_variant</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">vid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">variant_type</span><span class="p">(</span>
                <span class="n">vid</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">VariantType</span><span class="o">.</span><span class="n">MULTI</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">multi</span> <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">VariantType</span><span class="o">.</span><span class="n">SINGLE</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.variant_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.variant_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">variant_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;Type[spack.package_base.PackageBase]&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">variant_names</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h3</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variant </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> in package </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">variant_def</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">variant_definitions</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">define_variant</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">variant_def</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_condition_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">named_cond</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
        <span class="n">cache</span><span class="p">:</span> <span class="n">ConditionSpecCache</span><span class="p">,</span>
        <span class="n">body</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">ConditionIdContext</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the id for one half of a condition (either a trigger or an imposed constraint).</span>

<span class="sd">        Construct a key from the condition spec and any associated transformation, and</span>
<span class="sd">        cache the ASP functions that they imply. The saved functions will be output</span>
<span class="sd">        later in ``trigger_rules()`` and ``effect_rules()``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The id of the cached trigger or effect.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pkg_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">named_cond</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">named_cond_key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">named_cond</span><span class="p">),</span> <span class="n">context</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pkg_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">named_cond_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cond_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">)</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">named_cond</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">named_cond</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
        <span class="n">pkg_cache</span><span class="p">[</span><span class="n">named_cond_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cond_id</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cond_id</span>

<div class="viewcode-block" id="SpackSolverSetup.condition">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.condition">[docs]</a>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">required_spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
        <span class="n">imposed_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">required_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">imposed_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConditionContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate facts for a dependency or virtual provider condition.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            required_spec: the constraints that triggers this condition</span>
<span class="sd">            imposed_spec: the constraints that are imposed when this condition is triggered</span>
<span class="sd">            required_name: name for ``required_spec``</span>
<span class="sd">                (required if required_spec is anonymous, ignored if not)</span>
<span class="sd">            imposed_name: name for ``imposed_spec``</span>
<span class="sd">                (required if imposed_spec is anonymous, ignored if not)</span>
<span class="sd">            msg: description of the condition</span>
<span class="sd">            context: if provided, indicates how to modify the clause-sets for the required/imposed</span>
<span class="sd">                specs based on the type of constraint they are generated for (e.g. `depends_on`)</span>
<span class="sd">        Returns:</span>
<span class="sd">            int: id of the condition created by this function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_name</span> <span class="o">=</span> <span class="n">required_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">required_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Must provide a name for anonymous condition: &#39;</span><span class="si">{</span><span class="n">required_spec</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ConditionContext</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">transform_imposed</span> <span class="o">=</span> <span class="n">remove_node</span>

        <span class="k">if</span> <span class="n">imposed_spec</span><span class="p">:</span>
            <span class="n">imposed_name</span> <span class="o">=</span> <span class="n">imposed_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">imposed_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">imposed_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Must provide a name for imposed constraint: &#39;</span><span class="si">{</span><span class="n">imposed_spec</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">named_spec</span><span class="p">(</span><span class="n">required_spec</span><span class="p">,</span> <span class="n">required_name</span><span class="p">),</span> <span class="n">named_spec</span><span class="p">(</span><span class="n">imposed_spec</span><span class="p">,</span> <span class="n">imposed_name</span><span class="p">):</span>
            <span class="c1"># Check if we can emit the requirements before updating the condition ID counter.</span>
            <span class="c1"># In this way, if a condition can&#39;t be emitted but the exception is handled in the</span>
            <span class="c1"># caller, we won&#39;t emit partial facts.</span>

            <span class="n">condition_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">)</span>
            <span class="n">requirement_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">requirement_context</span><span class="p">()</span>
            <span class="n">trigger_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_condition_id</span><span class="p">(</span>
                <span class="n">required_spec</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trigger_cache</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">requirement_context</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">required_spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">condition_id</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">condition_reason</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                <span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">required_spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">condition_trigger</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">trigger_id</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">imposed_spec</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">condition_id</span>

            <span class="n">impose_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">impose_context</span><span class="p">()</span>
            <span class="n">effect_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_condition_id</span><span class="p">(</span>
                <span class="n">imposed_spec</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effect_cache</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">impose_context</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                <span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">required_spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">condition_effect</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">effect_id</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">condition_id</span></div>


<div class="viewcode-block" id="SpackSolverSetup.impose">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.impose">[docs]</a>
    <span class="k">def</span> <span class="nf">impose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition_id</span><span class="p">,</span> <span class="n">imposed_spec</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">imposed_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">imposed_spec</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">imposed_constraints</span><span class="p">:</span>
            <span class="c1"># imposed &quot;node&quot;-like conditions are no-ops</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span> <span class="ow">and</span> <span class="n">pred</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;virtual_node&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">imposed_constraint</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="o">*</span><span class="n">pred</span><span class="o">.</span><span class="n">args</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpackSolverSetup.package_provider_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.package_provider_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">package_provider_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vpkg_name</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">provided_virtual_names</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">vpkg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_virtuals</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">possible_provider</span><span class="p">(</span><span class="n">vpkg_name</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">provided</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">provided</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">vpkg</span> <span class="ow">in</span> <span class="n">provided</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vpkg</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_virtuals</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> provides </span><span class="si">{</span><span class="n">vpkg</span><span class="si">}</span><span class="s2"> when </span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">condition_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="n">vpkg</span><span class="p">,</span> <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">when</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">provider_condition</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">vpkg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">sets_of_virtuals</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">provided_together</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">condition_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
                <span class="n">when</span><span class="p">,</span> <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Virtuals are provided together&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">set_id</span><span class="p">,</span> <span class="n">virtuals_together</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets_of_virtuals</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">virtuals_together</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                        <span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">provided_together</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">set_id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.package_dependencies_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.package_dependencies_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">package_dependencies_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate &#39;depends_on&#39; directives into ASP logic.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">deps_by_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deps_by_name</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">depflag</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">depflag</span>
                <span class="c1"># Skip test dependencies if they&#39;re not requested</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
                    <span class="n">depflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dt</span><span class="o">.</span><span class="n">TEST</span>

                <span class="c1"># ... or if they are requested only for certain packages</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
                    <span class="n">depflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dt</span><span class="o">.</span><span class="n">TEST</span>

                <span class="c1"># if there are no dependency types to be considered</span>
                <span class="c1"># anymore, don&#39;t generate the dependency</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">depflag</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> depends on </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">cond</span> <span class="o">!=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; when </span><span class="si">{</span><span class="n">cond</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">def</span> <span class="nf">track_dependencies</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">requirements</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">requirements</span> <span class="o">+</span> <span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;track_dependencies&quot;</span><span class="p">,</span> <span class="n">input_spec</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>

                <span class="k">def</span> <span class="nf">dependency_holds</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">requirements</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">remove_node</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span>
                        <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span>
                            <span class="s2">&quot;dependency_holds&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">input_spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">flag_to_string</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dt</span><span class="o">.</span><span class="n">ALL_FLAGS</span>
                        <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="n">depflag</span>
                    <span class="p">]</span>

                <span class="n">context</span> <span class="o">=</span> <span class="n">ConditionContext</span><span class="p">()</span>
                <span class="n">context</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">append_type_suffix</span><span class="p">(</span>
                    <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">DEPENDS_ON</span>
                <span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">transform_required</span> <span class="o">=</span> <span class="n">track_dependencies</span>
                <span class="n">context</span><span class="o">.</span><span class="n">transform_imposed</span> <span class="o">=</span> <span class="n">dependency_holds</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">required_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_gen_match_variant_splice_constraints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pkg</span><span class="p">,</span>
        <span class="n">cond_spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span>
        <span class="n">splice_spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span>
        <span class="n">hash_asp_var</span><span class="p">:</span> <span class="s2">&quot;AspVar&quot;</span><span class="p">,</span>
        <span class="n">splice_node</span><span class="p">,</span>
        <span class="n">match_variants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="c1"># If there are no variants to match, no constraints are needed</span>
        <span class="n">variant_constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variant_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">match_variants</span><span class="p">):</span>
            <span class="n">vari_defs</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">variant_definitions</span><span class="p">(</span><span class="n">variant_name</span><span class="p">)</span>
            <span class="c1"># the spliceable config of the package always includes the variant</span>
            <span class="k">if</span> <span class="n">vari_defs</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">cond_spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vari_defs</span><span class="p">):</span>
                <span class="n">variant</span> <span class="o">=</span> <span class="n">vari_defs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">variant</span><span class="o">.</span><span class="n">multi</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># cannot automatically match multi-valued variants</span>
                <span class="n">value_var</span> <span class="o">=</span> <span class="n">AspVar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VariValue</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">attr_constraint</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;variant_value&quot;</span><span class="p">,</span> <span class="n">splice_node</span><span class="p">,</span> <span class="n">variant_name</span><span class="p">,</span> <span class="n">value_var</span><span class="p">)</span>
                <span class="n">hash_attr_constraint</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">hash_attr</span><span class="p">(</span>
                    <span class="n">hash_asp_var</span><span class="p">,</span> <span class="s2">&quot;variant_value&quot;</span><span class="p">,</span> <span class="n">splice_spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">variant_name</span><span class="p">,</span> <span class="n">value_var</span>
                <span class="p">)</span>
                <span class="n">variant_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr_constraint</span><span class="p">)</span>
                <span class="n">variant_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hash_attr_constraint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variant_constraints</span>

<div class="viewcode-block" id="SpackSolverSetup.package_splice_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.package_splice_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">package_splice_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Splice rules&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_to_splice</span><span class="p">,</span> <span class="n">match_variants</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">splice_specs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">):</span>
            <span class="k">with</span> <span class="n">named_spec</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">cond</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cond</span><span class="o">.</span><span class="n">versions</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">spec_to_splice</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec_to_splice</span><span class="o">.</span><span class="n">versions</span><span class="p">))</span>
                <span class="n">hash_var</span> <span class="o">=</span> <span class="n">AspVar</span><span class="p">(</span><span class="s2">&quot;Hash&quot;</span><span class="p">)</span>
                <span class="n">splice_node</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">AspVar</span><span class="p">(</span><span class="s2">&quot;NID&quot;</span><span class="p">),</span> <span class="n">cond</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">when_spec_attrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">splice_node</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required_from</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;node&quot;</span>
                <span class="p">]</span>
                <span class="n">splice_spec_hash_attrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">hash_attr</span><span class="p">(</span><span class="n">hash_var</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">spec_to_splice</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required_from</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;node&quot;</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">match_variants</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">variant_constraints</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">match_variants</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                    <span class="n">filt_match_variants</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">:</span>
                            <span class="n">filt_match_variants</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">filt_match_variants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filt_match_variants</span><span class="p">)</span>
                    <span class="n">variant_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_match_variant_splice_constraints</span><span class="p">(</span>
                        <span class="n">pkg</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">spec_to_splice</span><span class="p">,</span> <span class="n">hash_var</span><span class="p">,</span> <span class="n">splice_node</span><span class="p">,</span> <span class="n">filt_match_variants</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">v</span> <span class="ow">in</span> <span class="n">cond</span><span class="o">.</span><span class="n">variants</span> <span class="ow">or</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spec_to_splice</span><span class="o">.</span><span class="n">variants</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">match_variants</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s2">&quot;Overlap between match_variants and explicitly set variants&quot;</span>
                        <span class="p">)</span>
                    <span class="n">variant_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_match_variant_splice_constraints</span><span class="p">(</span>
                        <span class="n">pkg</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">spec_to_splice</span><span class="p">,</span> <span class="n">hash_var</span><span class="p">,</span> <span class="n">splice_node</span><span class="p">,</span> <span class="n">match_variants</span>
                    <span class="p">)</span>

                <span class="n">rule_head</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">abi_splice_conditions_hold</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">splice_node</span><span class="p">,</span> <span class="n">spec_to_splice</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hash_var</span>
                <span class="p">)</span>
                <span class="n">rule_body_components</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span>
                        <span class="c1"># splice_set_fact,</span>
                        <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="n">splice_node</span><span class="p">),</span>
                        <span class="n">fn</span><span class="o">.</span><span class="n">installed_hash</span><span class="p">(</span><span class="n">spec_to_splice</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hash_var</span><span class="p">),</span>
                    <span class="p">]</span>
                    <span class="o">+</span> <span class="n">when_spec_attrs</span>
                    <span class="o">+</span> <span class="n">splice_spec_hash_attrs</span>
                    <span class="o">+</span> <span class="n">variant_constraints</span>
                <span class="p">)</span>
                <span class="n">rule_body</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rule_body_components</span><span class="p">)</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rule_head</span><span class="si">}</span><span class="s2"> :-</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">rule_body</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.virtual_preferences">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.virtual_preferences">[docs]</a>
    <span class="k">def</span> <span class="nf">virtual_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call func(vspec, provider, i) for each of pkg&#39;s provider prefs.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>
        <span class="n">pkg_prefs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;providers&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">vspec</span><span class="p">,</span> <span class="n">providers</span> <span class="ow">in</span> <span class="n">pkg_prefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">vspec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_virtuals</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">provider</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">providers</span><span class="p">):</span>
                <span class="n">provider_name</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">func</span><span class="p">(</span><span class="n">vspec</span><span class="p">,</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.provider_defaults">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.provider_defaults">[docs]</a>
    <span class="k">def</span> <span class="nf">provider_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Default virtual providers&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtual_preferences</span><span class="p">(</span>
            <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">default_provider_preference</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.provider_requirements">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.provider_requirements">[docs]</a>
    <span class="k">def</span> <span class="nf">provider_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Requirements on virtual providers&quot;</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">RequirementParser</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">virtual_str</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_virtuals</span><span class="p">):</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">rules_from_virtual</span><span class="p">(</span><span class="n">virtual_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit_facts_from_requirement_rules</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_rules</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">effect_rules</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.emit_facts_from_requirement_rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.emit_facts_from_requirement_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">emit_facts_from_requirement_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate facts to enforce requirements.</span>

<span class="sd">        Args:</span>
<span class="sd">            rules: rules for which we want facts to be emitted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">requirement_grp_id</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rules</span><span class="p">):</span>
            <span class="n">virtual</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">RequirementKind</span><span class="o">.</span><span class="n">VIRTUAL</span>

            <span class="n">pkg_name</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">requirement_grp</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">policy</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">requirements</span>
            <span class="n">requirement_weight</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Write explicitly if a requirement is conditional or not</span>
            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">condition</span> <span class="o">!=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;condition to activate requirement </span><span class="si">{</span><span class="n">requirement_grp_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">main_condition_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
                        <span class="n">rule</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">required_name</span><span class="o">=</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">RequirementKind</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;cannot emit requirements for the solver: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">requirement_conditional</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">requirement_grp_id</span><span class="p">,</span> <span class="n">main_condition_id</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">requirement_group</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">requirement_grp_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">requirement_policy</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">requirement_grp_id</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">requirement_message</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">requirement_grp_id</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">input_spec</span> <span class="ow">in</span> <span class="n">requirement_grp</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">input_spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pkg_name</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">attach_git_version_lookup</span><span class="p">()</span>

                <span class="n">when_spec</span> <span class="o">=</span> <span class="n">spec</span>
                <span class="k">if</span> <span class="n">virtual</span><span class="p">:</span>
                    <span class="n">when_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="n">ConditionContext</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">append_type_suffix</span><span class="p">(</span>
                        <span class="n">pkg_name</span><span class="p">,</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">REQUIRE</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual</span><span class="p">:</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">transform_imposed</span> <span class="o">=</span> <span class="n">remove_node</span>
                    <span class="c1"># else: for virtuals we want to emit &quot;node&quot; and</span>
                    <span class="c1"># &quot;virtual_node&quot; in imposed specs</span>

                    <span class="n">member_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
                        <span class="n">required_spec</span><span class="o">=</span><span class="n">when_spec</span><span class="p">,</span>
                        <span class="n">imposed_spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                        <span class="n">required_name</span><span class="o">=</span><span class="n">pkg_name</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_spec</span><span class="si">}</span><span class="s2"> is a requirement for package </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Do not raise if the rule comes from the &#39;all&#39; subsection, since usability</span>
                    <span class="c1"># would be impaired. If a rule does not apply for a specific package, just</span>
                    <span class="c1"># discard it.</span>
                    <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">RequirementKind</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;cannot emit requirements for the solver: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">requirement_group_member</span><span class="p">(</span><span class="n">member_id</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">requirement_grp_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">requirement_has_weight</span><span class="p">(</span><span class="n">member_id</span><span class="p">,</span> <span class="n">requirement_weight</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
                <span class="n">requirement_weight</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="SpackSolverSetup.external_packages">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.external_packages">[docs]</a>
    <span class="k">def</span> <span class="nf">external_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Facts on external packages, from packages.yaml and implicit externals.&quot;&quot;&quot;</span>
        <span class="n">packages_yaml</span> <span class="o">=</span> <span class="n">_external_config_with_implicit_externals</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;External packages&quot;</span><span class="p">)</span>
        <span class="n">spec_filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">concretizer_yaml</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer&quot;</span><span class="p">)</span>
        <span class="n">reuse_yaml</span> <span class="o">=</span> <span class="n">concretizer_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reuse&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reuse_yaml</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="n">default_include</span> <span class="o">=</span> <span class="n">reuse_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">default_exclude</span> <span class="o">=</span> <span class="n">reuse_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">libc_externals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_libcs</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">reuse_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;external&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">include</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="n">default_include</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
                    <span class="c1"># Since libcs are implicit externals, we need to implicitly include them</span>
                    <span class="n">include</span> <span class="o">=</span> <span class="n">include</span> <span class="o">+</span> <span class="n">libc_externals</span>
                <span class="n">exclude</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="n">default_exclude</span><span class="p">)</span>
                <span class="n">spec_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">SpecFilter</span><span class="p">(</span>
                        <span class="n">factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="n">is_usable</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span>
                        <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pkg_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># package isn&#39;t a possible dependency and can&#39;t be in the solution</span>
            <span class="k">if</span> <span class="n">pkg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># This package is not among possible dependencies</span>
            <span class="k">if</span> <span class="n">pkg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check if the external package is buildable. If it is</span>
            <span class="c1"># not then &quot;external(&lt;pkg&gt;)&quot; is a fact, unless we can</span>
            <span class="c1"># reuse an already installed spec.</span>
            <span class="n">external_buildable</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buildable&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">external_buildable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">buildable_false</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">))</span>

            <span class="c1"># Read a list of all the specs for this package</span>
            <span class="n">externals</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;externals&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">candidate_specs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">parse_with_version_concrete</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">externals</span>
            <span class="p">]</span>

            <span class="n">selected_externals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">spec_filters</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">current_filter</span> <span class="ow">in</span> <span class="n">spec_filters</span><span class="p">:</span>
                    <span class="n">current_filter</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">candidate_specs</span>
                    <span class="n">selected_externals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_filter</span><span class="o">.</span><span class="n">selected_specs</span><span class="p">())</span>

            <span class="c1"># Emit facts for externals specs. Note that &quot;local_idx&quot; is the index of the spec</span>
            <span class="c1"># in packages:&lt;pkg_name&gt;:externals. This means:</span>
            <span class="c1">#</span>
            <span class="c1"># packages:&lt;pkg_name&gt;:externals[local_idx].spec == spec</span>
            <span class="n">external_versions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">local_idx</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidate_specs</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> available as external when satisfying </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">if</span> <span class="n">spec_filters</span> <span class="ow">and</span> <span class="n">spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_externals</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot use the external spec </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">: needs a concrete version&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">def</span> <span class="nf">external_imposition</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">requirements</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">requirements</span> <span class="o">+</span> <span class="p">[</span>
                        <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;external_conditions_hold&quot;</span><span class="p">,</span> <span class="n">input_spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">local_idx</span><span class="p">)</span>
                    <span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="n">ConditionContext</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">transform_imposed</span> <span class="o">=</span> <span class="n">external_imposition</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpecError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;while setting up external spec </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">external_versions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">local_idx</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

            <span class="c1"># Order the external versions to prefer more recent versions</span>
            <span class="c1"># even if specs in packages.yaml are not ordered that way</span>
            <span class="n">external_versions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">external_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">external_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">external_versions</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">version</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">external_id</span> <span class="ow">in</span> <span class="n">external_versions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">DeclaredVersion</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">Provenance</span><span class="o">.</span><span class="n">EXTERNAL</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_rules</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effect_rules</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.preferred_variants">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.preferred_variants">[docs]</a>
    <span class="k">def</span> <span class="nf">preferred_variants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Facts on concretization preferences, as read from packages.yaml&quot;&quot;&quot;</span>
        <span class="n">preferences</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_prefs</span><span class="o">.</span><span class="n">PackagePrefs</span>
        <span class="n">preferred_variants</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">preferred_variants</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">preferred_variants</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">variant_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">preferred_variants</span><span class="p">):</span>
            <span class="n">variant</span> <span class="o">=</span> <span class="n">preferred_variants</span><span class="p">[</span><span class="n">variant_name</span><span class="p">]</span>

            <span class="c1"># perform validation of the variant and values</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">variant_defs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">prevalidate_variant_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">),</span> <span class="n">variant</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">InvalidVariantValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[SETUP]: rejected </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span><span class="si">}</span><span class="s2"> as a preference for </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">value_as_tuple</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">variant_def</span> <span class="ow">in</span> <span class="n">variant_defs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variant_values_from_specs</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">pkg_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">variant_def</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">variant_default_value_from_packages_yaml</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.target_preferences">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.target_preferences">[docs]</a>
    <span class="k">def</span> <span class="nf">target_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key_fn</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_prefs</span><span class="o">.</span><span class="n">PackagePrefs</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_specs_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_specs_cache</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="s2">&quot;target=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">target_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_targets</span>
            <span class="p">]</span>

        <span class="n">package_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_specs_cache</span><span class="p">[:]</span>
        <span class="n">package_targets</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key_fn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">preferred</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">package_targets</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">target_weight</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">preferred</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">target</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpackSolverSetup.spec_clauses">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.spec_clauses">[docs]</a>
    <span class="k">def</span> <span class="nf">spec_clauses</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">body</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">expand_hashes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">concrete_build_deps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">required_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SourceContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AspFunction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap a call to `_spec_clauses()` into a try/except block with better error handling.</span>

<span class="sd">        Arguments are as for ``_spec_clauses()`` except ``required_from``.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            required_from: name of package that caused this call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spec_clauses</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                <span class="n">transitive</span><span class="o">=</span><span class="n">transitive</span><span class="p">,</span>
                <span class="n">expand_hashes</span><span class="o">=</span><span class="n">expand_hashes</span><span class="p">,</span>
                <span class="n">concrete_build_deps</span><span class="o">=</span><span class="n">concrete_build_deps</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">required_from</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; [required from package &#39;</span><span class="si">{</span><span class="n">required_from</span><span class="si">}</span><span class="s2">&#39;]&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clauses</span></div>


    <span class="k">def</span> <span class="nf">_spec_clauses</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">body</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">expand_hashes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">concrete_build_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SourceContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AspFunction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of clauses for a spec mandates are true.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            spec: the spec to analyze</span>
<span class="sd">            body: if True, generate clauses to be used in rule bodies (final values) instead</span>
<span class="sd">                of rule heads (setters).</span>
<span class="sd">            transitive: if False, don&#39;t generate clauses from dependencies (default True)</span>
<span class="sd">            expand_hashes: if True, descend into hashes of concrete specs (default False)</span>
<span class="sd">            concrete_build_deps: if False, do not include pure build deps of concrete specs</span>
<span class="sd">                (as they have no effect on runtime constraints)</span>
<span class="sd">            context: tracks what constraint this clause set is generated for (e.g. a</span>
<span class="sd">                `depends_on` constraint in a package.py file)</span>

<span class="sd">        Normally, if called with ``transitive=True``, ``spec_clauses()`` just generates</span>
<span class="sd">        hashes for the dependency requirements of concrete specs. If ``expand_hashes``</span>
<span class="sd">        is ``True``, we&#39;ll *also* output all the facts implied by transitive hashes,</span>
<span class="sd">        which are redundant during a solve but useful outside of one (e.g.,</span>
<span class="sd">        for spec ``diff``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_Head</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_Body</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_Body</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="n">_Head</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">virtual</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">virtual_node</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">namespace</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">namespace</span><span class="p">))</span>

        <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_versions</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>

        <span class="c1"># seed architecture at the root (we&#39;ll propagate later)</span>
        <span class="c1"># TODO: use better semantics.</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span>
        <span class="k">if</span> <span class="n">arch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">platform</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">node_platform</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arch</span><span class="o">.</span><span class="n">platform</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">os</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">node_os</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arch</span><span class="o">.</span><span class="n">os</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_ranges</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">node_target</span><span class="p">))</span>

        <span class="c1"># variants</span>
        <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># TODO: variant=&quot;*&quot; means &#39;variant is defined to something&#39;, which used to</span>
            <span class="c1"># be meaningless in concretization, as all variants had to be defined. But</span>
            <span class="c1"># now that variants can be conditional, it should force a variant to exist.</span>
            <span class="k">if</span> <span class="n">variant</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,):</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">value_as_tuple</span><span class="p">:</span>
                <span class="c1"># ensure that the value *can* be valid for the spec</span>
                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">virtual</span><span class="p">:</span>
                    <span class="n">variant_defs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">prevalidate_variant_value</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_class</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">variant</span><span class="p">,</span> <span class="n">spec</span>
                    <span class="p">)</span>

                    <span class="c1"># Record that that this is a valid possible value. Accounts for</span>
                    <span class="c1"># int/str/etc., where valid values can&#39;t be listed in the package</span>
                    <span class="k">for</span> <span class="n">variant_def</span> <span class="ow">in</span> <span class="n">variant_defs</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">variant_values_from_specs</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">variant_def</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">variant</span><span class="o">.</span><span class="n">propagate</span><span class="p">:</span>
                    <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">variant_value</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_class</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">has_variant</span><span class="p">(</span><span class="n">vname</span><span class="p">):</span>
                        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">variant_value</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">variant_value</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="c1"># compiler and compiler version</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">node_compiler</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">node_compiler_version</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">versions</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">versions</span> <span class="o">!=</span> <span class="n">vn</span><span class="o">.</span><span class="n">any_version</span><span class="p">:</span>
                <span class="c1"># The condition above emits a facts only if we have an actual constraint</span>
                <span class="c1"># on the compiler version, and avoids emitting them if any version is fine</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span>
                        <span class="s2">&quot;node_compiler_version_satisfies&quot;</span><span class="p">,</span>
                        <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">versions</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler_version_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">)</span>

        <span class="c1"># compiler flags</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">source</span> <span class="k">if</span> <span class="n">context</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>
        <span class="k">for</span> <span class="n">flag_type</span><span class="p">,</span> <span class="n">flags</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler_flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">flag_group</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">node_flag</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">node_flag</span><span class="p">(</span><span class="n">flag_type</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">flag_group</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">and</span> <span class="n">flag</span><span class="o">.</span><span class="n">propagate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span>
                            <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">fn</span><span class="o">.</span><span class="n">node_flag</span><span class="p">(</span><span class="n">flag_type</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">flag_group</span><span class="p">,</span> <span class="n">source</span><span class="p">),</span>
                            <span class="n">fn</span><span class="o">.</span><span class="n">edge_types</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># dependencies</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="c1"># older specs do not have package hashes, so we have to do this carefully</span>
            <span class="n">package_hash</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;_package_hash&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">package_hash</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;package_hash&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">package_hash</span><span class="p">))</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;hash&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()))</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">edges_from_dependents</span><span class="p">()</span>
        <span class="n">virtuals</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">edge</span><span class="o">.</span><span class="n">virtuals</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">virtual</span> <span class="ow">in</span> <span class="n">virtuals</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;provider_set&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">virtual</span><span class="p">))</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;virtual_node&quot;</span><span class="p">,</span> <span class="n">virtual</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">virtual</span> <span class="ow">in</span> <span class="n">virtuals</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;virtual_on_incoming_edges&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">virtual</span><span class="p">))</span>

        <span class="c1"># If the spec is external and concrete, we allow all the libcs on the system</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">and</span> <span class="n">using_libc_compatibility</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">libc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">libcs</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;compatible_libc&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

        <span class="c1"># add all clauses from dependencies</span>
        <span class="k">if</span> <span class="n">transitive</span><span class="p">:</span>
            <span class="c1"># TODO: Eventually distinguish 2 deps on the same pkg (build and link)</span>
            <span class="k">for</span> <span class="n">dspec</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">():</span>
                <span class="n">dep</span> <span class="o">=</span> <span class="n">dspec</span><span class="o">.</span><span class="n">spec</span>

                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                    <span class="c1"># GCC runtime is solved again by clingo, even on concrete specs, to give</span>
                    <span class="c1"># the possibility to reuse specs built against a different runtime.</span>
                    <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;gcc-runtime&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># libc is also solved again by clingo, but in this case the compatibility</span>
                    <span class="c1"># is not encoded in the parent node - so we need to emit explicit facts</span>
                    <span class="k">if</span> <span class="s2">&quot;libc&quot;</span> <span class="ow">in</span> <span class="n">dspec</span><span class="o">.</span><span class="n">virtuals</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">libc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">libcs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">libc_is_compatible</span><span class="p">(</span><span class="n">libc</span><span class="p">,</span> <span class="n">dep</span><span class="p">):</span>
                                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;compatible_libc&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                                <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># We know dependencies are real for concrete specs. For abstract</span>
                    <span class="c1"># specs they just mean the dep is somehow in the DAG.</span>
                    <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dt</span><span class="o">.</span><span class="n">ALL_FLAGS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dspec</span><span class="o">.</span><span class="n">depflag</span> <span class="o">&amp;</span> <span class="n">dtype</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="c1"># skip build dependencies of already-installed specs</span>
                        <span class="k">if</span> <span class="n">concrete_build_deps</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span><span class="p">:</span>
                            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span>
                                    <span class="s2">&quot;depends_on&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">flag_to_string</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">virtual_name</span> <span class="ow">in</span> <span class="n">dspec</span><span class="o">.</span><span class="n">virtuals</span><span class="p">:</span>
                                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;virtual_on_edge&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">virtual_name</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;virtual_node&quot;</span><span class="p">,</span> <span class="n">virtual_name</span><span class="p">))</span>

                    <span class="c1"># imposing hash constraints for all but pure build deps of</span>
                    <span class="c1"># already-installed concrete specs.</span>
                    <span class="k">if</span> <span class="n">concrete_build_deps</span> <span class="ow">or</span> <span class="n">dspec</span><span class="o">.</span><span class="n">depflag</span> <span class="o">!=</span> <span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span><span class="p">:</span>
                        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;hash&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()))</span>

                <span class="c1"># if the spec is abstract, descend into dependencies.</span>
                <span class="c1"># if it&#39;s concrete, then the hashes above take care of dependency</span>
                <span class="c1"># constraints, but expand the hashes if asked for.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">or</span> <span class="n">expand_hashes</span><span class="p">:</span>
                    <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_spec_clauses</span><span class="p">(</span>
                            <span class="n">dep</span><span class="p">,</span>
                            <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                            <span class="n">expand_hashes</span><span class="o">=</span><span class="n">expand_hashes</span><span class="p">,</span>
                            <span class="n">concrete_build_deps</span><span class="o">=</span><span class="n">concrete_build_deps</span><span class="p">,</span>
                            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">clauses</span>

<div class="viewcode-block" id="SpackSolverSetup.define_package_versions_and_validate_preferences">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_package_versions_and_validate_preferences">[docs]</a>
    <span class="k">def</span> <span class="nf">define_package_versions_and_validate_preferences</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">possible_pkgs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">require_checksum</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Declare any versions in specs not declared in packages.&quot;&quot;&quot;</span>
        <span class="n">packages_yaml</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">possible_pkgs</span><span class="p">:</span>
            <span class="n">pkg_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_class</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

            <span class="c1"># All the versions from the corresponding package.py file. Since concepts</span>
            <span class="c1"># like being a &quot;develop&quot; version or being preferred exist only at a</span>
            <span class="c1"># package.py level, sort them in this partial list here</span>
            <span class="n">package_py_versions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">pkg_cls</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">concretization_version_order</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">require_checksum</span> <span class="ow">and</span> <span class="n">pkg_cls</span><span class="o">.</span><span class="n">has_code</span><span class="p">:</span>
                <span class="n">package_py_versions</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">package_py_versions</span> <span class="k">if</span> <span class="n">_is_checksummed_version</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">version_info</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">package_py_versions</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_deprecated</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">DeclaredVersion</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">Provenance</span><span class="o">.</span><span class="n">PACKAGE_PY</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">pkg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packages_yaml</span> <span class="ow">or</span> <span class="s2">&quot;version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">version_defs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">GitOrStandardVersion</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">vstr</span> <span class="ow">in</span> <span class="n">packages_yaml</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">]:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">vn</span><span class="o">.</span><span class="n">ver</span><span class="p">(</span><span class="n">vstr</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">GitVersion</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">require_checksum</span> <span class="ow">or</span> <span class="n">v</span><span class="o">.</span><span class="n">is_commit</span><span class="p">:</span>
                        <span class="n">version_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
                    <span class="n">matches</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Preference for version </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> does not match any known &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;version of </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2"> (in its package.py or any external)&quot;</span>
                        <span class="p">)</span>
                    <span class="n">version_defs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">weight</span><span class="p">,</span> <span class="n">vdef</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">dedupe</span><span class="p">(</span><span class="n">version_defs</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">DeclaredVersion</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">vdef</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">Provenance</span><span class="o">.</span><span class="n">PACKAGES_YAML</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vdef</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_ad_hoc_versions_from_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_ad_hoc_versions_from_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">define_ad_hoc_versions_from_specs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">require_checksum</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add concrete versions to possible versions from lists of CLI/dev specs.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="c1"># If there is a concrete version on the CLI *that we know nothing</span>
            <span class="c1"># about*, add it to the known versions. Use idx=0, which is the</span>
            <span class="c1"># best possible, so they&#39;re guaranteed to be used preferentially.</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span>

            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">any</span><span class="p">((</span><span class="n">v</span> <span class="o">==</span> <span class="n">version</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">])):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">require_checksum</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_checksummed_git_version</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UnsatisfiableSpecError</span><span class="p">(</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;No matching version for constraint </span><span class="si">{name}</span><span class="s2">{@versions}&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_deprecated</span> <span class="ow">and</span> <span class="n">version</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_versions</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">declared</span> <span class="o">=</span> <span class="n">DeclaredVersion</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">declared</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">version</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_supported_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler_name</span><span class="p">,</span> <span class="n">compiler_version</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of which targets are supported by the compiler.</span>

<span class="sd">        Results are ordered most to least recent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">supported</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">optimization_flags</span><span class="p">(</span><span class="n">compiler_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">compiler_version</span><span class="p">))</span>
                <span class="n">supported</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">UnsupportedMicroarchitecture</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">supported</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="SpackSolverSetup.platform_defaults">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.platform_defaults">[docs]</a>
    <span class="k">def</span> <span class="nf">platform_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Default platform&quot;</span><span class="p">)</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">host</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">node_platform_default</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">allowed_platform</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpackSolverSetup.os_defaults">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.os_defaults">[docs]</a>
    <span class="k">def</span> <span class="nf">os_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Possible operating systems&quot;</span><span class="p">)</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">host</span><span class="p">()</span>

        <span class="c1"># create set of OS&#39;s to consider</span>
        <span class="n">buildable</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">operating_sys</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Consider any OS&#39;s mentioned on the command line. We need this to</span>
        <span class="c1"># cross-concretize in CI, and for some tests.</span>
        <span class="c1"># TODO: OS should really be more than just a label -- rework this.</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">os</span><span class="p">:</span>
                <span class="n">buildable</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">os</span><span class="p">)</span>

        <span class="c1"># make directives for buildable OS&#39;s</span>
        <span class="k">for</span> <span class="n">build_os</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">buildable</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">buildable_os</span><span class="p">(</span><span class="n">build_os</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">keyfun</span><span class="p">(</span><span class="n">os</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">os</span> <span class="o">==</span> <span class="n">platform</span><span class="o">.</span><span class="n">default_os</span><span class="p">,</span>  <span class="c1"># prefer default</span>
                <span class="n">os</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buildable</span><span class="p">,</span>  <span class="c1"># then prefer buildables</span>
                <span class="n">os</span><span class="p">,</span>  <span class="c1"># then sort by name</span>
            <span class="p">)</span>

        <span class="n">all_oses</span> <span class="o">=</span> <span class="n">buildable</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_oses</span><span class="p">)</span>
        <span class="n">ordered_oses</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_oses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">keyfun</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># output the preference order of OS&#39;s for the concretizer to choose</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">os_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_oses</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">os_name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpackSolverSetup.target_defaults">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.target_defaults">[docs]</a>
    <span class="k">def</span> <span class="nf">target_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add facts about targets and target compatibility.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Default target&quot;</span><span class="p">)</span>

        <span class="n">platform</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">host</span><span class="p">()</span>
        <span class="n">uarch</span> <span class="o">=</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">TARGETS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Target compatibility&quot;</span><span class="p">)</span>

        <span class="c1"># Construct the list of targets which are compatible with the host</span>
        <span class="n">candidate_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">uarch</span><span class="p">]</span> <span class="o">+</span> <span class="n">uarch</span><span class="o">.</span><span class="n">ancestors</span>

        <span class="c1"># Get configuration options</span>
        <span class="n">granularity</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer:targets:granularity&quot;</span><span class="p">)</span>
        <span class="n">host_compatible</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer:targets:host_compatible&quot;</span><span class="p">)</span>

        <span class="c1"># Add targets which are not compatible with the current host</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">host_compatible</span><span class="p">:</span>
            <span class="n">additional_targets_in_family</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">t</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">TARGETS</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">uarch</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate_targets</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ancestors</span><span class="p">),</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">candidate_targets</span> <span class="o">+=</span> <span class="n">additional_targets_in_family</span>

        <span class="c1"># Check if we want only generic architecture</span>
        <span class="k">if</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s2">&quot;generic&quot;</span><span class="p">:</span>
            <span class="n">candidate_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">candidate_targets</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="s2">&quot;generic&quot;</span><span class="p">]</span>

        <span class="c1"># Add targets explicitly requested from specs</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">target</span> <span class="o">=</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">TARGETS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_ranges</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate_targets</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">host_compatible</span><span class="p">:</span>
                <span class="n">candidate_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">ancestors</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ancestor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate_targets</span><span class="p">:</span>
                        <span class="n">candidate_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>

        <span class="n">best_targets</span> <span class="o">=</span> <span class="p">{</span><span class="n">uarch</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">compiler_id</span><span class="p">,</span> <span class="n">known_compiler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_compilers</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">known_compiler</span><span class="o">.</span><span class="n">available</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">compiler</span> <span class="o">=</span> <span class="n">known_compiler</span><span class="o">.</span><span class="n">compiler_obj</span>
            <span class="c1"># Stub support for cross-compilation, to be expanded later</span>
            <span class="k">if</span> <span class="n">known_compiler</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compiler</span><span class="o">.</span><span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">uarch</span><span class="o">.</span><span class="n">family</span><span class="p">),</span>
                <span class="s2">&quot;any&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_supports_target</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="n">supported</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supported_targets</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">candidate_targets</span><span class="p">)</span>

            <span class="c1"># If we can&#39;t find supported targets it may be due to custom</span>
            <span class="c1"># versions in the spec, e.g. gcc@foo. Try to match the</span>
            <span class="c1"># real_version from the compiler object to get more accurate</span>
            <span class="c1"># results.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">supported</span><span class="p">:</span>
                <span class="n">supported</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supported_targets</span><span class="p">(</span>
                    <span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">real_version</span><span class="p">,</span> <span class="n">candidate_targets</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">supported</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">supported</span><span class="p">:</span>
                <span class="n">best_targets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_supports_target</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">compiler_supports_target</span><span class="p">(</span><span class="n">compiler_id</span><span class="p">,</span> <span class="n">uarch</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># TODO compute per-target offset?</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">candidate_targets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">target_family</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">target_compatible</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="c1"># Code for ancestor can run on target</span>
            <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">ancestors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">target_compatible</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="c1"># prefer best possible targets; weight others poorly so</span>
            <span class="c1"># they&#39;re not used unless set explicitly</span>
            <span class="c1"># these are stored to be generated as facts later offset by the</span>
            <span class="c1"># number of preferred targets</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">best_targets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_targets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_targets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_targets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_targets</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_preferences</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.virtual_providers">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.virtual_providers">[docs]</a>
    <span class="k">def</span> <span class="nf">virtual_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Virtual providers&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vspec</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_virtuals</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">virtual</span><span class="p">(</span><span class="n">vspec</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_version_constraints">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_version_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">define_version_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define what version_satisfies(...) means in ASP logic.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">versions</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_constraints</span><span class="p">):</span>
            <span class="c1"># generate facts for each package constraint and the version</span>
            <span class="c1"># that satisfies it</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">versions</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">version_satisfies</span><span class="p">(</span><span class="n">versions</span><span class="p">,</span> <span class="n">v</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.collect_virtual_constraints">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.collect_virtual_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_virtual_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define versions for constraints on virtuals.</span>

<span class="sd">        Must be called before define_version_constraints().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># aggregate constraints into per-virtual sets</span>
        <span class="n">constraint_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">versions</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">constraint_map</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span>

        <span class="c1"># extract all the real versions mentioned in version ranges</span>
        <span class="k">def</span> <span class="nf">versions_for</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">StandardVersion</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">ClosedOpenRange</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">lo</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">_prev_version</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">hi</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">VersionList</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">((</span><span class="n">versions_for</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">v</span><span class="p">),</span> <span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;expected version type, found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="c1"># define a set of synthetic possible versions for virtuals, so</span>
        <span class="c1"># that `version_satisfies(Package, Constraint, Version)` has the</span>
        <span class="c1"># same semantics for virtuals as for regular packages.</span>
        <span class="k">for</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">versions</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">constraint_map</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">possible_versions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">versions_for</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">],</span> <span class="p">[]))</span>
            <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">possible_versions</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">version</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_compiler_version_constraints">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_compiler_version_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">define_compiler_version_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler_version_constraints</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">compiler_id</span><span class="p">,</span> <span class="n">compiler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_compilers</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">constraint</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span>
                        <span class="n">fn</span><span class="o">.</span><span class="n">compiler_version_satisfies</span><span class="p">(</span>
                            <span class="n">constraint</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">constraint</span><span class="o">.</span><span class="n">versions</span><span class="p">,</span> <span class="n">compiler_id</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_target_constraints">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_target_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">define_target_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_all_targets_satisfiying</span><span class="p">(</span><span class="n">single_constraint</span><span class="p">):</span>
            <span class="n">allowed_targets</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">single_constraint</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">single_constraint</span><span class="p">]</span>

            <span class="n">t_min</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">=</span> <span class="n">single_constraint</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">test_target</span> <span class="ow">in</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">TARGETS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># Check lower bound</span>
                <span class="k">if</span> <span class="n">t_min</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t_min</span> <span class="o">&lt;=</span> <span class="n">test_target</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Check upper bound</span>
                <span class="k">if</span> <span class="n">t_max</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t_max</span> <span class="o">&gt;=</span> <span class="n">test_target</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">allowed_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_target</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">allowed_targets</span>

        <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">target_constraint</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_constraints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="c1"># Construct the list of allowed targets for this constraint</span>
            <span class="n">allowed_targets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">single_constraint</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_constraint</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">single_constraint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
                    <span class="n">cache</span><span class="p">[</span><span class="n">single_constraint</span><span class="p">]</span> <span class="o">=</span> <span class="n">_all_targets_satisfiying</span><span class="p">(</span><span class="n">single_constraint</span><span class="p">)</span>
                <span class="n">allowed_targets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cache</span><span class="p">[</span><span class="n">single_constraint</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">allowed_targets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">target_satisfies</span><span class="p">(</span><span class="n">target_constraint</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_variant_values">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_variant_values">[docs]</a>
    <span class="k">def</span> <span class="nf">define_variant_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate variant values from the command line.</span>

<span class="sd">        Add valid variant values from the command line to the possible values for</span>
<span class="sd">        variant definitions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Tell the concretizer about possible values from specs seen in spec_clauses().</span>
        <span class="c1"># We might want to order these facts by pkg and name if we are debugging.</span>
        <span class="k">for</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">variant_def_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_values_from_specs</span><span class="p">:</span>
            <span class="n">vid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_ids_by_def_id</span><span class="p">[</span><span class="n">variant_def_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">variant_possible_value</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span></div>


<div class="viewcode-block" id="SpackSolverSetup.register_concrete_spec">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.register_concrete_spec">[docs]</a>
    <span class="k">def</span> <span class="nf">register_concrete_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">possible</span><span class="p">):</span>
        <span class="c1"># tell the solver about any installed packages that could</span>
        <span class="c1"># be dependencies (don&#39;t tell it about the others)</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Only consider installed packages for repo we know</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">UnknownNamespaceError</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">UnknownPackageError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[REUSE] Issues when trying to reuse </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reusable_and_possible</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.concrete_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.concrete_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">concrete_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Emit facts for reusable specs&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reusable_and_possible</span><span class="o">.</span><span class="n">explicit_items</span><span class="p">():</span>
            <span class="c1"># this indicates that there is a spec like this installed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">installed_hash</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
            <span class="c1"># indirection layer between hash constraints and imposition to allow for splicing</span>
            <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required_from</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">hash_attr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">pred</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
            <span class="c1"># Declare as possible parts of specs that are not in package.py</span>
            <span class="c1"># - Add versions to possible versions</span>
            <span class="c1"># - Add OS to possible OS&#39;s</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">GitVersion</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">DeclaredVersion</span><span class="p">(</span>
                            <span class="n">version</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">Provenance</span><span class="o">.</span><span class="n">INSTALLED_GIT_VERSION</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">DeclaredVersion</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">Provenance</span><span class="o">.</span><span class="n">INSTALLED</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">possible_oses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">os</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_concrete_input_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_concrete_input_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">define_concrete_input_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">possible</span><span class="p">):</span>
        <span class="c1"># any concrete specs in the input spec list</span>
        <span class="k">for</span> <span class="n">input_spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">input_spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register_concrete_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">possible</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.setup">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">reuse</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_deprecated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an ASP program with relevant constraints for specs.</span>

<span class="sd">        This calls methods on the solve driver to set up the problem with</span>
<span class="sd">        facts and rules from all possible dependencies of the input</span>
<span class="sd">        specs, as well as constraints from the specs themselves.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            specs: list of Specs to solve</span>
<span class="sd">            reuse: list of concrete specs that can be reused</span>
<span class="sd">            allow_deprecated: if True adds deprecated versions into the solve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_packages_exist</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

        <span class="n">node_counter</span> <span class="o">=</span> <span class="n">_create_counter</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">possible_virtuals</span> <span class="o">=</span> <span class="n">node_counter</span><span class="o">.</span><span class="n">possible_virtuals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span> <span class="o">=</span> <span class="n">node_counter</span><span class="o">.</span><span class="n">possible_dependencies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libcs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_libcs</span><span class="p">())</span>  <span class="c1"># type: ignore[type-var]</span>

        <span class="c1"># Fail if we already know an unreachable node is requested</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">missing_deps</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">virtual</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">missing_deps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">InvalidDependencyError</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">missing_deps</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">explicitly_required_namespaces</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">namespace</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">ProblemInstanceBuilder</span><span class="p">()</span>
        <span class="n">compiler_parser</span> <span class="o">=</span> <span class="n">CompilerParser</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span><span class="o">.</span><span class="n">with_input_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">using_libc_compatibility</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">libc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">libcs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">host_libc</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_deprecated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">deprecated_versions_not_allowed</span><span class="p">())</span>

        <span class="c1"># Calculate develop specs</span>
        <span class="c1"># they will be used in addition to command line specs</span>
        <span class="c1"># in determining known versions/targets/os</span>
        <span class="n">dev_specs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">active_environment</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">dev_specs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">constrained</span><span class="p">(</span>
                    <span class="s2">&quot;dev_path=</span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">canonicalize_path</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="n">default_wd</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">dev_specs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="n">specs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>  <span class="c1"># ensure compatible types to add</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Reusable concrete specs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_concrete_input_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reuse</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">optimize_for_reuse</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">reusable_spec</span> <span class="ow">in</span> <span class="n">reuse</span><span class="p">:</span>
                <span class="n">compiler_parser</span><span class="o">.</span><span class="n">add_compiler_from_concrete_spec</span><span class="p">(</span><span class="n">reusable_spec</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register_concrete_spec</span><span class="p">(</span><span class="n">reusable_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concrete_specs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">possible_compilers</span> <span class="o">=</span> <span class="n">compiler_parser</span><span class="o">.</span><span class="n">possible_compilers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Generic statements on possible packages&quot;</span><span class="p">)</span>
        <span class="n">node_counter</span><span class="o">.</span><span class="n">possible_packages_facts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Possible flags on nodes&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">FlagMap</span><span class="o">.</span><span class="n">valid_compiler_flags</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">flag_type</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;General Constraints&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_compatible_os</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler_facts</span><span class="p">()</span>

        <span class="c1"># architecture defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform_defaults</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">os_defaults</span><span class="p">(</span><span class="n">specs</span> <span class="o">+</span> <span class="n">dev_specs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_defaults</span><span class="p">(</span><span class="n">specs</span> <span class="o">+</span> <span class="n">dev_specs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">virtual_providers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider_defaults</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider_requirements</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_packages</span><span class="p">()</span>

        <span class="c1"># TODO: make a config option for this undocumented feature</span>
        <span class="n">checksummed</span> <span class="o">=</span> <span class="s2">&quot;SPACK_CONCRETIZER_REQUIRE_CHECKSUM&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_package_versions_and_validate_preferences</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="o">=</span><span class="n">allow_deprecated</span><span class="p">,</span> <span class="n">require_checksum</span><span class="o">=</span><span class="n">checksummed</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_ad_hoc_versions_from_specs</span><span class="p">(</span>
            <span class="n">specs</span><span class="p">,</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">SPEC</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="o">=</span><span class="n">allow_deprecated</span><span class="p">,</span> <span class="n">require_checksum</span><span class="o">=</span><span class="n">checksummed</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_ad_hoc_versions_from_specs</span><span class="p">(</span>
            <span class="n">dev_specs</span><span class="p">,</span>
            <span class="n">Provenance</span><span class="o">.</span><span class="n">DEV_SPEC</span><span class="p">,</span>
            <span class="n">allow_deprecated</span><span class="o">=</span><span class="n">allow_deprecated</span><span class="p">,</span>
            <span class="n">require_checksum</span><span class="o">=</span><span class="n">checksummed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_and_define_versions_from_requirements</span><span class="p">(</span>
            <span class="n">allow_deprecated</span><span class="o">=</span><span class="n">allow_deprecated</span><span class="p">,</span> <span class="n">require_checksum</span><span class="o">=</span><span class="n">checksummed</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Package Constraints&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Package rules: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pkg_rules</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Package preferences: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preferred_variants</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Special variants&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_auto_variant</span><span class="p">(</span><span class="s2">&quot;dev_path&quot;</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_auto_variant</span><span class="p">(</span><span class="s2">&quot;patches&quot;</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Develop specs&quot;</span><span class="p">)</span>
        <span class="c1"># Inject dev_path from environment</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dev_specs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">ds</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is a develop spec&quot;</span> <span class="o">%</span> <span class="n">ds</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_rules</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effect_rules</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Spec Constraints&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Variant Values defined in specs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_variant_values</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">WITH_RUNTIME</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Runtimes&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define_runtime_constraints</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Version Constraints&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_virtual_constraints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_version_constraints</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Compiler Version Constraints&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_compiler_version_constraints</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Target Constraints&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_target_constraints</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h1</span><span class="p">(</span><span class="s2">&quot;Internal errors&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_errors</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">value</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.internal_errors">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.internal_errors">[docs]</a>
    <span class="k">def</span> <span class="nf">internal_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ast_type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="n">clingo</span><span class="p">()</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">ASTType</span><span class="o">.</span><span class="n">Rule</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ast_type</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">==</span> <span class="n">clingo</span><span class="p">()</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">ASTType</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ast_type</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span> <span class="o">==</span> <span class="n">clingo</span><span class="p">()</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">ASTType</span><span class="o">.</span><span class="n">SymbolicAtom</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">ast_sym</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;internal_error&quot;</span><span class="p">:</span>
                                <span class="n">arg</span> <span class="o">=</span> <span class="n">ast_sym</span><span class="p">(</span><span class="n">ast_sym</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">symbol</span> <span class="o">=</span> <span class="n">AspFunction</span><span class="p">(</span><span class="n">name</span><span class="p">)(</span><span class="n">arg</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">assumptions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parse_term</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">symbol</span><span class="p">)),</span> <span class="kc">True</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;concretize.lp&quot;</span><span class="p">)</span>
        <span class="n">parse_files</span><span class="p">([</span><span class="n">path</span><span class="p">],</span> <span class="n">visit</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpackSolverSetup.define_runtime_constraints">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.define_runtime_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">define_runtime_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the constraints to be imposed on the runtimes&quot;&quot;&quot;</span>
        <span class="n">recorder</span> <span class="o">=</span> <span class="n">RuntimePropertyRecorder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">compiler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_compilers</span><span class="p">:</span>
            <span class="n">compiler_with_different_cls_names</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;oneapi&quot;</span><span class="p">:</span> <span class="s2">&quot;intel-oneapi-compilers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;clang&quot;</span><span class="p">:</span> <span class="s2">&quot;llvm&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">compiler_cls_name</span> <span class="o">=</span> <span class="n">compiler_with_different_cls_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">compiler_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">compiler_cls_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">compiler_cls</span><span class="p">,</span> <span class="s2">&quot;runtime_constraints&quot;</span><span class="p">):</span>
                    <span class="n">compiler_cls</span><span class="o">.</span><span class="n">runtime_constraints</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">recorder</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">UnknownPackageError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Inject libc from available compilers, on Linux</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compiler</span><span class="o">.</span><span class="n">available</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">current_libc</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compiler_obj</span><span class="o">.</span><span class="n">default_libc</span>

            <span class="k">if</span> <span class="n">using_libc_compatibility</span><span class="p">()</span> <span class="ow">and</span> <span class="n">current_libc</span><span class="p">:</span>
                <span class="n">recorder</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span>
                    <span class="s2">&quot;libc&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Add libc&quot;</span>
                <span class="p">)</span>
                <span class="n">recorder</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">current_libc</span><span class="p">),</span>
                    <span class="n">when</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">compiler</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;link&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Add libc&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">recorder</span><span class="o">.</span><span class="n">consume_facts</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.literal_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.literal_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">literal_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Spec: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
            <span class="n">condition_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">)</span>
            <span class="n">trigger_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">)</span>

            <span class="c1"># Special condition triggered by &quot;literal_solved&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">condition_trigger</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">trigger_id</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">condition_reason</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2"> requested explicitly&quot;</span><span class="p">))</span>

            <span class="n">imposed_spec_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="kc">None</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_cache</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">imposed_spec_key</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
                <span class="n">effect_id</span><span class="p">,</span> <span class="n">requirements</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">imposed_spec_key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">effect_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_counter</span><span class="p">)</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">SourceContext</span><span class="p">()</span>
                <span class="n">context</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;literal&quot;</span>
                <span class="n">requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="n">root_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                <span class="n">clause_name</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">clause_name</span> <span class="o">==</span> <span class="s2">&quot;variant_set&quot;</span><span class="p">:</span>
                    <span class="n">requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;variant_default_value_from_cli&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">clause</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">clause_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;virtual_node&quot;</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">):</span>
                    <span class="c1"># These facts are needed to compute the &quot;condition_set&quot; of the root</span>
                    <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">mentioned_in_literal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">root_name</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">))</span>

            <span class="n">requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;virtual_root&quot;</span> <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">virtual</span> <span class="k">else</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">imposed_spec_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">effect_id</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">pkg_fact</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">condition_effect</span><span class="p">(</span><span class="n">condition_id</span><span class="p">,</span> <span class="n">effect_id</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">concretize_everything</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">solve_literal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">effect_rules</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpackSolverSetup.validate_and_define_versions_from_requirements">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.validate_and_define_versions_from_requirements">[docs]</a>
    <span class="k">def</span> <span class="nf">validate_and_define_versions_from_requirements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">require_checksum</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If package requirements mention concrete versions that are not mentioned</span>
<span class="sd">        elsewhere, then we need to collect those to mark them as possible</span>
<span class="sd">        versions. If they are abstract and statically have no match, then we</span>
<span class="sd">        need to throw an error. This function assumes all possible versions are already</span>
<span class="sd">        registered in self.possible_versions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pkg_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="s2">&quot;require&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_specs_from_requires</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;require&quot;</span><span class="p">])):</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">versions</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">versions</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span> <span class="ow">or</span> <span class="n">versions</span> <span class="o">==</span> <span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">any_version</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">s</span><span class="o">.</span><span class="n">attach_git_version_lookup</span><span class="p">()</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">versions</span><span class="o">.</span><span class="n">concrete</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                    <span class="c1"># If the version is not concrete, check it&#39;s statically concretizable. If</span>
                    <span class="c1"># not throw an error, which is just so that users know they need to change</span>
                    <span class="c1"># their config, instead of getting a hard to decipher concretization error.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">versions</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Version requirement </span><span class="si">{</span><span class="n">versions</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;cannot match any known version from package.py or externals&quot;</span>
                        <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_deprecated</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_versions</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="c1"># If concrete an not yet defined, conditionally define it, like we do for specs</span>
                <span class="c1"># from the command line.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">require_checksum</span> <span class="ow">or</span> <span class="n">_is_checksummed_git_version</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">DeclaredVersion</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">Provenance</span><span class="o">.</span><span class="n">PACKAGE_REQUIREMENT</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_specs_from_requires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect specs from a requirement rule&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">_spec_with_default_name</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">spec_group</span> <span class="ow">in</span> <span class="n">section</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec_group</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">_spec_with_default_name</span><span class="p">(</span><span class="n">spec_group</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Otherwise it is an object. The object can contain a single</span>
            <span class="c1"># &quot;spec&quot; constraint, or a list of them with &quot;any_of&quot; or</span>
            <span class="c1"># &quot;one_of&quot; policy.</span>
            <span class="k">if</span> <span class="s2">&quot;spec&quot;</span> <span class="ow">in</span> <span class="n">spec_group</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">_spec_with_default_name</span><span class="p">(</span><span class="n">spec_group</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span> <span class="n">pkg_name</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;one_of&quot;</span> <span class="k">if</span> <span class="s2">&quot;one_of&quot;</span> <span class="ow">in</span> <span class="n">spec_group</span> <span class="k">else</span> <span class="s2">&quot;any_of&quot;</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec_group</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">_spec_with_default_name</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">)</span>

<div class="viewcode-block" id="SpackSolverSetup.pkg_class">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpackSolverSetup.pkg_class">[docs]</a>
    <span class="k">def</span> <span class="nf">pkg_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">]:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">pkg_name</span>
        <span class="k">if</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">explicitly_required_namespaces</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explicitly_required_namespaces</span><span class="p">[</span><span class="n">pkg_name</span><span class="p">]</span>
            <span class="n">request</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>
</div>



<span class="k">class</span> <span class="nc">_Head</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ASP functions used to express spec clauses in the HEAD of a rule&quot;&quot;&quot;</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;namespace_set&quot;</span><span class="p">)</span>
    <span class="n">virtual_node</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;virtual_node&quot;</span><span class="p">)</span>
    <span class="n">node_platform</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_platform_set&quot;</span><span class="p">)</span>
    <span class="n">node_os</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_os_set&quot;</span><span class="p">)</span>
    <span class="n">node_target</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_target_set&quot;</span><span class="p">)</span>
    <span class="n">variant_value</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;variant_set&quot;</span><span class="p">)</span>
    <span class="n">node_compiler</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_compiler_set&quot;</span><span class="p">)</span>
    <span class="n">node_compiler_version</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_compiler_version_set&quot;</span><span class="p">)</span>
    <span class="n">node_flag</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_flag_set&quot;</span><span class="p">)</span>
    <span class="n">propagate</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;propagate&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Body</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ASP functions used to express spec clauses in the BODY of a rule&quot;&quot;&quot;</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">)</span>
    <span class="n">virtual_node</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;virtual_node&quot;</span><span class="p">)</span>
    <span class="n">node_platform</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_platform&quot;</span><span class="p">)</span>
    <span class="n">node_os</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_os&quot;</span><span class="p">)</span>
    <span class="n">node_target</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_target&quot;</span><span class="p">)</span>
    <span class="n">variant_value</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;variant_value&quot;</span><span class="p">)</span>
    <span class="n">node_compiler</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_compiler&quot;</span><span class="p">)</span>
    <span class="n">node_compiler_version</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_compiler_version&quot;</span><span class="p">)</span>
    <span class="n">node_flag</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node_flag&quot;</span><span class="p">)</span>
    <span class="n">propagate</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;propagate&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ProblemInstanceBuilder">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder">[docs]</a>
<span class="k">class</span> <span class="nc">ProblemInstanceBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides an interface to construct a problem instance.</span>

<span class="sd">    Once all the facts and rules have been added, the problem instance can be retrieved with:</span>

<span class="sd">    &gt;&gt;&gt; builder = ProblemInstanceBuilder()</span>
<span class="sd">    &gt;&gt;&gt; ...</span>
<span class="sd">    &gt;&gt;&gt; problem_instance = builder.value()</span>

<span class="sd">    The problem instance can be added directly to the &quot;control&quot; structure of clingo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ProblemInstanceBuilder.fact">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.fact">[docs]</a>
    <span class="k">def</span> <span class="nf">fact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">:</span> <span class="n">AspFunction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">symbol</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;symbol&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemInstanceBuilder.append">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.append">[docs]</a>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemInstanceBuilder.title">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.title">[docs]</a>
    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">char</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span> <span class="mi">76</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;% </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span> <span class="mi">76</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemInstanceBuilder.h1">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.h1">[docs]</a>
    <span class="k">def</span> <span class="nf">h1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemInstanceBuilder.h2">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.h2">[docs]</a>
    <span class="k">def</span> <span class="nf">h2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemInstanceBuilder.h3">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.h3">[docs]</a>
    <span class="k">def</span> <span class="nf">h3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;% </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemInstanceBuilder.newline">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.newline">[docs]</a>
    <span class="k">def</span> <span class="nf">newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProblemInstanceBuilder.value">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ProblemInstanceBuilder.value">[docs]</a>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asp_problem</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="parse_spec_from_yaml_string">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.parse_spec_from_yaml_string">[docs]</a>
<span class="k">def</span> <span class="nf">parse_spec_from_yaml_string</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a spec from YAML and add file/line info to errors, if it&#39;s available.</span>

<span class="sd">    Parse a ``Spec`` from the supplied string, but also intercept any syntax errors and</span>
<span class="sd">    add file/line information for debugging using file/line annotations from the string.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        string: a string representing a ``Spec`` from config YAML.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SpecSyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="n">get_mark_from_yaml_data</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mark</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mark</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">mark</span><span class="o">.</span><span class="n">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">SpecSyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">raise</span> <span class="n">e</span></div>



<div class="viewcode-block" id="RequirementParser">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser">[docs]</a>
<span class="k">class</span> <span class="nc">RequirementParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses requirements from package.py files and configuration, and returns rules.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span>

<div class="viewcode-block" id="RequirementParser.rules">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser.rules">[docs]</a>
    <span class="k">def</span> <span class="nf">rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_from_package_py</span><span class="p">(</span><span class="n">pkg</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_from_require</span><span class="p">(</span><span class="n">pkg</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_from_prefer</span><span class="p">(</span><span class="n">pkg</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_from_conflict</span><span class="p">(</span><span class="n">pkg</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="RequirementParser.rules_from_package_py">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser.rules_from_package_py">[docs]</a>
    <span class="k">def</span> <span class="nf">rules_from_package_py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]:</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">requirement_list</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">requirement_list</span><span class="p">:</span>
                <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">RequirementRule</span><span class="p">(</span>
                        <span class="n">pkg_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span>
                        <span class="n">requirements</span><span class="o">=</span><span class="n">requirements</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">RequirementKind</span><span class="o">.</span><span class="n">PACKAGE</span><span class="p">,</span>
                        <span class="n">condition</span><span class="o">=</span><span class="n">when_spec</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">rules</span></div>


<div class="viewcode-block" id="RequirementParser.rules_from_virtual">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser.rules_from_virtual">[docs]</a>
    <span class="k">def</span> <span class="nf">rules_from_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">virtual_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]:</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">virtual_str</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;require&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules_from_requirements</span><span class="p">(</span>
            <span class="n">virtual_str</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">RequirementKind</span><span class="o">.</span><span class="n">VIRTUAL</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RequirementParser.rules_from_require">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser.rules_from_require">[docs]</a>
    <span class="k">def</span> <span class="nf">rules_from_require</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]:</span>
        <span class="n">kind</span><span class="p">,</span> <span class="n">requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_yaml_data</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s2">&quot;require&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules_from_requirements</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span></div>


<div class="viewcode-block" id="RequirementParser.rules_from_prefer">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser.rules_from_prefer">[docs]</a>
    <span class="k">def</span> <span class="nf">rules_from_prefer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kind</span><span class="p">,</span> <span class="n">preferences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_yaml_data</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s2">&quot;prefer&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">preferences</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_prefer_conflict_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="c1"># A strong preference is defined as:</span>
                <span class="c1">#</span>
                <span class="c1"># require:</span>
                <span class="c1"># - any_of: [spec_str, &quot;@:&quot;]</span>
                <span class="n">RequirementRule</span><span class="p">(</span>
                    <span class="n">pkg_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">policy</span><span class="o">=</span><span class="s2">&quot;any_of&quot;</span><span class="p">,</span>
                    <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="n">spec</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="s2">&quot;@:&quot;</span><span class="p">)],</span>
                    <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="RequirementParser.rules_from_conflict">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser.rules_from_conflict">[docs]</a>
    <span class="k">def</span> <span class="nf">rules_from_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kind</span><span class="p">,</span> <span class="n">conflicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_yaml_data</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s2">&quot;conflict&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_prefer_conflict_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="c1"># A conflict is defined as:</span>
                <span class="c1">#</span>
                <span class="c1"># require:</span>
                <span class="c1"># - one_of: [spec_str, &quot;@:&quot;]</span>
                <span class="n">RequirementRule</span><span class="p">(</span>
                    <span class="n">pkg_name</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">policy</span><span class="o">=</span><span class="s2">&quot;one_of&quot;</span><span class="p">,</span>
                    <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="n">spec</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="s2">&quot;@:&quot;</span><span class="p">)],</span>
                    <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


    <span class="k">def</span> <span class="nf">_parse_prefer_conflict_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># The item is either a string or an object with at least a &quot;spec&quot; attribute</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">parse_spec_from_yaml_string</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">parse_spec_from_yaml_string</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;when&quot;</span><span class="p">))</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spec</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">_raw_yaml_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">RequirementKind</span><span class="o">.</span><span class="n">PACKAGE</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">RequirementKind</span><span class="o">.</span><span class="n">DEFAULT</span>
        <span class="k">return</span> <span class="n">kind</span><span class="p">,</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_rules_from_requirements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="n">RequirementKind</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequirementRule</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Manipulate requirements from packages.yaml, and return a list of tuples</span>
<span class="sd">        with a uniform structure (name, policy, requirements).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requirements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="p">[</span><span class="n">requirements</span><span class="p">]</span>

        <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="c1"># A string is equivalent to a one_of group with a single element</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requirement</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">requirement</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;one_of&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">requirement</span><span class="p">]}</span>

            <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">,</span> <span class="s2">&quot;one_of&quot;</span><span class="p">,</span> <span class="s2">&quot;any_of&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">policy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">requirement</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">constraints</span> <span class="o">=</span> <span class="n">requirement</span><span class="p">[</span><span class="n">policy</span><span class="p">]</span>
                <span class="c1"># &quot;spec&quot; is for specifying a single spec</span>
                <span class="k">if</span> <span class="n">policy</span> <span class="o">==</span> <span class="s2">&quot;spec&quot;</span><span class="p">:</span>
                    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">constraints</span><span class="p">]</span>
                    <span class="n">policy</span> <span class="o">=</span> <span class="s2">&quot;one_of&quot;</span>

                <span class="c1"># validate specs from YAML first, and fail with line numbers if parsing fails.</span>
                <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">parse_spec_from_yaml_string</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span> <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span>
                <span class="p">]</span>
                <span class="n">when_str</span> <span class="o">=</span> <span class="n">requirement</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;when&quot;</span><span class="p">)</span>
                <span class="n">when</span> <span class="o">=</span> <span class="n">parse_spec_from_yaml_string</span><span class="p">(</span><span class="n">when_str</span><span class="p">)</span> <span class="k">if</span> <span class="n">when_str</span> <span class="k">else</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">()</span>

                <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">constraints</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_requirement_constraint</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">constraints</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">RequirementRule</span><span class="p">(</span>
                        <span class="n">pkg_name</span><span class="o">=</span><span class="n">pkg_name</span><span class="p">,</span>
                        <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span>
                        <span class="n">requirements</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">requirement</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">),</span>
                        <span class="n">condition</span><span class="o">=</span><span class="n">when</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">rules</span>

<div class="viewcode-block" id="RequirementParser.reject_requirement_constraint">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RequirementParser.reject_requirement_constraint">[docs]</a>
    <span class="k">def</span> <span class="nf">reject_requirement_constraint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">constraint</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="n">RequirementKind</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if a requirement constraint should be rejected&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">RequirementKind</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">:</span>
            <span class="c1"># Requirements under all: are applied only if they are satisfiable considering only</span>
            <span class="c1"># package rules, so e.g. variants must exist etc. Otherwise, they are rejected.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">validate_or_raise</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[SETUP] Rejecting the default &#39;</span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s2">&#39; requirement &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;on &#39;</span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="CompilerParser">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.CompilerParser">[docs]</a>
<span class="k">class</span> <span class="nc">CompilerParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses configuration files, and builds a list of possible compilers for the solve.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">KnownCompiler</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">all_compilers_from</span><span class="p">(</span><span class="n">configuration</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">using_libc_compatibility</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c_compiler_runs</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;the C compiler </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">cc</span><span class="si">}</span><span class="s2"> does not exist, or does not run correctly.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; The compiler </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2"> will not be used during concretization.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">using_libc_compatibility</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">default_libc</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;cannot detect libc from </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">. The compiler will not be used &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;during concretization.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">target</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="s2">&quot;any&quot;</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">KnownCompiler</span><span class="p">(</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">operating_system</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">available</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compiler_obj</span><span class="o">=</span><span class="n">c</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;duplicate found for </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">operating_system</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Edit your compilers.yaml configuration to remove it.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

<div class="viewcode-block" id="CompilerParser.with_input_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.CompilerParser.with_input_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">with_input_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CompilerParser&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Accounts for input specs when building the list of possible compilers.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_specs: specs to be concretized</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strict</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">concretize</span><span class="o">.</span><span class="n">CHECK_COMPILER_EXISTENCE</span>
        <span class="n">default_os</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">host</span><span class="p">()</span><span class="o">.</span><span class="n">default_os</span><span class="p">)</span>
        <span class="n">default_target</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">host</span><span class="p">()</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span><span class="n">input_specs</span><span class="p">):</span>
            <span class="c1"># we don&#39;t need to validate compilers for already-built specs</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">compiler</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">version</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">version</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">compiler</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Error when a compiler is not found and strict mode is enabled</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">concretize</span><span class="o">.</span><span class="n">UnavailableCompilerVersionError</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">compiler</span><span class="p">)</span>

            <span class="c1"># Make up a compiler matching the input spec. This is for bootstrapping.</span>
            <span class="n">compiler_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">class_for_compiler_name</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">compiler_obj</span> <span class="o">=</span> <span class="n">compiler_cls</span><span class="p">(</span>
                <span class="n">s</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span> <span class="n">operating_system</span><span class="o">=</span><span class="n">default_os</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">default_target</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">KnownCompiler</span><span class="p">(</span>
                    <span class="n">spec</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">=</span><span class="n">default_os</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">default_target</span><span class="p">,</span>
                    <span class="n">available</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">compiler_obj</span><span class="o">=</span><span class="n">compiler_obj</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="CompilerParser.add_compiler_from_concrete_spec">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.CompilerParser.add_compiler_from_concrete_spec">[docs]</a>
    <span class="k">def</span> <span class="nf">add_compiler_from_concrete_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Account for compilers that are coming from concrete specs, through reuse.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: concrete spec to be reused</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">,</span> <span class="s2">&quot;the spec argument must be concrete&quot;</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="n">KnownCompiler</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span>
            <span class="n">os</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">os</span><span class="p">),</span>
            <span class="n">target</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">family</span><span class="p">),</span>
            <span class="n">available</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compiler_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span></div>


<div class="viewcode-block" id="CompilerParser.possible_compilers">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.CompilerParser.possible_compilers">[docs]</a>
    <span class="k">def</span> <span class="nf">possible_compilers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">KnownCompiler</span><span class="p">]:</span>
        <span class="c1"># Here we have to sort two times, first sort by name and ascending version</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Then stable sort to prefer available compilers and account for preferences</span>
        <span class="n">ppk</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_prefs</span><span class="o">.</span><span class="n">PackagePrefs</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;compiler&quot;</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">available</span><span class="p">,</span> <span class="n">ppk</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">spec</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span></div>
</div>



<div class="viewcode-block" id="RuntimePropertyRecorder">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RuntimePropertyRecorder">[docs]</a>
<span class="k">class</span> <span class="nc">RuntimePropertyRecorder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An object of this class is injected in callbacks to compilers, to let them declare</span>
<span class="sd">    properties of the runtimes they support and of the runtimes they provide, and to add</span>
<span class="sd">    runtime dependencies to the nodes using said compiler.</span>

<span class="sd">    The usage of the object is the following. First, a runtime package name or the wildcard</span>
<span class="sd">    &quot;*&quot; are passed as an argument to __call__, to set which kind of package we are referring to.</span>
<span class="sd">    Then we can call one method with a directive-like API.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; pkg = RuntimePropertyRecorder(setup)</span>
<span class="sd">        &gt;&gt;&gt; # Every package compiled with %gcc has a link dependency on &#39;gcc-runtime&#39;</span>
<span class="sd">        &gt;&gt;&gt; pkg(&quot;*&quot;).depends_on(</span>
<span class="sd">        ...     &quot;gcc-runtime&quot;,</span>
<span class="sd">        ...     when=&quot;%gcc&quot;,</span>
<span class="sd">        ...     type=&quot;link&quot;,</span>
<span class="sd">        ...     description=&quot;If any package uses %gcc, it depends on gcc-runtime&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; # The version of gcc-runtime is the same as the %gcc used to &quot;compile&quot; it</span>
<span class="sd">        &gt;&gt;&gt; pkg(&quot;gcc-runtime&quot;).requires(&quot;@=9.4.0&quot;, when=&quot;%gcc@=9.4.0&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_conditions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># State of this object set in the __call__ method, and reset after</span>
        <span class="c1"># each directive-like method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RuntimePropertyRecorder&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets a package name for the next directive-like method call&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;state was already set to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_package</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="o">=</span> <span class="n">package_name</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="RuntimePropertyRecorder.reset">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RuntimePropertyRecorder.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets the current state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RuntimePropertyRecorder.depends_on">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RuntimePropertyRecorder.depends_on">[docs]</a>
    <span class="k">def</span> <span class="nf">depends_on</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dependency_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">when</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">languages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Injects conditional dependencies on packages.</span>

<span class="sd">        Conditional dependencies can be either &quot;real&quot; packages or virtual dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            dependency_str: the dependency spec to inject</span>
<span class="sd">            when: anonymous condition to be met on a package to have the dependency</span>
<span class="sd">            type: dependency type</span>
<span class="sd">            languages: languages needed by the package for the dependency to be considered</span>
<span class="sd">            description: human-readable description of the rule for adding the dependency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: The API for this function is not final, and is still subject to change. At</span>
        <span class="c1"># TODO: the moment, we implemented only the features strictly needed for the</span>
        <span class="c1"># TODO: functionality currently provided by Spack, and we assert nothing else is required.</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;the &#39;depends_on&#39; method can be called only with pkg(&#39;*&#39;)&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">when_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;only anonymous when specs are accepted&quot;</span>

        <span class="n">dependency_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">dependency_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependency_spec</span><span class="o">.</span><span class="n">versions</span> <span class="o">!=</span> <span class="n">vn</span><span class="o">.</span><span class="n">any_version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">version_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dependency_spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dependency_spec</span><span class="o">.</span><span class="n">versions</span><span class="p">))</span>

        <span class="n">placeholder</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>
        <span class="n">node_variable</span> <span class="o">=</span> <span class="s2">&quot;node(ID, Package)&quot;</span>
        <span class="n">when_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">placeholder</span>

        <span class="n">body_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39;,</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">body_clauses</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  not external(</span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  not runtime(Package)&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">placeholder</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">languages</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">+=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;  attr(&quot;language&quot;, </span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s1">, &quot;</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>

        <span class="n">head_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">dependency_spec</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">runtime_pkg</span> <span class="o">=</span> <span class="n">dependency_spec</span><span class="o">.</span><span class="n">name</span>

        <span class="n">is_virtual</span> <span class="o">=</span> <span class="n">head_clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;virtual_node&quot;</span>
        <span class="n">main_rule</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;% </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s1">&#39;1 </span><span class="se">{{</span><span class="s1"> attr(&quot;depends_on&quot;, </span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s1">, node(0..X-1, &quot;</span><span class="si">{</span><span class="n">runtime_pkg</span><span class="si">}</span><span class="s1">&quot;), &quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&quot;) :&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; max_dupes(&quot;</span><span class="si">{</span><span class="n">runtime_pkg</span><span class="si">}</span><span class="s1">&quot;, X)</span><span class="se">}}</span><span class="s1"> 1:-</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">body_str</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_virtual</span><span class="p">:</span>
            <span class="n">main_rule</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;% </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s1">&#39;attr(&quot;dependency_holds&quot;, </span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s1">, &quot;</span><span class="si">{</span><span class="n">runtime_pkg</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&quot;) :-</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">body_str</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_rule</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">head_clauses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clause</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">runtime_node</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;node(RuntimeID, &quot;</span><span class="si">{</span><span class="n">runtime_pkg</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="n">head_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">runtime_pkg</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">runtime_node</span><span class="p">)</span>
            <span class="n">depends_on_constraint</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;  attr(&quot;depends_on&quot;, </span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">runtime_node</span><span class="si">}</span><span class="s1">, &quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&quot;),</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_virtual</span><span class="p">:</span>
                <span class="n">depends_on_constraint</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;  attr(&quot;depends_on&quot;, </span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s1">, ProviderNode, &quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&quot;),</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s2">&quot;  provider(ProviderNode, </span><span class="si">{</span><span class="n">runtime_node</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">rule</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">head_str</span><span class="si">}</span><span class="s2"> :-</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">depends_on_constraint</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">body_str</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>


<div class="viewcode-block" id="RuntimePropertyRecorder.requires">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RuntimePropertyRecorder.requires">[docs]</a>
    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">impose</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Injects conditional requirements on a given package.</span>

<span class="sd">        Args:</span>
<span class="sd">            impose: constraint to be imposed</span>
<span class="sd">            when: condition triggering the constraint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;the &#39;requires&#39; method cannot be called with pkg(&#39;*&#39;) or without setting the package&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">imposed_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_package</span><span class="si">}{</span><span class="n">impose</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_package</span><span class="si">}{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">imposed_spec</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">impose</span><span class="si">}</span><span class="s2"> must have a concrete version&quot;</span>
        <span class="k">assert</span> <span class="n">when_spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">concrete</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2"> must have a concrete compiler&quot;</span>

        <span class="c1"># Add versions to possible versions</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">imposed_spec</span><span class="p">,</span> <span class="n">when_spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">possible_versions</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">declared_versions</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">DeclaredVersion</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">Provenance</span><span class="o">.</span><span class="n">RUNTIME</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_conditions</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">imposed_spec</span><span class="p">,</span> <span class="n">when_spec</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>


<div class="viewcode-block" id="RuntimePropertyRecorder.propagate">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RuntimePropertyRecorder.propagate">[docs]</a>
    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;the &#39;propagate&#39; method can be called only with pkg(&#39;*&#39;)&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_package</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">when_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;only anonymous when specs are accepted&quot;</span>

        <span class="n">placeholder</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>
        <span class="n">node_variable</span> <span class="o">=</span> <span class="s2">&quot;node(ID, Package)&quot;</span>
        <span class="n">when_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">placeholder</span>

        <span class="n">body_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39;,</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">body_clauses</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  not external(</span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  not runtime(Package)&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">placeholder</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">constraint_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">constraint_str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">constraint_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;only anonymous constraint specs are accepted&quot;</span>

        <span class="n">constraint_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">placeholder</span>
        <span class="n">constraint_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">spec_clauses</span><span class="p">(</span><span class="n">constraint_spec</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">constraint_clauses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clause</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;node_compiler_version_satisfies&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">compiler_version_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">constraint_spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">constraint_spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">constraint_spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">versions</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="n">head_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;propagate(</span><span class="si">{</span><span class="n">node_variable</span><span class="si">}</span><span class="s2">, node_compiler_version_satisfies(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">))&quot;</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">head_str</span><span class="si">}</span><span class="s2"> :-</span><span class="se">\n</span><span class="si">{</span><span class="n">body_str</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>


<div class="viewcode-block" id="RuntimePropertyRecorder.consume_facts">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.RuntimePropertyRecorder.consume_facts">[docs]</a>
    <span class="k">def</span> <span class="nf">consume_facts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Consume the facts collected by this object, and emits rules and</span>
<span class="sd">        facts for the runtimes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Runtimes: rules&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">h2</span><span class="p">(</span><span class="s2">&quot;Runtimes: conditions&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">runtime_pkg</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">packages_with_tags</span><span class="p">(</span><span class="s2">&quot;runtime&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">runtime</span><span class="p">(</span><span class="n">runtime_pkg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">possible_in_link_run</span><span class="p">(</span><span class="n">runtime_pkg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
            <span class="c1"># Inject version rules for runtimes (versions are declared based</span>
            <span class="c1"># on the available compilers)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">pkg_version_rules</span><span class="p">(</span><span class="n">runtime_pkg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">imposed_spec</span><span class="p">,</span> <span class="n">when_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_conditions</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">when_spec</span><span class="si">}</span><span class="s2"> requires </span><span class="si">{</span><span class="n">imposed_spec</span><span class="si">}</span><span class="s2"> at runtime&quot;</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="n">imposed_spec</span><span class="o">=</span><span class="n">imposed_spec</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">trigger_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="o">.</span><span class="n">effect_rules</span><span class="p">()</span></div>
</div>



<span class="c1"># This should be a dataclass, but dataclasses don&#39;t work on Python 3.6</span>
<div class="viewcode-block" id="Splice">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Splice">[docs]</a>
<span class="k">class</span> <span class="nc">Splice</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splice_node</span><span class="p">:</span> <span class="n">NodeArgument</span><span class="p">,</span> <span class="n">child_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">child_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splice_node</span> <span class="o">=</span> <span class="n">splice_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_name</span> <span class="o">=</span> <span class="n">child_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_hash</span> <span class="o">=</span> <span class="n">child_hash</span></div>



<div class="viewcode-block" id="SpecBuilder">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder">[docs]</a>
<span class="k">class</span> <span class="nc">SpecBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class with actions to rebuild a spec from ASP results.&quot;&quot;&quot;</span>

    <span class="c1">#: Regex for attributes that don&#39;t need actions b/c they aren&#39;t used to construct specs.</span>
    <span class="n">ignored_attributes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">r</span><span class="s2">&quot;^.*_propagate$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*_satisfies$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*_set$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^compatible_libc$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^dependency_holds$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^external_conditions_hold$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^node_compiler$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^package_hash$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^root$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^track_dependencies$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^variant_default_value_from_cli$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^virtual_node$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^virtual_on_incoming_edges$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^virtual_root$&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>

<div class="viewcode-block" id="SpecBuilder.make_node">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.make_node">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_node</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeArgument</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a package name, returns the string representation of the &quot;min_dupe_id&quot; node in</span>
<span class="sd">        the ASP encoding.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: name of a package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">NodeArgument</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">hash_lookup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeArgument</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Matches parent nodes to splice node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeArgument</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Splice</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command_line_specs</span> <span class="o">=</span> <span class="n">specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag_sources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">NodeArgument</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Pass in as arguments reusable specs and plug them in</span>
        <span class="c1"># from this dictionary during reconstruction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash_lookup</span> <span class="o">=</span> <span class="n">hash_lookup</span> <span class="ow">or</span> <span class="n">ConcreteSpecsByHash</span><span class="p">()</span>

<div class="viewcode-block" id="SpecBuilder.hash">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.hash">[docs]</a>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_lookup</span><span class="p">[</span><span class="n">h</span><span class="p">]</span></div>


<div class="viewcode-block" id="SpecBuilder.node">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.node">[docs]</a>
    <span class="k">def</span> <span class="nf">node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">flag_type</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">FlagMap</span><span class="o">.</span><span class="n">valid_compiler_flags</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">compiler_flags</span><span class="p">[</span><span class="n">flag_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


    <span class="k">def</span> <span class="nf">_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">architecture</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arch</span><span class="p">:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">ArchSpec</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">architecture</span> <span class="o">=</span> <span class="n">arch</span>
        <span class="k">return</span> <span class="n">arch</span>

<div class="viewcode-block" id="SpecBuilder.namespace">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.namespace">[docs]</a>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span></div>


<div class="viewcode-block" id="SpecBuilder.node_platform">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.node_platform">[docs]</a>
    <span class="k">def</span> <span class="nf">node_platform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span></div>


<div class="viewcode-block" id="SpecBuilder.node_os">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.node_os">[docs]</a>
    <span class="k">def</span> <span class="nf">node_os</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">os</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">os</span></div>


<div class="viewcode-block" id="SpecBuilder.node_target">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.node_target">[docs]</a>
    <span class="k">def</span> <span class="nf">node_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span></div>


<div class="viewcode-block" id="SpecBuilder.variant_selected">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.variant_selected">[docs]</a>
    <span class="k">def</span> <span class="nf">variant_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">variant_type</span><span class="p">,</span> <span class="n">variant_id</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="n">variant</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variant</span><span class="p">:</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">VariantType</span><span class="p">(</span><span class="n">variant_type</span><span class="p">)</span><span class="o">.</span><span class="n">variant_class</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">variant_type</span> <span class="o">==</span> <span class="n">vt</span><span class="o">.</span><span class="n">VariantType</span><span class="o">.</span><span class="n">MULTI</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can&#39;t have multiple values for single-valued variant: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">variant_type</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">variant_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">variant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpecBuilder.version">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.version">[docs]</a>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">versions</span> <span class="o">=</span> <span class="n">vn</span><span class="o">.</span><span class="n">VersionList</span><span class="p">([</span><span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">version</span><span class="p">)])</span></div>


<div class="viewcode-block" id="SpecBuilder.node_compiler_version">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.node_compiler_version">[docs]</a>
    <span class="k">def</span> <span class="nf">node_compiler_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">CompilerSpec</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">versions</span> <span class="o">=</span> <span class="n">vn</span><span class="o">.</span><span class="n">VersionList</span><span class="p">([</span><span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">version</span><span class="p">)])</span></div>


<div class="viewcode-block" id="SpecBuilder.node_flag">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.node_flag">[docs]</a>
    <span class="k">def</span> <span class="nf">node_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_flag</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">compiler_flags</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span>
            <span class="n">node_flag</span><span class="o">.</span><span class="n">flag_type</span><span class="p">,</span> <span class="n">node_flag</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">node_flag</span><span class="o">.</span><span class="n">flag_group</span><span class="p">,</span> <span class="n">node_flag</span><span class="o">.</span><span class="n">source</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SpecBuilder.external_spec_selected">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.external_spec_selected">[docs]</a>
    <span class="k">def</span> <span class="nf">external_spec_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This means that the external spec and index idx has been selected for this package.&quot;&quot;&quot;</span>
        <span class="n">packages_yaml</span> <span class="o">=</span> <span class="n">_external_config_with_implicit_externals</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span>
        <span class="n">spec_info</span> <span class="o">=</span> <span class="n">packages_yaml</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">pkg</span><span class="p">][</span><span class="s2">&quot;externals&quot;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">external_path</span> <span class="o">=</span> <span class="n">spec_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">external_modules</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">_format_module_list</span><span class="p">(</span>
            <span class="n">spec_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">extra_attributes</span> <span class="o">=</span> <span class="n">spec_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extra_attributes&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># If this is an extension, update the dependencies to include the extendee</span>
        <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">package_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
        <span class="n">extendee_spec</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">extendee_spec</span>

        <span class="k">if</span> <span class="n">extendee_spec</span><span class="p">:</span>
            <span class="n">extendee_node</span> <span class="o">=</span> <span class="n">SpecBuilder</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">extendee_spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">package</span><span class="o">.</span><span class="n">update_external_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extendee_node</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpecBuilder.depends_on">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.depends_on">[docs]</a>
    <span class="k">def</span> <span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">,</span> <span class="n">dependency_node</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">dependency_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">dependency_node</span><span class="p">]</span>
        <span class="n">depflag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">flag_from_string</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">parent_node</span><span class="p">]</span><span class="o">.</span><span class="n">add_dependency_edge</span><span class="p">(</span><span class="n">dependency_spec</span><span class="p">,</span> <span class="n">depflag</span><span class="o">=</span><span class="n">depflag</span><span class="p">,</span> <span class="n">virtuals</span><span class="o">=</span><span class="p">())</span></div>


<div class="viewcode-block" id="SpecBuilder.virtual_on_edge">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.virtual_on_edge">[docs]</a>
    <span class="k">def</span> <span class="nf">virtual_on_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">,</span> <span class="n">provider_node</span><span class="p">,</span> <span class="n">virtual</span><span class="p">):</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">parent_node</span><span class="p">]</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">provider_node</span><span class="o">.</span><span class="n">pkg</span><span class="p">))</span>
        <span class="n">provider_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">provider_node</span><span class="p">]</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dependencies</span> <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">provider_spec</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">virtual</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">provider_node</span><span class="o">.</span><span class="n">pkg</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update_virtuals</span><span class="p">((</span><span class="n">virtual</span><span class="p">,))</span></div>


<div class="viewcode-block" id="SpecBuilder.reorder_flags">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.reorder_flags">[docs]</a>
    <span class="k">def</span> <span class="nf">reorder_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each spec, determine the order of compiler flags applied to it.</span>

<span class="sd">        The solver determines which flags are on nodes; this routine</span>
<span class="sd">        imposes order afterwards. The order is:</span>

<span class="sd">        1. Flags applied in compiler definitions should come first</span>
<span class="sd">        2. Flags applied by dependents are ordered topologically (with a</span>
<span class="sd">           dependency on `traverse` to resolve the partial order into a</span>
<span class="sd">           stable total order)</span>
<span class="sd">        3. Flags from requirements are then applied (requirements always</span>
<span class="sd">           come from the package and never a parent)</span>
<span class="sd">        4. Command-line flags should come last</span>

<span class="sd">        Additionally, for each source (requirements, compiler, command line, and</span>
<span class="sd">        dependents), flags from that source should retain their order and grouping:</span>
<span class="sd">        e.g. for `y cflags=&quot;-z -a&quot;` &quot;-z&quot; and &quot;-a&quot; should never have any intervening</span>
<span class="sd">        flags inserted, and should always appear in that order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reverse compilers so we get highest priority compilers that share a spec</span>
        <span class="n">compilers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">all_compilers_from</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">cmd_specs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_line_specs</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># if bootstrapping, compiler is not in config and has no flags</span>
            <span class="n">flagmap_from_compiler</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span> <span class="ow">in</span> <span class="n">compilers</span><span class="p">:</span>
                <span class="n">flagmap_from_compiler</span> <span class="o">=</span> <span class="n">compilers</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span>

            <span class="k">for</span> <span class="n">flag_type</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler_flags</span><span class="o">.</span><span class="n">valid_compiler_flags</span><span class="p">():</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">SpecBuilder</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="n">ordered_flags</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># 1. Put compiler flags first</span>
                <span class="n">from_compiler</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">flagmap_from_compiler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_type</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="n">extend_flag_list</span><span class="p">(</span><span class="n">ordered_flags</span><span class="p">,</span> <span class="n">from_compiler</span><span class="p">)</span>

                <span class="c1"># 2. Add all sources (the compiler is one of them, so skip any</span>
                <span class="c1"># flag group that matches it exactly)</span>
                <span class="n">flag_groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">compiler_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_type</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">flag_groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">CompilerFlag</span><span class="p">(</span>
                            <span class="n">flag</span><span class="o">.</span><span class="n">flag_group</span><span class="p">,</span>
                            <span class="n">propagate</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">propagate</span><span class="p">,</span>
                            <span class="n">flag_group</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">flag_group</span><span class="p">,</span>
                            <span class="n">source</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># For flags that are applied by dependents, put flags from parents</span>
                <span class="c1"># before children; we depend on the stability of traverse() to</span>
                <span class="c1"># achieve a stable flag order for flags introduced in this manner.</span>
                <span class="n">topo_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;parents&quot;</span><span class="p">))</span>
                <span class="n">lex_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">flag_groups</span><span class="p">))</span>

                <span class="k">def</span> <span class="nf">_order_index</span><span class="p">(</span><span class="n">flag_group</span><span class="p">):</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">flag_group</span><span class="o">.</span><span class="n">source</span>
                    <span class="c1"># Note: if &#39;require: ^dependency cflags=...&#39; is ever possible,</span>
                    <span class="c1"># this will topologically sort for require as well</span>
                    <span class="n">type_index</span><span class="p">,</span> <span class="n">pkg_source</span> <span class="o">=</span> <span class="n">ConstraintOrigin</span><span class="o">.</span><span class="n">strip_type_suffix</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pkg_source</span> <span class="ow">in</span> <span class="n">topo_order</span><span class="p">:</span>
                        <span class="n">major_index</span> <span class="o">=</span> <span class="n">topo_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pkg_source</span><span class="p">)</span>
                        <span class="c1"># If for x-&gt;y, x has multiple depends_on declarations that</span>
                        <span class="c1"># are activated, and each adds cflags to y, we fall back on</span>
                        <span class="c1"># alphabetical ordering to maintain a total order</span>
                        <span class="n">minor_index</span> <span class="o">=</span> <span class="n">lex_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flag_group</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">major_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">topo_order</span><span class="p">)</span> <span class="o">+</span> <span class="n">lex_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flag_group</span><span class="p">)</span>
                        <span class="n">minor_index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">type_index</span><span class="p">,</span> <span class="n">major_index</span><span class="p">,</span> <span class="n">minor_index</span><span class="p">)</span>

                <span class="n">prioritized_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">flag_groups</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_order_index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">prioritized_groups</span><span class="p">:</span>
                    <span class="n">grp_flags</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                        <span class="n">x</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">tokenize_flags</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">flag_group</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">grp_flags</span> <span class="o">==</span> <span class="n">from_compiler</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">as_compiler_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">CompilerFlag</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">propagate</span><span class="o">=</span><span class="n">grp</span><span class="o">.</span><span class="n">propagate</span><span class="p">,</span>
                            <span class="n">flag_group</span><span class="o">=</span><span class="n">grp</span><span class="o">.</span><span class="n">flag_group</span><span class="p">,</span>
                            <span class="n">source</span><span class="o">=</span><span class="n">grp</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grp_flags</span>
                    <span class="p">)</span>
                    <span class="n">extend_flag_list</span><span class="p">(</span><span class="n">ordered_flags</span><span class="p">,</span> <span class="n">as_compiler_flags</span><span class="p">)</span>

                <span class="c1"># 3. Now put cmd-line flags last</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">pkg</span> <span class="ow">in</span> <span class="n">cmd_specs</span><span class="p">:</span>
                    <span class="n">cmd_flags</span> <span class="o">=</span> <span class="n">cmd_specs</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">pkg</span><span class="p">]</span><span class="o">.</span><span class="n">compiler_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_type</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">extend_flag_list</span><span class="p">(</span><span class="n">ordered_flags</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">)</span>

                <span class="n">compiler_flags</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_type</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not equal </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">compiler_flags</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">ordered_flags</span><span class="p">))</span>
                <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">compiler_flags</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">ordered_flags</span><span class="p">),</span> <span class="n">msg</span>

                <span class="n">spec</span><span class="o">.</span><span class="n">compiler_flags</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">flag_type</span><span class="p">:</span> <span class="n">ordered_flags</span><span class="p">})</span></div>


<div class="viewcode-block" id="SpecBuilder.deprecated">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.deprecated">[docs]</a>
    <span class="k">def</span> <span class="nf">deprecated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">NodeArgument</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;using &quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">pkg</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">&quot; which is a deprecated version&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpecBuilder.splice_at_hash">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.splice_at_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">splice_at_hash</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parent_node</span><span class="p">:</span> <span class="n">NodeArgument</span><span class="p">,</span>
        <span class="n">splice_node</span><span class="p">:</span> <span class="n">NodeArgument</span><span class="p">,</span>
        <span class="n">child_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">child_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">splice</span> <span class="o">=</span> <span class="n">Splice</span><span class="p">(</span><span class="n">splice_node</span><span class="p">,</span> <span class="n">child_name</span><span class="o">=</span><span class="n">child_name</span><span class="p">,</span> <span class="n">child_hash</span><span class="o">=</span><span class="n">child_hash</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splices</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">parent_node</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splice</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_resolve_automatic_splices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;After all of the specs have been concretized, apply all immediate splices.</span>

<span class="sd">        Use reverse topological order to ensure that all dependencies are resolved</span>
<span class="sd">        before their parents, allowing for maximal sharing and minimal copying.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fixed_specs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># create a mapping from dag hash to an integer representing position in reverse topo order.</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">topo_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traverse</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;topo&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">traverse</span><span class="o">.</span><span class="n">by_dag_hash</span><span class="p">))</span>
        <span class="n">topo_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">():</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">topo_order</span><span class="p">))}</span>

        <span class="c1"># iterate over specs, children before parents</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">topo_lookup</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]):</span>
            <span class="n">immediate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">immediate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">edge</span><span class="o">.</span><span class="n">spec</span> <span class="ow">in</span> <span class="n">fixed_specs</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">new_spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">build_spec</span> <span class="o">=</span> <span class="n">spec</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">():</span>
                <span class="n">depflag</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">depflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="o">==</span> <span class="n">splice</span><span class="o">.</span><span class="n">child_hash</span> <span class="k">for</span> <span class="n">splice</span> <span class="ow">in</span> <span class="n">immediate</span><span class="p">):</span>
                    <span class="n">splice</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">immediate</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">child_hash</span> <span class="o">==</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_spec</span><span class="o">.</span><span class="n">add_dependency_edge</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">splice</span><span class="o">.</span><span class="n">splice_node</span><span class="p">],</span> <span class="n">depflag</span><span class="o">=</span><span class="n">depflag</span><span class="p">,</span> <span class="n">virtuals</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">virtuals</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span> <span class="ow">in</span> <span class="n">fixed_specs</span><span class="p">:</span>
                    <span class="n">new_spec</span><span class="o">.</span><span class="n">add_dependency_edge</span><span class="p">(</span>
                        <span class="n">fixed_specs</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="p">],</span> <span class="n">depflag</span><span class="o">=</span><span class="n">depflag</span><span class="p">,</span> <span class="n">virtuals</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">virtuals</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_spec</span><span class="o">.</span><span class="n">add_dependency_edge</span><span class="p">(</span>
                        <span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">depflag</span><span class="o">=</span><span class="n">depflag</span><span class="p">,</span> <span class="n">virtuals</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">virtuals</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_spec</span>
            <span class="n">fixed_specs</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_spec</span>

<div class="viewcode-block" id="SpecBuilder.sort_fn">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.sort_fn">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sort_fn</span><span class="p">(</span><span class="n">function_tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure attributes are evaluated in the correct order.</span>

<span class="sd">        hash attributes are handled first, since they imply entire concrete specs</span>
<span class="sd">        node attributes are handled next, since they instantiate nodes</span>
<span class="sd">        external_spec_selected attributes are handled last, so that external extensions can find</span>
<span class="sd">        the concrete specs on which they depend because all nodes are fully constructed before we</span>
<span class="sd">        consider which ones are external.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">function_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;hash&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;node_flag&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;external_spec_selected&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># note out of order so this goes last</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;virtual_on_edge&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpecBuilder.build_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.build_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">build_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_tuples</span><span class="p">):</span>
        <span class="c1"># Functions don&#39;t seem to be in particular order in output.  Sort</span>
        <span class="c1"># them here so that directives that build objects (like node and</span>
        <span class="c1"># node_compiler) are called in the right order.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_tuples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">function_tuples</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_tuples</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">SpecBuilder</span><span class="o">.</span><span class="n">ignored_attributes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">action</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># print out unknown actions so we can display them for debugging</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;UNKNOWN SYMBOL: attr(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Internal Error: Uncallable action found in asp.py.  Please report to the spack&quot;</span>
                <span class="s2">&quot; maintainers.&quot;</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">action</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">action</span><span class="p">),</span> <span class="n">msg</span>

            <span class="c1"># ignore predicates on virtual packages, as they&#39;re used for</span>
            <span class="c1"># solving but don&#39;t construct anything. Do not ignore error</span>
            <span class="c1"># predicates on virtual packages.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pkg</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pkg</span>
                <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># if we&#39;ve already gotten a concrete spec for this pkg,</span>
                <span class="c1"># do not bother calling actions on it except for node_flag_source,</span>
                <span class="c1"># since node_flag_source is tracking information not in the spec itself</span>
                <span class="c1"># we also need to keep track of splicing information.</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">spec</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                    <span class="n">do_not_ignore_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;node_flag_source&quot;</span><span class="p">,</span> <span class="s2">&quot;splice_at_hash&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">do_not_ignore_attrs</span><span class="p">:</span>
                        <span class="k">continue</span>

            <span class="n">action</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># fix flags after all specs are constructed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reorder_flags</span><span class="p">()</span>

        <span class="c1"># inject patches -- note that we&#39; can&#39;t use set() to unique the</span>
        <span class="c1"># roots here, because the specs aren&#39;t complete, and the hash</span>
        <span class="c1"># function will loop forever.</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">root</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">id</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">roots</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">inject_patches_variant</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

        <span class="c1"># Add external paths to specs with just external modules</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">ensure_external_path_if_external</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_develop_specs_from_env</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">active_environment</span><span class="p">())</span>

        <span class="c1"># mark concrete and assign hashes to all specs in the solve</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">roots</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">root</span><span class="o">.</span><span class="n">_finalize_concretization</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_automatic_splices</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">ensure_no_deprecated</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Add git version lookup info to concrete Specs (this is generated for</span>
        <span class="c1"># abstract specs as well but the Versions may be replaced during the</span>
        <span class="c1"># concretization process)</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">traverse</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">vn</span><span class="o">.</span><span class="n">GitVersion</span><span class="p">):</span>
                    <span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">attach_lookup</span><span class="p">(</span>
                        <span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">git_ref_lookup</span><span class="o">.</span><span class="n">GitRefLookup</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_explicit_splices</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">specs</span></div>


<div class="viewcode-block" id="SpecBuilder.execute_explicit_splices">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecBuilder.execute_explicit_splices">[docs]</a>
    <span class="k">def</span> <span class="nf">execute_explicit_splices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">splice_config</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer:splice:explicit&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">splice_triples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">splice_set</span> <span class="ow">in</span> <span class="n">splice_config</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">splice_set</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
            <span class="n">replacement</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">splice_set</span><span class="p">[</span><span class="s2">&quot;replacement&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">replacement</span><span class="o">.</span><span class="n">abstract_hash</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">splice_set</span><span class="p">[</span><span class="s2">&quot;replacement&quot;</span><span class="p">],</span> <span class="s2">&quot;_start_mark&quot;</span><span class="p">,</span> <span class="s2">&quot; at unknown line number&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Explicit splice replacement &#39;</span><span class="si">{</span><span class="n">replacement</span><span class="si">}</span><span class="s2">&#39; does not include a hash.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    Splice replacements must be specified by hash&quot;</span>
                <span class="k">raise</span> <span class="n">InvalidSpliceError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">transitive</span> <span class="o">=</span> <span class="n">splice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transitive&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">splice_triples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">target</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">transitive</span><span class="p">))</span>

        <span class="n">specs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current_spec</span> <span class="o">=</span> <span class="n">spec</span>
            <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">transitive</span> <span class="ow">in</span> <span class="n">splice_triples</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">current_spec</span><span class="p">:</span>
                    <span class="c1"># matches root or non-root</span>
                    <span class="c1"># e.g. mvapich2%gcc</span>

                    <span class="c1"># The first iteration, we need to replace the abstract hash</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">replacement</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                        <span class="n">replacement</span><span class="o">.</span><span class="n">replace_hash</span><span class="p">()</span>
                    <span class="n">current_spec</span> <span class="o">=</span> <span class="n">current_spec</span><span class="o">.</span><span class="n">splice</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">transitive</span><span class="p">)</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">NodeArgument</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">current_spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">specs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_spec</span>

        <span class="k">return</span> <span class="n">specs</span></div>
</div>



<span class="k">def</span> <span class="nf">_develop_specs_from_env</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="n">dev_info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dev_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">env</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dev_info</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">canonicalize_path</span><span class="p">(</span><span class="n">dev_info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="n">default_wd</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;dev_path&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Internal Error: The dev_path for spec </span><span class="si">{name}</span><span class="s2"> is not connected to a valid environment&quot;</span>
            <span class="s2">&quot;path. Please note that develop specs can only be used inside an environment&quot;</span>
            <span class="s2">&quot;These paths should be the same:</span><span class="se">\n\t</span><span class="s2">dev_path:</span><span class="si">{dev_path}</span><span class="se">\n\t</span><span class="s2">env_based_path:</span><span class="si">{env_path}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_path</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">[</span><span class="s2">&quot;dev_path&quot;</span><span class="p">],</span> <span class="n">env_path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">[</span><span class="s2">&quot;dev_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">path</span><span class="p">,</span> <span class="n">error_msg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;dev_path&quot;</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">SingleValuedVariant</span><span class="p">(</span><span class="s2">&quot;dev_path&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">dev_info</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_is_reusable</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">local</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A spec is reusable if it&#39;s not a dev spec, it&#39;s imported from the cray manifest, it&#39;s not</span>
<span class="sd">    external, or it&#39;s external with matching packages.yaml entry. The latter prevents two issues:</span>

<span class="sd">    1. Externals in build caches: avoid installing an external on the build machine not</span>
<span class="sd">       available on the target machine</span>
<span class="sd">    2. Local externals: avoid reusing an external if the local config changes. This helps in</span>
<span class="sd">       particular when a user removes an external from packages.yaml, and expects that that</span>
<span class="sd">       takes effect immediately.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        spec: the spec to check</span>
<span class="sd">        packages: the packages configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;dev_path&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_has_runtime_dependencies</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="c1"># Cray external manifest externals are always reusable</span>
    <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;external-db&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">provided</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="o">.</span><span class="n">provided_virtual_names</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">RepoError</span><span class="p">:</span>
        <span class="n">provided</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">provided</span><span class="p">}:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">packages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;externals&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span>
                <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">external_path</span> <span class="o">==</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">external_modules</span> <span class="o">==</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modules&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_has_runtime_dependencies</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">WITH_RUNTIME</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;gcc&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="s2">&quot;gcc-runtime&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;oneapi&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="s2">&quot;intel-oneapi-runtime&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="SpecFilter">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecFilter">[docs]</a>
<span class="k">class</span> <span class="nc">SpecFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a method to produce a list of specs, this class can filter them according to</span>
<span class="sd">    different criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]],</span>
        <span class="n">is_usable</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">include</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            factory: factory to produce a list of specs</span>
<span class="sd">            is_usable: predicate that takes a spec in input and returns False if the spec</span>
<span class="sd">                should not be considered for this filter, True otherwise.</span>
<span class="sd">            include: if present, a &quot;good&quot; spec must match at least one entry in the list</span>
<span class="sd">            exclude: if present, a &quot;good&quot; spec must not match any entry in the list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_usable</span> <span class="o">=</span> <span class="n">is_usable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span>

<div class="viewcode-block" id="SpecFilter.is_selected">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecFilter.is_selected">[docs]</a>
    <span class="k">def</span> <span class="nf">is_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_usable</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">include</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SpecFilter.selected_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecFilter.selected_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">selected_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_selected</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span></div>


<div class="viewcode-block" id="SpecFilter.from_store">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecFilter.from_store">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_store</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SpecFilter&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs a filter that takes the specs from the current store.&quot;&quot;&quot;</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">_external_config_with_implicit_externals</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">is_reusable</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_is_reusable</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_specs_from_store</span><span class="p">,</span> <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpecFilter</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">factory</span><span class="p">,</span> <span class="n">is_usable</span><span class="o">=</span><span class="n">is_reusable</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpecFilter.from_buildcache">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecFilter.from_buildcache">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_buildcache</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SpecFilter&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs a filter that takes the specs from the configured buildcaches.&quot;&quot;&quot;</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">_external_config_with_implicit_externals</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">is_reusable</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_is_reusable</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpecFilter</span><span class="p">(</span>
            <span class="n">factory</span><span class="o">=</span><span class="n">_specs_from_mirror</span><span class="p">,</span> <span class="n">is_usable</span><span class="o">=</span><span class="n">is_reusable</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SpecFilter.from_environment">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecFilter.from_environment">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_environment</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SpecFilter&quot;</span><span class="p">:</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">_external_config_with_implicit_externals</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">is_reusable</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_is_reusable</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_specs_from_environment</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpecFilter</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">factory</span><span class="p">,</span> <span class="n">is_usable</span><span class="o">=</span><span class="n">is_reusable</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpecFilter.from_environment_included_concrete">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SpecFilter.from_environment_included_concrete">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_environment_included_concrete</span><span class="p">(</span>
        <span class="n">configuration</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">Environment</span><span class="p">,</span>
        <span class="n">included_concrete</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SpecFilter&quot;</span><span class="p">:</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">_external_config_with_implicit_externals</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">is_reusable</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_is_reusable</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">_specs_from_environment_included_concrete</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">included_concrete</span><span class="o">=</span><span class="n">included_concrete</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">SpecFilter</span><span class="p">(</span><span class="n">factory</span><span class="o">=</span><span class="n">factory</span><span class="p">,</span> <span class="n">is_usable</span><span class="o">=</span><span class="n">is_reusable</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span></div>
</div>



<span class="k">def</span> <span class="nf">_specs_from_store</span><span class="p">(</span><span class="n">configuration</span><span class="p">):</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">store</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">installed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_specs_from_mirror</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">binary_distribution</span><span class="o">.</span><span class="n">update_cache_and_get_specs</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">binary_distribution</span><span class="o">.</span><span class="n">FetchCacheError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="c1"># this is raised when no mirrors had indices.</span>
        <span class="c1"># TODO: update mirror configuration so it can indicate that the</span>
        <span class="c1"># TODO: source cache (or any mirror really) doesn&#39;t have binaries.</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">_specs_from_environment</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return all concrete specs from the environment. This includes all included concrete&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">concrete</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">concrete</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">concretized_specs</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">_specs_from_environment_included_concrete</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">included_concrete</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return only concrete specs from the environment included from the included_concrete&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">included_concrete</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">included_concrete_envs</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">concrete</span> <span class="k">for</span> <span class="n">concrete</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">included_specs_by_hash</span><span class="p">[</span><span class="n">included_concrete</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>


<div class="viewcode-block" id="ReuseStrategy">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ReuseStrategy">[docs]</a>
<span class="k">class</span> <span class="nc">ReuseStrategy</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">ROOTS</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">DEPENDENCIES</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>



<div class="viewcode-block" id="ReusableSpecsSelector">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ReusableSpecsSelector">[docs]</a>
<span class="k">class</span> <span class="nc">ReusableSpecsSelector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Selects specs that can be reused during concretization.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reuse_strategy</span> <span class="o">=</span> <span class="n">ReuseStrategy</span><span class="o">.</span><span class="n">ROOTS</span>

        <span class="n">reuse_yaml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concretizer:reuse&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reuse_yaml</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reuse_yaml</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuse_strategy</span> <span class="o">=</span> <span class="n">ReuseStrategy</span><span class="o">.</span><span class="n">NONE</span>
            <span class="k">if</span> <span class="n">reuse_yaml</span> <span class="o">==</span> <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuse_strategy</span> <span class="o">=</span> <span class="n">ReuseStrategy</span><span class="o">.</span><span class="n">DEPENDENCIES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_store</span><span class="p">(</span>
                        <span class="n">configuration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[],</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]</span>
                    <span class="p">),</span>
                    <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_buildcache</span><span class="p">(</span>
                        <span class="n">configuration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[],</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]</span>
                    <span class="p">),</span>
                    <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_environment</span><span class="p">(</span>
                        <span class="n">configuration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span>
                        <span class="n">include</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">active_environment</span><span class="p">(),</span>  <span class="c1"># includes all concrete includes</span>
                    <span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="n">reuse_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roots&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">roots</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuse_strategy</span> <span class="o">=</span> <span class="n">ReuseStrategy</span><span class="o">.</span><span class="n">ROOTS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuse_strategy</span> <span class="o">=</span> <span class="n">ReuseStrategy</span><span class="o">.</span><span class="n">DEPENDENCIES</span>
            <span class="n">default_include</span> <span class="o">=</span> <span class="n">reuse_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">default_exclude</span> <span class="o">=</span> <span class="n">reuse_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">default_sources</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;local&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;buildcache&quot;</span><span class="p">}]</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">reuse_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="n">default_sources</span><span class="p">):</span>
                <span class="n">include</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="n">default_include</span><span class="p">)</span>
                <span class="n">exclude</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="n">default_exclude</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;environment&quot;</span> <span class="ow">and</span> <span class="s2">&quot;path&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">env_dir</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">as_env_dir</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                    <span class="n">active_env</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">active_environment</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">active_env</span> <span class="ow">and</span> <span class="n">env_dir</span> <span class="ow">in</span> <span class="n">active_env</span><span class="o">.</span><span class="n">included_concrete_envs</span><span class="p">:</span>
                        <span class="c1"># If environment is included as a concrete environment, use the local copy</span>
                        <span class="c1"># of specs in the active environment.</span>
                        <span class="c1"># note: included concrete environments are only updated at concretization</span>
                        <span class="c1">#       time, and reuse needs to matchthe included specs.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_environment_included_concrete</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span>
                                <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span>
                                <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
                                <span class="n">env</span><span class="o">=</span><span class="n">active_env</span><span class="p">,</span>
                                <span class="n">included_concrete</span><span class="o">=</span><span class="n">env_dir</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If the environment is not included as a concrete environment, use the</span>
                        <span class="c1"># current specs from its lockfile.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_environment</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span>
                                <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span>
                                <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
                                <span class="n">env</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">environment_from_name_or_dir</span><span class="p">(</span><span class="n">env_dir</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;environment&quot;</span><span class="p">:</span>
                    <span class="c1"># reusing from the current environment implicitly reuses from all of the</span>
                    <span class="c1"># included concrete environments</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_environment</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span>
                            <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span>
                            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
                            <span class="n">env</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">active_environment</span><span class="p">(),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;buildcache&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">SpecFilter</span><span class="o">.</span><span class="n">from_buildcache</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="ReusableSpecsSelector.reusable_specs">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.ReusableSpecsSelector.reusable_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">reusable_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuse_strategy</span> <span class="o">==</span> <span class="n">ReuseStrategy</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reuse_source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuse_sources</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reuse_source</span><span class="o">.</span><span class="n">selected_specs</span><span class="p">())</span>
        <span class="c1"># If we only want to reuse dependencies, remove the root specs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuse_strategy</span> <span class="o">==</span> <span class="n">ReuseStrategy</span><span class="o">.</span><span class="n">DEPENDENCIES</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">root</span> <span class="ow">in</span> <span class="n">spec</span> <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">result</span></div>
</div>



<div class="viewcode-block" id="Solver">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Solver">[docs]</a>
<span class="k">class</span> <span class="nc">Solver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the main external interface class for solving.</span>

<span class="sd">    It manages solver configuration and preferences in one place. It sets up the solve</span>
<span class="sd">    and passes the setup method to the driver, as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">PyclingoDriver</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">ReusableSpecsSelector</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_input_and_extract_concrete_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">reusable</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">traverse</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">virtual</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                    <span class="n">reusable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">ensure_valid_variants</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reusable</span>

<div class="viewcode-block" id="Solver.solve_with_stats">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Solver.solve_with_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">solve_with_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">specs</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">tests</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">setup_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allow_deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concretize a set of specs and track the timing and statistics for the solve</span>

<span class="sd">        Arguments:</span>
<span class="sd">          specs (list): List of ``Spec`` objects to solve for.</span>
<span class="sd">          out: Optionally write the generate ASP program to a file-like object.</span>
<span class="sd">          timers (bool): Print out coarse timers for different solve phases.</span>
<span class="sd">          stats (bool): Print out detailed stats from clingo.</span>
<span class="sd">          tests (bool or tuple): If True, concretize test dependencies for all packages.</span>
<span class="sd">            If a tuple of package names, concretize test dependencies for named</span>
<span class="sd">            packages (defaults to False: do not concretize test dependencies).</span>
<span class="sd">          setup_only (bool): if True, stop after setup and don&#39;t solve (default False).</span>
<span class="sd">          allow_deprecated (bool): allow deprecated version in the solve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lookup_hash</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
        <span class="n">reusable_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_and_extract_concrete_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
        <span class="n">reusable_specs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">reusable_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>
        <span class="n">setup</span> <span class="o">=</span> <span class="n">SpackSolverSetup</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">OutputConfiguration</span><span class="p">(</span><span class="n">timers</span><span class="o">=</span><span class="n">timers</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">setup_only</span><span class="o">=</span><span class="n">setup_only</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
            <span class="n">setup</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reusable_specs</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="o">=</span><span class="n">allow_deprecated</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Solver.solve">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Solver.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function for concretizing a set of specs and ignoring timing</span>
<span class="sd">        and statistics. Uses the same kwargs as solve_with_stats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check upfront that the variants are admissible</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_with_stats</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Solver.solve_in_rounds">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.Solver.solve_in_rounds">[docs]</a>
    <span class="k">def</span> <span class="nf">solve_in_rounds</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_deprecated</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve for a stable model of specs in multiple rounds.</span>

<span class="sd">        This relaxes the assumption of solve that everything must be consistent and</span>
<span class="sd">        solvable in a single round. Each round tries to maximize the reuse of specs</span>
<span class="sd">        from previous rounds.</span>

<span class="sd">        The function is a generator that yields the result of each round.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            specs (list): list of Specs to solve.</span>
<span class="sd">            out: Optionally write the generate ASP program to a file-like object.</span>
<span class="sd">            timers (bool): print timing if set to True</span>
<span class="sd">            stats (bool): print internal statistics if set to True</span>
<span class="sd">            tests (bool): add test dependencies to the solve</span>
<span class="sd">            allow_deprecated (bool): allow deprecated version in the solve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lookup_hash</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
        <span class="n">reusable_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_and_extract_concrete_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
        <span class="n">reusable_specs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">reusable_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">))</span>
        <span class="n">setup</span> <span class="o">=</span> <span class="n">SpackSolverSetup</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">)</span>

        <span class="c1"># Tell clingo that we don&#39;t have to solve all the inputs at once</span>
        <span class="n">setup</span><span class="o">.</span><span class="n">concretize_everything</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">input_specs</span> <span class="o">=</span> <span class="n">specs</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">OutputConfiguration</span><span class="p">(</span><span class="n">timers</span><span class="o">=</span><span class="n">timers</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">setup_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
                <span class="n">setup</span><span class="p">,</span>
                <span class="n">input_specs</span><span class="p">,</span>
                <span class="n">reuse</span><span class="o">=</span><span class="n">reusable_specs</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                <span class="n">allow_deprecated</span><span class="o">=</span><span class="n">allow_deprecated</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">result</span>

            <span class="c1"># If we don&#39;t have unsolved specs we are done</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">unsolved_specs</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
                <span class="c1"># This is also a problem: no specs were solved for, which</span>
                <span class="c1"># means we would be in a loop if we tried again</span>
                <span class="n">unsolved_str</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="n">format_unsolved</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">unsolved_specs</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InternalConcretizerError</span><span class="p">(</span>
                    <span class="s2">&quot;Internal Spack error: a subset of input specs could not&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; be solved for.</span><span class="se">\n\t</span><span class="si">{</span><span class="n">unsolved_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">input_specs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">unsolved_specs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
                <span class="n">reusable_specs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="UnsatisfiableSpecError">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.UnsatisfiableSpecError">[docs]</a>
<span class="k">class</span> <span class="nc">UnsatisfiableSpecError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">UnsatisfiableSpecError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;There was an issue with the spec that was requested (i.e. a user error).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">UnsatisfiableSpecError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_type</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="InternalConcretizerError">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.InternalConcretizerError">[docs]</a>
<span class="k">class</span> <span class="nc">InternalConcretizerError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">UnsatisfiableSpecError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Errors that indicate a bug in Spack.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">UnsatisfiableSpecError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_type</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="SolverError">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.SolverError">[docs]</a>
<span class="k">class</span> <span class="nc">SolverError</span><span class="p">(</span><span class="n">InternalConcretizerError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For cases where the solver is unable to produce a solution.</span>

<span class="sd">    Such cases are unexpected because we allow for solutions with errors,</span>
<span class="sd">    so for example user specs that are over-constrained should still</span>
<span class="sd">    get a solution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provided</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Spack concretizer internal error. Please submit a bug report and include the &quot;</span>
            <span class="s2">&quot;command, environment if applicable and the following error message.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{</span><span class="n">provided</span><span class="si">}</span><span class="s2"> is unsatisfiable&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;, errors are:&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{</span><span class="n">conflict</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">conflict</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">])</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Add attribute expected of the superclass interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided</span> <span class="o">=</span> <span class="n">provided</span></div>



<div class="viewcode-block" id="InvalidSpliceError">
<a class="viewcode-back" href="../../../spack.solver.html#spack.solver.asp.InvalidSpliceError">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidSpliceError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For cases in which the splice configuration is invalid.&quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>