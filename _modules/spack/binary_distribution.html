

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.binary_distribution &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.binary_distribution</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.binary_distribution</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>

<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">llnl.util.filesystem</span> <span class="k">as</span> <span class="nn">fsys</span>
<span class="kn">import</span> <span class="nn">llnl.util.lang</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>
<span class="kn">from</span> <span class="nn">llnl.util.filesystem</span> <span class="kn">import</span> <span class="n">BaseDirectoryVisitor</span><span class="p">,</span> <span class="n">mkdirp</span><span class="p">,</span> <span class="n">visit_directory_tree</span>
<span class="kn">from</span> <span class="nn">llnl.util.symlink</span> <span class="kn">import</span> <span class="n">readlink</span>

<span class="kn">import</span> <span class="nn">spack.caches</span>
<span class="kn">import</span> <span class="nn">spack.config</span> <span class="k">as</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">spack.database</span> <span class="k">as</span> <span class="nn">spack_db</span>
<span class="kn">import</span> <span class="nn">spack.deptypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.hash_types</span> <span class="k">as</span> <span class="nn">ht</span>
<span class="kn">import</span> <span class="nn">spack.hooks</span>
<span class="kn">import</span> <span class="nn">spack.hooks.sbang</span>
<span class="kn">import</span> <span class="nn">spack.mirror</span>
<span class="kn">import</span> <span class="nn">spack.oci.image</span>
<span class="kn">import</span> <span class="nn">spack.oci.oci</span>
<span class="kn">import</span> <span class="nn">spack.oci.opener</span>
<span class="kn">import</span> <span class="nn">spack.paths</span>
<span class="kn">import</span> <span class="nn">spack.platforms</span>
<span class="kn">import</span> <span class="nn">spack.relocate</span> <span class="k">as</span> <span class="nn">relocate</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.stage</span>
<span class="kn">import</span> <span class="nn">spack.store</span>
<span class="kn">import</span> <span class="nn">spack.user_environment</span>
<span class="kn">import</span> <span class="nn">spack.util.archive</span>
<span class="kn">import</span> <span class="nn">spack.util.crypto</span>
<span class="kn">import</span> <span class="nn">spack.util.file_cache</span> <span class="k">as</span> <span class="nn">file_cache</span>
<span class="kn">import</span> <span class="nn">spack.util.filesystem</span> <span class="k">as</span> <span class="nn">ssys</span>
<span class="kn">import</span> <span class="nn">spack.util.gpg</span>
<span class="kn">import</span> <span class="nn">spack.util.parallel</span>
<span class="kn">import</span> <span class="nn">spack.util.path</span>
<span class="kn">import</span> <span class="nn">spack.util.spack_json</span> <span class="k">as</span> <span class="nn">sjson</span>
<span class="kn">import</span> <span class="nn">spack.util.spack_yaml</span> <span class="k">as</span> <span class="nn">syaml</span>
<span class="kn">import</span> <span class="nn">spack.util.timer</span> <span class="k">as</span> <span class="nn">timer</span>
<span class="kn">import</span> <span class="nn">spack.util.url</span> <span class="k">as</span> <span class="nn">url_util</span>
<span class="kn">import</span> <span class="nn">spack.util.web</span> <span class="k">as</span> <span class="nn">web_util</span>
<span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="n">traverse</span>
<span class="kn">from</span> <span class="nn">spack.caches</span> <span class="kn">import</span> <span class="n">misc_cache_location</span>
<span class="kn">from</span> <span class="nn">spack.oci.image</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Digest</span><span class="p">,</span>
    <span class="n">ImageReference</span><span class="p">,</span>
    <span class="n">default_config</span><span class="p">,</span>
    <span class="n">default_index_tag</span><span class="p">,</span>
    <span class="n">default_manifest</span><span class="p">,</span>
    <span class="n">default_tag</span><span class="p">,</span>
    <span class="n">tag_is_spec</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">spack.oci.oci</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">copy_missing_layers_with_retry</span><span class="p">,</span>
    <span class="n">get_manifest_and_config_with_retry</span><span class="p">,</span>
    <span class="n">list_tags</span><span class="p">,</span>
    <span class="n">upload_blob_with_retry</span><span class="p">,</span>
    <span class="n">upload_manifest_with_retry</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">spack.package_prefs</span> <span class="kn">import</span> <span class="n">get_package_dir_permissions</span><span class="p">,</span> <span class="n">get_package_group</span>
<span class="kn">from</span> <span class="nn">spack.relocate_text</span> <span class="kn">import</span> <span class="n">utf8_paths_to_single_binary_regex</span>
<span class="kn">from</span> <span class="nn">spack.spec</span> <span class="kn">import</span> <span class="n">Spec</span>
<span class="kn">from</span> <span class="nn">spack.stage</span> <span class="kn">import</span> <span class="n">Stage</span>
<span class="kn">from</span> <span class="nn">spack.util.executable</span> <span class="kn">import</span> <span class="n">which</span>

<span class="n">BUILD_CACHE_RELATIVE_PATH</span> <span class="o">=</span> <span class="s2">&quot;build_cache&quot;</span>
<span class="n">BUILD_CACHE_KEYS_RELATIVE_PATH</span> <span class="o">=</span> <span class="s2">&quot;_pgp&quot;</span>

<span class="c1">#: The build cache layout version that this version of Spack creates.</span>
<span class="c1">#: Version 2: includes parent directories of the package prefix in the tarball</span>
<span class="n">CURRENT_BUILD_CACHE_LAYOUT_VERSION</span> <span class="o">=</span> <span class="mi">2</span>


<div class="viewcode-block" id="BuildCacheDatabase">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildCacheDatabase">[docs]</a>
<span class="k">class</span> <span class="nc">BuildCacheDatabase</span><span class="p">(</span><span class="n">spack_db</span><span class="o">.</span><span class="n">Database</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A database for binary buildcaches.</span>

<span class="sd">    A database supports writing buildcache index files, in which case certain fields are not</span>
<span class="sd">    needed in each install record, and no locking is required. To use this feature, it provides</span>
<span class="sd">    ``lock_cfg=NO_LOCK``, and override the list of ``record_fields``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">record_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">,</span> <span class="s2">&quot;ref_count&quot;</span><span class="p">,</span> <span class="s2">&quot;in_buildcache&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">lock_cfg</span><span class="o">=</span><span class="n">spack_db</span><span class="o">.</span><span class="n">NO_LOCK</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_transaction_impl</span> <span class="o">=</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">nullcontext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_transaction_impl</span> <span class="o">=</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">nullcontext</span></div>



<div class="viewcode-block" id="FetchCacheError">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.FetchCacheError">[docs]</a>
<span class="k">class</span> <span class="nc">FetchCacheError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error thrown when fetching the cache failed, usually a composite error list.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected a list of errors&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;        Error </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{2}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Multiple errors during fetching:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>



<div class="viewcode-block" id="BinaryCacheIndex">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex">[docs]</a>
<span class="k">class</span> <span class="nc">BinaryCacheIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The BinaryCacheIndex tracks what specs are available on (usually remote)</span>
<span class="sd">    binary caches.</span>

<span class="sd">    This index is &quot;best effort&quot;, in the sense that whenever we don&#39;t find</span>
<span class="sd">    what we&#39;re looking for here, we will attempt to fetch it directly from</span>
<span class="sd">    configured mirrors anyway.  Thus, it has the potential to speed things</span>
<span class="sd">    up, but cache misses shouldn&#39;t break any spack functionality.</span>

<span class="sd">    At the moment, everything in this class is initialized as lazily as</span>
<span class="sd">    possible, so that it avoids slowing anything in spack down until</span>
<span class="sd">    absolutely necessary.</span>

<span class="sd">    TODO: What&#39;s the cost if, e.g., we realize in the middle of a spack</span>
<span class="sd">    install that the cache is out of date, and we fetch directly?  Does it</span>
<span class="sd">    mean we should have paid the price to update the cache earlier?</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_cache_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">cache_root</span> <span class="ow">or</span> <span class="n">binary_index_location</span><span class="p">()</span>

        <span class="c1"># the key associated with the serialized _local_index_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_contents_key</span> <span class="o">=</span> <span class="s2">&quot;contents.json&quot;</span>

        <span class="c1"># a FileCache instance storing copies of remote binary cache indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">file_cache</span><span class="o">.</span><span class="n">FileCache</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># stores a map of mirror URL to index hash and cache key (index path)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># hashes of remote indices already ingested into the concrete spec</span>
        <span class="c1"># cache (_mirrors_for_spec)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs_already_associated</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># mapping from mirror urls to the time.time() of the last index fetch and a bool indicating</span>
        <span class="c1"># whether the fetch succeeded or not.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># _mirrors_for_spec is a dictionary mapping DAG hashes to lists of</span>
        <span class="c1"># entries indicating mirrors where that concrete spec can be found.</span>
        <span class="c1"># Each entry is a dictionary consisting of:</span>
        <span class="c1">#</span>
        <span class="c1">#     - the mirror where the spec is, keyed by ``mirror_url``</span>
        <span class="c1">#     - the concrete spec itself, keyed by ``spec`` (including the</span>
        <span class="c1">#           full hash, since the dag hash may match but we want to</span>
        <span class="c1">#           use the updated source if available)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_init_local_index_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span> <span class="o">=</span> <span class="n">file_cache</span><span class="o">.</span><span class="n">FileCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_cache_root</span><span class="p">)</span>

            <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_contents_key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">init_entry</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

            <span class="n">cache_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">cache_path</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cache_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span> <span class="k">as</span> <span class="n">cache_file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cache_file</span><span class="p">)</span>

<div class="viewcode-block" id="BinaryCacheIndex.clear">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For testing purposes we need to be able to empty the cache and</span>
<span class="sd">        clear associated data structures.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs_already_associated</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span> <span class="o">=</span> <span class="p">{}</span></div>


    <span class="k">def</span> <span class="nf">_write_local_index_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_local_index_cache</span><span class="p">()</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_contents_key</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">write_transaction</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

<div class="viewcode-block" id="BinaryCacheIndex.regenerate_spec_cache">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex.regenerate_spec_cache">[docs]</a>
    <span class="k">def</span> <span class="nf">regenerate_spec_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate the local cache of concrete specs (``_mirrors_for_spec``)</span>
<span class="sd">        from the locally cached buildcache index files.  This is essentially a</span>
<span class="sd">        no-op if it has already been done, as we keep track of the index</span>
<span class="sd">        hashes for which we have already associated the built specs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_local_index_cache</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clear_existing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_specs_already_associated</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">mirror_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">:</span>
            <span class="n">cache_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">[</span><span class="n">mirror_url</span><span class="p">]</span>
            <span class="n">cached_index_path</span> <span class="o">=</span> <span class="n">cache_entry</span><span class="p">[</span><span class="s2">&quot;index_path&quot;</span><span class="p">]</span>
            <span class="n">cached_index_hash</span> <span class="o">=</span> <span class="n">cache_entry</span><span class="p">[</span><span class="s2">&quot;index_hash&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cached_index_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specs_already_associated</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_associate_built_specs_with_mirror</span><span class="p">(</span><span class="n">cached_index_path</span><span class="p">,</span> <span class="n">mirror_url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_specs_already_associated</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cached_index_hash</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_associate_built_specs_with_mirror</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">mirror_url</span><span class="p">):</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">BuildCacheDatabase</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">init_entry</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="n">cache_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">cache_path</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">_read_from_file</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">spack_db</span><span class="o">.</span><span class="n">InvalidDatabaseVersionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;you need a newer Spack version to read the buildcache index for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;following mirror: &#39;</span><span class="si">{</span><span class="n">mirror_url</span><span class="si">}</span><span class="s2">&#39;. </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">database_version_message</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">spec_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query_local</span><span class="p">(</span><span class="n">installed</span><span class="o">=</span><span class="nb">any</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">external</span> <span class="ow">or</span> <span class="n">db</span><span class="o">.</span><span class="n">query_local_by_spec_hash</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span><span class="o">.</span><span class="n">in_buildcache</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">indexed_spec</span> <span class="ow">in</span> <span class="n">spec_list</span><span class="p">:</span>
                <span class="n">dag_hash</span> <span class="o">=</span> <span class="n">indexed_spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">dag_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">]:</span>
                    <span class="c1"># A binary mirror can only have one spec per DAG hash, so</span>
                    <span class="c1"># if we already have an entry under this DAG hash for this</span>
                    <span class="c1"># mirror url, we&#39;re done.</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mirror_url</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">:</span> <span class="n">mirror_url</span><span class="p">,</span> <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="n">indexed_spec</span><span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="BinaryCacheIndex.get_all_built_specs">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex.get_all_built_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_built_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">spec_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dag_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">:</span>
            <span class="c1"># in the absence of further information, all concrete specs</span>
            <span class="c1"># with the same DAG hash are equivalent, so we can just</span>
            <span class="c1"># return the first one in the list.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">spec_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">spec_list</span></div>


<div class="viewcode-block" id="BinaryCacheIndex.find_built_spec">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex.find_built_spec">[docs]</a>
    <span class="k">def</span> <span class="nf">find_built_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">mirrors_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look in our cache for the built spec corresponding to ``spec``.</span>

<span class="sd">        If the spec can be found among the configured binary mirrors, a</span>
<span class="sd">        list is returned that contains the concrete spec and the mirror url</span>
<span class="sd">        of each mirror where it can be found.  Otherwise, ``None`` is</span>
<span class="sd">        returned.</span>

<span class="sd">        This method does not trigger reading anything from remote mirrors, but</span>
<span class="sd">        rather just checks if the concrete spec is found within the cache.</span>

<span class="sd">        The cache can be updated by calling ``update()`` on the cache.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec (spack.spec.Spec): Concrete spec to find</span>
<span class="sd">            mirrors_to_check: Optional mapping containing mirrors to check.  If</span>
<span class="sd">                None, just assumes all configured mirrors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An list of objects containing the found specs and mirror url where</span>
<span class="sd">                each can be found, e.g.:</span>

<span class="sd">                .. code-block:: python</span>

<span class="sd">                    [</span>
<span class="sd">                        {</span>
<span class="sd">                            &quot;spec&quot;: &lt;concrete-spec&gt;,</span>
<span class="sd">                            &quot;mirror_url&quot;: &lt;mirror-root-url&gt;</span>
<span class="sd">                        }</span>
<span class="sd">                    ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_hash</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">(),</span> <span class="n">mirrors_to_check</span><span class="o">=</span><span class="n">mirrors_to_check</span><span class="p">)</span></div>


<div class="viewcode-block" id="BinaryCacheIndex.find_by_hash">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex.find_by_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">find_by_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">find_hash</span><span class="p">,</span> <span class="n">mirrors_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Same as find_built_spec but uses the hash of a spec.</span>

<span class="sd">        Args:</span>
<span class="sd">            find_hash (str): hash of the spec to search</span>
<span class="sd">            mirrors_to_check: Optional mapping containing mirrors to check.  If</span>
<span class="sd">                None, just assumes all configured mirrors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">find_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">find_hash</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mirrors_to_check</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="n">mirror_urls</span> <span class="o">=</span> <span class="n">mirrors_to_check</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mirror_urls</span><span class="p">]</span></div>


<div class="viewcode-block" id="BinaryCacheIndex.update_spec">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex.update_spec">[docs]</a>
    <span class="k">def</span> <span class="nf">update_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">found_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take list of {&#39;mirror_url&#39;: m, &#39;spec&#39;: s} objects and update the local</span>
<span class="sd">        built_spec_cache</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec_dag_hash</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">spec_dag_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">spec_dag_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">found_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span><span class="p">[</span><span class="n">spec_dag_hash</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">new_entry</span> <span class="ow">in</span> <span class="n">found_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cur_entry</span> <span class="ow">in</span> <span class="n">current_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">new_entry</span><span class="p">[</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_entry</span><span class="p">[</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">]:</span>
                        <span class="n">cur_entry</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_entry</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">:</span> <span class="n">new_entry</span><span class="p">[</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">],</span> <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="n">new_entry</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]}</span>
                    <span class="p">)</span></div>


<div class="viewcode-block" id="BinaryCacheIndex.update">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheIndex.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_cooldown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sure local cache of buildcache index files is up to date.</span>
<span class="sd">        If the same mirrors are configured as the last time this was called</span>
<span class="sd">        and none of the remote buildcache indices have changed, calling this</span>
<span class="sd">        method will only result in fetching the index hash from each mirror</span>
<span class="sd">        to confirm it is the same as what is stored locally.  Otherwise, the</span>
<span class="sd">        buildcache ``index.json`` and ``index.json.hash`` files are retrieved</span>
<span class="sd">        from each configured mirror and stored locally (both in memory and</span>
<span class="sd">        on disk under ``_index_cache_root``).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_local_index_cache</span><span class="p">()</span>
        <span class="n">configured_mirror_urls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span><span class="o">.</span><span class="n">fetch_url</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">items_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spec_cache_clear_needed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">spec_cache_regenerate_needed</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors_for_spec</span>

        <span class="c1"># First compare the mirror urls currently present in the cache to the</span>
        <span class="c1"># configured mirrors.  If we have a cached index for a mirror which is</span>
        <span class="c1"># no longer configured, we should remove it from the cache.  For any</span>
        <span class="c1"># cached indices corresponding to currently configured mirrors, we need</span>
        <span class="c1"># to check if the cache is still good, or needs to be updated.</span>
        <span class="c1"># Finally, if there are configured mirrors for which we don&#39;t have a</span>
        <span class="c1"># cache entry, we need to fetch and cache the indices from those</span>
        <span class="c1"># mirrors.</span>

        <span class="c1"># If, during this process, we find that any mirrors for which we</span>
        <span class="c1"># already have entries have either been removed, or their index</span>
        <span class="c1"># hash has changed, then our concrete spec cache (_mirrors_for_spec)</span>
        <span class="c1"># likely has entries that need to be removed, so we will clear it</span>
        <span class="c1"># and regenerate that data structure.</span>

        <span class="c1"># If, during this process, we find that there are new mirrors for</span>
        <span class="c1"># which do not yet have an entry in our index cache, then we simply</span>
        <span class="c1"># need to regenerate the concrete spec cache, but do not need to</span>
        <span class="c1"># clear it first.</span>

        <span class="c1"># Otherwise the concrete spec cache should not need to be updated at</span>
        <span class="c1"># all.</span>

        <span class="n">fetch_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_methods_failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:binary_index_ttl&quot;</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cached_mirror_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">:</span>
            <span class="n">cache_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">[</span><span class="n">cached_mirror_url</span><span class="p">]</span>
            <span class="n">cached_index_path</span> <span class="o">=</span> <span class="n">cache_entry</span><span class="p">[</span><span class="s2">&quot;index_path&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cached_mirror_url</span> <span class="ow">in</span> <span class="n">configured_mirror_urls</span><span class="p">:</span>
                <span class="c1"># Only do a fetch if the last fetch was longer than TTL ago</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">with_cooldown</span>
                    <span class="ow">and</span> <span class="n">ttl</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">cached_mirror_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span>
                    <span class="ow">and</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">[</span><span class="n">cached_mirror_url</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ttl</span>
                <span class="p">):</span>
                    <span class="c1"># We&#39;re in the cooldown period, don&#39;t try to fetch again</span>
                    <span class="c1"># If the fetch succeeded last time, consider this update a success, otherwise</span>
                    <span class="c1"># re-report the error here</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">[</span><span class="n">cached_mirror_url</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">all_methods_failed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># May need to fetch the index and update the local caches</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">needs_regen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_and_cache_index</span><span class="p">(</span>
                            <span class="n">cached_mirror_url</span><span class="p">,</span> <span class="n">cache_entry</span><span class="o">=</span><span class="n">cache_entry</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">[</span><span class="n">cached_mirror_url</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">all_methods_failed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">except</span> <span class="n">FetchIndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">needs_regen</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">fetch_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">[</span><span class="n">cached_mirror_url</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># The need to regenerate implies a need to clear as well.</span>
                    <span class="n">spec_cache_clear_needed</span> <span class="o">|=</span> <span class="n">needs_regen</span>
                    <span class="n">spec_cache_regenerate_needed</span> <span class="o">|=</span> <span class="n">needs_regen</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No longer have this mirror, cached index should be removed</span>
                <span class="n">items_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">cached_mirror_url</span><span class="p">,</span>
                        <span class="s2">&quot;cache_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_cache_root</span><span class="p">,</span> <span class="n">cached_index_path</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">cached_mirror_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">[</span><span class="n">cached_mirror_url</span><span class="p">]</span>
                <span class="n">spec_cache_clear_needed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">spec_cache_regenerate_needed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Clean up items to be removed, identified above</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items_to_remove</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;cache_key&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>

        <span class="c1"># Iterate the configured mirrors now.  Any mirror urls we do not</span>
        <span class="c1"># already have in our cache must be fetched, stored, and represented</span>
        <span class="c1"># locally.</span>
        <span class="k">for</span> <span class="n">mirror_url</span> <span class="ow">in</span> <span class="n">configured_mirror_urls</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mirror_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Need to fetch the index and update the local caches</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">needs_regen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_and_cache_index</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">[</span><span class="n">mirror_url</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">all_methods_failed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="n">FetchIndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">fetch_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">needs_regen</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_fetch_times</span><span class="p">[</span><span class="n">mirror_url</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Generally speaking, a new mirror wouldn&#39;t imply the need to</span>
            <span class="c1"># clear the spec cache, so leave it as is.</span>
            <span class="k">if</span> <span class="n">needs_regen</span><span class="p">:</span>
                <span class="n">spec_cache_regenerate_needed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_local_index_cache</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">configured_mirror_urls</span> <span class="ow">and</span> <span class="n">all_methods_failed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchCacheError</span><span class="p">(</span><span class="n">fetch_errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fetch_errors</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The following issues were ignored while updating the indices of binary caches&quot;</span><span class="p">,</span>
                <span class="n">FetchCacheError</span><span class="p">(</span><span class="n">fetch_errors</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">spec_cache_regenerate_needed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regenerate_spec_cache</span><span class="p">(</span><span class="n">clear_existing</span><span class="o">=</span><span class="n">spec_cache_clear_needed</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_fetch_and_cache_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirror_url</span><span class="p">,</span> <span class="n">cache_entry</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch a buildcache index file from a remote mirror and cache it.</span>

<span class="sd">        If we already have a cached index from this mirror, then we first</span>
<span class="sd">        check if the hash has changed, and we avoid fetching it if not.</span>

<span class="sd">        Args:</span>
<span class="sd">            mirror_url (str): Base url of mirror</span>
<span class="sd">            cache_entry (dict): Old cache metadata with keys ``index_hash``, ``index_path``,</span>
<span class="sd">                ``etag``</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the local index.json was updated.</span>

<span class="sd">        Throws:</span>
<span class="sd">            FetchIndexError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: get rid of this request, handle 404 better</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span>

        <span class="k">if</span> <span class="n">scheme</span> <span class="o">!=</span> <span class="s2">&quot;oci&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">web_util</span><span class="o">.</span><span class="n">url_exists</span><span class="p">(</span>
            <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;oci&quot;</span><span class="p">:</span>
            <span class="c1"># TODO: Actually etag and OCI are not mutually exclusive...</span>
            <span class="n">fetcher</span> <span class="o">=</span> <span class="n">OCIIndexFetcher</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">,</span> <span class="n">cache_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_hash&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">cache_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etag&quot;</span><span class="p">):</span>
            <span class="n">fetcher</span> <span class="o">=</span> <span class="n">EtagIndexFetcher</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">,</span> <span class="n">cache_entry</span><span class="p">[</span><span class="s2">&quot;etag&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fetcher</span> <span class="o">=</span> <span class="n">DefaultIndexFetcher</span><span class="p">(</span>
                <span class="n">mirror_url</span><span class="p">,</span> <span class="n">local_hash</span><span class="o">=</span><span class="n">cache_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_hash&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">conditional_fetch</span><span class="p">()</span>

        <span class="c1"># Nothing to do</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fresh</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Persist new index.json</span>
        <span class="n">url_hash</span> <span class="o">=</span> <span class="n">compute_hash</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">)</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_hash</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">result</span><span class="o">.</span><span class="n">hash</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">init_entry</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">write_transaction</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="n">new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_local_index_cache</span><span class="p">[</span><span class="n">mirror_url</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;index_hash&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
            <span class="s2">&quot;index_path&quot;</span><span class="p">:</span> <span class="n">cache_key</span><span class="p">,</span>
            <span class="s2">&quot;etag&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">etag</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># clean up the old cache_key if necessary</span>
        <span class="n">old_cache_key</span> <span class="o">=</span> <span class="n">cache_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_cache_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_file_cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_cache_key</span><span class="p">)</span>

        <span class="c1"># We fetched an index and updated the local index cache, we should</span>
        <span class="c1"># regenerate the spec cache as a result.</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="binary_index_location">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.binary_index_location">[docs]</a>
<span class="k">def</span> <span class="nf">binary_index_location</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up a BinaryCacheIndex for remote buildcache dbs in the user&#39;s homedir.&quot;&quot;&quot;</span>
    <span class="n">cache_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">misc_cache_location</span><span class="p">(),</span> <span class="s2">&quot;indices&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">canonicalize_path</span><span class="p">(</span><span class="n">cache_root</span><span class="p">)</span></div>



<span class="c1">#: Default binary cache index instance</span>
<span class="n">BINARY_INDEX</span><span class="p">:</span> <span class="n">BinaryCacheIndex</span> <span class="o">=</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Singleton</span><span class="p">(</span><span class="n">BinaryCacheIndex</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<div class="viewcode-block" id="compute_hash">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.compute_hash">[docs]</a>
<span class="k">def</span> <span class="nf">compute_hash</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>



<div class="viewcode-block" id="build_cache_relative_path">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.build_cache_relative_path">[docs]</a>
<span class="k">def</span> <span class="nf">build_cache_relative_path</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span></div>



<div class="viewcode-block" id="build_cache_keys_relative_path">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.build_cache_keys_relative_path">[docs]</a>
<span class="k">def</span> <span class="nf">build_cache_keys_relative_path</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">BUILD_CACHE_KEYS_RELATIVE_PATH</span></div>



<div class="viewcode-block" id="build_cache_prefix">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.build_cache_prefix">[docs]</a>
<span class="k">def</span> <span class="nf">build_cache_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">build_cache_relative_path</span><span class="p">())</span></div>



<div class="viewcode-block" id="buildinfo_file_name">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.buildinfo_file_name">[docs]</a>
<span class="k">def</span> <span class="nf">buildinfo_file_name</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filename of the binary package meta-data file&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;.spack&quot;</span><span class="p">,</span> <span class="s2">&quot;binary_distribution&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_buildinfo_file">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.read_buildinfo_file">[docs]</a>
<span class="k">def</span> <span class="nf">read_buildinfo_file</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read buildinfo file&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">buildinfo_file_name</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">syaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>



<div class="viewcode-block" id="BuildManifestVisitor">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildManifestVisitor">[docs]</a>
<span class="k">class</span> <span class="nc">BuildManifestVisitor</span><span class="p">(</span><span class="n">BaseDirectoryVisitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visitor that collects a list of files and symlinks</span>
<span class="sd">    that can be checked for need of relocation. It knows how</span>
<span class="sd">    to dedupe hardlinks and deal with symlinks to files and</span>
<span class="sd">    directories.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Save unique identifiers of hardlinks to avoid relocating them multiple times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Lists of files we will check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symlinks</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="BuildManifestVisitor.seen_before">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildManifestVisitor.seen_before">[docs]</a>
    <span class="k">def</span> <span class="nf">seen_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">):</span>
        <span class="n">stat_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stat_result</span><span class="o">.</span><span class="n">st_nlink</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat_result</span><span class="o">.</span><span class="n">st_dev</span><span class="p">,</span> <span class="n">stat_result</span><span class="o">.</span><span class="n">st_ino</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="BuildManifestVisitor.visit_file">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildManifestVisitor.visit_file">[docs]</a>
    <span class="k">def</span> <span class="nf">visit_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_before</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildManifestVisitor.visit_symlinked_file">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildManifestVisitor.visit_symlinked_file">[docs]</a>
    <span class="k">def</span> <span class="nf">visit_symlinked_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="c1"># Note: symlinks *can* be hardlinked, but it is unclear if</span>
        <span class="c1"># symlinks can be relinked in-place (preserving inode).</span>
        <span class="c1"># Therefore, we do *not* de-dupe hardlinked symlinks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symlinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildManifestVisitor.before_visit_dir">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildManifestVisitor.before_visit_dir">[docs]</a>
    <span class="k">def</span> <span class="nf">before_visit_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.spack&quot;</span><span class="p">,</span> <span class="s2">&quot;man&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildManifestVisitor.before_visit_symlinked_dir">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildManifestVisitor.before_visit_symlinked_dir">[docs]</a>
    <span class="k">def</span> <span class="nf">before_visit_symlinked_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="c1"># Treat symlinked directories simply as symlinks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_symlinked_file</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="c1"># Never recurse into symlinked directories.</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="file_matches">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.file_matches">[docs]</a>
<span class="k">def</span> <span class="nf">file_matches</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">contents</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_buildfile_manifest">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.get_buildfile_manifest">[docs]</a>
<span class="k">def</span> <span class="nf">get_buildfile_manifest</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a data structure with information about a build, including</span>
<span class="sd">    text_to_relocate, binary_to_relocate, binary_to_relocate_fullpath</span>
<span class="sd">    link_to_relocate, and other, which means it doesn&#39;t fit any of previous</span>
<span class="sd">    checks (and should not be relocated). We exclude docs (man) and</span>
<span class="sd">    metadata (.spack). This can be used to find a particular kind of file</span>
<span class="sd">    in spack, or to generate the build metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;text_to_relocate&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;binary_to_relocate&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;link_to_relocate&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;binary_to_relocate_fullpath&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;hardlinks_deduped&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Guard against filesystem footguns of hardlinks and symlinks by using</span>
    <span class="c1"># a visitor to retrieve a list of files and symlinks, so we don&#39;t have</span>
    <span class="c1"># to worry about hardlinks of symlinked dirs and what not.</span>
    <span class="n">visitor</span> <span class="o">=</span> <span class="n">BuildManifestVisitor</span><span class="p">()</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">prefix</span>
    <span class="n">visit_directory_tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">visitor</span><span class="p">)</span>

    <span class="c1"># Collect a list of prefixes for this package and it&#39;s dependencies, Spack will</span>
    <span class="c1"># look for them to decide if text file needs to be relocated or not</span>
    <span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">prefix</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">external</span><span class="p">]</span>
    <span class="n">prefixes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">sbang</span><span class="o">.</span><span class="n">sbang_install_path</span><span class="p">())</span>
    <span class="n">prefixes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>

    <span class="c1"># Create a giant regex that matches all prefixes</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">utf8_paths_to_single_binary_regex</span><span class="p">(</span><span class="n">prefixes</span><span class="p">)</span>

    <span class="c1"># Symlinks.</span>

    <span class="c1"># Obvious bugs:</span>
    <span class="c1">#   1. relative links are not relocated.</span>
    <span class="c1">#   2. paths are used as strings.</span>
    <span class="k">for</span> <span class="n">rel_path</span> <span class="ow">in</span> <span class="n">visitor</span><span class="o">.</span><span class="n">symlinks</span><span class="p">:</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">)</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">readlink</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;link_to_relocate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>

    <span class="c1"># Non-symlinks.</span>
    <span class="k">for</span> <span class="n">rel_path</span> <span class="ow">in</span> <span class="n">visitor</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">)</span>
        <span class="n">m_type</span><span class="p">,</span> <span class="n">m_subtype</span> <span class="o">=</span> <span class="n">ssys</span><span class="o">.</span><span class="n">mime_type</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">relocate</span><span class="o">.</span><span class="n">needs_binary_relocation</span><span class="p">(</span><span class="n">m_type</span><span class="p">,</span> <span class="n">m_subtype</span><span class="p">):</span>
            <span class="c1"># Why is this branch not part of needs_binary_relocation? :(</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">m_subtype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x-executable&quot;</span><span class="p">,</span> <span class="s2">&quot;x-sharedlib&quot;</span><span class="p">,</span> <span class="s2">&quot;x-pie-executable&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;darwin&quot;</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">m_subtype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x-mach-binary&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rel_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.o&quot;</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;binary_to_relocate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;binary_to_relocate_fullpath&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">elif</span> <span class="n">relocate</span><span class="o">.</span><span class="n">needs_text_relocation</span><span class="p">(</span><span class="n">m_type</span><span class="p">,</span> <span class="n">m_subtype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file_matches</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;text_to_relocate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="deps_to_relocate">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.deps_to_relocate">[docs]</a>
<span class="k">def</span> <span class="nf">deps_to_relocate</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the transitive link and direct run dependencies of the spec.</span>

<span class="sd">    This is a special traversal for dependencies we need to consider when relocating a package.</span>

<span class="sd">    Package binaries, scripts, and other files may refer to the prefixes of  dependencies, so</span>
<span class="sd">    we need to rewrite those locations when dependencies are in a different place at install time</span>
<span class="sd">    than they were at build time.</span>

<span class="sd">    This traversal covers transitive link dependencies and direct run dependencies because:</span>

<span class="sd">    1. Spack adds RPATHs for transitive link dependencies so that packages can find needed</span>
<span class="sd">       dependency libraries.</span>
<span class="sd">    2. Packages may call any of their *direct* run dependencies (and may bake their paths into</span>
<span class="sd">       binaries or scripts), so we also need to search for run dependency prefixes when relocating.</span>

<span class="sd">    This returns a deduplicated list of transitive link dependencies and direct run dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="s2">&quot;link&quot;</span><span class="p">),</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">external</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">dedupe</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span></div>



<div class="viewcode-block" id="get_buildinfo_dict">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.get_buildinfo_dict">[docs]</a>
<span class="k">def</span> <span class="nf">get_buildinfo_dict</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create metadata for a tarball&quot;&quot;&quot;</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">get_buildfile_manifest</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;sbang_install_path&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">sbang</span><span class="o">.</span><span class="n">sbang_install_path</span><span class="p">(),</span>
        <span class="s2">&quot;buildpath&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
        <span class="s2">&quot;spackprefix&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
        <span class="s2">&quot;relative_prefix&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">root</span><span class="p">),</span>
        <span class="s2">&quot;relocate_textfiles&quot;</span><span class="p">:</span> <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;text_to_relocate&quot;</span><span class="p">],</span>
        <span class="s2">&quot;relocate_binaries&quot;</span><span class="p">:</span> <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;binary_to_relocate&quot;</span><span class="p">],</span>
        <span class="s2">&quot;relocate_links&quot;</span><span class="p">:</span> <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;link_to_relocate&quot;</span><span class="p">],</span>
        <span class="s2">&quot;hardlinks_deduped&quot;</span><span class="p">:</span> <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;hardlinks_deduped&quot;</span><span class="p">],</span>
        <span class="s2">&quot;hash_to_prefix&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">d</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">():</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps_to_relocate</span><span class="p">(</span><span class="n">spec</span><span class="p">)},</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="tarball_directory_name">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.tarball_directory_name">[docs]</a>
<span class="k">def</span> <span class="nf">tarball_directory_name</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return name of the tarball directory according to the convention</span>
<span class="sd">    &lt;os&gt;-&lt;architecture&gt;/&lt;compiler&gt;/&lt;package&gt;-&lt;version&gt;/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">spec</span><span class="o">.</span><span class="n">format_path</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{architecture}</span><span class="s2">/</span><span class="si">{compiler.name}</span><span class="s2">-</span><span class="si">{compiler.version}</span><span class="s2">/</span><span class="si">{name}</span><span class="s2">-</span><span class="si">{version}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="tarball_name">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.tarball_name">[docs]</a>
<span class="k">def</span> <span class="nf">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the name of the tarfile according to the convention</span>
<span class="sd">    &lt;os&gt;-&lt;architecture&gt;-&lt;package&gt;-&lt;dag_hash&gt;&lt;ext&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec_formatted</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">format_path</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{architecture}</span><span class="s2">-</span><span class="si">{compiler.name}</span><span class="s2">-</span><span class="si">{compiler.version}</span><span class="s2">-</span><span class="si">{name}</span><span class="s2">-</span><span class="si">{version}</span><span class="s2">-</span><span class="si">{hash}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec_formatted</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="tarball_path_name">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.tarball_path_name">[docs]</a>
<span class="k">def</span> <span class="nf">tarball_path_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the full path+name for a given spec according to the convention</span>
<span class="sd">    &lt;tarball_directory_name&gt;/&lt;tarball_name&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tarball_directory_name</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span></div>



<div class="viewcode-block" id="select_signing_key">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.select_signing_key">[docs]</a>
<span class="k">def</span> <span class="nf">select_signing_key</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">signing_keys</span><span class="p">()</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PickKeyException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoKeyException</span><span class="p">(</span>
            <span class="s2">&quot;No default key available for signing.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Use spack gpg init and spack gpg create&quot;</span>
            <span class="s2">&quot; to create a default key.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="sign_specfile">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.sign_specfile">[docs]</a>
<span class="k">def</span> <span class="nf">sign_specfile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">specfile_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;sign and return the path to the signed specfile&quot;&quot;&quot;</span>
    <span class="n">signed_specfile_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">specfile_path</span><span class="si">}</span><span class="s2">.sig&quot;</span>
    <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">specfile_path</span><span class="p">,</span> <span class="n">signed_specfile_path</span><span class="p">,</span> <span class="n">clearsign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">signed_specfile_path</span></div>



<span class="k">def</span> <span class="nf">_read_specs_and_push_index</span><span class="p">(</span>
    <span class="n">file_list</span><span class="p">,</span> <span class="n">read_method</span><span class="p">,</span> <span class="n">cache_prefix</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">BuildCacheDatabase</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="n">concurrency</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read all the specs listed in the provided list, using thread given thread parallelism,</span>
<span class="sd">        generate the index, and push it to the mirror.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_list (list(str)): List of urls or file paths pointing at spec files to read</span>
<span class="sd">        read_method: A function taking a single argument, either a url or a file path,</span>
<span class="sd">            and which reads the spec file at that location, and returns the spec.</span>
<span class="sd">        cache_prefix (str): prefix of the build cache on s3 where index should be pushed.</span>
<span class="sd">        db: A spack database used for adding specs and then writing the index.</span>
<span class="sd">        temp_dir (str): Location to write index.json and hash for pushing</span>
<span class="sd">        concurrency (int): Number of parallel processes to use when fetching</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">read_method</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="c1"># Need full spec.json name or this gets confused with index.json.</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json.sig&quot;</span><span class="p">):</span>
            <span class="n">specfile_json</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">extract_json_from_clearsig</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">fetched_spec</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">specfile_json</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">fetched_spec</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fetched_spec</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">fetched_spec</span><span class="p">,</span> <span class="s2">&quot;in_buildcache&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Now generate the index, compute its hash, and push the two files to</span>
    <span class="c1"># the mirror.</span>
    <span class="n">index_json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_write_to_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Read the index back in and compute its hash</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_json_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">index_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">index_hash</span> <span class="o">=</span> <span class="n">compute_hash</span><span class="p">(</span><span class="n">index_string</span><span class="p">)</span>

    <span class="c1"># Write the hash out to a local file</span>
    <span class="n">index_hash_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;index.json.hash&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_hash_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">index_hash</span><span class="p">)</span>

    <span class="c1"># Push the index itself</span>
    <span class="n">web_util</span><span class="o">.</span><span class="n">push_to_url</span><span class="p">(</span>
        <span class="n">index_json_path</span><span class="p">,</span>
        <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_prefix</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">),</span>
        <span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ContentType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;CacheControl&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Push the hash</span>
    <span class="n">web_util</span><span class="o">.</span><span class="n">push_to_url</span><span class="p">(</span>
        <span class="n">index_hash_path</span><span class="p">,</span>
        <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_prefix</span><span class="p">,</span> <span class="s2">&quot;index.json.hash&quot;</span><span class="p">),</span>
        <span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ContentType&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span> <span class="s2">&quot;CacheControl&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">},</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_specs_from_cache_aws_cli</span><span class="p">(</span><span class="n">cache_prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use aws cli to sync all the specs into a local temporary directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_prefix (str): prefix of the build cache on s3</span>

<span class="sd">    Return:</span>
<span class="sd">        List of the local file paths and a function that can read each one from the file system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">read_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">aws</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;aws&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">file_read_method</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">tmpspecsdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">sync_command_args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;s3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sync&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--exclude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--include&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*.spec.json.sig&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--include&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*.spec.json&quot;</span><span class="p">,</span>
        <span class="n">cache_prefix</span><span class="p">,</span>
        <span class="n">tmpspecsdir</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Using aws s3 sync to download specs from </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cache_prefix</span><span class="p">,</span> <span class="n">tmpspecsdir</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">aws</span><span class="p">(</span><span class="o">*</span><span class="n">sync_command_args</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">)</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="n">fsys</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tmpspecsdir</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;*.spec.json.sig&quot;</span><span class="p">,</span> <span class="s2">&quot;*.spec.json&quot;</span><span class="p">])</span>
        <span class="n">read_fn</span> <span class="o">=</span> <span class="n">file_read_method</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to use aws s3 sync to retrieve specs, falling back to parallel fetch&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpspecsdir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">file_list</span><span class="p">,</span> <span class="n">read_fn</span>


<span class="k">def</span> <span class="nf">_specs_from_cache_fallback</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use spack.util.web module to get a list of all the specs at the remote url.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_prefix (str): Base url of mirror (location of spec files)</span>

<span class="sd">    Return:</span>
<span class="sd">        The list of complete spec file urls and a function that can read each one from its</span>
<span class="sd">            remote location (also using the spack.util.web module).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">read_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">url_read_method</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spec_file</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">read_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">spec_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SpackWebError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading specfile: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contents</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">web_util</span><span class="o">.</span><span class="n">list_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;spec.json&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">entry</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;spec.json.sig&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">read_fn</span> <span class="o">=</span> <span class="n">url_read_method</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="c1"># If we got some kind of S3 (access denied or other connection error), the first non</span>
        <span class="c1"># boto-specific class in the exception is Exception.  Just print a warning and return</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encountered problem listing packages at </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">file_list</span><span class="p">,</span> <span class="n">read_fn</span>


<span class="k">def</span> <span class="nf">_spec_files_from_cache</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of all the spec files in the mirror and a function to</span>
<span class="sd">    read them.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: Base url of mirror (location of spec files)</span>

<span class="sd">    Return:</span>
<span class="sd">        A tuple where the first item is a list of absolute file paths or</span>
<span class="sd">        urls pointing to the specs that should be read from the mirror,</span>
<span class="sd">        and the second item is a function taking a url or file path and</span>
<span class="sd">        returning the spec read from that location.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
        <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_specs_from_cache_aws_cli</span><span class="p">)</span>

    <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_specs_from_cache_fallback</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">specs_from_cache_fn</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
        <span class="n">file_list</span><span class="p">,</span> <span class="n">read_fn</span> <span class="o">=</span> <span class="n">specs_from_cache_fn</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file_list</span><span class="p">,</span> <span class="n">read_fn</span>

    <span class="k">raise</span> <span class="n">ListMirrorSpecsError</span><span class="p">(</span><span class="s2">&quot;Failed to get list of specs from </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_url_generate_package_index</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create or replace the build cache index on the given mirror.  The</span>
<span class="sd">    buildcache index contains an entry for each binary package under the</span>
<span class="sd">    cache_prefix.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: Base url of binary mirror.</span>
<span class="sd">        concurrency: The desired threading concurrency to use when fetching the spec files from</span>
<span class="sd">            the mirror.</span>

<span class="sd">    Return:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">build_cache_relative_path</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_list</span><span class="p">,</span> <span class="n">read_fn</span> <span class="o">=</span> <span class="n">_spec_files_from_cache</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ListMirrorSpecsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">GenerateIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to generate package index: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieving spec descriptor files from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> to build index&quot;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">BuildCacheDatabase</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">_read_specs_and_push_index</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">read_fn</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">database_directory</span><span class="p">,</span> <span class="n">concurrency</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">GenerateIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encountered problem pushing package index to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>


<div class="viewcode-block" id="generate_key_index">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.generate_key_index">[docs]</a>
<span class="k">def</span> <span class="nf">generate_key_index</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the key index page.</span>

<span class="sd">    Creates (or replaces) the &quot;index.json&quot; page at the location given in key_prefix.  This page</span>
<span class="sd">    contains an entry for each key (.pub) under key_prefix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieving key.pub files from </span><span class="si">{</span><span class="n">url_util</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">)</span><span class="si">}</span><span class="s2"> to build key index&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fingerprints</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">entry</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">web_util</span><span class="o">.</span><span class="n">list_url</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pub&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CannotListKeys</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encountered problem listing keys at </span><span class="si">{</span><span class="n">key_prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">((</span><span class="n">fingerprint</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">fingerprint</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fingerprints</span><span class="p">)))}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">sjson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">web_util</span><span class="o">.</span><span class="n">push_to_url</span><span class="p">(</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">),</span>
            <span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">extra_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ContentType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">GenerateIndexError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Encountered problem pushing key index to </span><span class="si">{</span><span class="n">key_prefix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>



<div class="viewcode-block" id="tarfile_of_spec_prefix">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.tarfile_of_spec_prefix">[docs]</a>
<span class="k">def</span> <span class="nf">tarfile_of_spec_prefix</span><span class="p">(</span><span class="n">tar</span><span class="p">:</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a tarfile of an install prefix of a spec. Skips existing buildinfo file.</span>

<span class="sd">    Args:</span>
<span class="sd">        tar: tarfile object to add files to</span>
<span class="sd">        prefix: absolute install prefix of spec&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prefix &#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39; must be an absolute path to a directory&quot;</span><span class="p">)</span>
    <span class="n">stat_key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">stat</span><span class="p">:</span> <span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_dev</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_ino</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>  <span class="c1"># skip buildinfo file if it exists</span>
        <span class="n">files_to_skip</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat_key</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">buildinfo_file_name</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))]</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">stat_key</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="ow">in</span> <span class="n">files_to_skip</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="kc">False</span>

    <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">reproducible_tarfile_from_prefix</span><span class="p">(</span>
        <span class="n">tar</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">,</span>
        <span class="c1"># Spack &lt;= 0.21 did not include parent directories, leading to issues when tarballs are</span>
        <span class="c1"># used in runtimes like AWS lambda.</span>
        <span class="n">include_parent_directories</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_do_create_tarball</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">binaries_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">buildinfo</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">gzip_compressed_tarfile</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span>
        <span class="n">tar</span><span class="p">,</span>
        <span class="n">inner_checksum</span><span class="p">,</span>
        <span class="n">outer_checksum</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Tarball the install prefix</span>
        <span class="n">tarfile_of_spec_prefix</span><span class="p">(</span><span class="n">tar</span><span class="p">,</span> <span class="n">binaries_dir</span><span class="p">)</span>

        <span class="c1"># Serialize buildinfo for the tarball</span>
        <span class="n">bstring</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">buildinfo</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">default_path_to_name</span><span class="p">(</span><span class="n">buildinfo_file_name</span><span class="p">(</span><span class="n">binaries_dir</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">REGTYPE</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bstring</span><span class="p">)</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0o644</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">bstring</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">inner_checksum</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="n">outer_checksum</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<div class="viewcode-block" id="ExistsInBuildcache">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.ExistsInBuildcache">[docs]</a>
<span class="k">class</span> <span class="nc">ExistsInBuildcache</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">signed</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">unsigned</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">tarball</span><span class="p">:</span> <span class="nb">bool</span></div>



<div class="viewcode-block" id="BuildcacheFiles">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildcacheFiles">[docs]</a>
<span class="k">class</span> <span class="nc">BuildcacheFiles</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">,</span> <span class="n">local</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remote</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            spec: The spec whose tarball and specfile are being managed.</span>
<span class="sd">            local: The local path to the buildcache.</span>
<span class="sd">            remote: The remote URL to the buildcache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local</span> <span class="o">=</span> <span class="n">local</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">remote</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>

<div class="viewcode-block" id="BuildcacheFiles.remote_specfile">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildcacheFiles.remote_specfile">[docs]</a>
    <span class="k">def</span> <span class="nf">remote_specfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="p">,</span>
            <span class="n">build_cache_relative_path</span><span class="p">(),</span>
            <span class="n">tarball_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json.sig&quot;</span> <span class="k">if</span> <span class="n">signed</span> <span class="k">else</span> <span class="s2">&quot;.spec.json&quot;</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BuildcacheFiles.remote_tarball">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildcacheFiles.remote_tarball">[docs]</a>
    <span class="k">def</span> <span class="nf">remote_tarball</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="p">,</span> <span class="n">build_cache_relative_path</span><span class="p">(),</span> <span class="n">tarball_path_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spack&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BuildcacheFiles.local_specfile">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildcacheFiles.local_specfile">[docs]</a>
    <span class="k">def</span> <span class="nf">local_specfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2">.spec.json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildcacheFiles.local_tarball">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildcacheFiles.local_tarball">[docs]</a>
    <span class="k">def</span> <span class="nf">local_tarball</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span><span class="p">)</span></div>
</div>



<span class="k">def</span> <span class="nf">_exists_in_buildcache</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">out_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExistsInBuildcache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;returns a tuple of bools (signed, unsigned, tarball) indicating whether specfiles/tarballs</span>
<span class="sd">    exist in the buildcache&quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">BuildcacheFiles</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">,</span> <span class="n">out_url</span><span class="p">)</span>
    <span class="n">signed</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">url_exists</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">remote_specfile</span><span class="p">(</span><span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">unsigned</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">url_exists</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">remote_specfile</span><span class="p">(</span><span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">tarball</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">url_exists</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">remote_tarball</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ExistsInBuildcache</span><span class="p">(</span><span class="n">signed</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">,</span> <span class="n">tarball</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_url_upload_tarball_and_specfile</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">out_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exists</span><span class="p">:</span> <span class="n">ExistsInBuildcache</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">BuildcacheFiles</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">,</span> <span class="n">out_url</span><span class="p">)</span>
    <span class="n">tarball</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">local_tarball</span><span class="p">()</span>
    <span class="n">checksum</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_do_create_tarball</span><span class="p">(</span><span class="n">tarball</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">get_buildinfo_dict</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
    <span class="n">spec_dict</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="n">ht</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">)</span>
    <span class="n">spec_dict</span><span class="p">[</span><span class="s2">&quot;buildcache_layout_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CURRENT_BUILD_CACHE_LAYOUT_VERSION</span>
    <span class="n">spec_dict</span><span class="p">[</span><span class="s2">&quot;binary_cache_checksum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hash_algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">checksum</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">exists</span><span class="o">.</span><span class="n">tarball</span><span class="p">:</span>
        <span class="n">web_util</span><span class="o">.</span><span class="n">remove_url</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">remote_tarball</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">exists</span><span class="o">.</span><span class="n">signed</span><span class="p">:</span>
        <span class="n">web_util</span><span class="o">.</span><span class="n">remove_url</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">remote_specfile</span><span class="p">(</span><span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">exists</span><span class="o">.</span><span class="n">unsigned</span><span class="p">:</span>
        <span class="n">web_util</span><span class="o">.</span><span class="n">remove_url</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">remote_specfile</span><span class="p">(</span><span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">web_util</span><span class="o">.</span><span class="n">push_to_url</span><span class="p">(</span><span class="n">tarball</span><span class="p">,</span> <span class="n">files</span><span class="o">.</span><span class="n">remote_tarball</span><span class="p">(),</span> <span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">specfile</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">local_specfile</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">specfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Note: when using gpg clear sign, we need to avoid long lines (19995 chars).</span>
        <span class="c1"># If lines are longer, they are truncated without error. Thanks GPG!</span>
        <span class="c1"># So, here we still add newlines, but no indent, so save on file size and</span>
        <span class="c1"># line length.</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">spec_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>

    <span class="c1"># sign the tarball and spec file with gpg</span>
    <span class="k">if</span> <span class="n">signing_key</span><span class="p">:</span>
        <span class="n">specfile</span> <span class="o">=</span> <span class="n">sign_specfile</span><span class="p">(</span><span class="n">signing_key</span><span class="p">,</span> <span class="n">specfile</span><span class="p">)</span>

    <span class="n">web_util</span><span class="o">.</span><span class="n">push_to_url</span><span class="p">(</span>
        <span class="n">specfile</span><span class="p">,</span> <span class="n">files</span><span class="o">.</span><span class="n">remote_specfile</span><span class="p">(</span><span class="n">signed</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">signing_key</span><span class="p">)),</span> <span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>


<div class="viewcode-block" id="Uploader">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.Uploader">[docs]</a>
<span class="k">class</span> <span class="nc">Uploader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirror</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">update_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">mirror</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">force</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_index</span> <span class="o">=</span> <span class="n">update_index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">:</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Executor</span>

        <span class="c1"># Verify if the mirror meets the requirements to push</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">ensure_mirror_usable</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">spack</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_stage_root</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">make_concurrent_executor</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="Uploader.push_or_raise">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.Uploader.push_or_raise">[docs]</a>
    <span class="k">def</span> <span class="nf">push_or_raise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]:</span>
        <span class="n">skipped</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PushToBuildCacheError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to push </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> specs to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">push_url</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to push </span><span class="si">{</span><span class="n">_format_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">skipped</span></div>


<div class="viewcode-block" id="Uploader.push">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.Uploader.push">[docs]</a>
    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">]]]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Uploader.tag">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.Uploader.tag">[docs]</a>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a list of selected specs together available under the given tag&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="OCIUploader">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.OCIUploader">[docs]</a>
<span class="k">class</span> <span class="nc">OCIUploader</span><span class="p">(</span><span class="n">Uploader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mirror</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">update_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">base_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">update_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_image</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image_from_mirror</span><span class="p">(</span><span class="n">mirror</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_image</span> <span class="o">=</span> <span class="n">ImageReference</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">base_image</span><span class="p">)</span> <span class="k">if</span> <span class="n">base_image</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="OCIUploader.push">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.OCIUploader.push">[docs]</a>
    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">]]]:</span>
        <span class="n">skipped</span><span class="p">,</span> <span class="n">base_images</span><span class="p">,</span> <span class="n">checksums</span><span class="p">,</span> <span class="n">upload_errors</span> <span class="o">=</span> <span class="n">_oci_push</span><span class="p">(</span>
            <span class="n">target_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_image</span><span class="p">,</span>
            <span class="n">base_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_image</span><span class="p">,</span>
            <span class="n">installed_specs_with_deps</span><span class="o">=</span><span class="n">specs</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
            <span class="n">tmpdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
            <span class="n">executor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_base_images</span> <span class="o">=</span> <span class="n">base_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checksums</span> <span class="o">=</span> <span class="n">checksums</span>

        <span class="c1"># only update index if any binaries were uploaded</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_index</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">upload_errors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">_oci_update_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">upload_errors</span></div>


<div class="viewcode-block" id="OCIUploader.tag">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.OCIUploader.tag">[docs]</a>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]):</span>
        <span class="n">tagged_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_image</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="c1"># _push_oci may not populate self._base_images if binaries were already in the registry</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">_oci_update_base_images</span><span class="p">(</span>
                <span class="n">base_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_image</span><span class="p">,</span>
                <span class="n">target_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_image</span><span class="p">,</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                <span class="n">base_image_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_images</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">_oci_put_manifest</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checksums</span><span class="p">,</span> <span class="n">tagged_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">roots</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="URLUploader">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.URLUploader">[docs]</a>
<span class="k">class</span> <span class="nc">URLUploader</span><span class="p">(</span><span class="n">Uploader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mirror</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">update_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">signing_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">update_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">.</span><span class="n">push_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signing_key</span> <span class="o">=</span> <span class="n">signing_key</span>

<div class="viewcode-block" id="URLUploader.push">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.URLUploader.push">[docs]</a>
    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">]]]:</span>
        <span class="k">return</span> <span class="n">_url_push</span><span class="p">(</span>
            <span class="n">specs</span><span class="p">,</span>
            <span class="n">out_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
            <span class="n">update_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_index</span><span class="p">,</span>
            <span class="n">signing_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signing_key</span><span class="p">,</span>
            <span class="n">tmpdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
            <span class="n">executor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="make_uploader">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.make_uploader">[docs]</a>
<span class="k">def</span> <span class="nf">make_uploader</span><span class="p">(</span>
    <span class="n">mirror</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">update_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">signing_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">base_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Uploader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Builder for the appropriate uploader based on the mirror type&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mirror</span><span class="o">.</span><span class="n">push_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;oci://&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OCIUploader</span><span class="p">(</span>
            <span class="n">mirror</span><span class="o">=</span><span class="n">mirror</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">update_index</span><span class="o">=</span><span class="n">update_index</span><span class="p">,</span> <span class="n">base_image</span><span class="o">=</span><span class="n">base_image</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">URLUploader</span><span class="p">(</span>
            <span class="n">mirror</span><span class="o">=</span><span class="n">mirror</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">update_index</span><span class="o">=</span><span class="n">update_index</span><span class="p">,</span> <span class="n">signing_key</span><span class="o">=</span><span class="n">signing_key</span>
        <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_format_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">spec</span><span class="o">.</span><span class="n">cformat</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@version}{/hash:7}&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="FancyProgress">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.FancyProgress">[docs]</a>
<span class="k">class</span> <span class="nc">FancyProgress</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty_spec</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[F</span><span class="se">\033</span><span class="s2">[K&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">:{</span><span class="n">digits</span><span class="si">}}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="si">}</span><span class="s2">] &quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="FancyProgress.start">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.FancyProgress.start">[docs]</a>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">,</span> <span class="n">running</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="n">running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty_spec</span> <span class="o">=</span> <span class="n">_format_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="si">}</span><span class="s2">Pushing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_spec</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FancyProgress.ok">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.FancyProgress.ok">[docs]</a>
    <span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;Pushed </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_spec</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="si">}{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FancyProgress.fail">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.FancyProgress.fail">[docs]</a>
    <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="si">}</span><span class="s2">Failed to push </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<span class="k">def</span> <span class="nf">_url_push</span><span class="p">(</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">],</span>
    <span class="n">out_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">signing_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">update_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">executor</span><span class="p">:</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Executor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Spec</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pushes to the provided build cache, and returns a list of skipped specs that were already</span>
<span class="sd">    present (when force=False), and a list of errors. Does not raise on error.&quot;&quot;&quot;</span>
    <span class="n">skipped</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Spec</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">exists_futures</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_exists_in_buildcache</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">,</span> <span class="n">out_url</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span>
    <span class="p">]</span>

    <span class="n">exists</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">():</span> <span class="n">exists_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">exists_future</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">exists_futures</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">specs_to_upload</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="n">signed</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">,</span> <span class="n">tarball</span> <span class="o">=</span> <span class="n">exists</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">signed</span> <span class="ow">or</span> <span class="n">unsigned</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tarball</span><span class="p">:</span>
                <span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specs_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">specs_to_upload</span> <span class="o">=</span> <span class="n">specs</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">specs_to_upload</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">errors</span>

    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs_to_upload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">total</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> specs need to be pushed to </span><span class="si">{</span><span class="n">out_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">upload_futures</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
            <span class="n">_url_upload_tarball_and_specfile</span><span class="p">,</span>
            <span class="n">spec</span><span class="p">,</span>
            <span class="n">tmpdir</span><span class="p">,</span>
            <span class="n">out_url</span><span class="p">,</span>
            <span class="n">exists</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()],</span>
            <span class="n">signing_key</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs_to_upload</span>
    <span class="p">]</span>

    <span class="n">uploaded_any</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fancy_progress</span> <span class="o">=</span> <span class="n">FancyProgress</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">upload_future</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">specs_to_upload</span><span class="p">,</span> <span class="n">upload_futures</span><span class="p">):</span>
        <span class="n">fancy_progress</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">upload_future</span><span class="o">.</span><span class="n">running</span><span class="p">())</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">upload_future</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uploaded_any</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fancy_progress</span><span class="o">.</span><span class="n">ok</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fancy_progress</span><span class="o">.</span><span class="n">fail</span><span class="p">()</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spec</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>

    <span class="c1"># don&#39;t bother pushing keys / index if all failed to upload</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">uploaded_any</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">errors</span>

    <span class="k">if</span> <span class="n">signing_key</span><span class="p">:</span>
        <span class="n">keys_tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">keys_tmpdir</span><span class="p">)</span>
        <span class="n">_url_push_keys</span><span class="p">(</span><span class="n">out_url</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">signing_key</span><span class="p">],</span> <span class="n">update_index</span><span class="o">=</span><span class="n">update_index</span><span class="p">,</span> <span class="n">tmpdir</span><span class="o">=</span><span class="n">keys_tmpdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">update_index</span><span class="p">:</span>
        <span class="n">index_tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">index_tmpdir</span><span class="p">)</span>
        <span class="n">_url_generate_package_index</span><span class="p">(</span><span class="n">out_url</span><span class="p">,</span> <span class="n">index_tmpdir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">errors</span>


<span class="k">def</span> <span class="nf">_oci_upload_success_msg</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">,</span> <span class="n">digest</span><span class="p">:</span> <span class="n">Digest</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># guard against division by zero</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Pushed </span><span class="si">{</span><span class="n">_format_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">digest</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s)&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_oci_get_blob_info</span><span class="p">(</span><span class="n">image_ref</span><span class="p">:</span> <span class="n">ImageReference</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Blob</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the spack tarball layer digests and size if it exists&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">get_manifest_and_config_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Blob</span><span class="p">(</span>
            <span class="n">compressed_digest</span><span class="o">=</span><span class="n">Digest</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;digest&quot;</span><span class="p">]),</span>
            <span class="n">uncompressed_digest</span><span class="o">=</span><span class="n">Digest</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;rootfs&quot;</span><span class="p">][</span><span class="s2">&quot;diff_ids&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">size</span><span class="o">=</span><span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_oci_push_pkg_blob</span><span class="p">(</span>
    <span class="n">image_ref</span><span class="p">:</span> <span class="n">ImageReference</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Blob</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Push a package blob to the registry and return the blob info and the time taken&quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span><span class="p">)</span>

    <span class="c1"># Create an oci.image.layer aka tarball of the package</span>
    <span class="n">compressed_tarfile_checksum</span><span class="p">,</span> <span class="n">tarfile_checksum</span> <span class="o">=</span> <span class="n">_do_create_tarball</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">get_buildinfo_dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">blob</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Blob</span><span class="p">(</span>
        <span class="n">Digest</span><span class="o">.</span><span class="n">from_sha256</span><span class="p">(</span><span class="n">compressed_tarfile_checksum</span><span class="p">),</span>
        <span class="n">Digest</span><span class="o">.</span><span class="n">from_sha256</span><span class="p">(</span><span class="n">tarfile_checksum</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Upload the blob</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">upload_blob_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="n">blob</span><span class="o">.</span><span class="n">compressed_digest</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="c1"># delete the file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">blob</span><span class="p">,</span> <span class="n">elapsed</span>


<span class="k">def</span> <span class="nf">_oci_retrieve_env_dict_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the environment variables from the image config file.</span>
<span class="sd">    Sets a default value for PATH if it is not present.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): The image config file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The environment variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PATH&quot;</span><span class="p">:</span> <span class="s2">&quot;/bin:/usr/bin&quot;</span><span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;Env&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="p">{}):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;Env&quot;</span><span class="p">]:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">env</span>


<span class="k">def</span> <span class="nf">_oci_archspec_to_gooarch</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">name</span>
    <span class="n">name_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;aarch64&quot;</span><span class="p">:</span> <span class="s2">&quot;arm64&quot;</span><span class="p">,</span> <span class="s2">&quot;x86_64&quot;</span><span class="p">:</span> <span class="s2">&quot;amd64&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_oci_put_manifest</span><span class="p">(</span>
    <span class="n">base_images</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]],</span>
    <span class="n">checksums</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Blob</span><span class="p">],</span>
    <span class="n">image_ref</span><span class="p">:</span> <span class="n">ImageReference</span><span class="p">,</span>
    <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">extra_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">annotations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="o">*</span><span class="n">specs</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="n">_oci_archspec_to_gooarch</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">expected_blobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;topo&quot;</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">),</span> <span class="n">root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">external</span>
    <span class="p">]</span>
    <span class="n">expected_blobs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

    <span class="n">base_manifest</span><span class="p">,</span> <span class="n">base_config</span> <span class="o">=</span> <span class="n">base_images</span><span class="p">[</span><span class="n">architecture</span><span class="p">]</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">_oci_retrieve_env_dict_from_config</span><span class="p">(</span><span class="n">base_config</span><span class="p">)</span>

    <span class="c1"># If the base image uses `vnd.docker.distribution.manifest.v2+json`, then we use that too.</span>
    <span class="c1"># This is because Singularity / Apptainer is very strict about not mixing them.</span>
    <span class="n">base_manifest_mediaType</span> <span class="o">=</span> <span class="n">base_manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;mediaType&quot;</span><span class="p">,</span> <span class="s2">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span>
    <span class="p">)</span>
    <span class="n">use_docker_format</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">base_manifest_mediaType</span> <span class="o">==</span> <span class="s2">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span>
    <span class="p">)</span>

    <span class="n">spack</span><span class="o">.</span><span class="n">user_environment</span><span class="o">.</span><span class="n">environment_modifications_for_specs</span><span class="p">(</span><span class="o">*</span><span class="n">specs</span><span class="p">)</span><span class="o">.</span><span class="n">apply_modifications</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="c1"># Create an oci.image.config file</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_config</span><span class="p">)</span>

    <span class="c1"># Add the diff ids of the blobs</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">expected_blobs</span><span class="p">:</span>
        <span class="c1"># If a layer for a dependency has gone missing (due to removed manifest in the registry, a</span>
        <span class="c1"># failed push, or a local forced uninstall), we cannot create a runnable container image.</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksums</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">checksum</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;rootfs&quot;</span><span class="p">][</span><span class="s2">&quot;diff_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">checksum</span><span class="o">.</span><span class="n">uncompressed_digest</span><span class="p">))</span>

    <span class="c1"># Set the environment variables</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;Env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">extra_config</span><span class="p">:</span>
        <span class="c1"># From the OCI v1.0 spec:</span>
        <span class="c1"># &gt; Any extra fields in the Image JSON struct are considered implementation</span>
        <span class="c1"># &gt; specific and MUST be ignored by any implementations which are unable to</span>
        <span class="c1"># &gt; interpret them.</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_config</span><span class="p">)</span>

    <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2">.config.json&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>

    <span class="n">config_file_checksum</span> <span class="o">=</span> <span class="n">Digest</span><span class="o">.</span><span class="n">from_sha256</span><span class="p">(</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">checksum</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span> <span class="n">config_file</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Upload the config file</span>
    <span class="n">upload_blob_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="n">config_file_checksum</span><span class="p">)</span>

    <span class="n">manifest</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mediaType&quot;</span><span class="p">:</span> <span class="n">base_manifest_mediaType</span><span class="p">,</span>
        <span class="s2">&quot;schemaVersion&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;mediaType&quot;</span><span class="p">:</span> <span class="n">base_manifest</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;mediaType&quot;</span><span class="p">],</span>
            <span class="s2">&quot;digest&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_file_checksum</span><span class="p">),</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">config_file</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="o">*</span><span class="p">(</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">base_manifest</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]),</span>
            <span class="o">*</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;mediaType&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span>
                        <span class="k">if</span> <span class="n">use_docker_format</span>
                        <span class="k">else</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;digest&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">checksums</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span><span class="o">.</span><span class="n">compressed_digest</span><span class="p">),</span>
                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">checksums</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">expected_blobs</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="n">checksums</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_docker_format</span> <span class="ow">and</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="c1"># Finally upload the manifest</span>
    <span class="n">upload_manifest_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="p">,</span> <span class="n">manifest</span><span class="o">=</span><span class="n">manifest</span><span class="p">)</span>

    <span class="c1"># delete the config file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_oci_update_base_images</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">base_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImageReference</span><span class="p">],</span>
    <span class="n">target_image</span><span class="p">:</span> <span class="n">ImageReference</span><span class="p">,</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
    <span class="n">base_image_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For a given spec and base image, copy the missing layers of the base image with matching</span>
<span class="sd">    arch to the registry of the target image. If no base image is specified, create a dummy</span>
<span class="sd">    manifest and config file.&quot;&quot;&quot;</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="n">_oci_archspec_to_gooarch</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">architecture</span> <span class="ow">in</span> <span class="n">base_image_cache</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">base_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base_image_cache</span><span class="p">[</span><span class="n">architecture</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">default_manifest</span><span class="p">(),</span>
            <span class="n">default_config</span><span class="p">(</span><span class="n">architecture</span><span class="p">,</span> <span class="s2">&quot;linux&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_image_cache</span><span class="p">[</span><span class="n">architecture</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_missing_layers_with_retry</span><span class="p">(</span>
            <span class="n">base_image</span><span class="p">,</span> <span class="n">target_image</span><span class="p">,</span> <span class="n">architecture</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_oci_push</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">target_image</span><span class="p">:</span> <span class="n">ImageReference</span><span class="p">,</span>
    <span class="n">base_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImageReference</span><span class="p">],</span>
    <span class="n">installed_specs_with_deps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">],</span>
    <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">executor</span><span class="p">:</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Executor</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">],</span>
    <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]],</span>
    <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Blob</span><span class="p">],</span>
    <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Spec</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">]],</span>
<span class="p">]:</span>
    <span class="c1"># Spec dag hash -&gt; blob</span>
    <span class="n">checksums</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Blob</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># arch -&gt; (manifest, config)</span>
    <span class="n">base_images</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Specs not uploaded because they already exist</span>
    <span class="n">skipped</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for existing specs in the buildcache&quot;</span><span class="p">)</span>
        <span class="n">blobs_to_upload</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tags_to_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_image</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">default_tag</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">installed_specs_with_deps</span><span class="p">)</span>
        <span class="n">available_blobs</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_oci_get_blob_info</span><span class="p">,</span> <span class="n">tags_to_check</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">maybe_blob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">installed_specs_with_deps</span><span class="p">,</span> <span class="n">available_blobs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">maybe_blob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">checksums</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span> <span class="o">=</span> <span class="n">maybe_blob</span>
                <span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blobs_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">blobs_to_upload</span> <span class="o">=</span> <span class="n">installed_specs_with_deps</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">blobs_to_upload</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">base_images</span><span class="p">,</span> <span class="n">checksums</span><span class="p">,</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blobs_to_upload</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">installed_specs_with_deps</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blobs_to_upload</span><span class="p">)</span><span class="si">}</span><span class="s2"> specs need to be pushed to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_image</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">target_image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">blob_progress</span> <span class="o">=</span> <span class="n">FancyProgress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blobs_to_upload</span><span class="p">))</span>

    <span class="c1"># Upload blobs</span>
    <span class="n">blob_futures</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_oci_push_pkg_blob</span><span class="p">,</span> <span class="n">target_image</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">blobs_to_upload</span>
    <span class="p">]</span>

    <span class="n">manifests_to_upload</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Spec</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># And update the spec to blob mapping for successful uploads</span>
    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">blob_future</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">blobs_to_upload</span><span class="p">,</span> <span class="n">blob_futures</span><span class="p">):</span>
        <span class="n">blob_progress</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">blob_future</span><span class="o">.</span><span class="n">running</span><span class="p">())</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">blob_future</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blob</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">blob_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">blob_progress</span><span class="o">.</span><span class="n">ok</span><span class="p">(</span>
                <span class="n">_oci_upload_success_msg</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">blob</span><span class="o">.</span><span class="n">compressed_digest</span><span class="p">,</span> <span class="n">blob</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">manifests_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">checksums</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span> <span class="o">=</span> <span class="n">blob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blob_progress</span><span class="o">.</span><span class="n">fail</span><span class="p">()</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spec</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>

    <span class="c1"># Copy base images if necessary</span>
    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">manifests_to_upload</span><span class="p">:</span>
        <span class="n">_oci_update_base_images</span><span class="p">(</span>
            <span class="n">base_image</span><span class="o">=</span><span class="n">base_image</span><span class="p">,</span>
            <span class="n">target_image</span><span class="o">=</span><span class="n">target_image</span><span class="p">,</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
            <span class="n">base_image_cache</span><span class="o">=</span><span class="n">base_images</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">extra_config</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">):</span>
        <span class="n">spec_dict</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="n">ht</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">)</span>
        <span class="n">spec_dict</span><span class="p">[</span><span class="s2">&quot;buildcache_layout_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CURRENT_BUILD_CACHE_LAYOUT_VERSION</span>
        <span class="n">spec_dict</span><span class="p">[</span><span class="s2">&quot;binary_cache_checksum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;hash_algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">checksums</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span><span class="o">.</span><span class="n">compressed_digest</span><span class="o">.</span><span class="n">digest</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">spec_dict</span>

    <span class="c1"># Upload manifests</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Uploading manifests&quot;</span><span class="p">)</span>
    <span class="n">manifest_futures</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
            <span class="n">_oci_put_manifest</span><span class="p">,</span>
            <span class="n">base_images</span><span class="p">,</span>
            <span class="n">checksums</span><span class="p">,</span>
            <span class="n">target_image</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">default_tag</span><span class="p">(</span><span class="n">spec</span><span class="p">)),</span>
            <span class="n">tmpdir</span><span class="p">,</span>
            <span class="n">extra_config</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;org.opencontainers.image.description&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">()},</span>
            <span class="n">spec</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">manifests_to_upload</span>
    <span class="p">]</span>

    <span class="n">manifest_progress</span> <span class="o">=</span> <span class="n">FancyProgress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">manifests_to_upload</span><span class="p">))</span>

    <span class="c1"># Print the image names of the top-level specs</span>
    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">manifest_future</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">manifests_to_upload</span><span class="p">,</span> <span class="n">manifest_futures</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">manifest_future</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
        <span class="n">manifest_progress</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">manifest_future</span><span class="o">.</span><span class="n">running</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">manifest_progress</span><span class="o">.</span><span class="n">ok</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Tagged </span><span class="si">{</span><span class="n">_format_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">target_image</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">default_tag</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">manifest_progress</span><span class="o">.</span><span class="n">fail</span><span class="p">()</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spec</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">base_images</span><span class="p">,</span> <span class="n">checksums</span><span class="p">,</span> <span class="n">errors</span>


<span class="k">def</span> <span class="nf">_oci_config_from_tag</span><span class="p">(</span><span class="n">image_ref_and_tag</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ImageReference</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">image_ref</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">image_ref_and_tag</span>
    <span class="c1"># Don&#39;t allow recursion here, since Spack itself always uploads</span>
    <span class="c1"># vnd.oci.image.manifest.v1+json, not vnd.oci.image.index.v1+json</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">get_manifest_and_config_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="n">tag</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Do very basic validation: if &quot;spec&quot; is a key in the config, it</span>
    <span class="c1"># must be a Spec object too.</span>
    <span class="k">return</span> <span class="n">config</span> <span class="k">if</span> <span class="s2">&quot;spec&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_oci_update_index</span><span class="p">(</span>
    <span class="n">image_ref</span><span class="p">:</span> <span class="n">ImageReference</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pool</span><span class="p">:</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Executor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">list_tags</span><span class="p">(</span><span class="n">image_ref</span><span class="p">)</span>

    <span class="c1"># Fetch all image config files in parallel</span>
    <span class="n">spec_dicts</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">_oci_config_from_tag</span><span class="p">,</span> <span class="p">((</span><span class="n">image_ref</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">tag_is_spec</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Populate the database</span>
    <span class="n">db_root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;db_root&quot;</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">BuildCacheDatabase</span><span class="p">(</span><span class="n">db_root_dir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">spec_dict</span> <span class="ow">in</span> <span class="n">spec_dicts</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">spec_dict</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;in_buildcache&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create the index.json file</span>
    <span class="n">index_json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_write_to_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Create an empty config.json file</span>
    <span class="n">empty_config_json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">empty_config_json_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Upload the index.json file</span>
    <span class="n">index_shasum</span> <span class="o">=</span> <span class="n">Digest</span><span class="o">.</span><span class="n">from_sha256</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">checksum</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span> <span class="n">index_json_path</span><span class="p">))</span>
    <span class="n">upload_blob_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">index_json_path</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="n">index_shasum</span><span class="p">)</span>

    <span class="c1"># Upload the config.json file</span>
    <span class="n">empty_config_digest</span> <span class="o">=</span> <span class="n">Digest</span><span class="o">.</span><span class="n">from_sha256</span><span class="p">(</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">checksum</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span> <span class="n">empty_config_json_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">upload_blob_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">empty_config_json_path</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="n">empty_config_digest</span><span class="p">)</span>

    <span class="c1"># Push a manifest file that references the index.json file as a layer</span>
    <span class="c1"># Notice that we push this as if it is an image, which it of course is not.</span>
    <span class="c1"># When the ORAS spec becomes official, we can use that instead of a fake image.</span>
    <span class="c1"># For now we just use the OCI image spec, so that we don&#39;t run into issues with</span>
    <span class="c1"># automatic garbage collection of blobs that are not referenced by any image manifest.</span>
    <span class="n">oci_manifest</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;schemaVersion&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="c1"># Config is just an empty {} file for now, and irrelevant</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.config.v1+json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;digest&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">empty_config_digest</span><span class="p">),</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">empty_config_json_path</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="c1"># The buildcache index is the only layer, and is not a tarball, we lie here.</span>
        <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;mediaType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;digest&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_shasum</span><span class="p">),</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">index_json_path</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="n">upload_manifest_with_retry</span><span class="p">(</span><span class="n">image_ref</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">default_index_tag</span><span class="p">),</span> <span class="n">oci_manifest</span><span class="p">)</span>


<div class="viewcode-block" id="try_verify">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.try_verify">[docs]</a>
<span class="k">def</span> <span class="nf">try_verify</span><span class="p">(</span><span class="n">specfile_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function to attempt to verify a local file.  Assumes the</span>
<span class="sd">    file is a clearsigned signature file.</span>

<span class="sd">    Args:</span>
<span class="sd">        specfile_path (str): Path to file to be verified.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``True`` if the signature could be verified, ``False`` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">suppress</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:suppress_gpg_warnings&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">specfile_path</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="o">=</span><span class="n">suppress</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="try_fetch">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.try_fetch">[docs]</a>
<span class="k">def</span> <span class="nf">try_fetch</span><span class="p">(</span><span class="n">url_to_fetch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function to try and fetch a file from a url, stage it</span>
<span class="sd">    locally, and return the path to the staged file.</span>

<span class="sd">    Args:</span>
<span class="sd">        url_to_fetch (str): Url pointing to remote resource to fetch</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to locally staged resource or ``None`` if it could not be fetched.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">url_to_fetch</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">FetchError</span><span class="p">:</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">stage</span></div>



<span class="k">def</span> <span class="nf">_delete_staged_downloads</span><span class="p">(</span><span class="n">download_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up stages used to download tarball and specfile&quot;&quot;&quot;</span>
    <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;tarball_stage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
    <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;specfile_stage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_valid_spec_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_supported_layout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read and validate a spec file, returning the spec dict with its layout version, or raising</span>
<span class="sd">    InvalidMetadataFile if invalid.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">binary_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidMetadataFile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such file: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># In the future we may support transparently decompressing compressed spec files.</span>
    <span class="k">if</span> <span class="n">binary_content</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x1f\x8b</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidMetadataFile</span><span class="p">(</span><span class="s2">&quot;Compressed spec files are not supported&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">as_string</span> <span class="o">=</span> <span class="n">binary_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json.sig&quot;</span><span class="p">):</span>
            <span class="n">spec_dict</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">extract_json_from_clearsig</span><span class="p">(</span><span class="n">as_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">as_string</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidMetadataFile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> due to: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="c1"># Ensure this version is not too new.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">layout_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buildcache_layout_version&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidMetadataFile</span><span class="p">(</span><span class="s2">&quot;Could not parse layout version&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">if</span> <span class="n">layout_version</span> <span class="o">&gt;</span> <span class="n">max_supported_layout</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidMetadataFile</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Layout version </span><span class="si">{</span><span class="n">layout_version</span><span class="si">}</span><span class="s2"> is too new for this version of Spack&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">spec_dict</span><span class="p">,</span> <span class="n">layout_version</span>


<div class="viewcode-block" id="download_tarball">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.download_tarball">[docs]</a>
<span class="k">def</span> <span class="nf">download_tarball</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mirrors_for_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download binary tarball for given package into stage area, returning</span>
<span class="sd">    path to downloaded tarball if successful, None otherwise.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec (spack.spec.Spec): Concrete spec</span>
<span class="sd">        unsigned: if ``True`` or ``False`` override the mirror signature verification defaults</span>
<span class="sd">        mirrors_for_spec (list): Optional list of concrete specs and mirrors</span>
<span class="sd">            obtained by calling binary_distribution.get_mirrors_for_spec().</span>
<span class="sd">            These will be checked in order first before looking in other</span>
<span class="sd">            configured mirrors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``None`` if the tarball could not be downloaded (maybe also verified,</span>
<span class="sd">        depending on whether new-style signed binary packages were found).</span>
<span class="sd">        Otherwise, return an object indicating the path to the downloaded</span>
<span class="sd">        tarball, the path to the downloaded specfile (in the case of new-style</span>
<span class="sd">        buildcache), and whether or not the tarball is already verified.</span>

<span class="sd">    .. code-block:: JSON</span>

<span class="sd">       {</span>
<span class="sd">           &quot;tarball_path&quot;: &quot;path-to-locally-saved-tarfile&quot;,</span>
<span class="sd">           &quot;specfile_path&quot;: &quot;none-or-path-to-locally-saved-specfile&quot;,</span>
<span class="sd">           &quot;signature_verified&quot;: &quot;true-if-binary-pkg-was-already-verified&quot;</span>
<span class="sd">       }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">configured_mirrors</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span>
        <span class="n">binary</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">configured_mirrors</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="s2">&quot;Please add a spack mirror to allow download of pre-compiled packages.&quot;</span><span class="p">)</span>

    <span class="n">tarball</span> <span class="o">=</span> <span class="n">tarball_path_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spack&quot;</span><span class="p">)</span>
    <span class="n">specfile_prefix</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spec&quot;</span><span class="p">)</span>

    <span class="c1"># Note on try_first and try_next:</span>
    <span class="c1"># mirrors_for_spec mostly likely came from spack caching remote</span>
    <span class="c1"># mirror indices locally and adding their specs to a local data</span>
    <span class="c1"># structure supporting quick lookup of concrete specs.  Those</span>
    <span class="c1"># mirrors are likely a subset of all configured mirrors, and</span>
    <span class="c1"># we&#39;ll probably find what we need in one of them.  But we&#39;ll</span>
    <span class="c1"># look in all configured mirrors if needed, as maybe the spec</span>
    <span class="c1"># we need was in an un-indexed mirror.  No need to check any</span>
    <span class="c1"># mirror for the spec twice though.</span>
    <span class="n">try_first</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mirrors_for_spec</span><span class="p">]</span> <span class="k">if</span> <span class="n">mirrors_for_spec</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">try_next</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">fetch_url</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">configured_mirrors</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">fetch_url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">try_first</span><span class="p">]</span>
    <span class="n">mirror_urls</span> <span class="o">=</span> <span class="n">try_first</span> <span class="o">+</span> <span class="n">try_next</span>

    <span class="c1"># TODO: turn `mirrors_for_spec` into a list of Mirror instances, instead of doing that here.</span>
    <span class="k">def</span> <span class="nf">fetch_url_to_mirror</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="n">configured_mirrors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span> <span class="o">==</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mirror</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="n">mirrors</span> <span class="o">=</span> <span class="p">[</span><span class="n">fetch_url_to_mirror</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">mirror_urls</span><span class="p">]</span>

    <span class="n">tried_to_verify_sigs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Assumes we care more about finding a spec file by preferred ext</span>
    <span class="c1"># than by mirrory priority.  This can be made less complicated as</span>
    <span class="c1"># we remove support for deprecated spec formats and buildcache layouts.</span>
    <span class="k">for</span> <span class="n">try_signed</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
            <span class="c1"># Override mirror&#39;s default if</span>
            <span class="n">currently_unsigned</span> <span class="o">=</span> <span class="n">unsigned</span> <span class="k">if</span> <span class="n">unsigned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="ow">not</span> <span class="n">mirror</span><span class="o">.</span><span class="n">signed</span>

            <span class="c1"># If it&#39;s an OCI index, do things differently, since we cannot compose URLs.</span>
            <span class="n">fetch_url</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span>

            <span class="c1"># TODO: refactor this to some &quot;nice&quot; place.</span>
            <span class="k">if</span> <span class="n">fetch_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;oci://&quot;</span><span class="p">):</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageReference</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span>
                    <span class="n">fetch_url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;oci://&quot;</span><span class="p">)</span> <span class="p">:]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">default_tag</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>

                <span class="c1"># Fetch the manifest</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span>
                        <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span>
                            <span class="n">url</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">manifest_url</span><span class="p">(),</span>
                            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">manifest_content_type</span><span class="p">)},</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Download the config = spec.json and the relevant tarball</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">manifest</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">spec_digest</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Digest</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;digest&quot;</span><span class="p">])</span>
                    <span class="n">tarball_digest</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Digest</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span>
                        <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;digest&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">with</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">make_stage</span><span class="p">(</span>
                    <span class="n">ref</span><span class="o">.</span><span class="n">blob_url</span><span class="p">(</span><span class="n">spec_digest</span><span class="p">),</span> <span class="n">spec_digest</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">local_specfile_stage</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
                        <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_get_valid_spec_file</span><span class="p">(</span>
                                <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">save_filename</span><span class="p">,</span>
                                <span class="n">CURRENT_BUILD_CACHE_LAYOUT_VERSION</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="n">InvalidMetadataFile</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Ignoring binary package for </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">fetch_url</span><span class="si">}</span><span class="s2"> due to invalid metadata file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">cache_local</span><span class="p">()</span>

                <span class="k">with</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">make_stage</span><span class="p">(</span>
                    <span class="n">ref</span><span class="o">.</span><span class="n">blob_url</span><span class="p">(</span><span class="n">tarball_digest</span><span class="p">),</span> <span class="n">tarball_digest</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">tarball_stage</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tarball_stage</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
                        <span class="n">tarball_stage</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">tarball_stage</span><span class="o">.</span><span class="n">cache_local</span><span class="p">()</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;tarball_stage&quot;</span><span class="p">:</span> <span class="n">tarball_stage</span><span class="p">,</span>
                    <span class="s2">&quot;specfile_stage&quot;</span><span class="p">:</span> <span class="n">local_specfile_stage</span><span class="p">,</span>
                    <span class="s2">&quot;signature_verified&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;signature_required&quot;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">currently_unsigned</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;json.sig&quot;</span> <span class="k">if</span> <span class="n">try_signed</span> <span class="k">else</span> <span class="s2">&quot;json&quot;</span>
                <span class="n">specfile_path</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">fetch_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="n">specfile_prefix</span>
                <span class="p">)</span>
                <span class="n">specfile_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">specfile_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">spackfile_url</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fetch_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="n">tarball</span><span class="p">)</span>
                <span class="n">local_specfile_stage</span> <span class="o">=</span> <span class="n">try_fetch</span><span class="p">(</span><span class="n">specfile_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">local_specfile_stage</span><span class="p">:</span>
                    <span class="n">local_specfile_path</span> <span class="o">=</span> <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">save_filename</span>
                    <span class="n">signature_verified</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_get_valid_spec_file</span><span class="p">(</span>
                            <span class="n">local_specfile_path</span><span class="p">,</span> <span class="n">CURRENT_BUILD_CACHE_LAYOUT_VERSION</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="n">InvalidMetadataFile</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Ignoring binary package for </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">fetch_url</span><span class="si">}</span><span class="s2"> due to invalid metadata file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">try_signed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">currently_unsigned</span><span class="p">:</span>
                        <span class="c1"># If we found a signed specfile at the root, try to verify</span>
                        <span class="c1"># the signature immediately.  We will not download the</span>
                        <span class="c1"># tarball if we could not verify the signature.</span>
                        <span class="n">tried_to_verify_sigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">specfile_url</span><span class="p">)</span>
                        <span class="n">signature_verified</span> <span class="o">=</span> <span class="n">try_verify</span><span class="p">(</span><span class="n">local_specfile_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">signature_verified</span><span class="p">:</span>
                            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to verify: </span><span class="si">{</span><span class="n">specfile_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">currently_unsigned</span> <span class="ow">or</span> <span class="n">signature_verified</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">try_signed</span><span class="p">:</span>
                        <span class="c1"># We will download the tarball in one of three cases:</span>
                        <span class="c1">#     1. user asked for --no-check-signature</span>
                        <span class="c1">#     2. user didn&#39;t ask for --no-check-signature, but we</span>
                        <span class="c1">#     found a spec.json.sig and verified the signature already</span>
                        <span class="c1">#     3. neither of the first two cases are true, but this file</span>
                        <span class="c1">#     is *not* a signed json (not a spec.json.sig file).  That</span>
                        <span class="c1">#     means we already looked at all the mirrors and either didn&#39;t</span>
                        <span class="c1">#     find any .sig files or couldn&#39;t verify any of them.  But it</span>
                        <span class="c1">#     is still possible to find an old style binary package where</span>
                        <span class="c1">#     the signature is a detached .asc file in the outer archive</span>
                        <span class="c1">#     of the tarball, and in that case, the only way to know is to</span>
                        <span class="c1">#     download the tarball.  This is a deprecated use case, so if</span>
                        <span class="c1">#     something goes wrong during the extraction process (can&#39;t</span>
                        <span class="c1">#     verify signature, checksum doesn&#39;t match) we will fail at</span>
                        <span class="c1">#     that point instead of trying to download more tarballs from</span>
                        <span class="c1">#     the remaining mirrors, looking for one we can use.</span>
                        <span class="n">tarball_stage</span> <span class="o">=</span> <span class="n">try_fetch</span><span class="p">(</span><span class="n">spackfile_url</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tarball_stage</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">{</span>
                                <span class="s2">&quot;tarball_stage&quot;</span><span class="p">:</span> <span class="n">tarball_stage</span><span class="p">,</span>
                                <span class="s2">&quot;specfile_stage&quot;</span><span class="p">:</span> <span class="n">local_specfile_stage</span><span class="p">,</span>
                                <span class="s2">&quot;signature_verified&quot;</span><span class="p">:</span> <span class="n">signature_verified</span><span class="p">,</span>
                                <span class="s2">&quot;signature_required&quot;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">currently_unsigned</span><span class="p">,</span>
                            <span class="p">}</span>

                    <span class="n">local_specfile_stage</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="c1"># Falling through the nested loops meeans we exhaustively searched</span>
    <span class="c1"># for all known kinds of spec files on all mirrors and did not find</span>
    <span class="c1"># an acceptable one for which we could download a tarball.</span>

    <span class="k">if</span> <span class="n">tried_to_verify_sigs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoVerifyException</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;Spack found new style signed binary packages, &quot;</span>
                <span class="s2">&quot;but was unable to verify any of them.  Please &quot;</span>
                <span class="s2">&quot;obtain and trust the correct public key.  If &quot;</span>
                <span class="s2">&quot;these are public spack binaries, please see the &quot;</span>
                <span class="s2">&quot;spack docs for locations where keys can be found.&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="dedupe_hardlinks_if_necessary">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.dedupe_hardlinks_if_necessary">[docs]</a>
<span class="k">def</span> <span class="nf">dedupe_hardlinks_if_necessary</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">buildinfo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates a buildinfo dict for old archives that did</span>
<span class="sd">    not dedupe hardlinks. De-duping hardlinks is necessary</span>
<span class="sd">    when relocating files in parallel and in-place. This</span>
<span class="sd">    means we must preserve inodes when relocating.&quot;&quot;&quot;</span>

    <span class="c1"># New archives don&#39;t need this.</span>
    <span class="k">if</span> <span class="n">buildinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hardlinks_deduped&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># Clearly we can assume that an inode is either in the</span>
    <span class="c1"># textfile or binary group, but let&#39;s just stick to</span>
    <span class="c1"># a single set of visited nodes.</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Note: we do *not* dedupe hardlinked symlinks, since</span>
    <span class="c1"># it seems difficult or even impossible to relink</span>
    <span class="c1"># symlinks while preserving inode.</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;relocate_textfiles&quot;</span><span class="p">,</span> <span class="s2">&quot;relocate_binaries&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rel_path</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">stat_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">))</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat_result</span><span class="o">.</span><span class="n">st_dev</span><span class="p">,</span> <span class="n">stat_result</span><span class="o">.</span><span class="n">st_ino</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat_result</span><span class="o">.</span><span class="n">st_nlink</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>
        <span class="n">buildinfo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_list</span></div>



<div class="viewcode-block" id="relocate_package">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.relocate_package">[docs]</a>
<span class="k">def</span> <span class="nf">relocate_package</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Relocate the given package</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">buildinfo</span> <span class="o">=</span> <span class="n">read_buildinfo_file</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
    <span class="n">new_layout_root</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
    <span class="n">new_prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">new_rel_prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">new_prefix</span><span class="p">,</span> <span class="n">new_layout_root</span><span class="p">))</span>
    <span class="n">new_spack_prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

    <span class="n">old_sbang_install_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;sbang_install_path&quot;</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="p">:</span>
        <span class="n">old_sbang_install_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buildinfo</span><span class="p">[</span><span class="s2">&quot;sbang_install_path&quot;</span><span class="p">])</span>
    <span class="n">old_layout_root</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buildinfo</span><span class="p">[</span><span class="s2">&quot;buildpath&quot;</span><span class="p">])</span>
    <span class="n">old_spack_prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buildinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spackprefix&quot;</span><span class="p">))</span>
    <span class="n">old_rel_prefix</span> <span class="o">=</span> <span class="n">buildinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative_prefix&quot;</span><span class="p">)</span>
    <span class="n">old_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">old_layout_root</span><span class="p">,</span> <span class="n">old_rel_prefix</span><span class="p">)</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">buildinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative_rpaths&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># In the past prefix_to_hash was the default and externals were not dropped, so prefixes</span>
    <span class="c1"># were not unique.</span>
    <span class="k">if</span> <span class="s2">&quot;hash_to_prefix&quot;</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="p">:</span>
        <span class="n">hash_to_old_prefix</span> <span class="o">=</span> <span class="n">buildinfo</span><span class="p">[</span><span class="s2">&quot;hash_to_prefix&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;prefix_to_hash&quot;</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="p">:</span>
        <span class="n">hash_to_old_prefix</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="p">[</span><span class="s2">&quot;prefix_to_hash&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hash_to_old_prefix</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">old_rel_prefix</span> <span class="o">!=</span> <span class="n">new_rel_prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hash_to_old_prefix</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Package tarball was created from an install &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;prefix with a different directory layout and an older &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;buildcache create implementation. It cannot be relocated.&quot;</span>
        <span class="k">raise</span> <span class="n">NewLayoutException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Spurious replacements (e.g. sbang) will cause issues with binaries</span>
    <span class="c1"># For example, the new sbang can be longer than the old one.</span>
    <span class="c1"># Hence 2 dictionaries are maintained here.</span>
    <span class="n">prefix_to_prefix_text</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">prefix_to_prefix_bin</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">old_sbang_install_path</span><span class="p">:</span>
        <span class="n">install_path</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">sbang</span><span class="o">.</span><span class="n">sbang_install_path</span><span class="p">()</span>
        <span class="n">prefix_to_prefix_text</span><span class="p">[</span><span class="n">old_sbang_install_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">install_path</span>

    <span class="c1"># First match specific prefix paths. Possibly the *local* install prefix</span>
    <span class="c1"># of some dependency is in an upstream, so we cannot assume the original</span>
    <span class="c1"># spack store root can be mapped uniformly to the new spack store root.</span>
    <span class="c1">#</span>
    <span class="c1"># If the spec is spliced, we need to handle the simultaneous mapping</span>
    <span class="c1"># from the old install_tree to the new install_tree and from the build_spec</span>
    <span class="c1"># to the spliced spec.</span>
    <span class="c1"># Because foo.build_spec is foo for any non-spliced spec, we can simplify</span>
    <span class="c1"># by checking for spliced-in nodes by checking for nodes not in the build_spec</span>
    <span class="c1"># without any explicit check for whether the spec is spliced.</span>
    <span class="c1"># An analog in this algorithm is any spec that shares a name or provides the same virtuals</span>
    <span class="c1"># in the context of the relevant root spec. This ensures that the analog for a spec s</span>
    <span class="c1"># is the spec that s replaced when we spliced.</span>
    <span class="n">relocation_specs</span> <span class="o">=</span> <span class="n">deps_to_relocate</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">build_spec_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">ALL</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">relocation_specs</span><span class="p">:</span>
        <span class="n">analog</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">build_spec_ids</span><span class="p">:</span>
            <span class="n">analogs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">d</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">ALL</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_splice_match</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">self_root</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">other_root</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">analogs</span><span class="p">:</span>
                <span class="c1"># Prefer same-name analogs and prefer higher versions</span>
                <span class="c1"># This matches the preferences in Spec.splice, so we will find same node</span>
                <span class="n">analog</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">analogs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

        <span class="n">lookup_dag_hash</span> <span class="o">=</span> <span class="n">analog</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lookup_dag_hash</span> <span class="ow">in</span> <span class="n">hash_to_old_prefix</span><span class="p">:</span>
            <span class="n">old_dep_prefix</span> <span class="o">=</span> <span class="n">hash_to_old_prefix</span><span class="p">[</span><span class="n">lookup_dag_hash</span><span class="p">]</span>
            <span class="n">prefix_to_prefix_bin</span><span class="p">[</span><span class="n">old_dep_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">prefix_to_prefix_text</span><span class="p">[</span><span class="n">old_dep_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

    <span class="c1"># Only then add the generic fallback of install prefix -&gt; install prefix.</span>
    <span class="n">prefix_to_prefix_text</span><span class="p">[</span><span class="n">old_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_prefix</span>
    <span class="n">prefix_to_prefix_bin</span><span class="p">[</span><span class="n">old_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_prefix</span>
    <span class="n">prefix_to_prefix_text</span><span class="p">[</span><span class="n">old_layout_root</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_layout_root</span>
    <span class="n">prefix_to_prefix_bin</span><span class="p">[</span><span class="n">old_layout_root</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_layout_root</span>

    <span class="c1"># This is vestigial code for the *old* location of sbang. Previously,</span>
    <span class="c1"># sbang was a bash script, and it lived in the spack prefix. It is</span>
    <span class="c1"># now a POSIX script that lives in the install prefix. Old packages</span>
    <span class="c1"># will have the old sbang location in their shebangs.</span>
    <span class="n">orig_sbang</span> <span class="o">=</span> <span class="s2">&quot;#!/bin/bash </span><span class="si">{0}</span><span class="s2">/bin/sbang&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_spack_prefix</span><span class="p">)</span>
    <span class="n">new_sbang</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">sbang</span><span class="o">.</span><span class="n">sbang_shebang_line</span><span class="p">()</span>
    <span class="n">prefix_to_prefix_text</span><span class="p">[</span><span class="n">orig_sbang</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_sbang</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Relocating package from&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_layout_root</span><span class="p">,</span> <span class="n">new_layout_root</span><span class="p">))</span>

    <span class="c1"># Old archives maybe have hardlinks repeated.</span>
    <span class="n">dedupe_hardlinks_if_necessary</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">buildinfo</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_backup_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>

    <span class="c1"># Text files containing the prefix text</span>
    <span class="n">text_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="p">[</span><span class="s2">&quot;relocate_textfiles&quot;</span><span class="p">]:</span>
        <span class="n">text_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="c1"># Don&#39;t add backup files generated by filter_file during install step.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_backup_file</span><span class="p">(</span><span class="n">text_name</span><span class="p">):</span>
            <span class="n">text_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text_name</span><span class="p">)</span>

    <span class="c1"># If we are not installing back to the same install tree do the relocation</span>
    <span class="k">if</span> <span class="n">old_prefix</span> <span class="o">!=</span> <span class="n">new_prefix</span><span class="p">:</span>
        <span class="n">files_to_relocate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relocate_binaries&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># If the buildcache was not created with relativized rpaths</span>
        <span class="c1"># do the relocation of path in binaries</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;macho&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">binary_formats</span><span class="p">:</span>
            <span class="n">relocate</span><span class="o">.</span><span class="n">relocate_macho_binaries</span><span class="p">(</span>
                <span class="n">files_to_relocate</span><span class="p">,</span>
                <span class="n">old_layout_root</span><span class="p">,</span>
                <span class="n">new_layout_root</span><span class="p">,</span>
                <span class="n">prefix_to_prefix_bin</span><span class="p">,</span>
                <span class="n">rel</span><span class="p">,</span>
                <span class="n">old_prefix</span><span class="p">,</span>
                <span class="n">new_prefix</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;elf&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">binary_formats</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rel</span><span class="p">:</span>
            <span class="c1"># The new ELF dynamic section relocation logic only handles absolute to</span>
            <span class="c1"># absolute relocation.</span>
            <span class="n">relocate</span><span class="o">.</span><span class="n">new_relocate_elf_binaries</span><span class="p">(</span><span class="n">files_to_relocate</span><span class="p">,</span> <span class="n">prefix_to_prefix_bin</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;elf&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">binary_formats</span> <span class="ow">and</span> <span class="n">rel</span><span class="p">:</span>
            <span class="n">relocate</span><span class="o">.</span><span class="n">relocate_elf_binaries</span><span class="p">(</span>
                <span class="n">files_to_relocate</span><span class="p">,</span>
                <span class="n">old_layout_root</span><span class="p">,</span>
                <span class="n">new_layout_root</span><span class="p">,</span>
                <span class="n">prefix_to_prefix_bin</span><span class="p">,</span>
                <span class="n">rel</span><span class="p">,</span>
                <span class="n">old_prefix</span><span class="p">,</span>
                <span class="n">new_prefix</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Relocate links to the new install prefix</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">buildinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relocate_links&quot;</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="n">relocate</span><span class="o">.</span><span class="n">relocate_links</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">prefix_to_prefix_bin</span><span class="p">)</span>

        <span class="c1"># For all buildcaches</span>
        <span class="c1"># relocate the install prefixes in text files including dependencies</span>
        <span class="n">relocate</span><span class="o">.</span><span class="n">relocate_text</span><span class="p">(</span><span class="n">text_names</span><span class="p">,</span> <span class="n">prefix_to_prefix_text</span><span class="p">)</span>

        <span class="c1"># relocate the install prefixes in binary files including dependencies</span>
        <span class="n">changed_files</span> <span class="o">=</span> <span class="n">relocate</span><span class="o">.</span><span class="n">relocate_text_bin</span><span class="p">(</span><span class="n">files_to_relocate</span><span class="p">,</span> <span class="n">prefix_to_prefix_bin</span><span class="p">)</span>

        <span class="c1"># Add ad-hoc signatures to patched macho files when on macOS.</span>
        <span class="k">if</span> <span class="s2">&quot;macho&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">binary_formats</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
            <span class="n">codesign</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;codesign&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">codesign</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">binary</span> <span class="ow">in</span> <span class="n">changed_files</span><span class="p">:</span>
                <span class="c1"># preserve the original inode by running codesign on a copy</span>
                <span class="k">with</span> <span class="n">fsys</span><span class="o">.</span><span class="n">edit_in_place_through_temporary_file</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_binary</span><span class="p">:</span>
                    <span class="n">codesign</span><span class="p">(</span><span class="s2">&quot;-fs-&quot;</span><span class="p">,</span> <span class="n">tmp_binary</span><span class="p">)</span>

    <span class="c1"># If we are installing back to the same location</span>
    <span class="c1"># relocate the sbang location if the spack directory changed</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">old_spack_prefix</span> <span class="o">!=</span> <span class="n">new_spack_prefix</span><span class="p">:</span>
            <span class="n">relocate</span><span class="o">.</span><span class="n">relocate_text</span><span class="p">(</span><span class="n">text_names</span><span class="p">,</span> <span class="n">prefix_to_prefix_text</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_extract_inner_tarball</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">extract_to</span><span class="p">,</span> <span class="n">signature_required</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">remote_checksum</span><span class="p">):</span>
    <span class="n">stagepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">spackfile_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spack&quot;</span><span class="p">)</span>
    <span class="n">spackfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stagepath</span><span class="p">,</span> <span class="n">spackfile_name</span><span class="p">)</span>
    <span class="n">tarfile_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.tar.gz&quot;</span><span class="p">)</span>
    <span class="n">tarfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_to</span><span class="p">,</span> <span class="n">tarfile_name</span><span class="p">)</span>
    <span class="n">json_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json&quot;</span><span class="p">)</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_to</span><span class="p">,</span> <span class="n">json_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">spackfile_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_to</span><span class="p">)</span>
    <span class="c1"># some buildcache tarfiles use bzip2 compression</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">):</span>
        <span class="n">tarfile_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.tar.bz2&quot;</span><span class="p">)</span>
        <span class="n">tarfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_to</span><span class="p">,</span> <span class="n">tarfile_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_path</span><span class="p">):</span>
        <span class="n">specfile_path</span> <span class="o">=</span> <span class="n">json_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find spec file for </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extract_to</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">signature_required</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.asc&quot;</span> <span class="o">%</span> <span class="n">specfile_path</span><span class="p">):</span>
            <span class="n">suppress</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:suppress_gpg_warnings&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.asc&quot;</span> <span class="o">%</span> <span class="n">specfile_path</span><span class="p">,</span> <span class="n">specfile_path</span><span class="p">,</span> <span class="n">suppress</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoVerifyException</span><span class="p">(</span>
                    <span class="s2">&quot;Spack was unable to verify package &quot;</span>
                    <span class="s2">&quot;signature, please obtain and trust the &quot;</span>
                    <span class="s2">&quot;correct public key.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsignedPackageException</span><span class="p">(</span>
                <span class="s2">&quot;To install unsigned packages, use the --no-check-signature option.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># compute the sha256 checksum of the tarball</span>
    <span class="n">local_checksum</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">checksum</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span> <span class="n">tarfile_path</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">remote_checksum</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span>

    <span class="c1"># if the checksums don&#39;t match don&#39;t install</span>
    <span class="k">if</span> <span class="n">local_checksum</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">fsys</span><span class="o">.</span><span class="n">filesummary</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">NoChecksumException</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">local_checksum</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tarfile_path</span>


<span class="k">def</span> <span class="nf">_tar_strip_component</span><span class="p">(</span><span class="n">tar</span><span class="p">:</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield all members of tarfile that start with given prefix, and strip that prefix (including</span>
<span class="sd">    symlinks)&quot;&quot;&quot;</span>
    <span class="c1"># Including trailing /, otherwise we end up with absolute paths.</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span><span class="p">)</span>

    <span class="c1"># Only yield members in the package prefix.</span>
    <span class="c1"># Note: when a tarfile is created, relative in-prefix symlinks are</span>
    <span class="c1"># expanded to matching member names of tarfile entries. So, we have</span>
    <span class="c1"># to ensure that those are updated too.</span>
    <span class="c1"># Absolute symlinks are copied verbatim -- relocation should take care of</span>
    <span class="c1"># them.</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">linkname</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">linkname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">linkname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">linkname</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="p">:]</span>
        <span class="k">yield</span> <span class="n">m</span>


<div class="viewcode-block" id="extract_tarball">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.extract_tarball">[docs]</a>
<span class="k">def</span> <span class="nf">extract_tarball</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">download_result</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="n">timer</span><span class="o">.</span><span class="n">NULL_TIMER</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    extract binary tarball for given package into install area</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoOverwriteException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>

    <span class="c1"># Create the install prefix</span>
    <span class="n">fsys</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">get_package_dir_permissions</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span>
        <span class="n">group</span><span class="o">=</span><span class="n">get_package_group</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span>
        <span class="n">default_perms</span><span class="o">=</span><span class="s2">&quot;parents&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">specfile_path</span> <span class="o">=</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;specfile_stage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save_filename</span>
    <span class="n">spec_dict</span><span class="p">,</span> <span class="n">layout_version</span> <span class="o">=</span> <span class="n">_get_valid_spec_file</span><span class="p">(</span>
        <span class="n">specfile_path</span><span class="p">,</span> <span class="n">CURRENT_BUILD_CACHE_LAYOUT_VERSION</span>
    <span class="p">)</span>
    <span class="n">bchecksum</span> <span class="o">=</span> <span class="n">spec_dict</span><span class="p">[</span><span class="s2">&quot;binary_cache_checksum&quot;</span><span class="p">]</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;tarball_stage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save_filename</span>
    <span class="n">signature_verified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;signature_verified&quot;</span><span class="p">]</span>
    <span class="n">signature_required</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;signature_required&quot;</span><span class="p">]</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">layout_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Handle the older buildcache layout where the .spack file</span>
        <span class="c1"># contains a spec json, maybe an .asc file (signature),</span>
        <span class="c1"># and another tarball containing the actual install tree.</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tarfile_path</span> <span class="o">=</span> <span class="n">_extract_inner_tarball</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">,</span> <span class="n">signature_required</span><span class="p">,</span> <span class="n">bchecksum</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_delete_staged_downloads</span><span class="p">(</span><span class="n">download_result</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">layout_version</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Newer buildcache layout: the .spack file contains just</span>
        <span class="c1"># in the install tree, the signature, if it exists, is</span>
        <span class="c1"># wrapped around the spec.json at the root.  If sig verify</span>
        <span class="c1"># was required, it was already done before downloading</span>
        <span class="c1"># the tarball.</span>
        <span class="n">tarfile_path</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="n">signature_required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">signature_verified</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsignedPackageException</span><span class="p">(</span>
                <span class="s2">&quot;To install unsigned packages, use the --no-check-signature option, &quot;</span>
                <span class="s2">&quot;or configure the mirror with signed: false.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># compute the sha256 checksum of the tarball</span>
        <span class="n">local_checksum</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">checksum</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span> <span class="n">tarfile_path</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">bchecksum</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span>

        <span class="c1"># if the checksums don&#39;t match don&#39;t install</span>
        <span class="k">if</span> <span class="n">local_checksum</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">size</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">fsys</span><span class="o">.</span><span class="n">filesummary</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">)</span>
            <span class="n">_delete_staged_downloads</span><span class="p">(</span><span class="n">download_result</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoChecksumException</span><span class="p">(</span>
                <span class="n">tarfile_path</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">local_checksum</span>
            <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="c1"># Remove install prefix from tarfil to extract directly into spec.prefix</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">members</span><span class="o">=</span><span class="n">_tar_strip_component</span><span class="p">(</span><span class="n">tar</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">_ensure_common_prefix</span><span class="p">(</span><span class="n">tar</span><span class="p">)),</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_delete_staged_downloads</span><span class="p">(</span><span class="n">download_result</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tarfile_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">specfile_path</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">)</span>

    <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;relocate&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">relocate_package</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">manifest_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">,</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">manifest_file_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">):</span>
            <span class="n">spec_id</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">/</span><span class="si">{hash:7}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No manifest file in tarball for spec </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spec_id</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tmpdir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">_delete_staged_downloads</span><span class="p">(</span><span class="n">download_result</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;relocate&quot;</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_ensure_common_prefix</span><span class="p">(</span><span class="n">tar</span><span class="p">:</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># Find the lowest `binary_distribution` file (hard-coded forward slash is on purpose).</span>
    <span class="n">binary_distribution</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">e</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">isfile</span><span class="p">()</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.spack/binary_distribution&quot;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">binary_distribution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tarball is not a Spack package, missing binary_distribution file&quot;</span><span class="p">)</span>

    <span class="n">pkg_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">binary_distribution</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>

    <span class="c1"># Even the most ancient Spack version has required to list the dir of the package itself, so</span>
    <span class="c1"># guard against broken tarballs where `path.parent.parent` is empty.</span>
    <span class="k">if</span> <span class="n">pkg_path</span> <span class="o">==</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid tarball, missing package prefix dir&quot;</span><span class="p">)</span>

    <span class="n">pkg_prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg_path</span><span class="p">)</span>

    <span class="c1"># Ensure all tar entries are in the pkg_prefix dir, and if they&#39;re not, they should be parent</span>
    <span class="c1"># dirs of it.</span>
    <span class="n">has_prefix</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
        <span class="n">stripped</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pkg_prefix</span><span class="p">)</span> <span class="ow">or</span> <span class="n">member</span><span class="o">.</span><span class="n">isdir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">pkg_prefix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tarball contains file </span><span class="si">{</span><span class="n">stripped</span><span class="si">}</span><span class="s2"> outside of prefix </span><span class="si">{</span><span class="n">pkg_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">isdir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">stripped</span> <span class="o">==</span> <span class="n">pkg_prefix</span><span class="p">:</span>
            <span class="n">has_prefix</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># This is technically not required, but let&#39;s be defensive about the existence of the package</span>
    <span class="c1"># prefix dir.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_prefix</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tarball does not contain a common prefix </span><span class="si">{</span><span class="n">pkg_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pkg_prefix</span>


<div class="viewcode-block" id="install_root_node">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.install_root_node">[docs]</a>
<span class="k">def</span> <span class="nf">install_root_node</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span>
    <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sha256</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">allow_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Install the root node of a concrete spec from a buildcache.</span>

<span class="sd">    Checking the sha256 sum of a node before installation is usually needed only</span>
<span class="sd">    for software installed during Spack&#39;s bootstrapping (since we might not have</span>
<span class="sd">    a proper signature verification mechanism available).</span>

<span class="sd">    Args:</span>
<span class="sd">        spec: spec to be installed (note that only the root node will be installed)</span>
<span class="sd">        unsigned: if True allows installing unsigned binaries</span>
<span class="sd">        force: force installation if the spec is already present in the local store</span>
<span class="sd">        sha256: optional sha256 of the binary package, to be checked before installation</span>
<span class="sd">        allow_missing: when true, allows installing a node with missing dependencies</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Early termination</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">virtual</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Skipping external or virtual package </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">()))</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">installed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Package for spec </span><span class="si">{0}</span><span class="s2"> already installed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">()))</span>
        <span class="k">return</span>

    <span class="n">download_result</span> <span class="o">=</span> <span class="n">download_tarball</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">download_result</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;download of binary cache file for spec &quot;</span><span class="si">{0}</span><span class="s1">&quot; failed&#39;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="o">.</span><span class="n">format</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">sha256</span><span class="p">:</span>
        <span class="n">checker</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Checker</span><span class="p">(</span><span class="n">sha256</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;cannot verify checksum for &quot;</span><span class="si">{0}</span><span class="s1">&quot; [expected=</span><span class="si">{1}</span><span class="s1">]&#39;</span>
        <span class="n">tarball_path</span> <span class="o">=</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;tarball_stage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save_filename</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tarball_path</span><span class="p">,</span> <span class="n">sha256</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checker</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">tarball_path</span><span class="p">):</span>
            <span class="n">size</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">fsys</span><span class="o">.</span><span class="n">filesummary</span><span class="p">(</span><span class="n">tarball_path</span><span class="p">)</span>
            <span class="n">_delete_staged_downloads</span><span class="p">(</span><span class="n">download_result</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoChecksumException</span><span class="p">(</span>
                <span class="n">tarball_path</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">checker</span><span class="o">.</span><span class="n">hash_name</span><span class="p">,</span> <span class="n">sha256</span><span class="p">,</span> <span class="n">checker</span><span class="o">.</span><span class="n">sum</span>
            <span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Verified SHA256 checksum of the build cache&quot;</span><span class="p">)</span>

    <span class="c1"># don&#39;t print long padded paths while extracting/relocating binaries</span>
    <span class="k">with</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">filter_padding</span><span class="p">():</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;Installing &quot;</span><span class="si">{0}</span><span class="s1">&quot; from a buildcache&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">()))</span>
        <span class="n">extract_tarball</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">download_result</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">windows_establish_runtime_linkage</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">spliced</span><span class="p">:</span>  <span class="c1"># overwrite old metadata with new</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">write_spec</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">spec_file_path</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">post_install</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">allow_missing</span><span class="o">=</span><span class="n">allow_missing</span><span class="p">)</span></div>



<div class="viewcode-block" id="install_single_spec">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.install_single_spec">[docs]</a>
<span class="k">def</span> <span class="nf">install_single_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Install a single concrete spec from a buildcache.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec (spack.spec.Spec): spec to be installed</span>
<span class="sd">        unsigned (bool): if True allows installing unsigned binaries</span>
<span class="sd">        force (bool): force installation if the spec is already present in the</span>
<span class="sd">            local store</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)):</span>
        <span class="n">install_root_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">unsigned</span><span class="o">=</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span></div>



<div class="viewcode-block" id="try_direct_fetch">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.try_direct_fetch">[docs]</a>
<span class="k">def</span> <span class="nf">try_direct_fetch</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">mirrors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to find the spec directly on the configured mirrors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">specfile_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json&quot;</span><span class="p">)</span>
    <span class="n">signed_specfile_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json.sig&quot;</span><span class="p">)</span>
    <span class="n">specfile_is_signed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">found_specs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">binary_mirrors</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">mirrors</span><span class="o">=</span><span class="n">mirrors</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="n">binary_mirrors</span><span class="p">:</span>
        <span class="n">buildcache_fetch_url_json</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="n">specfile_name</span>
        <span class="p">)</span>
        <span class="n">buildcache_fetch_url_signed_json</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="n">signed_specfile_name</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">read_from_url</span><span class="p">(</span><span class="n">buildcache_fetch_url_signed_json</span><span class="p">)</span>
            <span class="n">specfile_is_signed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SpackWebError</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">read_from_url</span><span class="p">(</span><span class="n">buildcache_fetch_url_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SpackWebError</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Did not find </span><span class="si">{</span><span class="n">specfile_name</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">buildcache_fetch_url_signed_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">e1</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Did not find </span><span class="si">{</span><span class="n">specfile_name</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">buildcache_fetch_url_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
                <span class="k">continue</span>
        <span class="n">specfile_contents</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">fs</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># read the spec from the build cache file. All specs in build caches</span>
        <span class="c1"># are concrete (as they are built) so we need to mark this spec</span>
        <span class="c1"># concrete on read-in.</span>
        <span class="k">if</span> <span class="n">specfile_is_signed</span><span class="p">:</span>
            <span class="n">specfile_json</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">extract_json_from_clearsig</span><span class="p">(</span><span class="n">specfile_contents</span><span class="p">)</span>
            <span class="n">fetched_spec</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">specfile_json</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fetched_spec</span> <span class="o">=</span> <span class="n">Spec</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">specfile_contents</span><span class="p">)</span>
        <span class="n">fetched_spec</span><span class="o">.</span><span class="n">_mark_concrete</span><span class="p">()</span>

        <span class="n">found_specs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">:</span> <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">,</span> <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="n">fetched_spec</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">found_specs</span></div>



<div class="viewcode-block" id="get_mirrors_for_spec">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.get_mirrors_for_spec">[docs]</a>
<span class="k">def</span> <span class="nf">get_mirrors_for_spec</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mirrors_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if concrete spec exists on mirrors and return a list</span>
<span class="sd">    indicating the mirrors on which it can be found</span>

<span class="sd">    Args:</span>
<span class="sd">        spec (spack.spec.Spec): The spec to look for in binary mirrors</span>
<span class="sd">        mirrors_to_check (dict): Optionally override the configured mirrors</span>
<span class="sd">            with the mirrors in this dictionary.</span>
<span class="sd">        index_only (bool): When ``index_only`` is set to ``True``, only the local</span>
<span class="sd">            cache is checked, no requests are made.</span>

<span class="sd">    Return:</span>
<span class="sd">        A list of objects, each containing a ``mirror_url`` and ``spec`` key</span>
<span class="sd">            indicating all mirrors where the spec can be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">mirrors</span><span class="o">=</span><span class="n">mirrors_to_check</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No Spack mirrors are currently configured&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">BINARY_INDEX</span><span class="o">.</span><span class="n">find_built_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">mirrors_to_check</span><span class="o">=</span><span class="n">mirrors_to_check</span><span class="p">)</span>

    <span class="c1"># The index may be out-of-date. If we aren&#39;t only considering indices, try</span>
    <span class="c1"># to fetch directly since we know where the file should be.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">index_only</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">try_direct_fetch</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">mirrors</span><span class="o">=</span><span class="n">mirrors_to_check</span><span class="p">)</span>
        <span class="c1"># We found a spec by the direct fetch approach, we might as well</span>
        <span class="c1"># add it to our mapping.</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">BINARY_INDEX</span><span class="o">.</span><span class="n">update_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="update_cache_and_get_specs">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.update_cache_and_get_specs">[docs]</a>
<span class="k">def</span> <span class="nf">update_cache_and_get_specs</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all concrete specs for build caches available on configured mirrors.</span>
<span class="sd">    Initialization of internal cache data structures is done as lazily as</span>
<span class="sd">    possible, so this method will also attempt to initialize and update the</span>
<span class="sd">    local index cache (essentially a no-op if it has been done already and</span>
<span class="sd">    nothing has changed on the configured mirrors.)</span>

<span class="sd">    Throws:</span>
<span class="sd">        FetchCacheError</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">BINARY_INDEX</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">BINARY_INDEX</span><span class="o">.</span><span class="n">get_all_built_specs</span><span class="p">()</span></div>



<div class="viewcode-block" id="clear_spec_cache">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.clear_spec_cache">[docs]</a>
<span class="k">def</span> <span class="nf">clear_spec_cache</span><span class="p">():</span>
    <span class="n">BINARY_INDEX</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_keys">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.get_keys">[docs]</a>
<span class="k">def</span> <span class="nf">get_keys</span><span class="p">(</span><span class="n">install</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mirrors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get pgp public keys available on mirror with suffix .pub&quot;&quot;&quot;</span>
    <span class="n">mirror_collection</span> <span class="o">=</span> <span class="n">mirrors</span> <span class="ow">or</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mirror_collection</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="s2">&quot;Please add a spack mirror to allow &quot;</span> <span class="o">+</span> <span class="s2">&quot;download of build caches.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="n">mirror_collection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">fetch_url</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span>
        <span class="c1"># TODO: oci:// does not support signing.</span>
        <span class="k">if</span> <span class="n">fetch_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;oci://&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">keys_url</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">fetch_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="n">BUILD_CACHE_KEYS_RELATIVE_PATH</span>
        <span class="p">)</span>
        <span class="n">keys_index</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys_url</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Finding public keys in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_util</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fetch_url</span><span class="p">)))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">json_file</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">read_from_url</span><span class="p">(</span><span class="n">keys_index</span><span class="p">)</span>
            <span class="n">json_index</span> <span class="o">=</span> <span class="n">sjson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">json_file</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SpackWebError</span> <span class="k">as</span> <span class="n">url_err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">web_util</span><span class="o">.</span><span class="n">url_exists</span><span class="p">(</span><span class="n">keys_index</span><span class="p">):</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to find public keys in </span><span class="si">{</span><span class="n">url_util</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fetch_url</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; caught exception attempting to read from </span><span class="si">{</span><span class="n">url_util</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keys_index</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url_err</span><span class="p">)</span>

            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">fingerprint</span><span class="p">,</span> <span class="n">key_attributes</span> <span class="ow">in</span> <span class="n">json_index</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys_url</span><span class="p">,</span> <span class="n">fingerprint</span> <span class="o">+</span> <span class="s2">&quot;.pub&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">Stage</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;build_cache&quot;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">stage</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">save_filename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">force</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">save_filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">save_filename</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">stage</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">FetchError</span><span class="p">:</span>
                        <span class="k">continue</span>

            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found key </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fingerprint</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">install</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trust</span><span class="p">:</span>
                    <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">trust</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">save_filename</span><span class="p">)</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added this key to trusted keys.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Will not add this key to trusted keys.&quot;</span>
                        <span class="s2">&quot;Use -t to install all downloaded keys&quot;</span>
                    <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_url_push_keys</span><span class="p">(</span>
    <span class="o">*</span><span class="n">mirrors</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">tmpdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">update_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload pgp public keys to the given mirrors&quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">public_keys</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">keys</span> <span class="ow">or</span> <span class="p">()))</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.pub&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">export_keys</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
        <span class="n">push_url</span> <span class="o">=</span> <span class="n">mirror</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">mirror</span><span class="o">.</span><span class="n">push_url</span>
        <span class="n">keys_url</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">push_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="n">BUILD_CACHE_KEYS_RELATIVE_PATH</span>
        <span class="p">)</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pushing public keys to </span><span class="si">{</span><span class="n">url_util</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">push_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
            <span class="n">web_util</span><span class="o">.</span><span class="n">push_to_url</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys_url</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">update_index</span><span class="p">:</span>
            <span class="n">generate_key_index</span><span class="p">(</span><span class="n">keys_url</span><span class="p">,</span> <span class="n">tmpdir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span>


<div class="viewcode-block" id="needs_rebuild">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.needs_rebuild">[docs]</a>
<span class="k">def</span> <span class="nf">needs_rebuild</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">mirror_url</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;spec must be concrete to check against mirror&quot;</span><span class="p">)</span>

    <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span>
    <span class="n">pkg_version</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">version</span>
    <span class="n">pkg_hash</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking </span><span class="si">{0}</span><span class="s2">-</span><span class="si">{1}</span><span class="s2">, dag_hash = </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">pkg_version</span><span class="p">,</span> <span class="n">pkg_hash</span><span class="p">))</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">tree</span><span class="p">())</span>

    <span class="c1"># Try to retrieve the specfile directly, based on the known</span>
    <span class="c1"># format of the name, in order to determine if the package</span>
    <span class="c1"># needs to be rebuilt.</span>
    <span class="n">cache_prefix</span> <span class="o">=</span> <span class="n">build_cache_prefix</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">)</span>
    <span class="n">specfile_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json&quot;</span><span class="p">)</span>
    <span class="n">specfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_prefix</span><span class="p">,</span> <span class="n">specfile_name</span><span class="p">)</span>

    <span class="c1"># Only check for the presence of the json version of the spec.  If the</span>
    <span class="c1"># mirror only has the json version, or doesn&#39;t have the spec at all, we</span>
    <span class="c1"># need to rebuild.</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">web_util</span><span class="o">.</span><span class="n">url_exists</span><span class="p">(</span><span class="n">specfile_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_specs_against_mirrors">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.check_specs_against_mirrors">[docs]</a>
<span class="k">def</span> <span class="nf">check_specs_against_mirrors</span><span class="p">(</span><span class="n">mirrors</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check all the given specs against buildcaches on the given mirrors and</span>
<span class="sd">    determine if any of the specs need to be rebuilt.  Specs need to be rebuilt</span>
<span class="sd">    when their hash doesn&#39;t exist in the mirror.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        mirrors (dict): Mirrors to check against</span>
<span class="sd">        specs (typing.Iterable): Specs to check against mirrors</span>
<span class="sd">        output_file (str): Path to output file to be written.  If provided,</span>
<span class="sd">            mirrors with missing or out-of-date specs will be formatted as a</span>
<span class="sd">            JSON object and written to this file.</span>

<span class="sd">    Returns: 1 if any spec was out-of-date on any mirror, 0 otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rebuilds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">mirrors</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking for built specs at </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">))</span>

        <span class="n">rebuild_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">needs_rebuild</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">):</span>
                <span class="n">rebuild_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;short_spec&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()})</span>

        <span class="k">if</span> <span class="n">rebuild_list</span><span class="p">:</span>
            <span class="n">rebuilds</span><span class="p">[</span><span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mirrorName&quot;</span><span class="p">:</span> <span class="n">mirror</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;mirrorUrl&quot;</span><span class="p">:</span> <span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">,</span>
                <span class="s2">&quot;rebuildSpecs&quot;</span><span class="p">:</span> <span class="n">rebuild_list</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="k">if</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">rebuilds</span><span class="p">))</span>

    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">rebuilds</span> <span class="k">else</span> <span class="mi">0</span></div>



<span class="k">def</span> <span class="nf">_download_buildcache_entry</span><span class="p">(</span><span class="n">mirror_root</span><span class="p">,</span> <span class="n">descriptions</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">description</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
        <span class="n">mkdirp</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">fail_if_missing</span> <span class="o">=</span> <span class="n">description</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">description</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]:</span>
            <span class="n">description_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mirror_root</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">description_url</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;build_cache&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stage</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">FetchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail_if_missing</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to download required url </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">description_url</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="download_buildcache_entry">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.download_buildcache_entry">[docs]</a>
<span class="k">def</span> <span class="nf">download_buildcache_entry</span><span class="p">(</span><span class="n">file_descriptions</span><span class="p">,</span> <span class="n">mirror_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mirror_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">die</span><span class="p">(</span>
            <span class="s2">&quot;Please provide or add a spack mirror to allow &quot;</span> <span class="o">+</span> <span class="s2">&quot;download of buildcache entries.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">mirror_url</span><span class="p">:</span>
        <span class="n">mirror_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_download_buildcache_entry</span><span class="p">(</span><span class="n">mirror_root</span><span class="p">,</span> <span class="n">file_descriptions</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">mirror_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mirror</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_download_buildcache_entry</span><span class="p">(</span><span class="n">mirror_root</span><span class="p">,</span> <span class="n">file_descriptions</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="download_single_spec">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.download_single_spec">[docs]</a>
<span class="k">def</span> <span class="nf">download_single_spec</span><span class="p">(</span><span class="n">concrete_spec</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">mirror_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the buildcache files for a single concrete spec.</span>

<span class="sd">    Args:</span>
<span class="sd">        concrete_spec: concrete spec to be downloaded</span>
<span class="sd">        destination (str): path where to put the downloaded buildcache</span>
<span class="sd">        mirror_url (str): url of the mirror from which to download</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tarfile_name</span> <span class="o">=</span> <span class="n">tarball_name</span><span class="p">(</span><span class="n">concrete_spec</span><span class="p">,</span> <span class="s2">&quot;.spack&quot;</span><span class="p">)</span>
    <span class="n">tarball_dir_name</span> <span class="o">=</span> <span class="n">tarball_directory_name</span><span class="p">(</span><span class="n">concrete_spec</span><span class="p">)</span>
    <span class="n">tarball_path_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tarball_dir_name</span><span class="p">,</span> <span class="n">tarfile_name</span><span class="p">)</span>
    <span class="n">local_tarball_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">tarball_dir_name</span><span class="p">)</span>

    <span class="n">files_to_fetch</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">tarball_path_name</span><span class="p">],</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">local_tarball_path</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">tarball_name</span><span class="p">(</span><span class="n">concrete_spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json.sig&quot;</span><span class="p">),</span>
                <span class="n">tarball_name</span><span class="p">(</span><span class="n">concrete_spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">destination</span><span class="p">,</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">download_buildcache_entry</span><span class="p">(</span><span class="n">files_to_fetch</span><span class="p">,</span> <span class="n">mirror_url</span><span class="p">)</span></div>



<div class="viewcode-block" id="BinaryCacheQuery">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BinaryCacheQuery">[docs]</a>
<span class="k">class</span> <span class="nc">BinaryCacheQuery</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callable object to query if a spec is in a binary cache&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_architectures</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            all_architectures (bool): if True consider all the spec for querying,</span>
<span class="sd">                otherwise restrict to the current default architecture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_architectures</span> <span class="o">=</span> <span class="n">all_architectures</span>

        <span class="n">specs</span> <span class="o">=</span> <span class="n">update_cache_and_get_specs</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_architectures</span><span class="p">:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">default_arch</span><span class="p">()</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">arch</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">possible_specs</span> <span class="o">=</span> <span class="n">specs</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Spec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            spec: The spec being searched for</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_specs</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">spec</span><span class="p">)]</span></div>



<div class="viewcode-block" id="FetchIndexError">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.FetchIndexError">[docs]</a>
<span class="k">class</span> <span class="nc">FetchIndexError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, due to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="BuildcacheIndexError">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.BuildcacheIndexError">[docs]</a>
<span class="k">class</span> <span class="nc">BuildcacheIndexError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a buildcache cannot be read for any reason&quot;&quot;&quot;</span></div>



<span class="n">FetchIndexResult</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;FetchIndexResult&quot;</span><span class="p">,</span> <span class="s2">&quot;etag hash data fresh&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="DefaultIndexFetcher">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.DefaultIndexFetcher">[docs]</a>
<span class="k">class</span> <span class="nc">DefaultIndexFetcher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetcher for index.json, using separate index.json.hash as cache invalidation strategy&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">local_hash</span><span class="p">,</span> <span class="n">urlopen</span><span class="o">=</span><span class="n">web_util</span><span class="o">.</span><span class="n">urlopen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_hash</span> <span class="o">=</span> <span class="n">local_hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span> <span class="o">=</span> <span class="n">urlopen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SPACK_USER_AGENT</span><span class="p">}</span>

<div class="viewcode-block" id="DefaultIndexFetcher.get_remote_hash">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.DefaultIndexFetcher.get_remote_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">get_remote_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Failure to fetch index.json.hash is not fatal</span>
        <span class="n">url_index_hash</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="s2">&quot;index.json.hash&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url_index_hash</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Validate the hash</span>
        <span class="n">remote_hash</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;[a-f\d]</span><span class="si">{64}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">remote_hash</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">remote_hash</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DefaultIndexFetcher.conditional_fetch">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.DefaultIndexFetcher.conditional_fetch">[docs]</a>
    <span class="k">def</span> <span class="nf">conditional_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FetchIndexResult</span><span class="p">:</span>
        <span class="c1"># Do an intermediate fetch for the hash</span>
        <span class="c1"># and a conditional fetch for the contents</span>

        <span class="c1"># Early exit if our cache is up to date.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_hash</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_hash</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_hash</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">FetchIndexResult</span><span class="p">(</span><span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Otherwise, download index.json</span>
        <span class="n">url_index</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url_index</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="s2">&quot;Could not fetch index from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_index</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="s2">&quot;Remote index </span><span class="si">{}</span><span class="s2"> is invalid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_index</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">computed_hash</span> <span class="o">=</span> <span class="n">compute_hash</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># We don&#39;t handle computed_hash != remote_hash here, which can happen</span>
        <span class="c1"># when remote index.json and index.json.hash are out of sync, or if</span>
        <span class="c1"># the hash algorithm changed.</span>
        <span class="c1"># The most likely scenario is that we got index.json got updated</span>
        <span class="c1"># while we fetched index.json.hash. Warning about an issue thus feels</span>
        <span class="c1"># wrong, as it&#39;s more of an issue with race conditions in the cache</span>
        <span class="c1"># invalidation strategy.</span>

        <span class="c1"># For now we only handle etags on http(s), since 304 error handling</span>
        <span class="c1"># in s3:// is not there yet.</span>
        <span class="k">if</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">):</span>
            <span class="n">etag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">etag</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">parse_etag</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Etag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">FetchIndexResult</span><span class="p">(</span><span class="n">etag</span><span class="o">=</span><span class="n">etag</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">computed_hash</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EtagIndexFetcher">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.EtagIndexFetcher">[docs]</a>
<span class="k">class</span> <span class="nc">EtagIndexFetcher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetcher for index.json, using ETags headers as cache invalidation strategy&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">,</span> <span class="n">urlopen</span><span class="o">=</span><span class="n">web_util</span><span class="o">.</span><span class="n">urlopen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etag</span> <span class="o">=</span> <span class="n">etag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span> <span class="o">=</span> <span class="n">urlopen</span>

<div class="viewcode-block" id="EtagIndexFetcher.conditional_fetch">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.EtagIndexFetcher.conditional_fetch">[docs]</a>
    <span class="k">def</span> <span class="nf">conditional_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FetchIndexResult</span><span class="p">:</span>
        <span class="c1"># Just do a conditional fetch immediately</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">BUILD_CACHE_RELATIVE_PATH</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SPACK_USER_AGENT</span><span class="p">,</span> <span class="s2">&quot;If-None-Match&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">etag</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
                <span class="c1"># Not modified; that means fresh.</span>
                <span class="k">return</span> <span class="n">FetchIndexResult</span><span class="p">(</span><span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not fetch index </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not fetch index </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote index </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is invalid&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
        <span class="n">etag_header_value</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Etag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FetchIndexResult</span><span class="p">(</span>
            <span class="n">etag</span><span class="o">=</span><span class="n">web_util</span><span class="o">.</span><span class="n">parse_etag</span><span class="p">(</span><span class="n">etag_header_value</span><span class="p">),</span>
            <span class="nb">hash</span><span class="o">=</span><span class="n">compute_hash</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
            <span class="n">fresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="OCIIndexFetcher">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.OCIIndexFetcher">[docs]</a>
<span class="k">class</span> <span class="nc">OCIIndexFetcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_hash</span><span class="p">,</span> <span class="n">urlopen</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_hash</span> <span class="o">=</span> <span class="n">local_hash</span>

        <span class="c1"># Remove oci:// prefix</span>
        <span class="k">assert</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;oci://&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageReference</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span> <span class="o">=</span> <span class="n">urlopen</span> <span class="ow">or</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">urlopen</span>

<div class="viewcode-block" id="OCIIndexFetcher.conditional_fetch">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.OCIIndexFetcher.conditional_fetch">[docs]</a>
    <span class="k">def</span> <span class="nf">conditional_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FetchIndexResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download an index from an OCI registry type mirror.&quot;&quot;&quot;</span>
        <span class="n">url_manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">with_tag</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">default_index_tag</span><span class="p">)</span><span class="o">.</span><span class="n">manifest_url</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span>
                <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">url_manifest</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not fetch manifest from </span><span class="si">{</span><span class="n">url_manifest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote index </span><span class="si">{</span><span class="n">url_manifest</span><span class="si">}</span><span class="s2"> is invalid&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Get first blob hash, which should be the index.json</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index_digest</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Digest</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;digest&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote index </span><span class="si">{</span><span class="n">url_manifest</span><span class="si">}</span><span class="s2"> is invalid&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Fresh?</span>
        <span class="k">if</span> <span class="n">index_digest</span><span class="o">.</span><span class="n">digest</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FetchIndexResult</span><span class="p">(</span><span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Otherwise fetch the blob / index.json</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">blob_url</span><span class="p">(</span><span class="n">index_digest</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># Make sure the blob we download has the advertised hash</span>
        <span class="k">if</span> <span class="n">compute_hash</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="n">index_digest</span><span class="o">.</span><span class="n">digest</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FetchIndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote index </span><span class="si">{</span><span class="n">url_manifest</span><span class="si">}</span><span class="s2"> is invalid&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FetchIndexResult</span><span class="p">(</span><span class="n">etag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">index_digest</span><span class="o">.</span><span class="n">digest</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="NoOverwriteException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.NoOverwriteException">[docs]</a>
<span class="k">class</span> <span class="nc">NoOverwriteException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a file would be overwritten&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refusing to overwrite the following file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="NoGpgException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.NoGpgException">[docs]</a>
<span class="k">class</span> <span class="nc">NoGpgException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when gpg2 is not in PATH</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="NoKeyException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.NoKeyException">[docs]</a>
<span class="k">class</span> <span class="nc">NoKeyException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when gpg has no default key added.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="PickKeyException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.PickKeyException">[docs]</a>
<span class="k">class</span> <span class="nc">PickKeyException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when multiple keys can be used to sign.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Multiple keys available for signing</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">keys</span>
        <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;Use spack buildcache create -k &lt;key hash&gt; to pick a key.&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="NoVerifyException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.NoVerifyException">[docs]</a>
<span class="k">class</span> <span class="nc">NoVerifyException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised if file fails signature verification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>



<div class="viewcode-block" id="NoChecksumException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.NoChecksumException">[docs]</a>
<span class="k">class</span> <span class="nc">NoChecksumException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised if file fails checksum verification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">algorithm</span><span class="si">}</span><span class="s2"> checksum failed for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="n">computed</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;File size = </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> bytes. Contents = </span><span class="si">{</span><span class="n">contents</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="NewLayoutException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.NewLayoutException">[docs]</a>
<span class="k">class</span> <span class="nc">NewLayoutException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised if directory layout is different from buildcache.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="InvalidMetadataFile">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.InvalidMetadataFile">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidMetadataFile</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="UnsignedPackageException">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.UnsignedPackageException">[docs]</a>
<span class="k">class</span> <span class="nc">UnsignedPackageException</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised if installation of unsigned package is attempted without</span>
<span class="sd">    the use of ``--no-check-signature``.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ListMirrorSpecsError">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.ListMirrorSpecsError">[docs]</a>
<span class="k">class</span> <span class="nc">ListMirrorSpecsError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when unable to retrieve list of specs from the mirror&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="GenerateIndexError">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.GenerateIndexError">[docs]</a>
<span class="k">class</span> <span class="nc">GenerateIndexError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when unable to generate key or package index for mirror&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="CannotListKeys">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.CannotListKeys">[docs]</a>
<span class="k">class</span> <span class="nc">CannotListKeys</span><span class="p">(</span><span class="n">GenerateIndexError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when unable to list keys when generating key index&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="PushToBuildCacheError">
<a class="viewcode-back" href="../../spack.html#spack.binary_distribution.PushToBuildCacheError">[docs]</a>
<span class="k">class</span> <span class="nc">PushToBuildCacheError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when unable to push objects to binary mirror&quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>