

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.ci &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.ci</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.ci</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">HTTPError</span><span class="p">,</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">HTTPHandler</span><span class="p">,</span> <span class="n">HTTPSHandler</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">build_opener</span>

<span class="kn">import</span> <span class="nn">ruamel.yaml</span>

<span class="kn">import</span> <span class="nn">llnl.util.filesystem</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>
<span class="kn">from</span> <span class="nn">llnl.util.lang</span> <span class="kn">import</span> <span class="n">Singleton</span><span class="p">,</span> <span class="n">memoized</span>
<span class="kn">from</span> <span class="nn">llnl.util.tty.color</span> <span class="kn">import</span> <span class="n">cescape</span><span class="p">,</span> <span class="n">colorize</span>

<span class="kn">import</span> <span class="nn">spack</span>
<span class="kn">import</span> <span class="nn">spack.binary_distribution</span> <span class="k">as</span> <span class="nn">bindist</span>
<span class="kn">import</span> <span class="nn">spack.concretize</span>
<span class="kn">import</span> <span class="nn">spack.config</span> <span class="k">as</span> <span class="nn">cfg</span>
<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.main</span>
<span class="kn">import</span> <span class="nn">spack.mirror</span>
<span class="kn">import</span> <span class="nn">spack.paths</span>
<span class="kn">import</span> <span class="nn">spack.repo</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.util.git</span>
<span class="kn">import</span> <span class="nn">spack.util.gpg</span> <span class="k">as</span> <span class="nn">gpg_util</span>
<span class="kn">import</span> <span class="nn">spack.util.spack_yaml</span> <span class="k">as</span> <span class="nn">syaml</span>
<span class="kn">import</span> <span class="nn">spack.util.url</span> <span class="k">as</span> <span class="nn">url_util</span>
<span class="kn">import</span> <span class="nn">spack.util.web</span> <span class="k">as</span> <span class="nn">web_util</span>
<span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="n">traverse</span>
<span class="kn">from</span> <span class="nn">spack.error</span> <span class="kn">import</span> <span class="n">SpackError</span>
<span class="kn">from</span> <span class="nn">spack.reporters</span> <span class="kn">import</span> <span class="n">CDash</span><span class="p">,</span> <span class="n">CDashConfiguration</span>
<span class="kn">from</span> <span class="nn">spack.reporters.cdash</span> <span class="kn">import</span> <span class="n">SPACK_CDASH_TIMEOUT</span>
<span class="kn">from</span> <span class="nn">spack.reporters.cdash</span> <span class="kn">import</span> <span class="n">build_stamp</span> <span class="k">as</span> <span class="n">cdash_build_stamp</span>


<span class="k">def</span> <span class="nf">_urlopen</span><span class="p">():</span>
    <span class="n">error_handler</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SpackHTTPDefaultErrorHandler</span><span class="p">()</span>

    <span class="c1"># One opener with HTTPS ssl enabled</span>
    <span class="n">with_ssl</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span>
        <span class="n">HTTPHandler</span><span class="p">(),</span> <span class="n">HTTPSHandler</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">web_util</span><span class="o">.</span><span class="n">ssl_create_default_context</span><span class="p">()),</span> <span class="n">error_handler</span>
    <span class="p">)</span>

    <span class="c1"># One opener with HTTPS ssl disabled</span>
    <span class="n">without_ssl</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span>
        <span class="n">HTTPHandler</span><span class="p">(),</span> <span class="n">HTTPSHandler</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">_create_unverified_context</span><span class="p">()),</span> <span class="n">error_handler</span>
    <span class="p">)</span>

    <span class="c1"># And dynamically dispatch based on the config:verify_ssl.</span>
    <span class="k">def</span> <span class="nf">dispatch_open</span><span class="p">(</span><span class="n">fullurl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">opener</span> <span class="o">=</span> <span class="n">with_ssl</span> <span class="k">if</span> <span class="n">verify_ssl</span> <span class="k">else</span> <span class="n">without_ssl</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:connect_timeout&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fullurl</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dispatch_open</span>


<span class="n">_dyn_mapping_urlopener</span> <span class="o">=</span> <span class="n">Singleton</span><span class="p">(</span><span class="n">_urlopen</span><span class="p">)</span>

<span class="c1"># See https://docs.gitlab.com/ee/ci/yaml/#retry for descriptions of conditions</span>
<span class="n">JOB_RETRY_CONDITIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &quot;always&quot;,</span>
    <span class="s2">&quot;unknown_failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;script_failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;api_failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stuck_or_timeout_failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;runner_system_failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;runner_unsupported&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stale_schedule&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;job_execution_timeout&quot;,</span>
    <span class="s2">&quot;archived_failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;unmet_prerequisites&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scheduler_failure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data_integrity_failure&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">TEMP_STORAGE_MIRROR_NAME</span> <span class="o">=</span> <span class="s2">&quot;ci_temporary_mirror&quot;</span>
<span class="n">SPACK_RESERVED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">,</span> <span class="s2">&quot;protected&quot;</span><span class="p">,</span> <span class="s2">&quot;notary&quot;</span><span class="p">]</span>
<span class="n">JOB_NAME_FORMAT</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@version} {/hash:7} {</span><span class="si">%c</span><span class="s2">ompiler.name}{@compiler.version}{ arch=architecture}&quot;</span>
<span class="p">)</span>
<span class="n">IS_WINDOWS</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span>
<span class="n">spack_gpg</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">SpackCommand</span><span class="p">(</span><span class="s2">&quot;gpg&quot;</span><span class="p">)</span>
<span class="n">spack_compiler</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">SpackCommand</span><span class="p">(</span><span class="s2">&quot;compiler&quot;</span><span class="p">)</span>

<span class="n">PushResult</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;PushResult&quot;</span><span class="p">,</span> <span class="s2">&quot;success url&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="TemporaryDirectory">
<a class="viewcode-back" href="../../spack.html#spack.ci.TemporaryDirectory">[docs]</a>
<span class="k">class</span> <span class="nc">TemporaryDirectory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_directory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_directory</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_directory</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_job_name">
<a class="viewcode-back" href="../../spack.html#spack.ci.get_job_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_job_name</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">build_group</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a spec and possibly a build group, return the job name. If the</span>
<span class="sd">    resulting name is longer than 255 characters, it will be truncated.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        spec (spack.spec.Spec): Spec job will build</span>
<span class="sd">        build_group (str): Name of build group this job belongs to (a CDash</span>
<span class="sd">        notion)</span>

<span class="sd">    Returns: The job name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">job_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">JOB_NAME_FORMAT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">build_group</span><span class="p">:</span>
        <span class="n">job_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">build_group</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">job_name</span><span class="p">[:</span><span class="mi">255</span><span class="p">]</span></div>



<span class="k">def</span> <span class="nf">_remove_reserved_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to strip reserved tags from jobs&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SPACK_RESERVED_TAGS</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_spec_ci_label</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">PlainNodes</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span>
<span class="n">PlainEdges</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>


<div class="viewcode-block" id="stage_spec_jobs">
<a class="viewcode-back" href="../../spack.html#spack.ci.stage_spec_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">stage_spec_jobs</span><span class="p">(</span><span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PlainNodes</span><span class="p">,</span> <span class="n">PlainEdges</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turn a DAG into a list of stages (set of nodes), the list is ordered topologically, so that</span>
<span class="sd">    each node in a stage has dependencies only in previous stages.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        specs: Specs to build</span>

<span class="sd">    Returns: A tuple (nodes, edges, stages) where ``nodes`` maps labels to specs, ``edges`` maps</span>
<span class="sd">        labels to a set of labels of dependencies, and ``stages`` is a topologically ordered list</span>
<span class="sd">        of sets of labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The convenience method below, &quot;_remove_satisfied_deps()&quot;, does not modify</span>
    <span class="c1"># the &quot;deps&quot; parameter.  Instead, it returns a new dictionary where only</span>
    <span class="c1"># dependencies which have not yet been satisfied are included in the</span>
    <span class="c1"># return value.</span>
    <span class="k">def</span> <span class="nf">_remove_satisfied_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="n">satisfied_list</span><span class="p">):</span>
        <span class="n">new_deps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">satisfied_list</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">new_value</span><span class="p">:</span>
                <span class="n">new_deps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>

        <span class="k">return</span> <span class="n">new_deps</span>

    <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">_extract_dag</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

    <span class="c1"># Save the original edges, as we need to return them at the end of the function. In the loop</span>
    <span class="c1"># below, the &quot;dependencies&quot; variable is rebound rather than mutated, so &quot;edges&quot; is not mutated.</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="n">edges</span>
    <span class="n">unstaged</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">stages</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="n">dependencies</span><span class="p">:</span>
        <span class="n">dependents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dependencies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">next_stage</span> <span class="o">=</span> <span class="n">unstaged</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">dependents</span><span class="p">)</span>
        <span class="n">stages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_stage</span><span class="p">)</span>
        <span class="n">unstaged</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">next_stage</span><span class="p">)</span>
        <span class="c1"># Note that &quot;dependencies&quot; is a dictionary mapping each dependent</span>
        <span class="c1"># package to the set of not-yet-handled dependencies.  The final step</span>
        <span class="c1"># below removes all the dependencies that are handled by this stage.</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">_remove_satisfied_deps</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">next_stage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">unstaged</span><span class="p">:</span>
        <span class="n">stages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unstaged</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">stages</span></div>



<span class="k">def</span> <span class="nf">_print_staging_summary</span><span class="p">(</span><span class="n">spec_labels</span><span class="p">,</span> <span class="n">stages</span><span class="p">,</span> <span class="n">rebuild_decisions</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stages</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">mirrors</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Checked the following mirrors for binaries:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">fetch_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Staging summary ([x] means a job needs rebuilding):&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stage_index</span><span class="p">,</span> <span class="n">stage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stages</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  stage </span><span class="si">{</span><span class="n">stage_index</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs):&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rebuild_decisions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">rebuild</span><span class="p">,</span> <span class="n">j</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">spec_labels</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="n">rebuild_decisions</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span>
            <span class="n">reason_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">reason</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">spec_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@version}{</span><span class="si">%c</span><span class="s2">ompiler}{/hash:7}&quot;</span>
            <span class="k">if</span> <span class="n">rebuild_decisions</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">rebuild</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">colorize</span><span class="p">(</span><span class="s2">&quot;@*g{[x]}  &quot;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">status</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">cformat</span><span class="p">(</span><span class="n">spec_fmt</span><span class="p">)</span><span class="si">}{</span><span class="n">reason_msg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_fmt</span><span class="p">)</span><span class="si">}{</span><span class="n">reason_msg</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">rebuild_decisions</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">mirrors</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rebuild_decisions</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">mirrors</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">colorize</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  @K -   </span><span class="si">{</span><span class="n">cescape</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">@.&quot;</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_extract_dag</span><span class="p">(</span><span class="n">specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PlainNodes</span><span class="p">,</span> <span class="n">PlainEdges</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract a sub-DAG as plain old Python objects with external nodes removed.&quot;&quot;&quot;</span>
    <span class="n">nodes</span><span class="p">:</span> <span class="n">PlainNodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">edges</span><span class="p">:</span> <span class="n">PlainEdges</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_edges</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">cover</span><span class="o">=</span><span class="s2">&quot;edges&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="n">edge</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">external</span><span class="p">)</span> <span class="ow">or</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">child_id</span> <span class="o">=</span> <span class="n">_spec_ci_label</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="n">child_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span>
        <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">parent_id</span> <span class="o">=</span> <span class="n">_spec_ci_label</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">parent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">parent_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span>


<span class="k">def</span> <span class="nf">_spec_matches</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">match_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">spec</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">match_string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_job_needs</span><span class="p">(</span><span class="n">dep_jobs</span><span class="p">,</span> <span class="n">build_group</span><span class="p">,</span> <span class="n">prune_dag</span><span class="p">,</span> <span class="n">rebuild_decisions</span><span class="p">):</span>
    <span class="n">needs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dep_job</span> <span class="ow">in</span> <span class="n">dep_jobs</span><span class="p">:</span>
        <span class="n">dep_spec_key</span> <span class="o">=</span> <span class="n">_spec_ci_label</span><span class="p">(</span><span class="n">dep_job</span><span class="p">)</span>
        <span class="n">rebuild</span> <span class="o">=</span> <span class="n">rebuild_decisions</span><span class="p">[</span><span class="n">dep_spec_key</span><span class="p">]</span><span class="o">.</span><span class="n">rebuild</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">prune_dag</span> <span class="ow">or</span> <span class="n">rebuild</span><span class="p">:</span>
            <span class="n">needs_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;job&quot;</span><span class="p">:</span> <span class="n">get_job_name</span><span class="p">(</span><span class="n">dep_job</span><span class="p">,</span> <span class="n">build_group</span><span class="p">),</span> <span class="s2">&quot;artifacts&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">needs_list</span>


<div class="viewcode-block" id="get_change_revisions">
<a class="viewcode-back" href="../../spack.html#spack.ci.get_change_revisions">[docs]</a>
<span class="k">def</span> <span class="nf">get_change_revisions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a git repo get the revisions to use when checking</span>
<span class="sd">    for changed packages and spack core modules.&quot;&quot;&quot;</span>
    <span class="n">git_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">git_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">git_dir</span><span class="p">):</span>
        <span class="c1"># TODO: This will only find changed packages from the last</span>
        <span class="c1"># TODO: commit.  While this may work for single merge commits</span>
        <span class="c1"># TODO: when merging the topic branch into the base, it will</span>
        <span class="c1"># TODO: require more thought outside of that narrow case.</span>
        <span class="k">return</span> <span class="s2">&quot;HEAD^&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_stack_changed">
<a class="viewcode-back" href="../../spack.html#spack.ci.get_stack_changed">[docs]</a>
<span class="k">def</span> <span class="nf">get_stack_changed</span><span class="p">(</span><span class="n">env_path</span><span class="p">,</span> <span class="n">rev1</span><span class="o">=</span><span class="s2">&quot;HEAD^&quot;</span><span class="p">,</span> <span class="n">rev2</span><span class="o">=</span><span class="s2">&quot;HEAD&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an environment manifest path and two revisions to compare, return</span>
<span class="sd">    whether or not the stack was changed.  Returns True if the environment</span>
<span class="sd">    manifest changed between the provided revisions (or additionally if the</span>
<span class="sd">    `.gitlab-ci.yml` file itself changed).  Returns False otherwise.&quot;&quot;&quot;</span>
    <span class="n">git</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">git</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">git_log</span> <span class="o">=</span> <span class="n">git</span><span class="p">(</span>
                <span class="s2">&quot;diff&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--name-only&quot;</span><span class="p">,</span>
                <span class="n">rev1</span><span class="p">,</span>
                <span class="n">rev2</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span>
                <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">git_log</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="n">git_log</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;.gitlab-ci.yml&quot;</span> <span class="ow">in</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">env_path</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;env represented by </span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2"> changed&quot;</span><span class="p">)</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;touched file: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="compute_affected_packages">
<a class="viewcode-back" href="../../spack.html#spack.ci.compute_affected_packages">[docs]</a>
<span class="k">def</span> <span class="nf">compute_affected_packages</span><span class="p">(</span><span class="n">rev1</span><span class="o">=</span><span class="s2">&quot;HEAD^&quot;</span><span class="p">,</span> <span class="n">rev2</span><span class="o">=</span><span class="s2">&quot;HEAD&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine which packages were added, removed or changed</span>
<span class="sd">    between rev1 and rev2, and return the names as a set&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">get_all_package_diffs</span><span class="p">(</span><span class="s2">&quot;ARC&quot;</span><span class="p">,</span> <span class="n">rev1</span><span class="o">=</span><span class="n">rev1</span><span class="p">,</span> <span class="n">rev2</span><span class="o">=</span><span class="n">rev2</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_spec_filter_list">
<a class="viewcode-back" href="../../spack.html#spack.ci.get_spec_filter_list">[docs]</a>
<span class="k">def</span> <span class="nf">get_spec_filter_list</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">affected_pkgs</span><span class="p">,</span> <span class="n">dependent_traverse_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a list of package names and an active/concretized</span>
<span class="sd">       environment, return the set of all concrete specs from the</span>
<span class="sd">       environment that could have been affected by changing the</span>
<span class="sd">       list of packages.</span>

<span class="sd">       If a ``dependent_traverse_depth`` is given, it is used to limit</span>
<span class="sd">       upward (in the parent direction) traversal of specs of touched</span>
<span class="sd">       packages.  E.g. if 1 is provided, then only direct dependents</span>
<span class="sd">       of touched package specs are traversed to produce specs that</span>
<span class="sd">       could have been affected by changing the package, while if 0 is</span>
<span class="sd">       provided, only the changed specs themselves are traversed. If ``None``</span>
<span class="sd">       is given, upward traversal of touched package specs is done all</span>
<span class="sd">       the way to the environment roots.  Providing a negative number</span>
<span class="sd">       results in no traversals at all, yielding an empty set.</span>

<span class="sd">    Arguments:</span>

<span class="sd">        env (spack.environment.Environment): Active concrete environment</span>
<span class="sd">        affected_pkgs (List[str]): Affected package names</span>
<span class="sd">        dependent_traverse_depth: Optional integer to limit dependent</span>
<span class="sd">            traversal, or None to disable the limit.</span>

<span class="sd">    Returns:</span>

<span class="sd">        A set of concrete specs from the active environment including</span>
<span class="sd">        those associated with affected packages, their dependencies and</span>
<span class="sd">        dependents, as well as their dependents dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">affected_specs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_concrete_specs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">all_specs</span><span class="p">()</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All concrete environment specs:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_concrete_specs</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">affected_pkgs</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">affected_pkgs</span><span class="p">)</span>
    <span class="n">env_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_concrete_specs</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">affected_pkgs</span><span class="p">]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">dag_hash</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">depth</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span>
        <span class="n">env_matches</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;parents&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dag_hash</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;breadth&quot;</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">dependent_traverse_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="n">dependent_traverse_depth</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">affected_specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;children&quot;</span><span class="p">,</span> <span class="n">visited</span><span class="o">=</span><span class="n">visited</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dag_hash</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">affected_specs</span></div>



<span class="k">def</span> <span class="nf">_build_jobs</span><span class="p">(</span><span class="n">spec_labels</span><span class="p">,</span> <span class="n">stages</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">stage_jobs</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec_label</span> <span class="ow">in</span> <span class="n">stage_jobs</span><span class="p">:</span>
            <span class="n">release_spec</span> <span class="o">=</span> <span class="n">spec_labels</span><span class="p">[</span><span class="n">spec_label</span><span class="p">]</span>
            <span class="n">release_spec_dag_hash</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">release_spec</span><span class="p">,</span> <span class="n">release_spec_dag_hash</span>


<span class="k">def</span> <span class="nf">_noop</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">_unpack_script</span><span class="p">(</span><span class="n">script_section</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">_noop</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">script_section</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subcmd</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">subcmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">script</span>


<div class="viewcode-block" id="RebuildDecision">
<a class="viewcode-back" href="../../spack.html#spack.ci.RebuildDecision">[docs]</a>
<span class="k">class</span> <span class="nc">RebuildDecision</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebuild</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirrors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></div>



<div class="viewcode-block" id="SpackCI">
<a class="viewcode-back" href="../../spack.html#spack.ci.SpackCI">[docs]</a>
<span class="k">class</span> <span class="nc">SpackCI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spack CI object used to generate intermediate representation</span>
<span class="sd">    used by the CI generator(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci_config</span><span class="p">,</span> <span class="n">spec_labels</span><span class="p">,</span> <span class="n">stages</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given the information from the ci section of the config</span>
<span class="sd">        and the staged jobs, set up meta data needed for generating Spack</span>
<span class="sd">        CI IR.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ci_config</span> <span class="o">=</span> <span class="n">ci_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">named_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="s2">&quot;cleanup&quot;</span><span class="p">,</span> <span class="s2">&quot;noop&quot;</span><span class="p">,</span> <span class="s2">&quot;reindex&quot;</span><span class="p">,</span> <span class="s2">&quot;signing&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ir</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;rebuild-index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rebuild-index&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;broken-specs-url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;broken-specs-url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;broken-tests-packages&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;broken-tests-packages&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;gitlab&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">dag_hash</span> <span class="ow">in</span> <span class="n">_build_jobs</span><span class="p">(</span><span class="n">spec_labels</span><span class="p">,</span> <span class="n">stages</span><span class="p">):</span>
            <span class="n">jobs</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_job</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_jobs</span><span class="p">:</span>
            <span class="c1"># Skip the special named jobs</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">]:</span>
                <span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_job</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">release_spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize job object&quot;&quot;&quot;</span>
        <span class="n">job_object</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="n">release_spec</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">if</span> <span class="n">release_spec</span><span class="p">:</span>
            <span class="n">job_vars</span> <span class="o">=</span> <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_JOB_SPEC_DAG_HASH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_JOB_SPEC_PKG_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">name</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_JOB_SPEC_PKG_VERSION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{version}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_JOB_SPEC_COMPILER_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{compiler.name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_JOB_SPEC_COMPILER_VERSION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{compiler.version}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_JOB_SPEC_ARCH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{architecture}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_JOB_SPEC_VARIANTS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{variants}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_object</span>

    <span class="k">def</span> <span class="nf">__is_named</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a pipeline-gen configuration section is for a named job,</span>
<span class="sd">        and if so return the name otherwise return none.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_jobs</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">-job&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">-job-remove&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">section</span><span class="p">]):</span>
                <span class="k">return</span> <span class="n">_name</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__job_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the name of a named job with appropriate suffix.</span>
<span class="sd">        Valid suffixes are either &#39;-remove&#39; or empty string or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="n">jname</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
            <span class="n">jname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">-job</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">-job&quot;</span>

        <span class="k">return</span> <span class="n">jname</span>

    <span class="k">def</span> <span class="nf">__apply_submapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply submapping setion to the IR dict&quot;&quot;&quot;</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">only_first</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;match_behavior&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span>

        <span class="k">for</span> <span class="n">match_attrs</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="s2">&quot;submapping&quot;</span><span class="p">]):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">InternalConfigScope</span><span class="o">.</span><span class="n">_process_dict_keyname_overrides</span><span class="p">(</span><span class="n">match_attrs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">match_string</span> <span class="ow">in</span> <span class="n">match_attrs</span><span class="p">[</span><span class="s2">&quot;match&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">_spec_matches</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">match_string</span><span class="p">):</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="s2">&quot;build-job-remove&quot;</span> <span class="ow">in</span> <span class="n">match_attrs</span><span class="p">:</span>
                        <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_yaml</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;build-job-remove&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s2">&quot;build-job&quot;</span> <span class="ow">in</span> <span class="n">match_attrs</span><span class="p">:</span>
                        <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_yaml</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;build-job&quot;</span><span class="p">])</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">matched</span> <span class="ow">and</span> <span class="n">only_first</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">dest</span>

    <span class="c1"># Generate IR from the configs</span>
<div class="viewcode-block" id="SpackCI.generate_ir">
<a class="viewcode-back" href="../../spack.html#spack.ci.SpackCI.generate_ir">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_ir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the IR from the Spack CI configurations.&quot;&quot;&quot;</span>

        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>

        <span class="c1"># Implicit job defaults</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;build-job&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;cd </span><span class="si">{env_dir}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;spack env activate --without-view .&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;spack ci rebuild&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;noop-job&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;echo &quot;All specs already up to date, nothing to rebuild.&quot;&#39;</span><span class="p">]}},</span>
        <span class="p">]</span>

        <span class="c1"># Job overrides</span>
        <span class="n">overrides</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># Reindex script</span>
            <span class="p">{</span>
                <span class="s2">&quot;reindex-job&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;script:&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;spack buildcache update-index --keys </span><span class="si">{index_target_mirror}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="c1"># Cleanup script</span>
            <span class="p">{</span>
                <span class="s2">&quot;cleanup-job&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;script:&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;spack -d mirror destroy </span><span class="si">{mirror_prefix}</span><span class="s2">/$CI_PIPELINE_ID&quot;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="c1"># Add signing job tags</span>
            <span class="p">{</span><span class="s2">&quot;signing-job&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;aws&quot;</span><span class="p">,</span> <span class="s2">&quot;protected&quot;</span><span class="p">,</span> <span class="s2">&quot;notary&quot;</span><span class="p">]}},</span>
            <span class="c1"># Remove reserved tags</span>
            <span class="p">{</span><span class="s2">&quot;any-job-remove&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">SPACK_RESERVED_TAGS</span><span class="p">}},</span>
        <span class="p">]</span>

        <span class="n">pipeline_gen</span> <span class="o">=</span> <span class="n">overrides</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline-gen&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">defaults</span>

        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">pipeline_gen</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_named</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">has_submapping</span> <span class="o">=</span> <span class="s2">&quot;submapping&quot;</span> <span class="ow">in</span> <span class="n">section</span>
            <span class="n">has_dynmapping</span> <span class="o">=</span> <span class="s2">&quot;dynamic-mapping&quot;</span> <span class="ow">in</span> <span class="n">section</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">InternalConfigScope</span><span class="o">.</span><span class="n">_process_dict_keyname_overrides</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">remove_job_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__job_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;-remove&quot;</span><span class="p">)</span>
                <span class="n">merge_job_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__job_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">do_remove</span> <span class="o">=</span> <span class="n">remove_job_name</span> <span class="ow">in</span> <span class="n">section</span>
                <span class="n">do_merge</span> <span class="o">=</span> <span class="n">merge_job_name</span> <span class="ow">in</span> <span class="n">section</span>

                <span class="k">def</span> <span class="nf">_apply_section</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">do_remove</span><span class="p">:</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_yaml</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">remove_job_name</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">do_merge</span><span class="p">:</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_yaml</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">merge_job_name</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;build&quot;</span><span class="p">:</span>
                    <span class="c1"># Apply attributes to all build jobs</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]:</span>
                            <span class="n">_apply_section</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">],</span> <span class="n">section</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
                    <span class="c1"># Apply section attributes too all jobs</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">_apply_section</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">],</span> <span class="n">section</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create a signing job if there is script and the job hasn&#39;t</span>
                    <span class="c1"># been initialized yet</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;signing&quot;</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;signing-job&quot;</span> <span class="ow">in</span> <span class="n">section</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;script&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;signing-job&quot;</span><span class="p">]:</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_job</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="c1"># Apply attributes to named job</span>
                    <span class="n">_apply_section</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;attributes&quot;</span><span class="p">],</span> <span class="n">section</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">has_submapping</span><span class="p">:</span>
                <span class="c1"># Apply section jobs with specs to match</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]:</span>
                        <span class="n">job</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apply_submapping</span><span class="p">(</span>
                            <span class="n">job</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">],</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span> <span class="n">section</span>
                        <span class="p">)</span>
            <span class="k">elif</span> <span class="n">has_dynmapping</span><span class="p">:</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;dynamic-mapping&quot;</span><span class="p">]</span>

                <span class="n">dynmap_name</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

                <span class="c1"># Check if this section should be skipped</span>
                <span class="n">dynmap_skip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_CI_SKIP_DYNAMIC_MAPPING&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dynmap_name</span> <span class="ow">and</span> <span class="n">dynmap_skip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">dynmap_skip</span><span class="p">,</span> <span class="n">dynmap_name</span><span class="p">):</span>
                        <span class="k">continue</span>

                <span class="c1"># Get the endpoint</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;endpoint&quot;</span><span class="p">]</span>
                <span class="n">endpoint_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

                <span class="c1"># Configure the request header</span>
                <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SPACK_USER_AGENT</span><span class="p">}</span>
                <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="p">{}))</span>

                <span class="c1"># Expand header environment variables</span>
                <span class="c1"># ie. if tokens are passed</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">verify_ssl</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verify_ssl&quot;</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:verify_ssl&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:connect_timeout&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">required</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;require&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">allowed</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allow&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">ignored</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="p">[])</span>

                <span class="c1"># required keys are implicitly allowed</span>
                <span class="n">allowed</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">allowed</span> <span class="o">+</span> <span class="n">required</span><span class="p">))</span>
                <span class="n">ignored</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ignored</span><span class="p">))</span>
                <span class="n">required</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">required</span><span class="p">))</span>

                <span class="c1"># Make sure required things are not also ignored</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">ikey</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">ignored</span><span class="p">])</span>

                <span class="k">def</span> <span class="nf">job_query</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                    <span class="n">job_vars</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{SPACK_JOB_SPEC_PKG_NAME}</span><span class="s2">@</span><span class="si">{SPACK_JOB_SPEC_PKG_VERSION}</span><span class="s2">&quot;</span>
                        <span class="c1"># The preceding spaces are required (ref. https://github.com/spack/spack-gantry/blob/develop/docs/api.md#allocation)</span>
                        <span class="s2">&quot; </span><span class="si">{SPACK_JOB_SPEC_VARIANTS}</span><span class="s2">&quot;</span>
                        <span class="s2">&quot; arch=</span><span class="si">{SPACK_JOB_SPEC_ARCH}</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;%</span><span class="si">{SPACK_JOB_SPEC_COMPILER_NAME}</span><span class="s2">@</span><span class="si">{SPACK_JOB_SPEC_COMPILER_VERSION}</span><span class="s2">&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">job_vars</span><span class="p">)</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;spec=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Create request for this job</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="n">job_query</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span>
                        <span class="n">endpoint_url</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">geturl</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">_dyn_mapping_urlopener</span><span class="p">(</span>
                            <span class="n">request</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># For now just ignore any errors from dynamic mapping and continue</span>
                        <span class="c1"># This is still experimental, and failures should not stop CI</span>
                        <span class="c1"># from running normally</span>
                        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch dynamic mapping for query:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">response</span><span class="p">))</span>

                    <span class="c1"># Strip ignore keys</span>
                    <span class="k">if</span> <span class="n">ignored</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ignored</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                                <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                    <span class="c1"># Only keep allowed keys</span>
                    <span class="n">clean_config</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">allowed</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                                <span class="n">clean_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">clean_config</span> <span class="o">=</span> <span class="n">config</span>

                    <span class="c1"># Verify all of the required keys are present</span>
                    <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
                        <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">missing_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response missing required keys: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">clean_config</span><span class="p">:</span>
                        <span class="n">job</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_yaml</span><span class="p">(</span>
                            <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">clean_config</span>
                        <span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]:</span>
                <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir</span></div>
</div>



<div class="viewcode-block" id="generate_gitlab_ci_yaml">
<a class="viewcode-back" href="../../spack.html#spack.ci.generate_gitlab_ci_yaml">[docs]</a>
<span class="k">def</span> <span class="nf">generate_gitlab_ci_yaml</span><span class="p">(</span>
    <span class="n">env</span><span class="p">,</span>
    <span class="n">print_summary</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">prune_dag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">check_index_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">artifacts_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a gitlab yaml file to run a dynamic child pipeline from</span>
<span class="sd">        the spec matrix in the active environment.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        env (spack.environment.Environment): Activated environment object</span>
<span class="sd">            which must contain a ci section describing how to map</span>
<span class="sd">            specs to runners</span>
<span class="sd">        print_summary (bool): Should we print a summary of all the jobs in</span>
<span class="sd">            the stages in which they were placed.</span>
<span class="sd">        output_file (str): File path where generated file should be written</span>
<span class="sd">        prune_dag (bool): If True, do not generate jobs for specs already</span>
<span class="sd">            exist built on the mirror.</span>
<span class="sd">        check_index_only (bool): If True, attempt to fetch the mirror index</span>
<span class="sd">            and only use that to determine whether built specs on the mirror</span>
<span class="sd">            this mode results in faster yaml generation time). Otherwise, also</span>
<span class="sd">            check each spec directly by url (useful if there is no index or it</span>
<span class="sd">            might be out of date).</span>
<span class="sd">        artifacts_root (str): Path where artifacts like logs, environment</span>
<span class="sd">            files (spack.yaml, spack.lock), etc should be written.  GitLab</span>
<span class="sd">            requires this to be within the project directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">spack</span><span class="o">.</span><span class="n">concretize</span><span class="o">.</span><span class="n">disable_compiler_existence_check</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">write_transaction</span><span class="p">():</span>
            <span class="n">env</span><span class="o">.</span><span class="n">concretize</span><span class="p">()</span>
            <span class="n">env</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="c1"># Get the joined &quot;ci&quot; config with all of the current scopes resolved</span>
    <span class="n">ci_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ci&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ci_config</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpackCIError</span><span class="p">(</span><span class="s2">&quot;Environment does not have a `ci` configuration&quot;</span><span class="p">)</span>

    <span class="c1"># Default target is gitlab...and only target is gitlab</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ci_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;gitlab&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;gitlab&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpackCIError</span><span class="p">(</span><span class="s1">&#39;Spack CI module only generates target &quot;gitlab&quot;&#39;</span><span class="p">)</span>

    <span class="n">cdash_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cdash&quot;</span><span class="p">)</span>
    <span class="n">cdash_handler</span> <span class="o">=</span> <span class="n">CDashHandler</span><span class="p">(</span><span class="n">cdash_config</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;build-group&quot;</span> <span class="ow">in</span> <span class="n">cdash_config</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">build_group</span> <span class="o">=</span> <span class="n">cdash_handler</span><span class="o">.</span><span class="n">build_group</span> <span class="k">if</span> <span class="n">cdash_handler</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">dependent_depth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_PRUNE_UNTOUCHED_DEPENDENT_DEPTH&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dependent_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dependent_depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dependent_depth</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unrecognized value (</span><span class="si">{</span><span class="n">dependent_depth</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="s2">&quot;provided for SPACK_PRUNE_UNTOUCHED_DEPENDENT_DEPTH, &quot;</span>
                <span class="s2">&quot;ignoring it.&quot;</span>
            <span class="p">)</span>
            <span class="n">dependent_depth</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">prune_untouched_packages</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">spack_prune_untouched</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_PRUNE_UNTOUCHED&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spack_prune_untouched</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spack_prune_untouched</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
        <span class="c1"># Requested to prune untouched packages, but assume we won&#39;t do that</span>
        <span class="c1"># unless we&#39;re actually in a git repo.</span>
        <span class="n">rev1</span><span class="p">,</span> <span class="n">rev2</span> <span class="o">=</span> <span class="n">get_change_revisions</span><span class="p">()</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got following revisions: rev1=</span><span class="si">{</span><span class="n">rev1</span><span class="si">}</span><span class="s2">, rev2=</span><span class="si">{</span><span class="n">rev2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rev1</span> <span class="ow">and</span> <span class="n">rev2</span><span class="p">:</span>
            <span class="c1"># If the stack file itself did not change, proceed with pruning</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">get_stack_changed</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">manifest_path</span><span class="p">,</span> <span class="n">rev1</span><span class="p">,</span> <span class="n">rev2</span><span class="p">):</span>
                <span class="n">prune_untouched_packages</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">affected_pkgs</span> <span class="o">=</span> <span class="n">compute_affected_packages</span><span class="p">(</span><span class="n">rev1</span><span class="p">,</span> <span class="n">rev2</span><span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;affected pkgs:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">affected_pkgs</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">affected_specs</span> <span class="o">=</span> <span class="n">get_spec_filter_list</span><span class="p">(</span>
                    <span class="n">env</span><span class="p">,</span> <span class="n">affected_pkgs</span><span class="p">,</span> <span class="n">dependent_traverse_depth</span><span class="o">=</span><span class="n">dependent_depth</span>
                <span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;all affected specs:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">affected_specs</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Allow overriding --prune-dag cli opt with environment variable</span>
    <span class="n">prune_dag_override</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_PRUNE_UP_TO_DATE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prune_dag_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prune_dag</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">prune_dag_override</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="c1"># If we are not doing any kind of pruning, we are rebuilding everything</span>
    <span class="n">rebuild_everything</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">prune_dag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prune_untouched_packages</span>

    <span class="c1"># Downstream jobs will &quot;need&quot; (depend on, for both scheduling and</span>
    <span class="c1"># artifacts, which include spack.lock file) this pipeline generation</span>
    <span class="c1"># job by both name and pipeline id.  If those environment variables</span>
    <span class="c1"># do not exist, then maybe this is just running in a shell, in which</span>
    <span class="c1"># case, there is no expectation gitlab will ever run the generated</span>
    <span class="c1"># pipeline and those environment variables do not matter.</span>
    <span class="n">generate_job_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CI_JOB_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;job-does-not-exist&quot;</span><span class="p">)</span>
    <span class="n">parent_pipeline_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CI_PIPELINE_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;pipeline-does-not-exist&quot;</span><span class="p">)</span>

    <span class="c1"># Values: &quot;spack_pull_request&quot;, &quot;spack_protected_branch&quot;, or not set</span>
    <span class="n">spack_pipeline_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_PIPELINE_TYPE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">copy_only_pipeline</span> <span class="o">=</span> <span class="n">spack_pipeline_type</span> <span class="o">==</span> <span class="s2">&quot;spack_copy_only&quot;</span>

    <span class="k">def</span> <span class="nf">ensure_expected_target_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns passed paths with all Windows path separators exchanged</span>
<span class="sd">        for posix separators only if copy_only_pipeline is enabled</span>

<span class="sd">        This is required as copy_only_pipelines are a unique scenario where</span>
<span class="sd">        the generate job and child pipelines are run on different platforms.</span>
<span class="sd">        To make this compatible w/ Windows, we cannot write Windows style path separators</span>
<span class="sd">        that will be consumed on by the Posix copy job runner.</span>

<span class="sd">        TODO (johnwparent): Refactor config + cli read/write to deal only in posix</span>
<span class="sd">        style paths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy_only_pipeline</span> <span class="ow">and</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="n">pipeline_mirrors</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">buildcache_destination</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;buildcache-destination&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pipeline_mirrors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpackCIError</span><span class="p">(</span><span class="s2">&quot;spack ci generate requires a mirror named &#39;buildcache-destination&#39;&quot;</span><span class="p">)</span>

    <span class="n">buildcache_destination</span> <span class="o">=</span> <span class="n">pipeline_mirrors</span><span class="p">[</span><span class="s2">&quot;buildcache-destination&quot;</span><span class="p">]</span>

    <span class="n">spack_buildcache_copy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_COPY_BUILDCACHE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spack_buildcache_copy</span><span class="p">:</span>
        <span class="n">buildcache_copies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">buildcache_copy_src_prefix</span> <span class="o">=</span> <span class="n">buildcache_destination</span><span class="o">.</span><span class="n">fetch_url</span>
        <span class="n">buildcache_copy_dest_prefix</span> <span class="o">=</span> <span class="n">spack_buildcache_copy</span>

    <span class="c1"># Check for a list of &quot;known broken&quot; specs that we should not bother</span>
    <span class="c1"># trying to build.</span>
    <span class="n">broken_specs_url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">known_broken_specs_encountered</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;broken-specs-url&quot;</span> <span class="ow">in</span> <span class="n">ci_config</span><span class="p">:</span>
        <span class="n">broken_specs_url</span> <span class="o">=</span> <span class="n">ci_config</span><span class="p">[</span><span class="s2">&quot;broken-specs-url&quot;</span><span class="p">]</span>

    <span class="n">rebuild_index_enabled</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s2">&quot;rebuild-index&quot;</span> <span class="ow">in</span> <span class="n">ci_config</span> <span class="ow">and</span> <span class="n">ci_config</span><span class="p">[</span><span class="s2">&quot;rebuild-index&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">rebuild_index_enabled</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">pipeline_artifacts_dir</span> <span class="o">=</span> <span class="n">artifacts_root</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_artifacts_dir</span><span class="p">:</span>
        <span class="n">proj_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CI_PROJECT_DIR&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="n">pipeline_artifacts_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s2">&quot;jobs_scratch_dir&quot;</span><span class="p">)</span>

    <span class="n">pipeline_artifacts_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">)</span>
    <span class="n">concrete_env_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;concrete_environment&quot;</span><span class="p">)</span>

    <span class="c1"># Copy the environment manifest file into the concrete environment directory,</span>
    <span class="c1"># along with the spack.lock file.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">manifest_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">,</span> <span class="s2">&quot;spack.yaml&quot;</span><span class="p">))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">lock_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">,</span> <span class="s2">&quot;spack.lock&quot;</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">manifest_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_fd</span><span class="p">:</span>
        <span class="n">env_yaml_root</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">env_fd</span><span class="p">)</span>
        <span class="c1"># Add config scopes to environment</span>
        <span class="n">env_includes</span> <span class="o">=</span> <span class="n">env_yaml_root</span><span class="p">[</span><span class="s2">&quot;spack&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">cli_scopes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">concrete_env_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">scopes</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">writable</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DirectoryConfigScope</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env_includes</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">include_scopes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">cli_scopes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include_scopes</span> <span class="ow">and</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env_includes</span><span class="p">:</span>
                <span class="n">include_scopes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="n">env_includes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">include_scopes</span><span class="p">)</span>
        <span class="n">env_yaml_root</span><span class="p">[</span><span class="s2">&quot;spack&quot;</span><span class="p">][</span><span class="s2">&quot;include&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ensure_expected_target_path</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">env_includes</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">,</span> <span class="s2">&quot;spack.yaml&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">syaml</span><span class="o">.</span><span class="n">dump_config</span><span class="p">(</span><span class="n">env_yaml_root</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">job_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
    <span class="n">job_repro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;reproduction&quot;</span><span class="p">)</span>
    <span class="n">job_test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">)</span>
    <span class="n">user_artifacts_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;user_data&quot;</span><span class="p">)</span>

    <span class="c1"># We communicate relative paths to the downstream jobs to avoid issues in</span>
    <span class="c1"># situations where the CI_PROJECT_DIR varies between the pipeline</span>
    <span class="c1"># generation job and the rebuild jobs.  This can happen when gitlab</span>
    <span class="c1"># checks out the project into a runner-specific directory, for example,</span>
    <span class="c1"># and different runners are picked for generate and rebuild jobs.</span>
    <span class="n">ci_project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CI_PROJECT_DIR&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="n">rel_artifacts_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">,</span> <span class="n">ci_project_dir</span><span class="p">)</span>
    <span class="n">rel_concrete_env_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">,</span> <span class="n">ci_project_dir</span><span class="p">)</span>
    <span class="n">rel_job_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">job_log_dir</span><span class="p">,</span> <span class="n">ci_project_dir</span><span class="p">)</span>
    <span class="n">rel_job_repro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">job_repro_dir</span><span class="p">,</span> <span class="n">ci_project_dir</span><span class="p">)</span>
    <span class="n">rel_job_test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">job_test_dir</span><span class="p">,</span> <span class="n">ci_project_dir</span><span class="p">)</span>
    <span class="n">rel_user_artifacts_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">user_artifacts_dir</span><span class="p">,</span> <span class="n">ci_project_dir</span><span class="p">)</span>

    <span class="c1"># Speed up staging by first fetching binary indices from all mirrors</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bindist</span><span class="o">.</span><span class="n">BINARY_INDEX</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">bindist</span><span class="o">.</span><span class="n">FetchCacheError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">spec_labels</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">stages</span> <span class="o">=</span> <span class="n">stage_spec_jobs</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">concrete</span>
            <span class="k">for</span> <span class="n">abstract</span><span class="p">,</span> <span class="n">concrete</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">concretized_specs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">abstract</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">spec_lists</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">all_job_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_object</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">stage_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">stage_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">max_length_needs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_needs_job</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># If this is configured, spack will fail &quot;spack ci generate&quot; if it</span>
    <span class="c1"># generates any hash which exists under the broken specs url.</span>
    <span class="n">broken_spec_urls</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">broken_specs_url</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">broken_specs_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
            <span class="c1"># To make checking each spec against the list faster, we require</span>
            <span class="c1"># a url protocol that allows us to iterate the url in advance.</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Cannot use an http(s) url for broken specs, ignoring&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">broken_spec_urls</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">list_url</span><span class="p">(</span><span class="n">broken_specs_url</span><span class="p">)</span>

    <span class="n">spack_ci</span> <span class="o">=</span> <span class="n">SpackCI</span><span class="p">(</span><span class="n">ci_config</span><span class="p">,</span> <span class="n">spec_labels</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
    <span class="n">spack_ci_ir</span> <span class="o">=</span> <span class="n">spack_ci</span><span class="o">.</span><span class="n">generate_ir</span><span class="p">()</span>

    <span class="n">rebuild_decisions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">stage_jobs</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
        <span class="n">stage_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;stage-</span><span class="si">{</span><span class="n">stage_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">stage_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span>
        <span class="n">stage_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">spec_label</span> <span class="ow">in</span> <span class="n">stage_jobs</span><span class="p">:</span>
            <span class="n">release_spec</span> <span class="o">=</span> <span class="n">spec_labels</span><span class="p">[</span><span class="n">spec_label</span><span class="p">]</span>
            <span class="n">release_spec_dag_hash</span> <span class="o">=</span> <span class="n">release_spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>

            <span class="n">spec_record</span> <span class="o">=</span> <span class="n">RebuildDecision</span><span class="p">()</span>
            <span class="n">rebuild_decisions</span><span class="p">[</span><span class="n">spec_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_record</span>

            <span class="k">if</span> <span class="n">prune_untouched_packages</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">release_spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">affected_specs</span><span class="p">:</span>
                    <span class="n">spec_record</span><span class="o">.</span><span class="n">rebuild</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">spec_record</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Pruned, untouched by change.&quot;</span>
                    <span class="k">continue</span>

            <span class="n">up_to_date_mirrors</span> <span class="o">=</span> <span class="n">bindist</span><span class="o">.</span><span class="n">get_mirrors_for_spec</span><span class="p">(</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">release_spec</span><span class="p">,</span> <span class="n">index_only</span><span class="o">=</span><span class="n">check_index_only</span>
            <span class="p">)</span>

            <span class="n">spec_record</span><span class="o">.</span><span class="n">rebuild</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">up_to_date_mirrors</span>
            <span class="k">if</span> <span class="n">up_to_date_mirrors</span><span class="p">:</span>
                <span class="n">spec_record</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Pruned, found in mirrors&quot;</span>
                <span class="n">spec_record</span><span class="o">.</span><span class="n">mirrors</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;mirror_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">up_to_date_mirrors</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spec_record</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Scheduled, not found anywhere&quot;</span>

            <span class="n">job_object</span> <span class="o">=</span> <span class="n">spack_ci_ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="n">release_spec_dag_hash</span><span class="p">][</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">job_object</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No match found for </span><span class="si">{</span><span class="n">release_spec</span><span class="si">}</span><span class="s2">, skipping it&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">spack_pipeline_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># For spack pipelines &quot;public&quot; and &quot;protected&quot; are reserved tags</span>
                <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_remove_reserved_tags</span><span class="p">(</span><span class="n">job_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="n">spack_pipeline_type</span> <span class="o">==</span> <span class="s2">&quot;spack_protected_branch&quot;</span><span class="p">:</span>
                    <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;protected&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">spack_pipeline_type</span> <span class="o">==</span> <span class="s2">&quot;spack_pull_request&quot;</span><span class="p">:</span>
                    <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;public&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s2">&quot;script&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_object</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span>

            <span class="k">def</span> <span class="nf">main_script_replacements</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{env_dir}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rel_concrete_env_dir</span><span class="p">)</span>

            <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unpack_script</span><span class="p">(</span>
                <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">main_script_replacements</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;before_script&quot;</span> <span class="ow">in</span> <span class="n">job_object</span><span class="p">:</span>
                <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;before_script&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unpack_script</span><span class="p">(</span><span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;before_script&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s2">&quot;after_script&quot;</span> <span class="ow">in</span> <span class="n">job_object</span><span class="p">:</span>
                <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;after_script&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unpack_script</span><span class="p">(</span><span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;after_script&quot;</span><span class="p">])</span>

            <span class="n">job_name</span> <span class="o">=</span> <span class="n">get_job_name</span><span class="p">(</span><span class="n">release_spec</span><span class="p">,</span> <span class="n">build_group</span><span class="p">)</span>

            <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;needs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">spec_label</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="c1"># In this case, &quot;needs&quot; is only used for scheduling</span>
                <span class="c1"># purposes, so we only get the direct dependencies.</span>
                <span class="n">dep_jobs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">dep_label</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">[</span><span class="n">spec_label</span><span class="p">]:</span>
                    <span class="n">dep_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec_labels</span><span class="p">[</span><span class="n">dep_label</span><span class="p">])</span>

                <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;needs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">_format_job_needs</span><span class="p">(</span><span class="n">dep_jobs</span><span class="p">,</span> <span class="n">build_group</span><span class="p">,</span> <span class="n">prune_dag</span><span class="p">,</span> <span class="n">rebuild_decisions</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">rebuild_spec</span> <span class="o">=</span> <span class="n">spec_record</span><span class="o">.</span><span class="n">rebuild</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rebuild_spec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">copy_only_pipeline</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prune_dag</span><span class="p">:</span>
                    <span class="n">spec_record</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Pruned, up-to-date&quot;</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># DAG pruning is disabled, force the spec to rebuild. The</span>
                    <span class="c1"># record still contains any mirrors on which the spec</span>
                    <span class="c1"># may have been found, so we can print them in the staging</span>
                    <span class="c1"># summary.</span>
                    <span class="n">spec_record</span><span class="o">.</span><span class="n">rebuild</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">spec_record</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Scheduled, DAG pruning disabled&quot;</span>

            <span class="k">if</span> <span class="n">broken_spec_urls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">release_spec_dag_hash</span> <span class="ow">in</span> <span class="n">broken_spec_urls</span><span class="p">:</span>
                <span class="n">known_broken_specs_encountered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">release_spec_dag_hash</span><span class="p">)</span>

            <span class="c1"># Only keep track of these if we are copying rebuilt cache entries</span>
            <span class="k">if</span> <span class="n">spack_buildcache_copy</span><span class="p">:</span>
                <span class="c1"># TODO: This assumes signed version of the spec</span>
                <span class="n">buildcache_copies</span><span class="p">[</span><span class="n">release_spec_dag_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;src&quot;</span><span class="p">:</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">buildcache_copy_src_prefix</span><span class="p">,</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">build_cache_relative_path</span><span class="p">(),</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">tarball_name</span><span class="p">(</span><span class="n">release_spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json.sig&quot;</span><span class="p">),</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;dest&quot;</span><span class="p">:</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">buildcache_copy_dest_prefix</span><span class="p">,</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">build_cache_relative_path</span><span class="p">(),</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">tarball_name</span><span class="p">(</span><span class="n">release_spec</span><span class="p">,</span> <span class="s2">&quot;.spec.json.sig&quot;</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;src&quot;</span><span class="p">:</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">buildcache_copy_src_prefix</span><span class="p">,</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">build_cache_relative_path</span><span class="p">(),</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">tarball_path_name</span><span class="p">(</span><span class="n">release_spec</span><span class="p">,</span> <span class="s2">&quot;.spack&quot;</span><span class="p">),</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;dest&quot;</span><span class="p">:</span> <span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">buildcache_copy_dest_prefix</span><span class="p">,</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">build_cache_relative_path</span><span class="p">(),</span>
                            <span class="n">bindist</span><span class="o">.</span><span class="n">tarball_path_name</span><span class="p">(</span><span class="n">release_spec</span><span class="p">,</span> <span class="s2">&quot;.spack&quot;</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">]</span>

            <span class="k">if</span> <span class="n">artifacts_root</span><span class="p">:</span>
                <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;needs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;job&quot;</span><span class="p">:</span> <span class="n">generate_job_name</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_pipeline_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># Let downstream jobs know whether the spec needed rebuilding, regardless</span>
            <span class="c1"># whether DAG pruning was enabled or not.</span>
            <span class="n">job_vars</span> <span class="o">=</span> <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
            <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_SPEC_NEEDS_REBUILD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rebuild_spec</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cdash_handler</span><span class="p">:</span>
                <span class="n">cdash_handler</span><span class="o">.</span><span class="n">current_spec</span> <span class="o">=</span> <span class="n">release_spec</span>
                <span class="n">build_name</span> <span class="o">=</span> <span class="n">cdash_handler</span><span class="o">.</span><span class="n">build_name</span>
                <span class="n">all_job_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build_name</span><span class="p">)</span>
                <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_CDASH_BUILD_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_name</span>

                <span class="n">build_stamp</span> <span class="o">=</span> <span class="n">cdash_handler</span><span class="o">.</span><span class="n">build_stamp</span>
                <span class="n">job_vars</span><span class="p">[</span><span class="s2">&quot;SPACK_CDASH_BUILD_STAMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_stamp</span>

            <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;artifacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_yaml</span><span class="p">(</span>
                <span class="n">job_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifacts&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="p">{</span>
                    <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="s2">&quot;always&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">rel_job_log_dir</span><span class="p">,</span>
                        <span class="n">rel_job_repro_dir</span><span class="p">,</span>
                        <span class="n">rel_job_test_dir</span><span class="p">,</span>
                        <span class="n">rel_user_artifacts_dir</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>

            <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage_name</span>
            <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="n">JOB_RETRY_CONDITIONS</span><span class="p">}</span>
            <span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;interruptible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">length_needs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_object</span><span class="p">[</span><span class="s2">&quot;needs&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">length_needs</span> <span class="o">&gt;</span> <span class="n">max_length_needs</span><span class="p">:</span>
                <span class="n">max_length_needs</span> <span class="o">=</span> <span class="n">length_needs</span>
                <span class="n">max_needs_job</span> <span class="o">=</span> <span class="n">job_name</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">copy_only_pipeline</span><span class="p">:</span>
                <span class="n">output_object</span><span class="p">[</span><span class="n">job_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_object</span>
                <span class="n">job_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">print_summary</span><span class="p">:</span>
        <span class="n">_print_staging_summary</span><span class="p">(</span><span class="n">spec_labels</span><span class="p">,</span> <span class="n">stages</span><span class="p">,</span> <span class="n">rebuild_decisions</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> build jobs generated in </span><span class="si">{</span><span class="n">stage_id</span><span class="si">}</span><span class="s2"> stages&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">job_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The max_needs_job is </span><span class="si">{</span><span class="n">max_needs_job</span><span class="si">}</span><span class="s2">, with </span><span class="si">{</span><span class="n">max_length_needs</span><span class="si">}</span><span class="s2"> needs&quot;</span><span class="p">)</span>

    <span class="c1"># Use &quot;all_job_names&quot; to populate the build group for this set</span>
    <span class="k">if</span> <span class="n">cdash_handler</span> <span class="ow">and</span> <span class="n">cdash_handler</span><span class="o">.</span><span class="n">auth_token</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cdash_handler</span><span class="o">.</span><span class="n">populate_buildgroup</span><span class="p">(</span><span class="n">all_job_names</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">SpackError</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">,</span> <span class="n">URLError</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Problem populating buildgroup: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cdash_config</span><span class="p">:</span>
        <span class="c1"># warn only if there was actually a CDash configuration.</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unable to populate buildgroup without CDash credentials&quot;</span><span class="p">)</span>

    <span class="n">service_job_retries</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;runner_system_failure&quot;</span><span class="p">,</span> <span class="s2">&quot;stuck_or_timeout_failure&quot;</span><span class="p">,</span> <span class="s2">&quot;script_failure&quot;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">copy_only_pipeline</span><span class="p">:</span>
        <span class="n">stage_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;copy&quot;</span><span class="p">)</span>
        <span class="n">sync_job</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spack_ci_ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="s2">&quot;copy&quot;</span><span class="p">][</span><span class="s2">&quot;attributes&quot;</span><span class="p">])</span>
        <span class="n">sync_job</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span>
        <span class="k">if</span> <span class="n">artifacts_root</span><span class="p">:</span>
            <span class="n">sync_job</span><span class="p">[</span><span class="s2">&quot;needs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;job&quot;</span><span class="p">:</span> <span class="n">generate_job_name</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_pipeline_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}]</span>

        <span class="k">if</span> <span class="s2">&quot;variables&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sync_job</span><span class="p">:</span>
            <span class="n">sync_job</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">sync_job</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">][</span><span class="s2">&quot;SPACK_COPY_ONLY_DESTINATION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buildcache_destination</span><span class="o">.</span><span class="n">fetch_url</span>

        <span class="k">if</span> <span class="s2">&quot;buildcache-source&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pipeline_mirrors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpackCIError</span><span class="p">(</span><span class="s2">&quot;Copy-only pipelines require a mirror named &#39;buildcache-source&#39;&quot;</span><span class="p">)</span>

        <span class="n">buildcache_source</span> <span class="o">=</span> <span class="n">pipeline_mirrors</span><span class="p">[</span><span class="s2">&quot;buildcache-source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch_url</span>
        <span class="n">sync_job</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">][</span><span class="s2">&quot;SPACK_BUILDCACHE_SOURCE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buildcache_source</span>
        <span class="n">sync_job</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;copy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sync_job</span>
        <span class="n">job_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">job_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;script&quot;</span> <span class="ow">in</span> <span class="n">spack_ci_ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="s2">&quot;signing&quot;</span><span class="p">][</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">spack_pipeline_type</span> <span class="o">==</span> <span class="s2">&quot;spack_protected_branch&quot;</span>
        <span class="p">):</span>
            <span class="c1"># External signing: generate a job to check and sign binary pkgs</span>
            <span class="n">stage_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;stage-sign-pkgs&quot;</span><span class="p">)</span>
            <span class="n">signing_job</span> <span class="o">=</span> <span class="n">spack_ci_ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="s2">&quot;signing&quot;</span><span class="p">][</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>

            <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unpack_script</span><span class="p">(</span><span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">])</span>

            <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;stage-sign-pkgs&quot;</span>
            <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;when&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;always&quot;</span>
            <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;always&quot;</span><span class="p">]}</span>
            <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;interruptible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s2">&quot;variables&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">signing_job</span><span class="p">:</span>
                <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">][</span>
                <span class="s2">&quot;SPACK_BUILDCACHE_DESTINATION&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">buildcache_destination</span><span class="o">.</span><span class="n">push_url</span>
            <span class="n">signing_job</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;sign-pkgs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signing_job</span>

        <span class="k">if</span> <span class="n">rebuild_index_enabled</span><span class="p">:</span>
            <span class="c1"># Add a final job to regenerate the index</span>
            <span class="n">stage_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;stage-rebuild-index&quot;</span><span class="p">)</span>
            <span class="n">final_job</span> <span class="o">=</span> <span class="n">spack_ci_ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="s2">&quot;reindex&quot;</span><span class="p">][</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>

            <span class="n">final_job</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;stage-rebuild-index&quot;</span>
            <span class="n">target_mirror</span> <span class="o">=</span> <span class="n">buildcache_destination</span><span class="o">.</span><span class="n">push_url</span>
            <span class="n">final_job</span><span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unpack_script</span><span class="p">(</span>
                <span class="n">final_job</span><span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">],</span>
                <span class="n">op</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{index_target_mirror}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">target_mirror</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">final_job</span><span class="p">[</span><span class="s2">&quot;when&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;always&quot;</span>
            <span class="n">final_job</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service_job_retries</span>
            <span class="n">final_job</span><span class="p">[</span><span class="s2">&quot;interruptible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">final_job</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;rebuild-index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_job</span>

        <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;stages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage_names</span>

        <span class="c1"># Capture the version of Spack used to generate the pipeline, that can be</span>
        <span class="c1"># passed to `git checkout` for version consistency. If we aren&#39;t in a Git</span>
        <span class="c1"># repository, presume we are a Spack release and use the Git tag instead.</span>
        <span class="n">spack_version</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>
        <span class="n">version_to_clone</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">get_spack_commit</span><span class="p">()</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">spack</span><span class="o">.</span><span class="n">spack_version</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;SPACK_ARTIFACTS_ROOT&quot;</span><span class="p">:</span> <span class="n">rel_artifacts_root</span><span class="p">,</span>
            <span class="s2">&quot;SPACK_CONCRETE_ENV_DIR&quot;</span><span class="p">:</span> <span class="n">rel_concrete_env_dir</span><span class="p">,</span>
            <span class="s2">&quot;SPACK_VERSION&quot;</span><span class="p">:</span> <span class="n">spack_version</span><span class="p">,</span>
            <span class="s2">&quot;SPACK_CHECKOUT_VERSION&quot;</span><span class="p">:</span> <span class="n">version_to_clone</span><span class="p">,</span>
            <span class="s2">&quot;SPACK_JOB_LOG_DIR&quot;</span><span class="p">:</span> <span class="n">rel_job_log_dir</span><span class="p">,</span>
            <span class="s2">&quot;SPACK_JOB_REPRO_DIR&quot;</span><span class="p">:</span> <span class="n">rel_job_repro_dir</span><span class="p">,</span>
            <span class="s2">&quot;SPACK_JOB_TEST_DIR&quot;</span><span class="p">:</span> <span class="n">rel_job_test_dir</span><span class="p">,</span>
            <span class="s2">&quot;SPACK_PIPELINE_TYPE&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">spack_pipeline_type</span><span class="p">),</span>
            <span class="s2">&quot;SPACK_CI_STACK_NAME&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_CI_STACK_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SPACK_REBUILD_CHECK_UP_TO_DATE&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">prune_dag</span><span class="p">),</span>
            <span class="s2">&quot;SPACK_REBUILD_EVERYTHING&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">rebuild_everything</span><span class="p">),</span>
            <span class="s2">&quot;SPACK_REQUIRE_SIGNING&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_REQUIRE_SIGNING&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">output_vars</span> <span class="o">=</span> <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">output_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">output_vars</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensure_expected_target_path</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="n">spack_stack_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_CI_STACK_NAME&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spack_stack_name</span><span class="p">:</span>
            <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">][</span><span class="s2">&quot;SPACK_CI_STACK_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack_stack_name</span>

        <span class="k">if</span> <span class="n">spack_buildcache_copy</span><span class="p">:</span>
            <span class="c1"># Write out the file describing specs that should be copied</span>
            <span class="n">copy_specs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipeline_artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;specs_to_copy&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">copy_specs_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">copy_specs_dir</span><span class="p">)</span>

            <span class="n">copy_specs_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">copy_specs_dir</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;copy_</span><span class="si">{</span><span class="n">spack_stack_name</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">spack_stack_name</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;rebuilt&#39;</span><span class="si">}</span><span class="s2">_specs.json&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">copy_specs_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">buildcache_copies</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No jobs were generated</span>
        <span class="n">noop_job</span> <span class="o">=</span> <span class="n">spack_ci_ir</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="s2">&quot;noop&quot;</span><span class="p">][</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>
        <span class="c1"># If this job fails ignore the status and carry on</span>
        <span class="n">noop_job</span><span class="p">[</span><span class="s2">&quot;retry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">noop_job</span><span class="p">[</span><span class="s2">&quot;allow_failure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No specs to rebuild, generating no-op job&quot;</span><span class="p">)</span>
        <span class="n">output_object</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;no-specs-to-rebuild&quot;</span><span class="p">:</span> <span class="n">noop_job</span><span class="p">}</span>

    <span class="c1"># Ensure the child pipeline always runs</span>
    <span class="n">output_object</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rules&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="s2">&quot;always&quot;</span><span class="p">}]}</span>

    <span class="n">sorted_output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">output_key</span><span class="p">,</span> <span class="n">output_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">output_object</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">sorted_output</span><span class="p">[</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_value</span>
    <span class="k">if</span> <span class="n">known_broken_specs_encountered</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;This pipeline generated hashes known to be broken on develop:&quot;</span><span class="p">)</span>
        <span class="n">display_broken_spec_messages</span><span class="p">(</span><span class="n">broken_specs_url</span><span class="p">,</span> <span class="n">known_broken_specs_encountered</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rebuild_everything</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Minimize yaml output size through use of anchors</span>
    <span class="n">syaml</span><span class="o">.</span><span class="n">anchorify</span><span class="p">(</span><span class="n">sorted_output</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAML</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sorted_output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_url_encode_string</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
    <span class="n">encoded_keyval</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">({</span><span class="s2">&quot;donotcare&quot;</span><span class="p">:</span> <span class="n">input_string</span><span class="p">})</span>
    <span class="n">eq_idx</span> <span class="o">=</span> <span class="n">encoded_keyval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">encoded_value</span> <span class="o">=</span> <span class="n">encoded_keyval</span><span class="p">[</span><span class="n">eq_idx</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">encoded_value</span>


<div class="viewcode-block" id="import_signing_key">
<a class="viewcode-back" href="../../spack.html#spack.ci.import_signing_key">[docs]</a>
<span class="k">def</span> <span class="nf">import_signing_key</span><span class="p">(</span><span class="n">base64_signing_key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given Base64-encoded gpg key, decode and import it to use for</span>
<span class="sd">        signing packages.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        base64_signing_key (str): A gpg key including the secret key,</span>
<span class="sd">            armor-exported and base64 encoded, so it can be stored in a</span>
<span class="sd">            gitlab CI variable.  For an example of how to generate such</span>
<span class="sd">            a key, see:</span>

<span class="sd">        https://github.com/spack/spack-infrastructure/blob/main/gitlab-docker/files/gen-key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base64_signing_key</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No key found for signing/verifying packages&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ci.import_signing_key() will attempt to import a key&quot;</span><span class="p">)</span>

    <span class="c1"># This command has the side-effect of creating the directory referred</span>
    <span class="c1"># to as GNUPGHOME in setup_environment()</span>
    <span class="n">list_output</span> <span class="o">=</span> <span class="n">spack_gpg</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;spack gpg list:&quot;</span><span class="p">)</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">list_output</span><span class="p">)</span>

    <span class="n">decoded_key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">base64_signing_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decoded_key</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">decoded_key</span> <span class="o">=</span> <span class="n">decoded_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
        <span class="n">sign_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;signing_key&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sign_key_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decoded_key</span><span class="p">)</span>

        <span class="n">key_import_output</span> <span class="o">=</span> <span class="n">spack_gpg</span><span class="p">(</span><span class="s2">&quot;trust&quot;</span><span class="p">,</span> <span class="n">sign_key_path</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spack gpg trust </span><span class="si">{</span><span class="n">sign_key_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key_import_output</span><span class="p">)</span>

    <span class="c1"># Now print the keys we have for verifying and signing</span>
    <span class="n">trusted_keys_output</span> <span class="o">=</span> <span class="n">spack_gpg</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;--trusted&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">signing_keys_output</span> <span class="o">=</span> <span class="n">spack_gpg</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;--signing&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;spack gpg list --trusted&quot;</span><span class="p">)</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">trusted_keys_output</span><span class="p">)</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;spack gpg list --signing&quot;</span><span class="p">)</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">signing_keys_output</span><span class="p">)</span></div>



<div class="viewcode-block" id="can_sign_binaries">
<a class="viewcode-back" href="../../spack.html#spack.ci.can_sign_binaries">[docs]</a>
<span class="k">def</span> <span class="nf">can_sign_binaries</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility method to determine if this spack instance is capable of</span>
<span class="sd">    signing binary packages.  This is currently only possible if the</span>
<span class="sd">    spack gpg keystore contains exactly one secret key.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpg_util</span><span class="o">.</span><span class="n">signing_keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="can_verify_binaries">
<a class="viewcode-back" href="../../spack.html#spack.ci.can_verify_binaries">[docs]</a>
<span class="k">def</span> <span class="nf">can_verify_binaries</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility method to determin if this spack instance is capable (at</span>
<span class="sd">    least in theory) of verifying signed binaries.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpg_util</span><span class="o">.</span><span class="n">public_keys</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="push_to_build_cache">
<a class="viewcode-back" href="../../spack.html#spack.ci.push_to_build_cache">[docs]</a>
<span class="k">def</span> <span class="nf">push_to_build_cache</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">mirror_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sign_binaries</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Push one or more binary packages to the mirror.</span>

<span class="sd">    Arguments:</span>

<span class="sd">        spec: Installed spec to push</span>
<span class="sd">        mirror_url: URL of target mirror</span>
<span class="sd">        sign_binaries: If True, spack will attempt to sign binary package before pushing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pushing to build cache (</span><span class="si">{</span><span class="s1">&#39;signed&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">sign_binaries</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;unsigned&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">signing_key</span> <span class="o">=</span> <span class="n">bindist</span><span class="o">.</span><span class="n">select_signing_key</span><span class="p">()</span> <span class="k">if</span> <span class="n">sign_binaries</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">mirror</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">Mirror</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">mirror_url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">bindist</span><span class="o">.</span><span class="n">make_uploader</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">signing_key</span><span class="o">=</span><span class="n">signing_key</span><span class="p">)</span> <span class="k">as</span> <span class="n">uploader</span><span class="p">:</span>
            <span class="n">uploader</span><span class="o">.</span><span class="n">push_or_raise</span><span class="p">([</span><span class="n">spec</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">bindist</span><span class="o">.</span><span class="n">PushToBuildCacheError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Problem writing to </span><span class="si">{</span><span class="n">mirror_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="remove_other_mirrors">
<a class="viewcode-back" href="../../spack.html#spack.ci.remove_other_mirrors">[docs]</a>
<span class="k">def</span> <span class="nf">remove_other_mirrors</span><span class="p">(</span><span class="n">mirrors_to_keep</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all mirrors from the given config scope, the exceptions being</span>
<span class="sd">    any listed in in mirrors_to_keep, which is a list of mirror urls.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mirrors_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mirror_url</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">mirror_url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mirrors_to_keep</span><span class="p">:</span>
            <span class="n">mirrors_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mirror_name</span> <span class="ow">in</span> <span class="n">mirrors_to_remove</span><span class="p">:</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mirror_name</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span></div>



<div class="viewcode-block" id="copy_files_to_artifacts">
<a class="viewcode-back" href="../../spack.html#spack.ci.copy_files_to_artifacts">[docs]</a>
<span class="k">def</span> <span class="nf">copy_files_to_artifacts</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">artifacts_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy file(s) to the given artifacts directory</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src (str): the glob-friendly path expression for the file(s) to copy</span>
<span class="sd">        artifacts_dir (str): the destination directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">artifacts_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unable to copy files (</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">) to artifacts </span><span class="si">{</span><span class="n">artifacts_dir</span><span class="si">}</span><span class="s2"> due to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="copy_stage_logs_to_artifacts">
<a class="viewcode-back" href="../../spack.html#spack.ci.copy_stage_logs_to_artifacts">[docs]</a>
<span class="k">def</span> <span class="nf">copy_stage_logs_to_artifacts</span><span class="p">(</span><span class="n">job_spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">job_log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy selected build stage file(s) to the given artifacts directory</span>

<span class="sd">    Looks for build logs in the stage directory of the given</span>
<span class="sd">    job_spec, and attempts to copy the files into the directory given</span>
<span class="sd">    by job_log_dir.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_spec: spec associated with spack install log</span>
<span class="sd">        job_log_dir: path into which build log should be copied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job spec: </span><span class="si">{</span><span class="n">job_spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pkg_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">job_spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">job_pkg</span> <span class="o">=</span> <span class="n">pkg_cls</span><span class="p">(</span><span class="n">job_spec</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job package: </span><span class="si">{</span><span class="n">job_pkg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot copy stage logs: job spec (</span><span class="si">{</span><span class="n">job_spec</span><span class="si">}</span><span class="s2">) must be concrete&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">stage_dir</span> <span class="o">=</span> <span class="n">job_pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stage dir: </span><span class="si">{</span><span class="n">stage_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">job_pkg</span><span class="o">.</span><span class="n">log_path</span><span class="p">,</span> <span class="n">job_pkg</span><span class="o">.</span><span class="n">env_mods_path</span><span class="p">,</span> <span class="o">*</span><span class="n">job_pkg</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">archive_files</span><span class="p">]:</span>
        <span class="n">copy_files_to_artifacts</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">job_log_dir</span><span class="p">)</span></div>



<div class="viewcode-block" id="copy_test_logs_to_artifacts">
<a class="viewcode-back" href="../../spack.html#spack.ci.copy_test_logs_to_artifacts">[docs]</a>
<span class="k">def</span> <span class="nf">copy_test_logs_to_artifacts</span><span class="p">(</span><span class="n">test_stage</span><span class="p">,</span> <span class="n">job_test_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy test log file(s) to the given artifacts directory</span>

<span class="sd">    Parameters:</span>
<span class="sd">        test_stage (str): test stage path</span>
<span class="sd">        job_test_dir (str): the destination artifacts test directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test stage: </span><span class="si">{</span><span class="n">test_stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_stage</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot copy test logs: job test stage (</span><span class="si">{</span><span class="n">test_stage</span><span class="si">}</span><span class="s2">) does not exist&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">copy_files_to_artifacts</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_stage</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*.txt&quot;</span><span class="p">),</span> <span class="n">job_test_dir</span><span class="p">)</span></div>



<div class="viewcode-block" id="win_quote">
<a class="viewcode-back" href="../../spack.html#spack.ci.win_quote">[docs]</a>
<span class="k">def</span> <span class="nf">win_quote</span><span class="p">(</span><span class="n">quote_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">quote_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">quote_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    <span class="k">return</span> <span class="n">quote_str</span></div>



<div class="viewcode-block" id="download_and_extract_artifacts">
<a class="viewcode-back" href="../../spack.html#spack.ci.download_and_extract_artifacts">[docs]</a>
<span class="k">def</span> <span class="nf">download_and_extract_artifacts</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Look for gitlab artifacts.zip at the given url, and attempt to download</span>
<span class="sd">        and extract the contents into the given work_dir</span>

<span class="sd">    Arguments:</span>

<span class="sd">        url (str): Complete url to artifacts.zip file</span>
<span class="sd">        work_dir (str): Path to destination where artifacts should be extracted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching artifacts from: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/zip&quot;</span><span class="p">}</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITLAB_PRIVATE_TOKEN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;PRIVATE-TOKEN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

    <span class="n">opener</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span><span class="n">HTTPHandler</span><span class="p">)</span>

    <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">get_method</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">SPACK_CDASH_TIMEOUT</span><span class="p">)</span>
    <span class="n">response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">response_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error response code (</span><span class="si">{</span><span class="n">response_code</span><span class="si">}</span><span class="s2">) in reproduce_ci_job&quot;</span>
        <span class="k">raise</span> <span class="n">SpackError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">artifacts_zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;artifacts.zip&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">work_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">artifacts_zip_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>

    <span class="n">zip_file</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">artifacts_zip_path</span><span class="p">)</span>
    <span class="n">zip_file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
    <span class="n">zip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">artifacts_zip_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_spack_info">
<a class="viewcode-back" href="../../spack.html#spack.ci.get_spack_info">[docs]</a>
<span class="k">def</span> <span class="nf">get_spack_info</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If spack is running from a git repo, return the most recent git log</span>
<span class="sd">    entry, otherwise, return a string containing the spack version.&quot;&quot;&quot;</span>
    <span class="n">git_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">git_path</span><span class="p">):</span>
        <span class="n">git</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">git</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">git_log</span> <span class="o">=</span> <span class="n">git</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">git_log</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;no git repo, use spack </span><span class="si">{</span><span class="n">spack</span><span class="o">.</span><span class="n">spack_version</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="setup_spack_repro_version">
<a class="viewcode-back" href="../../spack.html#spack.ci.setup_spack_repro_version">[docs]</a>
<span class="k">def</span> <span class="nf">setup_spack_repro_version</span><span class="p">(</span><span class="n">repro_dir</span><span class="p">,</span> <span class="n">checkout_commit</span><span class="p">,</span> <span class="n">merge_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Look in the local spack clone to find the checkout_commit, and if</span>
<span class="sd">        provided, the merge_commit given as arguments.  If those commits can</span>
<span class="sd">        be found locally, then clone spack and attempt to recreate a merge</span>
<span class="sd">        commit with the same parent commits as tested in gitlab.  This looks</span>
<span class="sd">        something like 1) git clone repo &amp;&amp; cd repo 2) git checkout</span>
<span class="sd">        &lt;checkout_commit&gt; 3) git merge &lt;merge_commit&gt;.  If there is no</span>
<span class="sd">        merge_commit provided, then skip step (3).</span>

<span class="sd">    Arguments:</span>

<span class="sd">        repro_dir (str): Location where spack should be cloned</span>
<span class="sd">        checkout_commit (str): SHA of PR branch commit</span>
<span class="sd">        merge_commit (str): SHA of target branch parent</span>

<span class="sd">    Returns: True if git repo state was successfully recreated, or False</span>
<span class="sd">        otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># figure out the path to the spack git version being used for the</span>
    <span class="c1"># reproduction</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checkout_commit: </span><span class="si">{</span><span class="n">checkout_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;merge_commit: </span><span class="si">{</span><span class="n">merge_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dot_git_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dot_git_path</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to find the path to your local spack clone&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">spack_git_path</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">prefix</span>

    <span class="n">git</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">git</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;reproduction of pipeline job requires git&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check if we can find the tested commits in your local spack repo</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="n">spack_git_path</span><span class="p">):</span>
        <span class="n">git</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">checkout_commit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">git</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing commit: </span><span class="si">{</span><span class="n">checkout_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">merge_commit</span><span class="p">:</span>
            <span class="n">git</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">merge_commit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">git</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing commit: </span><span class="si">{</span><span class="n">merge_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Next attempt to clone your local spack repo into the repro dir</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="n">repro_dir</span><span class="p">):</span>
        <span class="n">clone_out</span> <span class="o">=</span> <span class="n">git</span><span class="p">(</span>
            <span class="s2">&quot;clone&quot;</span><span class="p">,</span> <span class="n">spack_git_path</span><span class="p">,</span> <span class="s2">&quot;spack&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">git</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to clone your local spack repo:&quot;</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">clone_out</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Finally, attempt to put the cloned repo into the same state used during</span>
    <span class="c1"># the pipeline build job</span>
    <span class="n">repro_spack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repro_dir</span><span class="p">,</span> <span class="s2">&quot;spack&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="n">repro_spack_path</span><span class="p">):</span>
        <span class="n">co_out</span> <span class="o">=</span> <span class="n">git</span><span class="p">(</span>
            <span class="s2">&quot;checkout&quot;</span><span class="p">,</span> <span class="n">checkout_commit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">git</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to checkout </span><span class="si">{</span><span class="n">checkout_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">co_out</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">merge_commit</span><span class="p">:</span>
            <span class="n">merge_out</span> <span class="o">=</span> <span class="n">git</span><span class="p">(</span>
                <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
                <span class="s2">&quot;user.name=cirepro&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
                <span class="s2">&quot;user.email=user@email.org&quot;</span><span class="p">,</span>
                <span class="s2">&quot;merge&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--no-edit&quot;</span><span class="p">,</span>
                <span class="n">merge_commit</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span>
                <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">git</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to merge </span><span class="si">{</span><span class="n">merge_commit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">merge_out</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="reproduce_ci_job">
<a class="viewcode-back" href="../../spack.html#spack.ci.reproduce_ci_job">[docs]</a>
<span class="k">def</span> <span class="nf">reproduce_ci_job</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">autostart</span><span class="p">,</span> <span class="n">gpg_url</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a url to gitlab artifacts.zip from a failed &#39;spack ci rebuild&#39; job,</span>
<span class="sd">    attempt to setup an environment in which the failure can be reproduced</span>
<span class="sd">    locally.  This entails the following:</span>

<span class="sd">    First download and extract artifacts.  Then look through those artifacts</span>
<span class="sd">    to glean some information needed for the reproduer (e.g. one of the</span>
<span class="sd">    artifacts contains information about the version of spack tested by</span>
<span class="sd">    gitlab, another is the generated pipeline yaml containing details</span>
<span class="sd">    of the job like the docker image used to run it).  The output of this</span>
<span class="sd">    function is a set of printed instructions for running docker and then</span>
<span class="sd">    commands to run to reproduce the build once inside the container.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
    <span class="n">platform_script_ext</span> <span class="o">=</span> <span class="s2">&quot;ps1&quot;</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s2">&quot;sh&quot;</span>
    <span class="n">download_and_extract_artifacts</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">)</span>

    <span class="n">gpg_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">gpg_url</span><span class="p">:</span>
        <span class="n">gpg_path</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">fetch_url_text</span><span class="p">(</span><span class="n">gpg_url</span><span class="p">,</span> <span class="n">dest_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;_pgp&quot;</span><span class="p">))</span>
        <span class="n">rel_gpg_path</span> <span class="o">=</span> <span class="n">gpg_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="n">lock_file</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;spack.lock&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">repro_lock_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">lock_file</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found lock file in: </span><span class="si">{</span><span class="n">repro_lock_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">yaml_files</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;*.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;*.yml&quot;</span><span class="p">])</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;yaml files:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">yaml_file</span> <span class="ow">in</span> <span class="n">yaml_files</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">yaml_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pipeline_yaml</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Try to find the dynamically generated pipeline yaml file in the</span>
    <span class="c1"># reproducer.  If the user did not put it in the artifacts root,</span>
    <span class="c1"># but rather somewhere else and exported it as an artifact from</span>
    <span class="c1"># that location, we won&#39;t be able to find it.</span>
    <span class="k">for</span> <span class="n">yf</span> <span class="ow">in</span> <span class="n">yaml_files</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yf</span><span class="p">)</span> <span class="k">as</span> <span class="n">y_fd</span><span class="p">:</span>
            <span class="n">yaml_obj</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">y_fd</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;variables&quot;</span> <span class="ow">in</span> <span class="n">yaml_obj</span> <span class="ow">and</span> <span class="s2">&quot;stages&quot;</span> <span class="ow">in</span> <span class="n">yaml_obj</span><span class="p">:</span>
                <span class="n">pipeline_yaml</span> <span class="o">=</span> <span class="n">yaml_obj</span>

    <span class="k">if</span> <span class="n">pipeline_yaml</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">yf</span><span class="si">}</span><span class="s2"> is likely your pipeline file&quot;</span><span class="p">)</span>

    <span class="n">relative_concrete_env_dir</span> <span class="o">=</span> <span class="n">pipeline_yaml</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">][</span><span class="s2">&quot;SPACK_CONCRETE_ENV_DIR&quot;</span><span class="p">]</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative environment path used by cloud job: </span><span class="si">{</span><span class="n">relative_concrete_env_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Using the relative concrete environment path found in the generated</span>
    <span class="c1"># pipeline variable above, copy the spack environment files so they&#39;ll</span>
    <span class="c1"># be found in the same location as when the job ran in the cloud.</span>
    <span class="n">concrete_env_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">relative_concrete_env_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">copy_lock_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">,</span> <span class="s2">&quot;spack.lock&quot;</span><span class="p">)</span>
    <span class="n">orig_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repro_lock_dir</span><span class="p">,</span> <span class="s2">&quot;spack.yaml&quot;</span><span class="p">)</span>
    <span class="n">copy_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concrete_env_dir</span><span class="p">,</span> <span class="s2">&quot;spack.yaml&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">lock_file</span><span class="p">,</span> <span class="n">copy_lock_path</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">orig_yaml_path</span><span class="p">,</span> <span class="n">copy_yaml_path</span><span class="p">)</span>

    <span class="c1"># Find the install script in the unzipped artifacts and make it executable</span>
    <span class="n">install_script</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;install.</span><span class="si">{</span><span class="n">platform_script_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="c1"># pointless on Windows</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">install_script</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">install_script</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IEXEC</span><span class="p">)</span>
    <span class="c1"># Find the repro details file.  This just includes some values we wrote</span>
    <span class="c1"># during `spack ci rebuild` to make reproduction easier.  E.g. the job</span>
    <span class="c1"># name is written here so we can easily find the configuration of the</span>
    <span class="c1"># job from the generated pipeline file.</span>
    <span class="n">repro_file</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;repro.json&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">repro_details</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repro_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">repro_details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="n">repro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">repro_file</span><span class="p">)</span>
    <span class="n">rel_repro_dir</span> <span class="o">=</span> <span class="n">repro_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="c1"># Find the spack info text file that should contain the git log</span>
    <span class="c1"># of the HEAD commit used during the CI build</span>
    <span class="n">spack_info_file</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;spack_info.txt&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">spack_info_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">spack_info</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Access the specific job configuration</span>
    <span class="n">job_name</span> <span class="o">=</span> <span class="n">repro_details</span><span class="p">[</span><span class="s2">&quot;job_name&quot;</span><span class="p">]</span>
    <span class="n">job_yaml</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="n">pipeline_yaml</span><span class="p">:</span>
        <span class="n">job_yaml</span> <span class="o">=</span> <span class="n">pipeline_yaml</span><span class="p">[</span><span class="n">job_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">job_yaml</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found job:&quot;</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">job_yaml</span><span class="p">)</span>

    <span class="n">job_image</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">setup_result</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">job_yaml</span><span class="p">:</span>
        <span class="n">job_image_elt</span> <span class="o">=</span> <span class="n">job_yaml</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">job_image_elt</span><span class="p">:</span>
            <span class="n">job_image</span> <span class="o">=</span> <span class="n">job_image_elt</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_image</span> <span class="o">=</span> <span class="n">job_image_elt</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ran with the following image: </span><span class="si">{</span><span class="n">job_image</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Because we found this job was run with a docker image, so we will try</span>
        <span class="c1"># to print a &quot;docker run&quot; command that bind-mounts the directory where</span>
        <span class="c1"># we extracted the artifacts.</span>

        <span class="c1"># Destination of bind-mounted reproduction directory.  It makes for a</span>
        <span class="c1"># more faithful reproducer if everything appears to run in the same</span>
        <span class="c1"># absolute path used during the CI build.</span>
        <span class="n">mount_as_dir</span> <span class="o">=</span> <span class="s2">&quot;/work&quot;</span>
        <span class="n">mounted_workdir</span> <span class="o">=</span> <span class="s2">&quot;/reproducer&quot;</span>
        <span class="k">if</span> <span class="n">repro_details</span><span class="p">:</span>
            <span class="n">mount_as_dir</span> <span class="o">=</span> <span class="n">repro_details</span><span class="p">[</span><span class="s2">&quot;ci_project_dir&quot;</span><span class="p">]</span>
            <span class="n">mounted_repro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mount_as_dir</span><span class="p">,</span> <span class="n">rel_repro_dir</span><span class="p">)</span>
            <span class="n">mounted_env_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mount_as_dir</span><span class="p">,</span> <span class="n">relative_concrete_env_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gpg_path</span><span class="p">:</span>
                <span class="n">mounted_gpg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mounted_workdir</span><span class="p">,</span> <span class="n">rel_gpg_path</span><span class="p">)</span>

    <span class="c1"># We will also try to clone spack from your local checkout and</span>
    <span class="c1"># reproduce the state present during the CI build, and put that into</span>
    <span class="c1"># the bind-mounted reproducer directory.</span>

    <span class="c1"># Regular expressions for parsing that HEAD commit.  If the pipeline</span>
    <span class="c1"># was on the gitlab spack mirror, it will have been a merge commit made by</span>
    <span class="c1"># gitub and pushed by the sync script.  If the pipeline was run on some</span>
    <span class="c1"># environment repo, then the tested spack commit will likely have been</span>
    <span class="c1"># a regular commit.</span>
    <span class="n">commit_1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">commit_2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">commit_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;commit\s+([^\s]+)&quot;</span><span class="p">)</span>
    <span class="n">merge_commit_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Merge\s+([^\s]+)\s+into\s+([^\s]+)&quot;</span><span class="p">)</span>

    <span class="c1"># Try the more specific merge commit regex first</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">merge_commit_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">spack_info</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="c1"># This was a merge commit and we captured the parents</span>
        <span class="n">commit_1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">commit_2</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Not a merge commit, just get the commit sha</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">commit_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">spack_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">commit_1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">setup_result</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">commit_1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">commit_2</span><span class="p">:</span>
            <span class="n">setup_result</span> <span class="o">=</span> <span class="n">setup_spack_repro_version</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">commit_2</span><span class="p">,</span> <span class="n">merge_commit</span><span class="o">=</span><span class="n">commit_1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">setup_result</span> <span class="o">=</span> <span class="n">setup_spack_repro_version</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">commit_1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">setup_result</span><span class="p">:</span>
        <span class="n">setup_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    This can happen if the spack you are using to run this command is not a git</span>
<span class="s2">    repo, or if it is a git repo, but it does not have the commits needed to</span>
<span class="s2">    recreate the tested merge commit.  If you are trying to reproduce a spack</span>
<span class="s2">    PR pipeline job failure, try fetching the latest develop commits from</span>
<span class="s2">    mainline spack and make sure you have the most recent commit of the PR</span>
<span class="s2">    branch in your local spack repo.  Then run this command again.</span>
<span class="s2">    Alternatively, you can also manually clone spack if you know the version</span>
<span class="s2">    you want to test.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Failed to automatically setup the tested version of spack &quot;</span>
            <span class="s2">&quot;in your local reproduction directory.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">setup_msg</span><span class="p">)</span>

    <span class="c1"># In cases where CI build was run on a shell runner, it might be useful</span>
    <span class="c1"># to see what tags were applied to the job so the user knows what shell</span>
    <span class="c1"># runner was used.  But in that case in general, we cannot do nearly as</span>
    <span class="c1"># much to set up the reproducer.</span>
    <span class="n">job_tags</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;tags&quot;</span> <span class="ow">in</span> <span class="n">job_yaml</span><span class="p">:</span>
        <span class="n">job_tags</span> <span class="o">=</span> <span class="n">job_yaml</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ran with the following tags: </span><span class="si">{</span><span class="n">job_tags</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">entrypoint_script</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;--global&quot;</span><span class="p">,</span> <span class="s2">&quot;--add&quot;</span><span class="p">,</span> <span class="s2">&quot;safe.directory&quot;</span><span class="p">,</span> <span class="n">mount_as_dir</span><span class="p">],</span>
        <span class="p">[</span>
            <span class="s2">&quot;.&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">mount_as_dir</span> <span class="k">if</span> <span class="n">job_image</span> <span class="k">else</span> <span class="n">work_dir</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;share/spack/setup-env.</span><span class="si">{</span><span class="n">platform_script_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;spack&quot;</span><span class="p">,</span> <span class="s2">&quot;gpg&quot;</span><span class="p">,</span> <span class="s2">&quot;trust&quot;</span><span class="p">,</span> <span class="n">mounted_gpg_path</span> <span class="k">if</span> <span class="n">job_image</span> <span class="k">else</span> <span class="n">gpg_path</span><span class="p">]</span> <span class="k">if</span> <span class="n">gpg_path</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="p">[</span><span class="s2">&quot;spack&quot;</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;activate&quot;</span><span class="p">,</span> <span class="n">mounted_env_dir</span> <span class="k">if</span> <span class="n">job_image</span> <span class="k">else</span> <span class="n">repro_dir</span><span class="p">],</span>
        <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mounted_repro_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;install.</span><span class="si">{</span><span class="n">platform_script_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job_image</span>
                <span class="k">else</span> <span class="n">install_script</span>
            <span class="p">)</span>
        <span class="p">],</span>
    <span class="p">]</span>
    <span class="n">entry_script</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mounted_workdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;entrypoint.</span><span class="si">{</span><span class="n">platform_script_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">inst_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Finally, print out some instructions to reproduce the build</span>
    <span class="k">if</span> <span class="n">job_image</span><span class="p">:</span>
        <span class="c1"># Allow interactive</span>
        <span class="n">install_mechanism</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mounted_repro_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;install.</span><span class="si">{</span><span class="n">platform_script_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_image</span>
            <span class="k">else</span> <span class="n">install_script</span>
        <span class="p">)</span>
        <span class="n">entrypoint_script</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Re-run install script using:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">install_mechanism</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        <span class="c1"># Allow interactive</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">entrypoint_script</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;($args -Join &#39; &#39;)&quot;</span><span class="p">,</span> <span class="s2">&quot;-NoExit&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entrypoint_script</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="s2">&quot;$@&quot;</span><span class="p">])</span>

        <span class="n">process_command</span><span class="p">(</span>
            <span class="s2">&quot;entrypoint&quot;</span><span class="p">,</span> <span class="n">entrypoint_script</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exit_on_failure</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">docker_command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">runtime</span><span class="p">,</span>
            <span class="s2">&quot;run&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-t&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--rm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spack_reproducer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
            <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">mounted_workdir</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
            <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;jobs_scratch_dir&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mount_as_dir</span><span class="p">,</span> <span class="s2">&quot;jobs_scratch_dir&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
            <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;spack&quot;</span><span class="p">),</span> <span class="n">mount_as_dir</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;--entrypoint&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">docker_command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;powershell.exe&quot;</span><span class="p">,</span> <span class="n">job_image</span><span class="p">,</span> <span class="n">entry_script</span><span class="p">,</span> <span class="s2">&quot;powershell.exe&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">docker_command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">entry_script</span><span class="p">,</span> <span class="n">job_image</span><span class="p">,</span> <span class="s2">&quot;bash&quot;</span><span class="p">])</span>
        <span class="n">docker_command</span> <span class="o">=</span> <span class="p">[</span><span class="n">docker_command</span><span class="p">]</span>
        <span class="n">autostart</span> <span class="o">=</span> <span class="n">autostart</span> <span class="ow">and</span> <span class="n">setup_result</span>
        <span class="n">process_command</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">docker_command</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">autostart</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">autostart</span><span class="p">:</span>
            <span class="n">inst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">To run the docker reproducer:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">inst_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;    - Start the docker container install&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;       $ </span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/start.</span><span class="si">{</span><span class="n">platform_script_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">autostart</span> <span class="o">=</span> <span class="n">autostart</span> <span class="ow">and</span> <span class="n">setup_result</span>
        <span class="n">process_command</span><span class="p">(</span><span class="s2">&quot;reproducer&quot;</span><span class="p">,</span> <span class="n">entrypoint_script</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">autostart</span><span class="p">)</span>

        <span class="n">inst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Once on the tagged runner:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">inst_list</span><span class="o">.</span><span class="n">extent</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;    - Run the reproducer script&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;       $ </span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/reproducer.</span><span class="si">{</span><span class="n">platform_script_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">setup_result</span><span class="p">:</span>
        <span class="n">inst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - Clone spack and acquire tested commit&quot;</span><span class="p">)</span>
        <span class="n">inst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        </span><span class="si">{</span><span class="n">spack_info</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">inst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">inst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        Path to clone spack: </span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/spack</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inst_list</span><span class="p">))</span></div>



<div class="viewcode-block" id="process_command">
<a class="viewcode-back" href="../../spack.html#spack.ci.process_command">[docs]</a>
<span class="k">def</span> <span class="nf">process_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">repro_dir</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exit_on_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a script for and run the command. Copy the script to the</span>
<span class="sd">    reproducibility directory.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        name (str): name of the command being processed</span>
<span class="sd">        commands (list): list of arguments for single command or list of lists of</span>
<span class="sd">            arguments for multiple commands. No shell escape is performed.</span>
<span class="sd">        repro_dir (str): Job reproducibility directory</span>
<span class="sd">        run (bool): Run the script and return the exit code if True</span>

<span class="sd">    Returns: the exit code from processing the command</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spack </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> arguments: </span><span class="si">{</span><span class="n">commands</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">commands</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">compose_command_err_handling</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="n">arg_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">arg_str</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="c1"># ErrorActionPreference will handle PWSH commandlets (Spack calls),</span>
        <span class="c1"># but we need to handle EXEs (git, etc) ourselves</span>
        <span class="n">catch_exe_failure</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">if ($LASTEXITCODE -ne 0){{</span>
<span class="sd">    throw &#39;Command {} has failed&#39;</span>
<span class="sd">}}</span>
<span class="sd">&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">IS_WINDOWS</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">exit_on_failure</span> <span class="ow">and</span> <span class="n">catch_exe_failure</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">catch_exe_failure</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Create a string [command 1] \n [command 2] \n ... \n [command n] with</span>
    <span class="c1"># commands composed into a platform dependent shell script, pwsh on Windows,</span>
    <span class="n">full_command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">compose_command_err_handling</span><span class="p">,</span> <span class="n">commands</span><span class="p">))</span>
    <span class="c1"># Write the command to a python script</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.ps1&quot;</span>
        <span class="n">script_content</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># spack </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> command</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exit_on_failure</span><span class="p">:</span>
            <span class="n">script_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$ErrorActionPreference = &quot;Stop&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_VERBOSE_SCRIPT&quot;</span><span class="p">):</span>
            <span class="n">script_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Set-PSDebug -Trace 2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.sh&quot;</span>
        <span class="n">script_content</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#!/bin/sh</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># spack </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> command</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exit_on_failure</span><span class="p">:</span>
            <span class="n">script_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;set -e</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_VERBOSE_SCRIPT&quot;</span><span class="p">):</span>
            <span class="n">script_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;set -x</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">script_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_command</span><span class="p">)</span>
    <span class="n">script_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">script_content</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">copy_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repro_dir</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">copy_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">copy_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">copy_path</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IEXEC</span><span class="p">)</span>

    <span class="c1"># Run the generated shell script as if it were being run in</span>
    <span class="c1"># a login shell.</span>
    <span class="n">exit_code</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We use sh as executor on Linux like platforms, pwsh on Windows</span>
            <span class="n">interpreter</span> <span class="o">=</span> <span class="s2">&quot;powershell.exe&quot;</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s2">&quot;/bin/sh&quot;</span>
            <span class="n">cmd_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">interpreter</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">script</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="n">cmd_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">cmd_process</span><span class="o">.</span><span class="n">returncode</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encountered error running </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> script&quot;</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spack </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> exited </span><span class="si">{</span><span class="n">exit_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Delete the script, it is copied to the destination dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exit_code</span></div>



<div class="viewcode-block" id="create_buildcache">
<a class="viewcode-back" href="../../spack.html#spack.ci.create_buildcache">[docs]</a>
<span class="k">def</span> <span class="nf">create_buildcache</span><span class="p">(</span>
    <span class="n">input_spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">destination_mirror_urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sign_binaries</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PushResult</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the buildcache at the provided mirror(s).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        input_spec: Installed spec to package and push</span>
<span class="sd">        destination_mirror_urls: List of urls to push to</span>
<span class="sd">        sign_binaries: Whether or not to sign buildcache entry</span>

<span class="sd">    Returns: A list of PushResults, indicating success or failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">mirror_url</span> <span class="ow">in</span> <span class="n">destination_mirror_urls</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">PushResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="n">push_to_build_cache</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">mirror_url</span><span class="p">,</span> <span class="n">sign_binaries</span><span class="p">),</span> <span class="n">url</span><span class="o">=</span><span class="n">mirror_url</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="write_broken_spec">
<a class="viewcode-back" href="../../spack.html#spack.ci.write_broken_spec">[docs]</a>
<span class="k">def</span> <span class="nf">write_broken_spec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">job_url</span><span class="p">,</span> <span class="n">pipeline_url</span><span class="p">,</span> <span class="n">spec_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a url to write to and the details of the failed job, write an entry</span>
<span class="sd">    in the broken specs list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;broken.txt&quot;</span><span class="p">)</span>

    <span class="n">broken_spec_details</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;broken-spec&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;job-name&quot;</span><span class="p">:</span> <span class="n">pkg_name</span><span class="p">,</span>
            <span class="s2">&quot;job-stack&quot;</span><span class="p">:</span> <span class="n">stack_name</span><span class="p">,</span>
            <span class="s2">&quot;job-url&quot;</span><span class="p">:</span> <span class="n">job_url</span><span class="p">,</span>
            <span class="s2">&quot;pipeline-url&quot;</span><span class="p">:</span> <span class="n">pipeline_url</span><span class="p">,</span>
            <span class="s2">&quot;concrete-spec-dict&quot;</span><span class="p">:</span> <span class="n">spec_dict</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">syaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">broken_spec_details</span><span class="p">))</span>
        <span class="n">web_util</span><span class="o">.</span><span class="n">push_to_url</span><span class="p">(</span>
            <span class="n">file_path</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ContentType&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="c1"># If there is an S3 error (e.g., access denied or connection</span>
        <span class="c1"># error), the first non boto-specific class in the exception</span>
        <span class="c1"># hierarchy is Exception.  Just print a warning and return</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error writing to broken specs list </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_broken_spec">
<a class="viewcode-back" href="../../spack.html#spack.ci.read_broken_spec">[docs]</a>
<span class="k">def</span> <span class="nf">read_broken_spec</span><span class="p">(</span><span class="n">broken_spec_url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read data from broken specs file located at the url, return as a yaml</span>
<span class="sd">    object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">read_from_url</span><span class="p">(</span><span class="n">broken_spec_url</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">web_util</span><span class="o">.</span><span class="n">SpackWebError</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to read broken spec from </span><span class="si">{</span><span class="n">broken_spec_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">broken_spec_contents</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">fs</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">syaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">broken_spec_contents</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_broken_spec_messages">
<a class="viewcode-back" href="../../spack.html#spack.ci.display_broken_spec_messages">[docs]</a>
<span class="k">def</span> <span class="nf">display_broken_spec_messages</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">hashes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch the broken spec file for each of the hashes under the base_url and</span>
<span class="sd">    print a message with some details about each one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">broken_specs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">read_broken_spec</span><span class="p">(</span><span class="n">url_util</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">h</span><span class="p">)))</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hashes</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">spec_hash</span><span class="p">,</span> <span class="n">broken_spec</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tup</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">broken_specs</span> <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">broken_spec</span><span class="p">[</span><span class="s2">&quot;broken-spec&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;job-name&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">item_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;job-name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spec_hash</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item_name</span> <span class="o">=</span> <span class="n">spec_hash</span>

        <span class="k">if</span> <span class="s2">&quot;job-stack&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">item_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item_name</span><span class="si">}</span><span class="s2"> (in stack </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;job-stack&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">item_name</span><span class="si">}</span><span class="s2"> was reported broken here: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;job-url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="run_standalone_tests">
<a class="viewcode-back" href="../../spack.html#spack.ci.run_standalone_tests">[docs]</a>
<span class="k">def</span> <span class="nf">run_standalone_tests</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run stand-alone tests on the current spec.</span>

<span class="sd">    Arguments:</span>
<span class="sd">       kwargs (dict): dictionary of arguments used to run the tests</span>

<span class="sd">    List of recognized keys:</span>

<span class="sd">    * &quot;cdash&quot; (CDashHandler): (optional) cdash handler instance</span>
<span class="sd">    * &quot;fail_fast&quot; (bool): (optional) terminate tests after the first failure</span>
<span class="sd">    * &quot;log_file&quot; (str): (optional) test log file name if NOT CDash reporting</span>
<span class="sd">    * &quot;job_spec&quot; (Spec): spec that was built</span>
<span class="sd">    * &quot;repro_dir&quot; (str): reproduction directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cdash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cdash&quot;</span><span class="p">)</span>
    <span class="n">fail_fast</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fail_fast&quot;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cdash</span> <span class="ow">and</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The test log file </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2"> option is ignored with CDash reporting&quot;</span><span class="p">)</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Error out but do NOT terminate if there are missing required arguments.</span>
    <span class="n">job_spec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job_spec&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_spec</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Job spec is required to run stand-alone tests&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">repro_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repro_dir&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">repro_dir</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Reproduction directory is required for stand-alone tests&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">test_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spack&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=always&quot;</span><span class="p">,</span> <span class="s2">&quot;--backtrace&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fail_fast</span><span class="p">:</span>
        <span class="n">test_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--fail-fast&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cdash</span><span class="p">:</span>
        <span class="n">test_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cdash</span><span class="o">.</span><span class="n">args</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--log-format&quot;</span><span class="p">,</span> <span class="s2">&quot;junit&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">log_file</span><span class="p">:</span>
            <span class="n">test_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--log-file&quot;</span><span class="p">,</span> <span class="n">log_file</span><span class="p">])</span>
    <span class="n">test_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running </span><span class="si">{</span><span class="n">job_spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> stand-alone tests&quot;</span><span class="p">)</span>
    <span class="n">exit_code</span> <span class="o">=</span> <span class="n">process_command</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">test_args</span><span class="p">,</span> <span class="n">repro_dir</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spack test exited </span><span class="si">{</span><span class="n">exit_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="CDashHandler">
<a class="viewcode-back" href="../../spack.html#spack.ci.CDashHandler">[docs]</a>
<span class="k">class</span> <span class="nc">CDashHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for managing CDash data and processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci_cdash</span><span class="p">):</span>
        <span class="c1"># start with the gitlab ci configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">ci_cdash</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_group</span> <span class="o">=</span> <span class="n">ci_cdash</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;build-group&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">ci_cdash</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">ci_cdash</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">)</span>

        <span class="c1"># grab the authorization token when available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_CDASH_AUTH_TOKEN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_token</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Using CDash auth token from environment&quot;</span><span class="p">)</span>

        <span class="c1"># append runner description to the site if available</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CI_RUNNER_DESCRIPTION&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runner</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">runner</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="c1"># track current spec, if any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_spec</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CDashHandler.args">
<a class="viewcode-back" href="../../spack.html#spack.ci.CDashHandler.args">[docs]</a>
    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;--cdash-upload-url&quot;</span><span class="p">,</span>
            <span class="n">win_quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_url</span><span class="p">),</span>
            <span class="s2">&quot;--cdash-build&quot;</span><span class="p">,</span>
            <span class="n">win_quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_name</span><span class="p">),</span>
            <span class="s2">&quot;--cdash-site&quot;</span><span class="p">,</span>
            <span class="n">win_quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">),</span>
            <span class="s2">&quot;--cdash-buildstamp&quot;</span><span class="p">,</span>
            <span class="n">win_quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_stamp</span><span class="p">),</span>
        <span class="p">]</span></div>


    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span> <span class="nf">build_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the CDash build name.</span>

<span class="sd">        A name will be generated if the `current_spec` property is set;</span>
<span class="sd">        otherwise, the value will be retrieved from the environment</span>
<span class="sd">        through the `SPACK_CDASH_BUILD_NAME` variable.</span>

<span class="sd">        Returns: (str) current spec&#39;s CDash build name.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_spec</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">build_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">%</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">hash=</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2"> arch=</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">build_group</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated CDash build name (</span><span class="si">{</span><span class="n">build_name</span><span class="si">}</span><span class="s2">) from the </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">build_name</span>

        <span class="n">build_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_CDASH_BUILD_NAME&quot;</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using CDash build name (</span><span class="si">{</span><span class="n">build_name</span><span class="si">}</span><span class="s2">) from the environment&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">build_name</span>

    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span> <span class="nf">build_stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the CDash build stamp.</span>

<span class="sd">        The one defined by SPACK_CDASH_BUILD_STAMP environment variable</span>
<span class="sd">        is preferred due to the representation of timestamps; otherwise,</span>
<span class="sd">        one will be built.</span>

<span class="sd">        Returns: (str) current CDash build stamp&quot;&quot;&quot;</span>
        <span class="n">build_stamp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SPACK_CDASH_BUILD_STAMP&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">build_stamp</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using build stamp (</span><span class="si">{</span><span class="n">build_stamp</span><span class="si">}</span><span class="s2">) from the environment&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">build_stamp</span>

        <span class="n">build_stamp</span> <span class="o">=</span> <span class="n">cdash_build_stamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_group</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated new build stamp (</span><span class="si">{</span><span class="n">build_stamp</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">build_stamp</span>

    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
    <span class="nd">@memoized</span>
    <span class="k">def</span> <span class="nf">project_enc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoding project (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">encode</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">({</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">})</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">encode</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">encode</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">upload_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/submit.php?project=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_enc</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">url_format</span>

<div class="viewcode-block" id="CDashHandler.copy_test_results">
<a class="viewcode-back" href="../../spack.html#spack.ci.CDashHandler.copy_test_results">[docs]</a>
    <span class="k">def</span> <span class="nf">copy_test_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy test results to artifacts directory.&quot;&quot;&quot;</span>
        <span class="n">reports</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;*_Test*.xml&quot;</span><span class="p">)</span>
        <span class="n">copy_files_to_artifacts</span><span class="p">(</span><span class="n">reports</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span></div>


<div class="viewcode-block" id="CDashHandler.create_buildgroup">
<a class="viewcode-back" href="../../spack.html#spack.ci.CDashHandler.create_buildgroup">[docs]</a>
    <span class="k">def</span> <span class="nf">create_buildgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opener</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_type</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;newbuildgroup&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">group_type</span><span class="p">}</span>

        <span class="n">enc_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">enc_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">SPACK_CDASH_TIMEOUT</span><span class="p">)</span>
        <span class="n">response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">response_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Creating buildgroup failed (response code = </span><span class="si">{</span><span class="n">response_code</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
        <span class="n">build_group_id</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">build_group_id</span></div>


<div class="viewcode-block" id="CDashHandler.populate_buildgroup">
<a class="viewcode-back" href="../../spack.html#spack.ci.CDashHandler.populate_buildgroup">[docs]</a>
    <span class="k">def</span> <span class="nf">populate_buildgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_names</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/api/v1/buildgroup.php&quot;</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">opener</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span><span class="n">HTTPHandler</span><span class="p">)</span>

        <span class="n">parent_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_buildgroup</span><span class="p">(</span><span class="n">opener</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_group</span><span class="p">,</span> <span class="s2">&quot;Daily&quot;</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_buildgroup</span><span class="p">(</span>
            <span class="n">opener</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Latest </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">build_group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Latest&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_group_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">group_id</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to create or retrieve buildgroups for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">build_group</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dynamiclist&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;parentgroupid&quot;</span><span class="p">:</span> <span class="n">parent_group_id</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">job_names</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="n">enc_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">enc_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">get_method</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;PUT&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">SPACK_CDASH_TIMEOUT</span><span class="p">)</span>
        <span class="n">response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">response_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error response code (</span><span class="si">{</span><span class="n">response_code</span><span class="si">}</span><span class="s2">) in populate_buildgroup&quot;</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="CDashHandler.report_skipped">
<a class="viewcode-back" href="../../spack.html#spack.ci.CDashHandler.report_skipped">[docs]</a>
    <span class="k">def</span> <span class="nf">report_skipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">report_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Explicitly report skipping testing of a spec (e.g., it&#39;s CI</span>
<span class="sd">        configuration identifies it as known to have broken tests or</span>
<span class="sd">        the CI installation failed).</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: spec being tested</span>
<span class="sd">            report_dir: directory where the report will be written</span>
<span class="sd">            reason: reason the test is being skipped</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="n">CDashConfiguration</span><span class="p">(</span>
            <span class="n">upload_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_url</span><span class="p">,</span>
            <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
            <span class="n">build</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_name</span><span class="p">,</span>
            <span class="n">site</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span>
            <span class="n">buildstamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_stamp</span><span class="p">,</span>
            <span class="n">track</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">reporter</span> <span class="o">=</span> <span class="n">CDash</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">test_skipped_report</span><span class="p">(</span><span class="n">report_dir</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SpackCIError">
<a class="viewcode-back" href="../../spack.html#spack.ci.SpackCIError">[docs]</a>
<span class="k">class</span> <span class="nc">SpackCIError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>