

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.package_base &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.package_base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.package_base</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="sd">&quot;&quot;&quot;This is where most of the action happens in Spack.</span>

<span class="sd">The spack package class structure is based strongly on Homebrew</span>
<span class="sd">(http://brew.sh/), mainly because Homebrew makes it very easy to create</span>
<span class="sd">packages.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">llnl.util.filesystem</span> <span class="k">as</span> <span class="nn">fsys</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>
<span class="kn">from</span> <span class="nn">llnl.util.lang</span> <span class="kn">import</span> <span class="n">classproperty</span><span class="p">,</span> <span class="n">memoized</span>
<span class="kn">from</span> <span class="nn">llnl.util.link_tree</span> <span class="kn">import</span> <span class="n">LinkTree</span>

<span class="kn">import</span> <span class="nn">spack.builder</span>
<span class="kn">import</span> <span class="nn">spack.compilers</span>
<span class="kn">import</span> <span class="nn">spack.config</span>
<span class="kn">import</span> <span class="nn">spack.dependency</span>
<span class="kn">import</span> <span class="nn">spack.deptypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">spack.directives</span>
<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.fetch_strategy</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">import</span> <span class="nn">spack.hooks</span>
<span class="kn">import</span> <span class="nn">spack.mirror</span>
<span class="kn">import</span> <span class="nn">spack.multimethod</span>
<span class="kn">import</span> <span class="nn">spack.patch</span>
<span class="kn">import</span> <span class="nn">spack.repo</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.store</span>
<span class="kn">import</span> <span class="nn">spack.url</span>
<span class="kn">import</span> <span class="nn">spack.util.environment</span>
<span class="kn">import</span> <span class="nn">spack.util.path</span>
<span class="kn">import</span> <span class="nn">spack.util.web</span>
<span class="kn">from</span> <span class="nn">spack.error</span> <span class="kn">import</span> <span class="n">InstallError</span><span class="p">,</span> <span class="n">NoURLError</span><span class="p">,</span> <span class="n">PackageError</span>
<span class="kn">from</span> <span class="nn">spack.filesystem_view</span> <span class="kn">import</span> <span class="n">YamlFilesystemView</span>
<span class="kn">from</span> <span class="nn">spack.install_test</span> <span class="kn">import</span> <span class="n">PackageTest</span><span class="p">,</span> <span class="n">TestSuite</span>
<span class="kn">from</span> <span class="nn">spack.solver.version_order</span> <span class="kn">import</span> <span class="n">concretization_version_order</span>
<span class="kn">from</span> <span class="nn">spack.stage</span> <span class="kn">import</span> <span class="n">DevelopStage</span><span class="p">,</span> <span class="n">ResourceStage</span><span class="p">,</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">StageComposite</span><span class="p">,</span> <span class="n">compute_stage_name</span>
<span class="kn">from</span> <span class="nn">spack.util.package_hash</span> <span class="kn">import</span> <span class="n">package_hash</span>
<span class="kn">from</span> <span class="nn">spack.version</span> <span class="kn">import</span> <span class="n">GitVersion</span><span class="p">,</span> <span class="n">StandardVersion</span>

<span class="n">FLAG_HANDLER_RETURN_TYPE</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="p">]</span>
<span class="n">FLAG_HANDLER_TYPE</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">FLAG_HANDLER_RETURN_TYPE</span><span class="p">]</span>

<span class="sd">&quot;&quot;&quot;Allowed URL schemes for spack packages.&quot;&quot;&quot;</span>
<span class="n">_ALLOWED_URL_SCHEMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;ftp&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span><span class="p">]</span>


<span class="c1">#: Filename for the Spack build/install log.</span>
<span class="n">_spack_build_logfile</span> <span class="o">=</span> <span class="s2">&quot;spack-build-out.txt&quot;</span>

<span class="c1">#: Filename for the Spack build/install environment file.</span>
<span class="n">_spack_build_envfile</span> <span class="o">=</span> <span class="s2">&quot;spack-build-env.txt&quot;</span>

<span class="c1">#: Filename for the Spack build/install environment modifications file.</span>
<span class="n">_spack_build_envmodsfile</span> <span class="o">=</span> <span class="s2">&quot;spack-build-env-mods.txt&quot;</span>

<span class="c1">#: Filename for the Spack configure args file.</span>
<span class="n">_spack_configure_argsfile</span> <span class="o">=</span> <span class="s2">&quot;spack-configure-args.txt&quot;</span>

<span class="c1">#: Filename of json with total build and phase times (seconds)</span>
<span class="n">spack_times_log</span> <span class="o">=</span> <span class="s2">&quot;install_times.json&quot;</span>


<div class="viewcode-block" id="deprecated_version">
<a class="viewcode-back" href="../../spack.html#spack.package_base.deprecated_version">[docs]</a>
<span class="k">def</span> <span class="nf">deprecated_version</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;PackageBase&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StandardVersion</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True iff the version is deprecated.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        pkg: The package whose version is to be checked.</span>
<span class="sd">        version: The version being checked</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">StandardVersion</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">StandardVersion</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

    <span class="n">details</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">details</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="preferred_version">
<a class="viewcode-back" href="../../spack.html#spack.package_base.preferred_version">[docs]</a>
<span class="k">def</span> <span class="nf">preferred_version</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;PackageBase&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a sorted list of the preferred versions of the package.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        pkg: The package whose versions are to be assessed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">version</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">concretization_version_order</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">version</span></div>



<div class="viewcode-block" id="WindowsRPath">
<a class="viewcode-back" href="../../spack.html#spack.package_base.WindowsRPath">[docs]</a>
<span class="k">class</span> <span class="nc">WindowsRPath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collection of functionality surrounding Windows RPATH specific features</span>

<span class="sd">    This is essentially meaningless for all other platforms</span>
<span class="sd">    due to their use of RPATH. All methods within this class are no-ops on</span>
<span class="sd">    non Windows. Packages can customize and manipulate this class as</span>
<span class="sd">    they would a genuine RPATH, i.e. adding directories that contain</span>
<span class="sd">    runtime library dependencies&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WindowsRPath.win_add_library_dependent">
<a class="viewcode-back" href="../../spack.html#spack.package_base.WindowsRPath.win_add_library_dependent">[docs]</a>
    <span class="k">def</span> <span class="nf">win_add_library_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return extra set of directories that require linking for package</span>

<span class="sd">        This method should be overridden by packages that produce</span>
<span class="sd">        binaries/libraries/python extension modules/etc that are installed into</span>
<span class="sd">        directories outside a package&#39;s `bin`, `lib`, and `lib64` directories,</span>
<span class="sd">        but still require linking against one of the packages dependencies, or</span>
<span class="sd">        other components of the package itself. No-op otherwise.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of additional directories that require linking</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="WindowsRPath.win_add_rpath">
<a class="viewcode-back" href="../../spack.html#spack.package_base.WindowsRPath.win_add_rpath">[docs]</a>
    <span class="k">def</span> <span class="nf">win_add_rpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return extra set of rpaths for package</span>

<span class="sd">        This method should be overridden by packages needing to</span>
<span class="sd">        include additional paths to be searched by rpath. No-op otherwise</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of additional rpaths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="WindowsRPath.windows_establish_runtime_linkage">
<a class="viewcode-back" href="../../spack.html#spack.package_base.WindowsRPath.windows_establish_runtime_linkage">[docs]</a>
    <span class="k">def</span> <span class="nf">windows_establish_runtime_linkage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish RPATH on Windows</span>

<span class="sd">        Performs symlinking to incorporate rpath dependencies to Windows runtime search paths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If spec is an external, we should not be modifying its bin directory, as we would</span>
        <span class="c1"># be doing in this method</span>
        <span class="c1"># Spack should in general not modify things it has not installed</span>
        <span class="c1"># we can reasonably expect externals to have their link interface properly established</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win_rpath</span><span class="o">.</span><span class="n">add_library_dependent</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">win_add_library_dependent</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win_rpath</span><span class="o">.</span><span class="n">add_rpath</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">win_add_rpath</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win_rpath</span><span class="o">.</span><span class="n">establish_link</span><span class="p">()</span></div>
</div>



<span class="c1">#: Registers which are the detectable packages, by repo and package name</span>
<span class="c1">#: Need a pass of package repositories to be filled.</span>
<span class="n">detectable_packages</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>


<div class="viewcode-block" id="DetectablePackageMeta">
<a class="viewcode-back" href="../../spack.html#spack.package_base.DetectablePackageMeta">[docs]</a>
<span class="k">class</span> <span class="nc">DetectablePackageMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a package is detectable and add default implementations</span>
<span class="sd">    for the detection function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TAG</span> <span class="o">=</span> <span class="s2">&quot;detectable&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;executables&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;libraries&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;a package can have either an &#39;executables&#39; or &#39;libraries&#39; attribute&quot;</span>
            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> [package &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; defines both]&quot;</span><span class="p">)</span>

        <span class="c1"># On windows, extend the list of regular expressions to look for</span>
        <span class="c1"># filenames ending with &quot;.exe&quot;</span>
        <span class="c1"># (in some cases these regular expressions include &quot;$&quot; to avoid</span>
        <span class="c1"># pulling in filenames with unexpected suffixes, but this allows</span>
        <span class="c1"># for example detecting &quot;foo.exe&quot; when the package writer specified</span>
        <span class="c1"># that &quot;foo&quot; was a possible executable.</span>

        <span class="c1"># If a package has the executables or libraries  attribute then it&#39;s</span>
        <span class="c1"># assumed to be detectable. Add a tag, so finding them is faster</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;executables&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;libraries&quot;</span><span class="p">):</span>
            <span class="c1"># To add the tag, we need to copy the tags attribute, and attach it to</span>
            <span class="c1"># the current class. We don&#39;t use append, since it might modify base classes,</span>
            <span class="c1"># if &quot;tags&quot; is retrieved following the MRO.</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">DetectablePackageMeta</span><span class="o">.</span><span class="n">TAG</span><span class="p">]</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">platform_executables</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">to_windows_exe</span><span class="p">(</span><span class="n">exe</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">exe</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
                        <span class="n">exe</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">win_exe_ext</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">exe</span> <span class="o">+=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">win_exe_ext</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">exe</span>

                <span class="n">plat_exe</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;executables&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">exe</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">executables</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
                            <span class="n">exe</span> <span class="o">=</span> <span class="n">to_windows_exe</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
                        <span class="n">plat_exe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">plat_exe</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">determine_spec_details</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">objs_in_prefix</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Allow ``spack external find ...`` to locate installations.</span>

<span class="sd">                Args:</span>
<span class="sd">                    prefix (str): the directory containing the executables</span>
<span class="sd">                                  or libraries</span>
<span class="sd">                    objs_in_prefix (set): the executables or libraries that</span>
<span class="sd">                                          match the regex</span>

<span class="sd">                Returns:</span>
<span class="sd">                    The list of detected specs for this package</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">objs_by_version</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                <span class="c1"># The default filter function is the identity function for the</span>
                <span class="c1"># list of executables</span>
                <span class="n">filter_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;filter_detected_exes&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">exes</span><span class="p">:</span> <span class="n">exes</span><span class="p">)</span>
                <span class="n">objs_in_prefix</span> <span class="o">=</span> <span class="n">filter_fn</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">objs_in_prefix</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs_in_prefix</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">version_str</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">determine_version</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">version_str</span><span class="p">:</span>
                            <span class="n">objs_by_version</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot detect the version of &#39;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&#39; [</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

                <span class="n">specs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">version_str</span><span class="p">,</span> <span class="n">objs</span> <span class="ow">in</span> <span class="n">objs_by_version</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">variants</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">determine_variants</span><span class="p">(</span><span class="n">objs</span><span class="p">,</span> <span class="n">version_str</span><span class="p">)</span>
                    <span class="c1"># Normalize output to list</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variants</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">variants</span> <span class="o">=</span> <span class="p">[</span><span class="n">variants</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">variant</span> <span class="o">=</span> <span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">variant_str</span><span class="p">,</span> <span class="n">extra_attributes</span> <span class="o">=</span> <span class="n">variant</span>
                        <span class="n">spec_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">variant_str</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="c1"># Pop a few reserved keys from extra attributes, since</span>
                        <span class="c1"># they have a different semantics</span>
                        <span class="n">external_path</span> <span class="o">=</span> <span class="n">extra_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">external_modules</span> <span class="o">=</span> <span class="n">extra_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">from_detection</span><span class="p">(</span>
                                <span class="n">spec_str</span><span class="p">,</span>
                                <span class="n">external_path</span><span class="o">=</span><span class="n">external_path</span><span class="p">,</span>
                                <span class="n">external_modules</span><span class="o">=</span><span class="n">external_modules</span><span class="p">,</span>
                                <span class="n">extra_attributes</span><span class="o">=</span><span class="n">extra_attributes</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Parsing failed [spec_str=&quot;</span><span class="si">{</span><span class="n">spec_str</span><span class="si">}</span><span class="s1">&quot;, error=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

                <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">determine_variants</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="n">version_str</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Register the class as a detectable package</span>
            <span class="n">detectable_packages</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">namespace</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Attach function implementations to the detectable class</span>
            <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;determine_spec_details&quot;</span><span class="p">):</span>
                <span class="n">default</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">determine_spec_details</span> <span class="o">=</span> <span class="n">determine_spec_details</span>

            <span class="k">if</span> <span class="n">default</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;determine_version&quot;</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;the package &quot;</span><span class="si">{0}</span><span class="s1">&quot; in the &quot;</span><span class="si">{1}</span><span class="s1">&quot; repo needs to define&#39;</span>
                    <span class="s1">&#39; the &quot;determine_version&quot; method to be detectable&#39;</span>
                <span class="p">)</span>
                <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">namespace</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">default</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;determine_variants&quot;</span><span class="p">):</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">determine_variants</span> <span class="o">=</span> <span class="n">determine_variants</span>

            <span class="c1"># This function should not be overridden by subclasses,</span>
            <span class="c1"># as it is not designed for bespoke pkg detection but rather</span>
            <span class="c1"># on a per-platform basis</span>
            <span class="k">if</span> <span class="s2">&quot;platform_executables&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">PackageError</span><span class="p">(</span><span class="s2">&quot;Packages should not override platform_executables&quot;</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">platform_executables</span> <span class="o">=</span> <span class="n">platform_executables</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DetectablePackageMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">)</span></div>



<div class="viewcode-block" id="PackageMeta">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageMeta">[docs]</a>
<span class="k">class</span> <span class="nc">PackageMeta</span><span class="p">(</span>
    <span class="n">spack</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">PhaseCallbacksMeta</span><span class="p">,</span>
    <span class="n">DetectablePackageMeta</span><span class="p">,</span>
    <span class="n">spack</span><span class="o">.</span><span class="n">directives</span><span class="o">.</span><span class="n">DirectiveMeta</span><span class="p">,</span>
    <span class="n">spack</span><span class="o">.</span><span class="n">multimethod</span><span class="o">.</span><span class="n">MultiMethodMeta</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Package metaclass for supporting directives (e.g., depends_on) and phases</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FIXME: REWRITE</span>
<span class="sd">        Instance creation is preceded by phase attribute transformations.</span>

<span class="sd">        Conveniently transforms attributes to permit extensible phases by</span>
<span class="sd">        iterating over the attribute &#39;phases&#39; and creating / updating private</span>
<span class="sd">        InstallPhase attributes in the class that will be initialized in</span>
<span class="sd">        __init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PackageMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">)</span></div>



<div class="viewcode-block" id="on_package_attributes">
<a class="viewcode-back" href="../../spack.html#spack.package_base.on_package_attributes">[docs]</a>
<span class="k">def</span> <span class="nf">on_package_attributes</span><span class="p">(</span><span class="o">**</span><span class="n">attr_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator: executes instance function only if object has attr valuses.</span>

<span class="sd">    Executes the decorated method only if at the moment of calling the</span>
<span class="sd">    instance has attributes that are equal to certain values.</span>

<span class="sd">    Args:</span>
<span class="sd">        attr_dict (dict): dictionary mapping attribute names to their</span>
<span class="sd">            required values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_under_condition</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># If all the attributes have the value we require, then execute</span>
            <span class="n">has_all_attributes</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">has_all_attributes</span><span class="p">:</span>
                <span class="n">has_the_right_values</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">]</span>  <span class="c1"># NOQA: ignore=E501</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">has_the_right_values</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_wrapper</span>

    <span class="k">return</span> <span class="n">_execute_under_condition</span></div>



<div class="viewcode-block" id="PackageViewMixin">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageViewMixin">[docs]</a>
<span class="k">class</span> <span class="nc">PackageViewMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This collects all functionality related to adding installed Spack</span>
<span class="sd">    package to views. Packages can customize how they are added to views by</span>
<span class="sd">    overriding these functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PackageViewMixin.view_source">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageViewMixin.view_source">[docs]</a>
    <span class="k">def</span> <span class="nf">view_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The source root directory that will be added to the view: files are</span>
<span class="sd">        added such that their path relative to the view destination matches</span>
<span class="sd">        their path relative to the view source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span></div>


<div class="viewcode-block" id="PackageViewMixin.view_destination">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageViewMixin.view_destination">[docs]</a>
    <span class="k">def</span> <span class="nf">view_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The target root directory: each file is added relative to this</span>
<span class="sd">        directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">get_projection_for_spec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageViewMixin.view_file_conflicts">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageViewMixin.view_file_conflicts">[docs]</a>
    <span class="k">def</span> <span class="nf">view_file_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">merge_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Report any files which prevent adding this package to the view. The</span>
<span class="sd">        default implementation looks for any files which already exist.</span>
<span class="sd">        Alternative implementations may allow some of the files to exist in</span>
<span class="sd">        the view (in this case they would be omitted from the results).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">dst</span> <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">merge_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span></div>


<div class="viewcode-block" id="PackageViewMixin.add_files_to_view">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageViewMixin.add_files_to_view">[docs]</a>
    <span class="k">def</span> <span class="nf">add_files_to_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">merge_map</span><span class="p">,</span> <span class="n">skip_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a map of package files to destination paths in the view, add</span>
<span class="sd">        the files to the view. By default this adds all files. Alternative</span>
<span class="sd">        implementations may skip some files, for example if other packages</span>
<span class="sd">        linked into the view already include the file.</span>

<span class="sd">        Args:</span>
<span class="sd">            view (spack.filesystem_view.FilesystemView): the view that&#39;s updated</span>
<span class="sd">            merge_map (dict): maps absolute source paths to absolute dest paths for</span>
<span class="sd">                all files in from this package.</span>
<span class="sd">            skip_if_exists (bool): when True, don&#39;t link files in view when they</span>
<span class="sd">                already exist. When False, always link files, without checking</span>
<span class="sd">                if they already exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">skip_if_exists</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">merge_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">merge_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">view</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageViewMixin.remove_files_from_view">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageViewMixin.remove_files_from_view">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_files_from_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">merge_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a map of package files to files currently linked in the view,</span>
<span class="sd">        remove the files from the view. The default implementation removes all</span>
<span class="sd">        files. Alternative implementations may not remove all files. For</span>
<span class="sd">        example if two packages include the same file, it should only be</span>
<span class="sd">        removed when both packages are removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view</span><span class="o">.</span><span class="n">remove_files</span><span class="p">(</span><span class="n">merge_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>
</div>



<span class="n">Pb</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;Pb&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;PackageBase&quot;</span><span class="p">)</span>

<span class="n">WhenDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<span class="n">NameValuesDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
<span class="n">NameWhenDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>


<span class="k">def</span> <span class="nf">_by_name</span><span class="p">(</span>
    <span class="n">when_indexed_dictionary</span><span class="p">:</span> <span class="n">WhenDict</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">NameValuesDict</span><span class="p">,</span> <span class="n">NameWhenDict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a dict of dicts keyed by when/name into a dict of lists keyed by name.</span>

<span class="sd">    Optional Arguments:</span>
<span class="sd">        when: if ``True``, don&#39;t discared the ``when`` specs; return a 2-level dictionary</span>
<span class="sd">            keyed by name and when spec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># very hard to define this type to be conditional on `when`</span>
    <span class="n">all_by_name</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">by_name</span> <span class="ow">in</span> <span class="n">when_indexed_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">by_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">when</span><span class="p">:</span>
                <span class="n">when_dict</span> <span class="o">=</span> <span class="n">all_by_name</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">when_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_by_name</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># this needs to preserve the insertion order of whens</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_by_name</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">_names</span><span class="p">(</span><span class="n">when_indexed_dictionary</span><span class="p">:</span> <span class="n">WhenDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get sorted names from dicts keyed by when/name.&quot;&quot;&quot;</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">by_name</span> <span class="ow">in</span> <span class="n">when_indexed_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">by_name</span><span class="p">:</span>
            <span class="n">all_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span>


<span class="n">WhenVariantList</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="s2">&quot;spack.variant.Variant&quot;</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">_remove_overridden_vdefs</span><span class="p">(</span><span class="n">variant_defs</span><span class="p">:</span> <span class="n">WhenVariantList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove variant defs from the list if their when specs are satisfied by later ones.</span>

<span class="sd">    Any such variant definitions are *always* overridden by their successor, as it will</span>
<span class="sd">    match everything the predecessor matches, and the solver will prefer it because of</span>
<span class="sd">    its higher precedence.</span>

<span class="sd">    We can just remove these defs from variant definitions and avoid putting them in the</span>
<span class="sd">    solver. This is also useful for, e.g., `spack info`, where we don&#39;t want to show a</span>
<span class="sd">    variant from a superclass if it is always overridden by a variant defined in a</span>
<span class="sd">    subclass.</span>

<span class="sd">    Example::</span>

<span class="sd">        class ROCmPackage:</span>
<span class="sd">            variant(&quot;amdgpu_target&quot;, ..., when=&quot;+rocm&quot;)</span>

<span class="sd">        class Hipblas:</span>
<span class="sd">            variant(&quot;amdgpu_target&quot;, ...)</span>

<span class="sd">    The subclass definition *always* overrides the superclass definition here, but they</span>
<span class="sd">    have different when specs and the subclass def won&#39;t just replace the one in the</span>
<span class="sd">    superclass. In this situation, the subclass should *probably* also have</span>
<span class="sd">    ``when=&quot;+rocm&quot;``, but we can&#39;t guarantee that will always happen when a vdef is</span>
<span class="sd">    overridden. So we use this method to remove any overrides we can know statically.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">variant_defs</span><span class="p">):</span>
        <span class="n">when</span><span class="p">,</span> <span class="n">vdef</span> <span class="o">=</span> <span class="n">variant_defs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">when</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">successor</span><span class="p">)</span> <span class="k">for</span> <span class="n">successor</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">variant_defs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]):</span>
            <span class="k">del</span> <span class="n">variant_defs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<div class="viewcode-block" id="RedistributionMixin">
<a class="viewcode-back" href="../../spack.html#spack.package_base.RedistributionMixin">[docs]</a>
<span class="k">class</span> <span class="nc">RedistributionMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logic for determining whether a Package is source/binary</span>
<span class="sd">    redistributable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Store whether a given Spec source/binary should not be</span>
    <span class="c1">#: redistributed.</span>
    <span class="n">disable_redistribute</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="s2">&quot;spack.directives.DisableRedistribute&quot;</span><span class="p">]</span>

    <span class="c1"># Source redistribution must be determined before concretization</span>
    <span class="c1"># (because source mirrors work with un-concretized Specs).</span>
<div class="viewcode-block" id="RedistributionMixin.redistribute_source">
<a class="viewcode-back" href="../../spack.html#spack.package_base.RedistributionMixin.redistribute_source">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">redistribute_source</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether it should be possible to add the source of this</span>
<span class="sd">        package to a Spack mirror.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">disable_redistribute</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">disable_redistribute</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">disable_redistribute</span><span class="o">.</span><span class="n">source</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">when_spec</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">redistribute_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether it should be possible to create a binary out of an</span>
<span class="sd">        installed instance of this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">disable_redistribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">disable_redistribute</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">disable_redistribute</span><span class="o">.</span><span class="n">binary</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">when_spec</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="PackageBase">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase">[docs]</a>
<span class="k">class</span> <span class="nc">PackageBase</span><span class="p">(</span><span class="n">WindowsRPath</span><span class="p">,</span> <span class="n">PackageViewMixin</span><span class="p">,</span> <span class="n">RedistributionMixin</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">PackageMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the superclass for all spack packages.</span>

<span class="sd">    ***The Package class***</span>

<span class="sd">    At its core, a package consists of a set of software to be installed.</span>
<span class="sd">    A package may focus on a piece of software and its associated software</span>
<span class="sd">    dependencies or it may simply be a set, or bundle, of software.  The</span>
<span class="sd">    former requires defining how to fetch, verify (via, e.g., sha256), build,</span>
<span class="sd">    and install that software and the packages it depends on, so that</span>
<span class="sd">    dependencies can be installed along with the package itself.   The latter,</span>
<span class="sd">    sometimes referred to as a ``no-source`` package, requires only defining</span>
<span class="sd">    the packages to be built.</span>

<span class="sd">    Packages are written in pure Python.</span>

<span class="sd">    There are two main parts of a Spack package:</span>

<span class="sd">      1. **The package class**.  Classes contain ``directives``, which are special functions, that</span>
<span class="sd">         add metadata (versions, patches, dependencies, and other information) to packages (see</span>
<span class="sd">         ``directives.py``). Directives provide the constraints that are used as input to the</span>
<span class="sd">         concretizer.</span>

<span class="sd">      2. **Package instances**. Once instantiated, a package can be passed to the PackageInstaller.</span>
<span class="sd">         It calls methods like ``do_stage()`` on the ``Package`` object, and it uses those to drive</span>
<span class="sd">         user-implemented methods like ``patch()``, ``install()``, and other build steps. To</span>
<span class="sd">         install software, an instantiated package needs a *concrete* spec, which guides the</span>
<span class="sd">         behavior of the various install methods.</span>

<span class="sd">    Packages are imported from repos (see ``repo.py``).</span>

<span class="sd">    **Package DSL**</span>

<span class="sd">    Look in ``lib/spack/docs`` or check https://spack.readthedocs.io for</span>
<span class="sd">    the full documentation of the package domain-specific language.  That</span>
<span class="sd">    used to be partially documented here, but as it grew, the docs here</span>
<span class="sd">    became increasingly out of date.</span>

<span class="sd">    **Package Lifecycle**</span>

<span class="sd">    A package&#39;s lifecycle over a run of Spack looks something like this:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       p = Package()             # Done for you by spack</span>

<span class="sd">       p.do_fetch()              # downloads tarball from a URL (or VCS)</span>
<span class="sd">       p.do_stage()              # expands tarball in a temp directory</span>
<span class="sd">       p.do_patch()              # applies patches to expanded source</span>
<span class="sd">       p.do_uninstall()          # removes install directory</span>

<span class="sd">    although packages that do not have code have nothing to fetch so omit</span>
<span class="sd">    ``p.do_fetch()``.</span>

<span class="sd">    There are also some other commands that clean the build area:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       p.do_clean()              # removes the stage directory entirely</span>
<span class="sd">       p.do_restage()            # removes the build directory and</span>
<span class="sd">                                 # re-expands the archive.</span>

<span class="sd">    The convention used here is that a ``do_*`` function is intended to be</span>
<span class="sd">    called internally by Spack commands (in ``spack.cmd``).  These aren&#39;t for</span>
<span class="sd">    package writers to override, and doing so may break the functionality</span>
<span class="sd">    of the Package class.</span>

<span class="sd">    Package creators have a lot of freedom, and they could technically</span>
<span class="sd">    override anything in this class.  That is not usually required.</span>

<span class="sd">    For most use cases.  Package creators typically just add attributes</span>
<span class="sd">    like ``homepage`` and, for a code-based package, ``url``, or functions</span>
<span class="sd">    such as ``install()``.</span>
<span class="sd">    There are many custom ``Package`` subclasses in the</span>
<span class="sd">    ``spack.build_systems`` package that make things even easier for</span>
<span class="sd">    specific build systems.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># These are default values for instance variables.</span>
    <span class="c1">#</span>

    <span class="c1"># Declare versions dictionary as placeholder for values.</span>
    <span class="c1"># This allows analysis tools to correctly interpret the class attributes.</span>
    <span class="n">versions</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;spack.dependency.Dependency&quot;</span><span class="p">]]</span>
    <span class="n">conflicts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span>
    <span class="n">requirements</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
        <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
    <span class="p">]</span>
    <span class="n">provided</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]]</span>
    <span class="n">provided_together</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
    <span class="n">patches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.patch.Patch&quot;</span><span class="p">]]</span>
    <span class="n">variants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;spack.variant.Variant&quot;</span><span class="p">]]</span>
    <span class="n">languages</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="n">splice_specs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span>

    <span class="c1">#: By default, packages are not virtual</span>
    <span class="c1">#: Virtual packages override this attribute</span>
    <span class="n">virtual</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Most Spack packages are used to install source or binary code while</span>
    <span class="c1">#: those that do not can be used to install a set of other Spack packages.</span>
    <span class="n">has_code</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#: By default we build in parallel.  Subclasses can override this.</span>
    <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#: By default do not run tests within package&#39;s install()</span>
    <span class="n">run_tests</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Most packages are NOT extendable. Set to True if you want extensions.</span>
    <span class="n">extendable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: When True, add RPATHs for the entire DAG. When False, add RPATHs only</span>
    <span class="c1">#: for immediate dependencies.</span>
    <span class="n">transitive_rpaths</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#: List of shared objects that should be replaced with a different library at</span>
    <span class="c1">#: runtime. Typically includes stub libraries like libcuda.so. When linking</span>
    <span class="c1">#: against a library listed here, the dependent will only record its soname</span>
    <span class="c1">#: or filename, not its absolute path, so that the dynamic linker will search</span>
    <span class="c1">#: for it. Note: accepts both file names and directory names, for example</span>
    <span class="c1">#: ``[&quot;libcuda.so&quot;, &quot;stubs&quot;]`` will ensure libcuda.so and all libraries in the</span>
    <span class="c1">#: stubs directory are not bound by path.&quot;&quot;&quot;</span>
    <span class="n">non_bindable_shared_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: List of prefix-relative file paths (or a single path). If these do</span>
    <span class="c1">#: not exist after install, or if they exist but are not files,</span>
    <span class="c1">#: sanity checks fail.</span>
    <span class="n">sanity_check_is_file</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: List of prefix-relative directory paths (or a single path). If</span>
    <span class="c1">#: these do not exist after install, or if they exist but are not</span>
    <span class="c1">#: directories, sanity checks will fail.</span>
    <span class="n">sanity_check_is_dir</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: Boolean. Set to ``True`` for packages that require a manual download.</span>
    <span class="c1">#: This is currently used by package sanity tests and generation of a</span>
    <span class="c1">#: more meaningful fetch failure error.</span>
    <span class="n">manual_download</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Set of additional options used when fetching package versions.</span>
    <span class="n">fetch_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">#</span>
    <span class="c1"># Set default licensing information</span>
    <span class="c1">#</span>
    <span class="c1">#: Boolean. If set to ``True``, this software requires a license.</span>
    <span class="c1">#: If set to ``False``, all of the ``license_*`` attributes will</span>
    <span class="c1">#: be ignored. Defaults to ``False``.</span>
    <span class="n">license_required</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: String. Contains the symbol used by the license manager to denote</span>
    <span class="c1">#: a comment. Defaults to ``#``.</span>
    <span class="n">license_comment</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>

    <span class="c1">#: List of strings. These are files that the software searches for when</span>
    <span class="c1">#: looking for a license. All file paths must be relative to the</span>
    <span class="c1">#: installation directory. More complex packages like Intel may require</span>
    <span class="c1">#: multiple licenses for individual components. Defaults to the empty list.</span>
    <span class="n">license_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: List of strings. Environment variables that can be set to tell the</span>
    <span class="c1">#: software where to look for a license if it is not in the usual location.</span>
    <span class="c1">#: Defaults to the empty list.</span>
    <span class="n">license_vars</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: String. A URL pointing to license setup instructions for the software.</span>
    <span class="c1">#: Defaults to the empty string.</span>
    <span class="n">license_url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1">#: Verbosity level, preserved across installs.</span>
    <span class="n">_verbose</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: index of patches by sha256 sum, built lazily</span>
    <span class="n">_patches_by_hash</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Package homepage where users can find more information about the package</span>
    <span class="n">homepage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Default list URL (place to find available versions)</span>
    <span class="n">list_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Link depth to which list_url should be searched for new versions</span>
    <span class="n">list_depth</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#: List of strings which contains GitHub usernames of package maintainers.</span>
    <span class="c1">#: Do not include @ here in order not to unnecessarily ping the users.</span>
    <span class="n">maintainers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: List of attributes to be excluded from a package&#39;s hash.</span>
    <span class="n">metadata_attrs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;homepage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">,</span>
        <span class="s2">&quot;urls&quot;</span><span class="p">,</span>
        <span class="s2">&quot;list_url&quot;</span><span class="p">,</span>
        <span class="s2">&quot;extendable&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;make_jobs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maintainers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1">#: Set to ``True`` to indicate the stand-alone test requires a compiler.</span>
    <span class="c1">#: It is used to ensure a compiler and build dependencies like &#39;cmake&#39;</span>
    <span class="c1">#: are available to build a custom test code.</span>
    <span class="n">test_requires_compiler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: TestSuite instance used to manage stand-alone tests for 1+ specs.</span>
    <span class="n">test_suite</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;TestSuite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="c1"># this determines how the package should be built.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span> <span class="o">=</span> <span class="n">spec</span>

        <span class="c1"># Allow custom staging paths for packages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Keep track of whether or not this package was installed from</span>
        <span class="c1"># a binary cache.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_from_binary_cache</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Ensure that only one of these two attributes are present</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;urls&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;a package can have either a &#39;url&#39; or a &#39;urls&#39; attribute&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; [package &#39;</span><span class="si">{0.name}</span><span class="s2">&#39; defines both]&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># init internal variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StageComposite</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tester</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;PackageTest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Set up timing variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_time</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">win_rpath</span> <span class="o">=</span> <span class="n">fsys</span><span class="o">.</span><span class="n">WindowsSimulatedRPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="PackageBase.dependency_names">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.dependency_names">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dependency_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_names</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.dependencies_by_name">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.dependencies_by_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dependencies_by_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_by_name</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span></div>


    <span class="c1"># Accessors for variants</span>
    <span class="c1"># External code workingw with Variants should go through the methods below</span>

<div class="viewcode-block" id="PackageBase.variant_names">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.variant_names">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">variant_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">_names</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.has_variant">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.has_variant">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">has_variant</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">dictionary</span> <span class="k">for</span> <span class="n">dictionary</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="PackageBase.num_variant_definitions">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.num_variant_definitions">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">num_variant_definitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total number of variant definitions in this class so far.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variants_by_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">variants_by_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="PackageBase.variant_definitions">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.variant_definitions">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">variant_definitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WhenVariantList</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterator over (when_spec, Variant) for all variant definitions for a particular name.&quot;&quot;&quot;</span>
        <span class="c1"># construct a list of defs sorted by precedence</span>
        <span class="n">defs</span><span class="p">:</span> <span class="n">WhenVariantList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">variants_by_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">variant_def</span> <span class="o">=</span> <span class="n">variants_by_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">variant_def</span><span class="p">:</span>
                <span class="n">defs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">when</span><span class="p">,</span> <span class="n">variant_def</span><span class="p">))</span>

        <span class="c1"># With multiple definitions, ensure precedence order and simplify overrides</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">defs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">defs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">precedence</span><span class="p">)</span>
            <span class="n">_remove_overridden_vdefs</span><span class="p">(</span><span class="n">defs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">defs</span></div>


<div class="viewcode-block" id="PackageBase.variant_items">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.variant_items">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">variant_items</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;spack.variant.Variant&quot;</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over ``cls.variants.items()`` with overridden definitions removed.&quot;&quot;&quot;</span>
        <span class="c1"># Note: This is quadratic in the average number of variant definitions per name.</span>
        <span class="c1"># That is likely close to linear in practice, as there are few variants with</span>
        <span class="c1"># multiple definitions (but it matters when they are there).</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">vdef</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">vdef</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">variant_definitions</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">variant_names</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">variants_by_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">filtered_variants_by_name</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">vdef</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">vdef</span> <span class="ow">in</span> <span class="n">variants_by_name</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">vdef</span><span class="p">)</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">filtered_variants_by_name</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">when</span><span class="p">,</span> <span class="n">filtered_variants_by_name</span></div>


<div class="viewcode-block" id="PackageBase.get_variant">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.get_variant">[docs]</a>
    <span class="k">def</span> <span class="nf">get_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;spack.variant.Variant&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the highest precedence variant definition matching this package&#39;s spec.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: name of the variant definition to get</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">highest_to_lowest</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variant_definitions</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">vdef</span> <span class="k">for</span> <span class="n">when</span><span class="p">,</span> <span class="n">vdef</span> <span class="ow">in</span> <span class="n">highest_to_lowest</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">when</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No variant &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; on spec: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.possible_dependencies">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.possible_dependencies">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">possible_dependencies</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">expand_virtuals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">depflag</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">DepFlag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
        <span class="n">visited</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">missing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">virtuals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return dict of possible dependencies of this package.</span>

<span class="sd">        Args:</span>
<span class="sd">            transitive (bool or None): return all transitive dependencies if</span>
<span class="sd">                True, only direct dependencies if False (default True)..</span>
<span class="sd">            expand_virtuals (bool or None): expand virtual dependencies into</span>
<span class="sd">                all possible implementations (default True)</span>
<span class="sd">            depflag: dependency types to consider</span>
<span class="sd">            visited (dict or None): dict of names of dependencies visited so</span>
<span class="sd">                far, mapped to their immediate dependencies&#39; names.</span>
<span class="sd">            missing (dict or None): dict to populate with packages and their</span>
<span class="sd">                *missing* dependencies.</span>
<span class="sd">            virtuals (set): if provided, populate with virtuals seen so far.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (dict): dictionary mapping dependency names to *their*</span>
<span class="sd">                immediate dependencies</span>

<span class="sd">        Each item in the returned dictionary maps a (potentially</span>
<span class="sd">        transitive) dependency of this package to its possible</span>
<span class="sd">        *immediate* dependencies. If ``expand_virtuals`` is ``False``,</span>
<span class="sd">        virtual package names wil be inserted as keys mapped to empty</span>
<span class="sd">        sets of dependencies.  Virtuals, if not expanded, are treated as</span>
<span class="sd">        though they have no immediate dependencies.</span>

<span class="sd">        Missing dependencies by default are ignored, but if a</span>
<span class="sd">        missing dict is provided, it will be populated with package names</span>
<span class="sd">        mapped to any dependencies they have that are in no</span>
<span class="sd">        repositories. This is only populated if transitive is True.</span>

<span class="sd">        Note: the returned dict *includes* the package itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">visited</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">visited</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">missing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">missing</span>

        <span class="n">visited</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">conditions</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dependencies_by_name</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># check whether this dependency could be of the type asked for</span>
            <span class="n">depflag_union</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">deplist</span> <span class="ow">in</span> <span class="n">conditions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deplist</span><span class="p">:</span>
                    <span class="n">depflag_union</span> <span class="o">|=</span> <span class="n">dep</span><span class="o">.</span><span class="n">depflag</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">depflag</span> <span class="o">&amp;</span> <span class="n">depflag_union</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># expand virtuals if enabled, otherwise just stop at virtuals</span>
            <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">virtuals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">virtuals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expand_virtuals</span><span class="p">:</span>
                    <span class="n">providers</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">providers_for</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">dep_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dep_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># add the dependency names to the visited dict</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dep_names</span><span class="p">))</span>

            <span class="c1"># recursively traverse dependencies</span>
            <span class="k">for</span> <span class="n">dep_name</span> <span class="ow">in</span> <span class="n">dep_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dep_name</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">visited</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dep_name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

                <span class="c1"># skip the rest if not transitive</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">transitive</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dep_cls</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">get_pkg_class</span><span class="p">(</span><span class="n">dep_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">UnknownPackageError</span><span class="p">:</span>
                    <span class="c1"># log unknown packages</span>
                    <span class="n">missing</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_name</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">dep_cls</span><span class="o">.</span><span class="n">possible_dependencies</span><span class="p">(</span>
                    <span class="n">transitive</span><span class="p">,</span> <span class="n">expand_virtuals</span><span class="p">,</span> <span class="n">depflag</span><span class="p">,</span> <span class="n">visited</span><span class="p">,</span> <span class="n">missing</span><span class="p">,</span> <span class="n">virtuals</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">visited</span></div>


    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">package_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Directory where the package.py file lives.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Module object (not just the name) that this package is defined in.</span>

<span class="sd">        We use this to add variables to package modules.  This makes</span>
<span class="sd">        install() methods easier to write (e.g., can call configure())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spack namespace for the package, which identifies its repo.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">namespace_from_fullname</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of this package, including the namespace&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">fullnames</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fullnames for this package and any packages from which it inherits.&quot;&quot;&quot;</span>
        <span class="n">fullnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;namespace&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
                <span class="n">fullnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">namespace</span> <span class="o">==</span> <span class="s2">&quot;builtin&quot;</span><span class="p">:</span>
                <span class="c1"># builtin packages cannot inherit from other repos</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">fullnames</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The name of this package.</span>

<span class="sd">        The name of a package is the name of its Python module, without</span>
<span class="sd">        the containing module names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">global_license_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the directory where license files for all packages are stored.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">canonicalize_path</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:license_dir&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_license_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the path where a global license file for this</span>
<span class="sd">        particular package should be stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_files</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_license_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">license_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="c1"># NOTE: return type should be Optional[Literal[&#39;all&#39;, &#39;specific&#39;, &#39;none&#39;]] in</span>
    <span class="c1"># Python 3.8+, but we still support 3.6.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keep_werror</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep ``-Werror`` flags, matches ``config:flags:keep_werror`` to override config.</span>

<span class="sd">        Valid return values are:</span>
<span class="sd">        * ``&quot;all&quot;``: keep all ``-Werror`` flags.</span>
<span class="sd">        * ``&quot;specific&quot;``: keep only ``-Werror=specific-warning`` flags.</span>
<span class="sd">        * ``&quot;none&quot;``: filter out all ``-Werror*`` flags.</span>
<span class="sd">        * ``None``: respect the user&#39;s configuration (``&quot;none&quot;`` by default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;%nvhpc@:23.3&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;%pgi&quot;</span><span class="p">):</span>
            <span class="c1"># Filtering works by replacing -Werror with -Wno-error, but older nvhpc and</span>
            <span class="c1"># PGI do not understand -Wno-error, so we disable filtering.</span>
            <span class="k">return</span> <span class="s2">&quot;all&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;%nvhpc@23.4:&quot;</span><span class="p">):</span>
            <span class="c1"># newer nvhpc supports -Wno-error but can&#39;t disable specific warnings with</span>
            <span class="c1"># -Wno-error=warning. Skip -Werror=warning, but still filter -Werror.</span>
            <span class="k">return</span> <span class="s2">&quot;specific&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use -Werror disablement by default for other compilers</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Version requested for a package that&quot;</span> <span class="s2">&quot; does not have a concrete version.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="PackageBase.version_urls">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.version_urls">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@memoized</span>
    <span class="k">def</span> <span class="nf">version_urls</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">StandardVersion</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dict of explicitly defined URLs for versions of this package.</span>

<span class="sd">        Return:</span>
<span class="sd">           An dict mapping version to url, ordered by version.</span>

<span class="sd">        A version&#39;s URL only appears in the result if it has an an explicitly defined ``url``</span>
<span class="sd">        argument. So, this list may be empty if a package only defines ``url`` at the top level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">}</span></div>


<div class="viewcode-block" id="PackageBase.nearest_url">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.nearest_url">[docs]</a>
    <span class="k">def</span> <span class="nf">nearest_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds the URL with the &quot;closest&quot; version to ``version``.</span>

<span class="sd">        This uses the following precedence order:</span>

<span class="sd">          1. Find the next lowest or equal version with a URL.</span>
<span class="sd">          2. If no lower URL, return the next *higher* URL.</span>
<span class="sd">          3. If no higher URL, return None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_urls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_urls</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">version_urls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">version_urls</span><span class="p">[</span><span class="n">version</span><span class="p">]</span>

        <span class="n">last_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_urls</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">version</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_url</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">last_url</span>
            <span class="n">last_url</span> <span class="o">=</span> <span class="n">u</span>

        <span class="k">return</span> <span class="n">last_url</span></div>


<div class="viewcode-block" id="PackageBase.url_for_version">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.url_for_version">[docs]</a>
    <span class="k">def</span> <span class="nf">url_for_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a URL from which the specified version of this package</span>
<span class="sd">        may be downloaded.</span>

<span class="sd">        version: class Version</span>
<span class="sd">            The version for which a URL is sought.</span>

<span class="sd">        See Class Version (version.py)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implement_all_urls_for_version</span><span class="p">(</span><span class="n">version</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="PackageBase.update_external_dependencies">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.update_external_dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">update_external_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extendee_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to override in package classes to handle external dependencies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="PackageBase.detect_dev_src_change">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.detect_dev_src_change">[docs]</a>
    <span class="k">def</span> <span class="nf">detect_dev_src_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for checking for source code changes to trigger rebuild/reinstall</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dev_path_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dev_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">fsys</span><span class="o">.</span><span class="n">last_modification_time_recursive</span><span class="p">(</span><span class="n">dev_path_var</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mtime</span> <span class="o">&gt;</span> <span class="n">record</span><span class="o">.</span><span class="n">installation_time</span></div>


<div class="viewcode-block" id="PackageBase.all_urls_for_version">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.all_urls_for_version">[docs]</a>
    <span class="k">def</span> <span class="nf">all_urls_for_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">StandardVersion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all URLs derived from version_urls(), url, urls, and</span>
<span class="sd">        list_url (if it contains a version) in a package in that order.</span>

<span class="sd">        Args:</span>
<span class="sd">            version: the version for which a URL is sought</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">url_for_version</span> <span class="o">!=</span> <span class="n">PackageBase</span><span class="o">.</span><span class="n">url_for_version</span><span class="p">:</span>
            <span class="n">uf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_for_version</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implement_all_urls_for_version</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">uf</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_implement_all_urls_for_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StandardVersion</span><span class="p">],</span>
        <span class="n">custom_url_for_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">StandardVersion</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">StandardVersion</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">version</span>

        <span class="n">urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If we have a specific URL for this version, don&#39;t extrapolate.</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_urls</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># if there is a custom url_for_version, use it</span>
        <span class="k">if</span> <span class="n">custom_url_for_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">custom_url_for_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
                <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sub_and_add</span><span class="p">(</span><span class="n">u</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># skip the url if there is no version to replace</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">parse_version</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">UndetectableVersionError</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">substitute_version</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_version</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>

        <span class="c1"># If no specific URL, use the default, class-level URL</span>
        <span class="n">sub_and_add</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;urls&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">sub_and_add</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

        <span class="n">sub_and_add</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;list_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># if no version-bearing URLs can be found, try them raw</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">urls</span><span class="p">:</span>
            <span class="n">default_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;urls&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># if no exact match AND no class-level default, use the nearest URL</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">default_url</span><span class="p">:</span>
                <span class="n">default_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearest_url</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

                <span class="c1"># if there are NO URLs to go by, then we can&#39;t do anything</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">default_url</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NoURLError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">substitute_version</span><span class="p">(</span><span class="n">default_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_version</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">urls</span>

<div class="viewcode-block" id="PackageBase.find_valid_url_for_version">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.find_valid_url_for_version">[docs]</a>
    <span class="k">def</span> <span class="nf">find_valid_url_for_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a URL from which the specified version of this package</span>
<span class="sd">        may be downloaded after testing whether the url is valid. Will try</span>
<span class="sd">        url, urls, and list_url before failing.</span>

<span class="sd">        version: class Version</span>
<span class="sd">            The version for which a URL is sought.</span>

<span class="sd">        See Class Version (version.py)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_urls_for_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">url_exists</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">u</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">_make_resource_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_stage</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="n">pretty_resource_name</span> <span class="o">=</span> <span class="n">fsys</span><span class="o">.</span><span class="n">polite_filename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ResourceStage</span><span class="p">(</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">fetcher</span><span class="p">,</span>
            <span class="n">root</span><span class="o">=</span><span class="n">root_stage</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_stage</span><span class="p">(</span><span class="n">resource</span><span class="p">),</span>
            <span class="n">mirror_paths</span><span class="o">=</span><span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">default_mirror_layout</span><span class="p">(</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">fetcher</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pretty_resource_name</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">mirrors</span><span class="o">=</span><span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_download_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dynamic_fetcher</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">from_list_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dynamic_fetcher</span><span class="p">]</span> <span class="k">if</span> <span class="n">dynamic_fetcher</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_make_root_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fetcher</span><span class="p">):</span>
        <span class="c1"># Construct a mirror path (TODO: get this out of package.py)</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">-</span><span class="si">{version}</span><span class="s2">&quot;</span>
        <span class="n">pretty_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">format_path</span><span class="p">(</span><span class="n">format_string</span><span class="p">)</span>
        <span class="n">mirror_paths</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">default_mirror_layout</span><span class="p">(</span>
            <span class="n">fetcher</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pretty_name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
        <span class="p">)</span>
        <span class="c1"># Construct a path where the stage should build..</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">stage_name</span> <span class="o">=</span> <span class="n">compute_stage_name</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span>
            <span class="n">fetcher</span><span class="p">,</span>
            <span class="n">mirror_paths</span><span class="o">=</span><span class="n">mirror_paths</span><span class="p">,</span>
            <span class="n">mirrors</span><span class="o">=</span><span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">stage_name</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">search_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_download_search</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">stage</span>

    <span class="k">def</span> <span class="nf">_make_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If it&#39;s a dev package (not transitively), use a DIY stage object</span>
        <span class="n">dev_path_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dev_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dev_path_var</span><span class="p">:</span>
            <span class="n">dev_path</span> <span class="o">=</span> <span class="n">dev_path_var</span><span class="o">.</span><span class="n">value</span>
            <span class="n">link_format</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:develop_stage_link&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">link_format</span><span class="p">:</span>
                <span class="n">link_format</span> <span class="o">=</span> <span class="s2">&quot;build-</span><span class="si">{arch}</span><span class="s2">-</span><span class="si">{hash:7}</span><span class="s2">&quot;</span>
            <span class="n">stage_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">format_path</span><span class="p">(</span><span class="n">link_format</span><span class="p">)</span>
            <span class="n">source_stage</span> <span class="o">=</span> <span class="n">DevelopStage</span><span class="p">(</span><span class="n">compute_stage_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="n">dev_path</span><span class="p">,</span> <span class="n">stage_link</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_root_stage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetcher</span><span class="p">)</span>

        <span class="c1"># all_stages is source + resources + patches</span>
        <span class="n">all_stages</span> <span class="o">=</span> <span class="n">StageComposite</span><span class="p">()</span>
        <span class="n">all_stages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_stage</span><span class="p">)</span>
        <span class="n">all_stages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_resource_stage</span><span class="p">(</span><span class="n">source_stage</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_needed_resources</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="n">all_stages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">p</span><span class="o">.</span><span class="n">stage</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">patches</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">UrlPatch</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The only code path that gets here is spack mirror create --all which just needs all</span>
            <span class="c1"># matching patches.</span>
            <span class="n">all_stages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">p</span><span class="o">.</span><span class="n">stage</span>
                <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">patch_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">when_spec</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patch_list</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">UrlPatch</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">all_stages</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the build staging area for this package.</span>

<span class="sd">        This automatically instantiates a ``Stage`` object if the package</span>
<span class="sd">        doesn&#39;t have one yet, but it does not create the Stage directory</span>
<span class="sd">        on the filesystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot retrieve stage for package without concrete version.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_stage</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span>

    <span class="nd">@stage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">StageComposite</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allow a stage object to be set to override the default.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="n">stage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the build environment file path associated with staging.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">_spack_build_envfile</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_mods_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the build environment modifications file path associated with</span>
<span class="sd">        staging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">_spack_build_envmodsfile</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the install metadata directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">install_env_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the build environment file path on successful installation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Backward compatibility: Return the name of an existing log path;</span>
        <span class="c1"># otherwise, return the current install env path name.</span>
        <span class="n">old_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">,</span> <span class="s2">&quot;build.env&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">old_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">,</span> <span class="n">_spack_build_envfile</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the build log file path associated with staging.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">_spack_build_logfile</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phase_log_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find sorted phase log files written to the staging directory&quot;&quot;&quot;</span>
        <span class="n">logs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;spack-build-*-out.txt&quot;</span><span class="p">)</span>
        <span class="n">log_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">logs_dir</span><span class="p">)</span>
        <span class="n">log_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">log_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">install_log_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the (compressed) build log file path on successful installation&quot;&quot;&quot;</span>
        <span class="c1"># Backward compatibility: Return the name of an existing install log.</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_spack_build_logfile</span><span class="p">,</span> <span class="s2">&quot;build.out&quot;</span><span class="p">,</span> <span class="s2">&quot;build.txt&quot;</span><span class="p">]:</span>
            <span class="n">old_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_log</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">old_log</span>

        <span class="c1"># Otherwise, return the current install log path name.</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">,</span> <span class="n">_spack_build_logfile</span> <span class="o">+</span> <span class="s2">&quot;.gz&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">configure_args_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configure args file path associated with staging.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">_spack_configure_argsfile</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">times_log_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the times log json file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">,</span> <span class="n">spack_times_log</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">install_configure_args_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configure args file path on successful installation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">,</span> <span class="n">_spack_configure_argsfile</span><span class="p">)</span>

<div class="viewcode-block" id="PackageBase.archive_install_test_log">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.archive_install_test_log">[docs]</a>
    <span class="k">def</span> <span class="nf">archive_install_test_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Archive the install-phase test log, if present.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tester</span><span class="o">.</span><span class="n">archive_install_test_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dir</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tester</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot retrieve tester for package without concrete version.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tester</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tester</span> <span class="o">=</span> <span class="n">PackageTest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tester</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">installed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;the &quot;PackageBase.installed&quot; property is deprecated and will be &#39;</span>
            <span class="s1">&#39;removed in Spack v0.19, use &quot;Spec.installed&quot; instead&#39;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">installed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">installed_upstream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;the &quot;PackageBase.installed_upstream&quot; property is deprecated and will &#39;</span>
            <span class="s1">&#39;be removed in Spack v0.19, use &quot;Spec.installed_upstream&quot; instead&#39;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">installed_upstream</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fetcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot retrieve fetcher for package without concrete version.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">for_package_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span>

    <span class="nd">@fetcher</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fetcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span><span class="o">.</span><span class="n">set_package</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="PackageBase.dependencies_of_type">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.dependencies_of_type">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dependencies_of_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">deptypes</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">DepFlag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get names of dependencies that can possibly have these deptypes.</span>

<span class="sd">        This analyzes the package and determines which dependencies *can*</span>
<span class="sd">        be a certain kind of dependency. Note that they may not *always*</span>
<span class="sd">        be this kind of dependency, since dependencies can be optional,</span>
<span class="sd">        so something may be a build dependency in one configuration and a</span>
<span class="sd">        run dependency in another.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dependencies</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dependencies_by_name</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">deptypes</span> <span class="o">&amp;</span> <span class="n">dep</span><span class="o">.</span><span class="n">depflag</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">)</span>
        <span class="p">}</span></div>


    <span class="c1"># TODO: allow more than one active extendee.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extendee_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spec of the extendee of this package, or None if it is not an extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extendees</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If the extendee is in the spec&#39;s deps already, return that.</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extendees</span><span class="p">:</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">deps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if the spec is concrete already, then it extends something</span>
        <span class="c1"># that is an *optional* dependency, and the dep isn&#39;t there.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">_concrete</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it&#39;s not concrete, then return the spec from the</span>
            <span class="c1"># extends() directive since that is all we know so far.</span>
            <span class="n">spec_str</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extendees</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">spec_str</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if it is concrete, it&#39;s only an extension if it actually</span>
        <span class="c1"># dependes on the extendee.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">_concrete</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extendee_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If not, then it&#39;s an extension if it *could* be an extension</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extendees</span><span class="p">)</span>

<div class="viewcode-block" id="PackageBase.extends">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.extends">[docs]</a>
    <span class="k">def</span> <span class="nf">extends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if this package extends the given spec.</span>

<span class="sd">        If ``self.spec`` is concrete, this returns whether this package extends</span>
<span class="sd">        the given spec.</span>

<span class="sd">        If ``self.spec`` is not concrete, this returns whether this package may</span>
<span class="sd">        extend the given spec.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extendees</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extendee_spec</span>
        <span class="k">return</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.provides">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.provides">[docs]</a>
    <span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vpkg_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if this package provides a virtual package with the specified name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">vpkg_name</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">provided</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">provided</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">when_spec</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">virtuals_provided</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        virtual packages provided by this package with its spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">vspec</span>
            <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">provided</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vspec</span> <span class="ow">in</span> <span class="n">provided</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">when_spec</span><span class="p">)</span>
        <span class="p">]</span>

<div class="viewcode-block" id="PackageBase.provided_virtual_names">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.provided_virtual_names">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">provided_virtual_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return sorted list of names of virtuals that can be provided by this package.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vpkg</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">virtuals</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">provided</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">vpkg</span> <span class="ow">in</span> <span class="n">virtuals</span><span class="p">))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the prefix into which this package should be installed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span>

    <span class="nd">@property</span>  <span class="c1"># type: ignore[misc]</span>
    <span class="nd">@memoized</span>
    <span class="k">def</span> <span class="nf">compiler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the spack.compiler.Compiler object used to build this package&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only get a compiler for a concrete package.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">compiler_for_spec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="p">)</span>

<div class="viewcode-block" id="PackageBase.url_version">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.url_version">[docs]</a>
    <span class="k">def</span> <span class="nf">url_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a version, this returns a string that should be substituted</span>
<span class="sd">        into the package&#39;s URL to download that version.</span>

<span class="sd">        By default, this just returns the version string. Subclasses may need</span>
<span class="sd">        to override this, e.g. for boost versions where you need to ensure that</span>
<span class="sd">        there are _&#39;s in the download URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.remove_prefix">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.remove_prefix">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the prefix for a package along with any empty parent</span>
<span class="sd">        directories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">remove_install_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">download_instr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines the default manual download instructions.  Packages can</span>
<span class="sd">        override the property to provide more information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str):  default manual download instructions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Manual download is required for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_download</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">required</span><span class="si">}</span><span class="s2">Refer to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">homepage</span><span class="si">}</span><span class="s2"> for download instructions.&quot;</span>

<div class="viewcode-block" id="PackageBase.do_fetch">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.do_fetch">[docs]</a>
    <span class="k">def</span> <span class="nf">do_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirror_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a stage directory and downloads the tarball for this package.</span>
<span class="sd">        Working directory will be set to the stage directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_code</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No fetch required for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">checksum</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:checksum&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">checksum</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">))</span>
            <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;dev_path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;There is no checksum on file to fetch </span><span class="si">%s</span><span class="s2"> safely.&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">cformat</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@version}&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Ask the user whether to skip the checksum if we&#39;re</span>
            <span class="c1"># interactive, but just fail if non-interactive.</span>
            <span class="n">ck_msg</span> <span class="o">=</span> <span class="s2">&quot;Add a checksum or use --no-checksum to skip this check.&quot;</span>
            <span class="n">ignore_checksum</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                <span class="n">ignore_checksum</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">get_yes_or_no</span><span class="p">(</span><span class="s2">&quot;  Fetch anyway?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ignore_checksum</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fetching with no checksum. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ck_msg</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_checksum</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">FetchError</span><span class="p">(</span>
                    <span class="s2">&quot;Will not fetch </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@version}&quot;</span><span class="p">),</span> <span class="n">ck_msg</span>
                <span class="p">)</span>

        <span class="n">deprecated</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:deprecated&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is deprecated and may be removed in a future Spack &quot;</span>
                <span class="s2">&quot;release.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@version}&quot;</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># Ask the user whether to install deprecated version if we&#39;re</span>
            <span class="c1"># interactive, but just fail if non-interactive.</span>
            <span class="n">dp_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;If you are willing to be a maintainer for this version &quot;</span>
                <span class="s2">&quot;of the package, submit a PR to remove `deprecated=False&quot;</span>
                <span class="s2">&quot;`, or use `--deprecated` to skip this check.&quot;</span>
            <span class="p">)</span>
            <span class="n">ignore_deprecation</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                <span class="n">ignore_deprecation</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">get_yes_or_no</span><span class="p">(</span><span class="s2">&quot;  Fetch anyway?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ignore_deprecation</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fetching deprecated version. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dp_msg</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_deprecation</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">FetchError</span><span class="p">(</span>
                    <span class="s2">&quot;Will not fetch </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@version}&quot;</span><span class="p">)),</span> <span class="n">dp_msg</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_download</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_instr</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">mirror_only</span><span class="p">,</span> <span class="n">err_msg</span><span class="o">=</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="k">if</span> <span class="n">checksum</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">cache_local</span><span class="p">()</span></div>


<div class="viewcode-block" id="PackageBase.do_stage">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.do_stage">[docs]</a>
    <span class="k">def</span> <span class="nf">do_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirror_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unpacks and expands the fetched tarball.&quot;&quot;&quot;</span>
        <span class="c1"># Always create the stage directory at this point.  Why?  A no-code</span>
        <span class="c1"># package may want to use the installation process to install metadata.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="c1"># Fetch/expand any associated code.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_fetch</span><span class="p">(</span><span class="n">mirror_only</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">expand_archive</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Support for post-install hooks requires a stage.source_path</span>
            <span class="n">fsys</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.do_patch">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.do_patch">[docs]</a>
    <span class="k">def</span> <span class="nf">do_patch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies patches if they haven&#39;t been applied already.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only patch concrete packages.&quot;</span><span class="p">)</span>

        <span class="c1"># Kick off the stage first.  This creates the stage.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_stage</span><span class="p">()</span>

        <span class="c1"># Package can add its own patch function.</span>
        <span class="n">has_patch_fun</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">)</span>

        <span class="c1"># Get the patches from the spec (this is a shortcut for the MV-variant)</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">patches</span>

        <span class="c1"># If there are no patches, note it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_patch_fun</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No patches needed for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Construct paths to special files in the archive dir used to</span>
        <span class="c1"># keep track of whether patches were successfully applied.</span>
        <span class="n">archive_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span>
        <span class="n">good_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="s2">&quot;.spack_patched&quot;</span><span class="p">)</span>
        <span class="n">no_patches_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="s2">&quot;.spack_no_patches&quot;</span><span class="p">)</span>
        <span class="n">bad_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="s2">&quot;.spack_patch_failed&quot;</span><span class="p">)</span>

        <span class="c1"># If we encounter an archive that failed to patch, restage it</span>
        <span class="c1"># so that we can apply all the patches again.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">bad_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">requires_patch_success</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patching failed last time. Restaging.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">restage</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># develop specs may have patch failures but should never be restaged</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;A patch failure was detected in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="s2">&quot; Build errors may occur due to this.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># If this file exists, then we already applied all the patches.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">good_file</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Already patched </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">no_patches_file</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No patches needed for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Apply all the patches for specs that match this one</span>
        <span class="n">patched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fsys</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="p">):</span>
                    <span class="n">patch</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Applied patch </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">path_or_url</span><span class="p">))</span>
                <span class="n">patched</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Touch bad file if anything goes wrong.</span>
                <span class="n">fsys</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">bad_file</span><span class="p">)</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Patch </span><span class="si">{</span><span class="n">patch</span><span class="o">.</span><span class="n">path_or_url</span><span class="si">}</span><span class="s2"> failed.&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">requires_patch_success</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_patch_fun</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fsys</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">()</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Ran patch() for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">patched</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">multimethod</span><span class="o">.</span><span class="n">NoSuchMethodError</span><span class="p">:</span>
                <span class="c1"># We are running a multimethod without a default case.</span>
                <span class="c1"># If there&#39;s no default it means we don&#39;t need to patch.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">patched</span><span class="p">:</span>
                    <span class="c1"># if we didn&#39;t apply a patch from a patch()</span>
                    <span class="c1"># directive, AND the patch function didn&#39;t apply, say</span>
                    <span class="c1"># no patches are needed.  Otherwise, we already</span>
                    <span class="c1"># printed a message for each patch.</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No patches needed for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Touch bad file if anything goes wrong.</span>
                <span class="n">fsys</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">bad_file</span><span class="p">)</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;patch() function failed for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">requires_patch_success</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">:</span>
            <span class="c1"># Get rid of any old failed file -- patches have either succeeded</span>
            <span class="c1"># or are not needed.  This is mostly defensive -- it&#39;s needed</span>
            <span class="c1"># if we didn&#39;t restage</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">bad_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bad_file</span><span class="p">)</span>

            <span class="c1"># touch good or no patches file so that we skip next time.</span>
            <span class="k">if</span> <span class="n">patched</span><span class="p">:</span>
                <span class="n">fsys</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">good_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fsys</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">no_patches_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.all_patches">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.all_patches">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all_patches</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve all patches associated with the package.</span>

<span class="sd">        Retrieves patches on the package itself as well as patches on the</span>
<span class="sd">        dependencies of the package.&quot;&quot;&quot;</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">patch_list</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patch_list</span><span class="p">:</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="n">pkg_deps</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">for</span> <span class="n">dep_name</span> <span class="ow">in</span> <span class="n">pkg_deps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">pkg_deps</span><span class="p">[</span><span class="n">dep_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">patch_list</span> <span class="ow">in</span> <span class="n">dependency</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patch_list</span><span class="p">:</span>
                        <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patches</span></div>


<div class="viewcode-block" id="PackageBase.content_hash">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.content_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">content_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a hash based on the artifacts and patches used to build this package.</span>

<span class="sd">        This includes:</span>
<span class="sd">            * source artifacts (tarballs, repositories) used to build;</span>
<span class="sd">            * content hashes (``sha256``&#39;s) of all patches applied by Spack; and</span>
<span class="sd">            * canonicalized contents the ``package.py`` recipe used to build.</span>

<span class="sd">        This hash is only included in Spack&#39;s DAG hash for concrete specs, but if it</span>
<span class="sd">        happens to be called on a package with an abstract spec, only applicable (i.e.,</span>
<span class="sd">        determinable) portions of the hash will be included.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># list of components to make up the hash</span>
        <span class="n">hash_content</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># source artifacts/repositories</span>
        <span class="c1"># TODO: resources</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source_id</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">for_package_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">source_id</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">ExtrapolationError</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">InvalidArgsError</span><span class="p">):</span>
                <span class="c1"># ExtrapolationError happens if the package has no fetchers defined.</span>
                <span class="c1"># InvalidArgsError happens when there are version directives with args,</span>
                <span class="c1">#     but none of them identifies an actual fetcher.</span>
                <span class="n">source_id</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">source_id</span><span class="p">:</span>
                <span class="c1"># TODO? in cases where a digest or source_id isn&#39;t available,</span>
                <span class="c1"># should this attempt to download the source and set one? This</span>
                <span class="c1"># probably only happens for source repositories which are</span>
                <span class="c1"># referenced by branch name rather than tag or commit ID.</span>
                <span class="n">from_local_sources</span> <span class="o">=</span> <span class="s2">&quot;dev_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_code</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">from_local_sources</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Missing a source id for </span><span class="si">{s.name}</span><span class="s2">@</span><span class="si">{s.version}</span><span class="s2">&quot;</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
                <span class="n">hash_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hash_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

        <span class="c1"># patch sha256&#39;s</span>
        <span class="c1"># Only include these if they&#39;ve been assigned by the concretizer.</span>
        <span class="c1"># We check spec._patches_assigned instead of spec.concrete because</span>
        <span class="c1"># we have to call package_hash *before* marking specs concrete</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">_patches_assigned</span><span class="p">():</span>
            <span class="n">hash_content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">)))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">patches</span>
            <span class="p">)</span>

        <span class="c1"># package.py contents</span>
        <span class="n">hash_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">package_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

        <span class="c1"># put it all together and encode as base32</span>
        <span class="n">b32_hash</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span>
            <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">bytes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">hash_content</span><span class="p">)))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">b32_hash</span> <span class="o">=</span> <span class="n">b32_hash</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">b32_hash</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cmake_prefix_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_has_make_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks to see if &#39;target&#39; is a valid target in a Makefile.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            target (str): the target to check for</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if &#39;target&#39; is found, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prevent altering LC_ALL for &#39;make&#39; outside this function</span>
        <span class="n">make</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">make</span><span class="p">)</span>

        <span class="c1"># Use English locale for missing target message comparison</span>
        <span class="n">make</span><span class="o">.</span><span class="n">add_default_env</span><span class="p">(</span><span class="s2">&quot;LC_ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span>

        <span class="c1"># Check if we have a Makefile</span>
        <span class="k">for</span> <span class="n">makefile</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GNUmakefile&quot;</span><span class="p">,</span> <span class="s2">&quot;Makefile&quot;</span><span class="p">,</span> <span class="s2">&quot;makefile&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">makefile</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No Makefile found in the build directory&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if &#39;target&#39; is a valid target.</span>
        <span class="c1">#</span>
        <span class="c1"># `make -n target` performs a &quot;dry run&quot;. It prints the commands that</span>
        <span class="c1"># would be run but doesn&#39;t actually run them. If the target does not</span>
        <span class="c1"># exist, you will see one of the following error messages:</span>
        <span class="c1">#</span>
        <span class="c1"># GNU Make:</span>
        <span class="c1">#     make: *** No rule to make target `test&#39;.  Stop.</span>
        <span class="c1">#           *** No rule to make target &#39;test&#39;.  Stop.</span>
        <span class="c1">#</span>
        <span class="c1"># BSD Make:</span>
        <span class="c1">#     make: don&#39;t know how to make test. Stop</span>
        <span class="c1">#</span>
        <span class="c1"># Note: &quot;Stop.&quot; is not printed when running a Make jobserver (spack env depfile) that runs</span>
        <span class="c1"># with `make -k/--keep-going`</span>
        <span class="n">missing_target_msgs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;No rule to make target `</span><span class="si">{0}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;No rule to make target &#39;</span><span class="si">{0}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;don&#39;t know how to make </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fail_on_error&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="c1"># Remove MAKEFLAGS to avoid inherited flags from Make jobserver (spack env depfile)</span>
            <span class="s2">&quot;extra_env&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;MAKEFLAGS&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="n">stderr</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">missing_target_msg</span> <span class="ow">in</span> <span class="n">missing_target_msgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">missing_target_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Target &#39;</span><span class="si">{0}</span><span class="s2">&#39; not found in </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">makefile</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_if_make_target_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs ``make target`` if &#39;target&#39; is a valid target in the Makefile.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            target (str): the target to potentially execute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_make_target</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="c1"># Execute target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has_ninja_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks to see if &#39;target&#39; is a valid target in a Ninja build script.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            target (str): the target to check for</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if &#39;target&#39; is found, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ninja</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ninja</span>

        <span class="c1"># Check if we have a Ninja build script</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;build.ninja&quot;</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No Ninja build script found in the build directory&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Get a list of all targets in the Ninja build script</span>
        <span class="c1"># https://ninja-build.org/manual.html#_extra_tools</span>
        <span class="n">all_targets</span> <span class="o">=</span> <span class="n">ninja</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;targets&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if &#39;target&#39; is a valid target</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">all_targets</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Target &#39;</span><span class="si">{0}</span><span class="s2">&#39; not found in build.ninja&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_if_ninja_target_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs ``ninja target`` if &#39;target&#39; is a valid target in the Ninja</span>
<span class="sd">        build script.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            target (str): the target to potentially execute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_ninja_target</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="c1"># Execute target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ninja</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_needed_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We use intersects here cause it would also work if self.spec is abstract</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">resource</span>
            <span class="k">for</span> <span class="n">when_spec</span><span class="p">,</span> <span class="n">resource_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">when_spec</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resource_list</span>
        <span class="p">]</span>
        <span class="c1"># Sorts the resources by the length of the string representing their destination. Since any</span>
        <span class="c1"># nested resource must contain another resource&#39;s path, that should work</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">res</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">destination</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_resource_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="n">pieces</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span>
        <span class="n">resource_stage_folder</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resource_stage_folder</span>

<div class="viewcode-block" id="PackageBase.do_test">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.do_test">[docs]</a>
    <span class="k">def</span> <span class="nf">do_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">externals</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_requires_compiler</span><span class="p">:</span>
            <span class="n">compilers</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">compilers_for_spec</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span> <span class="n">arch_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compilers</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Skipping tests for package </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">-</span><span class="si">{version}</span><span class="s2">-</span><span class="si">{hash:7}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;Package test requires missing compiler </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dirty&quot;</span><span class="p">:</span> <span class="n">dirty</span><span class="p">,</span>
            <span class="s2">&quot;fake&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
            <span class="s2">&quot;externals&quot;</span><span class="p">:</span> <span class="n">externals</span><span class="p">,</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="n">tty</span><span class="o">.</span><span class="n">is_verbose</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tester</span><span class="o">.</span><span class="n">stand_alone_tests</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.unit_test_check">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.unit_test_check">[docs]</a>
    <span class="k">def</span> <span class="nf">unit_test_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook for unit tests to assert things about package internals.</span>

<span class="sd">        Unit tests can override this function to perform checks after</span>
<span class="sd">        ``Package.install`` and all post-install hooks run, but before</span>
<span class="sd">        the database is updated.</span>

<span class="sd">        The overridden function may indicate that the install procedure</span>
<span class="sd">        should terminate early (before updating the database) by</span>
<span class="sd">        returning ``False`` (or any value such that ``bool(result)`` is</span>
<span class="sd">        ``False``).</span>

<span class="sd">        Return:</span>
<span class="sd">            (bool): ``True`` to continue, ``False`` to skip ``install()``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="PackageBase.inject_flags">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.inject_flags">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">inject_flags</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Pb</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">FLAG_HANDLER_RETURN_TYPE</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        flag_handler that injects all flags through the compiler wrapper.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">flags</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PackageBase.env_flags">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.env_flags">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">env_flags</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Pb</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">FLAG_HANDLER_RETURN_TYPE</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        flag_handler that adds all flags to canonical environment variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PackageBase.build_system_flags">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.build_system_flags">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_system_flags</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Pb</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FLAG_HANDLER_RETURN_TYPE</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        flag_handler that passes flags to the build system arguments.  Any</span>
<span class="sd">        package using `build_system_flags` must also implement</span>
<span class="sd">        `flags_to_build_system_args`, or derive from a class that</span>
<span class="sd">        implements it.  Currently, AutotoolsPackage and CMakePackage</span>
<span class="sd">        implement it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">flags</span></div>


<div class="viewcode-block" id="PackageBase.setup_run_environment">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.setup_run_environment">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_run_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up the run environment for a package.</span>

<span class="sd">        Args:</span>
<span class="sd">            env (spack.util.environment.EnvironmentModifications): environment</span>
<span class="sd">                modifications to be applied when the package is run. Package authors</span>
<span class="sd">                can call methods on it to alter the run environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="PackageBase.setup_dependent_run_environment">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.setup_dependent_run_environment">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_dependent_run_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">dependent_spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up the run environment of packages that depend on this one.</span>

<span class="sd">        This is similar to ``setup_run_environment``, but it is used to</span>
<span class="sd">        modify the run environments of packages that *depend* on this one.</span>

<span class="sd">        This gives packages like Python and others that follow the extension</span>
<span class="sd">        model a way to implement common environment or run-time settings</span>
<span class="sd">        for dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            env (spack.util.environment.EnvironmentModifications): environment</span>
<span class="sd">                modifications to be applied when the dependent package is run.</span>
<span class="sd">                Package authors can call methods on it to alter the build environment.</span>

<span class="sd">            dependent_spec (spack.spec.Spec): The spec of the dependent package</span>
<span class="sd">                about to be run. This allows the extendee (self) to query</span>
<span class="sd">                the dependent&#39;s state. Note that *this* package&#39;s spec is</span>
<span class="sd">                available as ``self.spec``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="PackageBase.setup_dependent_package">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.setup_dependent_package">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_dependent_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">dependent_spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up Python module-scope variables for dependent packages.</span>

<span class="sd">        Called before the install() method of dependents.</span>

<span class="sd">        Default implementation does nothing, but this can be</span>
<span class="sd">        overridden by an extendable package to set up the module of</span>
<span class="sd">        its extensions. This is useful if there are some common steps</span>
<span class="sd">        to installing all extensions for a certain package.</span>

<span class="sd">        Examples:</span>

<span class="sd">        1. Extensions often need to invoke the ``python`` interpreter</span>
<span class="sd">           from the Python installation being extended. This routine</span>
<span class="sd">           can put a ``python()`` Executable object in the module scope</span>
<span class="sd">           for the extension package to simplify extension installs.</span>

<span class="sd">        2. MPI compilers could set some variables in the dependent&#39;s</span>
<span class="sd">           scope that point to ``mpicc``, ``mpicxx``, etc., allowing</span>
<span class="sd">           them to be called by common name regardless of which MPI is used.</span>

<span class="sd">        3. BLAS/LAPACK implementations can set some variables</span>
<span class="sd">           indicating the path to their libraries, since these</span>
<span class="sd">           paths differ by BLAS/LAPACK implementation.</span>

<span class="sd">        Args:</span>
<span class="sd">            module (spack.package_base.PackageBase.module): The Python ``module``</span>
<span class="sd">                object of the dependent package. Packages can use this to set</span>
<span class="sd">                module-scope variables for the dependent to use.</span>

<span class="sd">            dependent_spec (spack.spec.Spec): The spec of the dependent package</span>
<span class="sd">                about to be built. This allows the extendee (self) to</span>
<span class="sd">                query the dependent&#39;s state.  Note that *this*</span>
<span class="sd">                package&#39;s spec is available as ``self.spec``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="n">_flag_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FLAG_HANDLER_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flag_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FLAG_HANDLER_TYPE</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flag_handler</span> <span class="o">=</span> <span class="n">PackageBase</span><span class="o">.</span><span class="n">inject_flags</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag_handler</span>

    <span class="nd">@flag_handler</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">flag_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">FLAG_HANDLER_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag_handler</span> <span class="o">=</span> <span class="n">var</span>

    <span class="c1"># The flag handler method is called for each of the allowed compiler flags.</span>
    <span class="c1"># It returns a triple of inject_flags, env_flags, build_system_flags.</span>
    <span class="c1"># The flags returned as inject_flags are injected through the spack</span>
    <span class="c1">#  compiler wrappers.</span>
    <span class="c1"># The flags returned as env_flags are passed to the build system through</span>
    <span class="c1">#  the environment variables of the same name.</span>
    <span class="c1"># The flags returned as build_system_flags are passed to the build system</span>
    <span class="c1">#  package subclass to be turned into the appropriate part of the standard</span>
    <span class="c1">#  arguments. This is implemented for build system classes where</span>
    <span class="c1">#  appropriate and will otherwise raise a NotImplementedError.</span>

<div class="viewcode-block" id="PackageBase.flags_to_build_system_args">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.flags_to_build_system_args">[docs]</a>
    <span class="k">def</span> <span class="nf">flags_to_build_system_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="c1"># Takes flags as a dict name: list of values</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flags</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The </span><span class="si">{0}</span><span class="s2"> build system&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; cannot take command line arguments for compiler flags&quot;</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.uninstall_by_spec">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.uninstall_by_spec">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">uninstall_by_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deprecator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="c1"># prefix may not exist, but DB may be inconsistent. Try to fix by</span>
            <span class="c1"># removing, but omit hooks.</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">specs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">deprecator</span><span class="p">:</span>
                    <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deprecate</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">deprecator</span><span class="p">)</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deprecating stale DB entry for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removed stale DB entry for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InstallError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is not installed.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">dependents</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">installed_relatives</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;parents&quot;</span><span class="p">,</span> <span class="n">transitive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">dependents</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PackageStillNeededError</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">dependents</span><span class="p">)</span>

        <span class="c1"># Try to get the package for the spec</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">package</span>
        <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">UnknownEntityError</span><span class="p">:</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Pre-uninstall hook runs first.</span>
        <span class="k">with</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">prefix_locker</span><span class="o">.</span><span class="n">write_lock</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">pre_uninstall</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;One or more pre_uninstall hooks have failed&quot;</span>
                            <span class="s2">&quot; for </span><span class="si">{0}</span><span class="s2">, but Spack is continuing with the&quot;</span>
                            <span class="s2">&quot; uninstall&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
                            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Error message: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                        <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                        <span class="c1"># Note that if the uninstall succeeds then we won&#39;t be</span>
                        <span class="c1"># seeing this error again and won&#39;t have another chance</span>
                        <span class="c1"># to run the hook.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="c1"># Uninstalling in Spack only requires removing the prefix.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Deleting package prefix [</span><span class="si">{0}</span><span class="s2">]&quot;</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">))</span>
                <span class="c1"># test if spec is already deprecated, not whether we want to</span>
                <span class="c1"># deprecate it now</span>
                <span class="n">deprecated</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deprecator</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">remove_install_directory</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">deprecated</span><span class="p">)</span>
            <span class="c1"># Delete DB entry</span>
            <span class="k">if</span> <span class="n">deprecator</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;deprecating DB entry [</span><span class="si">{0}</span><span class="s2">] in favor of [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">,</span> <span class="n">deprecator</span><span class="o">.</span><span class="n">short_spec</span><span class="p">))</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deprecate</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">deprecator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Deleting DB entry [</span><span class="si">{0}</span><span class="s2">]&quot;</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">))</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">post_uninstall</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If there is a failure here, this is our only chance to do</span>
                <span class="c1"># something about it: at this point the Spec has been removed</span>
                <span class="c1"># from the DB and prefix, so the post-uninstallation hooks</span>
                <span class="c1"># will not have another chance to run.</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;One or more post-uninstallation hooks failed for&quot;</span>
                    <span class="s2">&quot; </span><span class="si">{0}</span><span class="s2">, but the prefix has been removed (if it is not&quot;</span>
                    <span class="s2">&quot; external).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">tb_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">The error:</span><span class="se">\n\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tb_msg</span><span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Successfully uninstalled </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">))</span></div>


<div class="viewcode-block" id="PackageBase.do_uninstall">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.do_uninstall">[docs]</a>
    <span class="k">def</span> <span class="nf">do_uninstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uninstall this package by spec.&quot;&quot;&quot;</span>
        <span class="c1"># delegate to instance-less method.</span>
        <span class="n">PackageBase</span><span class="o">.</span><span class="n">uninstall_by_spec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.view">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.view">[docs]</a>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a view with the prefix of this package as the root.</span>
<span class="sd">        Extensions added to this view will modify the installation prefix of</span>
<span class="sd">        this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">YamlFilesystemView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageBase.do_restage">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.do_restage">[docs]</a>
    <span class="k">def</span> <span class="nf">do_restage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reverts expanded/checked out source to a pristine state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">restage</span><span class="p">()</span></div>


<div class="viewcode-block" id="PackageBase.do_clean">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.do_clean">[docs]</a>
    <span class="k">def</span> <span class="nf">do_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes the package&#39;s build stage and source tarball.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span></div>


<div class="viewcode-block" id="PackageBase.format_doc">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.format_doc">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">format_doc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap doc string at 72 characters and format nicely&quot;&quot;&quot;</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A list of all URLs in a package.</span>

<span class="sd">        Check both class-level and version-specific URLs.</span>

<span class="sd">        Returns a list of URLs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># fetch from first entry in urls to save time</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;urls&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="p">:</span>
            <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">urls</span>

<div class="viewcode-block" id="PackageBase.fetch_remote_versions">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageBase.fetch_remote_versions">[docs]</a>
    <span class="k">def</span> <span class="nf">fetch_remote_versions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">concurrency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">StandardVersion</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find remote versions of this package.</span>

<span class="sd">        Uses ``list_url`` and any other URLs listed in the package file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: a dictionary mapping versions to URLs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_urls</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">find_versions_of_archive</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_urls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_depth</span><span class="p">,</span> <span class="n">concurrency</span><span class="p">,</span> <span class="n">reference_package</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">NoNetworkConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="s2">&quot;Package.fetch_versions couldn&#39;t connect to:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the rpath this package links with, as a list of paths.&quot;&quot;&quot;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="s2">&quot;link&quot;</span><span class="p">)</span>

        <span class="c1"># on Windows, libraries of runtime interest are typically</span>
        <span class="c1"># stored in the bin directory</span>
        <span class="c1"># Do not include Windows system libraries in the rpath interface</span>
        <span class="c1"># these libraries are handled automatically by VS/VCVARS and adding</span>
        <span class="c1"># Spack derived system libs into the link path or address space of a program</span>
        <span class="c1"># can result in conflicting versions, which makes Spack packages less useable</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="n">rpaths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">]</span>
            <span class="n">rpaths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">d</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s2">&quot;windows-system&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rpaths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib64</span><span class="p">]</span>
            <span class="n">rpaths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">))</span>
            <span class="n">rpaths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib64</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib64</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rpaths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rpath_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the rpath args as a string, with -Wl,-rpath, for each element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;-Wl,-rpath,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpath</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">builder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>



<span class="n">inject_flags</span> <span class="o">=</span> <span class="n">PackageBase</span><span class="o">.</span><span class="n">inject_flags</span>
<span class="n">env_flags</span> <span class="o">=</span> <span class="n">PackageBase</span><span class="o">.</span><span class="n">env_flags</span>
<span class="n">build_system_flags</span> <span class="o">=</span> <span class="n">PackageBase</span><span class="o">.</span><span class="n">build_system_flags</span>


<div class="viewcode-block" id="install_dependency_symlinks">
<a class="viewcode-back" href="../../spack.html#spack.package_base.install_dependency_symlinks">[docs]</a>
<span class="k">def</span> <span class="nf">install_dependency_symlinks</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a dummy install and flatten dependencies.</span>

<span class="sd">    This routine can be used in a ``package.py`` definition by setting</span>
<span class="sd">    ``install = install_dependency_symlinks``.</span>

<span class="sd">    This feature comes in handy for creating a common location for the</span>
<span class="sd">    the installation of third-party libraries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flatten_dependencies</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span></div>



<div class="viewcode-block" id="use_cray_compiler_names">
<a class="viewcode-back" href="../../spack.html#spack.package_base.use_cray_compiler_names">[docs]</a>
<span class="k">def</span> <span class="nf">use_cray_compiler_names</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compiler names for builds that rely on cray compiler names.&quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cc&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CXX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CC&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ftn&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;F77&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ftn&quot;</span></div>



<div class="viewcode-block" id="flatten_dependencies">
<a class="viewcode-back" href="../../spack.html#spack.package_base.flatten_dependencies">[docs]</a>
<span class="k">def</span> <span class="nf">flatten_dependencies</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">flat_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make each dependency of spec present in dir via symlink.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span>

        <span class="n">dep_path</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">path_for_spec</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="n">dep_files</span> <span class="o">=</span> <span class="n">LinkTree</span><span class="p">(</span><span class="n">dep_path</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">flat_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">conflict</span> <span class="o">=</span> <span class="n">dep_files</span><span class="o">.</span><span class="n">find_conflict</span><span class="p">(</span><span class="n">flat_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conflict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DependencyConflictError</span><span class="p">(</span><span class="n">conflict</span><span class="p">)</span>

        <span class="n">dep_files</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">flat_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="possible_dependencies">
<a class="viewcode-back" href="../../spack.html#spack.package_base.possible_dependencies">[docs]</a>
<span class="k">def</span> <span class="nf">possible_dependencies</span><span class="p">(</span>
    <span class="o">*</span><span class="n">pkg_or_spec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">PackageBase</span><span class="p">]],</span>
    <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">expand_virtuals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">depflag</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">DepFlag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
    <span class="n">missing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">virtuals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the possible dependencies of a number of packages.</span>

<span class="sd">    See ``PackageBase.possible_dependencies`` for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pkg_or_spec</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">PackageMeta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">PackageBase</span><span class="p">):</span>
            <span class="n">packages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">is_virtual</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">packages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">package_class</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">providers_for</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">packages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">package_class</span><span class="p">)</span>

    <span class="n">visited</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
        <span class="n">pkg</span><span class="o">.</span><span class="n">possible_dependencies</span><span class="p">(</span>
            <span class="n">visited</span><span class="o">=</span><span class="n">visited</span><span class="p">,</span>
            <span class="n">transitive</span><span class="o">=</span><span class="n">transitive</span><span class="p">,</span>
            <span class="n">expand_virtuals</span><span class="o">=</span><span class="n">expand_virtuals</span><span class="p">,</span>
            <span class="n">depflag</span><span class="o">=</span><span class="n">depflag</span><span class="p">,</span>
            <span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">,</span>
            <span class="n">virtuals</span><span class="o">=</span><span class="n">virtuals</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">visited</span></div>



<div class="viewcode-block" id="PackageStillNeededError">
<a class="viewcode-back" href="../../spack.html#spack.package_base.PackageStillNeededError">[docs]</a>
<span class="k">class</span> <span class="nc">PackageStillNeededError</span><span class="p">(</span><span class="n">InstallError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when package is still needed by another on uninstall.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">dependents</span><span class="p">):</span>
        <span class="n">spec_fmt</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">DEFAULT_FORMAT</span> <span class="o">+</span> <span class="s2">&quot; /</span><span class="si">{hash:7}</span><span class="s2">&quot;</span>
        <span class="n">dep_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">{@versions} /</span><span class="si">{hash:7}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cannot uninstall </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_fmt</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;needed by </span><span class="si">{</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dep_fmt</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dep</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dependents</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependents</span> <span class="o">=</span> <span class="n">dependents</span></div>



<div class="viewcode-block" id="InvalidPackageOpError">
<a class="viewcode-back" href="../../spack.html#spack.package_base.InvalidPackageOpError">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidPackageOpError</span><span class="p">(</span><span class="n">PackageError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when someone tries perform an invalid operation on a package.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ExtensionError">
<a class="viewcode-back" href="../../spack.html#spack.package_base.ExtensionError">[docs]</a>
<span class="k">class</span> <span class="nc">ExtensionError</span><span class="p">(</span><span class="n">PackageError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Superclass for all errors having to do with extension packages.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ActivationError">
<a class="viewcode-back" href="../../spack.html#spack.package_base.ActivationError">[docs]</a>
<span class="k">class</span> <span class="nc">ActivationError</span><span class="p">(</span><span class="n">ExtensionError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when there are problems activating an extension.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">long_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">long_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="DependencyConflictError">
<a class="viewcode-back" href="../../spack.html#spack.package_base.DependencyConflictError">[docs]</a>
<span class="k">class</span> <span class="nc">DependencyConflictError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the dependencies cannot be flattened as asked for.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conflict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> conflicts with another file in the flattened directory.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conflict</span><span class="p">))</span></div>



<div class="viewcode-block" id="ManualDownloadRequiredError">
<a class="viewcode-back" href="../../spack.html#spack.package_base.ManualDownloadRequiredError">[docs]</a>
<span class="k">class</span> <span class="nc">ManualDownloadRequiredError</span><span class="p">(</span><span class="n">InvalidPackageOpError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when attempting an invalid operation on a package that requires a manual download.&quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>