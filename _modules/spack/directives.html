

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.directives &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.directives</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.directives</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>

<span class="sd">&quot;&quot;&quot;This package contains directives that can be used within a package.</span>

<span class="sd">Directives are functions that can be called inside a package</span>
<span class="sd">definition to modify the package, for example:</span>

<span class="sd">    class OpenMpi(Package):</span>
<span class="sd">        depends_on(&quot;hwloc&quot;)</span>
<span class="sd">        provides(&quot;mpi&quot;)</span>
<span class="sd">        ...</span>

<span class="sd">``provides`` and ``depends_on`` are spack directives.</span>

<span class="sd">The available directives are:</span>

<span class="sd">  * ``build_system``</span>
<span class="sd">  * ``conflicts``</span>
<span class="sd">  * ``depends_on``</span>
<span class="sd">  * ``extends``</span>
<span class="sd">  * ``patch``</span>
<span class="sd">  * ``provides``</span>
<span class="sd">  * ``resource``</span>
<span class="sd">  * ``variant``</span>
<span class="sd">  * ``version``</span>
<span class="sd">  * ``requires``</span>
<span class="sd">  * ``redistribute``</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">llnl.util.lang</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty.color</span>

<span class="kn">import</span> <span class="nn">spack.deptypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">spack.patch</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.util.crypto</span>
<span class="kn">import</span> <span class="nn">spack.variant</span>
<span class="kn">from</span> <span class="nn">spack.dependency</span> <span class="kn">import</span> <span class="n">Dependency</span>
<span class="kn">from</span> <span class="nn">spack.directives_meta</span> <span class="kn">import</span> <span class="n">DirectiveError</span><span class="p">,</span> <span class="n">DirectiveMeta</span>
<span class="kn">from</span> <span class="nn">spack.fetch_strategy</span> <span class="kn">import</span> <span class="n">from_kwargs</span>
<span class="kn">from</span> <span class="nn">spack.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">spack.version</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GitVersion</span><span class="p">,</span>
    <span class="n">Version</span><span class="p">,</span>
    <span class="n">VersionChecksumError</span><span class="p">,</span>
    <span class="n">VersionError</span><span class="p">,</span>
    <span class="n">VersionLookupError</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">spack.package_base</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;DirectiveError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DirectiveMeta&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DisableRedistribute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;version&quot;</span><span class="p">,</span>
    <span class="s2">&quot;conditional&quot;</span><span class="p">,</span>
    <span class="s2">&quot;conflicts&quot;</span><span class="p">,</span>
    <span class="s2">&quot;depends_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;extends&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maintainers&quot;</span><span class="p">,</span>
    <span class="s2">&quot;license&quot;</span><span class="p">,</span>
    <span class="s2">&quot;provides&quot;</span><span class="p">,</span>
    <span class="s2">&quot;patch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;variant&quot;</span><span class="p">,</span>
    <span class="s2">&quot;resource&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_system&quot;</span><span class="p">,</span>
    <span class="s2">&quot;requires&quot;</span><span class="p">,</span>
    <span class="s2">&quot;redistribute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;can_splice&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_patch_order_index</span> <span class="o">=</span> <span class="mi">0</span>


<span class="n">SpecType</span> <span class="o">=</span> <span class="nb">str</span>
<span class="n">DepType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">WhenType</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
<span class="n">Patcher</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">PatchesType</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Patcher</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Patcher</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span>


<span class="n">SUPPORTED_LANGUAGES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fortran&quot;</span><span class="p">,</span> <span class="s2">&quot;cxx&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_when_spec</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">WhenType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a ``Spec`` that indicates when a directive should be applied.</span>

<span class="sd">    Directives with ``when`` specs, e.g.:</span>

<span class="sd">        patch(&#39;foo.patch&#39;, when=&#39;@4.5.1:&#39;)</span>
<span class="sd">        depends_on(&#39;mpi&#39;, when=&#39;+mpi&#39;)</span>
<span class="sd">        depends_on(&#39;readline&#39;, when=sys.platform() != &#39;darwin&#39;)</span>

<span class="sd">    are applied conditionally depending on the value of the ``when``</span>
<span class="sd">    keyword argument.  Specifically:</span>

<span class="sd">      1. If the ``when`` argument is ``True``, the directive is always applied</span>
<span class="sd">      2. If it is ``False``, the directive is never applied</span>
<span class="sd">      3. If it is a ``Spec`` string, it is applied when the package&#39;s</span>
<span class="sd">         concrete spec satisfies the ``when`` spec.</span>

<span class="sd">    The first two conditions are useful for the third example case above.</span>
<span class="sd">    It allows package authors to include directives that are conditional</span>
<span class="sd">    at package definition time, in additional to ones that are evaluated</span>
<span class="sd">    as part of concretization.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        value: a conditional Spec, constant ``bool``, or None if not supplied</span>
<span class="sd">           value indicating when a directive should be applied.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="c1"># Unsatisfiable conditions are discarded by the caller, and never</span>
    <span class="c1"># added to the package class</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># If there is no constraint, the directive should always apply;</span>
    <span class="c1"># represent this by returning the unconstrained `Spec()`, which is</span>
    <span class="c1"># always satisfied.</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">()</span>

    <span class="c1"># This is conditional on the spec</span>
    <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="n">SubmoduleCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span>
<span class="n">directive</span> <span class="o">=</span> <span class="n">DirectiveMeta</span><span class="o">.</span><span class="n">directive</span>


<div class="viewcode-block" id="version">
<a class="viewcode-back" href="../../spack.html#spack.directives.version">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;versions&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">version</span><span class="p">(</span>
    <span class="n">ver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="c1"># this positional argument is deprecated, use sha256=... instead</span>
    <span class="n">checksum</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="c1"># generic version options</span>
    <span class="n">preferred</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">deprecated</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">no_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># url fetch options</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extension</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">expand</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fetch_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># url archive verification options</span>
    <span class="n">md5</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sha1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sha224</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sha256</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sha384</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sha512</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># git fetch options</span>
    <span class="n">git</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">commit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">get_full_repo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">submodules</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SubmoduleCallback</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">submodules_delete</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># other version control</span>
    <span class="n">svn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cvs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a version and, if appropriate, metadata for fetching its code.</span>

<span class="sd">    The ``version`` directives are aggregated into a ``versions`` dictionary</span>
<span class="sd">    attribute with ``Version`` keys and metadata values, where the metadata</span>
<span class="sd">    is stored as a dictionary of ``kwargs``.</span>

<span class="sd">    The (keyword) arguments are turned into a valid fetch strategy for</span>
<span class="sd">    code packages later. See ``spack.fetch_strategy.for_package_version()``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="n">sha256</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sha384&quot;</span><span class="p">,</span> <span class="n">sha384</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sha512&quot;</span><span class="p">,</span> <span class="n">sha512</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;preferred&quot;</span><span class="p">,</span> <span class="n">preferred</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="n">deprecated</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;no_cache&quot;</span><span class="p">,</span> <span class="n">no_cache</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;fetch_options&quot;</span><span class="p">,</span> <span class="n">fetch_options</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="n">git</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;svn&quot;</span><span class="p">,</span> <span class="n">svn</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;hg&quot;</span><span class="p">,</span> <span class="n">hg</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;cvs&quot;</span><span class="p">,</span> <span class="n">cvs</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;get_full_repo&quot;</span><span class="p">,</span> <span class="n">get_full_repo</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;branch&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;submodules&quot;</span><span class="p">,</span> <span class="n">submodules</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;submodules_delete&quot;</span><span class="p">,</span> <span class="n">submodules_delete</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="n">commit</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;revision&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sha1&quot;</span><span class="p">,</span> <span class="n">sha1</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sha224&quot;</span><span class="p">,</span> <span class="n">sha224</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;checksum&quot;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">pkg</span><span class="p">:</span> <span class="n">_execute_version</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_execute_version</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">hashes</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;checksum&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;has_code&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">has_code</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="n">VersionChecksumError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: Checksums not allowed in no-code packages &quot;</span>
            <span class="s2">&quot;(see &#39;</span><span class="si">{1}</span><span class="s2">&#39; version).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">VersionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: declared version &#39;</span><span class="si">{</span><span class="n">ver</span><span class="si">!r}</span><span class="s2">&#39; in package should be a string or int.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Declared versions are concrete</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;git&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">argname</span><span class="si">}</span><span class="s2">=&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">VersionLookupError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: spack version directives cannot include git hashes fetched from URLs.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    version(&#39;</span><span class="si">{</span><span class="n">ver</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Store kwargs for the package to later with a fetch_strategy.</span>
    <span class="n">pkg</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">version</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">_depends_on</span><span class="p">(</span>
    <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span>
    <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">WhenType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">DepType</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">DEFAULT_TYPES</span><span class="p">,</span>
    <span class="n">patches</span><span class="p">:</span> <span class="n">PatchesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DependencyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dependency specification in package &#39;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CircularReferenceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Package &#39;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; cannot depend on itself.&quot;</span><span class="p">)</span>

    <span class="n">depflag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>

    <span class="c1"># call this patches here for clarity -- we want patch to be a list,</span>
    <span class="c1"># but the caller doesn&#39;t have to make it one.</span>

    <span class="c1"># Note: we cannot check whether a package is virtual in a directive</span>
    <span class="c1"># because directives are run as part of class instantiation, and specs</span>
    <span class="c1"># instantiate the package class as part of the `virtual` check.</span>
    <span class="c1"># To be technical, specs only instantiate the package class as part of the</span>
    <span class="c1"># virtual check if the provider index hasn&#39;t been created yet.</span>
    <span class="c1"># TODO: There could be a cache warming strategy that would allow us to</span>
    <span class="c1"># ensure `Spec.virtual` is a valid thing to call in a directive.</span>
    <span class="c1"># For now, we comment out the following check to allow for virtual packages</span>
    <span class="c1"># with package files.</span>
    <span class="c1"># if patches and spec.virtual:</span>
    <span class="c1">#     raise DependencyPatchError(&quot;Cannot patch a virtual dependency.&quot;)</span>

    <span class="c1"># ensure patches is a list</span>
    <span class="k">if</span> <span class="n">patches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">patches</span><span class="p">]</span>

    <span class="c1"># auto-call patch() directive on any strings in patch list</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">callable</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">)</span>

    <span class="c1"># this is where we actually add the dependency to this package</span>
    <span class="n">deps_by_name</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">dependency</span> <span class="o">=</span> <span class="n">deps_by_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dependency</span><span class="p">:</span>
        <span class="n">dependency</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">depflag</span><span class="o">=</span><span class="n">depflag</span><span class="p">)</span>
        <span class="n">deps_by_name</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dependency</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dependency</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dependency</span><span class="o">.</span><span class="n">depflag</span> <span class="o">|=</span> <span class="n">depflag</span>

    <span class="c1"># apply patches to the dependency</span>
    <span class="k">for</span> <span class="n">execute_patch</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
        <span class="n">execute_patch</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>


<div class="viewcode-block" id="conflicts">
<a class="viewcode-back" href="../../spack.html#spack.directives.conflicts">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;conflicts&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">conflicts</span><span class="p">(</span><span class="n">conflict_spec</span><span class="p">:</span> <span class="n">SpecType</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">WhenType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allows a package to define a conflict.</span>

<span class="sd">    Currently, a &quot;conflict&quot; is a concretized configuration that is known</span>
<span class="sd">    to be non-valid. For example, a package that is known not to be</span>
<span class="sd">    buildable with intel compilers can declare::</span>

<span class="sd">        conflicts(&#39;%intel&#39;)</span>

<span class="sd">    To express the same constraint only when the &#39;foo&#39; variant is</span>
<span class="sd">    activated::</span>

<span class="sd">        conflicts(&#39;%intel&#39;, when=&#39;+foo&#39;)</span>

<span class="sd">    Args:</span>
<span class="sd">        conflict_spec (spack.spec.Spec): constraint defining the known conflict</span>
<span class="sd">        when (spack.spec.Spec): optional constraint that triggers the conflict</span>
<span class="sd">        msg (str): optional user defined message</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_conflicts</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">):</span>
        <span class="c1"># If when is not specified the conflict always holds</span>
        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Save in a list the conflicts and the associated custom messages</span>
        <span class="n">conflict_spec_list</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">conflicts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">msg_with_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">msg</span>
        <span class="n">conflict_spec_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">conflict_spec</span><span class="p">),</span> <span class="n">msg_with_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_execute_conflicts</span></div>



<div class="viewcode-block" id="depends_on">
<a class="viewcode-back" href="../../spack.html#spack.directives.depends_on">[docs]</a>
<span class="nd">@directive</span><span class="p">((</span><span class="s2">&quot;dependencies&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">depends_on</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">SpecType</span><span class="p">,</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">WhenType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">DepType</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">DEFAULT_TYPES</span><span class="p">,</span>
    <span class="n">patches</span><span class="p">:</span> <span class="n">PatchesType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a dict of deps with specs defining when they apply.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec: the package and constraints depended on</span>
<span class="sd">        when: when the dependent satisfies this, it has</span>
<span class="sd">            the dependency represented by ``spec``</span>
<span class="sd">        type: str or tuple of legal Spack deptypes</span>
<span class="sd">        patches: single result of ``patch()`` directive, a</span>
<span class="sd">            ``str`` to be passed to ``patch``, or a list of these</span>

<span class="sd">    This directive is to be used inside a Package definition to declare</span>
<span class="sd">    that the package requires other packages to be built first.</span>
<span class="sd">    @see The section &quot;Dependency specs&quot; in the Spack Packaging Guide.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dep_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dep_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">SUPPORTED_LANGUAGES</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;languages must be of &#39;build&#39; type&quot;</span>
        <span class="k">return</span> <span class="n">_language</span><span class="p">(</span><span class="n">lang_spec_str</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_depends_on</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">):</span>
        <span class="n">_depends_on</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">dep_spec</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">patches</span><span class="o">=</span><span class="n">patches</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_depends_on</span></div>



<span class="c1">#: Store whether a given Spec source/binary should not be redistributed.</span>
<div class="viewcode-block" id="DisableRedistribute">
<a class="viewcode-back" href="../../spack.html#spack.directives.DisableRedistribute">[docs]</a>
<span class="k">class</span> <span class="nc">DisableRedistribute</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">binary</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span></div>



<div class="viewcode-block" id="redistribute">
<a class="viewcode-back" href="../../spack.html#spack.directives.redistribute">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;disable_redistribute&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">redistribute</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">WhenType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Can be used inside a Package definition to declare that</span>
<span class="sd">    the package source and/or compiled binaries should not be</span>
<span class="sd">    redistributed.</span>

<span class="sd">    By default, Packages allow source/binary distribution (i.e. in</span>
<span class="sd">    mirrors). Because of this, and because overlapping enable/</span>
<span class="sd">    disable specs are not allowed, this directive only allows users</span>
<span class="sd">    to explicitly disable redistribution for specs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="k">lambda</span> <span class="n">pkg</span><span class="p">:</span> <span class="n">_execute_redistribute</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">when</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_execute_redistribute</span><span class="p">(</span>
    <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">WhenType</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">binary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">binary</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DirectiveError</span><span class="p">(</span>
            <span class="s2">&quot;Source/binary distribution are true by default, they can only &quot;</span>
            <span class="s2">&quot;be explicitly disabled.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">binary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">max_constraint</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">when_spec</span><span class="o">.</span><span class="n">versions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_constraint</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">when_spec</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DirectiveError</span><span class="p">(</span><span class="s2">&quot;Source distribution can only be disabled for versions&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">when_spec</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">disable_redistribute</span><span class="p">:</span>
        <span class="n">disable</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">disable_redistribute</span><span class="p">[</span><span class="n">when_spec</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">disable</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">binary</span><span class="p">:</span>
            <span class="n">disable</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pkg</span><span class="o">.</span><span class="n">disable_redistribute</span><span class="p">[</span><span class="n">when_spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">DisableRedistribute</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="ow">not</span> <span class="n">source</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="ow">not</span> <span class="n">binary</span>
        <span class="p">)</span>


<div class="viewcode-block" id="extends">
<a class="viewcode-back" href="../../spack.html#spack.directives.extends">[docs]</a>
<span class="nd">@directive</span><span class="p">((</span><span class="s2">&quot;extendees&quot;</span><span class="p">,</span> <span class="s2">&quot;dependencies&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">extends</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">),</span> <span class="n">patches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as depends_on, but also adds this package to the extendee list.</span>
<span class="sd">    In case of Python, also adds a dependency on python-venv.</span>

<span class="sd">    keyword arguments can be passed to extends() so that extension</span>
<span class="sd">    packages can pass parameters to the extendee&#39;s extension</span>
<span class="sd">    mechanism.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_extends</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">dep_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">_depends_on</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">dep_spec</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">patches</span><span class="o">=</span><span class="n">patches</span><span class="p">)</span>

        <span class="c1"># When extending python, also add a dependency on python-venv. This is done so that</span>
        <span class="c1"># Spack environment views are Python virtual environments.</span>
        <span class="k">if</span> <span class="n">dep_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;python&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;python-venv&quot;</span><span class="p">:</span>
            <span class="n">_depends_on</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="s2">&quot;python-venv&quot;</span><span class="p">),</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">))</span>

        <span class="c1"># TODO: the values of the extendees dictionary are not used. Remove in next refactor.</span>
        <span class="n">pkg</span><span class="o">.</span><span class="n">extendees</span><span class="p">[</span><span class="n">dep_spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dep_spec</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_extends</span></div>



<div class="viewcode-block" id="provides">
<a class="viewcode-back" href="../../spack.html#spack.directives.provides">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="n">dicts</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;provided&quot;</span><span class="p">,</span> <span class="s2">&quot;provided_together&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="o">*</span><span class="n">specs</span><span class="p">:</span> <span class="n">SpecType</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">WhenType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allows packages to provide a virtual dependency.</span>

<span class="sd">    If a package provides &quot;mpi&quot;, other packages can declare that they depend on &quot;mpi&quot;,</span>
<span class="sd">    and spack can use the providing package to satisfy the dependency.</span>

<span class="sd">    Args:</span>
<span class="sd">        *specs: virtual specs provided by this package</span>
<span class="sd">        when: condition when this provides clause needs to be considered</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_provides</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">spack.parser</span>  <span class="c1"># Avoid circular dependency</span>

        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># ``when`` specs for ``provides()`` need a name, as they are used</span>
        <span class="c1"># to build the ProviderIndex.</span>
        <span class="n">when_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span>

        <span class="n">spec_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
        <span class="n">spec_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spec_objs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">provided_together</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spec_names</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">provided_spec</span> <span class="ow">in</span> <span class="n">spec_objs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">provided_spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CircularReferenceError</span><span class="p">(</span><span class="s2">&quot;Package &#39;</span><span class="si">%s</span><span class="s2">&#39; cannot provide itself.&quot;</span> <span class="o">%</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">provided_set</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">provided</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="n">provided_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">provided_spec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_provides</span></div>



<div class="viewcode-block" id="can_splice">
<a class="viewcode-back" href="../../spack.html#spack.directives.can_splice">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;splice_specs&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">can_splice</span><span class="p">(</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">SpecType</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">SpecType</span><span class="p">,</span> <span class="n">match_variants</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Packages can declare whether they are ABI-compatible with another package</span>
<span class="sd">    and thus can be spliced into concrete versions of that package.</span>

<span class="sd">    Args:</span>
<span class="sd">        target: The spec that the current package is ABI-compatible with.</span>

<span class="sd">        when: An anonymous spec constraining current package for when it is</span>
<span class="sd">            ABI-compatible with target.</span>

<span class="sd">        match_variants: A list of variants that must match</span>
<span class="sd">            between target spec and current package, with special value &#39;*&#39;</span>
<span class="sd">            which matches all variants. Example: a variant is defined on both</span>
<span class="sd">            packages called json, and they are ABI-compatible whenever they agree on</span>
<span class="sd">            the json variant (regardless of whether it is turned on or off).  Note</span>
<span class="sd">            that this cannot be applied to multi-valued variants and multi-valued</span>
<span class="sd">            variants will be skipped by &#39;*&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_can_splice</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">):</span>
        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">match_variants</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">match_variants</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;* is the only valid string for match_variants &quot;</span>
                <span class="s2">&quot;if looking to provide a single variant, use &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">match_variants</span><span class="si">}</span><span class="s2">] instead&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">when_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pkg</span><span class="o">.</span><span class="n">splice_specs</span><span class="p">[</span><span class="n">when_spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="n">match_variants</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_can_splice</span></div>



<div class="viewcode-block" id="patch">
<a class="viewcode-back" href="../../spack.html#spack.directives.patch">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;patches&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">patch</span><span class="p">(</span>
    <span class="n">url_or_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">WhenType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">working_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sha256</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">archive_sha256</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Patcher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Packages can declare patches to apply to source.  You can</span>
<span class="sd">    optionally provide a when spec to indicate that a particular</span>
<span class="sd">    patch should only be applied when the package&#39;s spec meets</span>
<span class="sd">    certain conditions (e.g. a particular version).</span>

<span class="sd">    Args:</span>
<span class="sd">        url_or_filename: url or relative filename of the patch</span>
<span class="sd">        level: patch level (as in the patch shell command)</span>
<span class="sd">        when: optional anonymous spec that specifies when to apply the patch</span>
<span class="sd">        working_dir: dir to change to before applying</span>
<span class="sd">        reverse: reverse the patch</span>
<span class="sd">        sha256: sha256 sum of the patch, used to verify the patch (only required for URL patches)</span>
<span class="sd">        archive_sha256: sha256 sum of the *archive*, if the patch is compressed (only required for</span>
<span class="sd">            compressed URL patches)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_patch</span><span class="p">(</span><span class="n">pkg_or_dep</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">]):</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg_or_dep</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">):</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">pkg</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;has_code&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">has_code</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedPackageDirective</span><span class="p">(</span>
                <span class="s2">&quot;Patches are not allowed in </span><span class="si">{0}</span><span class="s2">: package has no code.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># If this spec is identical to some other, then append this</span>
        <span class="c1"># patch to the existing list.</span>
        <span class="n">cur_patches</span> <span class="o">=</span> <span class="n">pkg_or_dep</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">global</span> <span class="n">_patch_order_index</span>
        <span class="n">ordering_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_patch_order_index</span><span class="p">)</span>
        <span class="n">_patch_order_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">patch</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">Patch</span>
        <span class="k">if</span> <span class="s2">&quot;://&quot;</span> <span class="ow">in</span> <span class="n">url_or_filename</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sha256</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;patch() with a url requires a sha256&quot;</span><span class="p">)</span>

            <span class="n">patch</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">UrlPatch</span><span class="p">(</span>
                <span class="n">pkg</span><span class="p">,</span>
                <span class="n">url_or_filename</span><span class="p">,</span>
                <span class="n">level</span><span class="p">,</span>
                <span class="n">working_dir</span><span class="o">=</span><span class="n">working_dir</span><span class="p">,</span>
                <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                <span class="n">ordering_key</span><span class="o">=</span><span class="n">ordering_key</span><span class="p">,</span>
                <span class="n">sha256</span><span class="o">=</span><span class="n">sha256</span><span class="p">,</span>
                <span class="n">archive_sha256</span><span class="o">=</span><span class="n">archive_sha256</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">FilePatch</span><span class="p">(</span>
                <span class="n">pkg</span><span class="p">,</span> <span class="n">url_or_filename</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">ordering_key</span><span class="o">=</span><span class="n">ordering_key</span>
            <span class="p">)</span>

        <span class="n">cur_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_patch</span></div>



<div class="viewcode-block" id="conditional">
<a class="viewcode-back" href="../../spack.html#spack.directives.conditional">[docs]</a>
<span class="k">def</span> <span class="nf">conditional</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">when</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WhenType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Conditional values that can be used in variant declarations.&quot;&quot;&quot;</span>
    <span class="c1"># _make_when_spec returns None when the condition is statically false.</span>
    <span class="n">when</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">ConditionalVariantValues</span><span class="p">(</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">ConditionalValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="variant">
<a class="viewcode-back" href="../../spack.html#spack.directives.variant">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;variants&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">variant</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">validator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sticky</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define a variant for the package.</span>

<span class="sd">    Packager can specify a default value as well as a text description.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of the variant</span>
<span class="sd">        default: Default value for the variant, if not specified otherwise the default will be</span>
<span class="sd">            False for a boolean variant and &#39;nothing&#39; for a multi-valued variant</span>
<span class="sd">        description: Description of the purpose of the variant</span>
<span class="sd">        values: Either a tuple of strings containing the allowed values, or a callable accepting</span>
<span class="sd">            one value and returning True if it is valid</span>
<span class="sd">        multi: If False only one value per spec is allowed for this variant</span>
<span class="sd">        validator: Optional group validator to enforce additional logic. It receives the package</span>
<span class="sd">            name, the variant name and a tuple of values and should raise an instance of SpackError</span>
<span class="sd">            if the group doesn&#39;t meet the additional constraints</span>
<span class="sd">        when: Optional condition on which the variant applies</span>
<span class="sd">        sticky: The variant should not be changed by the concretizer to find a valid concrete spec</span>

<span class="sd">    Raises:</span>
<span class="sd">        DirectiveError: If arguments passed to the directive are invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">format_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; @*r{{[</span><span class="si">{0}</span><span class="s2">, variant &#39;</span><span class="si">{1}</span><span class="s2">&#39;]}}&quot;</span>
        <span class="k">return</span> <span class="n">llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tty</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">reserved_names</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_raise_reserved_name</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The name &#39;</span><span class="si">%s</span><span class="s2">&#39; is reserved by Spack&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="k">raise</span> <span class="n">DirectiveError</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pkg</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_raise_reserved_name</span>

    <span class="c1"># Ensure we have a sequence of allowed variant values, or a</span>
    <span class="c1"># predicate for it.</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;TRUE&quot;</span><span class="p">,</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span>

    <span class="c1"># The object defining variant values might supply its own defaults for</span>
    <span class="c1"># all the other arguments. Ensure we have no conflicting definitions</span>
    <span class="c1"># in place.</span>
    <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;multi&quot;</span><span class="p">,</span> <span class="s2">&quot;validator&quot;</span><span class="p">):</span>
        <span class="c1"># TODO: we can consider treating &#39;default&#39; differently from other</span>
        <span class="c1"># TODO: attributes and let a packager decide whether to use the fluent</span>
        <span class="c1"># TODO: interface or the directive argument</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">argument</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">_raise_argument_error</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Remove specification of </span><span class="si">{0}</span><span class="s2"> argument: it is handled &quot;</span>
                    <span class="s2">&quot;by an attribute of the &#39;values&#39; argument&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">DirectiveError</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argument</span><span class="p">),</span> <span class="n">pkg</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">_raise_argument_error</span>

    <span class="c1"># Allow for the object defining the allowed values to supply its own</span>
    <span class="c1"># default value and group validator, say if it supports multiple values.</span>
    <span class="n">default</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;validator&quot;</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;multi&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">multi</span><span class="p">))</span>

    <span class="c1"># Here we sanitize against a default value being either None</span>
    <span class="c1"># or the empty string, as the former indicates that a default</span>
    <span class="c1"># was not set while the latter will make the variant unparsable</span>
    <span class="c1"># from the command line</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">default</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_raise_default_not_set</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;either a default was not explicitly set, &quot;</span> <span class="s2">&quot;or &#39;None&#39; was used&quot;</span>
            <span class="k">elif</span> <span class="n">default</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;the default cannot be an empty string&quot;</span>
            <span class="k">raise</span> <span class="n">DirectiveError</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pkg</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_raise_default_not_set</span>

    <span class="n">description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">description</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_execute_variant</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">IDENTIFIER_RE</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">directive</span> <span class="o">=</span> <span class="s2">&quot;variant&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid variant name in </span><span class="si">{0}</span><span class="s2">: &#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;</span>
            <span class="k">raise</span> <span class="n">DirectiveError</span><span class="p">(</span><span class="n">directive</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="c1"># variants are stored by condition then by name (so only the last variant of a</span>
        <span class="c1"># given name takes precedence *per condition*).</span>
        <span class="c1"># NOTE: variant defaults and values can conflict if when conditions overlap.</span>
        <span class="n">variants_by_name</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">variants_by_name</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">Variant</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
            <span class="n">multi</span><span class="o">=</span><span class="n">multi</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
            <span class="n">sticky</span><span class="o">=</span><span class="n">sticky</span><span class="p">,</span>
            <span class="n">precedence</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">num_variant_definitions</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_variant</span></div>



<div class="viewcode-block" id="resource">
<a class="viewcode-back" href="../../spack.html#spack.directives.resource">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">resource</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define an external resource to be fetched and staged when building the</span>
<span class="sd">    package. Based on the keywords present in the dictionary the appropriate</span>
<span class="sd">    FetchStrategy will be used for the resource. Resources are fetched and</span>
<span class="sd">    staged in their own folder inside spack stage area, and then moved into</span>
<span class="sd">    the stage area of the package that needs them.</span>

<span class="sd">    List of recognized keywords:</span>

<span class="sd">    * &#39;when&#39; : (optional) represents the condition upon which the resource is</span>
<span class="sd">      needed</span>
<span class="sd">    * &#39;destination&#39; : (optional) path where to move the resource. This path</span>
<span class="sd">      must be relative to the main package stage area.</span>
<span class="sd">    * &#39;placement&#39; : (optional) gives the possibility to fine tune how the</span>
<span class="sd">      resource is moved into the main package stage area.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_resource</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
        <span class="n">when</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;when&quot;</span><span class="p">)</span>
        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">destination</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">placement</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;placement&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Check if the path is relative</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The destination keyword of a resource directive &quot;</span> <span class="s2">&quot;can&#39;t be an absolute path.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">destination : &#39;</span><span class="si">{dest}</span><span class="se">\n</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="n">destination</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Check if the path falls within the main package stage area</span>
        <span class="n">test_path</span> <span class="o">=</span> <span class="s2">&quot;stage_folder_root&quot;</span>
        <span class="n">normalized_destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Normalized absolute path</span>

        <span class="k">if</span> <span class="n">test_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">normalized_destination</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The destination folder of a resource must fall &quot;</span>
                <span class="s2">&quot;within the main package stage directory.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">destination : &#39;</span><span class="si">{dest}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="n">destination</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">resources</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">fetcher</span> <span class="o">=</span> <span class="n">from_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Resource</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fetcher</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">placement</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_execute_resource</span></div>



<div class="viewcode-block" id="build_system">
<a class="viewcode-back" href="../../spack.html#spack.directives.build_system">[docs]</a>
<span class="k">def</span> <span class="nf">build_system</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">variant</span><span class="p">(</span>
        <span class="s2">&quot;build_system&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Build systems supported by the package&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="maintainers">
<a class="viewcode-back" href="../../spack.html#spack.directives.maintainers">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="n">dicts</span><span class="o">=</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">maintainers</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new maintainer directive, to specify maintainers in a declarative way.</span>

<span class="sd">    Args:</span>
<span class="sd">        names: GitHub username for the maintainer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_maintainer</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
        <span class="n">maintainers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;maintainers&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">maintainers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">pkg</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">maintainers</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_maintainer</span></div>



<span class="k">def</span> <span class="nf">_execute_license</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">license_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">when</span><span class="p">):</span>
    <span class="c1"># If when is not specified the license always holds</span>
    <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">other_when_spec</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">licenses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">when_spec</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">other_when_spec</span><span class="p">):</span>
            <span class="n">when_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">when_spec</span> <span class="o">!=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">when_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;when </span><span class="si">{</span><span class="n">when_spec</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">other_when_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">other_when_spec</span> <span class="o">!=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">other_when_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;when </span><span class="si">{</span><span class="n">other_when_spec</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is specified as being licensed as </span><span class="si">{</span><span class="n">license_identifier</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">when_message</span><span class="si">}</span><span class="s2">, but it is also specified as being licensed under &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">licenses</span><span class="p">[</span><span class="n">other_when_spec</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">other_when_message</span><span class="si">}</span><span class="s2">, which conflict.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">OverlappingLicenseError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="n">pkg</span><span class="o">.</span><span class="n">licenses</span><span class="p">[</span><span class="n">when_spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">license_identifier</span>


<div class="viewcode-block" id="license">
<a class="viewcode-back" href="../../spack.html#spack.directives.license">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;licenses&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">license</span><span class="p">(</span>
    <span class="n">license_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">checked_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new license directive, to specify the SPDX identifier the software is</span>
<span class="sd">    distributed under.</span>

<span class="sd">    Args:</span>
<span class="sd">        license_identifiers: SPDX identifier specifying the license(s) the software</span>
<span class="sd">            is distributed under.</span>
<span class="sd">        checked_by: string or list of strings indicating which github user checked the</span>
<span class="sd">            license (if any).</span>
<span class="sd">        when: A spec specifying when the license applies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="k">lambda</span> <span class="n">pkg</span><span class="p">:</span> <span class="n">_execute_license</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">license_identifier</span><span class="p">,</span> <span class="n">when</span><span class="p">)</span></div>



<div class="viewcode-block" id="requires">
<a class="viewcode-back" href="../../spack.html#spack.directives.requires">[docs]</a>
<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;requirements&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="o">*</span><span class="n">requirement_specs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="s2">&quot;one_of&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allows a package to request a configuration to be present in all valid solutions.</span>

<span class="sd">    For instance, a package that is known to compile only with GCC can declare:</span>

<span class="sd">        requires(&quot;%gcc&quot;)</span>

<span class="sd">    A package that requires Apple-Clang on Darwin can declare instead:</span>

<span class="sd">        requires(&quot;%apple-clang&quot;, when=&quot;platform=darwin&quot;, msg=&quot;Apple Clang is required on Darwin&quot;)</span>

<span class="sd">    Args:</span>
<span class="sd">        requirement_specs: spec expressing the requirement</span>
<span class="sd">        when: optional constraint that triggers the requirement. If None the requirement</span>
<span class="sd">            is applied unconditionally.</span>

<span class="sd">        msg: optional user defined message</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_requires</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">policy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;one_of&quot;</span><span class="p">,</span> <span class="s2">&quot;any_of&quot;</span><span class="p">):</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;the &#39;policy&#39; argument of the &#39;requires&#39; directive in </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is set &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;to a wrong value (only &#39;one_of&#39; or &#39;any_of&#39; are allowed)&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">DirectiveError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Save in a list the requirements and the associated custom messages</span>
        <span class="n">requirement_list</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">msg_with_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">msg</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">requirement_specs</span><span class="p">)</span>
        <span class="n">requirement_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">requirements</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">msg_with_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_execute_requires</span></div>



<span class="nd">@directive</span><span class="p">(</span><span class="s2">&quot;languages&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_language</span><span class="p">(</span><span class="n">lang_spec_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Temporary implementation of language virtuals, until compilers are proper dependencies.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_execute_languages</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">):</span>
        <span class="n">when_spec</span> <span class="o">=</span> <span class="n">_make_when_spec</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">when_spec</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">languages</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">when_spec</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="n">languages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lang_spec_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_execute_languages</span>


<span class="k">class</span> <span class="nc">DependencyError</span><span class="p">(</span><span class="n">DirectiveError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is raised when a dependency specification is invalid.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">CircularReferenceError</span><span class="p">(</span><span class="n">DependencyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is raised when something depends on itself.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DependencyPatchError</span><span class="p">(</span><span class="n">DirectiveError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised for errors with patching dependencies.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">UnsupportedPackageDirective</span><span class="p">(</span><span class="n">DirectiveError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an invalid or unsupported package directive is specified.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">OverlappingLicenseError</span><span class="p">(</span><span class="n">DirectiveError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when two licenses are declared that apply on overlapping specs.&quot;&quot;&quot;</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>