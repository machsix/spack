

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.url &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.url</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.url</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module has methods for parsing names and versions of packages from URLs.</span>
<span class="sd">The idea is to allow package creators to supply nothing more than the</span>
<span class="sd">download location of the package, and figure out version and name information</span>
<span class="sd">from there.</span>

<span class="sd">**Example:** when spack is given the following URL:</span>

<span class="sd">    https://www.hdfgroup.org/ftp/HDF/releases/HDF4.2.12/src/hdf-4.2.12.tar.gz</span>

<span class="sd">It can figure out that the package name is ``hdf``, and that it is at version</span>
<span class="sd">``4.2.12``. This is useful for making the creation of packages simple: a user</span>
<span class="sd">just supplies a URL and skeleton code is generated automatically.</span>

<span class="sd">Spack can also figure out that it can most likely download 4.2.6 at this URL:</span>

<span class="sd">    https://www.hdfgroup.org/ftp/HDF/releases/HDF4.2.6/src/hdf-4.2.6.tar.gz</span>

<span class="sd">This is useful if a user asks for a package at a particular version number;</span>
<span class="sd">spack doesn&#39;t need anyone to tell it where to get the tarball even though</span>
<span class="sd">it&#39;s never been told about that version before.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">llnl.url</span>
<span class="kn">from</span> <span class="nn">llnl.path</span> <span class="kn">import</span> <span class="n">convert_to_posix_path</span>
<span class="kn">from</span> <span class="nn">llnl.util.tty.color</span> <span class="kn">import</span> <span class="n">cescape</span><span class="p">,</span> <span class="n">colorize</span>

<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.util.web</span>
<span class="kn">import</span> <span class="nn">spack.version</span>

<span class="c1">#</span>
<span class="c1"># Note: We call the input to most of these functions a &quot;path&quot; but the functions</span>
<span class="c1"># work on paths and URLs.  There&#39;s not a good word for both of these, but</span>
<span class="c1"># &quot;path&quot; seemed like the most generic term.</span>
<span class="c1">#</span>


<div class="viewcode-block" id="strip_name_suffixes">
<a class="viewcode-back" href="../../spack.html#spack.url.strip_name_suffixes">[docs]</a>
<span class="k">def</span> <span class="nf">strip_name_suffixes</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Most tarballs contain a package name followed by a version number.</span>
<span class="sd">    However, some also contain extraneous information in-between the name</span>
<span class="sd">    and version:</span>

<span class="sd">    * ``rgb-1.0.6``</span>
<span class="sd">    * ``converge_install_2.3.16``</span>
<span class="sd">    * ``jpegsrc.v9b``</span>

<span class="sd">    These strings are not part of the package name and should be ignored.</span>
<span class="sd">    This function strips the version number and any extraneous suffixes</span>
<span class="sd">    off and returns the remaining string. The goal is that the name is</span>
<span class="sd">    always the last thing in ``path``:</span>

<span class="sd">    * ``rgb``</span>
<span class="sd">    * ``converge``</span>
<span class="sd">    * ``jpeg``</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The filename or URL for the package</span>
<span class="sd">        version (str): The version detected for this URL</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The ``path`` with any extraneous suffixes removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: This could be done with complicated regexes in parse_name_offset</span>
    <span class="c1"># NOTE: The problem is that we would have to add these regexes to every</span>
    <span class="c1"># NOTE: single name regex. Easier to just strip them off permanently</span>

    <span class="n">suffix_regexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Strip off the version and anything after it</span>
        <span class="c1"># name-ver</span>
        <span class="c1"># name_ver</span>
        <span class="c1"># name.ver</span>
        <span class="sa">r</span><span class="s2">&quot;[._-][rvV]?&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">,</span>
        <span class="c1"># namever</span>
        <span class="sa">r</span><span class="s2">&quot;V?&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">,</span>
        <span class="c1"># Download type</span>
        <span class="sa">r</span><span class="s2">&quot;install&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;[Ss]rc&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;(open)?[Ss]ources?&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;[._-]open&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;[._-]archive&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;[._-]std&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;[._-]bin&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;Software&quot;</span><span class="p">,</span>
        <span class="c1"># Download version</span>
        <span class="sa">r</span><span class="s2">&quot;release&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;snapshot&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;distrib&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;everywhere&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;latest&quot;</span><span class="p">,</span>
        <span class="c1"># Arch</span>
        <span class="sa">r</span><span class="s2">&quot;Linux(64)?&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;x86_64&quot;</span><span class="p">,</span>
        <span class="c1"># VCS</span>
        <span class="sa">r</span><span class="s2">&quot;0\+bzr&quot;</span><span class="p">,</span>
        <span class="c1"># License</span>
        <span class="sa">r</span><span class="s2">&quot;gpl&quot;</span><span class="p">,</span>
        <span class="c1"># Needs to come before and after gpl, appears in both orders</span>
        <span class="sa">r</span><span class="s2">&quot;[._-]x11&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;gpl&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">regex</span> <span class="ow">in</span> <span class="n">suffix_regexes</span><span class="p">:</span>
        <span class="c1"># Remove the suffix from the end of the path</span>
        <span class="c1"># This may be done multiple times</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[._-]?&quot;</span> <span class="o">+</span> <span class="n">regex</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span></div>



<div class="viewcode-block" id="parse_version_offset">
<a class="viewcode-back" href="../../spack.html#spack.url.parse_version_offset">[docs]</a>
<span class="k">def</span> <span class="nf">parse_version_offset</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try to extract a version string from a filename or URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The filename or URL for the package</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            version of the package,</span>
<span class="sd">            first index of version,</span>
<span class="sd">            length of version string,</span>
<span class="sd">            the index of the matching regex,</span>
<span class="sd">            the matching regex</span>

<span class="sd">    Raises:</span>
<span class="sd">        UndetectableVersionError: If the URL does not match any regexes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="c1"># path:   The prefix of the URL, everything before the ext and suffix</span>
    <span class="c1"># ext:    The file extension</span>
    <span class="c1"># suffix: Any kind of query string that begins with a &#39;?&#39;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">llnl</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split_url_extension</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># stem:   Everything from path after the final &#39;/&#39;</span>
    <span class="n">original_stem</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Try to strip off anything after the version number</span>
    <span class="n">stem</span> <span class="o">=</span> <span class="n">llnl</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">strip_version_suffixes</span><span class="p">(</span><span class="n">original_stem</span><span class="p">)</span>

    <span class="c1"># Assumptions:</span>
    <span class="c1">#</span>
    <span class="c1"># 1. version always comes after the name</span>
    <span class="c1"># 2. separators include &#39;-&#39;, &#39;_&#39;, and &#39;.&#39;</span>
    <span class="c1"># 3. names can contain A-Z, a-z, 0-9, &#39;+&#39;, separators</span>
    <span class="c1"># 4. versions can contain A-Z, a-z, 0-9, separators</span>
    <span class="c1"># 5. versions always start with a digit</span>
    <span class="c1"># 6. versions are often prefixed by a &#39;v&#39; or &#39;r&#39; character</span>
    <span class="c1"># 7. separators are most reliable to determine name/version boundaries</span>

    <span class="c1"># List of the following format:</span>
    <span class="c1">#</span>
    <span class="c1"># [</span>
    <span class="c1">#     (regex, string),</span>
    <span class="c1">#     ...</span>
    <span class="c1"># ]</span>
    <span class="c1">#</span>
    <span class="c1"># The first regex that matches string will be used to determine</span>
    <span class="c1"># the version of the package. Thefore, hyperspecific regexes should</span>
    <span class="c1"># come first while generic, catch-all regexes should come last.</span>
    <span class="c1"># With that said, regular expressions are slow, so if possible, put</span>
    <span class="c1"># ones that only catch one or two URLs at the bottom.</span>
    <span class="n">version_regexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># 1st Pass: Simplest case</span>
        <span class="c1"># Assume name contains no digits and version contains no letters</span>
        <span class="c1"># e.g. libpng-1.6.27</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z+._-]+[._-]v?(\d[\d._-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 2nd Pass: Version only</span>
        <span class="c1"># Assume version contains no letters</span>
        <span class="c1"># ver</span>
        <span class="c1"># e.g. 3.2.7, 7.0.2-7, v3.3.0, v1_6_3</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^v?(\d[\d._-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 3rd Pass: No separator characters are used</span>
        <span class="c1"># Assume name contains no digits</span>
        <span class="c1"># namever</span>
        <span class="c1"># e.g. turbolinux702, nauty26r7</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z+]*(\d[\da-zA-Z]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 4th Pass: A single separator character is used</span>
        <span class="c1"># Assume name contains no digits</span>
        <span class="c1"># name-name-ver-ver</span>
        <span class="c1"># e.g. panda-2016-03-07, gts-snapshot-121130, cdd-061a</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z+-]*(\d[\da-zA-Z-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name_name_ver_ver</span>
        <span class="c1"># e.g. tinyxml_2_6_2, boost_1_55_0, tbb2017_20161128</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z+_]*(\d[\da-zA-Z_]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name.name.ver.ver</span>
        <span class="c1"># e.g. prank.source.150803, jpegsrc.v9b, atlas3.11.34, geant4.10.01.p03</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z+.]*(\d[\da-zA-Z.]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 5th Pass: Two separator characters are used</span>
        <span class="c1"># Name may contain digits, version may contain letters</span>
        <span class="c1"># name-name-ver.ver</span>
        <span class="c1"># e.g. m4-1.4.17, gmp-6.0.0a, launchmon-v1.0.2</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+-]+-v?(\d[\da-zA-Z.]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name-name-ver_ver</span>
        <span class="c1"># e.g. icu4c-57_1</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+-]+-v?(\d[\da-zA-Z_]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name_name_ver.ver</span>
        <span class="c1"># e.g. superlu_dist_4.1, pexsi_v0.9.0</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+_]+_v?(\d[\da-zA-Z.]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name_name.ver.ver</span>
        <span class="c1"># e.g. fer_source.v696</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+_]+\.v?(\d[\da-zA-Z.]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name_ver-ver</span>
        <span class="c1"># e.g. Bridger_r2014-12-01</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+]+_r?(\d[\da-zA-Z-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name-name-ver.ver-ver.ver</span>
        <span class="c1"># e.g. sowing-1.1.23-p1, bib2xhtml-v3.0-15-gf506, 4.6.3-alpha04</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:[a-zA-Z\d+-]+-)?v?(\d[\da-zA-Z.-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># namever.ver-ver.ver</span>
        <span class="c1"># e.g. go1.4-bootstrap-20161024</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z+]+v?(\d[\da-zA-Z.-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 6th Pass: All three separator characters are used</span>
        <span class="c1"># Name may contain digits, version may contain letters</span>
        <span class="c1"># name_name-ver.ver</span>
        <span class="c1"># e.g. the_silver_searcher-0.32.0, sphinx_rtd_theme-0.1.10a0</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+_]+-v?(\d[\da-zA-Z.]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name.name_ver.ver-ver.ver</span>
        <span class="c1"># e.g. TH.data_1.0-8, XML_3.98-1.4</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+.]+_v?(\d[\da-zA-Z.-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name-name-ver.ver_ver.ver</span>
        <span class="c1"># e.g. pypar-2.1.5_108</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+-]+-v?(\d[\da-zA-Z._]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name.name_name-ver.ver</span>
        <span class="c1"># e.g. tap.py-1.6, backports.ssl_match_hostname-3.5.0.1</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+._]+-v?(\d[\da-zA-Z.]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name-namever.ver_ver.ver</span>
        <span class="c1"># e.g. STAR-CCM+11.06.010_02</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z+-]+(\d[\da-zA-Z._]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># name-name_name-ver.ver</span>
        <span class="c1"># e.g. PerlIO-utf8_strict-0.002</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z\d+_-]+-v?(\d[\da-zA-Z.]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 7th Pass: Specific VCS</span>
        <span class="c1"># bazaar</span>
        <span class="c1"># e.g. libvterm-0+bzr681</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;bzr(\d[\da-zA-Z._-]*)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 8th Pass: Query strings</span>
        <span class="c1"># e.g. https://gitlab.cosma.dur.ac.uk/api/v4/projects/swift%2Fswiftsim/repository/archive.tar.gz?sha=v0.3.0</span>
        <span class="c1"># e.g. https://gitlab.kitware.com/api/v4/projects/icet%2Ficet/repository/archive.tar.bz2?sha=IceT-2.1.1</span>
        <span class="c1"># e.g. http://gitlab.cosma.dur.ac.uk/swift/swiftsim/repository/archive.tar.gz?ref=v0.3.0</span>
        <span class="c1"># e.g. http://apps.fz-juelich.de/jsc/sionlib/download.php?version=1.7.1</span>
        <span class="c1"># e.g. https://software.broadinstitute.org/gatk/download/auth?package=GATK-archive&amp;version=3.8-1-0-gf15c1c3ef</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[?&amp;](?:sha|ref|version)=[a-zA-Z\d+-]*[_-]?v?(\d[\da-zA-Z._-]*)$&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="p">),</span>
        <span class="c1"># e.g. http://slepc.upv.es/download/download.php?filename=slepc-3.6.2.tar.gz</span>
        <span class="c1"># e.g. http://laws-green.lanl.gov/projects/data/eos/get_file.php?package=eospac&amp;filename=eospac_v6.4.0beta.1_r20171213193219.tgz</span>
        <span class="c1"># e.g. https://evtgen.hepforge.org/downloads?f=EvtGen-01.07.00.tar.gz</span>
        <span class="c1"># e.g. http://wwwpub.zih.tu-dresden.de/%7Emlieber/dcount/dcount.php?package=otf&amp;get=OTF-1.12.5salmon.tar.gz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[?&amp;](?:filename|f|get)=[a-zA-Z\d+-]+[_-]v?(\d[\da-zA-Z.]*)&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># 9th Pass: Version in path</span>
        <span class="c1"># github.com/repo/name/releases/download/vver/name</span>
        <span class="c1"># e.g. https://github.com/nextflow-io/nextflow/releases/download/v0.20.1/nextflow</span>
        <span class="c1"># e.g. https://gitlab.com/hpctoolkit/hpcviewer/-/releases/2024.02/downloads/hpcviewer.tgz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;github\.com/[^/]+/[^/]+/releases/download/[a-zA-Z+._-]*v?(\d[\da-zA-Z._-]*)/&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gitlab\.com/[^/]+/.+/-/releases/[a-zA-Z+._-]*v?(\d[\da-zA-Z._-]*)/downloads/&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="c1"># e.g. ftp://ftp.ncbi.nlm.nih.gov/blast/executables/legacy.NOTSUPPORTED/2.2.26/ncbi.tar.gz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d[\da-zA-Z._-]*)/[^/]+$&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">version_regex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">version_regexes</span><span class="p">):</span>
        <span class="n">regex</span><span class="p">,</span> <span class="n">match_string</span> <span class="o">=</span> <span class="n">version_regex</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">match_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># If we matched from the stem or suffix, we need to add offset</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">match_string</span> <span class="ow">is</span> <span class="n">stem</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_stem</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">match_string</span> <span class="ow">is</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># .tar.gz is converted to tar.gz</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">offset</span>

            <span class="k">return</span> <span class="n">version</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">regex</span>

    <span class="k">raise</span> <span class="n">UndetectableVersionError</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_version">
<a class="viewcode-back" href="../../spack.html#spack.url.parse_version">[docs]</a>
<span class="k">def</span> <span class="nf">parse_version</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">StandardVersion</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try to extract a version string from a filename or URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: The filename or URL for the package</span>

<span class="sd">    Returns: The version of the package</span>

<span class="sd">    Raises:</span>
<span class="sd">        UndetectableVersionError: If the URL does not match any regexes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">version</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regex</span> <span class="o">=</span> <span class="n">parse_version_offset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">StandardVersion</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">version</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_name_offset">
<a class="viewcode-back" href="../../spack.html#spack.url.parse_name_offset">[docs]</a>
<span class="k">def</span> <span class="nf">parse_name_offset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try to determine the name of a package from its filename or URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The filename or URL for the package</span>
<span class="sd">        v (str): The version of the package</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            name of the package,</span>
<span class="sd">            first index of name,</span>
<span class="sd">            length of name,</span>
<span class="sd">            the index of the matching regex,</span>
<span class="sd">            the matching regex</span>

<span class="sd">    Raises:</span>
<span class="sd">        UndetectableNameError: If the URL does not match any regexes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="c1"># We really need to know the version of the package</span>
    <span class="c1"># This helps us prevent collisions between the name and version</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UndetectableVersionError</span><span class="p">:</span>
            <span class="c1"># Not all URLs contain a version. We still want to be able</span>
            <span class="c1"># to determine a name if possible.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="c1"># path:   The prefix of the URL, everything before the ext and suffix</span>
    <span class="c1"># ext:    The file extension</span>
    <span class="c1"># suffix: Any kind of query string that begins with a &#39;?&#39;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">llnl</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split_url_extension</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># stem:   Everything from path after the final &#39;/&#39;</span>
    <span class="n">original_stem</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Try to strip off anything after the package name</span>
    <span class="n">stem</span> <span class="o">=</span> <span class="n">strip_name_suffixes</span><span class="p">(</span><span class="n">original_stem</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="c1"># List of the following format:</span>
    <span class="c1">#</span>
    <span class="c1"># [</span>
    <span class="c1">#     (regex, string),</span>
    <span class="c1">#     ...</span>
    <span class="c1"># ]</span>
    <span class="c1">#</span>
    <span class="c1"># The first regex that matches string will be used to determine</span>
    <span class="c1"># the name of the package. Thefore, hyperspecific regexes should</span>
    <span class="c1"># come first while generic, catch-all regexes should come last.</span>
    <span class="c1"># With that said, regular expressions are slow, so if possible, put</span>
    <span class="c1"># ones that only catch one or two URLs at the bottom.</span>
    <span class="n">name_regexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># 1st Pass: Common repositories</span>
        <span class="c1"># GitHub: github.com/repo/name/</span>
        <span class="c1"># e.g. https://github.com/nco/nco/archive/4.6.2.tar.gz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;github\.com/[^/]+/([^/]+)&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="c1"># GitLab API endpoint: gitlab.*/api/v4/projects/NAMESPACE%2Fname/</span>
        <span class="c1"># e.g. https://gitlab.cosma.dur.ac.uk/api/v4/projects/swift%2Fswiftsim/repository/archive.tar.gz?sha=v0.3.0</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gitlab[^/]+/api/v4/projects/[^/]+</span><span class="si">%2F</span><span class="s2">([^/]+)&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="c1"># GitLab non-API endpoint: gitlab.*/repo/name/</span>
        <span class="c1"># e.g. http://gitlab.cosma.dur.ac.uk/swift/swiftsim/repository/archive.tar.gz?ref=v0.3.0</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gitlab[^/]+/(?!api/v4/projects)[^/]+/([^/]+)&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="c1"># Bitbucket: bitbucket.org/repo/name/</span>
        <span class="c1"># e.g. https://bitbucket.org/glotzer/hoomd-blue/get/v1.3.3.tar.bz2</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;bitbucket\.org/[^/]+/([^/]+)&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="c1"># PyPI: pypi.(python.org|io)/packages/source/first-letter/name/</span>
        <span class="c1"># e.g. https://pypi.python.org/packages/source/m/mpmath/mpmath-all-0.19.tar.gz</span>
        <span class="c1"># e.g. https://pypi.io/packages/source/b/backports.ssl_match_hostname/backports.ssl_match_hostname-3.5.0.1.tar.gz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;pypi\.(?:python\.org|io)/packages/source/[A-Za-z\d]/([^/]+)&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="c1"># 2nd Pass: Query strings</span>
        <span class="c1"># ?filename=name-ver.ver</span>
        <span class="c1"># e.g. http://slepc.upv.es/download/download.php?filename=slepc-3.6.2.tar.gz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\?filename=([A-Za-z\d+-]+)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># ?f=name-ver.ver</span>
        <span class="c1"># e.g. https://evtgen.hepforge.org/downloads?f=EvtGen-01.07.00.tar.gz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\?f=([A-Za-z\d+-]+)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># ?package=name</span>
        <span class="c1"># e.g. http://wwwpub.zih.tu-dresden.de/%7Emlieber/dcount/dcount.php?package=otf&amp;get=OTF-1.12.5salmon.tar.gz</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\?package=([A-Za-z\d+-]+)&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
        <span class="c1"># ?package=name-version</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\?package=([A-Za-z\d]+)&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="p">),</span>
        <span class="c1"># download.php</span>
        <span class="c1"># e.g. http://apps.fz-juelich.de/jsc/sionlib/download.php?version=1.7.1</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([^/]+)/download.php$&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="c1"># 3rd Pass: Name followed by version in archive</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([A-Za-z\d+\._-]+)$&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name_regex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">name_regexes</span><span class="p">):</span>
        <span class="n">regex</span><span class="p">,</span> <span class="n">match_string</span> <span class="o">=</span> <span class="n">name_regex</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">match_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># If we matched from the stem or suffix, we need to add offset</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">match_string</span> <span class="ow">is</span> <span class="n">stem</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_stem</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">match_string</span> <span class="ow">is</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># .tar.gz is converted to tar.gz</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">offset</span>

            <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">regex</span>

    <span class="k">raise</span> <span class="n">UndetectableNameError</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_name">
<a class="viewcode-back" href="../../spack.html#spack.url.parse_name">[docs]</a>
<span class="k">def</span> <span class="nf">parse_name</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try to determine the name of a package from its filename or URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The filename or URL for the package</span>
<span class="sd">        ver (str): The version of the package</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The name of the package</span>

<span class="sd">    Raises:</span>
<span class="sd">        UndetectableNameError: If the URL does not match any regexes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regex</span> <span class="o">=</span> <span class="n">parse_name_offset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span></div>



<div class="viewcode-block" id="parse_name_and_version">
<a class="viewcode-back" href="../../spack.html#spack.url.parse_name_and_version">[docs]</a>
<span class="k">def</span> <span class="nf">parse_name_and_version</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try to determine the name of a package and extract its version</span>
<span class="sd">    from its filename or URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The filename or URL for the package</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: a tuple containing the package (name, version)</span>

<span class="sd">    Raises:</span>
<span class="sd">        UndetectableVersionError: If the URL does not match any regexes</span>
<span class="sd">        UndetectableNameError: If the URL does not match any regexes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_all">
<a class="viewcode-back" href="../../spack.html#spack.url.find_all">[docs]</a>
<span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a list containing the indices of</span>
<span class="sd">    every occurrence of substring in string.&quot;&quot;&quot;</span>

    <span class="n">occurrences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">occurrences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">occurrences</span></div>



<div class="viewcode-block" id="substitution_offsets">
<a class="viewcode-back" href="../../spack.html#spack.url.substitution_offsets">[docs]</a>
<span class="k">def</span> <span class="nf">substitution_offsets</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This returns offsets for substituting versions and names in the</span>
<span class="sd">    provided path.  It is a helper for :func:`substitute_version`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get name and version offsets</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ver</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">vl</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">vregex</span> <span class="o">=</span> <span class="n">parse_version_offset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="n">nregex</span> <span class="o">=</span> <span class="n">parse_name_offset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UndetectableNameError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(),</span> <span class="n">ver</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">vl</span><span class="p">,</span> <span class="p">(</span><span class="n">vs</span><span class="p">,))</span>
    <span class="k">except</span> <span class="n">UndetectableVersionError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="n">nregex</span> <span class="o">=</span> <span class="n">parse_name_offset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="p">(</span><span class="n">ns</span><span class="p">,),</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">except</span> <span class="n">UndetectableNameError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">())</span>

    <span class="c1"># Find the index of every occurrence of name and ver in path</span>
    <span class="n">name_offsets</span> <span class="o">=</span> <span class="n">find_all</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">ver_offsets</span> <span class="o">=</span> <span class="n">find_all</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">name_offsets</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">vl</span><span class="p">,</span> <span class="n">ver_offsets</span><span class="p">)</span></div>



<div class="viewcode-block" id="wildcard_version">
<a class="viewcode-back" href="../../spack.html#spack.url.wildcard_version">[docs]</a>
<span class="k">def</span> <span class="nf">wildcard_version</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the version in the supplied path, and return a regular expression</span>
<span class="sd">    that will match this path with any version in its place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get version so we can replace it with a wildcard</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Split path by versions</span>
    <span class="n">vparts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>

    <span class="c1"># Replace each version with a generic capture group to find versions</span>
    <span class="c1"># and escape everything else so it&#39;s not interpreted as a regex</span>
    <span class="n">result</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(\d.*)&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span> <span class="k">for</span> <span class="n">vp</span> <span class="ow">in</span> <span class="n">vparts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="substitute_version">
<a class="viewcode-back" href="../../spack.html#spack.url.substitute_version">[docs]</a>
<span class="k">def</span> <span class="nf">substitute_version</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a URL or archive name, find the version in the path and</span>
<span class="sd">    substitute the new version for it.  Replace all occurrences of</span>
<span class="sd">    the version *if* they don&#39;t overlap with the package name.</span>

<span class="sd">    Simple example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       substitute_version(&#39;http://www.mr511.de/software/libelf-0.8.13.tar.gz&#39;, &#39;2.9.3&#39;)</span>
<span class="sd">       &gt;&gt;&gt; &#39;http://www.mr511.de/software/libelf-2.9.3.tar.gz&#39;</span>

<span class="sd">    Complex example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       substitute_version(&#39;https://www.hdfgroup.org/ftp/HDF/releases/HDF4.2.12/src/hdf-4.2.12.tar.gz&#39;, &#39;2.3&#39;)</span>
<span class="sd">       &gt;&gt;&gt; &#39;https://www.hdfgroup.org/ftp/HDF/releases/HDF2.3/src/hdf-2.3.tar.gz&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">noffs</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">vl</span><span class="p">,</span> <span class="n">voffs</span><span class="p">)</span> <span class="o">=</span> <span class="n">substitution_offsets</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">new_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="n">voffs</span><span class="p">:</span>
        <span class="n">new_path</span> <span class="o">+=</span> <span class="n">path</span><span class="p">[</span><span class="n">last</span><span class="p">:</span><span class="n">vo</span><span class="p">]</span>
        <span class="n">new_path</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_version</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">vo</span> <span class="o">+</span> <span class="n">vl</span>

    <span class="n">new_path</span> <span class="o">+=</span> <span class="n">path</span><span class="p">[</span><span class="n">last</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">new_path</span></div>



<div class="viewcode-block" id="color_url">
<a class="viewcode-back" href="../../spack.html#spack.url.color_url">[docs]</a>
<span class="k">def</span> <span class="nf">color_url</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Color the parts of the url according to Spack&#39;s parsing.</span>

<span class="sd">    Colors are:</span>
<span class="sd">       | Cyan: The version found by :func:`parse_version_offset`.</span>
<span class="sd">       | Red:  The name found by :func:`parse_name_offset`.</span>

<span class="sd">       | Green:   Instances of version string from :func:`substitute_version`.</span>
<span class="sd">       | Magenta: Instances of the name (protected from substitution).</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The filename or URL for the package</span>
<span class="sd">        errors (bool): Append parse errors at end of string.</span>
<span class="sd">        subs (bool): Color substitutions as well as parsed name/version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allow URLs containing @ and }</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">cescape</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">noffs</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">vl</span><span class="p">,</span> <span class="n">voffs</span><span class="p">)</span> <span class="o">=</span> <span class="n">substitution_offsets</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">nends</span> <span class="o">=</span> <span class="p">[</span><span class="n">no</span> <span class="o">+</span> <span class="n">nl</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">no</span> <span class="ow">in</span> <span class="n">noffs</span><span class="p">]</span>
    <span class="n">vends</span> <span class="o">=</span> <span class="p">[</span><span class="n">vo</span> <span class="o">+</span> <span class="n">vl</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="n">voffs</span><span class="p">]</span>

    <span class="n">nerr</span> <span class="o">=</span> <span class="n">verr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">vs</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;@c&quot;</span><span class="p">)</span>
            <span class="n">verr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ns</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;@r&quot;</span><span class="p">)</span>
            <span class="n">nerr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">subs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">voffs</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;@g&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">noffs</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;@m&quot;</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">vs</span> <span class="o">+</span> <span class="n">vl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;@.&quot;</span><span class="p">)</span>
            <span class="n">verr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ns</span> <span class="o">+</span> <span class="n">nl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;@.&quot;</span><span class="p">)</span>
            <span class="n">nerr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">subs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vends</span> <span class="ow">or</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nends</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;@.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nerr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; @r{[no name]}&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; @r{[no version]}&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nerr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; @r{[incomplete name]}&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; @r{[incomplete version]}&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">colorize</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span></div>



<div class="viewcode-block" id="find_versions_of_archive">
<a class="viewcode-back" href="../../spack.html#spack.url.find_versions_of_archive">[docs]</a>
<span class="k">def</span> <span class="nf">find_versions_of_archive</span><span class="p">(</span>
    <span class="n">archive_urls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">list_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">list_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">concurrency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">reference_package</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">StandardVersion</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scrape web pages for new versions of a tarball. This function prefers URLs in the</span>
<span class="sd">    following order: links found on the scraped page that match a url generated by the</span>
<span class="sd">    reference package, found and in the archive_urls list, found and derived from those</span>
<span class="sd">    in the archive_urls list, and if none are found for a version then the item in the</span>
<span class="sd">    archive_urls list is included for the version.</span>

<span class="sd">    Args:</span>
<span class="sd">        archive_urls: URL or sequence of URLs for different versions of a package. Typically these</span>
<span class="sd">            are just the tarballs from the package file itself. By default, this searches the</span>
<span class="sd">            parent directories of archives.</span>
<span class="sd">        list_url: URL for a listing of archives. Spack will scrape these pages for download links</span>
<span class="sd">            that look like the archive URL.</span>
<span class="sd">        list_depth: max depth to follow links on list_url pages. Defaults to 0.</span>
<span class="sd">        concurrency: maximum number of concurrent requests</span>
<span class="sd">        reference_package: a spack package used as a reference for url detection. Uses the</span>
<span class="sd">            url_for_version method on the package to produce reference urls which, if found, are</span>
<span class="sd">            preferred.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive_urls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">archive_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">archive_urls</span><span class="p">]</span>

    <span class="c1"># Generate a list of list_urls based on archive urls and any</span>
    <span class="c1"># explicitly listed list_url in the package</span>
    <span class="n">list_urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">list_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">list_url</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aurl</span> <span class="ow">in</span> <span class="n">archive_urls</span><span class="p">:</span>
        <span class="n">list_urls</span> <span class="o">|=</span> <span class="n">llnl</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">find_list_urls</span><span class="p">(</span><span class="n">aurl</span><span class="p">)</span>

    <span class="c1"># Add &#39;/&#39; to the end of the URL. Some web servers require this.</span>
    <span class="n">additional_list_urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">lurl</span> <span class="ow">in</span> <span class="n">list_urls</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lurl</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">additional_list_urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lurl</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">list_urls</span> <span class="o">|=</span> <span class="n">additional_list_urls</span>

    <span class="c1"># Grab some web pages to scrape.</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">links</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">spider</span><span class="p">(</span><span class="n">list_urls</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">list_depth</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="n">concurrency</span><span class="p">)</span>

    <span class="c1"># Scrape them for archive URLs</span>
    <span class="n">regexes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aurl</span> <span class="ow">in</span> <span class="n">archive_urls</span><span class="p">:</span>
        <span class="c1"># This creates a regex from the URL with a capture group for</span>
        <span class="c1"># the version part of the URL.  The capture group is converted</span>
        <span class="c1"># to a generic wildcard, so we can use this to extract things</span>
        <span class="c1"># on a page that look like archive URLs.</span>
        <span class="n">url_regex</span> <span class="o">=</span> <span class="n">wildcard_version</span><span class="p">(</span><span class="n">aurl</span><span class="p">)</span>

        <span class="c1"># We&#39;ll be a bit more liberal and just look for the archive</span>
        <span class="c1"># part, not the full path.</span>
        <span class="c1"># this is a URL so it is a posixpath even on Windows</span>
        <span class="n">url_regex</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">url_regex</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># We need to add a / to the beginning of the regex to prevent</span>
        <span class="c1"># Spack from picking up similarly named packages like:</span>
        <span class="c1">#   https://cran.r-project.org/src/contrib/pls_2.6-0.tar.gz</span>
        <span class="c1">#   https://cran.r-project.org/src/contrib/enpls_5.7.tar.gz</span>
        <span class="c1">#   https://cran.r-project.org/src/contrib/autopls_1.3.tar.gz</span>
        <span class="c1">#   https://cran.r-project.org/src/contrib/matrixpls_1.0.4.tar.gz</span>
        <span class="n">url_regex</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">url_regex</span>

        <span class="c1"># We need to add a $ anchor to the end of the regex to prevent</span>
        <span class="c1"># Spack from picking up signature files like:</span>
        <span class="c1">#   .asc</span>
        <span class="c1">#   .md5</span>
        <span class="c1">#   .sha256</span>
        <span class="c1">#   .sig</span>
        <span class="c1"># However, SourceForge downloads still need to end in &#39;/download&#39;.</span>
        <span class="n">url_regex</span> <span class="o">+=</span> <span class="sa">r</span><span class="s2">&quot;(\/download)?&quot;</span>
        <span class="c1"># PyPI adds #sha256=... to the end of the URL</span>
        <span class="n">url_regex</span> <span class="o">+=</span> <span class="s2">&quot;(#sha256=.*)?&quot;</span>
        <span class="n">url_regex</span> <span class="o">+=</span> <span class="s2">&quot;$&quot;</span>

        <span class="n">regexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url_regex</span><span class="p">)</span>

    <span class="n">regexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regexes</span><span class="p">]</span>
    <span class="c1"># Build a dict version -&gt; URL from any links that match the wildcards.</span>
    <span class="c1"># Walk through archive_url links first.</span>
    <span class="c1"># Any conflicting versions will be overwritten by the list_url links.</span>
    <span class="n">versions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">StandardVersion</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">convert_to_posix_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regexes</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ver</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">versions</span><span class="p">[</span><span class="n">ver</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
                <span class="c1"># prevent this version from getting overwritten</span>
                <span class="k">if</span> <span class="n">reference_package</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">url</span> <span class="o">==</span> <span class="n">reference_package</span><span class="o">.</span><span class="n">url_for_version</span><span class="p">(</span><span class="n">ver</span><span class="p">):</span>
                        <span class="n">matched</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extrapolated_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">substitute_version</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">archive_urls</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">extrapolated_urls</span><span class="p">:</span>
                        <span class="n">matched</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UndetectableVersionError</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">archive_urls</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">convert_to_posix_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
            <span class="n">versions</span><span class="p">[</span><span class="n">ver</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>

    <span class="k">return</span> <span class="n">versions</span></div>



<div class="viewcode-block" id="UrlParseError">
<a class="viewcode-back" href="../../spack.html#spack.url.UrlParseError">[docs]</a>
<span class="k">class</span> <span class="nc">UrlParseError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the URL module can&#39;t parse something correctly.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span></div>



<div class="viewcode-block" id="UndetectableVersionError">
<a class="viewcode-back" href="../../spack.html#spack.url.UndetectableVersionError">[docs]</a>
<span class="k">class</span> <span class="nc">UndetectableVersionError</span><span class="p">(</span><span class="n">UrlParseError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when we can&#39;t parse a version from a string.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t detect version in: &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>



<div class="viewcode-block" id="UndetectableNameError">
<a class="viewcode-back" href="../../spack.html#spack.url.UndetectableNameError">[docs]</a>
<span class="k">class</span> <span class="nc">UndetectableNameError</span><span class="p">(</span><span class="n">UrlParseError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when we can&#39;t parse a package name from a string.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t parse package name in: &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>