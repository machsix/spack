

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.installer &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.installer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.installer</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="sd">&quot;&quot;&quot;This module encapsulates package installation functionality.</span>

<span class="sd">The PackageInstaller coordinates concurrent builds of packages for the same</span>
<span class="sd">Spack instance by leveraging the dependency DAG and file system locks.  It</span>
<span class="sd">also proceeds with the installation of non-dependent packages of failed</span>
<span class="sd">dependencies in order to install as many dependencies of a package as possible.</span>

<span class="sd">Bottom-up traversal of the dependency DAG while prioritizing packages with no</span>
<span class="sd">uninstalled dependencies allows multiple processes to perform concurrent builds</span>
<span class="sd">of separate packages associated with a spec.</span>

<span class="sd">File system locks enable coordination such that no two processes attempt to</span>
<span class="sd">build the same or a failed dependency package.</span>

<span class="sd">If a dependency package fails to install, its dependents&#39; tasks will be</span>
<span class="sd">removed from the installing process&#39;s queue.  A failure file is also written</span>
<span class="sd">and locked. Other processes use this file to detect the failure and dequeue</span>
<span class="sd">its dependents.</span>

<span class="sd">This module supports the coordination of local and distributed concurrent</span>
<span class="sd">installations of packages in a Spack instance.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">gzip</span> <span class="kn">import</span> <span class="n">GzipFile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">llnl.util.filesystem</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">import</span> <span class="nn">llnl.util.lock</span> <span class="k">as</span> <span class="nn">lk</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>
<span class="kn">from</span> <span class="nn">llnl.string</span> <span class="kn">import</span> <span class="n">ordinal</span>
<span class="kn">from</span> <span class="nn">llnl.util.lang</span> <span class="kn">import</span> <span class="n">pretty_seconds</span>
<span class="kn">from</span> <span class="nn">llnl.util.tty.color</span> <span class="kn">import</span> <span class="n">colorize</span>
<span class="kn">from</span> <span class="nn">llnl.util.tty.log</span> <span class="kn">import</span> <span class="n">log_output</span>

<span class="kn">import</span> <span class="nn">spack.binary_distribution</span> <span class="k">as</span> <span class="nn">binary_distribution</span>
<span class="kn">import</span> <span class="nn">spack.build_environment</span>
<span class="kn">import</span> <span class="nn">spack.config</span>
<span class="kn">import</span> <span class="nn">spack.database</span>
<span class="kn">import</span> <span class="nn">spack.deptypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.hooks</span>
<span class="kn">import</span> <span class="nn">spack.mirror</span>
<span class="kn">import</span> <span class="nn">spack.package_base</span>
<span class="kn">import</span> <span class="nn">spack.package_prefs</span> <span class="k">as</span> <span class="nn">prefs</span>
<span class="kn">import</span> <span class="nn">spack.repo</span>
<span class="kn">import</span> <span class="nn">spack.rewiring</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.store</span>
<span class="kn">import</span> <span class="nn">spack.util.executable</span>
<span class="kn">import</span> <span class="nn">spack.util.path</span>
<span class="kn">import</span> <span class="nn">spack.util.timer</span> <span class="k">as</span> <span class="nn">timer</span>
<span class="kn">from</span> <span class="nn">spack.util.environment</span> <span class="kn">import</span> <span class="n">EnvironmentModifications</span><span class="p">,</span> <span class="n">dump_environment</span>
<span class="kn">from</span> <span class="nn">spack.util.executable</span> <span class="kn">import</span> <span class="n">which</span>

<span class="c1">#: Counter to support unique spec sequencing that is used to ensure packages</span>
<span class="c1">#: with the same priority are (initially) processed in the order in which they</span>
<span class="c1">#: were added (see https://docs.python.org/2/library/heapq.html).</span>
<span class="n">_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<div class="viewcode-block" id="BuildStatus">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildStatus">[docs]</a>
<span class="k">class</span> <span class="nc">BuildStatus</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Different build (task) states.&quot;&quot;&quot;</span>

    <span class="c1">#: Build status indicating task has been added/queued.</span>
    <span class="n">QUEUED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: Build status indicating the spec failed to install</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: Build status indicating the spec is being installed (possibly by another</span>
    <span class="c1">#: process)</span>
    <span class="n">INSTALLING</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: Build status indicating the spec was sucessfully installed</span>
    <span class="n">INSTALLED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: Build status indicating the task has been popped from the queue</span>
    <span class="n">DEQUEUED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: Build status indicating task has been removed (to maintain priority</span>
    <span class="c1">#: queue invariants).</span>
    <span class="n">REMOVED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>



<span class="k">def</span> <span class="nf">_write_timer_json</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
    <span class="n">extra_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">:</span> <span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">times_log_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">timelog</span><span class="p">:</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">timelog</span><span class="p">,</span> <span class="n">extra_attributes</span><span class="o">=</span><span class="n">extra_attributes</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span>


<div class="viewcode-block" id="ExecuteResult">
<a class="viewcode-back" href="../../spack.html#spack.installer.ExecuteResult">[docs]</a>
<span class="k">class</span> <span class="nc">ExecuteResult</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="c1"># Task succeeded</span>
    <span class="n">SUCCESS</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># Task failed</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1"># Task is missing build spec and will be requeued</span>
    <span class="n">MISSING_BUILD_SPEC</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>



<div class="viewcode-block" id="InstallAction">
<a class="viewcode-back" href="../../spack.html#spack.installer.InstallAction">[docs]</a>
<span class="k">class</span> <span class="nc">InstallAction</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="c1">#: Don&#39;t perform an install</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1">#: Do a standard install</span>
    <span class="n">INSTALL</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="c1">#: Do an overwrite install</span>
    <span class="n">OVERWRITE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>



<div class="viewcode-block" id="InstallStatus">
<a class="viewcode-back" href="../../spack.html#spack.installer.InstallStatus">[docs]</a>
<span class="k">class</span> <span class="nc">InstallStatus</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Counters used for showing status information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">pkg_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_ids</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="InstallStatus.next_pkg">
<a class="viewcode-back" href="../../spack.html#spack.installer.InstallStatus.next_pkg">[docs]</a>
    <span class="k">def</span> <span class="nf">next_pkg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">):</span>
        <span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pkg_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pkg_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="InstallStatus.set_term_title">
<a class="viewcode-back" href="../../spack.html#spack.installer.InstallStatus.set_term_title">[docs]</a>
    <span class="k">def</span> <span class="nf">set_term_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:install_status&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_progress</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">]0;Spack: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="se">\x07</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="InstallStatus.get_progress">
<a class="viewcode-back" href="../../spack.html#spack.installer.InstallStatus.get_progress">[docs]</a>
    <span class="k">def</span> <span class="nf">get_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_num</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_count</span><span class="si">}</span><span class="s2">]&quot;</span></div>
</div>



<div class="viewcode-block" id="TermStatusLine">
<a class="viewcode-back" href="../../spack.html#spack.installer.TermStatusLine">[docs]</a>
<span class="k">class</span> <span class="nc">TermStatusLine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is used in distributed builds to inform the user that other packages are</span>
<span class="sd">    being installed by another process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_set</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="TermStatusLine.add">
<a class="viewcode-back" href="../../spack.html#spack.installer.TermStatusLine.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a package to the waiting list, and if it is new, update the status line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_set</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">colorize</span><span class="p">(</span><span class="s2">&quot;@*{Waiting for} @*g{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">pkg_id</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="TermStatusLine.clear">
<a class="viewcode-back" href="../../spack.html#spack.installer.TermStatusLine.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the status line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Move the cursor to the beginning of the first &quot;Waiting for&quot; message and clear</span>
        <span class="c1"># everything after it.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[</span><span class="si">{</span><span class="n">lines</span><span class="si">}</span><span class="s2">F</span><span class="se">\x1b</span><span class="s2">[J&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>
</div>



<span class="k">def</span> <span class="nf">_check_last_phase</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures the specified package has a valid last phase before proceeding</span>
<span class="sd">    with its installation.</span>

<span class="sd">    The last phase is also set to None if it is the last phase of the</span>
<span class="sd">    package already.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: the package being installed</span>

<span class="sd">    Raises:</span>
<span class="sd">        ``BadInstallPhase`` if stop_before or last phase is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phases</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">phases</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">stop_before_phase</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">stop_before_phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">raise</span> <span class="n">BadInstallPhase</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">stop_before_phase</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">last_phase</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">last_phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">raise</span> <span class="n">BadInstallPhase</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">last_phase</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="c1"># If we got a last_phase, make sure it&#39;s not already last</span>
    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">last_phase</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">last_phase</span> <span class="o">==</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="n">pkg</span><span class="o">.</span><span class="n">last_phase</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[attr-defined]</span>


<span class="k">def</span> <span class="nf">_handle_external_and_upstream</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if the package is external or upstream and register it in the</span>
<span class="sd">    database if it is external package.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: the package whose installation is under consideration</span>
<span class="sd">        explicit: the package was explicitly requested by the user</span>
<span class="sd">    Return:</span>
<span class="sd">        ``True`` if the package is not to be installed locally, otherwise ``False``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For external packages the workflow is simplified, and basically</span>
    <span class="c1"># consists in module file generation and registration in the DB.</span>
    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
        <span class="n">_process_external_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">explicit</span><span class="p">)</span>
        <span class="n">_print_installed_pkg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> (external </span><span class="si">{</span><span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">installed_upstream</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s2"> is installed in an upstream Spack instance at &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">_print_installed_pkg</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

        <span class="c1"># This will result in skipping all post-install hooks. In the case</span>
        <span class="c1"># of modules this is considered correct because we want to retrieve</span>
        <span class="c1"># the module from the upstream Spack instance.</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_do_fake_install</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a fake install directory with fake executables, headers, and libraries.&quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span>
    <span class="n">library</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># Avoid double &#39;lib&#39; for packages whose names already start with lib</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lib&quot;</span><span class="p">):</span>
        <span class="n">library</span> <span class="o">=</span> <span class="s2">&quot;lib&quot;</span> <span class="o">+</span> <span class="n">library</span>

    <span class="n">plat_shared</span> <span class="o">=</span> <span class="s2">&quot;.dll&quot;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span> <span class="k">else</span> <span class="s2">&quot;.so&quot;</span>
    <span class="n">plat_static</span> <span class="o">=</span> <span class="s2">&quot;.lib&quot;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span> <span class="k">else</span> <span class="s2">&quot;.a&quot;</span>
    <span class="n">dso_suffix</span> <span class="o">=</span> <span class="s2">&quot;.dylib&quot;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span> <span class="k">else</span> <span class="n">plat_shared</span>

    <span class="c1"># Install fake command</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="n">chmod</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;chmod&quot;</span><span class="p">)</span>
        <span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;+x&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>

    <span class="c1"># Install fake header file</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">,</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;.h&quot;</span><span class="p">))</span>

    <span class="c1"># Install fake shared and static libraries</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dso_suffix</span><span class="p">,</span> <span class="n">plat_static</span><span class="p">]:</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="n">library</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">))</span>

    <span class="c1"># Install fake man page</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">man</span><span class="o">.</span><span class="n">man1</span><span class="p">)</span>

    <span class="n">packages_dir</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">build_packages_path</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">dump_packages</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">packages_dir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_hms</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert seconds to hours, minutes, seconds</span>

<span class="sd">    Args:</span>
<span class="sd">        seconds: time to be converted in seconds</span>

<span class="sd">    Return: String representation of the time as #h #m #.##s</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">h&quot;</span> <span class="o">%</span> <span class="n">h</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">m&quot;</span> <span class="o">%</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_log_prefix</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prefix of the form &quot;[pid]: [pkg name]: ...&quot; when printing a status update during</span>
<span class="sd">    the build.&quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="k">if</span> <span class="n">tty</span><span class="o">.</span><span class="n">show_pid</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pid</span><span class="si">}{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">:&quot;</span>


<span class="k">def</span> <span class="nf">_print_installed_pkg</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Output a message with a package icon.</span>

<span class="sd">    Args:</span>
<span class="sd">        message (str): message to be output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tty</span><span class="o">.</span><span class="n">msg_enabled</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">colorize</span><span class="p">(</span><span class="s2">&quot;@*g{[+]} &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">debug_padded_filter</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>


<div class="viewcode-block" id="print_install_test_log">
<a class="viewcode-back" href="../../spack.html#spack.installer.print_install_test_log">[docs]</a>
<span class="k">def</span> <span class="nf">print_install_test_log</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Output install test log file path but only if have test failures.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: instance of the package under test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">run_tests</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">tester</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">tester</span><span class="o">.</span><span class="n">test_failures</span><span class="p">):</span>
        <span class="c1"># The tests were not run or there were no test failures</span>
        <span class="k">return</span>

    <span class="n">pkg</span><span class="o">.</span><span class="n">tester</span><span class="o">.</span><span class="n">print_log_path</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">_print_timer</span><span class="p">(</span><span class="n">pre</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timer</span><span class="p">:</span> <span class="n">timer</span><span class="o">.</span><span class="n">BaseTimer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">_hms</span><span class="p">(</span><span class="n">timer</span><span class="o">.</span><span class="n">duration</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">timer</span><span class="o">.</span><span class="n">phases</span><span class="p">]</span>
    <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total: </span><span class="si">{</span><span class="n">_hms</span><span class="p">(</span><span class="n">timer</span><span class="o">.</span><span class="n">duration</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> Successfully installed </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">phases</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_install_from_cache</span><span class="p">(</span>
    <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Install the package from binary cache</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: package to install from the binary cache</span>
<span class="sd">        explicit: ``True`` if installing the package was explicitly</span>
<span class="sd">            requested by the user, otherwise, ``False``</span>
<span class="sd">        unsigned: if ``True`` or ``False`` override the mirror signature verification defaults</span>

<span class="sd">    Return: ``True`` if the package was extract from binary cache, ``False`` otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>
    <span class="n">installed_from_cache</span> <span class="o">=</span> <span class="n">_try_install_from_binary_cache</span><span class="p">(</span>
        <span class="n">pkg</span><span class="p">,</span> <span class="n">explicit</span><span class="p">,</span> <span class="n">unsigned</span><span class="o">=</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="n">t</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">installed_from_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">t</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully extracted </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> from binary cache&quot;</span><span class="p">)</span>

    <span class="n">_write_timer_json</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">_print_timer</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">_log_prefix</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">pkg_id</span><span class="o">=</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
    <span class="n">_print_installed_pkg</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">post_install</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">explicit</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_process_external_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to run post install hooks and register external packages.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: the external package</span>
<span class="sd">        explicit: if the package was requested explicitly by the user,</span>
<span class="sd">            ``False`` if it was pulled in as a dependency of an explicit</span>
<span class="sd">            package.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">,</span> <span class="s2">&quot;Expected to post-install/register an external package.&quot;</span>

    <span class="n">pre</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2"> :&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span>

    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">external_modules</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> has external module in </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">external_modules</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> is actually installed in </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">external_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> externally installed in </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">external_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if the package was already registered in the DB.</span>
        <span class="c1"># If this is the case, then only make explicit if required.</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> already registered in DB&quot;</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">explicit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">explicit</span><span class="p">:</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;explicit&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># If not, register it and generate the module file.</span>
        <span class="c1"># For external packages we just need to run</span>
        <span class="c1"># post-install hooks to generate module files.</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> generating module file&quot;</span><span class="p">)</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">post_install</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">explicit</span><span class="p">)</span>

        <span class="c1"># Add to the DB</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> registering into DB&quot;</span><span class="p">)</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process_binary_cache_tarball</span><span class="p">(</span>
    <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span>
    <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">unsigned</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
    <span class="n">mirrors_for_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">timer</span><span class="o">.</span><span class="n">BaseTimer</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">NULL_TIMER</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the binary cache tarball.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: the package being installed</span>
<span class="sd">        explicit: the package was explicitly requested by the user</span>
<span class="sd">        unsigned: if ``True`` or ``False`` override the mirror signature verification defaults</span>
<span class="sd">        mirrors_for_spec: Optional list of concrete specs and mirrors</span>
<span class="sd">        obtained by calling binary_distribution.get_mirrors_for_spec().</span>
<span class="sd">        timer: timer to keep track of binary install phases.</span>

<span class="sd">    Return:</span>
<span class="sd">        bool: ``True`` if the package was extracted from binary cache,</span>
<span class="sd">            else ``False``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">timer</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="s2">&quot;fetch&quot;</span><span class="p">):</span>
        <span class="n">download_result</span> <span class="o">=</span> <span class="n">binary_distribution</span><span class="o">.</span><span class="n">download_tarball</span><span class="p">(</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">,</span> <span class="n">mirrors_for_spec</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">download_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting </span><span class="si">{</span><span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s2"> from binary cache&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">timer</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">),</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">filter_padding</span><span class="p">():</span>
        <span class="n">binary_distribution</span><span class="o">.</span><span class="n">extract_tarball</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">download_result</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="n">timer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spliced</span><span class="p">:</span>  <span class="c1"># overwrite old metadata with new</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">write_spec</span><span class="p">(</span>
                <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">spec_file_path</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;_post_buildcache_install_hook&quot;</span><span class="p">):</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">_post_buildcache_install_hook</span><span class="p">()</span>

        <span class="n">pkg</span><span class="o">.</span><span class="n">installed_from_binary_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_try_install_from_binary_cache</span><span class="p">(</span>
    <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span>
    <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">unsigned</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">timer</span><span class="o">.</span><span class="n">BaseTimer</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">NULL_TIMER</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to extract the package from binary cache.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: package to be extracted from binary cache</span>
<span class="sd">        explicit: the package was explicitly requested by the user</span>
<span class="sd">        unsigned: if ``True`` or ``False`` override the mirror signature verification defaults</span>
<span class="sd">        timer: timer to keep track of binary install phases.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Early exit if no binary mirrors are configured.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spack</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">MirrorCollection</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching for binary cache of </span><span class="si">{</span><span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">timer</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="s2">&quot;search&quot;</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">binary_distribution</span><span class="o">.</span><span class="n">get_mirrors_for_spec</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">index_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_process_binary_cache_tarball</span><span class="p">(</span>
        <span class="n">pkg</span><span class="p">,</span> <span class="n">explicit</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">,</span> <span class="n">mirrors_for_spec</span><span class="o">=</span><span class="n">matches</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="n">timer</span>
    <span class="p">)</span>


<div class="viewcode-block" id="combine_phase_logs">
<a class="viewcode-back" href="../../spack.html#spack.installer.combine_phase_logs">[docs]</a>
<span class="k">def</span> <span class="nf">combine_phase_logs</span><span class="p">(</span><span class="n">phase_log_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">log_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read set or list of logs and combine them into one file.</span>

<span class="sd">    Each phase will produce it&#39;s own log, so this function aims to cat all the</span>
<span class="sd">    separate phase log output files into the pkg.log_path. It is written</span>
<span class="sd">    generally to accept some list of files, and a log path to combine them to.</span>

<span class="sd">    Args:</span>
<span class="sd">        phase_log_files: a list or iterator of logs to combine</span>
<span class="sd">        log_path: the path to combine them to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s2">&quot;bw&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">phase_log_file</span> <span class="ow">in</span> <span class="n">phase_log_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">phase_log_file</span><span class="p">,</span> <span class="s2">&quot;br&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">phase_log</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">phase_log</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)</span></div>



<div class="viewcode-block" id="dump_packages">
<a class="viewcode-back" href="../../spack.html#spack.installer.dump_packages">[docs]</a>
<span class="k">def</span> <span class="nf">dump_packages</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump all package information for a spec and its dependencies.</span>

<span class="sd">    This creates a package repository within path for every namespace in the</span>
<span class="sd">    spec DAG, and fills the repos with package files and patch files for every</span>
<span class="sd">    node in the DAG.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec: the Spack spec whose package information is to be dumped</span>
<span class="sd">        path: the path to the build packages directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Copy in package.py files from any dependencies.</span>
    <span class="c1"># Note that we copy them in as they are in the *install* directory</span>
    <span class="c1"># NOT as they are in the repository, because we want a snapshot of</span>
    <span class="c1"># how *this* particular build was done.</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="nb">all</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
            <span class="c1"># Locate the dependency package in the install tree and find</span>
            <span class="c1"># its provenance information.</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">build_packages_path</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">source_repo_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>

            <span class="c1"># If there&#39;s no provenance installed for the package, skip it.</span>
            <span class="c1"># If it&#39;s external, skip it because it either:</span>
            <span class="c1"># 1) it wasn&#39;t built with Spack, so it has no Spack metadata</span>
            <span class="c1"># 2) it was built by another Spack instance, and we do not</span>
            <span class="c1"># (currently) use Spack metadata to associate repos with externals</span>
            <span class="c1"># built by other Spack instances.</span>
            <span class="c1"># Spack can always get something current from the builtin repo.</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">external</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">source_repo_root</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Create a source repo and get the pkg directory out of it.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source_repo</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">source_repo_root</span><span class="p">)</span>
                <span class="n">source_pkg_dir</span> <span class="o">=</span> <span class="n">source_repo</span><span class="o">.</span><span class="n">dirname_for_package_name</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">RepoError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create source repo for </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">source_pkg_dir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Couldn&#39;t copy in provenance for </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a destination repository</span>
        <span class="n">dest_repo_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_repo_root</span><span class="p">):</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">create_repo</span><span class="p">(</span><span class="n">dest_repo_root</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">dest_repo_root</span><span class="p">)</span>

        <span class="c1"># Get the location of the package in the dest repo.</span>
        <span class="n">dest_pkg_dir</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">dirname_for_package_name</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">dump_provenance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">dest_pkg_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source_pkg_dir</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">install_tree</span><span class="p">(</span><span class="n">source_pkg_dir</span><span class="p">,</span> <span class="n">dest_pkg_dir</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_dependent_ids">
<a class="viewcode-back" href="../../spack.html#spack.installer.get_dependent_ids">[docs]</a>
<span class="k">def</span> <span class="nf">get_dependent_ids</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of package ids for the spec&#39;s dependents</span>

<span class="sd">    Args:</span>
<span class="sd">        spec: Concretized spec</span>

<span class="sd">    Returns: list of package ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">package_id</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependents</span><span class="p">()]</span></div>



<div class="viewcode-block" id="install_msg">
<a class="viewcode-back" href="../../spack.html#spack.installer.install_msg">[docs]</a>
<span class="k">def</span> <span class="nf">install_msg</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">install_status</span><span class="p">:</span> <span class="n">InstallStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Colorize the name/id of the package being installed</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name/id of the package being installed</span>
<span class="sd">        pid: id of the installer process</span>

<span class="sd">    Return: Colorized installing message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="k">if</span> <span class="n">tty</span><span class="o">.</span><span class="n">show_pid</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot; @*{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">install_status</span><span class="o">.</span><span class="n">get_progress</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">install_status</span> <span class="ow">and</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:install_status&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pre</span> <span class="o">+</span> <span class="n">colorize</span><span class="p">(</span><span class="s2">&quot;@*</span><span class="si">{Installing}</span><span class="s2"> @*g{</span><span class="si">%s</span><span class="s2">}</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">post</span><span class="p">))</span></div>



<div class="viewcode-block" id="archive_install_logs">
<a class="viewcode-back" href="../../spack.html#spack.installer.archive_install_logs">[docs]</a>
<span class="k">def</span> <span class="nf">archive_install_logs</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">phase_log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy install logs to their destination directory(ies)</span>
<span class="sd">    Args:</span>
<span class="sd">        pkg: the package that was built and installed</span>
<span class="sd">        phase_log_dir: path to the archive directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy a compressed version of the install log</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">log_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">install_log_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
        <span class="c1"># Use GzipFile directly so we can omit filename / mtime in header</span>
        <span class="n">gzip_file</span> <span class="o">=</span> <span class="n">GzipFile</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">mtime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">gzip_file</span><span class="p">)</span>
        <span class="n">gzip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Archive the install-phase test log, if present</span>
    <span class="n">pkg</span><span class="o">.</span><span class="n">archive_install_test_log</span><span class="p">()</span></div>



<div class="viewcode-block" id="log">
<a class="viewcode-back" href="../../spack.html#spack.installer.log">[docs]</a>
<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy provenance into the install directory on success</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: the package that was built and installed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">packages_dir</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">build_packages_path</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

    <span class="c1"># Remove first if we&#39;re overwriting another build</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># log and env install paths are inside this</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">packages_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># FIXME : this potentially catches too many things...</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">archive_install_logs</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">packages_dir</span><span class="p">))</span>

    <span class="c1"># Archive the environment modifications for the build.</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">env_mods_path</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">install_env_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">configure_args_path</span><span class="p">):</span>
        <span class="c1"># Archive the args used for the build</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">configure_args_path</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">install_configure_args_path</span><span class="p">)</span>

    <span class="c1"># Finally, archive files that are specific to each package</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="s2">&quot;archived-files&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">glob_expr</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">archive_files</span><span class="p">:</span>
            <span class="c1"># Check that we are trying to copy things that are</span>
            <span class="c1"># in the stage tree (not arbitrary files)</span>
            <span class="n">abs_expr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">glob_expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">abs_expr</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OUTSIDE SOURCE PATH]: </span><span class="si">{</span><span class="n">glob_expr</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Now that we are sure that the path is within the correct</span>
            <span class="c1"># folder, make it relative and check for matches</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">glob_expr</span><span class="p">):</span>
                <span class="n">glob_expr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">glob_expr</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_expr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="c1"># We must ensure that the directory exists before</span>
                    <span class="c1"># copying a file in</span>
                    <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
                    <span class="n">fs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                    <span class="c1"># Here try to be conservative, and avoid discarding</span>
                    <span class="c1"># the whole install procedure because of copying a</span>
                    <span class="c1"># single file failed</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FAILED TO ARCHIVE]: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">getvalue</span><span class="p">():</span>
            <span class="n">error_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s2">&quot;errors.txt&quot;</span><span class="p">)</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">err</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors occurred when archiving files.</span><span class="se">\n\t</span><span class="s2">See: </span><span class="si">{</span><span class="n">error_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dump_packages</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">packages_dir</span><span class="p">)</span></div>



<div class="viewcode-block" id="package_id">
<a class="viewcode-back" href="../../spack.html#spack.installer.package_id">[docs]</a>
<span class="k">def</span> <span class="nf">package_id</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A &quot;unique&quot; package identifier for installation purposes</span>

<span class="sd">    The identifier is used to track tasks, locks, install, and</span>
<span class="sd">    failure statuses.</span>

<span class="sd">    The identifier needs to distinguish between combinations of compilers</span>
<span class="sd">    and packages for combinatorial environments.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg: the package from which the identifier is derived</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot provide a unique, readable id when the spec is not concretized.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="BuildRequest">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildRequest">[docs]</a>
<span class="k">class</span> <span class="nc">BuildRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for representing an installation request.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">install_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate a build request for a package.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: the package to be built and installed</span>
<span class="sd">            install_args: the install arguments associated with ``pkg``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure dealing with a package that has a concrete spec</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span><span class="si">}</span><span class="s2"> must be a package&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> must have a concrete spec&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">stop_before_phase</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stop_before&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined] # noqa: E501</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">last_phase</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stop_at&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

        <span class="c1"># Cache the package id for convenience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># Save off the original install arguments plus standard defaults</span>
        <span class="c1"># since they apply to the requested package *and* dependencies.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_args</span> <span class="o">=</span> <span class="n">install_args</span> <span class="k">if</span> <span class="n">install_args</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_default_args</span><span class="p">()</span>

        <span class="c1"># Cache overwrite information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Save off dependency package ids for quick checks since traversals</span>
        <span class="c1"># are not able to return full dependents for all packages across</span>
        <span class="c1"># environment specs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">package_id</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_depflags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">package_id</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a formal representation of the build request.&quot;&quot;&quot;</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&quot;</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rep</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a printable version of the build request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;package=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, install_args=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">install_args</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_add_default_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure standard install options are set to at least the default.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">),</span>  <span class="c1"># installs *always* build</span>
            <span class="p">(</span><span class="s2">&quot;dependencies_cache_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;dependencies_use_cache&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;fail_fast&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;install_deps&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;install_package&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;install_source&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;package_cache_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;package_use_cache&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;keep_prefix&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;keep_stage&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;restage&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;skip_patch&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;unsigned&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

<div class="viewcode-block" id="BuildRequest.get_depflags">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildRequest.get_depflags">[docs]</a>
    <span class="k">def</span> <span class="nf">get_depflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the required dependency types for the associated package.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: explicit or implicit package being installed</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: required dependency type(s) for the package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depflag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span>
        <span class="n">include_build_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_build_deps&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span> <span class="o">==</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">):</span>
            <span class="n">cache_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_cache_only&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dependencies_cache_only&quot;</span><span class="p">)</span>

        <span class="c1"># Include build dependencies if pkg is going to be built from sources, or</span>
        <span class="c1"># if build deps are explicitly requested.</span>
        <span class="k">if</span> <span class="n">include_build_deps</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">cache_only</span> <span class="ow">or</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">installed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span>
        <span class="p">):</span>
            <span class="n">depflag</span> <span class="o">|=</span> <span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
            <span class="n">depflag</span> <span class="o">|=</span> <span class="n">dt</span><span class="o">.</span><span class="n">TEST</span>
        <span class="k">return</span> <span class="n">depflag</span></div>


<div class="viewcode-block" id="BuildRequest.has_dependency">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildRequest.has_dependency">[docs]</a>
    <span class="k">def</span> <span class="nf">has_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns ``True`` if the package id represents a known dependency</span>
<span class="sd">        of the requested package, ``False`` otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span></div>


<div class="viewcode-block" id="BuildRequest.run_tests">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildRequest.run_tests">[docs]</a>
    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if the tests should be run for the provided packages</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: explicit or implicit package being installed</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if they should be run; ``False`` otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tests</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tests</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The specification associated with the package.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span>

<div class="viewcode-block" id="BuildRequest.traverse_dependencies">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildRequest.traverse_dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">traverse_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visited</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield any dependencies of the appropriate type(s)&quot;&quot;&quot;</span>
        <span class="c1"># notice: deptype is not constant across nodes, so we cannot use</span>
        <span class="c1"># spec.traverse_edges(deptype=...).</span>

        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
        <span class="k">if</span> <span class="n">visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_depflags</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">package</span><span class="p">)):</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hash</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
            <span class="c1"># In Python 3: yield from self.traverse_dependencies(dep, visited)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse_dependencies</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">visited</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">s</span>
            <span class="k">yield</span> <span class="n">dep</span></div>
</div>



<div class="viewcode-block" id="Task">
<a class="viewcode-back" href="../../spack.html#spack.installer.Task">[docs]</a>
<span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for representing a task for a package.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">BuildRequest</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">BuildStatus</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
        <span class="n">installed</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate a task for a package.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: the package to be built and installed</span>
<span class="sd">            request: the associated install request</span>
<span class="sd">            start: the initial start time for the package, in seconds</span>
<span class="sd">            attempts: the number of attempts to install the package, which</span>
<span class="sd">                should be 0 when the task is initially instantiated</span>
<span class="sd">            status: the installation status</span>
<span class="sd">            installed: the (string) identifiers of packages that have</span>
<span class="sd">                been installed so far</span>

<span class="sd">        Raises:</span>
<span class="sd">            ``InstallError`` if the build status is incompatible with the task</span>
<span class="sd">            ``TypeError`` if provided an argument of the wrong type</span>
<span class="sd">            ``ValueError`` if provided an argument with the wrong value or state</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure dealing with a package that has a concrete spec</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span><span class="si">}</span><span class="s2"> must be a package&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> must have a concrete spec&quot;</span><span class="p">)</span>

        <span class="c1"># The &quot;unique&quot; identifier for the task&#39;s package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># The explicit build request associated with the package</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">BuildRequest</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2"> is not a valid build request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

        <span class="c1"># Initialize the status to an active state.  The status is used to</span>
        <span class="c1"># ensure priority queue invariants when tasks are &quot;removed&quot; from the</span>
        <span class="c1"># queue.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">BuildStatus</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> is not a valid build status&quot;</span><span class="p">)</span>

        <span class="c1"># The initial build task cannot have status &quot;removed&quot;.</span>
        <span class="k">if</span> <span class="n">attempts</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">==</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">REMOVED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot create a task for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> with status &#39;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

        <span class="c1"># cache the PID, which is used for distributed build messages in self.execute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="c1"># The initial start time for processing the spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">installed</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;BuildTask constructor requires &#39;installed&#39; be a &#39;set&#39;, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not &#39;</span><span class="si">{</span><span class="n">installed</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Set of dependents, which needs to include the requesting package</span>
        <span class="c1"># to support tracking of parallel, multi-spec, environment installs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_dependent_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pkg id </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> has the following dependents:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependents</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Set of dependencies</span>
        <span class="c1">#</span>
        <span class="c1"># Be consistent wrt use of dependents and dependencies.  That is,</span>
        <span class="c1"># if use traverse for transitive dependencies, then must remove</span>
        <span class="c1"># transitive dependents on failure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">package_id</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_depflags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">package_id</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span>
        <span class="p">)</span>

        <span class="c1"># List of uninstalled dependencies, which is used to establish</span>
        <span class="c1"># the priority of the task.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uninstalled_deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">pkg_id</span> <span class="k">for</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">installed</span>
        <span class="p">)</span>

        <span class="c1"># Ensure key sequence-related properties are updated accordingly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="n">attempts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

<div class="viewcode-block" id="Task.execute">
<a class="viewcode-back" href="../../spack.html#spack.installer.Task.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">install_status</span><span class="p">:</span> <span class="n">InstallStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecuteResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the work of this task.</span>

<span class="sd">        The ``install_status`` is an ``InstallStatus`` object used to format progress reporting for</span>
<span class="sd">        this task in the context of the full ``BuildRequest``.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a formal representation of the task.&quot;&quot;&quot;</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&quot;</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rep</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a printable version of the task.&quot;&quot;&quot;</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#dependencies=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;priority=</span><span class="si">{0}</span><span class="s2">, status=</span><span class="si">{1}</span><span class="s2">, start=</span><span class="si">{2}</span><span class="s2">, </span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">dependencies</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update properties associated with a new instance of a task.&quot;&quot;&quot;</span>
        <span class="c1"># Number of times the task has/will be queued</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Ensure the task gets a unique sequence number to preserve the</span>
        <span class="c1"># order in which it is added.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_counter</span><span class="p">)</span>

<div class="viewcode-block" id="Task.add_dependent">
<a class="viewcode-back" href="../../spack.html#spack.installer.Task.add_dependent">[docs]</a>
    <span class="k">def</span> <span class="nf">add_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure the package is in this task&#39;s ``dependents`` list.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg_id:  package identifier of the dependent package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pkg_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span> <span class="ow">and</span> <span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependents</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> as a dependent of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Task.add_dependency">
<a class="viewcode-back" href="../../spack.html#spack.installer.Task.add_dependency">[docs]</a>
    <span class="k">def</span> <span class="nf">add_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure the package is in this task&#39;s ``dependencies`` list.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg_id (str):  package identifier of the dependency package</span>
<span class="sd">            installed (bool):  install status of the dependency package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pkg_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span> <span class="ow">and</span> <span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> as a depencency of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">installed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uninstalled_deps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Task.flag_installed">
<a class="viewcode-back" href="../../spack.html#spack.installer.Task.flag_installed">[docs]</a>
    <span class="k">def</span> <span class="nf">flag_installed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">installed</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure the dependency is not considered to still be uninstalled.</span>

<span class="sd">        Args:</span>
<span class="sd">            installed: the identifiers of packages that have been installed so far</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now_installed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uninstalled_deps</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">installed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="n">now_installed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uninstalled_deps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">: Removed </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> from uninstalled deps list: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uninstalled_deps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_setup_install_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and ensure proper access controls for the install directory.</span>
<span class="sd">        Write a small metadata file with the current spack environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: the package to be built and installed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Move to a module level method.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">debug_padded_filter</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating the installation directory </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">create_install_directory</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set the proper group for the prefix</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_package_group</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">chgrp</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

            <span class="c1"># Set the proper permissions.</span>
            <span class="c1"># This has to be done after group because changing groups blows</span>
            <span class="c1"># away the sticky group bit on the directory</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_package_dir_permissions</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">perms</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">perms</span><span class="p">)</span>

            <span class="c1"># Ensure the metadata path exists as well</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">perms</span><span class="p">)</span>

        <span class="c1"># Always write host environment - we assume this can change</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">write_host_environment</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;explicit&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_build_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The package was requested directly&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">pkg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">_use_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_build_request</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_use_cache&quot;</span><span class="p">,</span> <span class="n">_use_cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dependencies_use_cache&quot;</span><span class="p">,</span> <span class="n">_use_cache</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache_only</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">_cache_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_build_request</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_cache_only&quot;</span><span class="p">,</span> <span class="n">_cache_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dependencies_cache_only&quot;</span><span class="p">,</span> <span class="n">_cache_only</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The key is the tuple (# uninstalled dependencies, sequence).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>

<div class="viewcode-block" id="Task.next_attempt">
<a class="viewcode-back" href="../../spack.html#spack.installer.Task.next_attempt">[docs]</a>
    <span class="k">def</span> <span class="nf">next_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">installed</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Task&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new, updated task for the next installation attempt.&quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">task</span><span class="o">.</span><span class="n">flag_installed</span><span class="p">(</span><span class="n">installed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">task</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The priority is based on the remaining uninstalled dependencies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uninstalled_deps</span><span class="p">)</span></div>



<div class="viewcode-block" id="BuildTask">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildTask">[docs]</a>
<span class="k">class</span> <span class="nc">BuildTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for representing a build task for a package.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BuildTask.execute">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildTask.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">install_status</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the installation of the requested spec and/or dependency</span>
<span class="sd">        represented by the build task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">install_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tests&quot;</span><span class="p">)</span>
        <span class="n">unsigned</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unsigned&quot;</span><span class="p">)</span>

        <span class="n">pkg</span><span class="p">,</span> <span class="n">pkg_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">install_msg</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">install_status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">INSTALLING</span>

        <span class="c1"># Use the binary cache if requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_install_from_cache</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span><span class="p">,</span> <span class="n">unsigned</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ExecuteResult</span><span class="o">.</span><span class="n">SUCCESS</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_only</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span>
                    <span class="s2">&quot;No binary found when cache-only was specified&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No binary for </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> found: installing from source&quot;</span><span class="p">)</span>

        <span class="n">pkg</span><span class="o">.</span><span class="n">run_tests</span> <span class="o">=</span> <span class="n">tests</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">tests</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tests</span>

        <span class="c1"># hook that allows tests to inspect the Package before installation</span>
        <span class="c1"># see unit_test_check() docs.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">unit_test_check</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ExecuteResult</span><span class="o">.</span><span class="n">FAILED</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create stage object now and let it be serialized for the child process. That</span>
            <span class="c1"># way monkeypatch in tests works correctly.</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">stage</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_install_dir</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

            <span class="c1"># Create a child process to do the actual installation.</span>
            <span class="c1"># Preserve verbosity settings across installs.</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">build_environment</span><span class="o">.</span><span class="n">start_build_process</span><span class="p">(</span>
                <span class="n">pkg</span><span class="p">,</span> <span class="n">build_process</span><span class="p">,</span> <span class="n">install_args</span>
            <span class="p">)</span>

            <span class="c1"># Note: PARENT of the build process adds the new package to</span>
            <span class="c1"># the database, so that we don&#39;t need to re-read from file.</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">explicit</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">StopPhase</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># A StopPhase exception means that do_install was asked to</span>
            <span class="c1"># stop early from clients, and is not an error at this point</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="k">if</span> <span class="n">tty</span><span class="o">.</span><span class="n">show_pid</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pid</span><span class="si">}{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Package stage directory: </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ExecuteResult</span><span class="o">.</span><span class="n">SUCCESS</span></div>
</div>



<div class="viewcode-block" id="RewireTask">
<a class="viewcode-back" href="../../spack.html#spack.installer.RewireTask">[docs]</a>
<span class="k">class</span> <span class="nc">RewireTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for representing a rewire task for a package.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RewireTask.execute">
<a class="viewcode-back" href="../../spack.html#spack.installer.RewireTask.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">install_status</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute rewire task</span>

<span class="sd">        Rewire tasks are executed by either rewiring self.package.spec.build_spec that is already</span>
<span class="sd">        installed or downloading and rewiring a binary for the it.</span>

<span class="sd">        If not available installed or as binary, return ExecuteResult.MISSING_BUILD_SPEC.</span>
<span class="sd">        This will prompt the Installer to requeue the task with a dependency on the BuildTask</span>
<span class="sd">        to install self.pkg.spec.build_spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">oldstatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">INSTALLING</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">install_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">install_status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">install_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span>
                <span class="n">unsigned</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unsigned&quot;</span><span class="p">)</span>
                <span class="n">_process_binary_cache_tarball</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">explicit</span><span class="p">,</span> <span class="n">unsigned</span><span class="o">=</span><span class="n">unsigned</span><span class="p">)</span>
                <span class="n">_print_installed_pkg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ExecuteResult</span><span class="o">.</span><span class="n">SUCCESS</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to rewire </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2"> from binary. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">oldstatus</span>
                <span class="k">return</span> <span class="n">ExecuteResult</span><span class="o">.</span><span class="n">MISSING_BUILD_SPEC</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">rewiring</span><span class="o">.</span><span class="n">rewire_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span><span class="p">)</span>
        <span class="n">_print_installed_pkg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ExecuteResult</span><span class="o">.</span><span class="n">SUCCESS</span></div>
</div>



<div class="viewcode-block" id="PackageInstaller">
<a class="viewcode-back" href="../../spack.html#spack.installer.PackageInstaller">[docs]</a>
<span class="k">class</span> <span class="nc">PackageInstaller</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for managing the install process for a Spack instance based on a bottom-up DAG approach.</span>

<span class="sd">    This installer can coordinate concurrent batch and interactive, local and distributed (on a</span>
<span class="sd">    shared file system) builds for the same Spack instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cache_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dependencies_cache_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dependencies_use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">dirty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">explicit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fail_fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">fake</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_build_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">install_deps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">install_package</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">install_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">keep_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">keep_stage</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">package_cache_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">package_use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">restage</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_patch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">stop_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stop_before</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tests</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">unsigned</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">            explicit: Set of package hashes to be marked as installed explicitly in the db. If</span>
<span class="sd">                True, the specs from ``packages`` are marked explicit, while their dependencies are</span>
<span class="sd">                not.</span>
<span class="sd">            fail_fast: Fail if any dependency fails to install; otherwise, the default is to</span>
<span class="sd">                install as many dependencies as possible (i.e., best effort installation).</span>
<span class="sd">            fake: Don&#39;t really build; install fake stub files instead.</span>
<span class="sd">            install_deps: Install dependencies before installing this package</span>
<span class="sd">            install_source: By default, source is not installed, but for debugging it might be</span>
<span class="sd">                useful to keep it around.</span>
<span class="sd">            keep_prefix: Keep install prefix on failure. By default, destroys it.</span>
<span class="sd">            keep_stage: By default, stage is destroyed only if there are no exceptions during</span>
<span class="sd">                build. Set to True to keep the stage even with exceptions.</span>
<span class="sd">            restage: Force spack to restage the package source.</span>
<span class="sd">            skip_patch: Skip patch stage of build if True.</span>
<span class="sd">            stop_before: stop execution before this installation phase (or None)</span>
<span class="sd">            stop_at: last installation phase to be executed (or None)</span>
<span class="sd">            tests: False to run no tests, True to test all packages, or a list of package names to</span>
<span class="sd">                run tests for some</span>
<span class="sd">            use_cache: Install from binary package, if available.</span>
<span class="sd">            verbose: Display verbose build output (by default, suppresses it)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">explicit</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">explicit</span> <span class="o">=</span> <span class="p">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">}</span> <span class="k">if</span> <span class="n">explicit</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">install_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cache_only&quot;</span><span class="p">:</span> <span class="n">cache_only</span><span class="p">,</span>
            <span class="s2">&quot;dependencies_cache_only&quot;</span><span class="p">:</span> <span class="n">dependencies_cache_only</span><span class="p">,</span>
            <span class="s2">&quot;dependencies_use_cache&quot;</span><span class="p">:</span> <span class="n">dependencies_use_cache</span><span class="p">,</span>
            <span class="s2">&quot;dirty&quot;</span><span class="p">:</span> <span class="n">dirty</span><span class="p">,</span>
            <span class="s2">&quot;explicit&quot;</span><span class="p">:</span> <span class="n">explicit</span><span class="p">,</span>
            <span class="s2">&quot;fail_fast&quot;</span><span class="p">:</span> <span class="n">fail_fast</span><span class="p">,</span>
            <span class="s2">&quot;fake&quot;</span><span class="p">:</span> <span class="n">fake</span><span class="p">,</span>
            <span class="s2">&quot;include_build_deps&quot;</span><span class="p">:</span> <span class="n">include_build_deps</span><span class="p">,</span>
            <span class="s2">&quot;install_deps&quot;</span><span class="p">:</span> <span class="n">install_deps</span><span class="p">,</span>
            <span class="s2">&quot;install_package&quot;</span><span class="p">:</span> <span class="n">install_package</span><span class="p">,</span>
            <span class="s2">&quot;install_source&quot;</span><span class="p">:</span> <span class="n">install_source</span><span class="p">,</span>
            <span class="s2">&quot;keep_prefix&quot;</span><span class="p">:</span> <span class="n">keep_prefix</span><span class="p">,</span>
            <span class="s2">&quot;keep_stage&quot;</span><span class="p">:</span> <span class="n">keep_stage</span><span class="p">,</span>
            <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="s2">&quot;package_cache_only&quot;</span><span class="p">:</span> <span class="n">package_cache_only</span><span class="p">,</span>
            <span class="s2">&quot;package_use_cache&quot;</span><span class="p">:</span> <span class="n">package_use_cache</span><span class="p">,</span>
            <span class="s2">&quot;restage&quot;</span><span class="p">:</span> <span class="n">restage</span><span class="p">,</span>
            <span class="s2">&quot;skip_patch&quot;</span><span class="p">:</span> <span class="n">skip_patch</span><span class="p">,</span>
            <span class="s2">&quot;stop_at&quot;</span><span class="p">:</span> <span class="n">stop_at</span><span class="p">,</span>
            <span class="s2">&quot;stop_before&quot;</span><span class="p">:</span> <span class="n">stop_before</span><span class="p">,</span>
            <span class="s2">&quot;tests&quot;</span><span class="p">:</span> <span class="n">tests</span><span class="p">,</span>
            <span class="s2">&quot;unsigned&quot;</span><span class="p">:</span> <span class="n">unsigned</span><span class="p">,</span>
            <span class="s2">&quot;use_cache&quot;</span><span class="p">:</span> <span class="n">use_cache</span><span class="p">,</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># List of build requests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">BuildRequest</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">install_args</span><span class="p">)</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">]</span>

        <span class="c1"># Priority queue of tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_pq</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Task</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Mapping of unique package ids to task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Cache of package locks for failed packages, keyed on package&#39;s ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Cache the PID for distributed build messaging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="c1"># Cache of installed packages&#39; unique ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Data store layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span>

        <span class="c1"># Locks on specs being built, keyed on the package&#39;s unique id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Cache fail_fast option to ensure if one build request asks to fail</span>
        <span class="c1"># fast then that option applies to all build requests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_fast</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Initializing all_dependencies to empty. This will be set later in _init_queue.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a formal representation of the package installer.&quot;&quot;&quot;</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&quot;</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rep</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a printable version of the package installer.&quot;&quot;&quot;</span>
        <span class="n">requests</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#requests=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_requests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#tasks=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">installed</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;installed (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">)</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">requests</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">tasks</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">installed</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_add_init_task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">BuildRequest</span><span class="p">,</span>
        <span class="n">all_deps</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and queues the initial task for the package.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: the package to be built and installed</span>
<span class="sd">            request: the associated install request</span>
<span class="sd">            all_deps: dictionary of all dependencies and associated dependents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">RewireTask</span> <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spliced</span> <span class="k">else</span> <span class="n">BuildTask</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">BuildStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="n">all_deps</span><span class="p">[</span><span class="n">dep_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_push_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_db</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">InstallRecord</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if the spec is flagged as installed in the database</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: spec whose database install status is being checked</span>

<span class="sd">        Return:</span>
<span class="sd">            Tuple of optional database record, and a boolean installed_in_db</span>
<span class="sd">                that&#39;s ``True`` iff the spec is considered installed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">installed_in_db</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">installed</span> <span class="k">if</span> <span class="n">rec</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># KeyError is raised if there is no matching spec in the database</span>
            <span class="c1"># (versus no matching specs that are installed).</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">installed_in_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">rec</span><span class="p">,</span> <span class="n">installed_in_db</span>

    <span class="k">def</span> <span class="nf">_check_deps_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">BuildRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the install status of the requested package</span>

<span class="sd">        Args:</span>
<span class="sd">            request: the associated install request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Cannot proceed with </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">traverse_dependencies</span><span class="p">():</span>
            <span class="n">dep_pkg</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">package</span>
            <span class="n">dep_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

            <span class="c1"># Check for failure since a prefix lock is not required</span>
            <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">failure_tracker</span><span class="o">.</span><span class="n">has_failed</span><span class="p">(</span><span class="n">dep</span><span class="p">):</span>
                <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;&#39;spack install&#39; the dependency&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> is marked as an install failure: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">dep_pkg</span><span class="p">)</span>

            <span class="c1"># Attempt to get a read lock to ensure another process does not</span>
            <span class="c1"># uninstall the dependency while the requested spec is being</span>
            <span class="c1"># installed</span>
            <span class="n">ltype</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_locked</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="n">dep_pkg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> is write locked by another process&quot;</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">pkg</span><span class="p">)</span>

            <span class="c1"># Flag external and upstream packages as being installed</span>
            <span class="k">if</span> <span class="n">dep_pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="ow">or</span> <span class="n">dep_pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">installed_upstream</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_flag_installed</span><span class="p">(</span><span class="n">dep_pkg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Check the database to see if the dependency has been installed</span>
            <span class="c1"># and flag as such if appropriate</span>
            <span class="n">rec</span><span class="p">,</span> <span class="n">installed_in_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_db</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">rec</span>
                <span class="ow">and</span> <span class="n">installed_in_db</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">dep</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">overwrite</span>
                    <span class="ow">or</span> <span class="n">rec</span><span class="o">.</span><span class="n">installation_time</span> <span class="o">&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">overwrite_time</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flagging </span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> as installed per the database&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_flag_installed</span><span class="p">(</span><span class="n">dep_pkg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">release_read</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_for_install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the database and leftover installation directories/files and</span>
<span class="sd">        prepare for a new install attempt for an uninstalled package.</span>
<span class="sd">        Preparation includes cleaning up installation and stage directories</span>
<span class="sd">        and ensuring the database is up-to-date.</span>

<span class="sd">        Args:</span>
<span class="sd">            task: the task whose associated package is</span>
<span class="sd">                being checked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">install_args</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span>
        <span class="n">keep_prefix</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_prefix&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure the package is ready to be locally installed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_install_ready</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># Skip file system operations if we&#39;ve already gone through them for</span>
        <span class="c1"># this spec.</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="c1"># Already determined the spec has been installed</span>
            <span class="k">return</span>

        <span class="c1"># Determine if the spec is flagged as installed in the database</span>
        <span class="n">rec</span><span class="p">,</span> <span class="n">installed_in_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_db</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">installed_in_db</span><span class="p">:</span>
            <span class="c1"># Ensure there is no other installed spec with the same prefix dir</span>
            <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_occupied_install_prefix</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Install prefix collision for </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">long_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Prefix directory </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> already &quot;</span>
                    <span class="s2">&quot;used by another installed spec.&quot;</span><span class="p">,</span>
                    <span class="n">pkg</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Make sure the installation directory is in the desired state</span>
            <span class="c1"># for uninstalled specs.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_prefix</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">remove_prefix</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> is partially installed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">rec</span>
            <span class="ow">and</span> <span class="n">installed_in_db</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">overwrite</span>
                <span class="ow">or</span> <span class="n">rec</span><span class="o">.</span><span class="n">installation_time</span> <span class="o">&gt;</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">overwrite_time</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_installed</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="c1"># Only update the explicit entry once for the explicit package</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">explicit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">explicit</span><span class="p">:</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;explicit&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cleanup_all_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup all tasks to include releasing their locks.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release_lock</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_failed</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_task</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_cleanup_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanup any failed markers for the package</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg_id (str): identifier for the failed package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> exception when removing failure tracking for </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{2}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing failure mark on </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">release_write</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_cleanup_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanup the task for the spec</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: the package being installed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_task</span><span class="p">(</span><span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>

        <span class="c1"># Ensure we have a read lock to prevent others from uninstalling the</span>
        <span class="c1"># spec during our installation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_locked</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_install_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure the package is ready to install locally, which includes</span>
<span class="sd">        already locked.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: the package being locally installed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> cannot be installed locally:&quot;</span>

        <span class="c1"># External packages cannot be installed locally.</span>
        <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExternalPackageError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> is external&quot;</span><span class="p">)</span>

        <span class="c1"># Upstream packages cannot be installed locally.</span>
        <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">installed_upstream</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UpstreamPackageError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> is upstream&quot;</span><span class="p">)</span>

        <span class="c1"># The package must have a prefix lock at this stage.</span>
        <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InstallLockError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2"> not locked&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_locked</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a prefix lock of the specified type for the package spec</span>

<span class="sd">        If the lock exists, then adjust accordingly.  That is, read locks</span>
<span class="sd">        will be upgraded to write locks if a write lock is requested and</span>
<span class="sd">        write locks will be downgraded to read locks if a read lock is</span>
<span class="sd">        requested.</span>

<span class="sd">        The lock timeout for write locks is deliberately near zero seconds in</span>
<span class="sd">        order to ensure the current process proceeds as quickly as possible to</span>
<span class="sd">        the next spec.</span>

<span class="sd">        Args:</span>
<span class="sd">            lock_type: &#39;read&#39; for a read lock, &#39;write&#39; for a write lock</span>
<span class="sd">            pkg: the package whose spec is being installed</span>

<span class="sd">        Return:</span>
<span class="sd">            (lock_type, lock) tuple where lock will be None if it could not be obtained</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">lock_type</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;read&quot;</span><span class="p">,</span>
            <span class="s2">&quot;write&quot;</span><span class="p">,</span>
        <span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">lock_type</span><span class="si">}</span><span class="s1">&quot; is not a supported package management lock type&#39;</span>

        <span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">ltype</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="p">(</span><span class="n">lock_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">lock</span> <span class="ow">and</span> <span class="n">ltype</span> <span class="o">==</span> <span class="n">lock_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ltype</span><span class="p">,</span> <span class="n">lock</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lock_type</span><span class="si">}</span><span class="s2"> lock&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> a </span><span class="si">{1}</span><span class="s2"> on </span><span class="si">{2}</span><span class="s2"> with timeout </span><span class="si">{3}</span><span class="s2">&quot;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Failed to </span><span class="si">{0}</span><span class="s2"> a </span><span class="si">{1}</span><span class="s2"> for </span><span class="si">{2}</span><span class="s2"> due to </span><span class="si">{3}</span><span class="s2">: </span><span class="si">{4}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">lock_type</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span><span class="p">:</span>
            <span class="c1"># Wait until the other process finishes if there are no more</span>
            <span class="c1"># tasks with priority 0 (i.e., with no uninstalled</span>
            <span class="c1"># dependencies).</span>
            <span class="n">no_p0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_is_pri0</span><span class="p">()</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">no_p0</span> <span class="k">else</span> <span class="mf">3.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mf">1e-9</span>  <span class="c1"># Near 0 to iterate through install specs quickly</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Acquiring&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">pretty_seconds</span><span class="p">(</span><span class="n">timeout</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)))</span>
                <span class="n">op</span> <span class="o">=</span> <span class="s2">&quot;acquire&quot;</span>
                <span class="n">lock</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">prefix_locker</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="n">lock</span><span class="o">.</span><span class="n">default_timeout</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected prefix lock timeout </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">, not </span><span class="si">{</span><span class="n">lock</span><span class="o">.</span><span class="n">default_timeout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lock_type</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span><span class="p">:</span>
                    <span class="n">lock</span><span class="o">.</span><span class="n">acquire_read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lock</span><span class="o">.</span><span class="n">acquire_write</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">lock_type</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span><span class="p">:</span>  <span class="c1"># write -&gt; read</span>
                <span class="c1"># Only get here if the current lock is a write lock, which</span>
                <span class="c1"># must be downgraded to be a read lock</span>
                <span class="c1"># Retain the original lock timeout, which is in the lock&#39;s</span>
                <span class="c1"># default_timeout setting.</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;Downgrading to&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">pretty_seconds</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">default_timeout</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">op</span> <span class="o">=</span> <span class="s2">&quot;downgrade to&quot;</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">downgrade_write_to_read</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># read -&gt; write</span>
                <span class="c1"># Only get here if the current lock is a read lock, which</span>
                <span class="c1"># must be upgraded to be a write lock</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Upgrading to&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">pretty_seconds</span><span class="p">(</span><span class="n">timeout</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)))</span>
                <span class="n">op</span> <span class="o">=</span> <span class="s2">&quot;upgrade to&quot;</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">upgrade_read_to_write</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> is now </span><span class="si">{</span><span class="n">lock_type</span><span class="si">}</span><span class="s2"> locked&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">lk</span><span class="o">.</span><span class="n">LockDowngradeError</span><span class="p">,</span> <span class="n">lk</span><span class="o">.</span><span class="n">LockTimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">lock_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_all_tasks</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">pkg_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lock_type</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">pkg_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_requeue_with_build_spec_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Requeue the task and its missing build spec dependencies&quot;&quot;&quot;</span>
        <span class="c1"># Full install of the build_spec is necessary because it didn&#39;t already exist somewhere</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">():</span>
            <span class="n">dep_pkg</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">package</span>

            <span class="n">dep_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dep_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_init_task</span><span class="p">(</span><span class="n">dep_pkg</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_dependencies</span><span class="p">)</span>

            <span class="c1"># Clear any persistent failure markings _unless_ they are</span>
            <span class="c1"># associated with another process in this parallel build</span>
            <span class="c1"># of the spec.</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">failure_tracker</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Queue the build spec.</span>
        <span class="n">build_pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">build_spec</span><span class="p">)</span>
        <span class="n">build_spec_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">[</span><span class="n">build_pkg_id</span><span class="p">]</span>
        <span class="n">spec_pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">next_attempt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">)</span>
        <span class="n">spec_task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">QUEUED</span>
        <span class="c1"># Convey a build spec as a dependency of a deployed spec.</span>
        <span class="n">build_spec_task</span><span class="o">.</span><span class="n">add_dependent</span><span class="p">(</span><span class="n">spec_pkg_id</span><span class="p">)</span>
        <span class="n">spec_task</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">build_pkg_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_push_task</span><span class="p">(</span><span class="n">spec_task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">BuildRequest</span><span class="p">,</span> <span class="n">all_deps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tasks to the priority queue for the given build request.</span>

<span class="sd">        It also tracks all dependents associated with each dependency in</span>
<span class="sd">        order to ensure proper tracking of uninstalled dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (BuildRequest): the associated install request</span>
<span class="sd">            all_deps (defaultdict(set)): dictionary of all dependencies and</span>
<span class="sd">                associated dependents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing the build queue for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure not attempting to perform an installation when user didn&#39;t</span>
        <span class="c1"># want to go that far for the requested package.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_check_last_phase</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadInstallPhase</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installation request refused: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">install_deps</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;install_deps&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">install_deps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">traverse_dependencies</span><span class="p">():</span>
                <span class="n">dep_pkg</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">package</span>

                <span class="n">dep_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dep_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_init_task</span><span class="p">(</span><span class="n">dep_pkg</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">all_deps</span><span class="o">=</span><span class="n">all_deps</span><span class="p">)</span>

                <span class="c1"># Clear any persistent failure markings _unless_ they are</span>
                <span class="c1"># associated with another process in this parallel build</span>
                <span class="c1"># of the spec.</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">failure_tracker</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">install_package</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;install_package&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">install_package</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span>
            <span class="c1"># Be sure to clear any previous failure</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">failure_tracker</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># If not installing dependencies, then determine their</span>
            <span class="c1"># installation status before proceeding</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">install_deps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_deps_status</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="c1"># Now add the package itself, if appropriate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_init_task</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">all_deps</span><span class="o">=</span><span class="n">all_deps</span><span class="p">)</span>

        <span class="c1"># Ensure if one request is to fail fast then all requests will.</span>
        <span class="n">fail_fast</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fail_fast&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_fast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_fast</span> <span class="ow">or</span> <span class="n">fail_fast</span>

    <span class="k">def</span> <span class="nf">_install_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">:</span> <span class="n">InstallStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the installation of the requested spec and/or dependency</span>
<span class="sd">        represented by the task.</span>

<span class="sd">        Args:</span>
<span class="sd">            task: the installation task for a package</span>
<span class="sd">            install_status: the installation status for the package&quot;&quot;&quot;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">install_status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">ExecuteResult</span><span class="o">.</span><span class="n">MISSING_BUILD_SPEC</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requeue_with_build_spec_tasks</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if rc == ExecuteResult.SUCCESS or rc == ExecuteResult.FAILED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_installed</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_next_is_pri0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the next task has priority 0</span>

<span class="sd">        Return:</span>
<span class="sd">            True if it does, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Leverage the fact that the first entry in the queue is the next</span>
        <span class="c1"># one that will be processed</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_pq</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_pop_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove and return the lowest priority task.</span>

<span class="sd">        Source: Variant of function at docs.python.org/2/library/heapq.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_pq</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_pq</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">REMOVED</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">]</span>
                <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">DEQUEUED</span>
                <span class="k">return</span> <span class="n">task</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_push_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Push (or queue) the specified task for the package.</span>

<span class="sd">        Source: Customization of &quot;add_task&quot; function at</span>
<span class="sd">                docs.python.org/2/library/heapq.html</span>

<span class="sd">        Args:</span>
<span class="sd">            task: the installation task for a package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> a task for </span><span class="si">{1}</span><span class="s2"> with status &#39;</span><span class="si">{2}</span><span class="s2">&#39;&quot;</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="s2">&quot;Skipping requeue of task for </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span>

        <span class="c1"># Ensure do not (re-)queue installed or failed packages whose status</span>
        <span class="c1"># may have been determined by a separate process.</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">skip</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="s2">&quot;installed&quot;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">skip</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Remove any associated task since its sequence will change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_task</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Queueing&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">attempts</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Requeueing (</span><span class="si">{</span><span class="n">ordinal</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">attempts</span><span class="p">)</span><span class="si">}</span><span class="s2"> attempt)&quot;</span>
        <span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>

        <span class="c1"># Now add the new task to the queue with a new sequence number to</span>
        <span class="c1"># ensure it is the last entry popped with the same priority.  This</span>
        <span class="c1"># is necessary in case we are re-queueing a task whose priority</span>
        <span class="c1"># was decremented due to the installation of one of its dependencies.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_pq</span><span class="p">,</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_release_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release any lock on the package</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg_id (str): identifier for the package whose lock is be released</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> exception when releasing </span><span class="si">{1}</span><span class="s2"> lock for </span><span class="si">{2}</span><span class="s2">: </span><span class="si">{3}</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Releasing </span><span class="si">{0}</span><span class="s2"> lock on </span><span class="si">{1}</span><span class="s2">&quot;</span>
            <span class="n">ltype</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">pkg_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ltype</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ltype</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span><span class="p">:</span>
                        <span class="n">lock</span><span class="o">.</span><span class="n">release_read</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lock</span><span class="o">.</span><span class="n">release_write</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">ltype</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_remove_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark the existing package task as being removed and return it.</span>
<span class="sd">        Raises KeyError if not found.</span>

<span class="sd">        Source: Variant of function at docs.python.org/2/library/heapq.html</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg_id: identifier for the package to be removed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing task for </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> from list&quot;</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">REMOVED</span>
            <span class="k">return</span> <span class="n">task</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_requeue_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">:</span> <span class="n">InstallStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requeues a task that appears to be in progress by another process.</span>

<span class="sd">        Args:</span>
<span class="sd">            task (Task): the installation task for a package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BuildStatus</span><span class="o">.</span><span class="n">INSTALLED</span><span class="p">,</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">INSTALLING</span><span class="p">]:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">install_msg</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">install_status</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;in progress by another process&quot;</span>
            <span class="p">)</span>

        <span class="n">new_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">next_attempt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">)</span>
        <span class="n">new_task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">INSTALLING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_push_task</span><span class="p">(</span><span class="n">new_task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_failed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">mark</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the task and transitive dependents as failed; optionally mark</span>
<span class="sd">        externally as failed; and remove associated tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            task: the task for the failed package</span>
<span class="sd">            mark: ``True`` if the package and its dependencies are to</span>
<span class="sd">                be marked as &quot;failed&quot;, otherwise, ``False``</span>
<span class="sd">            exc: optional exception if associated with the failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pkg_id</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flagging </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> as failed</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mark</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="p">[</span><span class="n">pkg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">failure_tracker</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="p">[</span><span class="n">pkg_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">FAILED</span>

        <span class="k">for</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">dependents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping build of </span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> since </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
                <span class="c1"># Ensure the dependent&#39;s uninstalled dependents are</span>
                <span class="c1"># up-to-date and their tasks removed.</span>
                <span class="n">dep_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">[</span><span class="n">dep_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_failed</span><span class="p">(</span><span class="n">dep_task</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_task</span><span class="p">(</span><span class="n">dep_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No task for </span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> to skip since </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_installed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark the task as installed and ensure dependent tasks are aware.</span>

<span class="sd">        Args:</span>
<span class="sd">            task: the task for the installed package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BuildStatus</span><span class="o">.</span><span class="n">INSTALLED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag_installed</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">dependents</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_flag_installed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">dependent_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flag the package as installed and ensure known by all tasks of</span>
<span class="sd">        known dependents.</span>

<span class="sd">        Args:</span>
<span class="sd">            pkg: Package that has been installed locally, externally or upstream</span>
<span class="sd">            dependent_ids: set of the package&#39;s dependent ids, or None if the dependent ids are</span>
<span class="sd">                limited to those maintained in the package (dependency DAG)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="c1"># Already determined the package has been installed</span>
            <span class="k">return</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flagging </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> as installed&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>

        <span class="c1"># Update affected dependents</span>
        <span class="n">dependent_ids</span> <span class="o">=</span> <span class="n">dependent_ids</span> <span class="ow">or</span> <span class="n">get_dependent_ids</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dependent_ids</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2">&#39;s uninstalled dependencies.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span>
                <span class="c1"># Ensure the dependent&#39;s uninstalled dependencies are</span>
                <span class="c1"># up-to-date.  This will require requeueing the task.</span>
                <span class="n">dep_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">[</span><span class="n">dep_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_push_task</span><span class="p">(</span><span class="n">dep_task</span><span class="o">.</span><span class="n">next_attempt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> has no task to update for </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">&#39;s success&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the build queue from the list of build requests.&quot;&quot;&quot;</span>
        <span class="n">all_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing the build queue from the build requests&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_requests</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tasks</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">all_dependencies</span><span class="p">)</span>

        <span class="c1"># Add any missing dependents to ensure proper uninstalled dependency</span>
        <span class="c1"># tracking when installing multiple specs</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ensure all dependencies know all dependents across specs&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="n">all_dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">:</span>
                <span class="n">dependents</span> <span class="o">=</span> <span class="n">all_dependencies</span><span class="p">[</span><span class="n">dep_id</span><span class="p">]</span>
                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tasks</span><span class="p">[</span><span class="n">dep_id</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">dependent_id</span> <span class="ow">in</span> <span class="n">dependents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">dependents</span><span class="p">):</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">add_dependent</span><span class="p">(</span><span class="n">dependent_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_dependencies</span> <span class="o">=</span> <span class="n">all_dependencies</span>

    <span class="k">def</span> <span class="nf">_install_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstallAction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether the installation should be overwritten (if it already</span>
<span class="sd">        exists) or skipped (if has been handled by another process).</span>

<span class="sd">        If the package has not been installed yet, this will indicate that the</span>
<span class="sd">        installation should proceed as normal (i.e. no need to transactionally</span>
<span class="sd">        preserve the old prefix).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we don&#39;t have to overwrite, do a normal install</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">INSTALL</span>

        <span class="c1"># If it&#39;s not installed, do a normal install as well</span>
        <span class="n">rec</span><span class="p">,</span> <span class="n">installed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_db</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">installed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">INSTALL</span>

        <span class="c1"># Ensure install_tree projections have not changed.</span>
        <span class="k">assert</span> <span class="n">rec</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">rec</span><span class="o">.</span><span class="n">path</span>

        <span class="c1"># If another process has overwritten this, we shouldn&#39;t install at all</span>
        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">installation_time</span> <span class="o">&gt;=</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">overwrite_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">NONE</span>

        <span class="c1"># If the install prefix is missing, warn about it, and proceed with</span>
        <span class="c1"># normal install.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Missing installation to overwrite&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">INSTALL</span>

        <span class="c1"># Otherwise, do an actual overwrite install. We backup the original</span>
        <span class="c1"># install directory, put the old prefix</span>
        <span class="c1"># back on failure</span>
        <span class="k">return</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">OVERWRITE</span>

<div class="viewcode-block" id="PackageInstaller.install">
<a class="viewcode-back" href="../../spack.html#spack.installer.PackageInstaller.install">[docs]</a>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Install the requested package(s) and or associated dependencies.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_queue</span><span class="p">()</span>
        <span class="n">fail_fast_err</span> <span class="o">=</span> <span class="s2">&quot;Terminating after first install failure&quot;</span>
        <span class="n">single_requested_spec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_requests</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">failed_build_requests</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">install_status</span> <span class="o">=</span> <span class="n">InstallStatus</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_pq</span><span class="p">))</span>

        <span class="c1"># Only enable the terminal status line when we&#39;re in a tty without debug info</span>
        <span class="c1"># enabled, so that the output does not get cluttered.</span>
        <span class="n">term_status</span> <span class="o">=</span> <span class="n">TermStatusLine</span><span class="p">(</span>
            <span class="n">enabled</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">tty</span><span class="o">.</span><span class="n">msg_enabled</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tty</span><span class="o">.</span><span class="n">is_debug</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_pq</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_task</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">install_args</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_args</span>
            <span class="n">keep_prefix</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_prefix&quot;</span><span class="p">)</span>

            <span class="n">pkg</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span>
            <span class="n">install_status</span><span class="o">.</span><span class="n">next_pkg</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
            <span class="n">install_status</span><span class="o">.</span><span class="n">set_term_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">: task=</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Ensure that the current spec has NO uninstalled dependencies,</span>
            <span class="c1"># which is assumed to be reflected directly in its priority.</span>
            <span class="c1">#</span>
            <span class="c1"># If the spec has uninstalled dependencies, then there must be</span>
            <span class="c1"># a bug in the code (e.g., priority queue or uninstalled</span>
            <span class="c1"># dependencies handling).  So terminate under the assumption that</span>
            <span class="c1"># all subsequent tasks will have non-zero priorities or may be</span>
            <span class="c1"># dependencies of this task.</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">priority</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">term_status</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Detected uninstalled dependencies for </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">uninstalled_deps</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">left</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_id</span> <span class="k">for</span> <span class="n">dep_id</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">uninstalled_deps</span> <span class="k">if</span> <span class="n">dep_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">left</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> does NOT actually have any uninstalled deps left&quot;</span><span class="p">)</span>
                <span class="n">dep_str</span> <span class="o">=</span> <span class="s2">&quot;dependencies&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;dependency&quot;</span>

                <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot proceed with </span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">priority</span><span class="si">}</span><span class="s2"> uninstalled &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dep_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">uninstalled_deps</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Skip the installation if the spec is not being installed locally</span>
            <span class="c1"># (i.e., if external or upstream) BUT flag it as installed since</span>
            <span class="c1"># some package likely depends on it.</span>
            <span class="k">if</span> <span class="n">_handle_external_and_upstream</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">explicit</span><span class="p">):</span>
                <span class="n">term_status</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_flag_installed</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">dependents</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Flag a failed spec.  Do not need an (install) prefix lock since</span>
            <span class="c1"># assume using a separate (failed) prefix lock file.</span>
            <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed</span> <span class="ow">or</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">failure_tracker</span><span class="o">.</span><span class="n">has_failed</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                <span class="n">term_status</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> failed to install&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_failed</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_fast</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span><span class="n">fail_fast_err</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

                <span class="k">continue</span>

            <span class="c1"># Attempt to get a write lock.  If we can&#39;t get the lock then</span>
            <span class="c1"># another process is likely (un)installing the spec or has</span>
            <span class="c1"># determined the spec has already been installed (though the</span>
            <span class="c1"># other process may be hung).</span>
            <span class="n">install_status</span><span class="o">.</span><span class="n">set_term_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acquiring lock for </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">term_status</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="n">ltype</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_locked</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Attempt to get a read lock instead.  If this fails then</span>
                <span class="c1"># another process has a write lock so must be (un)installing</span>
                <span class="c1"># the spec (or that process is hung).</span>
                <span class="n">ltype</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_locked</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
            <span class="c1"># Requeue the spec if we cannot get at least a read lock so we</span>
            <span class="c1"># can check the status presumably established by another process</span>
            <span class="c1"># -- failed, installed, or uninstalled -- on the next pass.</span>
            <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_requeue_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">term_status</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Take a timestamp with the overwrite argument to allow checking</span>
            <span class="c1"># whether another process has already overridden the package.</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">explicit</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">overwrite_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Determine state of installation artifacts and adjust accordingly.</span>
            <span class="n">install_status</span><span class="o">.</span><span class="n">set_term_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_for_install</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="c1"># Flag an already installed package</span>
            <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
                <span class="c1"># Downgrade to a read lock to preclude other processes from</span>
                <span class="c1"># uninstalling the package until we&#39;re done installing its</span>
                <span class="c1"># dependents.</span>
                <span class="n">ltype</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_locked</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_installed</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">debug_padded_filter</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                    <span class="n">_print_installed_pkg</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># At this point we&#39;ve failed to get a write or a read</span>
                    <span class="c1"># lock, which means another process has taken a write</span>
                    <span class="c1"># lock between our releasing the write and acquiring the</span>
                    <span class="c1"># read.</span>
                    <span class="c1">#</span>
                    <span class="c1"># Requeue the task so we can re-check the status</span>
                    <span class="c1"># established by the other process -- failed, installed,</span>
                    <span class="c1"># or uninstalled -- on the next pass.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_requeue_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Having a read lock on an uninstalled pkg may mean another</span>
            <span class="c1"># process completed an uninstall of the software between the</span>
            <span class="c1"># time we failed to acquire the write lock and the time we</span>
            <span class="c1"># took the read lock.</span>
            <span class="c1">#</span>
            <span class="c1"># Requeue the task so we can check the status presumably</span>
            <span class="c1"># established by the other process -- failed, installed, or</span>
            <span class="c1"># uninstalled -- on the next pass.</span>
            <span class="k">if</span> <span class="n">ltype</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span><span class="p">:</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">release_read</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_requeue_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Proceed with the installation since we have an exclusive write</span>
            <span class="c1"># lock on the package.</span>
            <span class="n">install_status</span><span class="o">.</span><span class="n">set_term_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_action</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">INSTALL</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_install_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">OVERWRITE</span><span class="p">:</span>
                    <span class="c1"># spack.store.STORE.db is not really a Database object, but a small</span>
                    <span class="c1"># wrapper -- silence mypy</span>
                    <span class="n">OverwriteInstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">)</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>  <span class="c1"># type: ignore[arg-type] # noqa: E501</span>

                <span class="c1"># If we installed then we should keep the prefix</span>
                <span class="n">stop_before_phase</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;stop_before_phase&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">last_phase</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;last_phase&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">keep_prefix</span> <span class="o">=</span> <span class="n">keep_prefix</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stop_before_phase</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># The build has been terminated with a Ctrl-C so terminate</span>
                <span class="c1"># regardless of the number of remaining specs.</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to install </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> due to &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span>

            <span class="k">except</span> <span class="n">binary_distribution</span><span class="o">.</span><span class="n">NoChecksumException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">cache_only</span><span class="p">:</span>
                    <span class="k">raise</span>

                <span class="c1"># Checking hash on downloaded binary failed.</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to install </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> from binary cache due &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">: Requeueing to install from source.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># this overrides a full method, which is ugly.</span>
                <span class="n">task</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># type: ignore[misc]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_requeue_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">install_status</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_failed</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

                <span class="c1"># Best effort installs suppress the exception and mark the</span>
                <span class="c1"># package as a failure.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SpackError</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">exc</span><span class="o">.</span><span class="n">printed</span><span class="p">:</span>  <span class="c1"># type: ignore[union-attr] # noqa: E501</span>
                    <span class="n">exc</span><span class="o">.</span><span class="n">printed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[union-attr]</span>
                    <span class="c1"># SpackErrors can be printed by the build process or at</span>
                    <span class="c1"># lower levels -- skip printing if already printed.</span>
                    <span class="c1"># TODO: sort out this and SpackError.print_context()</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to install </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> due to &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Terminate if requested to do so on the first failure.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_fast</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fail_fast_err</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

                <span class="c1"># Terminate when a single build request has failed, or summarize errors later.</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">is_build_request</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">single_requested_spec</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="n">failed_build_requests</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pkg</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Remove the install prefix if anything went wrong during</span>
                <span class="c1"># install.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">action</span> <span class="o">==</span> <span class="n">InstallAction</span><span class="o">.</span><span class="n">OVERWRITE</span><span class="p">:</span>
                    <span class="n">pkg</span><span class="o">.</span><span class="n">remove_prefix</span><span class="p">()</span>

            <span class="c1"># Perform basic task cleanup for the installed spec to</span>
            <span class="c1"># include downgrading the write to a read lock</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_task</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># Cleanup, which includes releasing all of the read locks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_all_tasks</span><span class="p">()</span>

        <span class="c1"># Ensure we properly report if one or more explicit specs failed</span>
        <span class="c1"># or were not installed when should have been.</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_requests</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;install_package&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">failed_build_requests</span> <span class="ow">or</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">failed_build_requests</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2">: Package was not installed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_build_requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pkg</span> <span class="o">=</span> <span class="n">failed_build_requests</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pkg_id</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">failed_build_requests</span><span class="p">]</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Associating installation failure with first failed &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;explicit package (</span><span class="si">{</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pkg</span> <span class="o">=</span> <span class="n">missing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pkg_id</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pkg_id</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">]</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Associating installation failure with first &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;missing package (</span><span class="si">{</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">(</span>
                <span class="s2">&quot;Installation request failed.  Refer to reported errors for failing package(s).&quot;</span><span class="p">,</span>
                <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="BuildProcessInstaller">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildProcessInstaller">[docs]</a>
<span class="k">class</span> <span class="nc">BuildProcessInstaller</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class implements the part installation that happens in the child process.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">install_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new BuildProcessInstaller.</span>

<span class="sd">        It is assumed that the lifecycle of this object is the same as the child</span>
<span class="sd">        process in the build.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pkg: the package being installed.</span>
<span class="sd">            install_args: arguments to the installer from parent process.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg</span>

        <span class="c1"># whether to do a fake install</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># whether to install source code with the packag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_source</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;install_source&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">is_develop</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">is_develop</span>
        <span class="c1"># whether to keep the build stage after installation</span>
        <span class="c1"># Note: user commands do not have an explicit choice to disable</span>
        <span class="c1"># keeping stages (i.e., we have a --keep-stage option, but not</span>
        <span class="c1"># a --destroy-stage option), so we can override a default choice</span>
        <span class="c1"># to destroy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_stage</span> <span class="o">=</span> <span class="n">is_develop</span> <span class="ow">or</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_stage&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># whether to restage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restage</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_develop</span><span class="p">)</span> <span class="ow">and</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restage&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># whether to skip the patch phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_patch</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_patch&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># whether to enable echoing of build output initially or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="c1"># whether installation was explicitly requested by the user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;explicit&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># env before starting installation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmodified_env</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unmodified_env&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># env modifications by Spack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_mods</span> <span class="o">=</span> <span class="n">install_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;env_modifications&quot;</span><span class="p">,</span> <span class="n">EnvironmentModifications</span><span class="p">())</span>

        <span class="c1"># timer for build phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>

        <span class="c1"># If we are using a padded path, filter the output to compress padded paths</span>
        <span class="c1"># The real log still has full-length paths.</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:install_tree:padded_length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_fn</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">padding_filter</span> <span class="k">if</span> <span class="n">padding</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># info/debug information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">_log_prefix</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

<div class="viewcode-block" id="BuildProcessInstaller.run">
<a class="viewcode-back" href="../../spack.html#spack.installer.BuildProcessInstaller.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main entry point from ``build_process`` to kick off install in child.&quot;&quot;&quot;</span>

        <span class="n">stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">stage</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">keep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_stage</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restage</span><span class="p">:</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">stage</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_patch</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">do_patch</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">do_stage</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">)</span>

            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="si">}</span><span class="s2"> Building </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">build_system_class</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># type: ignore[attr-defined] # noqa: E501</span>
            <span class="p">)</span>

            <span class="c1"># get verbosity from install parameter or saved value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="o">.</span><span class="n">_verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="o">.</span><span class="n">_verbose</span>

            <span class="c1"># Run the pre-install hook in the child process after</span>
            <span class="c1"># the directory is created.</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">pre_install</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake</span><span class="p">:</span>
                <span class="n">_do_fake_install</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_source</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_install_source</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_real_install</span><span class="p">()</span>

            <span class="c1"># Run post install hooks before build stage is removed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;post-install&quot;</span><span class="p">)</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">post_install</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;post-install&quot;</span><span class="p">)</span>

            <span class="c1"># Stop the timer and save results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">_write_timer_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">print_install_test_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">)</span>
        <span class="n">_print_timer</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">pkg_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>
        <span class="n">_print_installed_pkg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

        <span class="c1"># preserve verbosity across runs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo</span></div>


    <span class="k">def</span> <span class="nf">_install_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Install source code from stage into share/pkg/src if necessary.&quot;&quot;&quot;</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">src_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;share&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="si">}</span><span class="s2"> Copying source to </span><span class="si">{</span><span class="n">src_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">fs</span><span class="o">.</span><span class="n">install_tree</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="p">,</span> <span class="n">src_target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_real_install</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">spack.builder</span>

        <span class="n">pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg</span>

        <span class="c1"># Do the real install in the source directory.</span>
        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="p">):</span>
            <span class="c1"># Save the build environment in a file before building.</span>
            <span class="n">dump_environment</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">env_path</span><span class="p">)</span>

            <span class="c1"># Save just the changes to the environment.  This file can be</span>
            <span class="c1"># safely installed, since it does not contain secret variables.</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">env_mods_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_mods_file</span><span class="p">:</span>
                <span class="n">mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_mods</span><span class="o">.</span><span class="n">shell_modifications</span><span class="p">(</span><span class="n">explicit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unmodified_env</span><span class="p">)</span>
                <span class="n">env_mods_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;configure_args&quot;</span><span class="p">,</span> <span class="s2">&quot;cmake_args&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">configure_args</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">attr</span><span class="p">)()</span>
                    <span class="n">configure_args</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configure_args</span><span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">configure_args_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">args_file</span><span class="p">:</span>
                        <span class="n">args_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configure_args</span><span class="p">)</span>

                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># cache debug settings</span>
            <span class="n">debug_level</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">debug_level</span><span class="p">()</span>

            <span class="c1"># Spawn a daemon that reads from a pipe and redirects</span>
            <span class="c1"># everything to log_path, and provide the phase for logging</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phase_fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">builder</span><span class="p">):</span>
                <span class="c1"># Keep a log file for each phase</span>
                <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>
                <span class="n">log_file</span> <span class="o">=</span> <span class="s2">&quot;spack-build-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%s</span><span class="s2">-out.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_fn</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># DEBUGGING TIP - to debug this section, insert an IPython</span>
                    <span class="c1"># embed here, and run the sections below without log capture</span>
                    <span class="n">log_contextmanager</span> <span class="o">=</span> <span class="n">log_output</span><span class="p">(</span>
                        <span class="n">log_file</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span><span class="p">,</span>
                        <span class="kc">True</span><span class="p">,</span>
                        <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unmodified_env</span><span class="p">,</span>
                        <span class="n">filter_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_fn</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">with</span> <span class="n">log_contextmanager</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>
                        <span class="c1"># Redirect stdout and stderr to daemon pipe</span>
                        <span class="k">with</span> <span class="n">logger</span><span class="o">.</span><span class="n">force_echo</span><span class="p">():</span>
                            <span class="n">inner_debug_level</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">debug_level</span><span class="p">()</span>
                            <span class="n">tty</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">debug_level</span><span class="p">)</span>
                            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="si">}</span><span class="s2"> Executing phase: &#39;</span><span class="si">{</span><span class="n">phase_fn</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                            <span class="n">tty</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">inner_debug_level</span><span class="p">)</span>

                        <span class="c1"># Catch any errors to report to logging</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phase_fn</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">phase_fn</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">phase_fn</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">combine_phase_logs</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">phase_log_files</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="c1"># We assume loggers share echo True/False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">echo</span>

        <span class="c1"># After log, we can get all output/error files from the package stage</span>
        <span class="n">combine_phase_logs</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">phase_log_files</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span></div>



<div class="viewcode-block" id="build_process">
<a class="viewcode-back" href="../../spack.html#spack.installer.build_process">[docs]</a>
<span class="k">def</span> <span class="nf">build_process</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="s2">&quot;spack.package_base.PackageBase&quot;</span><span class="p">,</span> <span class="n">install_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform the installation/build of the package.</span>

<span class="sd">    This runs in a separate child process, and has its own process and</span>
<span class="sd">    python module space set up by build_environment.start_build_process().</span>

<span class="sd">    This essentially wraps an instance of ``BuildProcessInstaller`` so that we can</span>
<span class="sd">    more easily create one in a subprocess.</span>

<span class="sd">    This function&#39;s return value is returned to the parent process.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        pkg: the package being installed.</span>
<span class="sd">        install_args: arguments to installer from parent process.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">installer</span> <span class="o">=</span> <span class="n">BuildProcessInstaller</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">install_args</span><span class="p">)</span>

    <span class="c1"># don&#39;t print long padded paths in executable debug output.</span>
    <span class="k">with</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">filter_padding</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">installer</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>



<div class="viewcode-block" id="deprecate">
<a class="viewcode-back" href="../../spack.html#spack.installer.deprecate">[docs]</a>
<span class="k">def</span> <span class="nf">deprecate</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">deprecator</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">link_fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deprecate this package in favor of deprecator spec&quot;&quot;&quot;</span>
    <span class="c1"># Here we assume we don&#39;t deprecate across different stores, and that same hash</span>
    <span class="c1"># means same binary artifacts</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="o">==</span> <span class="n">deprecator</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="c1"># We can&#39;t really have control over external specs, and cannot link anything in their place</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Install deprecator if it isn&#39;t installed already</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">deprecator</span><span class="p">):</span>
        <span class="n">PackageInstaller</span><span class="p">([</span><span class="n">deprecator</span><span class="o">.</span><span class="n">package</span><span class="p">],</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>

    <span class="n">old_deprecator</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deprecator</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">old_deprecator</span><span class="p">:</span>
        <span class="c1"># Find this spec file from its old deprecation</span>
        <span class="n">specfile</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">deprecated_file_path</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">old_deprecator</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">specfile</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">spec_file_path</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="c1"># copy spec metadata to &quot;deprecated&quot; dir of deprecator</span>
    <span class="n">depr_specfile</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">deprecated_file_path</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">deprecator</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">depr_specfile</span><span class="p">))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">specfile</span><span class="p">,</span> <span class="n">depr_specfile</span><span class="p">)</span>

    <span class="c1"># Any specs deprecated in favor of this spec are re-deprecated in favor of its new deprecator</span>
    <span class="k">for</span> <span class="n">deprecated</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">specs_deprecated_by</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
        <span class="n">deprecate</span><span class="p">(</span><span class="n">deprecated</span><span class="p">,</span> <span class="n">deprecator</span><span class="p">,</span> <span class="n">link_fn</span><span class="p">)</span>

    <span class="c1"># Now that we&#39;ve handled metadata, uninstall and replace with link</span>
    <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="o">.</span><span class="n">uninstall_by_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deprecator</span><span class="o">=</span><span class="n">deprecator</span><span class="p">)</span>
    <span class="n">link_fn</span><span class="p">(</span><span class="n">deprecator</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span></div>



<div class="viewcode-block" id="OverwriteInstall">
<a class="viewcode-back" href="../../spack.html#spack.installer.OverwriteInstall">[docs]</a>
<span class="k">class</span> <span class="nc">OverwriteInstall</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">installer</span><span class="p">:</span> <span class="n">PackageInstaller</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Database</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
        <span class="n">install_status</span><span class="p">:</span> <span class="n">InstallStatus</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installer</span> <span class="o">=</span> <span class="n">installer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_status</span> <span class="o">=</span> <span class="n">install_status</span>

<div class="viewcode-block" id="OverwriteInstall.install">
<a class="viewcode-back" href="../../spack.html#spack.installer.OverwriteInstall.install">[docs]</a>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to run the install task overwriting the package prefix.</span>
<span class="sd">        If this fails, try to recover the original install prefix. If that fails</span>
<span class="sd">        too, mark the spec as uninstalled. This function always the original</span>
<span class="sd">        install error if installation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">replace_directory_transaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">installer</span><span class="o">.</span><span class="n">_install_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_status</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">fs</span><span class="o">.</span><span class="n">CouldNotRestoreDirectoryBackup</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Recovery of install dir of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> failed due to &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">outer_exception</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">outer_exception</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;The spec is now uninstalled.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Unwrap the actual installation exception.</span>
            <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">inner_exception</span></div>
</div>



<div class="viewcode-block" id="BadInstallPhase">
<a class="viewcode-back" href="../../spack.html#spack.installer.BadInstallPhase">[docs]</a>
<span class="k">class</span> <span class="nc">BadInstallPhase</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised for an install phase option is not allowed for a package.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">&#39; is not a valid phase for package </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="ExternalPackageError">
<a class="viewcode-back" href="../../spack.html#spack.installer.ExternalPackageError">[docs]</a>
<span class="k">class</span> <span class="nc">ExternalPackageError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised by install() when a package is only for external use.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="InstallLockError">
<a class="viewcode-back" href="../../spack.html#spack.installer.InstallLockError">[docs]</a>
<span class="k">class</span> <span class="nc">InstallLockError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised during install when something goes wrong with package locking.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="UpstreamPackageError">
<a class="viewcode-back" href="../../spack.html#spack.installer.UpstreamPackageError">[docs]</a>
<span class="k">class</span> <span class="nc">UpstreamPackageError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">InstallError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised during install when something goes wrong with an upstream</span>
<span class="sd">    package.&quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>