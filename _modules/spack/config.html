

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.config &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.config</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.config</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="sd">&quot;&quot;&quot;This module implements Spack&#39;s configuration file handling.</span>

<span class="sd">This implements Spack&#39;s configuration system, which handles merging</span>
<span class="sd">multiple scopes with different levels of precedence.  See the</span>
<span class="sd">documentation on :ref:`configuration-scopes` for details on how Spack&#39;s</span>
<span class="sd">configuration system behaves.  The scopes are:</span>

<span class="sd">  #. ``default``</span>
<span class="sd">  #. ``system``</span>
<span class="sd">  #. ``site``</span>
<span class="sd">  #. ``user``</span>

<span class="sd">And corresponding :ref:`per-platform scopes &lt;platform-scopes&gt;`. Important</span>
<span class="sd">functions in this module are:</span>

<span class="sd">* :func:`~spack.config.Configuration.get_config`</span>
<span class="sd">* :func:`~spack.config.Configuration.update_config`</span>

<span class="sd">``get_config`` reads in YAML data for a particular scope and returns</span>
<span class="sd">it. Callers can then modify the data and write it back with</span>
<span class="sd">``update_config``.</span>

<span class="sd">When read in, Spack validates configurations with jsonschemas.  The</span>
<span class="sd">schemas are in submodules of :py:mod:`spack.schema`.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">llnl.util</span> <span class="kn">import</span> <span class="n">filesystem</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">tty</span>

<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.paths</span>
<span class="kn">import</span> <span class="nn">spack.platforms</span>
<span class="kn">import</span> <span class="nn">spack.schema</span>
<span class="kn">import</span> <span class="nn">spack.schema.bootstrap</span>
<span class="kn">import</span> <span class="nn">spack.schema.cdash</span>
<span class="kn">import</span> <span class="nn">spack.schema.ci</span>
<span class="kn">import</span> <span class="nn">spack.schema.compilers</span>
<span class="kn">import</span> <span class="nn">spack.schema.concretizer</span>
<span class="kn">import</span> <span class="nn">spack.schema.config</span>
<span class="kn">import</span> <span class="nn">spack.schema.definitions</span>
<span class="kn">import</span> <span class="nn">spack.schema.develop</span>
<span class="kn">import</span> <span class="nn">spack.schema.env</span>
<span class="kn">import</span> <span class="nn">spack.schema.mirrors</span>
<span class="kn">import</span> <span class="nn">spack.schema.modules</span>
<span class="kn">import</span> <span class="nn">spack.schema.packages</span>
<span class="kn">import</span> <span class="nn">spack.schema.repos</span>
<span class="kn">import</span> <span class="nn">spack.schema.upstreams</span>
<span class="kn">import</span> <span class="nn">spack.schema.view</span>

<span class="c1"># Hacked yaml for configuration files preserves line numbers.</span>
<span class="kn">import</span> <span class="nn">spack.util.spack_yaml</span> <span class="k">as</span> <span class="nn">syaml</span>
<span class="kn">import</span> <span class="nn">spack.util.web</span> <span class="k">as</span> <span class="nn">web_util</span>
<span class="kn">from</span> <span class="nn">spack.util.cpus</span> <span class="kn">import</span> <span class="n">cpus_available</span>

<span class="c1">#: Dict from section names -&gt; schema for that section</span>
<span class="n">SECTION_SCHEMAS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;compilers&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;concretizer&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">concretizer</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;definitions&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">definitions</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;view&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;develop&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">develop</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">mirrors</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;repos&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;packages&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;modules&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;upstreams&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">upstreams</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;bootstrap&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">bootstrap</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;ci&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ci</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
    <span class="s2">&quot;cdash&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">cdash</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Same as above, but including keys for environments</span>
<span class="c1"># this allows us to unify config reading between configs and environments</span>
<span class="n">_ALL_SCHEMAS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">SECTION_SCHEMAS</span><span class="p">)</span>
<span class="n">_ALL_SCHEMAS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">TOP_LEVEL_KEY</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">schema</span><span class="p">})</span>

<span class="c1">#: Path to the default configuration</span>
<span class="n">CONFIGURATION_DEFAULTS_PATH</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;defaults&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">etc_path</span><span class="p">,</span> <span class="s2">&quot;defaults&quot;</span><span class="p">))</span>

<span class="c1">#: Hard-coded default values for some key configuration options.</span>
<span class="c1">#: This ensures that Spack will still work even if config.yaml in</span>
<span class="c1">#: the defaults scope is removed.</span>
<span class="n">CONFIG_DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;connect_timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;verify_ssl&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;checksum&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;dirty&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;build_jobs&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">cpus_available</span><span class="p">()),</span>
        <span class="s2">&quot;build_stage&quot;</span><span class="p">:</span> <span class="s2">&quot;$tempdir/spack-stage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;license_dir&quot;</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">default_license_dir</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">#: metavar to use for commands that accept scopes</span>
<span class="c1">#: this is shorter and more readable than listing all choices</span>
<span class="n">SCOPES_METAVAR</span> <span class="o">=</span> <span class="s2">&quot;{defaults,system,site,user,command_line}[/PLATFORM] or env:ENVIRONMENT&quot;</span>

<span class="c1">#: Base name for the (internal) overrides scope.</span>
<span class="n">_OVERRIDES_BASE_NAME</span> <span class="o">=</span> <span class="s2">&quot;overrides-&quot;</span>

<span class="c1">#: Type used for raw YAML configuration</span>
<span class="n">YamlConfigDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>


<div class="viewcode-block" id="ConfigScope">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigScope">[docs]</a>
<span class="k">class</span> <span class="nc">ConfigScope</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">()</span>

<div class="viewcode-block" id="ConfigScope.get_section_filename">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigScope.get_section_filename">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ConfigScope.get_section">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigScope.get_section">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="k">def</span> <span class="nf">_write_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_platform_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="ConfigScope.clear">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigScope.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Empty cached config information.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;ConfigScope: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span></div>



<div class="viewcode-block" id="DirectoryConfigScope">
<a class="viewcode-back" href="../../spack.html#spack.config.DirectoryConfigScope">[docs]</a>
<span class="k">class</span> <span class="nc">DirectoryConfigScope</span><span class="p">(</span><span class="n">ConfigScope</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Config scope backed by a directory containing one file per section.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">writable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">writable</span>

<div class="viewcode-block" id="DirectoryConfigScope.get_section_filename">
<a class="viewcode-back" href="../../spack.html#spack.config.DirectoryConfigScope.get_section_filename">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the filename associated with a given section&quot;&quot;&quot;</span>
        <span class="n">_validate_section_name</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DirectoryConfigScope.get_section">
<a class="viewcode-back" href="../../spack.html#spack.config.DirectoryConfigScope.get_section">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the data associated with a given section&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_filename</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">SECTION_SCHEMAS</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">read_config_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_write_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">writable</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot write to immutable scope </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_filename</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SECTION_SCHEMAS</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">filesystem</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">syaml</span><span class="o">.</span><span class="n">dump_config</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">syaml</span><span class="o">.</span><span class="n">SpackYAMLError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigFileError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot write to &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_platform_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns true if the scope name is platform specific&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>



<div class="viewcode-block" id="SingleFileScope">
<a class="viewcode-back" href="../../spack.html#spack.config.SingleFileScope">[docs]</a>
<span class="k">class</span> <span class="nc">SingleFileScope</span><span class="p">(</span><span class="n">ConfigScope</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class represents a configuration scope in a single YAML file.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">YamlConfigDict</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">yaml_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">writable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Similar to ``ConfigScope`` but can be embedded in another schema.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            schema (dict): jsonschema for the file to read</span>
<span class="sd">            yaml_path (list): path in the schema where config data can be</span>
<span class="sd">                found.</span>

<span class="sd">                If the schema accepts the following yaml data, the yaml_path</span>
<span class="sd">                would be [&#39;outer&#39;, &#39;inner&#39;]</span>

<span class="sd">                .. code-block:: yaml</span>

<span class="sd">                   outer:</span>
<span class="sd">                     inner:</span>
<span class="sd">                       config:</span>
<span class="sd">                         install_tree: $spack/opt/spack</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">writable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yaml_path</span> <span class="o">=</span> <span class="n">yaml_path</span> <span class="ow">or</span> <span class="p">[]</span>

<div class="viewcode-block" id="SingleFileScope.get_section_filename">
<a class="viewcode-back" href="../../spack.html#spack.config.SingleFileScope.get_section_filename">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span></div>


<div class="viewcode-block" id="SingleFileScope.get_section">
<a class="viewcode-back" href="../../spack.html#spack.config.SingleFileScope.get_section">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]:</span>
        <span class="c1"># read raw data from the file, which looks like:</span>
        <span class="c1"># {</span>
        <span class="c1">#   &#39;config&#39;: {</span>
        <span class="c1">#      ... data ...</span>
        <span class="c1">#   },</span>
        <span class="c1">#   &#39;packages&#39;: {</span>
        <span class="c1">#      ... data ...</span>
        <span class="c1">#   },</span>
        <span class="c1"># }</span>
        <span class="c1">#</span>
        <span class="c1"># To preserve overrides up to the section level (e.g. to override</span>
        <span class="c1"># the &quot;packages&quot; section with the &quot;::&quot; syntax), data in self.sections</span>
        <span class="c1"># looks like this:</span>
        <span class="c1"># {</span>
        <span class="c1">#   &#39;config&#39;: {</span>
        <span class="c1">#      &#39;config&#39;: {</span>
        <span class="c1">#         ... data ...</span>
        <span class="c1">#       }</span>
        <span class="c1">#   },</span>
        <span class="c1">#   &#39;packages&#39;: {</span>
        <span class="c1">#      &#39;packages&#39;: {</span>
        <span class="c1">#         ... data ...</span>
        <span class="c1">#      }</span>
        <span class="c1">#   }</span>
        <span class="c1"># }</span>

        <span class="c1"># This bit ensures we have read the file and have</span>
        <span class="c1"># the raw data in memory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span> <span class="o">=</span> <span class="n">read_config_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Here we know we have the raw data and ensure we</span>
        <span class="c1"># populate the sections dictionary, which may be</span>
        <span class="c1"># cleared by the clear() method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">section_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">section_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">section_data</span> <span class="o">=</span> <span class="n">section_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">section_key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">section_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">section_key</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_write_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">writable</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot write to immutable scope </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data_to_write</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span>

        <span class="c1"># If there is no existing data, this section SingleFileScope has never</span>
        <span class="c1"># been written to disk. We need to construct the portion of the data</span>
        <span class="c1"># from the root of self._raw_data to the level at which the config</span>
        <span class="c1"># sections are defined. That requires creating keys for every entry in</span>
        <span class="c1"># self.yaml_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_to_write</span><span class="p">:</span>
            <span class="n">data_to_write</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># reverse because we construct it from the inside out</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml_path</span><span class="p">):</span>
                <span class="n">data_to_write</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data_to_write</span><span class="p">}</span>

        <span class="c1"># data_update_pointer is a pointer to the part of data_to_write</span>
        <span class="c1"># that we are currently updating.</span>
        <span class="c1"># We start by traversing into the data to the point at which the</span>
        <span class="c1"># config sections are defined. This means popping the keys from</span>
        <span class="c1"># self.yaml_path</span>
        <span class="n">data_update_pointer</span> <span class="o">=</span> <span class="n">data_to_write</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml_path</span><span class="p">:</span>
            <span class="n">data_update_pointer</span> <span class="o">=</span> <span class="n">data_update_pointer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># For each section, update the data at the level of our pointer</span>
        <span class="c1"># with the data from the section</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data_update_pointer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">validate</span><span class="p">(</span><span class="n">data_to_write</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">filesystem</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">.tmp&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">syaml</span><span class="o">.</span><span class="n">dump_config</span><span class="p">(</span><span class="n">data_to_write</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">filesystem</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">syaml</span><span class="o">.</span><span class="n">SpackYAMLError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigFileError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot write to config file </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;SingleFileScope: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&gt;&quot;</span></div>



<div class="viewcode-block" id="InternalConfigScope">
<a class="viewcode-back" href="../../spack.html#spack.config.InternalConfigScope">[docs]</a>
<span class="k">class</span> <span class="nc">InternalConfigScope</span><span class="p">(</span><span class="n">ConfigScope</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An internal configuration scope that is not persisted to a file.</span>

<span class="sd">    This is for spack internal use so that command-line options and</span>
<span class="sd">    config file settings are accessed the same way, and Spack can easily</span>
<span class="sd">    override settings from files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">InternalConfigScope</span><span class="o">.</span><span class="n">_process_dict_keyname_overrides</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">dsec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
                <span class="n">validate</span><span class="p">({</span><span class="n">section</span><span class="p">:</span> <span class="n">dsec</span><span class="p">},</span> <span class="n">SECTION_SCHEMAS</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mark_internal</span><span class="p">(</span><span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">({</span><span class="n">section</span><span class="p">:</span> <span class="n">dsec</span><span class="p">}),</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="InternalConfigScope.get_section">
<a class="viewcode-back" href="../../spack.html#spack.config.InternalConfigScope.get_section">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Just reads from an internal dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_write_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This only validates, as the data is already in memory.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SECTION_SCHEMAS</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mark_internal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;InternalConfigScope: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="InternalConfigScope.clear">
<a class="viewcode-back" href="../../spack.html#spack.config.InternalConfigScope.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># no cache to clear here.</span>
        <span class="k">pass</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_process_dict_keyname_overrides</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">YamlConfigDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YamlConfigDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Turn a trailing `:&#39; in a key name into an override attribute.&quot;&quot;&quot;</span>
        <span class="c1"># Below we have a lot of type directives, since we hack on types and monkey-patch them</span>
        <span class="c1"># by adding attributes that otherwise they won&#39;t have.</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">YamlConfigDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sv</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sk</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_str</span><span class="p">(</span><span class="n">sk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">key</span><span class="o">.</span><span class="n">override</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">elif</span> <span class="n">sk</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_str</span><span class="p">(</span><span class="n">sk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">key</span><span class="o">.</span><span class="n">prepend</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">elif</span> <span class="n">sk</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_str</span><span class="p">(</span><span class="n">sk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">key</span><span class="o">.</span><span class="n">append</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">sk</span>  <span class="c1"># type: ignore[assignment]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sv</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">InternalConfigScope</span><span class="o">.</span><span class="n">_process_dict_keyname_overrides</span><span class="p">(</span><span class="n">sv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>



<span class="k">def</span> <span class="nf">_config_mutator</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to mark all the methods in the Configuration class</span>
<span class="sd">    that mutate the underlying configuration. Used to clear the</span>
<span class="sd">    memoization cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_memoized</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_method</span>


<div class="viewcode-block" id="Configuration">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration">[docs]</a>
<span class="k">class</span> <span class="nc">Configuration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A full Spack configuration, from a hierarchy of config files.</span>

<span class="sd">    This class makes it easy to add a new scope on top of an existing one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># convert to typing.OrderedDict when we drop 3.6, or OrderedDict when we reach 3.9</span>
    <span class="n">scopes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConfigScope</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">scopes</span><span class="p">:</span> <span class="n">ConfigScope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a configuration with an initial list of scopes.</span>

<span class="sd">        Args:</span>
<span class="sd">            scopes: list of scopes to add to this</span>
<span class="sd">                Configuration, ordered from lowest to highest precedence</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">scopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_updates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">]]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<div class="viewcode-block" id="Configuration.ensure_unwrapped">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.ensure_unwrapped">[docs]</a>
    <span class="k">def</span> <span class="nf">ensure_unwrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Configuration&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure we unwrap this object from any dynamic wrapper (like Singleton)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Configuration.highest">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.highest">[docs]</a>
    <span class="k">def</span> <span class="nf">highest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfigScope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scope with highest precedence&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Configuration.ensure_scope_ordering">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.ensure_scope_ordering">[docs]</a>
    <span class="nd">@_config_mutator</span>
    <span class="k">def</span> <span class="nf">ensure_scope_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure that scope order matches documented precedent&quot;&quot;&quot;</span>
        <span class="c1"># FIXME: We also need to consider that custom configurations and other orderings</span>
        <span class="c1"># may not be preserved correctly</span>
        <span class="k">if</span> <span class="s2">&quot;command_line&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
            <span class="c1"># TODO (when dropping python 3.6): self.scopes.move_to_end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">[</span><span class="s2">&quot;command_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_scope</span><span class="p">(</span><span class="s2">&quot;command_line&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Configuration.push_scope">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.push_scope">[docs]</a>
    <span class="nd">@_config_mutator</span>
    <span class="k">def</span> <span class="nf">push_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">ConfigScope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a higher precedence scope to the Configuration.&quot;&quot;&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CONFIGURATION: PUSH SCOPE]: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">[</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope</span></div>


<div class="viewcode-block" id="Configuration.pop_scope">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.pop_scope">[docs]</a>
    <span class="nd">@_config_mutator</span>
    <span class="k">def</span> <span class="nf">pop_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfigScope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the highest precedence scope and return it.&quot;&quot;&quot;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CONFIGURATION: POP SCOPE]: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scope</span></div>


<div class="viewcode-block" id="Configuration.remove_scope">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.remove_scope">[docs]</a>
    <span class="nd">@_config_mutator</span>
    <span class="k">def</span> <span class="nf">remove_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove scope by name; has no effect when ``scope_name`` does not exist&quot;&quot;&quot;</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CONFIGURATION: POP SCOPE]: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scope</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">writable_scopes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generator of writable scopes with an associated file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">writable</span><span class="p">)</span>

<div class="viewcode-block" id="Configuration.highest_precedence_scope">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.highest_precedence_scope">[docs]</a>
    <span class="k">def</span> <span class="nf">highest_precedence_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfigScope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writable scope with highest precedence.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">writable</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Configuration.highest_precedence_non_platform_scope">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.highest_precedence_non_platform_scope">[docs]</a>
    <span class="k">def</span> <span class="nf">highest_precedence_non_platform_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfigScope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writable non-platform scope with highest precedence&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">s</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">writable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">is_platform_dependent</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Configuration.matching_scopes">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.matching_scopes">[docs]</a>
    <span class="k">def</span> <span class="nf">matching_scopes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of all scopes whose names match the provided regular expression.</span>

<span class="sd">        For example, matching_scopes(r&#39;^command&#39;) will return all scopes</span>
<span class="sd">        whose names begin with `command`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">reg_expr</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span></div>


    <span class="k">def</span> <span class="nf">_validate_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ConfigScope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure that scope is valid in this configuration.</span>

<span class="sd">        This should be used by routines in ``config.py`` to validate</span>
<span class="sd">        scope name arguments, and to determine a default scope where no</span>
<span class="sd">        scope is specified.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if ``scope`` is not valid</span>

<span class="sd">        Returns:</span>
<span class="sd">            ConfigScope: a valid ConfigScope if ``scope`` is ``None`` or valid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># default to the scope with highest precedence.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">highest_precedence_scope</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid config scope: &#39;</span><span class="si">{</span><span class="n">scope</span><span class="si">}</span><span class="s2">&#39;.  Must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Configuration.get_config_filename">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.get_config_filename">[docs]</a>
    <span class="k">def</span> <span class="nf">get_config_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For some scope and section, get the name of the configuration file.&quot;&quot;&quot;</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_section_filename</span><span class="p">(</span><span class="n">section</span><span class="p">)</span></div>


<div class="viewcode-block" id="Configuration.clear_caches">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.clear_caches">[docs]</a>
    <span class="nd">@_config_mutator</span>
    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clears the caches for configuration files,</span>

<span class="sd">        This will cause files to be re-read upon the next request.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">scope</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="Configuration.update_config">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.update_config">[docs]</a>
    <span class="nd">@_config_mutator</span>
    <span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">update_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the configuration file for a particular scope.</span>

<span class="sd">        Overwrites contents of a section in a scope with update_data,</span>
<span class="sd">        then writes out the config file.</span>

<span class="sd">        update_data should have the top-level section name stripped off</span>
<span class="sd">        (it will be re-added).  Data itself can be a list, dict, or any</span>
<span class="sd">        other yaml-ish structure.</span>

<span class="sd">        Configuration scopes that are still written in an old schema</span>
<span class="sd">        format will fail to update unless ``force`` is True.</span>

<span class="sd">        Args:</span>
<span class="sd">            section: section of the configuration to be updated</span>
<span class="sd">            update_data: data to be used for the update</span>
<span class="sd">            scope: scope to be updated</span>
<span class="sd">            force: force the update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_updates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The &quot;</span><span class="si">{0}</span><span class="s1">&quot; section of the configuration needs to be written&#39;</span>
                <span class="s2">&quot; to disk, but is currently using a deprecated format. &quot;</span>
                <span class="s2">&quot;Please update it using:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">spack config [--scope=&lt;scope&gt;] update </span><span class="si">{0}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Note that previous versions of Spack will not be able to &quot;</span>
                <span class="s2">&quot;use the updated configuration.&quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">_validate_section_name</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>  <span class="c1"># validate section name</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>  <span class="c1"># get ConfigScope object</span>

        <span class="c1"># manually preserve comments</span>
        <span class="n">need_comment_copy</span> <span class="o">=</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">scope</span><span class="o">.</span><span class="n">sections</span> <span class="ow">and</span> <span class="n">scope</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">need_comment_copy</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">extract_comments</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">section</span><span class="p">])</span>

        <span class="c1"># read only the requested section&#39;s data.</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">({</span><span class="n">section</span><span class="p">:</span> <span class="n">update_data</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">need_comment_copy</span> <span class="ow">and</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">syaml</span><span class="o">.</span><span class="n">set_comments</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">section</span><span class="p">],</span> <span class="n">data_comments</span><span class="o">=</span><span class="n">comments</span><span class="p">)</span>

        <span class="n">scope</span><span class="o">.</span><span class="n">_write_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span></div>


<div class="viewcode-block" id="Configuration.get_config">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.get_config">[docs]</a>
    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YamlConfigDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get configuration settings for a section.</span>

<span class="sd">        If ``scope`` is ``None`` or not provided, return the merged contents</span>
<span class="sd">        of all of Spack&#39;s configuration scopes.  If ``scope`` is provided,</span>
<span class="sd">        return only the configuration as specified in that scope.</span>

<span class="sd">        This off the top-level name from the YAML section.  That is, for a</span>
<span class="sd">        YAML config file that looks like this::</span>

<span class="sd">           config:</span>
<span class="sd">             install_tree:</span>
<span class="sd">               root: $spack/opt/spack</span>
<span class="sd">             build_stage:</span>
<span class="sd">             - $tmpdir/$user/spack-stage</span>

<span class="sd">        ``get_config(&#39;config&#39;)`` will return::</span>

<span class="sd">           { &#39;install_tree&#39;: {</span>
<span class="sd">                 &#39;root&#39;: &#39;$spack/opt/spack&#39;,</span>
<span class="sd">             }</span>
<span class="sd">             &#39;build_stage&#39;: [&#39;$tmpdir/$user/spack-stage&#39;]</span>
<span class="sd">           }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_memoized</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span></div>


    <span class="nd">@lang</span><span class="o">.</span><span class="n">memoized</span>
    <span class="k">def</span> <span class="nf">_get_config_memoized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">YamlConfigDict</span><span class="p">:</span>
        <span class="n">_validate_section_name</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scopes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scopes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)]</span>

        <span class="n">merged_section</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">scopes</span><span class="p">:</span>
            <span class="c1"># read potentially cached data from the scope.</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

            <span class="c1"># Skip empty configs</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># We might be reading configuration files in an old format,</span>
            <span class="c1"># thus read data and update it in memory if need be.</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="n">_update_in_memory</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format_updates</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

            <span class="n">merged_section</span> <span class="o">=</span> <span class="n">merge_yaml</span><span class="p">(</span><span class="n">merged_section</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># no config files -- empty config.</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_section</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">()</span>

        <span class="c1"># take the top key off before returning.</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">merged_section</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="Configuration.get">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a config section or a single value from one.</span>

<span class="sd">        Accepts a path syntax that allows us to grab nested config map</span>
<span class="sd">        entries.  Getting the &#39;config&#39; section would look like::</span>

<span class="sd">            spack.config.get(&#39;config&#39;)</span>

<span class="sd">        and the ``dirty`` section in the ``config`` scope would be::</span>

<span class="sd">            spack.config.get(&#39;config:dirty&#39;)</span>

<span class="sd">        We use ``:`` as the separator, like YAML objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">process_config_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># cannot use value.get(key, default) in case there is another part</span>
            <span class="c1"># and default is not a dict</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Configuration.set">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.set">[docs]</a>
    <span class="nd">@_config_mutator</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience function for setting single values in config files.</span>

<span class="sd">        Accepts the path syntax described in ``get()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="c1"># handle bare section name as path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_config</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">process_config_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">section_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">section_data</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_override</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])()</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Make it an ordered dict</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
                <span class="c1"># reattach to parent object</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">new</span>

        <span class="k">if</span> <span class="n">_override</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># update new value</span>
        <span class="n">data</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_config</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">section_data</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over scopes in this configuration.&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<div class="viewcode-block" id="Configuration.print_section">
<a class="viewcode-back" href="../../spack.html#spack.config.Configuration.print_section">[docs]</a>
    <span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blame</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a configuration to stdout.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
            <span class="n">syaml</span><span class="o">.</span><span class="n">dump_config</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blame</span><span class="o">=</span><span class="n">blame</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">syaml</span><span class="o">.</span><span class="n">SpackYAMLError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot read &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39; configuration&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>
</div>



<div class="viewcode-block" id="override">
<a class="viewcode-back" href="../../spack.html#spack.config.override">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">override</span><span class="p">(</span>
    <span class="n">path_or_scope</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Configuration</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple way to override config settings within a context.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path_or_scope (ConfigScope or str): scope or single option to override</span>
<span class="sd">        value (object or None): value for the single option</span>

<span class="sd">    Temporarily push a scope on the current configuration, then remove it</span>
<span class="sd">    after the context completes. If a single option is provided, create</span>
<span class="sd">    an internal config scope for it and push/pop that scope.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_scope</span><span class="p">,</span> <span class="n">ConfigScope</span><span class="p">):</span>
        <span class="n">overrides</span> <span class="o">=</span> <span class="n">path_or_scope</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">path_or_scope</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">_OVERRIDES_BASE_NAME</span>
        <span class="c1"># Ensure the new override gets a unique scope name</span>
        <span class="n">current_overrides</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">matching_scopes</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
        <span class="n">num_overrides</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_overrides</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">num_overrides</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">scope_name</span> <span class="ow">in</span> <span class="n">current_overrides</span><span class="p">:</span>
                <span class="n">num_overrides</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">overrides</span> <span class="o">=</span> <span class="n">InternalConfigScope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">path_or_scope</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope_name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">CONFIG</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">remove_scope</span><span class="p">(</span><span class="n">overrides</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">scope</span> <span class="ow">is</span> <span class="n">overrides</span></div>



<span class="k">def</span> <span class="nf">_add_platform_scope</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">writable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a platform-specific subdirectory for the current platform.&quot;&quot;&quot;</span>
    <span class="n">platform</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">host</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">DirectoryConfigScope</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">platform</span><span class="p">),</span> <span class="n">writable</span><span class="o">=</span><span class="n">writable</span>
    <span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>


<div class="viewcode-block" id="config_paths_from_entry_points">
<a class="viewcode-back" href="../../spack.html#spack.config.config_paths_from_entry_points">[docs]</a>
<span class="k">def</span> <span class="nf">config_paths_from_entry_points</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load configuration paths from entry points</span>

<span class="sd">    A python package can register entry point metadata so that Spack can find</span>
<span class="sd">    its configuration by adding the following to the project&#39;s pyproject.toml:</span>

<span class="sd">    .. code-block:: toml</span>

<span class="sd">       [project.entry-points.&quot;spack.config&quot;]</span>
<span class="sd">       baz = &quot;baz:get_spack_config_path&quot;</span>

<span class="sd">    The function ``get_spack_config_path`` returns the path to the package&#39;s</span>
<span class="sd">    spack configuration scope</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry_point</span> <span class="ow">in</span> <span class="n">lang</span><span class="o">.</span><span class="n">get_entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s2">&quot;spack.config&quot;</span><span class="p">):</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">entry_point</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">hook</span><span class="p">):</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">hook</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">config_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
                <span class="n">config_paths</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;plugin-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entry_point</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_path</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">config_paths</span></div>



<span class="k">def</span> <span class="nf">_add_command_line_scopes</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">command_line_scopes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add additional scopes from the --config-scope argument, either envs or dirs.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spack.environment.environment</span> <span class="k">as</span> <span class="nn">env</span>  <span class="c1"># circular import</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">command_line_scopes</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cmd_scope_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># managed environment</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">EnvironmentManifestFile</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">env</span><span class="o">.</span><span class="n">is_env_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># anonymous environment</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">EnvironmentManifestFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># directory with config files</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">DirectoryConfigScope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">writable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">_add_platform_scope</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">writable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid configuration scope: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">env_config_scopes</span><span class="p">:</span>
            <span class="n">scope</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">scope</span><span class="o">.</span><span class="n">writable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>


<div class="viewcode-block" id="create">
<a class="viewcode-back" href="../../spack.html#spack.config.create">[docs]</a>
<span class="k">def</span> <span class="nf">create</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Singleton Configuration instance.</span>

<span class="sd">    This constructs one instance associated with this module and returns</span>
<span class="sd">    it. It is bundled inside a function so that configuration can be</span>
<span class="sd">    initialized lazily.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">()</span>

    <span class="c1"># first do the builtin, hardcoded defaults</span>
    <span class="n">builtin</span> <span class="o">=</span> <span class="n">InternalConfigScope</span><span class="p">(</span><span class="s2">&quot;_builtin&quot;</span><span class="p">,</span> <span class="n">CONFIG_DEFAULTS</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>

    <span class="c1"># Builtin paths to configuration files in Spack</span>
    <span class="n">configuration_paths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Default configuration scope is the lowest-level scope. These are</span>
        <span class="c1"># versioned with Spack and can be overridden by systems, sites or users</span>
        <span class="n">CONFIGURATION_DEFAULTS_PATH</span>
    <span class="p">]</span>

    <span class="n">disable_local_config</span> <span class="o">=</span> <span class="s2">&quot;SPACK_DISABLE_LOCAL_CONFIG&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>

    <span class="c1"># System configuration is per machine.</span>
    <span class="c1"># This is disabled if user asks for no local configuration.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_local_config</span><span class="p">:</span>
        <span class="n">configuration_paths</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">system_config_path</span><span class="p">))</span>

    <span class="c1"># Site configuration is per spack instance, for sites or projects</span>
    <span class="c1"># No site-level configs should be checked into spack by default.</span>
    <span class="n">configuration_paths</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">etc_path</span><span class="p">)))</span>

    <span class="c1"># Python package&#39;s can register configuration scopes via entry_points</span>
    <span class="n">configuration_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">config_paths_from_entry_points</span><span class="p">())</span>

    <span class="c1"># User configuration can override both spack defaults and site config</span>
    <span class="c1"># This is disabled if user asks for no local configuration.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_local_config</span><span class="p">:</span>
        <span class="n">configuration_paths</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">user_config_path</span><span class="p">))</span>

    <span class="c1"># add each scope and its platform-specific directory</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">configuration_paths</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">DirectoryConfigScope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

        <span class="c1"># Each scope can have per-platfom overrides in subdirectories</span>
        <span class="n">_add_platform_scope</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cfg</span></div>



<span class="c1">#: This is the singleton configuration instance for Spack.</span>
<span class="n">CONFIG</span><span class="p">:</span> <span class="n">Configuration</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">Singleton</span><span class="p">(</span><span class="n">create</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<div class="viewcode-block" id="add_from_file">
<a class="viewcode-back" href="../../spack.html#spack.config.add_from_file">[docs]</a>
<span class="k">def</span> <span class="nf">add_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add updates to a config from a filename&quot;&quot;&quot;</span>
    <span class="c1"># Extract internal attributes, if we are dealing with an environment</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">read_config_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">TOP_LEVEL_KEY</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">TOP_LEVEL_KEY</span><span class="p">]</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;unexpected &#39;None&#39; value when retrieving configuration. &quot;</span>
        <span class="s2">&quot;Please submit a bug-report at https://github.com/spack/spack/issues&quot;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>

    <span class="c1"># update all sections from config dict</span>
    <span class="c1"># We have to iterate on keys to keep overrides from the file</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">SECTION_SCHEMAS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Special handling for compiler scope difference</span>
            <span class="c1"># Has to be handled after we choose a section</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">default_modify_scope</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">merge_yaml</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="c1"># We cannot call config.set directly (set is a type)</span>
            <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span></div>



<div class="viewcode-block" id="add">
<a class="viewcode-back" href="../../spack.html#spack.config.add">[docs]</a>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">fullpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the given configuration to the specified config scope.</span>
<span class="sd">    Add accepts a path. If you want to add from a filename, use add_from_file&quot;&quot;&quot;</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">process_config_path</span><span class="p">(</span><span class="n">fullpath</span><span class="p">)</span>

    <span class="n">has_existing_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">override</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_str</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># First handle double colons in constructing path</span>
        <span class="n">colon</span> <span class="o">=</span> <span class="s2">&quot;::&quot;</span> <span class="k">if</span> <span class="n">override</span> <span class="k">else</span> <span class="s2">&quot;:&quot;</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="n">colon</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;override&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">override</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">override</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Test whether there is an existing value at this level</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">has_existing_value</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># We&#39;ve nested further than existing config, so we need the</span>
            <span class="c1"># type information for validation to know how to handle bare</span>
            <span class="c1"># values appended to lists.</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">get_valid_type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># construct value from this point down</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">value</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">component</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>  <span class="c1"># type: ignore[no-redef]</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="s2">&quot;::&quot;</span>

    <span class="k">if</span> <span class="n">has_existing_value</span><span class="p">:</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>

    <span class="c1"># append values to lists</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>  <span class="c1"># type: ignore[no-redef]</span>

    <span class="c1"># merge value into existing</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">merge_yaml</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span></div>



<div class="viewcode-block" id="get">
<a class="viewcode-back" href="../../spack.html#spack.config.get">[docs]</a>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Module-level wrapper for ``Configuration.get()``.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span></div>



<div class="viewcode-block" id="set">
<a class="viewcode-back" href="../../spack.html#spack.config.set">[docs]</a>
<span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function for setting single values in config files.</span>

<span class="sd">    Accepts the path syntax described in ``get()``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_default_platform_scope">
<a class="viewcode-back" href="../../spack.html#spack.config.add_default_platform_scope">[docs]</a>
<span class="k">def</span> <span class="nf">add_default_platform_scope</span><span class="p">(</span><span class="n">platform</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">plat_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;defaults&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
    <span class="n">plat_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIGURATION_DEFAULTS_PATH</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">platform</span><span class="p">)</span>
    <span class="n">CONFIG</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">DirectoryConfigScope</span><span class="p">(</span><span class="n">plat_name</span><span class="p">,</span> <span class="n">plat_path</span><span class="p">))</span></div>



<div class="viewcode-block" id="scopes">
<a class="viewcode-back" href="../../spack.html#spack.config.scopes">[docs]</a>
<span class="k">def</span> <span class="nf">scopes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConfigScope</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to get list of configuration scopes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">scopes</span></div>



<div class="viewcode-block" id="writable_scopes">
<a class="viewcode-back" href="../../spack.html#spack.config.writable_scopes">[docs]</a>
<span class="k">def</span> <span class="nf">writable_scopes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return list of writable scopes. Higher-priority scopes come first in the list.&quot;&quot;&quot;</span>
    <span class="n">scopes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">writable</span><span class="p">]</span>
    <span class="n">scopes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">scopes</span></div>



<div class="viewcode-block" id="writable_scope_names">
<a class="viewcode-back" href="../../spack.html#spack.config.writable_scope_names">[docs]</a>
<span class="k">def</span> <span class="nf">writable_scope_names</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">writable_scopes</span><span class="p">())</span></div>



<div class="viewcode-block" id="matched_config">
<a class="viewcode-back" href="../../spack.html#spack.config.matched_config">[docs]</a>
<span class="k">def</span> <span class="nf">matched_config</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">scope</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">))</span> <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">writable_scope_names</span><span class="p">()]</span></div>



<div class="viewcode-block" id="change_or_add">
<a class="viewcode-back" href="../../spack.html#spack.config.change_or_add">[docs]</a>
<span class="k">def</span> <span class="nf">change_or_add</span><span class="p">(</span>
    <span class="n">section_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">find_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">update_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change or add a subsection of config, with additional logic to</span>
<span class="sd">    select a reasonable scope where the change is applied.</span>

<span class="sd">    Search through config scopes starting with the highest priority:</span>
<span class="sd">    the first matching a criteria (determined by ``find_fn``) is updated;</span>
<span class="sd">    if no such config exists, find the first config scope that defines</span>
<span class="sd">    any config for the named section; if no scopes define any related</span>
<span class="sd">    config, then update the highest-priority config scope.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">configs_by_section</span> <span class="o">=</span> <span class="n">matched_config</span><span class="p">(</span><span class="n">section_name</span><span class="p">)</span>

    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">scope</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">configs_by_section</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">find_fn</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
        <span class="n">update_fn</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># If no scope meets the criteria specified by ``find_fn``,</span>
    <span class="c1"># then look for a scope that has any content (for the specified</span>
    <span class="c1"># section name)</span>
    <span class="k">for</span> <span class="n">scope</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">configs_by_section</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">section</span><span class="p">:</span>
            <span class="n">update_fn</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># If no scopes define any config for the named section, then</span>
    <span class="c1"># modify the highest-priority scope.</span>
    <span class="n">scope</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">configs_by_section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">update_fn</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_all">
<a class="viewcode-back" href="../../spack.html#spack.config.update_all">[docs]</a>
<span class="k">def</span> <span class="nf">update_all</span><span class="p">(</span><span class="n">section_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">change_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change a config section, which may have details duplicated</span>
<span class="sd">    across multiple scopes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">configs_by_section</span> <span class="o">=</span> <span class="n">matched_config</span><span class="p">(</span><span class="s2">&quot;develop&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">scope</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">configs_by_section</span><span class="p">:</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">change_fn</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modified</span><span class="p">:</span>
            <span class="n">CONFIG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_validate_section_name</span><span class="p">(</span><span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exit if the section is not a valid section.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SECTION_SCHEMAS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigSectionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid config section: &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39;. Options are: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SECTION_SCHEMAS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<div class="viewcode-block" id="validate">
<a class="viewcode-back" href="../../spack.html#spack.config.validate">[docs]</a>
<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">YamlConfigDict</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">YamlConfigDict</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YamlConfigDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate data read in from a Spack YAML file.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data: data read from a Spack YAML file</span>
<span class="sd">        schema: jsonschema to validate data</span>

<span class="sd">    This leverages the line information (start_mark, end_mark) stored</span>
<span class="sd">    on Spack YAML structures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">jsonschema</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Validator</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;lc&quot;</span><span class="p">):</span>
            <span class="n">line_number</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_number</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="n">ConfigFormatError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">line_number</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="c1"># return the validated data so that we can access the raw data</span>
    <span class="c1"># mostly relevant for environments</span>
    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="read_config_file">
<a class="viewcode-back" href="../../spack.html#spack.config.read_config_file">[docs]</a>
<span class="k">def</span> <span class="nf">read_config_file</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">YamlConfigDict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a YAML configuration file.</span>

<span class="sd">    User can provide a schema for validation. If no schema is provided,</span>
<span class="sd">    we will infer the schema from the top-level key.&quot;&quot;&quot;</span>
    <span class="c1"># Dev: Inferring schema and allowing it to be provided directly allows us</span>
    <span class="c1"># to preserve flexibility in calling convention (don&#39;t need to provide</span>
    <span class="c1"># schema when it&#39;s not necessary) while allowing us to validate against a</span>
    <span class="c1"># known schema when the top-level key could be incorrect.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading config from file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">_ALL_SCHEMAS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="c1"># Ignore nonexistent files.</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping nonexistent config path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigFileError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path is not a file or is not readable: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigFileError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file is empty or is not a valid YAML dict: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">except</span> <span class="n">syaml</span><span class="o">.</span><span class="n">SpackYAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigFileError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span></div>



<span class="k">def</span> <span class="nf">_override</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test if a spack YAML string is an override.</span>

<span class="sd">    See ``spack_yaml`` for details.  Keys in Spack YAML can end in `::`,</span>
<span class="sd">    and if they do, their values completely replace lower-precedence</span>
<span class="sd">    configs instead of merging into them.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s2">&quot;override&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">string</span><span class="o">.</span><span class="n">override</span>


<span class="k">def</span> <span class="nf">_append</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test if a spack YAML string is an override.</span>

<span class="sd">    See ``spack_yaml`` for details.  Keys in Spack YAML can end in `+:`,</span>
<span class="sd">    and if they do, their values append lower-precedence</span>
<span class="sd">    configs.</span>

<span class="sd">    str, str : concatenate strings.</span>
<span class="sd">    [obj], [obj] : append lists.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_prepend</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test if a spack YAML string is an override.</span>

<span class="sd">    See ``spack_yaml`` for details.  Keys in Spack YAML can end in `+:`,</span>
<span class="sd">    and if they do, their values prepend lower-precedence</span>
<span class="sd">    configs.</span>

<span class="sd">    str, str : concatenate strings.</span>
<span class="sd">    [obj], [obj] : prepend lists. (default behavior)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s2">&quot;prepend&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_mark_internal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a simple name mark to raw YAML/JSON data.</span>

<span class="sd">    This is used by `spack config blame` to show where config lines came from.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">_mark_internal</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">_mark_internal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_list</span><span class="p">(</span><span class="n">_mark_internal</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">syaml</span><span class="o">.</span><span class="n">markable</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">_start_mark</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">name_mark</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">_end_mark</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">name_mark</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d</span>


<div class="viewcode-block" id="get_valid_type">
<a class="viewcode-back" href="../../spack.html#spack.config.get_valid_type">[docs]</a>
<span class="k">def</span> <span class="nf">get_valid_type</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns an instance of a type that will pass validation for path.</span>

<span class="sd">    The instance is created by calling the constructor with no arguments.</span>
<span class="sd">    If multiple types will satisfy validation for data at the configuration</span>
<span class="sd">    path given, the priority order is ``list``, ``dict``, ``str``, ``bool``,</span>
<span class="sd">    ``int``, ``float``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_dict</span><span class="p">,</span>
        <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;boolean&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="s2">&quot;integer&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">components</span> <span class="o">=</span> <span class="n">process_config_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Use None to construct the test data</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">component</span><span class="p">:</span> <span class="n">test_data</span><span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">SECTION_SCHEMAS</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ConfigFormatError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">jsonschema_error</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">validation_error</span>
        <span class="k">if</span> <span class="n">jsonschema_error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">types</span><span class="p">[</span><span class="n">jsonschema_error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">]()</span>
        <span class="k">elif</span> <span class="n">jsonschema_error</span><span class="o">.</span><span class="n">validator</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;anyOf&quot;</span><span class="p">,</span> <span class="s2">&quot;oneOf&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subschema</span> <span class="ow">in</span> <span class="n">jsonschema_error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">:</span>
                <span class="n">schema_type</span> <span class="o">=</span> <span class="n">subschema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">schema_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">types</span><span class="p">[</span><span class="n">schema_type</span><span class="p">]()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot determine valid type for path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="remove_yaml">
<a class="viewcode-back" href="../../spack.html#spack.config.remove_yaml">[docs]</a>
<span class="k">def</span> <span class="nf">remove_yaml</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;UnMerges source from dest; entries in source take precedence over dest.</span>

<span class="sd">    This routine may modify dest and should be assigned to dest, in</span>
<span class="sd">    case dest was None to begin with, e.g.:</span>

<span class="sd">       dest = remove_yaml(dest, source)</span>

<span class="sd">    In the result, elements from lists from ``source`` will not appear</span>
<span class="sd">    as elements of lists from ``dest``. Likewise, when iterating over keys</span>
<span class="sd">    or items in merged ``OrderedDict`` objects, keys from ``source`` will not</span>
<span class="sd">    appear as keys in ``dest``.</span>

<span class="sd">    Config file authors can optionally end any attribute in a dict</span>
<span class="sd">    with `::` instead of `:`, and the key will remove the entire section</span>
<span class="sd">    from ``dest``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">they_are</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="c1"># If source is None, overwrite with source.</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dest</span>

    <span class="c1"># Source list is prepended (for precedence)</span>
    <span class="k">if</span> <span class="n">they_are</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Make sure to copy ruamel comments</span>
        <span class="n">dest</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dest</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dest</span>

    <span class="c1"># Source dict is merged into dest.</span>
    <span class="k">elif</span> <span class="n">they_are</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sv</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># always remove the dest items. Python dicts do not overwrite</span>
            <span class="c1"># keys on insert, so this ensures that source keys are copied</span>
            <span class="c1"># into dest along with mark provenance (i.e., file/line info).</span>
            <span class="n">unmerge</span> <span class="o">=</span> <span class="n">sk</span> <span class="ow">in</span> <span class="n">dest</span>
            <span class="n">old_dest_value</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">unmerge</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_override</span><span class="p">(</span><span class="n">sk</span><span class="p">):</span>
                <span class="n">dest</span><span class="p">[</span><span class="n">sk</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_yaml</span><span class="p">(</span><span class="n">old_dest_value</span><span class="p">,</span> <span class="n">sv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dest</span>

    <span class="c1"># If we reach here source and dest are either different types or are</span>
    <span class="c1"># not both lists or dicts: replace with source.</span>
    <span class="k">return</span> <span class="n">dest</span></div>



<div class="viewcode-block" id="merge_yaml">
<a class="viewcode-back" href="../../spack.html#spack.config.merge_yaml">[docs]</a>
<span class="k">def</span> <span class="nf">merge_yaml</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merges source into dest; entries in source take precedence over dest.</span>

<span class="sd">    This routine may modify dest and should be assigned to dest, in</span>
<span class="sd">    case dest was None to begin with, e.g.:</span>

<span class="sd">       dest = merge_yaml(dest, source)</span>

<span class="sd">    In the result, elements from lists from ``source`` will appear before</span>
<span class="sd">    elements of lists from ``dest``. Likewise, when iterating over keys</span>
<span class="sd">    or items in merged ``OrderedDict`` objects, keys from ``source`` will</span>
<span class="sd">    appear before keys from ``dest``.</span>

<span class="sd">    Config file authors can optionally end any attribute in a dict</span>
<span class="sd">    with `::` instead of `:`, and the key will override that of the</span>
<span class="sd">    parent instead of merging.</span>

<span class="sd">    `+:` will extend the default prepend merge strategy to include string concatenation</span>
<span class="sd">    `-:` will change the merge strategy to append, it also includes string concatentation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">they_are</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="c1"># If source is None, overwrite with source.</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Source list is prepended (for precedence)</span>
    <span class="k">if</span> <span class="n">they_are</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="c1"># Make sure to copy ruamel comments</span>
            <span class="n">dest</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dest</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span> <span class="o">+</span> <span class="n">source</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Make sure to copy ruamel comments</span>
            <span class="n">dest</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">source</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dest</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dest</span>

    <span class="c1"># Source dict is merged into dest.</span>
    <span class="k">elif</span> <span class="n">they_are</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># save dest keys to reinsert later -- this ensures that  source items</span>
        <span class="c1"># come *before* dest in OrderdDicts</span>
        <span class="n">dest_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">dk</span> <span class="k">for</span> <span class="n">dk</span> <span class="ow">in</span> <span class="n">dest</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">dk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sv</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># always remove the dest items. Python dicts do not overwrite</span>
            <span class="c1"># keys on insert, so this ensures that source keys are copied</span>
            <span class="c1"># into dest along with mark provenance (i.e., file/line info).</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="n">sk</span> <span class="ow">in</span> <span class="n">dest</span>
            <span class="n">old_dest_value</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">merge</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_override</span><span class="p">(</span><span class="n">sk</span><span class="p">):</span>
                <span class="n">dest</span><span class="p">[</span><span class="n">sk</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_yaml</span><span class="p">(</span><span class="n">old_dest_value</span><span class="p">,</span> <span class="n">sv</span><span class="p">,</span> <span class="n">_prepend</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">_append</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if sk ended with ::, or if it&#39;s new, completely override</span>
                <span class="n">dest</span><span class="p">[</span><span class="n">sk</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sv</span><span class="p">)</span>

        <span class="c1"># reinsert dest keys so they are last in the result</span>
        <span class="k">for</span> <span class="n">dk</span> <span class="ow">in</span> <span class="n">dest_keys</span><span class="p">:</span>
            <span class="n">dest</span><span class="p">[</span><span class="n">dk</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dest</span>

    <span class="k">elif</span> <span class="n">they_are</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Concatenate strings in prepend mode</span>
        <span class="k">if</span> <span class="n">prepend</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">source</span> <span class="o">+</span> <span class="n">dest</span>
        <span class="k">elif</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dest</span> <span class="o">+</span> <span class="n">source</span>

    <span class="c1"># If we reach here source and dest are either different types or are</span>
    <span class="c1"># not both lists or dicts: replace with source.</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span></div>



<div class="viewcode-block" id="ConfigPath">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigPath">[docs]</a>
<span class="k">class</span> <span class="nc">ConfigPath</span><span class="p">:</span>
    <span class="n">quoted_string</span> <span class="o">=</span> <span class="s2">&quot;(?:</span><span class="se">\&quot;</span><span class="s2">[^</span><span class="se">\&quot;</span><span class="s2">]+</span><span class="se">\&quot;</span><span class="s2">)|(?:&#39;[^&#39;]+&#39;)&quot;</span>
    <span class="n">unquoted_string</span> <span class="o">=</span> <span class="s2">&quot;[^:&#39;</span><span class="se">\&quot;</span><span class="s2">]+&quot;</span>
    <span class="n">element</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;(?:(?:</span><span class="si">{</span><span class="n">quoted_string</span><span class="si">}</span><span class="s2">)|(?:</span><span class="si">{</span><span class="n">unquoted_string</span><span class="si">}</span><span class="s2">))&quot;</span>
    <span class="n">next_key_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2">[+-]?)(?:\:|$)&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_split_front</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">extract</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">extract</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">string</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">:]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Example valid config paths:</span>

<span class="sd">        x:y:z</span>
<span class="sd">        x:&quot;y&quot;:z</span>
<span class="sd">        x:y+:z</span>
<span class="sd">        x:y::z</span>
<span class="sd">        x:y+::z</span>
<span class="sd">        x:y:</span>
<span class="sd">        x:y::</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_key</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">ConfigPath</span><span class="o">.</span><span class="n">_split_front</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ConfigPath</span><span class="o">.</span><span class="n">next_key_pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config path does not start with a parse-able key: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">path_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_key</span><span class="p">]</span>
        <span class="n">path_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">separator</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">ConfigPath</span><span class="o">.</span><span class="n">_split_front</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;(\:+)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">separator</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected separator for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">path_elements</span><span class="p">[</span><span class="n">path_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">separator</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">element</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">ConfigPath</span><span class="o">.</span><span class="n">_split_front</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ConfigPath</span><span class="o">.</span><span class="n">next_key_pattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="p">:</span>
                <span class="c1"># If we can&#39;t parse something as a key, then it must be a</span>
                <span class="c1"># value (if it&#39;s valid).</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">syaml</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spack_yaml</span><span class="o">.</span><span class="n">SpackYAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Remainder of path is not a valid key&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; and does not parse as a value </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># The rest of the path was consumed into the value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">remainder</span>

            <span class="n">path_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">path_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">path_elements</span>

<div class="viewcode-block" id="ConfigPath.process">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigPath.process">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="s2">&quot;[&#39;</span><span class="se">\&quot;</span><span class="s2">]&quot;</span>
        <span class="n">seen_override_in_path</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">path_elements</span> <span class="o">=</span> <span class="n">ConfigPath</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">last_element_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path_elements</span><span class="p">):</span>
            <span class="n">override</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">prepend</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">quoted</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">last_element_idx</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">seen_override_in_path</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">syaml</span><span class="o">.</span><span class="n">SpackYAMLError</span><span class="p">(</span>
                        <span class="s2">&quot;Meaningless second override indicator `::&#39; in path `</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="n">override</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">seen_override_in_path</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
                <span class="n">prepend</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">append</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;+-&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">quote</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
                <span class="n">quoted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">append</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">override</span><span class="p">,</span> <span class="n">quoted</span><span class="p">]):</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">syaml</span><span class="o">.</span><span class="n">syaml_str</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">append</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">prepend</span><span class="p">:</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">prepend</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">override</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>
</div>



<div class="viewcode-block" id="process_config_path">
<a class="viewcode-back" href="../../spack.html#spack.config.process_config_path">[docs]</a>
<span class="k">def</span> <span class="nf">process_config_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a path argument to config.set() that may contain overrides (&#39;::&#39; or</span>
<span class="sd">    trailing &#39;:&#39;)</span>

<span class="sd">    Colons will be treated as static strings if inside of quotes,</span>
<span class="sd">    e.g. `this:is:a:path:&#39;value:with:colon&#39;` will yield:</span>

<span class="sd">        [this, is, a, path, value:with:colon]</span>

<span class="sd">    The path may consist only of keys (e.g. for a `get`) or may end in a value.</span>
<span class="sd">    Keys are always strings: if a user encloses a key in quotes, the quotes</span>
<span class="sd">    should be removed. Values with quotes should be treated as strings,</span>
<span class="sd">    but without quotes, may be parsed as a different yaml object (e.g.</span>
<span class="sd">    &#39;{}&#39; is a dict, but &#39;&quot;{}&quot;&#39; is a string).</span>

<span class="sd">    This function does not know whether the final element of the path is a</span>
<span class="sd">    key or value, so:</span>

<span class="sd">    * It must strip the quotes, in case it is a key (so we look for &quot;key&quot; and</span>
<span class="sd">      not &#39;&quot;key&quot;&#39;))</span>
<span class="sd">    * It must indicate somehow that the quotes were stripped, in case it is a</span>
<span class="sd">      value (so that we don&#39;t process &#39;&quot;{}&quot;&#39; as a YAML dict)</span>

<span class="sd">    Therefore, all elements with quotes are stripped, and then also converted</span>
<span class="sd">    to ``syaml_str`` (if treating the final element as a value, the caller</span>
<span class="sd">    should not parse it in this case).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ConfigPath</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>



<span class="c1">#</span>
<span class="c1"># Settings for commands that modify configuration</span>
<span class="c1">#</span>
<div class="viewcode-block" id="default_modify_scope">
<a class="viewcode-back" href="../../spack.html#spack.config.default_modify_scope">[docs]</a>
<span class="k">def</span> <span class="nf">default_modify_scope</span><span class="p">(</span><span class="n">section</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the config scope that commands should modify by default.</span>

<span class="sd">    Commands that modify configuration by default modify the *highest*</span>
<span class="sd">    priority scope.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        section (bool): Section for which to get the default scope.</span>
<span class="sd">            If this is not &#39;compilers&#39;, a general (non-platform) scope is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;compilers&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">highest_precedence_scope</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">highest_precedence_non_platform_scope</span><span class="p">()</span><span class="o">.</span><span class="n">name</span></div>



<span class="k">def</span> <span class="nf">_update_in_memory</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">YamlConfigDict</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the format of the configuration data in memory.</span>

<span class="sd">    This function assumes the section is valid (i.e. validation</span>
<span class="sd">    is responsibility of the caller)</span>

<span class="sd">    Args:</span>
<span class="sd">        data: configuration data</span>
<span class="sd">        section: section of the configuration to update</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the data was changed, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">update_fn</span> <span class="o">=</span> <span class="n">ensure_latest_format_fn</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="n">update_fn</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">changed</span>


<div class="viewcode-block" id="ensure_latest_format_fn">
<a class="viewcode-back" href="../../spack.html#spack.config.ensure_latest_format_fn">[docs]</a>
<span class="k">def</span> <span class="nf">ensure_latest_format_fn</span><span class="p">(</span><span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">YamlConfigDict</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a function that takes as input a dictionary read from</span>
<span class="sd">    a configuration file and update it to the latest format.</span>

<span class="sd">    The function returns True if there was any update, False otherwise.</span>

<span class="sd">    Args:</span>
<span class="sd">        section: section of the configuration e.g. &quot;packages&quot;,</span>
<span class="sd">            &quot;config&quot;, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The line below is based on the fact that every module we need</span>
    <span class="c1"># is already imported at the top level</span>
    <span class="n">section_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
    <span class="n">update_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">section_module</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">update_fn</span></div>



<div class="viewcode-block" id="use_configuration">
<a class="viewcode-back" href="../../spack.html#spack.config.use_configuration">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">use_configuration</span><span class="p">(</span>
    <span class="o">*</span><span class="n">scopes_or_paths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Configuration</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use the configuration scopes passed as arguments within the context manager.</span>

<span class="sd">    This function invalidates caches, and is therefore very slow.</span>

<span class="sd">    Args:</span>
<span class="sd">        *scopes_or_paths: scope objects or paths to be used</span>

<span class="sd">    Returns:</span>
<span class="sd">        Configuration object associated with the scopes passed as arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">CONFIG</span>

    <span class="c1"># Normalize input and construct a Configuration object</span>
    <span class="n">configuration</span> <span class="o">=</span> <span class="n">_config_from</span><span class="p">(</span><span class="n">scopes_or_paths</span><span class="p">)</span>
    <span class="n">CONFIG</span><span class="o">.</span><span class="n">clear_caches</span><span class="p">(),</span> <span class="n">configuration</span><span class="o">.</span><span class="n">clear_caches</span><span class="p">()</span>

    <span class="n">saved_config</span><span class="p">,</span> <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">configuration</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">configuration</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">saved_config</span></div>



<span class="nd">@lang</span><span class="o">.</span><span class="n">memoized</span>
<span class="k">def</span> <span class="nf">_config_from</span><span class="p">(</span><span class="n">scopes_or_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ConfigScope</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
    <span class="n">scopes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scope_or_path</span> <span class="ow">in</span> <span class="n">scopes_or_paths</span><span class="p">:</span>
        <span class="c1"># If we have a config scope we are already done</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scope_or_path</span><span class="p">,</span> <span class="n">ConfigScope</span><span class="p">):</span>
            <span class="n">scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope_or_path</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Otherwise we need to construct it</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">scope_or_path</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&quot; must be a directory&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DirectoryConfigScope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

    <span class="n">configuration</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="o">*</span><span class="n">scopes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">configuration</span>


<div class="viewcode-block" id="raw_github_gitlab_url">
<a class="viewcode-back" href="../../spack.html#spack.config.raw_github_gitlab_url">[docs]</a>
<span class="k">def</span> <span class="nf">raw_github_gitlab_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform a github URL to the raw form to avoid undesirable html.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: url to be converted to raw form</span>

<span class="sd">    Returns:</span>
<span class="sd">        Raw github/gitlab url or the original url</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note we rely on GitHub to redirect the &#39;raw&#39; URL returned here to the</span>
    <span class="c1"># actual URL under https://raw.githubusercontent.com/ with &#39;/blob&#39;</span>
    <span class="c1"># removed and or, &#39;/blame&#39; if needed.</span>
    <span class="k">if</span> <span class="s2">&quot;github&quot;</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s2">&quot;gitlab&quot;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/blob/&quot;</span><span class="p">,</span> <span class="s2">&quot;/raw/&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">url</span></div>



<div class="viewcode-block" id="collect_urls">
<a class="viewcode-back" href="../../spack.html#spack.config.collect_urls">[docs]</a>
<span class="k">def</span> <span class="nf">collect_urls</span><span class="p">(</span><span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of configuration URLs.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        base_url: URL for a configuration (yaml) file or a directory</span>
<span class="sd">            containing yaml file(s)</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of configuration file(s) or empty list if none</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;.yaml&quot;</span>

    <span class="k">if</span> <span class="n">base_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extension</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">base_url</span><span class="p">]</span>

    <span class="c1"># Collect configuration URLs if the base_url is a &quot;directory&quot;.</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">links</span> <span class="o">=</span> <span class="n">web_util</span><span class="o">.</span><span class="n">spider</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extension</span><span class="p">)]</span></div>



<div class="viewcode-block" id="fetch_remote_configs">
<a class="viewcode-back" href="../../spack.html#spack.config.fetch_remote_configs">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_remote_configs</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">skip_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve configuration file(s) at the specified URL.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        url: URL for a configuration (yaml) file or a directory containing</span>
<span class="sd">            yaml file(s)</span>
<span class="sd">        dest_dir: destination directory</span>
<span class="sd">        skip_existing: Skip files that already exist in dest_dir if</span>
<span class="sd">            ``True``; otherwise, replace those files</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the corresponding file if URL is or contains a</span>
<span class="sd">        single file and it is the only file in the destination directory or</span>
<span class="sd">        the root (dest_dir) directory if multiple configuration files exist</span>
<span class="sd">        or are retrieved.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_fetch_file</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">raw_github_gitlab_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading config from url </span><span class="si">{</span><span class="n">raw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">web_util</span><span class="o">.</span><span class="n">fetch_url_text</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">dest_dir</span><span class="o">=</span><span class="n">dest_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigFileError</span><span class="p">(</span><span class="s2">&quot;Cannot retrieve configuration without a URL&quot;</span><span class="p">)</span>

    <span class="c1"># Return the local path to the cached configuration file OR to the</span>
    <span class="c1"># directory containing the cached configuration files.</span>
    <span class="n">config_links</span> <span class="o">=</span> <span class="n">collect_urls</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">existing_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">config_url</span> <span class="ow">in</span> <span class="n">config_links</span><span class="p">:</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">config_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_existing</span> <span class="ow">and</span> <span class="n">basename</span> <span class="ow">in</span> <span class="n">existing_files</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Will not fetch configuration from </span><span class="si">{</span><span class="n">config_url</span><span class="si">}</span><span class="s2"> since a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;version already exists in </span><span class="si">{</span><span class="n">dest_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">_fetch_file</span><span class="p">(</span><span class="n">config_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dest_dir</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">raise</span> <span class="n">ConfigFileError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot retrieve configuration (yaml) from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_mark_from_yaml_data">
<a class="viewcode-back" href="../../spack.html#spack.config.get_mark_from_yaml_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_mark_from_yaml_data</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try to get ``spack.util.spack_yaml`` mark from YAML data.</span>

<span class="sd">    We try the object, and if that fails we try its first member (if it&#39;s a container).</span>

<span class="sd">    Returns:</span>
<span class="sd">        mark if one is found, otherwise None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># mark of object itelf</span>
    <span class="n">mark</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_start_mark&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mark</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mark</span>

    <span class="c1"># mark of first member if it is a container</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="n">first_member</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_member</span><span class="p">:</span>
            <span class="n">mark</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">first_member</span><span class="p">,</span> <span class="s2">&quot;_start_mark&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mark</span></div>



<div class="viewcode-block" id="determine_number_of_jobs">
<a class="viewcode-back" href="../../spack.html#spack.config.determine_number_of_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">determine_number_of_jobs</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">max_cpus</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cpus_available</span><span class="p">(),</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Configuration</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Packages that require sequential builds need 1 job. Otherwise we use the</span>
<span class="sd">    number of jobs set on the command line. If not set, then we use the config</span>
<span class="sd">    defaults (which is usually set through the builtin config scope), but we</span>
<span class="sd">    cap to the number of CPUs available to avoid oversubscription.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        parallel: true when package supports parallel builds</span>
<span class="sd">        max_cpus: maximum number of CPUs to use (defaults to cpus_available())</span>
<span class="sd">        config: configuration object (defaults to global config)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">CONFIG</span>

    <span class="c1"># Command line overrides all</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:build_jobs&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;command_line&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">command_line</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_cpus</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:build_jobs&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span></div>



<div class="viewcode-block" id="ConfigSectionError">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigSectionError">[docs]</a>
<span class="k">class</span> <span class="nc">ConfigSectionError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error for referring to a bad config section name in a configuration.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ConfigFileError">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigFileError">[docs]</a>
<span class="k">class</span> <span class="nc">ConfigFileError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Issue reading or accessing a configuration file.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ConfigFormatError">
<a class="viewcode-back" href="../../spack.html#spack.config.ConfigFormatError">[docs]</a>
<span class="k">class</span> <span class="nc">ConfigFormatError</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a configuration format does not match its schema.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">validation_error</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">YamlConfigDict</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">line</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># spack yaml has its own file/line marks -- try to find them</span>
        <span class="c1"># we prioritize these over the inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_error</span> <span class="o">=</span> <span class="n">validation_error</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mark</span><span class="p">(</span><span class="n">validation_error</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mark</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">mark</span><span class="o">.</span><span class="n">name</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">mark</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>  <span class="c1"># record this for ruamel.yaml</span>

        <span class="c1"># construct location</span>
        <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;&lt;unknown file&gt;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">line</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">validation_error</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_error</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the file/line mark fo a validation error from a Spack YAML file.&quot;&quot;&quot;</span>

        <span class="c1"># Try various places, starting with instance and parent</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">(</span><span class="n">validation_error</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">validation_error</span><span class="o">.</span><span class="n">parent</span><span class="p">):</span>
            <span class="n">mark</span> <span class="o">=</span> <span class="n">get_mark_from_yaml_data</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mark</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mark</span>

        <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">get_path</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">data</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># Try really hard to get the parent (which sometimes is not</span>
        <span class="c1"># set) This digs it out of the validated structure if it&#39;s not</span>
        <span class="c1"># on the validation_error.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">validation_error</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">get_path</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">keylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">keylist</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">keylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">mark</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">keylist</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s2">&quot;_start_mark&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mark</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">mark</span>

        <span class="c1"># give up and return None if nothing worked</span>
        <span class="k">return</span> <span class="kc">None</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>