

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.build_environment &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.build_environment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.build_environment</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains all routines related to setting up the package</span>
<span class="sd">build environment.  All of this is set up by package.py just before</span>
<span class="sd">install() is called.</span>

<span class="sd">There are two parts to the build environment:</span>

<span class="sd">1. Python build environment (i.e. install() method)</span>

<span class="sd">   This is how things are set up when install() is called.  Spack</span>
<span class="sd">   takes advantage of each package being in its own module by adding a</span>
<span class="sd">   bunch of command-like functions (like configure(), make(), etc.) in</span>
<span class="sd">   the package&#39;s module scope.  Ths allows package writers to call</span>
<span class="sd">   them all directly in Package.install() without writing &#39;self.&#39;</span>
<span class="sd">   everywhere.  No, this isn&#39;t Pythonic.  Yes, it makes the code more</span>
<span class="sd">   readable and more like the shell script from which someone is</span>
<span class="sd">   likely porting.</span>

<span class="sd">2. Build execution environment</span>

<span class="sd">   This is the set of environment variables, like PATH, CC, CXX,</span>
<span class="sd">   etc. that control the build.  There are also a number of</span>
<span class="sd">   environment variables used to pass information (like RPATHs and</span>
<span class="sd">   other information about dependencies) to Spack&#39;s compiler wrappers.</span>
<span class="sd">   All of these env vars are also set up here.</span>

<span class="sd">Skimming this module is a nice way to get acquainted with the types of</span>
<span class="sd">calls you can make from within the install() function.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">auto</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">multiprocessing.connection</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">archspec.cpu</span>

<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>
<span class="kn">from</span> <span class="nn">llnl.string</span> <span class="kn">import</span> <span class="n">plural</span>
<span class="kn">from</span> <span class="nn">llnl.util.filesystem</span> <span class="kn">import</span> <span class="n">join_path</span>
<span class="kn">from</span> <span class="nn">llnl.util.lang</span> <span class="kn">import</span> <span class="n">dedupe</span><span class="p">,</span> <span class="n">stable_partition</span>
<span class="kn">from</span> <span class="nn">llnl.util.symlink</span> <span class="kn">import</span> <span class="n">symlink</span>
<span class="kn">from</span> <span class="nn">llnl.util.tty.color</span> <span class="kn">import</span> <span class="n">cescape</span><span class="p">,</span> <span class="n">colorize</span>

<span class="kn">import</span> <span class="nn">spack.build_systems._checks</span>
<span class="kn">import</span> <span class="nn">spack.build_systems.cmake</span>
<span class="kn">import</span> <span class="nn">spack.build_systems.meson</span>
<span class="kn">import</span> <span class="nn">spack.build_systems.python</span>
<span class="kn">import</span> <span class="nn">spack.builder</span>
<span class="kn">import</span> <span class="nn">spack.compilers</span>
<span class="kn">import</span> <span class="nn">spack.config</span>
<span class="kn">import</span> <span class="nn">spack.deptypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">spack.error</span>
<span class="kn">import</span> <span class="nn">spack.multimethod</span>
<span class="kn">import</span> <span class="nn">spack.package_base</span>
<span class="kn">import</span> <span class="nn">spack.paths</span>
<span class="kn">import</span> <span class="nn">spack.platforms</span>
<span class="kn">import</span> <span class="nn">spack.schema.environment</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.stage</span>
<span class="kn">import</span> <span class="nn">spack.store</span>
<span class="kn">import</span> <span class="nn">spack.subprocess_context</span>
<span class="kn">import</span> <span class="nn">spack.util.executable</span>
<span class="kn">import</span> <span class="nn">spack.util.libc</span>
<span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="n">traverse</span>
<span class="kn">from</span> <span class="nn">spack.context</span> <span class="kn">import</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="nn">spack.error</span> <span class="kn">import</span> <span class="n">InstallError</span><span class="p">,</span> <span class="n">NoHeadersError</span><span class="p">,</span> <span class="n">NoLibrariesError</span>
<span class="kn">from</span> <span class="nn">spack.install_test</span> <span class="kn">import</span> <span class="n">spack_install_test_log</span>
<span class="kn">from</span> <span class="nn">spack.util.environment</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SYSTEM_DIR_CASE_ENTRY</span><span class="p">,</span>
    <span class="n">EnvironmentModifications</span><span class="p">,</span>
    <span class="n">env_flag</span><span class="p">,</span>
    <span class="n">filter_system_paths</span><span class="p">,</span>
    <span class="n">get_path</span><span class="p">,</span>
    <span class="n">is_system_path</span><span class="p">,</span>
    <span class="n">validate</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">spack.util.executable</span> <span class="kn">import</span> <span class="n">Executable</span>
<span class="kn">from</span> <span class="nn">spack.util.log_parse</span> <span class="kn">import</span> <span class="n">make_log_context</span><span class="p">,</span> <span class="n">parse_log_events</span>
<span class="kn">from</span> <span class="nn">spack.util.module_cmd</span> <span class="kn">import</span> <span class="n">load_module</span>

<span class="c1">#</span>
<span class="c1"># This can be set by the user to globally disable parallel builds.</span>
<span class="c1">#</span>
<span class="n">SPACK_NO_PARALLEL_MAKE</span> <span class="o">=</span> <span class="s2">&quot;SPACK_NO_PARALLEL_MAKE&quot;</span>

<span class="c1">#</span>
<span class="c1"># These environment variables are set by</span>
<span class="c1"># set_wrapper_variables and used to pass parameters to</span>
<span class="c1"># Spack&#39;s compiler wrappers.</span>
<span class="c1">#</span>
<span class="n">SPACK_ENV_PATH</span> <span class="o">=</span> <span class="s2">&quot;SPACK_ENV_PATH&quot;</span>
<span class="n">SPACK_MANAGED_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_MANAGED_DIRS&quot;</span>
<span class="n">SPACK_INCLUDE_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_INCLUDE_DIRS&quot;</span>
<span class="n">SPACK_LINK_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_LINK_DIRS&quot;</span>
<span class="n">SPACK_RPATH_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_RPATH_DIRS&quot;</span>
<span class="n">SPACK_STORE_INCLUDE_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_STORE_INCLUDE_DIRS&quot;</span>
<span class="n">SPACK_STORE_LINK_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_STORE_LINK_DIRS&quot;</span>
<span class="n">SPACK_STORE_RPATH_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_STORE_RPATH_DIRS&quot;</span>
<span class="n">SPACK_RPATH_DEPS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_RPATH_DEPS&quot;</span>
<span class="n">SPACK_LINK_DEPS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_LINK_DEPS&quot;</span>
<span class="n">SPACK_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;SPACK_PREFIX&quot;</span>
<span class="n">SPACK_INSTALL</span> <span class="o">=</span> <span class="s2">&quot;SPACK_INSTALL&quot;</span>
<span class="n">SPACK_DEBUG</span> <span class="o">=</span> <span class="s2">&quot;SPACK_DEBUG&quot;</span>
<span class="n">SPACK_SHORT_SPEC</span> <span class="o">=</span> <span class="s2">&quot;SPACK_SHORT_SPEC&quot;</span>
<span class="n">SPACK_DEBUG_LOG_ID</span> <span class="o">=</span> <span class="s2">&quot;SPACK_DEBUG_LOG_ID&quot;</span>
<span class="n">SPACK_DEBUG_LOG_DIR</span> <span class="o">=</span> <span class="s2">&quot;SPACK_DEBUG_LOG_DIR&quot;</span>
<span class="n">SPACK_CCACHE_BINARY</span> <span class="o">=</span> <span class="s2">&quot;SPACK_CCACHE_BINARY&quot;</span>
<span class="n">SPACK_SYSTEM_DIRS</span> <span class="o">=</span> <span class="s2">&quot;SPACK_SYSTEM_DIRS&quot;</span>

<span class="c1"># Platform-specific library suffix.</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
    <span class="n">dso_suffix</span> <span class="o">=</span> <span class="s2">&quot;dylib&quot;</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
    <span class="n">dso_suffix</span> <span class="o">=</span> <span class="s2">&quot;dll&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">dso_suffix</span> <span class="o">=</span> <span class="s2">&quot;so&quot;</span>

<span class="n">stat_suffix</span> <span class="o">=</span> <span class="s2">&quot;lib&quot;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span> <span class="k">else</span> <span class="s2">&quot;a&quot;</span>


<div class="viewcode-block" id="jobserver_enabled">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.jobserver_enabled">[docs]</a>
<span class="k">def</span> <span class="nf">jobserver_enabled</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns true if a posix jobserver (make) is detected.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;MAKEFLAGS&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s2">&quot;--jobserver&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MAKEFLAGS&quot;</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_effective_jobs">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.get_effective_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">get_effective_jobs</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_jobserver</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the number of jobs, or None if supports_jobserver and a jobserver is detected.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parallel</span> <span class="ow">or</span> <span class="n">jobs</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">env_flag</span><span class="p">(</span><span class="n">SPACK_NO_PARALLEL_MAKE</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">supports_jobserver</span> <span class="ow">and</span> <span class="n">jobserver_enabled</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">jobs</span></div>



<div class="viewcode-block" id="MakeExecutable">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.MakeExecutable">[docs]</a>
<span class="k">class</span> <span class="nc">MakeExecutable</span><span class="p">(</span><span class="n">Executable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Special callable executable object for make so the user can specify</span>
<span class="sd">    parallelism options on a per-invocation basis.  Specifying</span>
<span class="sd">    &#39;parallel&#39; to the call will override whatever the package&#39;s</span>
<span class="sd">    global setting is, so you can either default to true or false and</span>
<span class="sd">    override particular calls. Specifying &#39;jobs_env&#39; to a particular</span>
<span class="sd">    call will name an environment variable which will be set to the</span>
<span class="sd">    parallelism level (without affecting the normal invocation with</span>
<span class="sd">    -j).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">supports_jobserver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;supports_jobserver&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supports_jobserver</span> <span class="o">=</span> <span class="n">supports_jobserver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">jobs</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;parallel, and jobs_env from kwargs are swallowed and used here;</span>
<span class="sd">        remaining arguments are passed through to the superclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">jobs_env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;jobs_env&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">jobs_env_supports_jobserver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;jobs_env_supports_jobserver&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">jobs</span> <span class="o">=</span> <span class="n">get_effective_jobs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">supports_jobserver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supports_jobserver</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;-j</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobs</span><span class="p">),)</span> <span class="o">+</span> <span class="n">args</span>

        <span class="k">if</span> <span class="n">jobs_env</span><span class="p">:</span>
            <span class="c1"># Caller wants us to set an environment variable to</span>
            <span class="c1"># control the parallelism.</span>
            <span class="n">jobs_env_jobs</span> <span class="o">=</span> <span class="n">get_effective_jobs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">supports_jobserver</span><span class="o">=</span><span class="n">jobs_env_supports_jobserver</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">jobs_env_jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;extra_env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">jobs_env</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobs_env_jobs</span><span class="p">)}</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="clean_environment">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.clean_environment">[docs]</a>
<span class="k">def</span> <span class="nf">clean_environment</span><span class="p">():</span>
    <span class="c1"># Stuff in here sanitizes the build environment to eliminate</span>
    <span class="c1"># anything the user has set that may interfere. We apply it immediately</span>
    <span class="c1"># unlike the other functions so it doesn&#39;t overwrite what the modules load.</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span>

    <span class="c1"># Remove these vars from the environment during build because they</span>
    <span class="c1"># can affect how some packages find libraries.  We want to make</span>
    <span class="c1"># sure that builds never pull in unintended external dependencies.</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;LD_LIBRARY_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;LD_RUN_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;DYLD_LIBRARY_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;DYLD_FALLBACK_LIBRARY_PATH&quot;</span><span class="p">)</span>

    <span class="c1"># These vars affect how the compiler finds libraries and include dirs.</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;LIBRARY_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;CPATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;C_INCLUDE_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;CPLUS_INCLUDE_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;OBJC_INCLUDE_PATH&quot;</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;CMAKE_PREFIX_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;R_HOME&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;R_ENVIRON&quot;</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;LUA_PATH&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;LUA_CPATH&quot;</span><span class="p">)</span>

    <span class="c1"># Affects GNU make, can e.g. indirectly inhibit enabling parallel build</span>
    <span class="c1"># env.unset(&#39;MAKEFLAGS&#39;)</span>

    <span class="c1"># Avoid that libraries of build dependencies get hijacked.</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;LD_PRELOAD&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s2">&quot;DYLD_INSERT_LIBRARIES&quot;</span><span class="p">)</span>

    <span class="c1"># Avoid &lt;packagename&gt;_ROOT user variables overriding spack dependencies</span>
    <span class="c1"># https://cmake.org/cmake/help/latest/variable/PackageName_ROOT.html</span>
    <span class="c1"># Spack needs SPACK_ROOT though, so we need to exclude that</span>
    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_ROOT&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">varname</span> <span class="o">!=</span> <span class="s2">&quot;SPACK_ROOT&quot;</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>

    <span class="c1"># Unset the following variables because they can affect installation of</span>
    <span class="c1"># Autotools and CMake packages.</span>
    <span class="n">build_system_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;CC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CFLAGS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CPP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CPPFLAGS&quot;</span><span class="p">,</span>  <span class="c1"># C variables</span>
        <span class="s2">&quot;CXX&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CCC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CXXFLAGS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CXXCPP&quot;</span><span class="p">,</span>  <span class="c1"># C++ variables</span>
        <span class="s2">&quot;F77&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FFLAGS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FLIBS&quot;</span><span class="p">,</span>  <span class="c1"># Fortran77 variables</span>
        <span class="s2">&quot;FC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FCFLAGS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FCLIBS&quot;</span><span class="p">,</span>  <span class="c1"># Fortran variables</span>
        <span class="s2">&quot;LDFLAGS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LIBS&quot;</span><span class="p">,</span>  <span class="c1"># linker variables</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">build_system_vars</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># Unset mpi environment vars. These flags should only be set by</span>
    <span class="c1"># mpi providers for packages with mpi dependencies</span>
    <span class="n">mpi_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MPICC&quot;</span><span class="p">,</span> <span class="s2">&quot;MPICXX&quot;</span><span class="p">,</span> <span class="s2">&quot;MPIFC&quot;</span><span class="p">,</span> <span class="s2">&quot;MPIF77&quot;</span><span class="p">,</span> <span class="s2">&quot;MPIF90&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mpi_vars</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">build_lang</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:build_language&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">build_lang</span><span class="p">:</span>
        <span class="c1"># Override language-related variables. This can be used to force</span>
        <span class="c1"># English compiler messages etc., which allows parse_log_events to</span>
        <span class="c1"># show useful matches.</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;LC_ALL&quot;</span><span class="p">,</span> <span class="n">build_lang</span><span class="p">)</span>

    <span class="c1"># Remove any macports installs from the PATH.  The macports ld can</span>
    <span class="c1"># cause conflicts with the built-in linker on el capitan.  Solves</span>
    <span class="c1"># assembler issues, e.g.:</span>
    <span class="c1">#    suffix or operands invalid for `movq&#39;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;/macports/&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">remove_path</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">env</span></div>



<span class="k">def</span> <span class="nf">_add_werror_handling</span><span class="p">(</span><span class="n">keep_werror</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="n">keep_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># set of pairs</span>
    <span class="n">replace_flags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">keep_werror</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">keep_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;-Werror*&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keep_werror</span> <span class="o">==</span> <span class="s2">&quot;specific&quot;</span><span class="p">:</span>
            <span class="n">keep_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;-Werror-*&quot;</span><span class="p">)</span>
            <span class="n">keep_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;-Werror=*&quot;</span><span class="p">)</span>
        <span class="c1"># This extra case is to handle -Werror-implicit-function-declaration</span>
        <span class="n">replace_flags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;-Werror-&quot;</span><span class="p">,</span> <span class="s2">&quot;-Wno-error=&quot;</span><span class="p">))</span>
        <span class="n">replace_flags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;-Werror&quot;</span><span class="p">,</span> <span class="s2">&quot;-Wno-error&quot;</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_COMPILER_FLAGS_KEEP&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keep_flags</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_COMPILER_FLAGS_REPLACE&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">replace_flags</span><span class="p">]))</span>


<div class="viewcode-block" id="set_compiler_environment_variables">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.set_compiler_environment_variables">[docs]</a>
<span class="k">def</span> <span class="nf">set_compiler_environment_variables</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">concrete</span>
    <span class="n">compiler</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">compiler</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span>

    <span class="c1"># Make sure the executables for this compiler exist</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">verify_executables</span><span class="p">()</span>

    <span class="c1"># Set compiler variables used by CMake and autotools</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">compiler</span><span class="o">.</span><span class="n">link_paths</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cc&quot;</span><span class="p">,</span> <span class="s2">&quot;cxx&quot;</span><span class="p">,</span> <span class="s2">&quot;f77&quot;</span><span class="p">,</span> <span class="s2">&quot;fc&quot;</span><span class="p">))</span>

    <span class="c1"># Populate an object with the list of environment modifications</span>
    <span class="c1"># and return it</span>
    <span class="c1"># TODO : add additional kwargs for better diagnostics, like requestor,</span>
    <span class="c1"># ttyout, ttyerr, etc.</span>
    <span class="n">link_dir</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">build_env_path</span>

    <span class="c1"># Set SPACK compiler variables so that our wrapper knows what to</span>
    <span class="c1"># call.  If there is no compiler configured then use a default</span>
    <span class="c1"># wrapper which will emit an error if it is used.</span>
    <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_CC&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">cc</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="s2">&quot;cc&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">cxx</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_CXX&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">cxx</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;CXX&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;cxx&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="s2">&quot;c++&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">f77</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_F77&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">f77</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;F77&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;f77&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;F77&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="s2">&quot;f77&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">fc</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_FC&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">fc</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;FC&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;fc&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;FC&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="s2">&quot;fc&quot;</span><span class="p">))</span>

    <span class="c1"># Set SPACK compiler rpath flags so that our wrapper knows what to use</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_CC_RPATH_ARG&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">cc_rpath_arg</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_CXX_RPATH_ARG&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">cxx_rpath_arg</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_F77_RPATH_ARG&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">f77_rpath_arg</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_FC_RPATH_ARG&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">fc_rpath_arg</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_LINKER_ARG&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">linker_arg</span><span class="p">)</span>

    <span class="c1"># Check whether we want to force RPATH or RUNPATH</span>
    <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:shared_linking:type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;rpath&quot;</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_DTAGS_TO_STRIP&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">enable_new_dtags</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_DTAGS_TO_ADD&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">disable_new_dtags</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_DTAGS_TO_STRIP&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">disable_new_dtags</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_DTAGS_TO_ADD&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">.</span><span class="n">enable_new_dtags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keep_werror</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keep_werror</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keep_werror</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keep_werror</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:flags:keep_werror&quot;</span><span class="p">)</span>

    <span class="n">_add_werror_handling</span><span class="p">(</span><span class="n">keep_werror</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># Set the target parameters that the compiler will add</span>
    <span class="n">isa_arg</span> <span class="o">=</span> <span class="n">optimization_flags</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_TARGET_ARGS&quot;</span><span class="p">,</span> <span class="n">isa_arg</span><span class="p">)</span>

    <span class="c1"># Trap spack-tracked compiler flags as appropriate.</span>
    <span class="c1"># env_flags are easy to accidentally override.</span>
    <span class="n">inject_flags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">env_flags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">build_system_flags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">FlagMap</span><span class="o">.</span><span class="n">valid_compiler_flags</span><span class="p">():</span>
        <span class="c1"># Always convert flag_handler to function type.</span>
        <span class="c1"># This avoids discrepencies in calling conventions between functions</span>
        <span class="c1"># and methods, or between bound and unbound methods in python 2.</span>
        <span class="c1"># We cannot effectively convert everything to a bound method, which</span>
        <span class="c1"># would be the simpler solution.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">flag_handler</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">flag_handler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">flag_handler</span><span class="o">.</span><span class="vm">__func__</span>

        <span class="n">injf</span><span class="p">,</span> <span class="n">envf</span><span class="p">,</span> <span class="n">bsf</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">compiler_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">][:])</span>
        <span class="n">inject_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">=</span> <span class="n">injf</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">env_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">=</span> <span class="n">envf</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">build_system_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">=</span> <span class="n">bsf</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="c1"># Place compiler flags as specified by flag_handler</span>
    <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">FlagMap</span><span class="o">.</span><span class="n">valid_compiler_flags</span><span class="p">():</span>
        <span class="c1"># Concreteness guarantees key safety here</span>
        <span class="k">if</span> <span class="n">inject_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]:</span>
            <span class="c1"># variables SPACK_&lt;FLAG&gt; inject flags through wrapper</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;SPACK_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">inject_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">env_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]:</span>
            <span class="c1"># implicit variables</span>
            <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">env_flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]))</span>
    <span class="n">pkg</span><span class="o">.</span><span class="n">flags_to_build_system_args</span><span class="p">(</span><span class="n">build_system_flags</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_COMPILER_SPEC&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">compiler</span><span class="p">))</span>

    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_SYSTEM_DIRS&quot;</span><span class="p">,</span> <span class="n">SYSTEM_DIR_CASE_ENTRY</span><span class="p">)</span>

    <span class="n">compiler</span><span class="o">.</span><span class="n">setup_custom_environment</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">env</span></div>



<div class="viewcode-block" id="optimization_flags">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.optimization_flags">[docs]</a>
<span class="k">def</span> <span class="nf">optimization_flags</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">is_mixed_toolchain</span><span class="p">(</span><span class="n">compiler</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;microarchitecture specific optimizations are not &quot;</span>
            <span class="s2">&quot;supported yet on mixed compiler toolchains [check&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">compiler</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2"> for further details]&quot;</span>
        <span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Try to check if the current compiler comes with a version number or</span>
    <span class="c1"># has an unexpected suffix. If so, treat it as a compiler with a</span>
    <span class="c1"># custom spec.</span>
    <span class="n">compiler_version</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">version</span>
    <span class="n">version_number</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">version_components</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">version_number</span> <span class="ow">or</span> <span class="n">suffix</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">compiler_version</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">real_version</span>
        <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">ProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># log this and just return compiler.version instead</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">optimization_flags</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">compiler_version</span><span class="o">.</span><span class="n">dotted_numeric_string</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">archspec</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">UnsupportedMicroarchitecture</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="FilterDefaultDynamicLinkerSearchPaths">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.FilterDefaultDynamicLinkerSearchPaths">[docs]</a>
<span class="k">class</span> <span class="nc">FilterDefaultDynamicLinkerSearchPaths</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove rpaths to directories that are default search paths of the dynamic linker.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dynamic_linker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Identify directories by (inode, device) tuple, which handles symlinks too.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_path_identifiers</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dynamic_linker</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">default_search_paths_from_dynamic_linker</span><span class="p">(</span><span class="n">dynamic_linker</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">default_path_identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">st_ino</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">st_dev</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">continue</span>

<div class="viewcode-block" id="FilterDefaultDynamicLinkerSearchPaths.is_dynamic_loader_default_path">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.FilterDefaultDynamicLinkerSearchPaths.is_dynamic_loader_default_path">[docs]</a>
    <span class="k">def</span> <span class="nf">is_dynamic_loader_default_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">st_ino</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">st_dev</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_path_identifiers</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_path_identifiers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dirs</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dynamic_loader_default_path</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span></div>



<div class="viewcode-block" id="set_wrapper_variables">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.set_wrapper_variables">[docs]</a>
<span class="k">def</span> <span class="nf">set_wrapper_variables</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set environment variables used by the Spack compiler wrapper (which have the prefix</span>
<span class="sd">    `SPACK_`) and also add the compiler wrappers to PATH.</span>

<span class="sd">    This determines the injected -L/-I/-rpath options; each of these specifies a search order and</span>
<span class="sd">    this function computes these options in a manner that is intended to match the DAG traversal</span>
<span class="sd">    order in `SetupContext`. TODO: this is not the case yet, we&#39;re using post order, SetupContext</span>
<span class="sd">    is using topo order.&quot;&quot;&quot;</span>
    <span class="c1"># Set environment variables if specified for</span>
    <span class="c1"># the given compiler</span>
    <span class="n">compiler</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">compiler</span>
    <span class="n">env</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">environment</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">extra_rpaths</span><span class="p">:</span>
        <span class="n">extra_rpaths</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">extra_rpaths</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_COMPILER_EXTRA_RPATHS&quot;</span><span class="p">,</span> <span class="n">extra_rpaths</span><span class="p">)</span>

    <span class="c1"># Add spack build environment path with compiler wrappers first in</span>
    <span class="c1"># the path. We add the compiler wrapper path, which includes default</span>
    <span class="c1"># wrappers (cc, c++, f77, f90), AND a subdirectory containing</span>
    <span class="c1"># compiler-specific symlinks.  The latter ensures that builds that</span>
    <span class="c1"># are sensitive to the *name* of the compiler see the right name when</span>
    <span class="c1"># we&#39;re building with the wrappers.</span>
    <span class="c1">#</span>
    <span class="c1"># Conflicts on case-insensitive systems (like &quot;CC&quot; and &quot;cc&quot;) are</span>
    <span class="c1"># handled by putting one in the &lt;build_env_path&gt;/case-insensitive</span>
    <span class="c1"># directory.  Add that to the path too.</span>
    <span class="n">env_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">compiler_specific</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">build_env_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">build_env_path</span><span class="p">,</span> <span class="n">compiler_specific</span><span class="p">]:</span>
        <span class="n">env_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;case-insensitive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ci</span><span class="p">):</span>
            <span class="n">env_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding compiler bin/ paths: &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env_paths</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">env_paths</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set_path</span><span class="p">(</span><span class="n">SPACK_ENV_PATH</span><span class="p">,</span> <span class="n">env_paths</span><span class="p">)</span>

    <span class="c1"># Working directory for the spack command itself, for debug logs.</span>
    <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:debug&quot;</span><span class="p">):</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_DEBUG</span><span class="p">,</span> <span class="s2">&quot;TRUE&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_SHORT_SPEC</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_DEBUG_LOG_ID</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">-</span><span class="si">{hash:7}</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_DEBUG_LOG_DIR</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">spack_working_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:ccache&quot;</span><span class="p">):</span>
        <span class="c1"># Enable ccache in the compiler wrapper</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_CCACHE_BINARY</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">which_string</span><span class="p">(</span><span class="s2">&quot;ccache&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Avoid cache pollution if a build system forces `ccache &lt;compiler wrapper invocation&gt;`.</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;CCACHE_DISABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>

    <span class="c1"># Gather information about various types of dependencies</span>
    <span class="n">rpath_hashes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">get_rpath_deps</span><span class="p">(</span><span class="n">pkg</span><span class="p">))</span>
    <span class="n">link_deps</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;topo&quot;</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">LINK</span><span class="p">)</span>
    <span class="n">external_link_deps</span><span class="p">,</span> <span class="n">nonexternal_link_deps</span> <span class="o">=</span> <span class="n">stable_partition</span><span class="p">(</span><span class="n">link_deps</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">external</span><span class="p">)</span>

    <span class="n">link_dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rpath_dirs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">external_link_deps</span><span class="p">,</span> <span class="n">nonexternal_link_deps</span><span class="p">):</span>
        <span class="c1"># TODO: is_system_path is wrong, but even if we knew default -L, -I flags from the compiler</span>
        <span class="c1"># and default search dirs from the dynamic linker, it&#39;s not obvious how to avoid a possibly</span>
        <span class="c1"># expensive search in `query.libs.directories` and `query.headers.directories`, which is</span>
        <span class="c1"># what this branch is trying to avoid.</span>
        <span class="k">if</span> <span class="n">is_system_path</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># TODO: as of Spack 0.22, multiple instances of the same package may occur among the link</span>
        <span class="c1"># deps, so keying by name is wrong. In practice it is not problematic: we obtain the same</span>
        <span class="c1"># gcc-runtime / glibc here, and repeatedly add the same dirs that are later deduped.</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">dep_link_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locating libraries can be time consuming, so log start and finish.</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collecting libraries for </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dep_link_dirs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">directories</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Libraries for </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> have been collected.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NoLibrariesError</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No libraries found for </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">default_lib_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;lib64&quot;</span><span class="p">):</span>
            <span class="n">default_lib_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">default_lib_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">default_lib_prefix</span><span class="p">):</span>
                <span class="n">dep_link_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_lib_prefix</span><span class="p">)</span>

        <span class="n">link_dirs</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep_link_dirs</span>
        <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="n">rpath_hashes</span><span class="p">:</span>
            <span class="n">rpath_dirs</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep_link_dirs</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collecting headers for </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">include_dirs</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">directories</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Headers for </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> have been collected.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NoHeadersError</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No headers found for </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># The top-level package is heuristically rpath&#39;ed.</span>
    <span class="k">for</span> <span class="n">libdir</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;lib64&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">):</span>
        <span class="n">lib_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">libdir</span><span class="p">)</span>
        <span class="n">rpath_dirs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lib_path</span><span class="p">)</span>

    <span class="n">filter_default_dynamic_linker_search_paths</span> <span class="o">=</span> <span class="n">FilterDefaultDynamicLinkerSearchPaths</span><span class="p">(</span>
        <span class="n">pkg</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">default_dynamic_linker</span>
    <span class="p">)</span>

    <span class="c1"># TODO: filter_system_paths is again wrong (and probably unnecessary due to the is_system_path</span>
    <span class="c1"># branch above). link_dirs should be filtered with entries from _parse_link_paths.</span>
    <span class="n">link_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dedupe</span><span class="p">(</span><span class="n">filter_system_paths</span><span class="p">(</span><span class="n">link_dirs</span><span class="p">)))</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dedupe</span><span class="p">(</span><span class="n">filter_system_paths</span><span class="p">(</span><span class="n">include_dirs</span><span class="p">)))</span>
    <span class="n">rpath_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dedupe</span><span class="p">(</span><span class="n">filter_system_paths</span><span class="p">(</span><span class="n">rpath_dirs</span><span class="p">)))</span>
    <span class="n">rpath_dirs</span> <span class="o">=</span> <span class="n">filter_default_dynamic_linker_search_paths</span><span class="p">(</span><span class="n">rpath_dirs</span><span class="p">)</span>

    <span class="c1"># TODO: implicit_rpaths is prefiltered by is_system_path, that should be removed in favor of</span>
    <span class="c1"># just this filter.</span>
    <span class="n">implicit_rpaths</span> <span class="o">=</span> <span class="n">filter_default_dynamic_linker_search_paths</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">implicit_rpaths</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">implicit_rpaths</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SPACK_COMPILER_IMPLICIT_RPATHS&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">implicit_rpaths</span><span class="p">))</span>

    <span class="c1"># Spack managed directories include the stage, store and upstream stores. We extend this with</span>
    <span class="c1"># their real paths to make it more robust (e.g. /tmp vs /private/tmp on macOS).</span>
    <span class="n">spack_managed_dirs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_stage_root</span><span class="p">(),</span>
        <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
        <span class="o">*</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">root</span> <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">spack</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">STORE</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">upstream_dbs</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">spack_managed_dirs</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">spack_managed_dirs</span><span class="p">])</span>

    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_MANAGED_DIRS</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">/&quot;*&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spack_managed_dirs</span><span class="p">)))</span>
    <span class="n">is_spack_managed</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">store</span><span class="p">)</span> <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">spack_managed_dirs</span><span class="p">)</span>
    <span class="n">link_dirs_spack</span><span class="p">,</span> <span class="n">link_dirs_system</span> <span class="o">=</span> <span class="n">stable_partition</span><span class="p">(</span><span class="n">link_dirs</span><span class="p">,</span> <span class="n">is_spack_managed</span><span class="p">)</span>
    <span class="n">include_dirs_spack</span><span class="p">,</span> <span class="n">include_dirs_system</span> <span class="o">=</span> <span class="n">stable_partition</span><span class="p">(</span><span class="n">include_dirs</span><span class="p">,</span> <span class="n">is_spack_managed</span><span class="p">)</span>
    <span class="n">rpath_dirs_spack</span><span class="p">,</span> <span class="n">rpath_dirs_system</span> <span class="o">=</span> <span class="n">stable_partition</span><span class="p">(</span><span class="n">rpath_dirs</span><span class="p">,</span> <span class="n">is_spack_managed</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_LINK_DIRS</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dirs_system</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_INCLUDE_DIRS</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">include_dirs_system</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_RPATH_DIRS</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rpath_dirs_system</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_STORE_LINK_DIRS</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dirs_spack</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_STORE_INCLUDE_DIRS</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">include_dirs_spack</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">SPACK_STORE_RPATH_DIRS</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rpath_dirs_spack</span><span class="p">))</span></div>



<div class="viewcode-block" id="set_package_py_globals">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.set_package_py_globals">[docs]</a>
<span class="k">def</span> <span class="nf">set_package_py_globals</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populate the Python module of a package with some useful global names.</span>
<span class="sd">    This makes things easier for package writers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">ModuleChangePropagator</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

    <span class="n">jobs</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">determine_number_of_jobs</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
    <span class="n">module</span><span class="o">.</span><span class="n">make_jobs</span> <span class="o">=</span> <span class="n">jobs</span>
    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">std_meson_args</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">meson</span><span class="o">.</span><span class="n">MesonBuilder</span><span class="o">.</span><span class="n">std_args</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
        <span class="n">module</span><span class="o">.</span><span class="n">std_pip_args</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">PythonPipBuilder</span><span class="o">.</span><span class="n">std_args</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

    <span class="c1"># TODO: make these build deps that can be installed if not found.</span>
    <span class="n">module</span><span class="o">.</span><span class="n">make</span> <span class="o">=</span> <span class="n">MakeExecutable</span><span class="p">(</span><span class="s2">&quot;make&quot;</span><span class="p">,</span> <span class="n">jobs</span><span class="p">)</span>
    <span class="n">module</span><span class="o">.</span><span class="n">gmake</span> <span class="o">=</span> <span class="n">MakeExecutable</span><span class="p">(</span><span class="s2">&quot;gmake&quot;</span><span class="p">,</span> <span class="n">jobs</span><span class="p">)</span>
    <span class="n">module</span><span class="o">.</span><span class="n">ninja</span> <span class="o">=</span> <span class="n">MakeExecutable</span><span class="p">(</span><span class="s2">&quot;ninja&quot;</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="n">supports_jobserver</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># TODO: johnwparent: add package or builder support to define these build tools</span>
    <span class="c1"># for now there is no entrypoint for builders to define these on their</span>
    <span class="c1"># own</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">nmake</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="s2">&quot;nmake&quot;</span><span class="p">)</span>
        <span class="n">module</span><span class="o">.</span><span class="n">msbuild</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="s2">&quot;msbuild&quot;</span><span class="p">)</span>
        <span class="c1"># analog to configure for win32</span>
        <span class="n">module</span><span class="o">.</span><span class="n">cscript</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="s2">&quot;cscript&quot;</span><span class="p">)</span>

    <span class="c1"># Find the configure script in the archive path</span>
    <span class="c1"># Don&#39;t use which for this; we want to find it in the current dir.</span>
    <span class="n">module</span><span class="o">.</span><span class="n">configure</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="s2">&quot;./configure&quot;</span><span class="p">)</span>

    <span class="c1"># Put spack compiler paths in module scope. (Some packages use it</span>
    <span class="c1"># in setup_run_environment etc, so don&#39;t put it context == build)</span>
    <span class="n">link_dir</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">build_env_path</span>
    <span class="n">pkg_compiler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pkg_compiler</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">compiler</span>
    <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">NoCompilerForSpecError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot set &#39;spack_cc&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pkg_compiler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_cc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">pkg_compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">])</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_cxx</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">pkg_compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;cxx&quot;</span><span class="p">])</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_f77</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">pkg_compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;f77&quot;</span><span class="p">])</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_fc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_dir</span><span class="p">,</span> <span class="n">pkg_compiler</span><span class="o">.</span><span class="n">link_paths</span><span class="p">[</span><span class="s2">&quot;fc&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_cc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_cxx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_f77</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">module</span><span class="o">.</span><span class="n">spack_fc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Useful directories within the prefix are encapsulated in</span>
    <span class="c1"># a Prefix object.</span>
    <span class="n">module</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">prefix</span>

    <span class="c1"># Platform-specific library suffix.</span>
    <span class="n">module</span><span class="o">.</span><span class="n">dso_suffix</span> <span class="o">=</span> <span class="n">dso_suffix</span>

    <span class="k">def</span> <span class="nf">static_to_shared_library</span><span class="p">(</span><span class="n">static_lib</span><span class="p">,</span> <span class="n">shared_lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compiler&quot;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">spack_cc</span><span class="p">)</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_static_to_shared_library</span><span class="p">(</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">static_lib</span><span class="p">,</span> <span class="n">shared_lib</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="n">module</span><span class="o">.</span><span class="n">static_to_shared_library</span> <span class="o">=</span> <span class="n">static_to_shared_library</span>

    <span class="n">module</span><span class="o">.</span><span class="n">propagate_changes_to_mro</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">_static_to_shared_library</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">static_lib</span><span class="p">,</span> <span class="n">shared_lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a static library to a shared library. The static library has to</span>
<span class="sd">    be built with PIC for the conversion to work.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        static_lib (str): Path to the static library.</span>
<span class="sd">        shared_lib (str): Path to the shared library. Default is to derive</span>
<span class="sd">                          from the static library&#39;s path.</span>

<span class="sd">    Keyword arguments:</span>
<span class="sd">        compiler (str): Path to the compiler. Default is spack_cc.</span>
<span class="sd">        compiler_output: Where to print compiler output to.</span>
<span class="sd">        arguments (str list): Additional arguments for the compiler.</span>
<span class="sd">        version (str): Library version. Default is unspecified.</span>
<span class="sd">        compat_version (str): Library compatibility version. Default is</span>
<span class="sd">                              version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">compiler_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compiler_output&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">compat_version</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compat_version&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">shared_lib</span><span class="p">:</span>
        <span class="n">shared_lib</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">static_lib</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dso_suffix</span><span class="p">)</span>

    <span class="n">compiler_args</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># TODO: Compiler arguments should not be hardcoded but provided by</span>
    <span class="c1">#       the different compiler classes.</span>
    <span class="k">if</span> <span class="s2">&quot;linux&quot;</span> <span class="ow">in</span> <span class="n">arch</span> <span class="ow">or</span> <span class="s2">&quot;cray&quot;</span> <span class="ow">in</span> <span class="n">arch</span><span class="p">:</span>
        <span class="n">soname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">shared_lib</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">compat_version</span><span class="p">:</span>
            <span class="n">soname</span> <span class="o">+=</span> <span class="s2">&quot;.</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compat_version</span><span class="p">)</span>

        <span class="n">compiler_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;-shared&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-Wl,-soname,</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">soname</span><span class="p">),</span>
            <span class="s2">&quot;-Wl,--whole-archive&quot;</span><span class="p">,</span>
            <span class="n">static_lib</span><span class="p">,</span>
            <span class="s2">&quot;-Wl,--no-whole-archive&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;darwin&quot;</span> <span class="ow">in</span> <span class="n">arch</span><span class="p">:</span>
        <span class="n">install_name</span> <span class="o">=</span> <span class="n">shared_lib</span>

        <span class="k">if</span> <span class="n">compat_version</span><span class="p">:</span>
            <span class="n">install_name</span> <span class="o">+=</span> <span class="s2">&quot;.</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compat_version</span><span class="p">)</span>

        <span class="n">compiler_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;-dynamiclib&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-install_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">install_name</span><span class="p">),</span>
            <span class="s2">&quot;-Wl,-force_load,</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">static_lib</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">compat_version</span><span class="p">:</span>
            <span class="n">compiler_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-compatibility_version&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compat_version</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
            <span class="n">compiler_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-current_version&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">compiler_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>

    <span class="n">shared_lib_base</span> <span class="o">=</span> <span class="n">shared_lib</span>

    <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
        <span class="n">shared_lib</span> <span class="o">+=</span> <span class="s2">&quot;.</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compat_version</span><span class="p">:</span>
        <span class="n">shared_lib</span> <span class="o">+=</span> <span class="s2">&quot;.</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compat_version</span><span class="p">)</span>

    <span class="n">compiler_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">shared_lib</span><span class="p">])</span>

    <span class="c1"># Create symlinks for version and compat_version</span>
    <span class="n">shared_lib_link</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">shared_lib</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">version</span> <span class="ow">or</span> <span class="n">compat_version</span><span class="p">:</span>
        <span class="n">symlink</span><span class="p">(</span><span class="n">shared_lib_link</span><span class="p">,</span> <span class="n">shared_lib_base</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">compat_version</span> <span class="ow">and</span> <span class="n">compat_version</span> <span class="o">!=</span> <span class="n">version</span><span class="p">:</span>
        <span class="n">symlink</span><span class="p">(</span><span class="n">shared_lib_link</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shared_lib_base</span><span class="p">,</span> <span class="n">compat_version</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">compiler</span><span class="p">(</span><span class="o">*</span><span class="n">compiler_args</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">compiler_output</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_rpath_deps_from_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">transitive_rpaths</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">transitive_rpaths</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">LINK</span><span class="p">)</span>

    <span class="n">by_name</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">LINK</span><span class="p">):</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="n">by_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lookup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">by_name</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep</span>
        <span class="k">elif</span> <span class="n">lookup</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">dep</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="n">by_name</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">by_name</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>


<div class="viewcode-block" id="get_rpath_deps">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.get_rpath_deps">[docs]</a>
<span class="k">def</span> <span class="nf">get_rpath_deps</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return immediate or transitive dependencies (depending on the package) that need to be</span>
<span class="sd">    rpath&#39;ed. If a package occurs multiple times, the newest version is kept.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_rpath_deps_from_spec</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">transitive_rpaths</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_external_modules">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.load_external_modules">[docs]</a>
<span class="k">def</span> <span class="nf">load_external_modules</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Traverse a package&#39;s spec DAG and load any external modules.</span>

<span class="sd">    Traverse a package&#39;s dependencies and load any external modules</span>
<span class="sd">    associated with them.</span>

<span class="sd">    Args:</span>
<span class="sd">        pkg (spack.package_base.PackageBase): package to load deps for</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">()):</span>
        <span class="n">external_modules</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">external_modules</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">external_module</span> <span class="ow">in</span> <span class="n">external_modules</span><span class="p">:</span>
            <span class="n">load_module</span><span class="p">(</span><span class="n">external_module</span><span class="p">)</span></div>



<div class="viewcode-block" id="setup_package">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.setup_package">[docs]</a>
<span class="k">def</span> <span class="nf">setup_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">dirty</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute all environment setup routines.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">,</span> <span class="n">Context</span><span class="o">.</span><span class="n">TEST</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;context&#39; must be Context.BUILD or Context.TEST - got </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># First populate the package.py&#39;s module with the relevant globals that could be used in any</span>
    <span class="c1"># of the setup_* functions.</span>
    <span class="n">setup_context</span> <span class="o">=</span> <span class="n">SetupContext</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
    <span class="n">setup_context</span><span class="o">.</span><span class="n">set_all_package_py_globals</span><span class="p">()</span>

    <span class="c1"># Keep track of env changes from packages separately, since we want to</span>
    <span class="c1"># issue warnings when packages make &quot;suspicious&quot; modifications.</span>
    <span class="n">env_base</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span> <span class="k">if</span> <span class="n">dirty</span> <span class="k">else</span> <span class="n">clean_environment</span><span class="p">()</span>
    <span class="n">env_mods</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span>

    <span class="c1"># setup compilers for build contexts</span>
    <span class="n">need_compiler</span> <span class="o">=</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">TEST</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">test_requires_compiler</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">need_compiler</span><span class="p">:</span>
        <span class="n">set_compiler_environment_variables</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">env_mods</span><span class="p">)</span>
        <span class="n">set_wrapper_variables</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">env_mods</span><span class="p">)</span>

    <span class="c1"># Platform specific setup goes before package specific setup. This is for setting</span>
    <span class="c1"># defaults like MACOSX_DEPLOYMENT_TARGET on macOS.</span>
    <span class="n">platform</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">platforms</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
    <span class="n">platform</span><span class="o">.</span><span class="n">setup_platform_environment</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">env_mods</span><span class="p">)</span>

    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setup_package: grabbing modifications from dependencies&quot;</span><span class="p">)</span>
    <span class="n">env_mods</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">setup_context</span><span class="o">.</span><span class="n">get_env_modifications</span><span class="p">())</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setup_package: collected all modifications from dependencies&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">TEST</span><span class="p">:</span>
        <span class="n">env_mods</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dirty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env_mods</span><span class="o">.</span><span class="n">is_unset</span><span class="p">(</span><span class="s2">&quot;CPATH&quot;</span><span class="p">):</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;A dependency has updated CPATH, this may lead pkg-config to assume that the package &quot;</span>
            <span class="s2">&quot;is part of the system includes and omit it when invoked with &#39;--cflags&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># First apply the clean environment changes</span>
    <span class="n">env_base</span><span class="o">.</span><span class="n">apply_modifications</span><span class="p">()</span>

    <span class="c1"># Load modules on an already clean environment, just before applying Spack&#39;s</span>
    <span class="c1"># own environment modifications. This ensures Spack controls CC/CXX/... variables.</span>
    <span class="k">if</span> <span class="n">need_compiler</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setup_package: loading compiler modules&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">load_module</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

    <span class="n">load_external_modules</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

    <span class="c1"># Make sure nothing&#39;s strange about the Spack environment.</span>
    <span class="n">validate</span><span class="p">(</span><span class="n">env_mods</span><span class="p">,</span> <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">)</span>
    <span class="n">env_mods</span><span class="o">.</span><span class="n">apply_modifications</span><span class="p">()</span>

    <span class="c1"># Return all env modifications we controlled (excluding module related ones)</span>
    <span class="n">env_base</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">env_mods</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env_base</span></div>



<div class="viewcode-block" id="EnvironmentVisitor">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.EnvironmentVisitor">[docs]</a>
<span class="k">class</span> <span class="nc">EnvironmentVisitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">roots</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">):</span>
        <span class="c1"># For the roots (well, marked specs) we follow different edges</span>
        <span class="c1"># than for their deps, depending on the context.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_hashes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">:</span>
            <span class="c1"># Drop direct run deps in build context</span>
            <span class="c1"># We don&#39;t really distinguish between install and build time test deps,</span>
            <span class="c1"># so we include them here as build-time test deps.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_depflag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">TEST</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span>
        <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">TEST</span><span class="p">:</span>
            <span class="c1"># This is more of an extended run environment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_depflag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">TEST</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span>
        <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">RUN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_depflag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span>

<div class="viewcode-block" id="EnvironmentVisitor.neighbors">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.EnvironmentVisitor.neighbors">[docs]</a>
    <span class="k">def</span> <span class="nf">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_hashes</span><span class="p">:</span>
            <span class="n">depflag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_depflag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depflag</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span>
        <span class="k">return</span> <span class="n">traverse</span><span class="o">.</span><span class="n">sort_edges</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">(</span><span class="n">depflag</span><span class="o">=</span><span class="n">depflag</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="UseMode">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.UseMode">[docs]</a>
<span class="k">class</span> <span class="nc">UseMode</span><span class="p">(</span><span class="n">Flag</span><span class="p">):</span>
    <span class="c1">#: Entrypoint spec (a spec to be built; an env root, etc)</span>
    <span class="n">ROOT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: A spec used at runtime, but no executables in PATH</span>
    <span class="n">RUNTIME</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: A spec used at runtime, with executables in PATH</span>
    <span class="n">RUNTIME_EXECUTABLE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: A spec that&#39;s a direct build or test dep</span>
    <span class="n">BUILDTIME_DIRECT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: A spec that should be visible in search paths in a build env.</span>
    <span class="n">BUILDTIME</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

    <span class="c1">#: Flag is set when the (node, mode) is finalized</span>
    <span class="n">ADDED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span></div>



<div class="viewcode-block" id="effective_deptypes">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.effective_deptypes">[docs]</a>
<span class="k">def</span> <span class="nf">effective_deptypes</span><span class="p">(</span>
    <span class="o">*</span><span class="n">specs</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">UseMode</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a list of input specs and a context, return a list of tuples of</span>
<span class="sd">    all specs that contribute to (environment) modifications, together with</span>
<span class="sd">    a flag specifying in what way they do so. The list is ordered topologically</span>
<span class="sd">    from root to leaf, meaning that environment modifications should be applied</span>
<span class="sd">    in reverse so that dependents override dependencies, not the other way around.&quot;&quot;&quot;</span>
    <span class="n">visitor</span> <span class="o">=</span> <span class="n">traverse</span><span class="o">.</span><span class="n">TopoVisitor</span><span class="p">(</span>
        <span class="n">EnvironmentVisitor</span><span class="p">(</span><span class="o">*</span><span class="n">specs</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">(),</span>
        <span class="n">root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">all_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">traverse</span><span class="o">.</span><span class="n">traverse_depth_first_with_visitor</span><span class="p">(</span><span class="n">traverse</span><span class="o">.</span><span class="n">with_artificial_edges</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span> <span class="n">visitor</span><span class="p">)</span>

    <span class="c1"># Dictionary with &quot;no mode&quot; as default value, so it&#39;s easy to write modes[x] |= flag.</span>
    <span class="n">use_modes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">UseMode</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">nodes_with_type</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">visitor</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">depflag</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">depflag</span>

        <span class="c1"># Mark the starting point</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ROOT</span>
            <span class="k">continue</span>

        <span class="n">parent_mode</span> <span class="o">=</span> <span class="n">use_modes</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

        <span class="c1"># Nothing to propagate.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_mode</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Dependending on the context, include particular deps from the root.</span>
        <span class="k">if</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ROOT</span> <span class="o">&amp;</span> <span class="n">parent_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">TEST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                    <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME_DIRECT</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                    <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME</span>

            <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">TEST</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">RUN</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">TEST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                    <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME_EXECUTABLE</span>
                <span class="k">elif</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                    <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME</span>

            <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">RUN</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                    <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME_EXECUTABLE</span>
                <span class="k">elif</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                    <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME</span>

        <span class="c1"># Propagate RUNTIME and RUNTIME_EXECUTABLE through link and run deps.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME</span> <span class="o">|</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME_EXECUTABLE</span> <span class="o">|</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME_DIRECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">parent_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME_EXECUTABLE</span>

        <span class="c1"># Propagate BUILDTIME through link deps.</span>
        <span class="k">if</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME</span> <span class="o">&amp;</span> <span class="n">parent_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">&amp;</span> <span class="n">depflag</span><span class="p">:</span>
                <span class="n">use_modes</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME</span>

        <span class="c1"># Finalize the spec; the invariant is that all in-edges are processed</span>
        <span class="c1"># before out-edges, meaning that parent is done.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">UseMode</span><span class="o">.</span><span class="n">ADDED</span> <span class="o">&amp;</span> <span class="n">parent_mode</span><span class="p">):</span>
            <span class="n">use_modes</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ADDED</span>
            <span class="n">nodes_with_type</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent</span><span class="p">,</span> <span class="n">parent_mode</span><span class="p">))</span>

    <span class="c1"># Attach the leaf nodes, since we only added nodes with out-edges.</span>
    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">parent_mode</span> <span class="ow">in</span> <span class="n">use_modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">parent_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">UseMode</span><span class="o">.</span><span class="n">ADDED</span> <span class="o">&amp;</span> <span class="n">parent_mode</span><span class="p">):</span>
            <span class="n">nodes_with_type</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spec</span><span class="p">,</span> <span class="n">parent_mode</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">nodes_with_type</span></div>



<div class="viewcode-block" id="SetupContext">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.SetupContext">[docs]</a>
<span class="k">class</span> <span class="nc">SetupContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class encapsulates the logic to determine environment modifications, and is used as</span>
<span class="sd">    well to set globals in modules of package.py.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">specs</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a ModificationsFromDag object.</span>
<span class="sd">        Args:</span>
<span class="sd">            specs: single root spec for build/test context, possibly more for run context</span>
<span class="sd">            context: build, run, or test&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">TEST</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot setup build environment for multiple specs&quot;</span><span class="p">)</span>
        <span class="n">specs_with_type</span> <span class="o">=</span> <span class="n">effective_deptypes</span><span class="p">(</span><span class="o">*</span><span class="n">specs</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">specs</span> <span class="o">=</span> <span class="n">specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">UseMode</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonexternal</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">UseMode</span><span class="p">]]</span>
        <span class="c1"># Reverse so we go from leaf to root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_in_subdag</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">specs_with_type</span><span class="p">)</span>

        <span class="c1"># Split into non-external and external, maintaining topo order per group.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonexternal</span> <span class="o">=</span> <span class="n">stable_partition</span><span class="p">(</span>
            <span class="nb">reversed</span><span class="p">(</span><span class="n">specs_with_type</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">external</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_be_runnable</span> <span class="o">=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME_DIRECT</span> <span class="o">|</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME_EXECUTABLE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_run_env</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME_DIRECT</span> <span class="o">|</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME</span> <span class="o">|</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">RUNTIME_EXECUTABLE</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_dependent_build_env</span> <span class="o">=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME</span> <span class="o">|</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">BUILDTIME_DIRECT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_build_env</span> <span class="o">=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ROOT</span> <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span> <span class="k">else</span> <span class="n">UseMode</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">RUN</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">TEST</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">should_be_runnable</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ROOT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_run_env</span> <span class="o">|=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ROOT</span>

        <span class="c1"># Everything that calls setup_run_environment and setup_dependent_* needs globals set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_set_package_py_globals</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_dependent_build_env</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_run_env</span> <span class="o">|</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ROOT</span>
        <span class="p">)</span>
        <span class="c1"># In a build context, the root needs build-specific globals set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needs_build_context</span> <span class="o">=</span> <span class="n">UseMode</span><span class="o">.</span><span class="n">ROOT</span>

<div class="viewcode-block" id="SetupContext.set_all_package_py_globals">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.SetupContext.set_all_package_py_globals">[docs]</a>
    <span class="k">def</span> <span class="nf">set_all_package_py_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the globals in modules of package.py files.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dspec</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonexternal</span><span class="p">):</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="n">dspec</span><span class="o">.</span><span class="n">package</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_set_package_py_globals</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_build_context</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">set_package_py_globals</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This includes runtime dependencies, also runtime deps of direct build deps.</span>
                    <span class="n">set_package_py_globals</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">Context</span><span class="o">.</span><span class="n">RUN</span><span class="p">)</span>

        <span class="c1"># Looping over the set of packages a second time</span>
        <span class="c1"># ensures all globals are loaded into the module space prior to</span>
        <span class="c1"># any package setup. This guarantees package setup methods have</span>
        <span class="c1"># access to expected module level definitions such as &quot;spack_cc&quot;</span>
        <span class="k">for</span> <span class="n">dspec</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonexternal</span><span class="p">):</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="n">dspec</span><span class="o">.</span><span class="n">package</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">dspec</span><span class="o">.</span><span class="n">dependents</span><span class="p">():</span>
                <span class="c1"># Note: some specs have dependents that are unreachable from the root, so avoid</span>
                <span class="c1"># setting globals for those.</span>
                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_in_subdag</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dependent_module</span> <span class="o">=</span> <span class="n">ModuleChangePropagator</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
                <span class="n">pkg</span><span class="o">.</span><span class="n">setup_dependent_package</span><span class="p">(</span><span class="n">dependent_module</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
                <span class="n">dependent_module</span><span class="o">.</span><span class="n">propagate_changes_to_mro</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">:</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">package</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">ModuleChangePropagator</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
            <span class="c1"># std_cmake_args is not sufficiently static to be defined</span>
            <span class="c1"># in set_package_py_globals and is deprecated so its handled</span>
            <span class="c1"># here as a special case</span>
            <span class="n">module</span><span class="o">.</span><span class="n">std_cmake_args</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">cmake</span><span class="o">.</span><span class="n">CMakeBuilder</span><span class="o">.</span><span class="n">std_args</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
            <span class="n">module</span><span class="o">.</span><span class="n">propagate_changes_to_mro</span><span class="p">()</span></div>


<div class="viewcode-block" id="SetupContext.get_env_modifications">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.SetupContext.get_env_modifications">[docs]</a>
    <span class="k">def</span> <span class="nf">get_env_modifications</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvironmentModifications</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the environment variable modifications for the given input specs and context.</span>
<span class="sd">        Environment modifications include:</span>
<span class="sd">        - Updating PATH for packages that are required at runtime</span>
<span class="sd">        - Updating CMAKE_PREFIX_PATH and PKG_CONFIG_PATH so that their respective</span>
<span class="sd">        tools can find Spack-built dependencies (when context=build)</span>
<span class="sd">        - Running custom package environment modifications: setup_run_environment,</span>
<span class="sd">        setup_dependent_run_environment, setup_build_environment,</span>
<span class="sd">        setup_dependent_build_environment.</span>

<span class="sd">        The (partial) order imposed on the specs is externals first, then topological</span>
<span class="sd">        from leaf to root. That way externals cannot contribute search paths that would shadow</span>
<span class="sd">        Spack&#39;s prefixes, and dependents override variables set by dependencies.&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dspec</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonexternal</span><span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding env modifications for </span><span class="si">{</span><span class="n">dspec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="n">dspec</span><span class="o">.</span><span class="n">package</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_dependent_build_env</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_buildtime_detectable</span><span class="p">(</span><span class="n">dspec</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>  <span class="c1"># there is only one root in build context</span>
                    <span class="n">spack</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span><span class="o">.</span><span class="n">setup_dependent_build_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_build_env</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span><span class="o">.</span><span class="n">setup_build_environment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_be_runnable</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_runnable</span><span class="p">(</span><span class="n">dspec</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_setup_run_env</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">run_env_mods</span> <span class="o">=</span> <span class="n">EnvironmentModifications</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">dspec</span><span class="o">.</span><span class="n">dependents</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_in_subdag</span><span class="p">:</span>
                        <span class="n">pkg</span><span class="o">.</span><span class="n">setup_dependent_run_environment</span><span class="p">(</span><span class="n">run_env_mods</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
                <span class="n">pkg</span><span class="o">.</span><span class="n">setup_run_environment</span><span class="p">(</span><span class="n">run_env_mods</span><span class="p">)</span>

                <span class="n">external_env</span> <span class="o">=</span> <span class="p">(</span><span class="n">dspec</span><span class="o">.</span><span class="n">extra_attributes</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;environment&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="n">external_env</span><span class="p">:</span>
                    <span class="n">run_env_mods</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">external_env</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="n">Context</span><span class="o">.</span><span class="n">BUILD</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t let the runtime environment of comiler like dependencies leak into the</span>
                    <span class="c1"># build env</span>
                    <span class="n">run_env_mods</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="s2">&quot;CXX&quot;</span><span class="p">,</span> <span class="s2">&quot;F77&quot;</span><span class="p">,</span> <span class="s2">&quot;FC&quot;</span><span class="p">)</span>
                <span class="n">env</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">run_env_mods</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">env</span></div>


    <span class="k">def</span> <span class="nf">_make_buildtime_detectable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">EnvironmentModifications</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_system_path</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="s2">&quot;CMAKE_PREFIX_PATH&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;lib64&quot;</span><span class="p">,</span> <span class="s2">&quot;share&quot;</span><span class="p">):</span>
            <span class="n">pcdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="s2">&quot;pkgconfig&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pcdir</span><span class="p">):</span>
                <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="s2">&quot;PKG_CONFIG_PATH&quot;</span><span class="p">,</span> <span class="n">pcdir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_runnable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">EnvironmentModifications</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_system_path</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;bin64&quot;</span><span class="p">):</span>
            <span class="n">bin_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">bin_dir</span><span class="p">):</span>
                <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="n">bin_dir</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_setup_pkg_and_run</span><span class="p">(</span>
    <span class="n">serialized_pkg</span><span class="p">:</span> <span class="s2">&quot;spack.subprocess_context.PackageInstallContext&quot;</span><span class="p">,</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">write_pipe</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span>
    <span class="n">input_pipe</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Connection</span><span class="p">],</span>
    <span class="n">jsfd1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Connection</span><span class="p">],</span>
    <span class="n">jsfd2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Connection</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point in the child process for Spack builds.</span>

<span class="sd">    ``_setup_pkg_and_run`` is called by the child process created in</span>
<span class="sd">    ``start_build_process()``, and its main job is to run ``function()`` on behalf of</span>
<span class="sd">    some Spack installation (see :ref:`spack.installer.PackageInstaller._install_task`).</span>

<span class="sd">    The child process is passed a ``write_pipe``, on which it&#39;s expected to send one of</span>
<span class="sd">    the following:</span>

<span class="sd">    * ``StopPhase``: error raised by a build process indicating it&#39;s stopping at a</span>
<span class="sd">      particular build phase.</span>

<span class="sd">    * ``BaseException``: any exception raised by a child build process, which will be</span>
<span class="sd">      wrapped in ``ChildError`` (which adds a bunch of debug info and log context) and</span>
<span class="sd">      raised in the parent.</span>

<span class="sd">    * The return value of ``function()``, which can be anything (except an exception).</span>
<span class="sd">      This is returned to the caller.</span>

<span class="sd">    Note: ``jsfd1`` and ``jsfd2`` are passed solely to ensure that the child process</span>
<span class="sd">    does not close these file descriptors. Some ``multiprocessing`` backends will close</span>
<span class="sd">    them automatically in the child if they are not passed at process creation time.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        serialized_pkg: Spack package install context object (serialized form of the</span>
<span class="sd">            package that we&#39;ll build in the child process).</span>
<span class="sd">        function: function to call in the child process; serialized_pkg is passed to</span>
<span class="sd">            this as the first argument.</span>
<span class="sd">        kwargs: additional keyword arguments to pass to ``function()``.</span>
<span class="sd">        write_pipe: multiprocessing ``Connection`` to the parent process, to which the</span>
<span class="sd">            child *must* send a result (or an error) back to parent on.</span>
<span class="sd">        input_multiprocess_fd: stdin from the parent (not passed currently on Windows)</span>
<span class="sd">        jsfd1: gmake Jobserver file descriptor 1.</span>
<span class="sd">        jsfd2: gmake Jobserver file descriptor 2.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># We are in the child process. Python sets sys.stdin to open(os.devnull) to prevent our</span>
        <span class="c1"># process and its parent from simultaneously reading from the original stdin. But, we</span>
        <span class="c1"># assume that the parent process is not going to read from it till we are done with the</span>
        <span class="c1"># child, so we undo Python&#39;s precaution. closefd=False since Connection has ownership.</span>
        <span class="k">if</span> <span class="n">input_pipe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">input_pipe</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">closefd</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pkg</span> <span class="o">=</span> <span class="n">serialized_pkg</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;unmodified_env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;env_modifications&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup_package</span><span class="p">(</span>
                <span class="n">pkg</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">context</span><span class="o">=</span><span class="n">Context</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">write_pipe</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">StopPhase</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Do not create a full ChildError from this, it&#39;s not an error</span>
        <span class="c1"># it&#39;s a control statement.</span>
        <span class="n">write_pipe</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># catch ANYTHING that goes wrong in the child process</span>

        <span class="c1"># Need to unwind the traceback in the child because traceback</span>
        <span class="c1"># objects can&#39;t be sent to the parent.</span>
        <span class="n">exc_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span>
        <span class="n">tb_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tb</span><span class="p">))</span>

        <span class="c1"># build up some context from the offending package so we can</span>
        <span class="c1"># show that, too.</span>
        <span class="n">package_context</span> <span class="o">=</span> <span class="n">get_package_context</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>

        <span class="n">logfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;build&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;log_path&quot;</span><span class="p">):</span>
                    <span class="n">logfile</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">log_path</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="c1"># &#39;pkg&#39; is not defined yet</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">test_suite</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">test_suite</span><span class="o">.</span><span class="n">test_log_name</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">multimethod</span><span class="o">.</span><span class="n">NoSuchMethodError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="s2">&quot;test the installation&quot;</span> <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span> <span class="k">else</span> <span class="s2">&quot;build from sources&quot;</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The &#39;</span><span class="si">{}</span><span class="s2">&#39; package cannot find an attribute while trying to </span><span class="si">{}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;This might be due to a change in Spack&#39;s package format &quot;</span>
                <span class="s2">&quot;to support multiple build-systems for a single package. You can fix this &quot;</span>
                <span class="s2">&quot;by updating the </span><span class="si">{}</span><span class="s2"> recipe, and you can also report the issue as a bug. &quot;</span>
                <span class="s2">&quot;More information at https://spack.readthedocs.io/en/latest/packaging_guide.html#installation-procedure&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">colorize</span><span class="p">(</span><span class="s2">&quot;@*R{{</span><span class="si">{}</span><span class="s2">}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error_msg</span><span class="p">))</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">error_msg</span><span class="p">)</span>

        <span class="c1"># make a pickleable exception to send to parent.</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

        <span class="n">ce</span> <span class="o">=</span> <span class="n">ChildError</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
            <span class="n">exc_type</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">tb_string</span><span class="p">,</span>
            <span class="n">logfile</span><span class="p">,</span>
            <span class="n">context</span><span class="p">,</span>
            <span class="n">package_context</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">write_pipe</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">ce</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">write_pipe</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">input_pipe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_pipe</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="start_build_process">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.start_build_process">[docs]</a>
<span class="k">def</span> <span class="nf">start_build_process</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a child process to do part of a spack build.</span>

<span class="sd">    Args:</span>

<span class="sd">        pkg (spack.package_base.PackageBase): package whose environment we should set up the</span>
<span class="sd">            child process for.</span>
<span class="sd">        function (typing.Callable): argless function to run in the child</span>
<span class="sd">            process.</span>

<span class="sd">    Usage::</span>

<span class="sd">        def child_fun():</span>
<span class="sd">            # do stuff</span>
<span class="sd">        build_env.start_build_process(pkg, child_fun)</span>

<span class="sd">    The child process is run with the build environment set up by</span>
<span class="sd">    spack.build_environment.  This allows package authors to have full</span>
<span class="sd">    control over the environment, etc. without affecting other builds</span>
<span class="sd">    that might be executed in the same spack call.</span>

<span class="sd">    If something goes wrong, the child process catches the error and</span>
<span class="sd">    passes it to the parent wrapped in a ChildError.  The parent is</span>
<span class="sd">    expected to handle (or re-raise) the ChildError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">read_pipe</span><span class="p">,</span> <span class="n">write_pipe</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">input_fd</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">jobserver_fd1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">jobserver_fd2</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">serialized_pkg</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">subprocess_context</span><span class="o">.</span><span class="n">PackageInstallContext</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Forward sys.stdin when appropriate, to allow toggling verbosity</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;win32&quot;</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;fileno&quot;</span><span class="p">):</span>
            <span class="n">input_fd</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">()))</span>
        <span class="n">mflags</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MAKEFLAGS&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mflags</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;--jobserver-[^=]*=(\d),(\d)&quot;</span><span class="p">,</span> <span class="n">mflags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">jobserver_fd1</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">jobserver_fd2</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">_setup_pkg_and_run</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                <span class="n">serialized_pkg</span><span class="p">,</span>
                <span class="n">function</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="p">,</span>
                <span class="n">write_pipe</span><span class="p">,</span>
                <span class="n">input_fd</span><span class="p">,</span>
                <span class="n">jobserver_fd1</span><span class="p">,</span>
                <span class="n">jobserver_fd2</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># We close the writable end of the pipe now to be sure that p is the</span>
        <span class="c1"># only process which owns a handle for it. This ensures that when p</span>
        <span class="c1"># closes its handle for the writable end, read_pipe.recv() will</span>
        <span class="c1"># promptly report the readable end as being ready.</span>
        <span class="n">write_pipe</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">InstallError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg</span>
        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Close the input stream in the parent process</span>
        <span class="k">if</span> <span class="n">input_fd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">exitcode_msg</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;exit&quot;</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;signal&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">child_result</span> <span class="o">=</span> <span class="n">read_pipe</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">InstallError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The process has stopped unexpectedly (</span><span class="si">{</span><span class="n">exitcode_msg</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># If returns a StopPhase, raise it</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_result</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">StopPhase</span><span class="p">):</span>
        <span class="c1"># do not print</span>
        <span class="k">raise</span> <span class="n">child_result</span>

    <span class="c1"># let the caller know which package went wrong.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_result</span><span class="p">,</span> <span class="n">InstallError</span><span class="p">):</span>
        <span class="n">child_result</span><span class="o">.</span><span class="n">pkg</span> <span class="o">=</span> <span class="n">pkg</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_result</span><span class="p">,</span> <span class="n">ChildError</span><span class="p">):</span>
        <span class="c1"># If the child process raised an error, print its output here rather</span>
        <span class="c1"># than waiting until the call to SpackError.die() in main(). This</span>
        <span class="c1"># allows exception handling output to be logged from within Spack.</span>
        <span class="c1"># see spack.main.SpackCommand.</span>
        <span class="n">child_result</span><span class="o">.</span><span class="n">print_context</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">child_result</span>

    <span class="c1"># Fallback. Usually caught beforehand in EOFError above.</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InstallError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The process failed unexpectedly (</span><span class="si">{</span><span class="n">exitcode_msg</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">child_result</span></div>



<span class="n">CONTEXT_BASES</span> <span class="o">=</span> <span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">_checks</span><span class="o">.</span><span class="n">BaseBuilder</span><span class="p">)</span>


<div class="viewcode-block" id="get_package_context">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.get_package_context">[docs]</a>
<span class="k">def</span> <span class="nf">get_package_context</span><span class="p">(</span><span class="n">traceback</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return some context for an error message when the build fails.</span>

<span class="sd">    Args:</span>
<span class="sd">        traceback: A traceback from some exception raised during</span>
<span class="sd">            install</span>

<span class="sd">        context (int): Lines of context to show before and after the line</span>
<span class="sd">            where the error happened</span>

<span class="sd">    This function inspects the stack to find where we failed in the</span>
<span class="sd">    package file, and it adds detailed context to the long_message</span>
<span class="sd">    from there.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make_stack</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracebacks come out of the system in caller -&gt; callee order.  Return</span>
<span class="sd">        an array in callee -&gt; caller order so we can traverse it.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">make_stack</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stack</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="n">make_stack</span><span class="p">(</span><span class="n">traceback</span><span class="p">)</span>

    <span class="n">basenames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">CONTEXT_BASES</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span>
        <span class="k">if</span> <span class="s2">&quot;self&quot;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="c1"># Find the first proper subclass of the PackageBase or BaseBuilder, but</span>
            <span class="c1"># don&#39;t provide context if the code is actually in the base classes.</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__qualname__&quot;</span><span class="p">):</span>
                <span class="n">typename</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">CONTEXT_BASES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">typename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basenames</span><span class="p">:</span>
                    <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># We found obj, the Package implementation we care about.</span>
    <span class="c1"># Point out the location in the install method where we failed.</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
    <span class="n">lineno</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;package.py&quot;</span><span class="p">:</span>
        <span class="c1"># subtract 1 because we inject a magic import at the top of package files.</span>
        <span class="c1"># TODO: get rid of the magic import.</span>
        <span class="n">lineno</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1:d}</span><span class="s2">, in </span><span class="si">{2}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)]</span>

    <span class="c1"># Build a message showing context in the install method.</span>
    <span class="n">sourcelines</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Calculate lineno of the error relative to the start of the function.</span>
    <span class="n">fun_lineno</span> <span class="o">=</span> <span class="n">lineno</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">start_ctx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fun_lineno</span> <span class="o">-</span> <span class="n">context</span><span class="p">)</span>
    <span class="n">sourcelines</span> <span class="o">=</span> <span class="n">sourcelines</span><span class="p">[</span><span class="n">start_ctx</span> <span class="p">:</span> <span class="n">fun_lineno</span> <span class="o">+</span> <span class="n">context</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sourcelines</span><span class="p">):</span>
        <span class="n">is_error</span> <span class="o">=</span> <span class="n">start_ctx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">==</span> <span class="n">fun_lineno</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="s2">&quot;&gt;&gt; &quot;</span> <span class="k">if</span> <span class="n">is_error</span> <span class="k">else</span> <span class="s2">&quot;   &quot;</span>
        <span class="c1"># Add start to get lineno relative to start of file, not function.</span>
        <span class="n">marked</span> <span class="o">=</span> <span class="s2">&quot;  </span><span class="si">{0}{1:-6d}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">start_ctx</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">is_error</span><span class="p">:</span>
            <span class="n">marked</span> <span class="o">=</span> <span class="n">colorize</span><span class="p">(</span><span class="s2">&quot;@R{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">cescape</span><span class="p">(</span><span class="n">marked</span><span class="p">))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marked</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lines</span></div>



<div class="viewcode-block" id="ChildError">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.ChildError">[docs]</a>
<span class="k">class</span> <span class="nc">ChildError</span><span class="p">(</span><span class="n">InstallError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Special exception class for wrapping exceptions from child processes</span>
<span class="sd">       in Spack&#39;s build environment.</span>

<span class="sd">    The main features of a ChildError are:</span>

<span class="sd">    1. They&#39;re serializable, so when a child build fails, we can send one</span>
<span class="sd">       of these to the parent and let the parent report what happened.</span>

<span class="sd">    2. They have a ``traceback`` field containing a traceback generated</span>
<span class="sd">       on the child immediately after failure.  Spack will print this on</span>
<span class="sd">       failure in lieu of trying to run sys.excepthook on the parent</span>
<span class="sd">       process, so users will see the correct stack trace from a child.</span>

<span class="sd">    3. They also contain context, which shows context in the Package</span>
<span class="sd">       implementation where the error happened.  This helps people debug</span>
<span class="sd">       Python code in their packages.  To get it, Spack searches the</span>
<span class="sd">       stack trace for the deepest frame where ``self`` is in scope and</span>
<span class="sd">       is an instance of PackageBase.  This will generally find a useful</span>
<span class="sd">       spot in the ``package.py`` file.</span>

<span class="sd">    The long_message of a ChildError displays one of two things:</span>

<span class="sd">      1. If the original error was a ProcessError, indicating a command</span>
<span class="sd">         died during the build, we&#39;ll show context from the build log.</span>

<span class="sd">      2. If the original error was any other type of error, we&#39;ll show</span>
<span class="sd">         context from the Python code.</span>

<span class="sd">    SpackError handles displaying the special traceback if we&#39;re in debug</span>
<span class="sd">    mode with spack -d.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># List of errors considered &quot;build errors&quot;, for which we&#39;ll show log</span>
    <span class="c1"># context instead of Python context.</span>
    <span class="n">build_errors</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;spack.util.executable&quot;</span><span class="p">,</span> <span class="s2">&quot;ProcessError&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">traceback_string</span><span class="p">,</span> <span class="n">log_name</span><span class="p">,</span> <span class="n">log_type</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">classname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">traceback_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_name</span> <span class="o">=</span> <span class="n">log_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_type</span> <span class="o">=</span> <span class="n">log_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">long_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_long_message</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_long_message</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">have_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_name</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ChildError</span><span class="o">.</span><span class="n">build_errors</span><span class="p">:</span>
            <span class="c1"># The error happened in some external executed process. Show</span>
            <span class="c1"># the log with errors or warnings highlighted.</span>
            <span class="k">if</span> <span class="n">have_log</span><span class="p">:</span>
                <span class="n">write_log_summary</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The error happened in the Python code, so try to show</span>
            <span class="c1"># some context from the Package itself.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">():</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">have_log</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;See </span><span class="si">{0}</span><span class="s2"> log for details:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_type</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">))</span>

        <span class="c1"># Also output the test log path IF it exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">have_log</span><span class="p">:</span>
            <span class="n">test_log</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">),</span> <span class="n">spack_install_test_log</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">test_log</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">See test log for details:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_log</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;__reduce__ is used to serialize (pickle) ChildErrors.</span>

<span class="sd">        Return a function to reconstruct a ChildError, along with the</span>
<span class="sd">        salient properties we&#39;ll need.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_make_child_error</span><span class="p">,</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_type</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
        <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_make_child_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">log_type</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used by __reduce__ in ChildError to reconstruct pickled errors.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ChildError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">log_type</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<div class="viewcode-block" id="write_log_summary">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.write_log_summary">[docs]</a>
<span class="k">def</span> <span class="nf">write_log_summary</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">log_type</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span> <span class="o">=</span> <span class="n">parse_log_events</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
    <span class="n">nerr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    <span class="n">nwar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nerr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">and</span> <span class="n">nerr</span> <span class="o">&gt;</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="o">-</span><span class="n">last</span><span class="p">:]</span>
            <span class="n">nerr</span> <span class="o">=</span> <span class="n">last</span>

        <span class="c1"># If errors are found, only display errors</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> found in </span><span class="si">%s</span><span class="s2"> log:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">plural</span><span class="p">(</span><span class="n">nerr</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">),</span> <span class="n">log_type</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">make_log_context</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">nwar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">and</span> <span class="n">nwar</span> <span class="o">&gt;</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">warnings</span> <span class="o">=</span> <span class="n">warnings</span><span class="p">[</span><span class="o">-</span><span class="n">last</span><span class="p">:]</span>
            <span class="n">nwar</span> <span class="o">=</span> <span class="n">last</span>

        <span class="c1"># If no errors are found but warnings are, display warnings</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> found in </span><span class="si">%s</span><span class="s2"> log:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">plural</span><span class="p">(</span><span class="n">nwar</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">),</span> <span class="n">log_type</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">make_log_context</span><span class="p">(</span><span class="n">warnings</span><span class="p">))</span></div>



<div class="viewcode-block" id="ModuleChangePropagator">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.ModuleChangePropagator">[docs]</a>
<span class="k">class</span> <span class="nc">ModuleChangePropagator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper class to accept changes to a package.py Python module, and propagate them in the</span>
<span class="sd">    MRO of the package.</span>

<span class="sd">    It is mainly used as a substitute of the ``package.py`` module, when calling the</span>
<span class="sd">    &quot;setup_dependent_package&quot; function during build environment setup.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_PROTECTED_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;package&quot;</span><span class="p">,</span> <span class="s2">&quot;current_module&quot;</span><span class="p">,</span> <span class="s2">&quot;modules_in_mro&quot;</span><span class="p">,</span> <span class="s2">&quot;_set_attributes&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="o">.</span><span class="n">PackageBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_self_attributes</span><span class="p">(</span><span class="s2">&quot;package&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_self_attributes</span><span class="p">(</span><span class="s2">&quot;current_module&quot;</span><span class="p">,</span> <span class="n">package</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>

        <span class="c1">#: Modules for the classes in the MRO up to PackageBase</span>
        <span class="n">modules_in_mro</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">module</span> <span class="ow">is</span> <span class="n">spack</span><span class="o">.</span><span class="n">package_base</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_module</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">modules_in_mro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_self_attributes</span><span class="p">(</span><span class="s2">&quot;modules_in_mro&quot;</span><span class="p">,</span> <span class="n">modules_in_mro</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_self_attributes</span><span class="p">(</span><span class="s2">&quot;_set_attributes&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">_set_self_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_module</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ModuleChangePropagator</span><span class="o">.</span><span class="n">_PROTECTED_NAMES</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Cannot set attribute &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot; in ModuleMonkeyPatcher&#39;</span>
            <span class="k">return</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_module</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="ModuleChangePropagator.propagate_changes_to_mro">
<a class="viewcode-back" href="../../spack.html#spack.build_environment.ModuleChangePropagator.propagate_changes_to_mro">[docs]</a>
    <span class="k">def</span> <span class="nf">propagate_changes_to_mro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">module_in_mro</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules_in_mro</span><span class="p">:</span>
            <span class="n">module_in_mro</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>