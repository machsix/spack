

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spack.database &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../spack.html">spack</a></li>
      <li class="breadcrumb-item active">spack.database</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spack.database</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="sd">&quot;&quot;&quot;Spack&#39;s installation tracking database.</span>

<span class="sd">The database serves two purposes:</span>

<span class="sd">  1. It implements a cache on top of a potentially very large Spack</span>
<span class="sd">     directory hierarchy, speeding up many operations that would</span>
<span class="sd">     otherwise require filesystem access.</span>

<span class="sd">  2. It will allow us to track external installations as well as lost</span>
<span class="sd">     packages and their dependencies.</span>

<span class="sd">Prior to the implementation of this store, a directory layout served</span>
<span class="sd">as the authoritative database of packages in Spack.  This module</span>
<span class="sd">provides a cache and a sanity checking mechanism for what is in the</span>
<span class="sd">filesystem.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">JSONDecoder</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Container</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">uuid</span>

    <span class="n">_use_uuid</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_use_uuid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">llnl.util.filesystem</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">import</span> <span class="nn">llnl.util.lang</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>

<span class="kn">import</span> <span class="nn">spack.deptypes</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">spack.hash_types</span> <span class="k">as</span> <span class="nn">ht</span>
<span class="kn">import</span> <span class="nn">spack.spec</span>
<span class="kn">import</span> <span class="nn">spack.traverse</span> <span class="k">as</span> <span class="nn">tr</span>
<span class="kn">import</span> <span class="nn">spack.util.lock</span> <span class="k">as</span> <span class="nn">lk</span>
<span class="kn">import</span> <span class="nn">spack.util.spack_json</span> <span class="k">as</span> <span class="nn">sjson</span>
<span class="kn">import</span> <span class="nn">spack.version</span> <span class="k">as</span> <span class="nn">vn</span>
<span class="kn">from</span> <span class="nn">spack.directory_layout</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DirectoryLayout</span><span class="p">,</span>
    <span class="n">DirectoryLayoutError</span><span class="p">,</span>
    <span class="n">InconsistentInstallDirectoryError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">spack.error</span> <span class="kn">import</span> <span class="n">SpackError</span>
<span class="kn">from</span> <span class="nn">spack.util.crypto</span> <span class="kn">import</span> <span class="n">bit_length</span>

<span class="c1"># TODO: Provide an API automatically retyring a build after detecting and</span>
<span class="c1"># TODO: clearing a failure.</span>

<span class="c1">#: DB goes in this directory underneath the root</span>
<span class="n">_DB_DIRNAME</span> <span class="o">=</span> <span class="s2">&quot;.spack-db&quot;</span>

<span class="c1">#: DB version.  This is stuck in the DB file to track changes in format.</span>
<span class="c1">#: Increment by one when the database format changes.</span>
<span class="c1">#: Versions before 5 were not integers.</span>
<span class="n">_DB_VERSION</span> <span class="o">=</span> <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;7&quot;</span><span class="p">)</span>

<span class="c1">#: For any version combinations here, skip reindex when upgrading.</span>
<span class="c1">#: Reindexing can take considerable time and is not always necessary.</span>
<span class="n">_SKIP_REINDEX</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># reindexing takes a significant amount of time, and there&#39;s</span>
    <span class="c1"># no reason to do it from DB version 0.9.3 to version 5. The</span>
    <span class="c1"># only difference is that v5 can contain &quot;deprecated_for&quot;</span>
    <span class="c1"># fields.  So, skip the reindex for this transition. The new</span>
    <span class="c1"># version is saved to disk the first time the DB is written.</span>
    <span class="p">(</span><span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;0.9.3&quot;</span><span class="p">),</span> <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">),</span> <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">),</span> <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;7&quot;</span><span class="p">)),</span>
<span class="p">]</span>

<span class="c1">#: Default timeout for spack database locks in seconds or None (no timeout).</span>
<span class="c1">#: A balance needs to be struck between quick turnaround for parallel installs</span>
<span class="c1">#: (to avoid excess delays) and waiting long enough when the system is busy</span>
<span class="c1">#: (to ensure the database is updated).</span>
<span class="n">_DEFAULT_DB_LOCK_TIMEOUT</span> <span class="o">=</span> <span class="mi">120</span>

<span class="c1">#: Default timeout for spack package locks in seconds or None (no timeout).</span>
<span class="c1">#: A balance needs to be struck between quick turnaround for parallel installs</span>
<span class="c1">#: (to avoid excess delays when performing a parallel installation) and waiting</span>
<span class="c1">#: long enough for the next possible spec to install (to avoid excessive</span>
<span class="c1">#: checking of the last high priority package) or holding on to a lock (to</span>
<span class="c1">#: ensure a failed install is properly tracked).</span>
<span class="n">_DEFAULT_PKG_LOCK_TIMEOUT</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#: Types of dependencies tracked by the database</span>
<span class="c1">#: We store by DAG hash, so we track the dependencies that the DAG hash includes.</span>
<span class="n">_TRACKED_DEPENDENCIES</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">dag_hash</span><span class="o">.</span><span class="n">depflag</span>

<span class="c1">#: Default list of fields written for each install record</span>
<span class="n">DEFAULT_INSTALL_RECORD_FIELDS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;spec&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ref_count&quot;</span><span class="p">,</span>
    <span class="s2">&quot;path&quot;</span><span class="p">,</span>
    <span class="s2">&quot;installed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;explicit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;installation_time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;deprecated_for&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="nd">@llnl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">memoized</span>
<span class="k">def</span> <span class="nf">_getfqdn</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Memoized version of `getfqdn()`.</span>

<span class="sd">    If we call `getfqdn()` too many times, DNS can be very slow. We only need to call it</span>
<span class="sd">    one time per process, so we cache it here.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span>


<div class="viewcode-block" id="reader">
<a class="viewcode-back" href="../../spack.html#spack.database.reader">[docs]</a>
<span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="n">vn</span><span class="o">.</span><span class="n">StandardVersion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;spack.spec.SpecfileReaderBase&quot;</span><span class="p">]:</span>
    <span class="n">reader_cls</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">):</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">SpecfileV1</span><span class="p">,</span>
        <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">):</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">SpecfileV3</span><span class="p">,</span>
        <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;7&quot;</span><span class="p">):</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">SpecfileV4</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">reader_cls</span><span class="p">[</span><span class="n">version</span><span class="p">]</span></div>



<span class="k">def</span> <span class="nf">_now</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the time since the epoch&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_autospec</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that automatically converts the argument of a single-arg</span>
<span class="sd">    function to a Spec.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_like</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec_like</span><span class="p">,</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">):</span>
            <span class="n">spec_like</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">spec_like</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_like</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">converter</span>


<div class="viewcode-block" id="InstallStatus">
<a class="viewcode-back" href="../../spack.html#spack.database.InstallStatus">[docs]</a>
<span class="k">class</span> <span class="nc">InstallStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="InstallStatuses">
<a class="viewcode-back" href="../../spack.html#spack.database.InstallStatuses">[docs]</a>
<span class="k">class</span> <span class="nc">InstallStatuses</span><span class="p">:</span>
    <span class="n">INSTALLED</span> <span class="o">=</span> <span class="n">InstallStatus</span><span class="p">(</span><span class="s2">&quot;installed&quot;</span><span class="p">)</span>
    <span class="n">DEPRECATED</span> <span class="o">=</span> <span class="n">InstallStatus</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">)</span>
    <span class="n">MISSING</span> <span class="o">=</span> <span class="n">InstallStatus</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="InstallStatuses.canonicalize">
<a class="viewcode-back" href="../../spack.html#spack.database.InstallStatuses.canonicalize">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">canonicalize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query_arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">query_arg</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">INSTALLED</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">query_arg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">MISSING</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">query_arg</span> <span class="ow">is</span> <span class="nb">any</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">INSTALLED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEPRECATED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MISSING</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_arg</span><span class="p">,</span> <span class="n">InstallStatus</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">query_arg</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query_arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">InstallStatus</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">statuses</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">statuses</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;installation query must be `any`, boolean, &quot;</span>
            <span class="s2">&quot;InstallStatus, or iterable of InstallStatus&quot;</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="InstallRecord">
<a class="viewcode-back" href="../../spack.html#spack.database.InstallRecord">[docs]</a>
<span class="k">class</span> <span class="nc">InstallRecord</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A record represents one installation in the DB.</span>

<span class="sd">    The record keeps track of the spec for the installation, its</span>
<span class="sd">    install path, AND whether or not it is installed.  We need the</span>
<span class="sd">    installed flag in case a user either:</span>

<span class="sd">        a) blew away a directory, or</span>
<span class="sd">        b) used spack uninstall -f to get rid of it</span>

<span class="sd">    If, in either case, the package was removed but others still</span>
<span class="sd">    depend on it, we still need to track its spec, so we don&#39;t</span>
<span class="sd">    actually remove from the database until a spec has no installed</span>
<span class="sd">    dependents left.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec: spec tracked by the install record</span>
<span class="sd">        path: path where the spec has been installed</span>
<span class="sd">        installed: whether or not the spec is currently installed</span>
<span class="sd">        ref_count (int): number of specs that depend on this one</span>
<span class="sd">        explicit (bool or None): whether or not this spec was explicitly</span>
<span class="sd">            installed, or pulled-in as a dependency of something else</span>
<span class="sd">        installation_time (datetime.datetime or None): time of the installation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">installed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">ref_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">installation_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deprecated_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_buildcache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">installed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">=</span> <span class="n">ref_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="n">explicit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installation_time</span> <span class="o">=</span> <span class="n">installation_time</span> <span class="ow">or</span> <span class="n">_now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_for</span> <span class="o">=</span> <span class="n">deprecated_for</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_buildcache</span> <span class="o">=</span> <span class="n">in_buildcache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>

<div class="viewcode-block" id="InstallRecord.install_type_matches">
<a class="viewcode-back" href="../../spack.html#spack.database.InstallRecord.install_type_matches">[docs]</a>
    <span class="k">def</span> <span class="nf">install_type_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">installed</span><span class="p">):</span>
        <span class="n">installed</span> <span class="o">=</span> <span class="n">InstallStatuses</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">(</span><span class="n">installed</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InstallStatuses</span><span class="o">.</span><span class="n">INSTALLED</span> <span class="ow">in</span> <span class="n">installed</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InstallStatuses</span><span class="o">.</span><span class="n">DEPRECATED</span> <span class="ow">in</span> <span class="n">installed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InstallStatuses</span><span class="o">.</span><span class="n">MISSING</span> <span class="ow">in</span> <span class="n">installed</span></div>


<div class="viewcode-block" id="InstallRecord.to_dict">
<a class="viewcode-back" href="../../spack.html#spack.database.InstallRecord.to_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_fields</span><span class="o">=</span><span class="n">DEFAULT_INSTALL_RECORD_FIELDS</span><span class="p">):</span>
        <span class="n">rec_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">include_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;spec&quot;</span><span class="p">:</span>
                <span class="n">rec_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">node_dict_with_hashes</span><span class="p">()})</span>
            <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;deprecated_for&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">:</span>
                <span class="n">rec_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;deprecated_for&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rec_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field_name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
            <span class="n">rec_dict</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>

        <span class="k">return</span> <span class="n">rec_dict</span></div>


<div class="viewcode-block" id="InstallRecord.from_dict">
<a class="viewcode-back" href="../../spack.html#spack.database.InstallRecord.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Old databases may have &quot;None&quot; for path for externals</span>
        <span class="k">if</span> <span class="s2">&quot;path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;installed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;installed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">InstallRecord</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ForbiddenLockError">
<a class="viewcode-back" href="../../spack.html#spack.database.ForbiddenLockError">[docs]</a>
<span class="k">class</span> <span class="nc">ForbiddenLockError</span><span class="p">(</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an upstream DB attempts to acquire a lock&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ForbiddenLock">
<a class="viewcode-back" href="../../spack.html#spack.database.ForbiddenLock">[docs]</a>
<span class="k">class</span> <span class="nc">ForbiddenLock</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ForbiddenLockError</span><span class="p">(</span><span class="s2">&quot;Cannot access attribute &#39;</span><span class="si">{0}</span><span class="s2">&#39; of lock&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ForbiddenLock</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">()</span></div>



<div class="viewcode-block" id="LockConfiguration">
<a class="viewcode-back" href="../../spack.html#spack.database.LockConfiguration">[docs]</a>
<span class="k">class</span> <span class="nc">LockConfiguration</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data class to configure locks in Database objects</span>

<span class="sd">    Args:</span>
<span class="sd">        enable: whether to enable locks or not.</span>
<span class="sd">        database_timeout: timeout for the database lock</span>
<span class="sd">        package_timeout: timeout for the package lock</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">enable</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">database_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">package_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span></div>



<span class="c1">#: Configure a database to avoid using locks</span>
<span class="n">NO_LOCK</span><span class="p">:</span> <span class="n">LockConfiguration</span> <span class="o">=</span> <span class="n">LockConfiguration</span><span class="p">(</span>
    <span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">database_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">package_timeout</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>


<span class="c1">#: Configure the database to use locks without a timeout</span>
<span class="n">NO_TIMEOUT</span><span class="p">:</span> <span class="n">LockConfiguration</span> <span class="o">=</span> <span class="n">LockConfiguration</span><span class="p">(</span>
    <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">database_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">package_timeout</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>

<span class="c1">#: Default configuration for database locks</span>
<span class="n">DEFAULT_LOCK_CFG</span><span class="p">:</span> <span class="n">LockConfiguration</span> <span class="o">=</span> <span class="n">LockConfiguration</span><span class="p">(</span>
    <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">database_timeout</span><span class="o">=</span><span class="n">_DEFAULT_DB_LOCK_TIMEOUT</span><span class="p">,</span>
    <span class="n">package_timeout</span><span class="o">=</span><span class="n">_DEFAULT_PKG_LOCK_TIMEOUT</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="lock_configuration">
<a class="viewcode-back" href="../../spack.html#spack.database.lock_configuration">[docs]</a>
<span class="k">def</span> <span class="nf">lock_configuration</span><span class="p">(</span><span class="n">configuration</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a LockConfiguration from a spack.config.Configuration object.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LockConfiguration</span><span class="p">(</span>
        <span class="n">enable</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:locks&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">database_timeout</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:db_lock_timeout&quot;</span><span class="p">),</span>
        <span class="n">package_timeout</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config:package_lock_timeout&quot;</span><span class="p">),</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="prefix_lock_path">
<a class="viewcode-back" href="../../spack.html#spack.database.prefix_lock_path">[docs]</a>
<span class="k">def</span> <span class="nf">prefix_lock_path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the path of the prefix lock file, given the root directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir: root directory containing the database directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">_DB_DIRNAME</span> <span class="o">/</span> <span class="s2">&quot;prefix_lock&quot;</span></div>



<div class="viewcode-block" id="failures_lock_path">
<a class="viewcode-back" href="../../spack.html#spack.database.failures_lock_path">[docs]</a>
<span class="k">def</span> <span class="nf">failures_lock_path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the path of the failures lock file, given the root directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir: root directory containing the database directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">_DB_DIRNAME</span> <span class="o">/</span> <span class="s2">&quot;prefix_failures&quot;</span></div>



<div class="viewcode-block" id="SpecLocker">
<a class="viewcode-back" href="../../spack.html#spack.database.SpecLocker">[docs]</a>
<span class="k">class</span> <span class="nc">SpecLocker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages acquiring and releasing read or write locks on concrete specs.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span> <span class="n">default_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">lock_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_timeout</span> <span class="o">=</span> <span class="n">default_timeout</span>

        <span class="c1"># Maps (spec.dag_hash(), spec.name) to the corresponding lock object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="SpecLocker.lock">
<a class="viewcode-back" href="../../spack.html#spack.database.SpecLocker.lock">[docs]</a>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a lock on a concrete spec.</span>

<span class="sd">        The lock is a byte range lock on the nth byte of a file.</span>

<span class="sd">        The lock file is ``self.lock_path``.</span>

<span class="sd">        n is the sys.maxsize-bit prefix of the DAG hash.  This makes likelihood of collision is</span>
<span class="sd">        very low AND it gives us readers-writer lock semantics with just a single lockfile, so</span>
<span class="sd">        no cleanup required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">,</span> <span class="s2">&quot;cannot lock a non-concrete spec&quot;</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_timeout</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_key</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_lock</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">default_timeout</span> <span class="o">=</span> <span class="n">timeout</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="SpecLocker.raw_lock">
<a class="viewcode-back" href="../../spack.html#spack.database.SpecLocker.raw_lock">[docs]</a>
    <span class="k">def</span> <span class="nf">raw_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a raw lock for a Spec, but doesn&#39;t keep track of it.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_path</span><span class="p">),</span>
            <span class="n">start</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash_bit_prefix</span><span class="p">(</span><span class="n">bit_length</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)),</span>
            <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">default_timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SpecLocker.has_lock">
<a class="viewcode-back" href="../../spack.html#spack.database.SpecLocker.has_lock">[docs]</a>
    <span class="k">def</span> <span class="nf">has_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the spec is already managed by this spec locker&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_key</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span></div>


    <span class="k">def</span> <span class="nf">_lock_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">(),</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="SpecLocker.write_lock">
<a class="viewcode-back" href="../../spack.html#spack.database.SpecLocker.write_lock">[docs]</a>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">write_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="s2">&quot;SpecLocker&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire_write</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="n">lk</span><span class="o">.</span><span class="n">LockError</span><span class="p">:</span>
            <span class="c1"># This addresses the case where a nested lock attempt fails inside</span>
            <span class="c1"># of this context manager</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release_write</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release_write</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpecLocker.clear">
<a class="viewcode-back" href="../../spack.html#spack.database.SpecLocker.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_key</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">lock</span><span class="p">),</span> <span class="n">lock</span></div>


<div class="viewcode-block" id="SpecLocker.clear_all">
<a class="viewcode-back" href="../../spack.html#spack.database.SpecLocker.clear_all">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">clear_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">clear_fn</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="FailureTracker">
<a class="viewcode-back" href="../../spack.html#spack.database.FailureTracker">[docs]</a>
<span class="k">class</span> <span class="nc">FailureTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tracks installation failures.</span>

<span class="sd">    Prefix failure marking takes the form of a byte range lock on the nth</span>
<span class="sd">    byte of a file for coordinating between concurrent parallel build</span>
<span class="sd">    processes and a persistent file, named with the full hash and</span>
<span class="sd">    containing the spec, in a subdirectory of the database to enable</span>
<span class="sd">    persistence across overlapping but separate related build processes.</span>

<span class="sd">    The failure lock file lives alongside the install DB.</span>

<span class="sd">    ``n`` is the sys.maxsize-bit prefix of the associated DAG hash to make</span>
<span class="sd">    the likelihood of collision very low with no cleanup required.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span> <span class="n">default_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="c1">#: Ensure a persistent location for dealing with parallel installation</span>
        <span class="c1">#: failures (e.g., across near-concurrent processes).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">_DB_DIRNAME</span> <span class="o">/</span> <span class="s2">&quot;failures&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">locker</span> <span class="o">=</span> <span class="n">SpecLocker</span><span class="p">(</span><span class="n">failures_lock_path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">),</span> <span class="n">default_timeout</span><span class="o">=</span><span class="n">default_timeout</span><span class="p">)</span>

<div class="viewcode-block" id="FailureTracker.clear">
<a class="viewcode-back" href="../../spack.html#spack.database.FailureTracker.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes any persistent and cached failure tracking for the spec.</span>

<span class="sd">        see `mark()`.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: the spec whose failure indicators are being removed</span>
<span class="sd">            force: True if the failure information should be cleared when a failure lock</span>
<span class="sd">                exists for the file, or False if the failure should not be cleared (e.g.,</span>
<span class="sd">                it may be associated with a concurrent build)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">locked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_taken</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">locked</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retaining failure marking for </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> due to lock&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">locked</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing failure marking despite lock for </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">succeeded</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locker</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">succeeded</span> <span class="ow">and</span> <span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release_write</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent_mark</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing failure marking for </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to remove failure marking for </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="FailureTracker.clear_all">
<a class="viewcode-back" href="../../spack.html#spack.database.FailureTracker.clear_all">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Force remove install failure tracking files.&quot;&quot;&quot;</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Releasing prefix failure locks&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locker</span><span class="o">.</span><span class="n">clear_all</span><span class="p">(</span>
            <span class="n">clear_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">release_write</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_write_locked</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing prefix failure tracking files&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fail_mark</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">/</span> <span class="n">fail_mark</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to remove failure marking file </span><span class="si">{</span><span class="n">fail_mark</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to remove failure marking files: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FailureTracker.mark">
<a class="viewcode-back" href="../../spack.html#spack.database.FailureTracker.mark">[docs]</a>
    <span class="k">def</span> <span class="nf">mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Marks a spec as failing to install.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: spec that failed to install</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Dump the spec to the failure file for (manual) debugging purposes</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

        <span class="c1"># Also ensure a failure lock is taken to prevent cleanup removal</span>
        <span class="c1"># of failure status information during a concurrent parallel build.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">locker</span><span class="o">.</span><span class="n">has_lock</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locker</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">mark</span><span class="o">.</span><span class="n">acquire_write</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">lk</span><span class="o">.</span><span class="n">LockTimeoutError</span><span class="p">:</span>
                <span class="c1"># Unlikely that another process failed to install at the same</span>
                <span class="c1"># time but log it anyway.</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PID </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2"> failed to mark install failure for </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to mark </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> as failed.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locker</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="FailureTracker.has_failed">
<a class="viewcode-back" href="../../spack.html#spack.database.FailureTracker.has_failed">[docs]</a>
    <span class="k">def</span> <span class="nf">has_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the spec is marked as failed.&quot;&quot;&quot;</span>
        <span class="c1"># The failure was detected in this process.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locker</span><span class="o">.</span><span class="n">has_lock</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># The failure was detected by a concurrent process (e.g., an srun),</span>
        <span class="c1"># which is expected to be holding a write lock if that is the case.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_taken</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Determine if the spec may have been marked as failed by a separate</span>
        <span class="c1"># spack build process running concurrently.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent_mark</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="FailureTracker.lock_taken">
<a class="viewcode-back" href="../../spack.html#spack.database.FailureTracker.lock_taken">[docs]</a>
    <span class="k">def</span> <span class="nf">lock_taken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if another process has a failure lock on the spec.&quot;&quot;&quot;</span>
        <span class="n">check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locker</span><span class="o">.</span><span class="n">raw_lock</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">check</span><span class="o">.</span><span class="n">is_write_locked</span><span class="p">()</span></div>


<div class="viewcode-block" id="FailureTracker.persistent_mark">
<a class="viewcode-back" href="../../spack.html#spack.database.FailureTracker.persistent_mark">[docs]</a>
    <span class="k">def</span> <span class="nf">persistent_mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if the spec has a persistent failure marking.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the path to the spec&#39;s failure file, which may not exist.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">,</span> <span class="s2">&quot;concrete spec required for failure path&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>



<span class="n">SelectType</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">InstallRecord</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>


<div class="viewcode-block" id="Database">
<a class="viewcode-back" href="../../spack.html#spack.database.Database">[docs]</a>
<span class="k">class</span> <span class="nc">Database</span><span class="p">:</span>
    <span class="c1">#: Fields written for each install record</span>
    <span class="n">record_fields</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_INSTALL_RECORD_FIELDS</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">upstream_dbs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Database&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_upstream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">lock_cfg</span><span class="p">:</span> <span class="n">LockConfiguration</span> <span class="o">=</span> <span class="n">DEFAULT_LOCK_CFG</span><span class="p">,</span>
        <span class="n">layout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DirectoryLayout</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Database for Spack installations.</span>

<span class="sd">        A Database is a cache of Specs data from ``$prefix/spec.yaml`` files</span>
<span class="sd">        in Spack installation directories.</span>

<span class="sd">        Database files (data and lock files) are stored under ``root/.spack-db``, which is</span>
<span class="sd">        created if it does not exist.  This is the &quot;database directory&quot;.</span>

<span class="sd">        The database will attempt to read an ``index.json`` file in the database directory.</span>
<span class="sd">        If that does not exist, it will create a database when needed by scanning the entire</span>
<span class="sd">        store root for ``spec.json`` files according to Spack&#39;s directory layout.</span>

<span class="sd">        Args:</span>
<span class="sd">            root: root directory where to create the database directory.</span>
<span class="sd">            upstream_dbs: upstream databases for this repository.</span>
<span class="sd">            is_upstream: whether this repository is an upstream.</span>
<span class="sd">            lock_cfg: configuration for the locks to be used by this repository.</span>
<span class="sd">                Relevant only if the repository is not an upstream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">_DB_DIRNAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">layout</span>

        <span class="c1"># Set up layout of database files within the db dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_directory</span><span class="p">,</span> <span class="s2">&quot;index.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verifier_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_directory</span><span class="p">,</span> <span class="s2">&quot;index_verifier&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_directory</span><span class="p">,</span> <span class="s2">&quot;lock&quot;</span><span class="p">)</span>

        <span class="c1"># Create needed directories and files</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_upstream</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_directory</span><span class="p">):</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_directory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_upstream</span> <span class="o">=</span> <span class="n">is_upstream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_seen_verifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Failed write transactions (interrupted by exceptions) will alert</span>
        <span class="c1"># _write. When that happens, we set this flag to indicate that</span>
        <span class="c1"># future read/write transactions should re-read the DB. Normally it</span>
        <span class="c1"># would make more sense to resolve this at the end of the transaction</span>
        <span class="c1"># but typically a failed transaction will terminate the running</span>
        <span class="c1"># instance of Spack and we don&#39;t want to incur an extra read in that</span>
        <span class="c1"># case, so we defer the cleanup to when we begin the next transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_is_inconsistent</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># initialize rest of state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_lock_timeout</span> <span class="o">=</span> <span class="n">lock_cfg</span><span class="o">.</span><span class="n">database_timeout</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DATABASE LOCK TIMEOUT: </span><span class="si">{0}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_lock_timeout</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ForbiddenLock</span><span class="p">,</span> <span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_upstream</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">ForbiddenLock</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">Lock</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lock_path</span><span class="p">,</span>
                <span class="n">default_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_lock_timeout</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;database&quot;</span><span class="p">,</span>
                <span class="n">enable</span><span class="o">=</span><span class="n">lock_cfg</span><span class="o">.</span><span class="n">enable</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InstallRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># For every installed spec we keep track of its install prefix, so that</span>
        <span class="c1"># we can answer the simple query whether a given path is already taken</span>
        <span class="c1"># before installing a different spec.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">upstream_dbs</span><span class="p">)</span> <span class="k">if</span> <span class="n">upstream_dbs</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_transaction_impl</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">WriteTransaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_transaction_impl</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">ReadTransaction</span>

<div class="viewcode-block" id="Database.write_transaction">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.write_transaction">[docs]</a>
    <span class="k">def</span> <span class="nf">write_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a write lock context manager for use in a `with` block.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_transaction_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">acquire</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.read_transaction">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.read_transaction">[docs]</a>
    <span class="k">def</span> <span class="nf">read_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a read lock context manager for use in a `with` block.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_transaction_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">acquire</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_write_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write out the database in JSON format to the stream passed</span>
<span class="sd">        as argument.</span>

<span class="sd">        This function does not do any locking or transactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># map from per-spec hash code to installation record.</span>
        <span class="n">installs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">include_fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">record_fields</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># database includes installation list and version.</span>

        <span class="c1"># NOTE: this DB version does not handle multiple installs of</span>
        <span class="c1"># the same spec well.  If there are 2 identical specs with</span>
        <span class="c1"># different paths, it can&#39;t differentiate.</span>
        <span class="c1"># TODO: fix this before we support multiple install locations.</span>
        <span class="n">database</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># TODO: move this to a top-level _meta section if we ever</span>
                <span class="c1"># TODO: bump the DB version to 7</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">_DB_VERSION</span><span class="p">),</span>
                <span class="c1"># dictionary of installation records, keyed by DAG hash</span>
                <span class="s2">&quot;installs&quot;</span><span class="p">:</span> <span class="n">installs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sjson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">sjson</span><span class="o">.</span><span class="n">SpackJSONError</span><span class="p">(</span><span class="s2">&quot;error writing JSON database:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_read_spec_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_reader</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">installs</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">ht</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively construct a spec from a hash in a YAML database.</span>

<span class="sd">        Does not do any locking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec_dict</span> <span class="o">=</span> <span class="n">installs</span><span class="p">[</span><span class="n">hash_key</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span>

        <span class="c1"># Install records don&#39;t include hash with spec, so we add it in here</span>
        <span class="c1"># to ensure it is read properly.</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># old format, can&#39;t update format here</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spec_dict</span><span class="p">:</span>
                <span class="n">spec_dict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># new format, already a singleton</span>
            <span class="n">spec_dict</span><span class="p">[</span><span class="nb">hash</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_key</span>

        <span class="c1"># Build spec from dict first.</span>
        <span class="k">return</span> <span class="n">spec_reader</span><span class="o">.</span><span class="n">from_node_dict</span><span class="p">(</span><span class="n">spec_dict</span><span class="p">)</span>

<div class="viewcode-block" id="Database.db_for_spec_hash">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.db_for_spec_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">db_for_spec_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">hash_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hash_key</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">db</span></div>


<div class="viewcode-block" id="Database.query_by_spec_hash">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.query_by_spec_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">query_by_spec_hash</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InstallRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InstallRecord</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a spec for hash, and whether it&#39;s installed upstream.</span>

<span class="sd">        Return:</span>
<span class="sd">            (tuple): (bool, optional InstallRecord): bool tells us whether</span>
<span class="sd">                the spec is installed upstream. Its InstallRecord is also</span>
<span class="sd">                returned if it&#39;s installed at all; otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">hash_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">hash_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hash_key</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Database.query_local_by_spec_hash">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.query_local_by_spec_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">query_local_by_spec_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a spec by hash in the local database</span>

<span class="sd">        Return:</span>
<span class="sd">            (InstallRecord or None): InstallRecord when installed</span>
<span class="sd">                locally, otherwise None.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_assign_dependencies</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spec_reader</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;spack.spec.SpecfileReaderBase&quot;</span><span class="p">],</span>
        <span class="n">hash_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">installs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InstallRecord</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="c1"># Add dependencies from other records in the install DB to</span>
        <span class="c1"># form a full spec.</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">spec_node_dict</span> <span class="o">=</span> <span class="n">installs</span><span class="p">[</span><span class="n">hash_key</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec_node_dict</span><span class="p">:</span>
            <span class="c1"># old format</span>
            <span class="n">spec_node_dict</span> <span class="o">=</span> <span class="n">spec_node_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;dependencies&quot;</span> <span class="ow">in</span> <span class="n">spec_node_dict</span><span class="p">:</span>
            <span class="n">yaml_deps</span> <span class="o">=</span> <span class="n">spec_node_dict</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dhash</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">virtuals</span> <span class="ow">in</span> <span class="n">spec_reader</span><span class="o">.</span><span class="n">read_specfile_dep_specs</span><span class="p">(</span>
                <span class="n">yaml_deps</span>
            <span class="p">):</span>
                <span class="c1"># It is important that we always check upstream installations in the same order,</span>
                <span class="c1"># and that we always check the local installation first: if a downstream Spack</span>
                <span class="c1"># installs a package then dependents in that installation could be using it. If a</span>
                <span class="c1"># hash is installed locally and upstream, there isn&#39;t enough information to</span>
                <span class="c1"># determine which one a local package depends on, so the convention ensures that</span>
                <span class="c1"># this isn&#39;t an issue.</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">dhash</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">spec</span> <span class="k">if</span> <span class="n">record</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Missing dependency not in database: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">cformat</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">{/hash:7}&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> needs </span><span class="si">{</span><span class="n">dname</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dhash</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">spec</span><span class="o">.</span><span class="n">_add_dependency</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">depflag</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">(</span><span class="n">dtypes</span><span class="p">),</span> <span class="n">virtuals</span><span class="o">=</span><span class="n">virtuals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill database from file, do not maintain old data.</span>
<span class="sd">        Translate the spec portions from node-dict form to spec form.</span>

<span class="sd">        Does not do any locking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># In the future we may use a stream of JSON objects, hence `raw_decode` for compat.</span>
                <span class="n">fdata</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">JSONDecoder</span><span class="p">()</span><span class="o">.</span><span class="n">raw_decode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CorruptDatabaseError</span><span class="p">(</span><span class="s2">&quot;error parsing database:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">if</span> <span class="n">fdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cond</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CorruptDatabaseError</span><span class="p">(</span><span class="s2">&quot;Spack database is corrupt: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">)</span>

        <span class="n">check</span><span class="p">(</span><span class="s2">&quot;database&quot;</span> <span class="ow">in</span> <span class="n">fdata</span><span class="p">,</span> <span class="s2">&quot;no &#39;database&#39; attribute in JSON DB.&quot;</span><span class="p">)</span>

        <span class="c1"># High-level file checks</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">fdata</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
        <span class="n">check</span><span class="p">(</span><span class="s2">&quot;version&quot;</span> <span class="ow">in</span> <span class="n">db</span><span class="p">,</span> <span class="s2">&quot;no &#39;version&#39; in JSON DB.&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: better version checking semantics.</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">vn</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;</span> <span class="n">_DB_VERSION</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidDatabaseVersionError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_DB_VERSION</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">_DB_VERSION</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">old</span> <span class="o">==</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">new</span> <span class="o">==</span> <span class="n">_DB_VERSION</span> <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">_SKIP_REINDEX</span>
        <span class="p">):</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spack database version changed from </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">_DB_VERSION</span><span class="si">}</span><span class="s2">. Upgrading.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">reindex</span><span class="p">()</span>
            <span class="n">installs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">include_fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_record_fields</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check</span><span class="p">(</span><span class="s2">&quot;installs&quot;</span> <span class="ow">in</span> <span class="n">db</span><span class="p">,</span> <span class="s2">&quot;no &#39;installs&#39; in JSON DB.&quot;</span><span class="p">)</span>
            <span class="n">installs</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;installs&quot;</span><span class="p">]</span>

        <span class="n">spec_reader</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">invalid_record</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CorruptDatabaseError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid record in Spack database: hash: </span><span class="si">{</span><span class="n">hash_key</span><span class="si">}</span><span class="s2">, cause: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Build up the database in three passes:</span>
        <span class="c1">#</span>
        <span class="c1">#   1. Read in all specs without dependencies.</span>
        <span class="c1">#   2. Hook dependencies up among specs.</span>
        <span class="c1">#   3. Mark all specs concrete.</span>
        <span class="c1">#</span>
        <span class="c1"># The database is built up so that ALL specs in it share nodes</span>
        <span class="c1"># (i.e., its specs are a true Merkle DAG, unlike most specs.)</span>

        <span class="c1"># Pass 1: Iterate through database and build specs w/o dependencies</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InstallRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">installed_prefixes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">installs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This constructs a spec DAG from the list of all installs</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_spec_from_dict</span><span class="p">(</span><span class="n">spec_reader</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">installs</span><span class="p">)</span>

                <span class="c1"># Insert the brand new spec in the database.  Each</span>
                <span class="c1"># spec has its own copies of its dependency specs.</span>
                <span class="c1"># TODO: would a more immmutable spec implementation simplify</span>
                <span class="c1">#       this?</span>
                <span class="n">data</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">InstallRecord</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="ow">and</span> <span class="s2">&quot;installed&quot;</span> <span class="ow">in</span> <span class="n">rec</span> <span class="ow">and</span> <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;installed&quot;</span><span class="p">]:</span>
                    <span class="n">installed_prefixes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">invalid_record</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Pass 2: Assign dependencies once all specs are created.</span>
        <span class="k">for</span> <span class="n">hash_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assign_dependencies</span><span class="p">(</span><span class="n">spec_reader</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">installs</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MissingDependenciesError</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">invalid_record</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Pass 3: Mark all specs concrete.  Specs representing real</span>
        <span class="c1"># installations must be explicitly marked.</span>
        <span class="c1"># We do this *after* all dependencies are connected because if we</span>
        <span class="c1"># do it *while* we&#39;re constructing specs,it causes hashes to be</span>
        <span class="c1"># cached prematurely.</span>
        <span class="k">for</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">_mark_root_concrete</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span> <span class="o">=</span> <span class="n">installed_prefixes</span>

<div class="viewcode-block" id="Database.reindex">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.reindex">[docs]</a>
    <span class="k">def</span> <span class="nf">reindex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build database index from scratch based on a directory layout.</span>

<span class="sd">        Locks the DB if it isn&#39;t locked already.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_upstream</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UpstreamDatabaseLockingError</span><span class="p">(</span><span class="s2">&quot;Cannot reindex an upstream database&quot;</span><span class="p">)</span>

        <span class="c1"># Special transaction to avoid recursive reindex calls and to</span>
        <span class="c1"># ignore errors if we need to rebuild a corrupt database.</span>
        <span class="k">def</span> <span class="nf">_read_suppress_error</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CorruptDatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reindexing corrupt database, error was: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">lk</span><span class="o">.</span><span class="n">WriteTransaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">acquire</span><span class="o">=</span><span class="n">_read_suppress_error</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">):</span>
            <span class="n">old_installed_prefixes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">old_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reindex</span><span class="p">(</span><span class="n">old_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="c1"># If anything explodes, restore old data, skip write.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">old_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span> <span class="o">=</span> <span class="n">old_installed_prefixes</span>
                <span class="k">raise</span></div>


    <span class="k">def</span> <span class="nf">_reindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InstallRecord</span><span class="p">]):</span>
        <span class="c1"># Specs on the file system are the source of truth for record.spec. The old database values</span>
        <span class="c1"># if available are the source of truth for the rest of the record.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="s2">&quot;Database layout must be set to reindex&quot;</span>

        <span class="n">specs_from_fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">all_specs</span><span class="p">()</span>
        <span class="n">deprecated_for</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">(</span><span class="n">specs_from_fs</span><span class="p">)</span>

        <span class="n">known_specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="o">*</span><span class="n">specs_from_fs</span><span class="p">,</span>
            <span class="o">*</span><span class="p">(</span><span class="n">deprecated</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">deprecated</span> <span class="ow">in</span> <span class="n">deprecated_for</span><span class="p">),</span>
            <span class="o">*</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">spec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">old_data</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="p">]</span>

        <span class="n">upstream_hashes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dag_hash</span> <span class="k">for</span> <span class="n">upstream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span> <span class="k">for</span> <span class="n">dag_hash</span> <span class="ow">in</span> <span class="n">upstream</span><span class="o">.</span><span class="n">_data</span>
        <span class="p">}</span>
        <span class="n">upstream_hashes</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">known_specs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">create_node</span><span class="p">(</span><span class="n">edge</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">DependencySpec</span><span class="p">,</span> <span class="n">is_upstream</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_upstream</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span> <span class="o">=</span> <span class="n">InstallRecord</span><span class="p">(</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">path</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external_path</span> <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">installed</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Store all nodes of known specs, excluding ones found in upstreams</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">traverse_breadth_first_with_visitor</span><span class="p">(</span>
            <span class="n">known_specs</span><span class="p">,</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">CoverNodesVisitor</span><span class="p">(</span>
                <span class="n">NoUpstreamVisitor</span><span class="p">(</span><span class="n">upstream_hashes</span><span class="p">,</span> <span class="n">create_node</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">by_dag_hash</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Store the prefix and other information for specs were found on the file system</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs_from_fs</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span>
            <span class="n">record</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">prefix</span>
            <span class="n">record</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">record</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># conservative assumption</span>
            <span class="n">record</span><span class="o">.</span><span class="n">installation_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">st_ctime</span>

        <span class="c1"># Deprecate specs</span>
        <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">deprecated_for</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">old</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span><span class="o">.</span><span class="n">deprecated_for</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>

        <span class="c1"># Copy data we have from the old database</span>
        <span class="k">for</span> <span class="n">old_record</span> <span class="ow">in</span> <span class="n">old_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">old_record</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span>
            <span class="n">record</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="n">old_record</span><span class="o">.</span><span class="n">explicit</span>
            <span class="n">record</span><span class="o">.</span><span class="n">installation_time</span> <span class="o">=</span> <span class="n">old_record</span><span class="o">.</span><span class="n">installation_time</span>
            <span class="n">record</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">old_record</span><span class="o">.</span><span class="n">origin</span>
            <span class="n">record</span><span class="o">.</span><span class="n">deprecated_for</span> <span class="o">=</span> <span class="n">old_record</span><span class="o">.</span><span class="n">deprecated_for</span>

            <span class="c1"># Warn when the spec has been removed from the file system (i.e. it was not detected)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">installed</span> <span class="ow">and</span> <span class="n">old_record</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Spec </span><span class="si">{</span><span class="n">old_record</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="si">}</span><span class="s2"> was marked installed in the database &quot;</span>
                    <span class="s2">&quot;but was not found on the file system. It is now marked as missing.&quot;</span>
                <span class="p">)</span>

        <span class="k">def</span> <span class="nf">create_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">:</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">DependencySpec</span><span class="p">,</span> <span class="n">is_upstream</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">edge</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">parent_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">is_upstream</span><span class="p">:</span>
                <span class="n">upstream</span><span class="p">,</span> <span class="n">child_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span>
                <span class="k">assert</span> <span class="n">upstream</span> <span class="ow">and</span> <span class="n">child_record</span><span class="p">,</span> <span class="s2">&quot;Internal error: upstream spec not found&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">child_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()]</span>
            <span class="n">parent_record</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">_add_dependency</span><span class="p">(</span>
                <span class="n">child_record</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">depflag</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">depflag</span><span class="p">,</span> <span class="n">virtuals</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">virtuals</span>
            <span class="p">)</span>

        <span class="c1"># Then store edges</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">traverse_breadth_first_with_visitor</span><span class="p">(</span>
            <span class="n">known_specs</span><span class="p">,</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">CoverEdgesVisitor</span><span class="p">(</span>
                <span class="n">NoUpstreamVisitor</span><span class="p">(</span><span class="n">upstream_hashes</span><span class="p">,</span> <span class="n">create_edge</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">by_dag_hash</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Finally update the ref counts</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">):</span>
                <span class="n">dep_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">dep_record</span><span class="p">:</span>  <span class="c1"># dep might be upstream</span>
                    <span class="n">dep_record</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">]</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_ref_counts</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_ref_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure consistency of reference counts in the DB.</span>

<span class="sd">        Raise an AssertionError if something is amiss.</span>

<span class="sd">        Does no locking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">counts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">):</span>
                <span class="n">dep_key</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dep_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">dep_key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">:</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">ref_count</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid ref_count: </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> (expected </span><span class="si">%d</span><span class="s2">), in DB </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the in-memory database index to its file path.</span>

<span class="sd">        This is a helper function called by the WriteTransaction context</span>
<span class="sd">        manager. If there is an exception while the write lock is active,</span>
<span class="sd">        nothing will be written to the database file, but the in-memory</span>
<span class="sd">        database *may* be left in an inconsistent state.  It will be consistent</span>
<span class="sd">        after the start of the next transaction, when it read from disk again.</span>

<span class="sd">        This routine does no locking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Do not write if exceptions were raised</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># A failure interrupted a transaction, so we should record that</span>
            <span class="c1"># the Database is now in an inconsistent state: we should</span>
            <span class="c1"># restore it in the next transaction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_is_inconsistent</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="n">temp_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.temp&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_getfqdn</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

        <span class="c1"># Write a temporary database file them move it into place</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_use_uuid</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verifier_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">new_verifier</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_verifier</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_seen_verifier</span> <span class="o">=</span> <span class="n">new_verifier</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="c1"># Clean up temp file if something goes wrong.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-read Database from the data in the set location. This does no locking.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">):</span>
            <span class="n">current_verifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">_use_uuid</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verifier_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">current_verifier</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">current_verifier</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_seen_verifier</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">current_verifier</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_seen_verifier</span> <span class="o">=</span> <span class="n">current_verifier</span>
                <span class="c1"># Read from file if a database exists</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_is_inconsistent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_is_inconsistent</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_upstream</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;upstream not found: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span>
        <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">installation_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an install record for this spec to the database.</span>

<span class="sd">        Also ensures dependencies are present and updated in the DB as either installed or missing.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: spec to be added</span>
<span class="sd">            explicit:</span>
<span class="sd">                Possible values: True, False, any</span>

<span class="sd">                A spec that was installed following a specific user request is marked as explicit.</span>
<span class="sd">                If instead it was pulled-in as a dependency of a user requested spec it&#39;s</span>
<span class="sd">                considered implicit.</span>

<span class="sd">            installation_time:</span>
<span class="sd">                Date and time of installation</span>
<span class="sd">            allow_missing: if True, don&#39;t warn when installation is not found on on disk</span>
<span class="sd">                This is useful when installing specs without build deps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NonConcreteSpecAddError</span><span class="p">(</span><span class="s2">&quot;Specs added to DB must be concrete.&quot;</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
        <span class="n">spec_pkg_hash</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">_package_hash</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="n">upstream</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upstream</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">installation_time</span> <span class="o">=</span> <span class="n">installation_time</span> <span class="ow">or</span> <span class="n">_now</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">(</span><span class="n">depflag</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span>
                <span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="n">explicit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">installation_time</span><span class="o">=</span><span class="n">installation_time</span><span class="p">,</span>
                <span class="c1"># allow missing build-only deps. This prevents excessive warnings when a spec is</span>
                <span class="c1"># installed, and its build dep is missing a build dep; there&#39;s no need to install</span>
                <span class="c1"># the build dep&#39;s build dep first, and there&#39;s no need to warn about it missing.</span>
                <span class="n">allow_missing</span><span class="o">=</span><span class="n">allow_missing</span> <span class="ow">or</span> <span class="n">edge</span><span class="o">.</span><span class="n">depflag</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">BUILD</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Make sure the directory layout agrees whether the spec is installed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">path_for_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">installed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">ensure_installed</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">installed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">DirectoryLayoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">allow_missing</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">InconsistentInstallDirectoryError</span><span class="p">)):</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;updated&quot;</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="k">else</span> <span class="s2">&quot;registered&quot;</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="si">}</span><span class="s2"> is being </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> in the database with prefix </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="s2">&quot;but this directory does not contain an installation of &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;the spec, due to: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">external_path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">external_path</span>
            <span class="n">installed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">installed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="c1"># Create a new install record with no deps initially.</span>
            <span class="n">new_spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">InstallRecord</span><span class="p">(</span>
                <span class="n">new_spec</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">,</span>
                <span class="n">ref_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">,</span>
                <span class="n">installation_time</span><span class="o">=</span><span class="n">installation_time</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">spec</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Connect dependencies from the DB to the new copy.</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">(</span><span class="n">depflag</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">):</span>
                <span class="n">dkey</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
                <span class="n">upstream</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">dkey</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">record</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing dependency </span><span class="si">{</span><span class="n">dep</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">short_spec</span><span class="si">}</span><span class="s2"> in DB&quot;</span>
                <span class="n">new_spec</span><span class="o">.</span><span class="n">_add_dependency</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">depflag</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">depflag</span><span class="p">,</span> <span class="n">virtuals</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">virtuals</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">upstream</span><span class="p">:</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Mark concrete once everything is built, and preserve the original hashes of concrete</span>
            <span class="c1"># specs.</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">_mark_concrete</span><span class="p">()</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">_package_hash</span> <span class="o">=</span> <span class="n">spec_pkg_hash</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># It is already in the database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="n">installed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">installation_time</span> <span class="o">=</span> <span class="n">_now</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="n">explicit</span>

<div class="viewcode-block" id="Database.add">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.add">[docs]</a>
    <span class="nd">@_autospec</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">explicit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">allow_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add spec at path to database, locking and reading DB to sync.</span>

<span class="sd">        ``add()`` will lock and read from the DB on disk.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: ensure that spec is concrete?</span>
        <span class="c1"># Entire add is transactional.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_transaction</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">,</span> <span class="n">allow_missing</span><span class="o">=</span><span class="n">allow_missing</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_matching_spec_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the exact spec OR get a single spec that matches.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
        <span class="n">upstream</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_one</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">NoSuchSpecError</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span>

<div class="viewcode-block" id="Database.get_record">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.get_record">[docs]</a>
    <span class="nd">@_autospec</span>
    <span class="k">def</span> <span class="nf">get_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InstallRecord</span><span class="p">]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_matching_spec_key</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">upstream</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span></div>


    <span class="k">def</span> <span class="nf">_decrement_ref_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="c1"># TODO: print something here?  DB is corrupt, but</span>
            <span class="c1"># not much we can do.</span>
            <span class="k">return</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_decrement_ref_count</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_increment_ref_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Non-locking version of remove(); does real work.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_matching_spec_key</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># This install prefix is now free for other specs to use, even if the</span>
        <span class="c1"># spec is only marked uninstalled.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">external</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">installed</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">ref_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Remove any reference to this node from dependencies and</span>
        <span class="c1"># decrement the reference count</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decrement_ref_count</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">:</span>
            <span class="n">new_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decrement_ref_count</span><span class="p">(</span><span class="n">new_spec</span><span class="p">)</span>

        <span class="c1"># Returns the concrete spec so we know it in the case where a</span>
        <span class="c1"># query spec was passed in.</span>
        <span class="k">return</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span>

<div class="viewcode-block" id="Database.remove">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.remove">[docs]</a>
    <span class="nd">@_autospec</span>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes a spec from the database.  To be called on uninstall.</span>

<span class="sd">        Reads the database, then:</span>

<span class="sd">          1. Marks the spec as not installed.</span>
<span class="sd">          2. Removes the spec if it has no more dependents.</span>
<span class="sd">          3. If removed, recursively updates dependencies&#39; ref counts</span>
<span class="sd">             and removes them if they are no longer needed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Take a lock around the entire removal.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.deprecator">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.deprecator">[docs]</a>
    <span class="k">def</span> <span class="nf">deprecator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the spec that the given spec is deprecated for, or None&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="n">spec_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_matching_spec_key</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec_rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">spec_key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">spec_rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">spec_rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Database.specs_deprecated_by">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.specs_deprecated_by">[docs]</a>
    <span class="k">def</span> <span class="nf">specs_deprecated_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all specs deprecated in favor of the given spec&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">spec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">deprecated_for</span> <span class="o">==</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
            <span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_deprecate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">deprecator</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spec_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_matching_spec_key</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec_rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">spec_key</span><span class="p">]</span>

        <span class="n">deprecator_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_matching_spec_key</span><span class="p">(</span><span class="n">deprecator</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_increment_ref_count</span><span class="p">(</span><span class="n">deprecator</span><span class="p">)</span>

        <span class="c1"># If spec was already deprecated, update old deprecator&#39;s ref count</span>
        <span class="k">if</span> <span class="n">spec_rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">:</span>
            <span class="n">old_repl_rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">spec_rec</span><span class="o">.</span><span class="n">deprecated_for</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decrement_ref_count</span><span class="p">(</span><span class="n">old_repl_rec</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">spec_rec</span><span class="o">.</span><span class="n">deprecated_for</span> <span class="o">=</span> <span class="n">deprecator_key</span>
        <span class="n">spec_rec</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">spec_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_rec</span>

<div class="viewcode-block" id="Database.mark">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.mark">[docs]</a>
    <span class="nd">@_autospec</span>
    <span class="k">def</span> <span class="nf">mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark an arbitrary record on a spec.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mark</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_matching_spec_key</span><span class="p">(</span><span class="n">spec</span><span class="p">)]</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Database.deprecate">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.deprecate">[docs]</a>
    <span class="nd">@_autospec</span>
    <span class="k">def</span> <span class="nf">deprecate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span> <span class="n">deprecator</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Marks a spec as deprecated in favor of its deprecator&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deprecate</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">deprecator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.installed_relatives">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.installed_relatives">[docs]</a>
    <span class="nd">@_autospec</span>
    <span class="k">def</span> <span class="nf">installed_relatives</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">,</span>
        <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;children&quot;</span><span class="p">,</span>
        <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">deptype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">DepFlag</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">DepTypes</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return installed specs related to this one.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;parents&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid direction: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">direction</span><span class="p">)</span>

        <span class="n">relatives</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">transitive</span><span class="p">:</span>
                <span class="n">to_add</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="n">deptype</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;parents&quot;</span><span class="p">:</span>
                <span class="n">to_add</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependents</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">deptype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># direction == &#39;children&#39;</span>
                <span class="n">to_add</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">deptype</span><span class="o">=</span><span class="n">deptype</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">relative</span> <span class="ow">in</span> <span class="n">to_add</span><span class="p">:</span>
                <span class="n">hash_key</span> <span class="o">=</span> <span class="n">relative</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">hash_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">:</span>
                    <span class="n">tty</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Inconsistent state: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;dependent&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;parents&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;dependency&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">hash_key</span><span class="si">}</span><span class="s2"> of &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span><span class="si">}</span><span class="s2"> not in DB&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">relatives</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relatives</span></div>


<div class="viewcode-block" id="Database.installed_extensions_for">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.installed_extensions_for">[docs]</a>
    <span class="nd">@_autospec</span>
    <span class="k">def</span> <span class="nf">installed_extensions_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extendee_spec</span><span class="p">:</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the specs of all packages that extend the given spec&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">extends</span><span class="p">(</span><span class="n">extendee_spec</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">spec</span><span class="o">.</span><span class="n">package</span></div>


    <span class="k">def</span> <span class="nf">_get_by_hash_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dag_hash</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="nb">any</span><span class="p">):</span>
        <span class="c1"># hash is a full hash and is in the data somewhere</span>
        <span class="k">if</span> <span class="n">dag_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dag_hash</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">install_type_matches</span><span class="p">(</span><span class="n">installed</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>

        <span class="c1"># check if hash is a prefix of some installed (or previously</span>
        <span class="c1"># installed) spec.</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">record</span><span class="o">.</span><span class="n">spec</span>
            <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">dag_hash</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">install_type_matches</span><span class="p">(</span><span class="n">installed</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matches</span>

        <span class="c1"># nothing found</span>
        <span class="k">return</span> <span class="n">default</span>

<div class="viewcode-block" id="Database.get_by_hash_local">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.get_by_hash_local">[docs]</a>
    <span class="k">def</span> <span class="nf">get_by_hash_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dag_hash</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="nb">any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look up a spec in *this DB* by DAG hash, or by a DAG hash prefix.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            dag_hash (str): hash (or hash prefix) to look up</span>
<span class="sd">            default (object or None): default value to return if dag_hash is</span>
<span class="sd">                not in the DB (default: None)</span>
<span class="sd">            installed (bool or InstallStatus or typing.Iterable or None):</span>
<span class="sd">                if ``True``, includes only installed</span>
<span class="sd">                specs in the search; if ``False`` only missing specs, and if</span>
<span class="sd">                ``any``, all specs in database. If an InstallStatus or iterable</span>
<span class="sd">                of InstallStatus, returns specs whose install status</span>
<span class="sd">                (installed, deprecated, or missing) matches (one of) the</span>
<span class="sd">                InstallStatus. (default: any)</span>

<span class="sd">        ``installed`` defaults to ``any`` so that we can refer to any</span>
<span class="sd">        known hash.  Note that ``query()`` and ``query_one()`` differ in</span>
<span class="sd">        that they only return installed specs by default.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list): a list of specs matching the hash or hash prefix</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_by_hash_local</span><span class="p">(</span><span class="n">dag_hash</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.get_by_hash">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.get_by_hash">[docs]</a>
    <span class="k">def</span> <span class="nf">get_by_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dag_hash</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="nb">any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look up a spec by DAG hash, or by a DAG hash prefix.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            dag_hash (str): hash (or hash prefix) to look up</span>
<span class="sd">            default (object or None): default value to return if dag_hash is</span>
<span class="sd">                not in the DB (default: None)</span>
<span class="sd">            installed (bool or InstallStatus or typing.Iterable or None):</span>
<span class="sd">                if ``True``, includes only installed specs in the search; if ``False``</span>
<span class="sd">                only missing specs, and if ``any``, all specs in database. If an</span>
<span class="sd">                InstallStatus or iterable of InstallStatus, returns specs whose install</span>
<span class="sd">                status (installed, deprecated, or missing) matches (one of) the</span>
<span class="sd">                InstallStatus. (default: any)</span>

<span class="sd">        ``installed`` defaults to ``any`` so that we can refer to any</span>
<span class="sd">        known hash.  Note that ``query()`` and ``query_one()`` differ in</span>
<span class="sd">        that they only return installed specs by default.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list): a list of specs matching the hash or hash prefix</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_hash_local</span><span class="p">(</span><span class="n">dag_hash</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec</span>

        <span class="k">for</span> <span class="n">upstream_db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">upstream_db</span><span class="o">.</span><span class="n">_get_by_hash_local</span><span class="p">(</span><span class="n">dag_hash</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">spec</span>

        <span class="k">return</span> <span class="n">default</span></div>


    <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">predicate_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SelectType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">installed</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">InstallStatus</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">InstallStatus</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">explicit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hashes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_buildcache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>

        <span class="c1"># Restrict the set of records over which we iterate first</span>
        <span class="n">matching_hashes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
        <span class="k">if</span> <span class="n">hashes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">matching_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="n">h</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hashes</span> <span class="k">if</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_spec</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">query_spec</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">query_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">query_spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="n">hash_key</span> <span class="o">=</span> <span class="n">query_spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hash_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matching_hashes</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">matching_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="n">hash_key</span><span class="p">:</span> <span class="n">matching_hashes</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]}</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">min</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">max</span>

        <span class="n">deferred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">matching_hashes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="n">rec</span><span class="o">.</span><span class="n">origin</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">install_type_matches</span><span class="p">(</span><span class="n">installed</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">in_buildcache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">in_buildcache</span> <span class="o">!=</span> <span class="n">in_buildcache</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">explicit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">explicit</span> <span class="o">!=</span> <span class="n">explicit</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">predicate_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">predicate_fn</span><span class="p">(</span><span class="n">rec</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">start_date</span> <span class="ow">or</span> <span class="n">end_date</span><span class="p">:</span>
                <span class="n">inst_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">installation_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_date</span> <span class="o">&lt;</span> <span class="n">inst_date</span> <span class="o">&lt;</span> <span class="n">end_date</span><span class="p">):</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">query_spec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">query_spec</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># check anon specs and exact name matches first</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">query_spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">query_spec</span><span class="p">):</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

            <span class="c1"># save potential virtual matches for later, but not if we already found a match</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">deferred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># Checking for virtuals is expensive, so we save it for last and only if needed.</span>
        <span class="c1"># If we get here, we didn&#39;t find anything in the DB that matched by name.</span>
        <span class="c1"># If we did fine something, the query spec can&#39;t be virtual b/c we matched an actual</span>
        <span class="c1"># package installation, so skip the virtual check entirely. If we *didn&#39;t* find anything,</span>
        <span class="c1"># check all the deferred specs *if* the query is virtual.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">query_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deferred</span> <span class="ow">and</span> <span class="n">query_spec</span><span class="o">.</span><span class="n">virtual</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">deferred</span> <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="n">query_spec</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="Database.query_local">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.query_local">[docs]</a>
    <span class="k">def</span> <span class="nf">query_local</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">predicate_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SelectType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">installed</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">InstallStatus</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">InstallStatus</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">explicit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hashes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_buildcache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queries the local Spack database.</span>

<span class="sd">        This function doesn&#39;t guarantee any sorting of the returned data for performance reason,</span>
<span class="sd">        since comparing specs for __lt__ may be an expensive operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            query_spec:  if query_spec is ``None``, match all specs in the database.</span>
<span class="sd">                If it is a spec, return all specs matching ``spec.satisfies(query_spec)``.</span>

<span class="sd">            predicate_fn: optional predicate taking an InstallRecord as argument, and returning</span>
<span class="sd">                whether that record is selected for the query. It can be used to craft criteria</span>
<span class="sd">                that need some data for selection not provided by the Database itself.</span>

<span class="sd">            installed: if ``True``, includes only installed specs in the search. If ``False`` only</span>
<span class="sd">                missing specs, and if ``any``, all specs in database. If an InstallStatus or</span>
<span class="sd">                iterable of InstallStatus, returns specs whose install status matches at least</span>
<span class="sd">                one of the InstallStatus.</span>

<span class="sd">            explicit: a spec that was installed following a specific user request is marked as</span>
<span class="sd">                explicit. If instead it was pulled-in as a dependency of a user requested spec</span>
<span class="sd">                it&#39;s considered implicit.</span>

<span class="sd">            start_date: if set considers only specs installed from the starting date.</span>

<span class="sd">            end_date: if set considers only specs installed until the ending date.</span>

<span class="sd">            in_buildcache: specs that are marked in this database as part of an associated binary</span>
<span class="sd">                cache are ``in_buildcache``. All other specs are not. This field is used for</span>
<span class="sd">                querying mirror indices. By default, it does not check this status.</span>

<span class="sd">            hashes: list of hashes used to restrict the search</span>

<span class="sd">            origin: origin of the spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span>
                <span class="n">query_spec</span><span class="p">,</span>
                <span class="n">predicate_fn</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">,</span>
                <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">,</span>
                <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                <span class="n">hashes</span><span class="o">=</span><span class="n">hashes</span><span class="p">,</span>
                <span class="n">in_buildcache</span><span class="o">=</span><span class="n">in_buildcache</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Database.query">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.query">[docs]</a>
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">predicate_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SelectType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">installed</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">InstallStatus</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">InstallStatus</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">explicit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_buildcache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hashes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">install_tree</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queries the Spack database including all upstream databases.</span>

<span class="sd">        Args:</span>
<span class="sd">            query_spec:  if query_spec is ``None``, match all specs in the database.</span>
<span class="sd">                If it is a spec, return all specs matching ``spec.satisfies(query_spec)``.</span>

<span class="sd">            predicate_fn: optional predicate taking an InstallRecord as argument, and returning</span>
<span class="sd">                whether that record is selected for the query. It can be used to craft criteria</span>
<span class="sd">                that need some data for selection not provided by the Database itself.</span>

<span class="sd">            installed: if ``True``, includes only installed specs in the search. If ``False`` only</span>
<span class="sd">                missing specs, and if ``any``, all specs in database. If an InstallStatus or</span>
<span class="sd">                iterable of InstallStatus, returns specs whose install status matches at least</span>
<span class="sd">                one of the InstallStatus.</span>

<span class="sd">            explicit: a spec that was installed following a specific user request is marked as</span>
<span class="sd">                explicit. If instead it was pulled-in as a dependency of a user requested spec</span>
<span class="sd">                it&#39;s considered implicit.</span>

<span class="sd">            start_date: if set considers only specs installed from the starting date.</span>

<span class="sd">            end_date: if set considers only specs installed until the ending date.</span>

<span class="sd">            in_buildcache: specs that are marked in this database as part of an associated binary</span>
<span class="sd">                cache are ``in_buildcache``. All other specs are not. This field is used for</span>
<span class="sd">                querying mirror indices. By default, it does not check this status.</span>

<span class="sd">            hashes: list of hashes used to restrict the search</span>

<span class="sd">            install_tree: query &#39;all&#39; (default), &#39;local&#39;, &#39;upstream&#39;, or upstream path</span>

<span class="sd">            origin: origin of the spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_trees</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;upstream&quot;</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">root</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">install_tree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_trees</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid install_tree argument to Database.query()</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Try one of </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_trees</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">upstream_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">upstreams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span>
        <span class="k">if</span> <span class="n">install_tree</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;upstream&quot;</span><span class="p">):</span>
            <span class="n">upstreams</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_dbs</span> <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">root</span> <span class="o">==</span> <span class="n">install_tree</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">upstream_db</span> <span class="ow">in</span> <span class="n">upstreams</span><span class="p">:</span>
            <span class="c1"># queries for upstream DBs need to *not* lock - we may not</span>
            <span class="c1"># have permissions to do this and the upstream DBs won&#39;t know about</span>
            <span class="c1"># us anyway (so e.g. they should never uninstall specs)</span>
            <span class="n">upstream_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">upstream_db</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span>
                    <span class="n">query_spec</span><span class="p">,</span>
                    <span class="n">predicate_fn</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">,</span>
                    <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">,</span>
                    <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">,</span>
                    <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                    <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                    <span class="n">hashes</span><span class="o">=</span><span class="n">hashes</span><span class="p">,</span>
                    <span class="n">in_buildcache</span><span class="o">=</span><span class="n">in_buildcache</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="p">[]</span>
            <span class="p">)</span>

        <span class="n">local_results</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">install_tree</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">==</span> <span class="n">install_tree</span><span class="p">:</span>
            <span class="n">local_results</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_local</span><span class="p">(</span>
                    <span class="n">query_spec</span><span class="p">,</span>
                    <span class="n">predicate_fn</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">,</span>
                    <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">,</span>
                    <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">,</span>
                    <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                    <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                    <span class="n">hashes</span><span class="o">=</span><span class="n">hashes</span><span class="p">,</span>
                    <span class="n">in_buildcache</span><span class="o">=</span><span class="n">in_buildcache</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">local_results</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">upstream_results</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">local_results</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


<div class="viewcode-block" id="Database.query_one">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.query_one">[docs]</a>
    <span class="k">def</span> <span class="nf">query_one</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]],</span>
        <span class="n">predicate_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SelectType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">installed</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">InstallStatus</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">InstallStatus</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query for exactly one spec that matches the query spec.</span>

<span class="sd">        Returns None if no installed package matches.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: if more than one spec matches the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">concrete_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_spec</span><span class="p">,</span> <span class="n">predicate_fn</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="n">installed</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">concrete_specs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">concrete_specs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">concrete_specs</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Database.missing">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.missing">[docs]</a>
    <span class="k">def</span> <span class="nf">missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span>
        <span class="n">upstream</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_by_spec_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">installed</span></div>


<div class="viewcode-block" id="Database.is_occupied_install_prefix">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.is_occupied_install_prefix">[docs]</a>
    <span class="k">def</span> <span class="nf">is_occupied_install_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_installed_prefixes</span></div>


<div class="viewcode-block" id="Database.all_hashes">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.all_hashes">[docs]</a>
    <span class="k">def</span> <span class="nf">all_hashes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return dag hash of every spec in the database.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="Database.unused_specs">
<a class="viewcode-back" href="../../spack.html#spack.database.Database.unused_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">unused_specs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root_hashes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Container</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deptype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">DepFlag</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">DepTypes</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">LINK</span> <span class="o">|</span> <span class="n">dt</span><span class="o">.</span><span class="n">RUN</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;spack.spec.Spec&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all specs that are currently installed but not needed by root specs.</span>

<span class="sd">        By default, roots are all explicit specs in the database. If a set of root</span>
<span class="sd">        hashes are passed in, they are instead used as the roots.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            root_hashes: optional list of roots to consider when evaluating needed installations.</span>
<span class="sd">            deptype: if a spec is reachable from a root via these dependency types, it is</span>
<span class="sd">                considered needed. By default only link and run dependency types are considered.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Whether a DB record is a root for garbage collection.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">root_hashes</span> <span class="k">if</span> <span class="n">root_hashes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">record</span><span class="o">.</span><span class="n">explicit</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_transaction</span><span class="p">():</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">spec</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">root</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rec</span><span class="p">)]</span>
            <span class="n">needed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">traverse_nodes</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">deptype</span><span class="o">=</span><span class="n">deptype</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">spec</span>
                <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">needed</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">installed</span>
            <span class="p">]</span></div>
</div>



<div class="viewcode-block" id="NoUpstreamVisitor">
<a class="viewcode-back" href="../../spack.html#spack.database.NoUpstreamVisitor">[docs]</a>
<span class="k">class</span> <span class="nc">NoUpstreamVisitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gives edges to upstream specs, but does follow edges from upstream specs.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">upstream_hashes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">on_visit</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;spack.spec.DependencySpec&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upstream_hashes</span> <span class="o">=</span> <span class="n">upstream_hashes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_visit</span> <span class="o">=</span> <span class="n">on_visit</span>

<div class="viewcode-block" id="NoUpstreamVisitor.accept">
<a class="viewcode-back" href="../../spack.html#spack.database.NoUpstreamVisitor.accept">[docs]</a>
    <span class="k">def</span> <span class="nf">accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">EdgeAndDepth</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_visit</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">edge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_upstream</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="NoUpstreamVisitor.is_upstream">
<a class="viewcode-back" href="../../spack.html#spack.database.NoUpstreamVisitor.is_upstream">[docs]</a>
    <span class="k">def</span> <span class="nf">is_upstream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">EdgeAndDepth</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">dag_hash</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_hashes</span></div>


<div class="viewcode-block" id="NoUpstreamVisitor.neighbors">
<a class="viewcode-back" href="../../spack.html#spack.database.NoUpstreamVisitor.neighbors">[docs]</a>
    <span class="k">def</span> <span class="nf">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">EdgeAndDepth</span><span class="p">):</span>
        <span class="c1"># Prune edges from upstream nodes, only follow database tracked dependencies</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_upstream</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">item</span><span class="o">.</span><span class="n">edge</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">edges_to_dependencies</span><span class="p">(</span><span class="n">depflag</span><span class="o">=</span><span class="n">_TRACKED_DEPENDENCIES</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="UpstreamDatabaseLockingError">
<a class="viewcode-back" href="../../spack.html#spack.database.UpstreamDatabaseLockingError">[docs]</a>
<span class="k">class</span> <span class="nc">UpstreamDatabaseLockingError</span><span class="p">(</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an operation would need to lock an upstream database&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="CorruptDatabaseError">
<a class="viewcode-back" href="../../spack.html#spack.database.CorruptDatabaseError">[docs]</a>
<span class="k">class</span> <span class="nc">CorruptDatabaseError</span><span class="p">(</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when errors are found while reading the database.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="NonConcreteSpecAddError">
<a class="viewcode-back" href="../../spack.html#spack.database.NonConcreteSpecAddError">[docs]</a>
<span class="k">class</span> <span class="nc">NonConcreteSpecAddError</span><span class="p">(</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when attempting to add non-concrete spec to DB.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="MissingDependenciesError">
<a class="viewcode-back" href="../../spack.html#spack.database.MissingDependenciesError">[docs]</a>
<span class="k">class</span> <span class="nc">MissingDependenciesError</span><span class="p">(</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when DB cannot find records for dependencies&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="InvalidDatabaseVersionError">
<a class="viewcode-back" href="../../spack.html#spack.database.InvalidDatabaseVersionError">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidDatabaseVersionError</span><span class="p">(</span><span class="n">SpackError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when the database metadata is newer than current Spack.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">found</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found</span> <span class="o">=</span> <span class="n">found</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;you need a newer Spack version to read the DB in &#39;</span><span class="si">{</span><span class="n">database</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database_version_message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database_version_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;The expected DB version is &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2">&#39;, but &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">found</span><span class="si">}</span><span class="s2">&#39; was found.&quot;</span></div>



<div class="viewcode-block" id="NoSuchSpecError">
<a class="viewcode-back" href="../../spack.html#spack.database.NoSuchSpecError">[docs]</a>
<span class="k">class</span> <span class="nc">NoSuchSpecError</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a spec is not found in the database.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This exception is raised frequently, and almost always</span>
        <span class="c1"># caught, so ensure we don&#39;t pay the cost of Spec.__str__</span>
        <span class="c1"># unless the exception is actually printed.</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No such spec in database: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>