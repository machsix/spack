

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>llnl.util.tty.log &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=832b3b9f"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html">
            
              <img src="../../../../_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../packaging_guide.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../tty.html">llnl.util.tty</a></li>
      <li class="breadcrumb-item active">llnl.util.tty.log</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for llnl.util.tty.log</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>

<span class="sd">&quot;&quot;&quot;Utility classes for logging the output of blocks of code.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">multiprocessing.connection</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">llnl.util.tty</span> <span class="k">as</span> <span class="nn">tty</span>

<span class="n">termios</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">termios</span> <span class="k">as</span> <span class="nn">term_mod</span>

    <span class="n">termios</span> <span class="o">=</span> <span class="n">term_mod</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">esc</span><span class="p">,</span> <span class="n">bell</span><span class="p">,</span> <span class="n">lbracket</span><span class="p">,</span> <span class="n">bslash</span><span class="p">,</span> <span class="n">newline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\x1b&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\x07&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\[&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\n&quot;</span>
<span class="c1"># Ansi Control Sequence Introducers (CSI) are a well-defined format</span>
<span class="c1"># Standard ECMA-48: Control Functions for Character-Imaging I/O Devices, section 5.4</span>
<span class="c1"># https://www.ecma-international.org/wp-content/uploads/ECMA-48_5th_edition_june_1991.pdf</span>
<span class="n">csi_pre</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">esc</span><span class="si">}{</span><span class="n">lbracket</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">csi_param</span><span class="p">,</span> <span class="n">csi_inter</span><span class="p">,</span> <span class="n">csi_post</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[0-?]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;[ -/]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;[@-~]&quot;</span>
<span class="n">ansi_csi</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csi_pre</span><span class="si">}{</span><span class="n">csi_param</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">csi_inter</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">csi_post</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="c1"># General ansi escape sequences have well-defined prefixes,</span>
<span class="c1">#  but content and suffixes are less reliable.</span>
<span class="c1"># Conservatively assume they end with either &quot;&lt;ESC&gt;\&quot; or &quot;&lt;BELL&gt;&quot;,</span>
<span class="c1">#  with no intervening &quot;&lt;ESC&gt;&quot;/&quot;&lt;BELL&gt;&quot; keys or newlines</span>
<span class="n">esc_pre</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">esc</span><span class="si">}</span><span class="s2">[@-_]&quot;</span>
<span class="n">esc_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[^</span><span class="si">{</span><span class="n">esc</span><span class="si">}{</span><span class="n">bell</span><span class="si">}{</span><span class="n">newline</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="n">esc_post</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(?:</span><span class="si">{</span><span class="n">esc</span><span class="si">}{</span><span class="n">bslash</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">bell</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="n">ansi_esc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">esc_pre</span><span class="si">}{</span><span class="n">esc_content</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">esc_post</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="c1"># Use this to strip escape sequences</span>
<span class="n">_escape</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ansi_csi</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">ansi_esc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># control characters for enabling/disabling echo</span>
<span class="c1">#</span>
<span class="c1"># We use control characters to ensure that echo enable/disable are inline</span>
<span class="c1"># with the other output.  We always follow these with a newline to ensure</span>
<span class="c1"># one per line the following newline is ignored in output.</span>
<span class="n">xon</span><span class="p">,</span> <span class="n">xoff</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x11\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x13\n</span><span class="s2">&quot;</span>
<span class="n">control</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(</span><span class="se">\x11\n</span><span class="s2">|</span><span class="se">\x13\n</span><span class="s2">)&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ignore_signal">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.ignore_signal">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">ignore_signal</span><span class="p">(</span><span class="n">signum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager to temporarily ignore a signal.&quot;&quot;&quot;</span>
    <span class="n">old_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">old_handler</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_is_background_tty</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;True if the stream is a tty and calling process is in the background.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">getpgrp</span><span class="p">()</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">tcgetpgrp</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strip color and control characters from a line.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_escape</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>


<div class="viewcode-block" id="keyboard_input">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.keyboard_input">[docs]</a>
<span class="k">class</span> <span class="nc">keyboard_input</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager to disable line editing and echoing.</span>

<span class="sd">    Use this with ``sys.stdin`` for keyboard input, e.g.::</span>

<span class="sd">        with keyboard_input(sys.stdin) as kb:</span>
<span class="sd">            while True:</span>
<span class="sd">                kb.check_fg_bg()</span>
<span class="sd">                r, w, x = select.select([sys.stdin], [], [])</span>
<span class="sd">                # ... do something with keypresses ...</span>

<span class="sd">    The ``keyboard_input`` context manager disables canonical</span>
<span class="sd">    (line-based) input and echoing, so that keypresses are available on</span>
<span class="sd">    the stream immediately, and they are not printed to the</span>
<span class="sd">    terminal. Typically, standard input is line-buffered, which means</span>
<span class="sd">    keypresses won&#39;t be sent until the user hits return. In this mode, a</span>
<span class="sd">    user can hit, e.g., &#39;v&#39;, and it will be read on the other end of the</span>
<span class="sd">    pipe immediately but not printed.</span>

<span class="sd">    The handler takes care to ensure that terminal changes only take</span>
<span class="sd">    effect when the calling process is in the foreground. If the process</span>
<span class="sd">    is backgrounded, canonical mode and echo are re-enabled. They are</span>
<span class="sd">    disabled again when the calling process comes back to the foreground.</span>

<span class="sd">    This context manager works through a single signal handler for</span>
<span class="sd">    ``SIGTSTP``, along with a poolling routine called ``check_fg_bg()``.</span>
<span class="sd">    Here are the relevant states, transitions, and POSIX signals::</span>

<span class="sd">        [Running] -------- Ctrl-Z sends SIGTSTP ------------.</span>
<span class="sd">        [ in FG ] &lt;------- fg sends SIGCONT --------------. |</span>
<span class="sd">           ^                                              | |</span>
<span class="sd">           | fg (no signal)                               | |</span>
<span class="sd">           |                                              | v</span>
<span class="sd">        [Running] &lt;------- bg sends SIGCONT ---------- [Stopped]</span>
<span class="sd">        [ in BG ]                                      [ in BG ]</span>

<span class="sd">    We handle all transitions exept for ``SIGTSTP`` generated by Ctrl-Z</span>
<span class="sd">    by periodically calling ``check_fg_bg()``.  This routine notices if</span>
<span class="sd">    we are in the background with canonical mode or echo disabled, or if</span>
<span class="sd">    we are in the foreground without canonical disabled and echo enabled,</span>
<span class="sd">    and it fixes the terminal settings in response.</span>

<span class="sd">    ``check_fg_bg()`` works *except* for when the process is stopped with</span>
<span class="sd">    ``SIGTSTP``.  We cannot rely on a periodic timer in this case, as it</span>
<span class="sd">    may not rrun before the process stops.  We therefore restore terminal</span>
<span class="sd">    settings in the ``SIGTSTP`` handler.</span>

<span class="sd">    Additional notes:</span>

<span class="sd">    * We mostly use polling here instead of a SIGARLM timer or a</span>
<span class="sd">      thread. This is to avoid the complexities of many interrupts, which</span>
<span class="sd">      seem to make system calls (like I/O) unreliable in older Python</span>
<span class="sd">      versions (2.6 and 2.7).  See these issues for details:</span>

<span class="sd">      1. https://www.python.org/dev/peps/pep-0475/</span>
<span class="sd">      2. https://bugs.python.org/issue8354</span>

<span class="sd">      There are essentially too many ways for asynchronous signals to go</span>
<span class="sd">      wrong if we also have to support older Python versions, so we opt</span>
<span class="sd">      not to use them.</span>

<span class="sd">    * ``SIGSTOP`` can stop a process (in the foreground or background),</span>
<span class="sd">      but it can&#39;t be caught. Because of this, we can&#39;t fix any terminal</span>
<span class="sd">      settings on ``SIGSTOP``, and the terminal will be left with</span>
<span class="sd">      ``ICANON`` and ``ECHO`` disabled until it is resumes execution.</span>

<span class="sd">    * Technically, a process *could* be sent ``SIGTSTP`` while running in</span>
<span class="sd">      the foreground, without the shell backgrounding that process. This</span>
<span class="sd">      doesn&#39;t happen in practice, and we assume that ``SIGTSTP`` always</span>
<span class="sd">      means that defaults should be restored.</span>

<span class="sd">    * We rely on ``termios`` support.  Without it, or if the stream isn&#39;t</span>
<span class="sd">      a TTY, ``keyboard_input`` has no effect.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a context manager that will enable keyboard input on stream.</span>

<span class="sd">        Args:</span>
<span class="sd">            stream (file-like): stream on which to accept keyboard input</span>

<span class="sd">        Note that stream can be None, in which case ``keyboard_input``</span>
<span class="sd">        will do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>

    <span class="k">def</span> <span class="nf">_is_background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True iff calling process is in the background.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_is_background_tty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_canon_echo_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current termios canonical and echo settings.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">termios</span><span class="o">.</span><span class="n">ICANON</span><span class="p">),</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_enable_keyboard_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable canonical input and echoing on ``self.stream``.&quot;&quot;&quot;</span>
        <span class="c1"># &quot;enable&quot; input by disabling canonical mode and echo</span>
        <span class="n">new_cfg</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
        <span class="n">new_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">termios</span><span class="o">.</span><span class="n">ICANON</span>
        <span class="n">new_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span>

        <span class="c1"># Apply new settings for terminal</span>
        <span class="k">with</span> <span class="n">ignore_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTTOU</span><span class="p">):</span>
            <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSANOW</span><span class="p">,</span> <span class="n">new_cfg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_restore_default_terminal_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore the original input configuration on ``self.stream``.&quot;&quot;&quot;</span>
        <span class="c1"># _restore_default_terminal_settings Can be called in foreground</span>
        <span class="c1"># or background. When called in the background, tcsetattr triggers</span>
        <span class="c1"># SIGTTOU, which we must ignore, or the process will be stopped.</span>
        <span class="k">with</span> <span class="n">ignore_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTTOU</span><span class="p">):</span>
            <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSANOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_cfg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_tstp_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_default_terminal_settings</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGSTOP</span><span class="p">)</span>

<div class="viewcode-block" id="keyboard_input.check_fg_bg">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.keyboard_input.check_fg_bg">[docs]</a>
    <span class="k">def</span> <span class="nf">check_fg_bg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># old_cfg is set up in __enter__ and indicates that we have</span>
        <span class="c1"># termios and a valid stream.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_cfg</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># query terminal flags and fg/bg status</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_canon_echo_flags</span><span class="p">()</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_background</span><span class="p">()</span>

        <span class="c1"># restore sanity if flags are amiss -- see diagram in class docs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bg</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>  <span class="c1"># fg, but input not enabled</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_keyboard_input</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">bg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>  <span class="c1"># bg, but input enabled</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_default_terminal_settings</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable immediate keypress input, while this process is foreground.</span>

<span class="sd">        If the stream is not a TTY or the system doesn&#39;t support termios,</span>
<span class="sd">        do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_cfg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Ignore all this if the input stream is not a tty.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">termios</span><span class="p">:</span>
            <span class="c1"># save old termios settings to restore later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_cfg</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>

            <span class="c1"># Install a signal handler to disable/enable keyboard input</span>
            <span class="c1"># when the process moves between foreground and background.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tstp_handler</span><span class="p">)</span>

            <span class="c1"># add an atexit handler to ensure the terminal is restored</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restore_default_terminal_settings</span><span class="p">)</span>

            <span class="c1"># enable keyboard input initially (if foreground)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_background</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_enable_keyboard_input</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If termios was available, restore old settings.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_cfg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_default_terminal_settings</span><span class="p">()</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restore_default_terminal_settings</span><span class="p">)</span>

        <span class="c1"># restore SIGSTP and SIGCONT handlers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">signum</span><span class="p">,</span> <span class="n">old_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">old_handler</span><span class="p">)</span></div>



<div class="viewcode-block" id="Unbuffered">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.Unbuffered">[docs]</a>
<span class="k">class</span> <span class="nc">Unbuffered</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for Python streams that forces them to be unbuffered.</span>

<span class="sd">    This is implemented by forcing a flush after each write.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>

<div class="viewcode-block" id="Unbuffered.write">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.Unbuffered.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="Unbuffered.writelines">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.Unbuffered.writelines">[docs]</a>
    <span class="k">def</span> <span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_file_descriptors_work</span><span class="p">(</span><span class="o">*</span><span class="n">streams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether we can get file descriptors for the streams specified.</span>

<span class="sd">    This tries to call ``fileno()`` on all streams in the argument list,</span>
<span class="sd">    and returns ``False`` if anything goes wrong.</span>

<span class="sd">    This can happen, when, e.g., the test framework replaces stdout with</span>
<span class="sd">    a ``StringIO`` object.</span>

<span class="sd">    We have to actually try this to see whether it works, rather than</span>
<span class="sd">    checking for the fileno attribute, beacuse frameworks like pytest add</span>
<span class="sd">    dummy fileno methods on their dummy file objects that return</span>
<span class="sd">    ``UnsupportedOperationErrors``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># test whether we can get fds for out and error</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="FileWrapper">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.FileWrapper">[docs]</a>
<span class="k">class</span> <span class="nc">FileWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a file. Can be an open stream, a path to a file (not opened</span>
<span class="sd">    yet), or neither. When unwrapped, it returns an open file (or file-like)</span>
<span class="sd">    object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_like</span><span class="p">):</span>
        <span class="c1"># This records whether the file-like object returned by &quot;unwrap&quot; is</span>
        <span class="c1"># purely in-memory. In that case a subprocess will need to explicitly</span>
        <span class="c1"># transmit the contents to the parent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_in_parent</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span> <span class="o">=</span> <span class="n">file_like</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_like</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">_file_descriptors_work</span><span class="p">(</span><span class="n">file_like</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_in_parent</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="FileWrapper.unwrap">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.FileWrapper.unwrap">[docs]</a>
    <span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_like</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We were handed an already-open file object. In this case we also</span>
            <span class="c1"># will not actually close the object when requested to.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span></div>


<div class="viewcode-block" id="FileWrapper.close">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.FileWrapper.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="replace_environment">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.replace_environment">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">replace_environment</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace the current environment (`os.environ`) with `env`.</span>

<span class="sd">    If `env` is empty (or None), this unsets all current environment</span>
<span class="sd">    variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">env</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">old_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">old_env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>



<div class="viewcode-block" id="log_output">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.log_output">[docs]</a>
<span class="k">def</span> <span class="nf">log_output</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager that logs its output to a file.</span>

<span class="sd">    In the simplest case, the usage looks like this::</span>

<span class="sd">        with log_output(&#39;logfile.txt&#39;):</span>
<span class="sd">            # do things ... output will be logged</span>

<span class="sd">    Any output from the with block will be redirected to ``logfile.txt``.</span>
<span class="sd">    If you also want the output to be echoed to ``stdout``, use the</span>
<span class="sd">    ``echo`` parameter::</span>

<span class="sd">        with log_output(&#39;logfile.txt&#39;, echo=True):</span>
<span class="sd">            # do things ... output will be logged and printed out</span>

<span class="sd">    The following is available on Unix only. No-op on Windows.</span>
<span class="sd">    And, if you just want to echo *some* stuff from the parent, use</span>
<span class="sd">    ``force_echo``::</span>

<span class="sd">        with log_output(&#39;logfile.txt&#39;, echo=False) as logger:</span>
<span class="sd">            # do things ... output will be logged</span>

<span class="sd">            with logger.force_echo():</span>
<span class="sd">                # things here will be echoed *and* logged</span>

<span class="sd">    See individual log classes for more information.</span>


<span class="sd">    This method is actually a factory serving a per platform</span>
<span class="sd">    (unix vs windows) log_output class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">winlog</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nixlog</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="nixlog">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.nixlog">[docs]</a>
<span class="k">class</span> <span class="nc">nixlog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Under the hood, we spawn a daemon and set up a pipe between this</span>
<span class="sd">    process and the daemon.  The daemon writes our output to both the</span>
<span class="sd">    file and to stdout (if echoing).  The parent process can communicate</span>
<span class="sd">    with the daemon to tell it when and when not to echo; this is what</span>
<span class="sd">    force_echo does.  You can also enable/disable echoing by typing &#39;v&#39;.</span>

<span class="sd">    We try to use OS-level file descriptors to do the redirection, but if</span>
<span class="sd">    stdout or stderr has been set to some Python-level file object, we</span>
<span class="sd">    use Python-level redirection instead.  This allows the redirection to</span>
<span class="sd">    work within test frameworks like nose and pytest.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">file_like</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_fn</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new output log context manager.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_like (str or stream): open file object or name of file where</span>
<span class="sd">                output should be logged</span>
<span class="sd">            echo (bool): whether to echo output in addition to logging it</span>
<span class="sd">            debug (int): positive to enable tty debug mode during logging</span>
<span class="sd">            buffer (bool): pass buffer=True to skip unbuffering output; note</span>
<span class="sd">                this doesn&#39;t set up any *new* buffering</span>
<span class="sd">            filter_fn (callable, optional): Callable[str] -&gt; str to filter each</span>
<span class="sd">                line of output</span>

<span class="sd">        log_output can take either a file object or a filename. If a</span>
<span class="sd">        filename is passed, the file will be opened and closed entirely</span>
<span class="sd">        within ``__enter__`` and ``__exit__``. If a file object is passed,</span>
<span class="sd">        this assumes the caller owns it and will close it.</span>

<span class="sd">        By default, we unbuffer sys.stdout and sys.stderr because the</span>
<span class="sd">        logger will include output from executed programs and from python</span>
<span class="sd">        calls.  If stdout and stderr are buffered, their output won&#39;t be</span>
<span class="sd">        printed in the right place w.r.t. output from commands.</span>

<span class="sd">        Logger daemon is not started until ``__enter__()``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span> <span class="o">=</span> <span class="n">file_like</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>  <span class="c1"># the environment to use for _writer_daemon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_fn</span> <span class="o">=</span> <span class="n">filter_fn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># used to prevent re-entry</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_like</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This behaves the same as init. It allows a logger to be reused.</span>

<span class="sd">        Arguments are the same as for ``__init__()``.  Args here take</span>
<span class="sd">        precedence over those passed to ``__init__()``.</span>

<span class="sd">        With the ``__call__`` function, you can save state between uses</span>
<span class="sd">        of a single logger.  This is useful if you want to remember,</span>
<span class="sd">        e.g., the echo settings for a prior ``with log_output()``::</span>

<span class="sd">            logger = log_output()</span>

<span class="sd">            with logger(&#39;foo.txt&#39;):</span>
<span class="sd">                # log things; user can change echo settings with &#39;v&#39;</span>

<span class="sd">            with logger(&#39;bar.txt&#39;):</span>
<span class="sd">                # log things; logger remembers prior echo settings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span> <span class="o">=</span> <span class="n">file_like</span>
        <span class="k">if</span> <span class="n">echo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t re-enter the same log_output!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file argument must be set by either __init__ or __call__&quot;</span><span class="p">)</span>

        <span class="c1"># set up a stream for the daemon to write to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">FileWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_like</span><span class="p">)</span>

        <span class="c1"># record parent color settings before redirecting.  We do this</span>
        <span class="c1"># because color output depends on whether the *original* stdout</span>
        <span class="c1"># is a TTY.  New stdout won&#39;t be a TTY so we force colorization.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_color</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">_force_color</span>
        <span class="n">forced_color</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">get_color_when</span><span class="p">()</span>

        <span class="c1"># also record parent debug settings -- in case the logger is</span>
        <span class="c1"># forcing debug output.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_debug</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">_debug</span>

        <span class="c1"># Pipe for redirecting output to logger</span>
        <span class="n">read_fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_fd</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Pipe for communication back from the daemon</span>
        <span class="c1"># Currently only used to save echo value between uses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pipe</span><span class="p">,</span> <span class="n">child_pipe</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Sets a daemon that writes to file what it reads from a pipe</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># need to pass this b/c multiprocessing closes stdin in child.</span>
            <span class="n">input_fd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                    <span class="n">input_fd</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">()))</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="c1"># just don&#39;t forward input if this fails</span>
                <span class="k">pass</span>

            <span class="k">with</span> <span class="n">replace_environment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">_writer_daemon</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">input_fd</span><span class="p">,</span>
                        <span class="n">read_fd</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_fd</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span>
                        <span class="n">child_pipe</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">filter_fn</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># must set before start()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_fd</span><span class="p">:</span>
                <span class="n">input_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">read_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Flush immediately before redirecting so that anything buffered</span>
        <span class="c1"># goes to the original stream</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Now do the actual output redirection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fds</span> <span class="o">=</span> <span class="n">_file_descriptors_work</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_fds</span><span class="p">:</span>
            <span class="c1"># We try first to use OS-level file descriptors, as this</span>
            <span class="c1"># redirects output for subprocesses and system calls.</span>

            <span class="c1"># Save old stdout and stderr file descriptors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>

            <span class="c1"># redirect to the pipe we created above</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle I/O the Python way. This won&#39;t redirect lower-level</span>
            <span class="c1"># output, but it&#39;s the best we can do, and the caller</span>
            <span class="c1"># shouldn&#39;t expect any better, since *they* have apparently</span>
            <span class="c1"># redirected I/O the Python way.</span>

            <span class="c1"># Save old stdout and stderr file objects</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

            <span class="c1"># create a file object for the pipe; redirect to it.</span>
            <span class="n">pipe_fd_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">pipe_fd_out</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">pipe_fd_out</span>

        <span class="c1"># Unbuffer stdout and stderr at the Python level</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">Unbuffered</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">Unbuffered</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="c1"># Force color and debug settings now that we have redirected.</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">set_color_when</span><span class="p">(</span><span class="n">forced_color</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>

        <span class="c1"># track whether we&#39;re currently inside this log_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># return this log_output object so that the user can do things</span>
        <span class="c1"># like temporarily echo some output.</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="c1"># Flush any buffered output to the logger daemon.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># restore previous output settings, either the low-level way or</span>
        <span class="c1"># the python way</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_fds</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_saved_stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_saved_stdout</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_saved_stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_saved_stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_stdout</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_stderr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># print log contents in parent if needed.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">write_in_parent</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_pipe</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_like</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

        <span class="c1"># recover and store echo settings from the child before it dies</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_pipe</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="c1"># This may occur if some exception prematurely terminates the</span>
            <span class="c1"># _writer_daemon. An exception will have already been generated.</span>
            <span class="k">pass</span>

        <span class="c1"># now that the write pipe is closed (in this __exit__, when we restore</span>
        <span class="c1"># stdout with dup2), the logger daemon process loop will terminate. We</span>
        <span class="c1"># wait for that here.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># restore old color and debug settings</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">_force_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_color</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_debug</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># safe to enter again</span>

<div class="viewcode-block" id="nixlog.force_echo">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.nixlog.force_echo">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">force_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager to force local echo, even if echo is off.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t call force_echo() outside log_output region!&quot;</span><span class="p">)</span>

        <span class="c1"># This uses the xon/xoff to highlight regions to be echoed in the</span>
        <span class="c1"># output. We us these control characters rather than, say, a</span>
        <span class="c1"># separate pipe, because they&#39;re in-band and assured to appear</span>
        <span class="c1"># exactly before and after the text we want to echo.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xon</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xoff</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="StreamWrapper">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.StreamWrapper">[docs]</a>
<span class="k">class</span> <span class="nc">StreamWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper class to handle redirection of io streams&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_attr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span> <span class="o">=</span> <span class="n">sys_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_stream</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win32&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;gettotalrefcount&quot;</span><span class="p">):</span>  <span class="c1"># debug build</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;ucrtbased&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;api-ms-win-crt-stdio-l1-1-0&quot;</span><span class="p">)</span>

            <span class="n">kernel32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinDLL</span><span class="p">(</span><span class="s2">&quot;kernel32&quot;</span><span class="p">)</span>

            <span class="c1"># https://docs.microsoft.com/en-us/windows/console/getstdhandle</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span> <span class="o">==</span> <span class="s2">&quot;stdout&quot;</span><span class="p">:</span>
                <span class="n">STD_HANDLE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">11</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span> <span class="o">==</span> <span class="s2">&quot;stderr&quot;</span><span class="p">:</span>
                <span class="n">STD_HANDLE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span><span class="p">)</span>

            <span class="n">c_stdout</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetStdHandle</span><span class="p">(</span><span class="n">STD_HANDLE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">libc</span> <span class="o">=</span> <span class="n">libc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_stream</span> <span class="o">=</span> <span class="n">c_stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_stream</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_stream</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_stream_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_stream</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="c1"># Save a copy of the original stdout fd in saved_stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_stream</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_stream_fd</span><span class="p">)</span>

<div class="viewcode-block" id="StreamWrapper.redirect_stream">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.StreamWrapper.redirect_stream">[docs]</a>
    <span class="k">def</span> <span class="nf">redirect_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_fd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Redirect stdout to the given file descriptor.&quot;&quot;&quot;</span>
        <span class="c1"># Flush the C-level buffer stream</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win32&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">fflush</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">fflush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_stream</span><span class="p">)</span>
        <span class="c1"># Flush and close sys_stream - also closes the file descriptor (fd)</span>
        <span class="n">sys_stream</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span><span class="p">)</span>
        <span class="n">sys_stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Make orig_stream_fd point to the same file as to_fd</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">to_fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_stream_fd</span><span class="p">)</span>
        <span class="c1"># Set sys_stream to a new stream that points to the redirected fd</span>
        <span class="n">new_buffer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_stream_fd</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">new_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">new_buffer</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span><span class="p">,</span> <span class="n">new_stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_stream</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_attr</span><span class="p">)</span></div>


<div class="viewcode-block" id="StreamWrapper.flush">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.StreamWrapper.flush">[docs]</a>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win32&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">fflush</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">fflush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="StreamWrapper.close">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.StreamWrapper.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Redirect back to the original system stream, and close stream&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_stream</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_stream</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="winlog">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.winlog">[docs]</a>
<span class="k">class</span> <span class="nc">winlog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similar to nixlog, with underlying</span>
<span class="sd">    functionality ported to support Windows.</span>

<span class="sd">    Does not support the use of &#39;v&#39; toggling as nixlog does.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">file_like</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_fn</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">file_like</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">StreamWrapper</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">StreamWrapper</span><span class="p">(</span><span class="s2">&quot;stderr&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ioflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t re-enter the same log_output!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;file argument must be set by __init__ &quot;</span><span class="p">)</span>

        <span class="c1"># Open both write and reading on logfile</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ioflag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># cannot have two streams on tempfile, so we must make our own</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb+&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb+&quot;</span><span class="p">)</span>

            <span class="c1"># Dup stdout so we can still write to it after redirection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">echo_writer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="c1"># Redirect stdout and stderr to write to logfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">redirect_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">redirect_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">background_reader</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">echo_writer</span><span class="p">,</span> <span class="n">_kill</span><span class="p">):</span>
                <span class="c1"># for each line printed to logfile, read it</span>
                <span class="c1"># if echo: write line to user</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">is_killed</span> <span class="o">=</span> <span class="n">_kill</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                        <span class="c1"># Flush buffered build output to file</span>
                        <span class="c1"># stdout/err fds refer to log file</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                        <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="ow">and</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">echo_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()))</span>
                            <span class="n">echo_writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">is_killed</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="n">replace_environment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">background_reader</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo_writer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ioflag</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stderr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ioflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">echo_writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="winlog.force_echo">
<a class="viewcode-back" href="../../../../llnl.util.tty.html#llnl.util.tty.log.winlog.force_echo">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">force_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager to force local echo, even if echo is off.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t call force_echo() outside log_output region!&quot;</span><span class="p">)</span>
        <span class="k">yield</span></div>
</div>



<span class="k">def</span> <span class="nf">_writer_daemon</span><span class="p">(</span>
    <span class="n">stdin_fd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Connection</span><span class="p">],</span>
    <span class="n">read_fd</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span>
    <span class="n">write_fd</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span>
    <span class="n">echo</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">log_file_wrapper</span><span class="p">:</span> <span class="n">FileWrapper</span><span class="p">,</span>
    <span class="n">control_fd</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span>
    <span class="n">filter_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Daemon used by ``log_output`` to write to a log file and to ``stdout``.</span>

<span class="sd">    The daemon receives output from the parent process and writes it both</span>
<span class="sd">    to a log and, optionally, to ``stdout``.  The relationship looks like</span>
<span class="sd">    this::</span>

<span class="sd">        Terminal</span>
<span class="sd">           |</span>
<span class="sd">           |          +-------------------------+</span>
<span class="sd">           |          | Parent Process          |</span>
<span class="sd">           +--------&gt; |   with log_output():    |</span>
<span class="sd">           | stdin    |     ...                 |</span>
<span class="sd">           |          +-------------------------+</span>
<span class="sd">           |            ^             | write_fd (parent&#39;s redirected stdout)</span>
<span class="sd">           |            | control     |</span>
<span class="sd">           |            | pipe        |</span>
<span class="sd">           |            |             v read_fd</span>
<span class="sd">           |          +-------------------------+   stdout</span>
<span class="sd">           |          | Writer daemon           |------------&gt;</span>
<span class="sd">           +--------&gt; |   read from read_fd     |   log_file</span>
<span class="sd">             stdin    |   write to out and log  |------------&gt;</span>
<span class="sd">                      +-------------------------+</span>

<span class="sd">    Within the ``log_output`` handler, the parent&#39;s output is redirected</span>
<span class="sd">    to a pipe from which the daemon reads.  The daemon writes each line</span>
<span class="sd">    from the pipe to a log file and (optionally) to ``stdout``.  The user</span>
<span class="sd">    can hit ``v`` to toggle output on ``stdout``.</span>

<span class="sd">    In addition to the input and output file descriptors, the daemon</span>
<span class="sd">    interacts with the parent via ``control_pipe``.  It reports whether</span>
<span class="sd">    ``stdout`` was enabled or disabled when it finished and, if the</span>
<span class="sd">    ``log_file`` is a ``StringIO`` object, then the daemon also sends the</span>
<span class="sd">    logged output back to the parent as a string, to be written to the</span>
<span class="sd">    ``StringIO`` in the parent. This is mainly for testing.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        stdin_fd: optional input from the terminal</span>
<span class="sd">        read_fd: pipe for reading from parent&#39;s redirected stdout</span>
<span class="sd">        echo: initial echo setting -- controlled by user and preserved across multiple writer</span>
<span class="sd">            daemons</span>
<span class="sd">        log_file_wrapper: file to log all output</span>
<span class="sd">        control_pipe: multiprocessing pipe on which to send control information to the parent</span>
<span class="sd">        filter_fn: optional function to filter each line of output</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This process depends on closing all instances of write_pipe to terminate the reading loop</span>
    <span class="n">write_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># 1. Use line buffering (3rd param = 1) since Python 3 has a bug</span>
    <span class="c1">#    that prevents unbuffered text I/O. [needs citation]</span>
    <span class="c1"># 2. Enforce a UTF-8 interpretation of build process output with errors replaced by &#39;?&#39;.</span>
    <span class="c1">#    The downside is that the log file will not contain the exact output of the build process.</span>
    <span class="c1"># 3. closefd=False because Connection has &quot;ownership&quot;</span>
    <span class="n">read_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span>
        <span class="n">read_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">stdin_fd</span><span class="p">:</span>
        <span class="n">stdin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">stdin_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">closefd</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stdin_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># list of streams to select from</span>
    <span class="n">istreams</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_file</span><span class="p">,</span> <span class="n">stdin_file</span><span class="p">]</span> <span class="k">if</span> <span class="n">stdin_file</span> <span class="k">else</span> <span class="p">[</span><span class="n">read_file</span><span class="p">]</span>
    <span class="n">force_echo</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># parent can force echo for certain output</span>

    <span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file_wrapper</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">keyboard_input</span><span class="p">(</span><span class="n">stdin_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">kb</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># fix the terminal settings if we recently came to</span>
                <span class="c1"># the foreground</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">check_fg_bg</span><span class="p">()</span>

                <span class="c1"># wait for input from any stream. use a coarse timeout to</span>
                <span class="c1"># allow other checks while we wait for input</span>
                <span class="n">rlist</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_retry</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">)(</span><span class="n">istreams</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">1e-1</span><span class="p">)</span>

                <span class="c1"># Allow user to toggle echo with &#39;v&#39; key.</span>
                <span class="c1"># Currently ignores other chars.</span>
                <span class="c1"># only read stdin if we&#39;re in the foreground</span>
                <span class="k">if</span> <span class="n">stdin_file</span> <span class="ow">and</span> <span class="n">stdin_file</span> <span class="ow">in</span> <span class="n">rlist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_background_tty</span><span class="p">(</span><span class="n">stdin_file</span><span class="p">):</span>
                    <span class="c1"># it&#39;s possible to be backgrounded between the above</span>
                    <span class="c1"># check and the read, so we ignore SIGTTIN here.</span>
                    <span class="k">with</span> <span class="n">ignore_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTTIN</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">stdin_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span>
                                <span class="n">echo</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">echo</span>
                        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># If SIGTTIN is ignored, the system gives EIO</span>
                            <span class="c1"># to let the caller know the read failed b/c it</span>
                            <span class="c1"># was in the bg. Ignore that too.</span>
                            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EIO</span><span class="p">:</span>
                                <span class="k">raise</span>

                <span class="k">if</span> <span class="n">read_file</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                    <span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">while</span> <span class="n">line_count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                            <span class="c1"># Handle output from the calling process.</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">_retry</span><span class="p">(</span><span class="n">read_file</span><span class="o">.</span><span class="n">readline</span><span class="p">)()</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                                <span class="k">return</span>
                            <span class="n">line_count</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="c1"># find control characters and strip them.</span>
                            <span class="n">clean_line</span><span class="p">,</span> <span class="n">num_controls</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

                            <span class="c1"># Echo to stdout if requested or forced.</span>
                            <span class="k">if</span> <span class="n">echo</span> <span class="ow">or</span> <span class="n">force_echo</span><span class="p">:</span>
                                <span class="n">output_line</span> <span class="o">=</span> <span class="n">clean_line</span>
                                <span class="k">if</span> <span class="n">filter_fn</span><span class="p">:</span>
                                    <span class="n">output_line</span> <span class="o">=</span> <span class="n">filter_fn</span><span class="p">(</span><span class="n">clean_line</span><span class="p">)</span>
                                <span class="n">enc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
                                <span class="k">if</span> <span class="n">enc</span> <span class="o">!=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">:</span>
                                    <span class="c1"># On Python 3.6 and 3.7-3.14 with non-{utf-8,C} locale stdout</span>
                                    <span class="c1"># may not be able to handle utf-8 output. We do an inefficient</span>
                                    <span class="c1"># dance of re-encoding with errors replaced, so stdout.write</span>
                                    <span class="c1"># does not raise.</span>
                                    <span class="n">output_line</span> <span class="o">=</span> <span class="n">output_line</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_line</span><span class="p">)</span>

                            <span class="c1"># Stripped output to log file.</span>
                            <span class="n">log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_strip</span><span class="p">(</span><span class="n">clean_line</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">num_controls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">controls</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">xon</span> <span class="ow">in</span> <span class="n">controls</span><span class="p">:</span>
                                    <span class="n">force_echo</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">xoff</span> <span class="ow">in</span> <span class="n">controls</span><span class="p">:</span>
                                    <span class="n">force_echo</span> <span class="o">=</span> <span class="kc">False</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">_input_available</span><span class="p">(</span><span class="n">read_file</span><span class="p">):</span>
                                <span class="k">break</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">echo</span> <span class="ow">or</span> <span class="n">force_echo</span><span class="p">:</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                            <span class="n">log_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred in writer daemon!&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># send written data back to parent if we used a StringIO</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
            <span class="n">control_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">log_file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">log_file_wrapper</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">read_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stdin_fd</span><span class="p">:</span>
            <span class="n">stdin_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># send echo value back to the parent so it can be preserved.</span>
        <span class="n">control_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">echo</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_retry</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retry a call if errors indicating an interrupted system call occur.</span>

<span class="sd">    Interrupted system calls return -1 and set ``errno`` to ``EINTR`` if</span>
<span class="sd">    certain flags are not set.  Newer Pythons automatically retry them,</span>
<span class="sd">    but older Pythons do not, so we need to retry the calls.</span>

<span class="sd">    This function converts a call like this:</span>

<span class="sd">        syscall(args)</span>

<span class="sd">    and makes it retry by wrapping the function like this:</span>

<span class="sd">        _retry(syscall)(args)</span>

<span class="sd">    This is a private function because EINTR is unfortunately raised in</span>
<span class="sd">    different ways from different functions, and we only handle the ones</span>
<span class="sd">    relevant for this file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">raise</span>

    <span class="k">return</span> <span class="n">wrapped</span>


<span class="k">def</span> <span class="nf">_input_available</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>