

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Packaging Guide &mdash; Spack 0.23.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5f00b823" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=832b3b9f"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Build Systems" href="build_systems.html" />
    <link rel="prev" title="Contribution Guide" href="contribution_guide.html" /> 
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S0PQ7WV75K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S0PQ7WV75K');
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/spack-logo-white-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="replace_conda_homebrew.html">Spack for Homebrew/Conda Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="frequently_asked_questions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://spack-tutorial.readthedocs.io">Tutorial (spack-tutorial.rtfd.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://packages.spack.io">Packages (packages.spack.io)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cache.spack.io">Binaries (binaries.spack.io)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_yaml.html">Spack Settings (config.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="packages_yaml.html">Package Settings (packages.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_settings.html">Concretization Settings (concretizer.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="environments.html">Environments (spack.yaml, spack.lock)</a></li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="mirrors.html">Mirrors (mirrors.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_file_support.html">Modules (modules.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="repositories.html">Package Repositories (repos.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="binary_caches.html">Build Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootstrapping.html">Bootstrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_index.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="chain.html">Chaining Spack Installations (upstreams.yaml)</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">Custom Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines.html">CI Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="signing.html">Spack Package Signing</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu_configuration.html">Using External GPU Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Packaging Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview-of-the-installation-procedure">Overview of the installation procedure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-a-package-recipe">Writing a package recipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-new-packages">Creating new packages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#controlling-the-editor">Controlling the editor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bundling-software">Bundling software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-downloadable-software">Non-downloadable software</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#editing-existing-packages">Editing existing packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#naming-directory-structure">Naming &amp; directory structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#var-spack-repos-builtin-packages"><code class="docutils literal notranslate"><span class="pre">var/spack/repos/builtin/packages</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#package-names">Package Names</a></li>
<li class="toctree-l3"><a class="reference internal" href="#package-class-names">Package class names</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#maintainers">Maintainers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trusted-downloads">Trusted Downloads</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#checksums">Checksums</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#versions-and-fetching">Versions and fetching</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#date-versions">Date Versions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#version-urls">Version URLs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mirrors-of-the-main-url">Mirrors of the main URL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#skipping-the-expand-step">Skipping the expand step</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deprecating-old-versions">Deprecating old versions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#download-caching">Download caching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#version-comparison">Version comparison</a></li>
<li class="toctree-l3"><a class="reference internal" href="#version-selection">Version selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ranges-versus-specific-versions">Ranges versus specific versions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-checksum"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">checksum</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#finding-new-versions">Finding new versions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#list-url"><code class="docutils literal notranslate"><span class="pre">list_url</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#list-depth"><code class="docutils literal notranslate"><span class="pre">list_depth</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fetching-from-code-repositories">Fetching from code repositories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#git">Git</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github">GitHub</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mercurial">Mercurial</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subversion">Subversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cvs">CVS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#go">Go</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">Variants</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#boolean-variants">Boolean variants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-valued-variants">Multi-valued variants</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#complex-validation-logic-for-variant-values">Complex validation logic for variant values</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conditional-possible-values">Conditional Possible Values</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#conditional-variants">Conditional Variants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sticky-variants">Sticky Variants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overriding-variants">Overriding Variants</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#resources-expanding-extra-tarballs">Resources (expanding extra tarballs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#licensed-software">Licensed software</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#license-required"><code class="docutils literal notranslate"><span class="pre">license_required</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#license-comment"><code class="docutils literal notranslate"><span class="pre">license_comment</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#license-files"><code class="docutils literal notranslate"><span class="pre">license_files</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#license-vars"><code class="docutils literal notranslate"><span class="pre">license_vars</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#license-url"><code class="docutils literal notranslate"><span class="pre">license_url</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#patches">Patches</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#patch"><code class="docutils literal notranslate"><span class="pre">patch</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sha256-archive-sha256"><code class="docutils literal notranslate"><span class="pre">sha256</span></code>, <code class="docutils literal notranslate"><span class="pre">archive_sha256</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#when"><code class="docutils literal notranslate"><span class="pre">when</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#level"><code class="docutils literal notranslate"><span class="pre">level</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#working-dir"><code class="docutils literal notranslate"><span class="pre">working_dir</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#patch-functions">Patch functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependency-patching">Dependency patching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inspecting-patches">Inspecting patches</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#handling-rpaths">Handling RPATHs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parallel-builds">Parallel builds</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#package-level-build-parallelism">Package-level build parallelism</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-level-build-parallelism">Install-level build parallelism</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dependencies">Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#depends-on"><code class="docutils literal notranslate"><span class="pre">depends_on()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependency-specs">Dependency specs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#specifying-backward-and-forward-compatibility">Specifying backward and forward compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependency-types">Dependency types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conditional-dependencies">Conditional dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependency-dependency-patching">Dependency patching</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#conflicts-and-requirements">Conflicts and requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extensions">Extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-additional-constraints">Adding additional constraints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#runtime-and-build-time-environment-variables">Runtime and build time environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-package-module-variables">Setting package module variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#views">Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="#virtual-dependencies">Virtual dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#provides"><code class="docutils literal notranslate"><span class="pre">provides</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#providing-multiple-virtuals-simultaneously">Providing multiple virtuals simultaneously</a></li>
<li class="toctree-l3"><a class="reference internal" href="#versioned-interfaces">Versioned Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#provides-when"><code class="docutils literal notranslate"><span class="pre">provides</span> <span class="pre">when</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#custom-attributes">Custom attributes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-customized-attributes-for-virtual-packages">Example: Customized attributes for virtual packages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#abstract-concrete-specs">Abstract &amp; concrete specs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#concretization">Concretization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-spec"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">spec</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#concretization-policies"><code class="docutils literal notranslate"><span class="pre">Concretization</span> <span class="pre">Policies</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#common-when-constraints">Common <code class="docutils literal notranslate"><span class="pre">when=</span></code> constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="#common-default-arguments">Common default arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conflicting-specs">Conflicting Specs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overriding-build-system-defaults">Overriding build system defaults</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overriding-builder-methods">Overriding builder methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overriding-an-entire-phase">Overriding an entire phase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mixin-base-classes">Mixin base classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-build-systems">Multiple build systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-build-environment">The build environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#forking-install">Forking <code class="docutils literal notranslate"><span class="pre">install()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables">Environment variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#failing-the-build">Failing the build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shell-command-functions">Shell command functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compiler-flags">Compiler flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="#blas-lapack-and-scalapack-libraries">Blas, Lapack and ScaLapack libraries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prefix-objects">Prefix objects</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#spec-objects">Spec objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#testing-spec-constraints">Testing spec constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#architecture-specifiers">Architecture specifiers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#querying-the-platform-and-the-operating-system">Querying the platform and the operating system</a></li>
<li class="toctree-l4"><a class="reference internal" href="#querying-the-target-microarchitecture">Querying the target microarchitecture</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-dependencies">Accessing Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multimethods-and-when">Multimethods and <code class="docutils literal notranslate"><span class="pre">&#64;when</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#compiler-wrappers">Compiler wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mpi-support-in-spack">MPI support in Spack</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#packaging-conventions">Packaging Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-mpi"><code class="docutils literal notranslate"><span class="pre">spec[&quot;mpi&quot;]</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#wrapping-wrappers">Wrapping wrappers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mpi-on-cray-machines">MPI on Cray machines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#checking-an-installation">Checking an installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-time-tests">Build-time tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-sanity-checks">Adding sanity checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-installation-phase-tests">Adding installation phase tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#checking-build-time-test-results">Checking build-time test results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#stand-alone-tests">Stand-alone tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuring-the-test-stage-directory">Configuring the test stage directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-stand-alone-tests">Adding stand-alone tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-stand-alone-test-parts">Adding stand-alone test parts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-and-running-test-executables">Building and running test executables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#saving-build-and-install-time-files">Saving build- and install-time files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-custom-files">Adding custom files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-expected-output-from-a-file">Reading expected output from a file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#comparing-expected-to-actual-outputs">Comparing expected to actual outputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-package-and-test-related-files">Finding package- and test-related files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inheriting-stand-alone-tests">Inheriting stand-alone tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spack-test-list"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">list</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#spack-test-run"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">run</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#spack-test-results"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">results</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#spack-test-find"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">find</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#spack-test-remove"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">remove</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#file-manipulation-functions">File manipulation functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#filtering-functions">Filtering functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file-functions">File functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#making-a-package-discoverable-with-spack-external-find">Making a package discoverable with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">external</span> <span class="pre">find</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#minimal-detection">Minimal detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-functionality">Additional functionality</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#variants-and-custom-attributes">Variants and custom attributes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filter-matching-executables">Filter matching executables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#validate-detection">Validate detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-detection-workflow">Custom detection workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-detection-tests-to-packages">Add detection tests to packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tests-for-path-inspections">Tests for PATH inspections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reuse-tests-from-other-packages">Reuse tests from other packages</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#style-guidelines-for-packages">Style guidelines for packages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#variant-names">Variant Names</a></li>
<li class="toctree-l3"><a class="reference internal" href="#version-lists">Version Lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-home-vs-prefix">Using <code class="docutils literal notranslate"><span class="pre">home</span></code> vs <code class="docutils literal notranslate"><span class="pre">prefix</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#packaging-workflow-commands">Packaging workflow commands</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spack-fetch"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">fetch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-stage"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">stage</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-patch"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">patch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-restage"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">restage</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-clean"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">clean</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#keeping-the-stage-directory-on-success">Keeping the stage directory on success</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keeping-the-install-prefix-on-failure">Keeping the install prefix on failure</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#graphing-dependencies">Graphing dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spack-graph"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">graph</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#interactive-shell-support">Interactive shell support</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spack-cd"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">cd</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-build-env"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">build-env</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-location"><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">location</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#specifying-abi-compatibility">Specifying ABI Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#package-class-architecture">Package class architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-system-variant"><code class="docutils literal notranslate"><span class="pre">build_system</span></code> variant</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compatibility-with-single-class-format">Compatibility with single-class format</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#specifying-license-information">Specifying License Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="build_systems.html">Build Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer_guide.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="spack.html">Spack API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="llnl.html">LLNL API Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Spack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Packaging Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/packaging_guide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="packaging-guide">
<span id="id1"></span><h1>Packaging Guide<a class="headerlink" href="#packaging-guide" title="Link to this heading"></a></h1>
<p>This guide is intended for developers or administrators who want to
package software so that Spack can install it.  It assumes that you
have at least some familiarity with Python, and that you’ve read the
<a class="reference internal" href="basic_usage.html#basic-usage"><span class="std std-ref">basic usage guide</span></a>, especially the part about
<a class="reference internal" href="basic_usage.html#sec-specs"><span class="std std-ref">specs</span></a>.</p>
<p>There are two key parts of Spack:</p>
<ol class="arabic simple">
<li><p><strong>Specs</strong>: expressions for describing builds of software, and</p></li>
<li><p><strong>Packages</strong>: Python modules that describe how to build and
test software according to a spec.</p></li>
</ol>
<p>Specs allow a user to describe a <em>particular</em> build in a way that a
package author can understand.  Packages allow the packager to
encapsulate the build logic for different versions, compilers,
options, platforms, and dependency combinations in one place.
Essentially, a package translates a spec into build logic. It
also allows the packager to write spec-specific tests of the
installed software.</p>
<p>Packages in Spack are written in pure Python, so you can do anything
in Spack that you can do in Python.  Python was chosen as the
implementation language for two reasons.  First, Python is becoming
ubiquitous in the scientific software community. Second, it’s a modern
language and has many powerful features to help make package writing
easy.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>As a general rule, packages should install the software <em>from source</em>.
The only exception is for proprietary software (e.g., vendor compilers).</p>
<p>If a special build system needs to be added in order to support building
a package from source, then the associated code and recipe should be added
first.</p>
</div>
<section id="overview-of-the-installation-procedure">
<span id="installation-procedure"></span><h2>Overview of the installation procedure<a class="headerlink" href="#overview-of-the-installation-procedure" title="Link to this heading"></a></h2>
<p>Whenever Spack installs software, it goes through a series of predefined steps:</p>
<a class="reference internal image-reference" href="_images/installation_pipeline.png"><img alt="_images/installation_pipeline.png" class="align-center" src="_images/installation_pipeline.png" style="width: 310.8px; height: 360.59999999999997px;" />
</a>
<p>All these steps are influenced by the metadata in each <code class="docutils literal notranslate"><span class="pre">package.py</span></code> and
by the current Spack configuration.
Since build systems are different from one another, the execution of the
last block in the figure is further expanded in a build system specific way.
An example for <code class="docutils literal notranslate"><span class="pre">CMake</span></code> is, for instance:</p>
<a class="reference internal image-reference" href="_images/builder_phases.png"><img alt="_images/builder_phases.png" class="align-center" src="_images/builder_phases.png" style="width: 654.6px; height: 352.2px;" />
</a>
<p>The predefined steps for each build system are called “phases”.
In general, the name and order in which the phases will be executed can be
obtained by either reading the API docs at <a class="reference internal" href="spack.build_systems.html#module-spack.build_systems" title="spack.build_systems"><code class="xref py py-mod docutils literal notranslate"><span class="pre">build_systems</span></code></a>, or
using the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">info</span></code> command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>info<span class="w"> </span>--phases<span class="w"> </span>m4
<span class="go">AutotoolsPackage:    m4</span>
<span class="go">Homepage:            https://www.gnu.org/software/m4/m4.html</span>

<span class="go">Safe versions:</span>
<span class="go">    1.4.17    ftp://ftp.gnu.org/gnu/m4/m4-1.4.17.tar.gz</span>

<span class="go">Variants:</span>
<span class="go">    Name       Default   Description</span>

<span class="go">    sigsegv    on        Build the libsigsegv dependency</span>

<span class="hll"><span class="go">Installation Phases:</span>
</span><span class="hll"><span class="go">    autoreconf    configure    build    install</span>
</span>
<span class="go">Build Dependencies:</span>
<span class="go">    libsigsegv</span>

<span class="go">...</span>
</pre></div>
</div>
<p>An extensive list of available build systems and phases is provided in <a class="reference internal" href="#installation-process"><span class="std std-ref">Overriding build system defaults</span></a>.</p>
</section>
<section id="writing-a-package-recipe">
<h2>Writing a package recipe<a class="headerlink" href="#writing-a-package-recipe" title="Link to this heading"></a></h2>
<p>Since v0.19, Spack supports  two ways of writing a package recipe. The most commonly used is to encode both the metadata
(directives, etc.) and the build behavior in a single class, like shown in the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Openjpeg</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenJPEG is an open-source JPEG 2000 codec written in C language&quot;&quot;&quot;</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/uclouvain/openjpeg&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/uclouvain/openjpeg/archive/v2.3.1.tar.gz&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;2.4.0&quot;</span><span class="p">,</span> <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;8702ba68b442657f11aaeb2b338443ca8d5fb95b0d845757968a7be31ef7f16d&quot;</span><span class="p">)</span>

    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;codec&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Build the CODEC executables&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;libpng&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+codec&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">url_for_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2.1.1&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">url_for_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="n">url_fmt</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/uclouvain/openjpeg/archive/version.</span><span class="si">{0}</span><span class="s2">.tar.gz&quot;</span>
        <span class="k">return</span> <span class="n">url_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cmake_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define_from_variant</span><span class="p">(</span><span class="s2">&quot;BUILD_CODEC&quot;</span><span class="p">,</span> <span class="s2">&quot;codec&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;BUILD_MJ2&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;BUILD_THIRDPARTY&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">args</span>
</pre></div>
</div>
<p>A package encoded with a single class is backward compatible with versions of Spack
lower than v0.19, and so are custom repositories containing only recipes of this kind.
The downside is that <em>this format doesn’t allow packagers to use more than one build system in a single recipe</em>.</p>
<p>To do that, we have to resort to the second way Spack has of writing packages, which involves writing a
builder class explicitly. Using the same example as above, this reads:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Openjpeg</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenJPEG is an open-source JPEG 2000 codec written in C language&quot;&quot;&quot;</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/uclouvain/openjpeg&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/uclouvain/openjpeg/archive/v2.3.1.tar.gz&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;2.4.0&quot;</span><span class="p">,</span> <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;8702ba68b442657f11aaeb2b338443ca8d5fb95b0d845757968a7be31ef7f16d&quot;</span><span class="p">)</span>

    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;codec&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Build the CODEC executables&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;libpng&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+codec&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">url_for_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2.1.1&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">url_for_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="n">url_fmt</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/uclouvain/openjpeg/archive/version.</span><span class="si">{0}</span><span class="s2">.tar.gz&quot;</span>
        <span class="k">return</span> <span class="n">url_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CMakeBuilder</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">cmake</span><span class="o">.</span><span class="n">CMakeBuilder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cmake_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define_from_variant</span><span class="p">(</span><span class="s2">&quot;BUILD_CODEC&quot;</span><span class="p">,</span> <span class="s2">&quot;codec&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;BUILD_MJ2&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;BUILD_THIRDPARTY&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">args</span>
</pre></div>
</div>
<p>This way of writing packages allows extending the recipe to support multiple build systems,
see <a class="reference internal" href="#multiple-build-systems"><span class="std std-ref">Multiple build systems</span></a> for more details. The downside is that recipes of this kind
are only understood by Spack since v0.19+. More information on the internal architecture of
Spack can be found at <a class="reference internal" href="#package-class-structure"><span class="std std-ref">Package class architecture</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a builder is implemented in <code class="docutils literal notranslate"><span class="pre">package.py</span></code>, all build-specific methods must be moved
to the builder. This means that if you have a package like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">CmakePackage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cmake_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>and you add a builder to the <code class="docutils literal notranslate"><span class="pre">package.py</span></code>, you must move <code class="docutils literal notranslate"><span class="pre">cmake_args</span></code> to the builder.</p>
</div>
</section>
<section id="creating-new-packages">
<span id="cmd-spack-create"></span><h2>Creating new packages<a class="headerlink" href="#creating-new-packages" title="Link to this heading"></a></h2>
<p>To help creating a new package Spack provides a command that generates a <code class="docutils literal notranslate"><span class="pre">package.py</span></code>
file in an existing repository, with a boilerplate package template. Here’s an example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>create<span class="w"> </span>https://gmplib.org/download/gmp/gmp-6.1.2.tar.bz2
</pre></div>
</div>
<p>Spack examines the tarball URL and tries to figure out the name of the package
to be created. If the name contains uppercase letters, these are automatically
converted to lowercase. If the name contains underscores or periods, these are
automatically converted to dashes.</p>
<p>Spack also searches for <em>additional</em> versions located in the same directory of
the website. Spack prompts you to tell you how many versions it found and asks
you how many you would like to download and checksum:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>create<span class="w"> </span>https://gmplib.org/download/gmp/gmp-6.1.2.tar.bz2
<span class="go">==&gt; This looks like a URL for gmp</span>
<span class="go">==&gt; Found 16 versions of gmp:</span>

<span class="go">  6.1.2   https://gmplib.org/download/gmp/gmp-6.1.2.tar.bz2</span>
<span class="go">  6.1.1   https://gmplib.org/download/gmp/gmp-6.1.1.tar.bz2</span>
<span class="go">  6.1.0   https://gmplib.org/download/gmp/gmp-6.1.0.tar.bz2</span>
<span class="go">  ...</span>
<span class="go">  5.0.0   https://gmplib.org/download/gmp/gmp-5.0.0.tar.bz2</span>

<span class="go">How many would you like to checksum? (default is 1, q to abort)</span>
</pre></div>
</div>
<p>Spack will automatically download the number of tarballs you specify
(starting with the most recent) and checksum each of them.</p>
<p>You do not <em>have</em> to download all of the versions up front. You can
always choose to download just one tarball initially, and run
<a class="reference internal" href="#cmd-spack-checksum"><span class="std std-ref">spack checksum</span></a> later if you need more versions.</p>
<p>Spack automatically creates a directory in the appropriate repository,
generates a boilerplate template for your package, and opens up the new
<code class="docutils literal notranslate"><span class="pre">package.py</span></code> in your favorite <code class="docutils literal notranslate"><span class="pre">$EDITOR</span></code> (see <a class="reference internal" href="#controlling-the-editor"><span class="std std-ref">Controlling the editor</span></a>
for details):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># Copyright 2013-2024 Lawrence Livermore National Security, LLC and other</span>
<span class="linenos"> 2</span><span class="c1"># Spack Project Developers. See the top-level COPYRIGHT file for details.</span>
<span class="linenos"> 3</span><span class="c1">#</span>
<span class="linenos"> 4</span><span class="c1"># SPDX-License-Identifier: (Apache-2.0 OR MIT)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="c1"># ----------------------------------------------------------------------------</span>
<span class="linenos"> 7</span><span class="c1"># If you submit this package back to Spack as a pull request,</span>
<span class="linenos"> 8</span><span class="c1"># please first remove this boilerplate and all FIXME comments.</span>
<span class="linenos"> 9</span><span class="c1">#</span>
<span class="linenos">10</span><span class="c1"># This is a template package file for Spack.  We&#39;ve put &quot;FIXME&quot;</span>
<span class="linenos">11</span><span class="c1"># next to all the things you&#39;ll want to change. Once you&#39;ve handled</span>
<span class="linenos">12</span><span class="c1"># them, you can save this file and test your package like this:</span>
<span class="linenos">13</span><span class="c1">#</span>
<span class="linenos">14</span><span class="c1">#     spack install gmp</span>
<span class="linenos">15</span><span class="c1">#</span>
<span class="linenos">16</span><span class="c1"># You can edit this file again by typing:</span>
<span class="linenos">17</span><span class="c1">#</span>
<span class="linenos">18</span><span class="c1">#     spack edit gmp</span>
<span class="linenos">19</span><span class="c1">#</span>
<span class="linenos">20</span><span class="c1"># See the Spack documentation for more information on packaging.</span>
<span class="linenos">21</span><span class="c1"># ----------------------------------------------------------------------------</span>
<span class="linenos">22</span><span class="kn">import</span> <span class="nn">spack.build_systems.autotools</span>
<span class="linenos">23</span><span class="kn">from</span> <span class="nn">spack.package</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos">24</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="k">class</span> <span class="nc">Gmp</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>
<span class="linenos">27</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;FIXME: Put a proper description of your package here.&quot;&quot;&quot;</span>
<span class="linenos">28</span>
<span class="linenos">29</span>    <span class="c1"># FIXME: Add a proper url for your package&#39;s homepage here.</span>
<span class="linenos">30</span>    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://www.example.com&quot;</span>
<span class="linenos">31</span>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://gmplib.org/download/gmp/gmp-6.1.2.tar.bz2&quot;</span>
<span class="linenos">32</span>
<span class="linenos">33</span>    <span class="c1"># FIXME: Add a list of GitHub accounts to</span>
<span class="linenos">34</span>    <span class="c1"># notify when the package is updated.</span>
<span class="linenos">35</span>    <span class="c1"># maintainers(&quot;github_user1&quot;, &quot;github_user2&quot;)</span>
<span class="linenos">36</span>
<span class="linenos">37</span>    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;6.2.1&quot;</span><span class="p">,</span> <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;eae9326beb4158c386e39a356818031bd28f3124cf915f8c5b1dc4c7a36b4d7c&quot;</span><span class="p">)</span>
<span class="linenos">38</span>
<span class="linenos">39</span>    <span class="c1"># FIXME: Add dependencies if required.</span>
<span class="linenos">40</span>    <span class="c1"># depends_on(&quot;foo&quot;)</span>
<span class="linenos">41</span>
<span class="linenos">42</span>    <span class="k">def</span> <span class="nf">configure_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">43</span>        <span class="c1"># FIXME: Add arguments other than --prefix</span>
<span class="linenos">44</span>        <span class="c1"># FIXME: If not needed delete the function</span>
<span class="linenos">45</span>        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">46</span>        <span class="k">return</span> <span class="n">args</span>
</pre></div>
</div>
<p>The tedious stuff (creating the class, checksumming archives) has been
done for you. Spack correctly detected that <code class="docutils literal notranslate"><span class="pre">gmp</span></code> uses the <code class="docutils literal notranslate"><span class="pre">autotools</span></code>
build system, so it created a new <code class="docutils literal notranslate"><span class="pre">Gmp</span></code> package that subclasses the
<code class="docutils literal notranslate"><span class="pre">AutotoolsPackage</span></code> base class.</p>
<p>The default installation procedure for a package subclassing the <code class="docutils literal notranslate"><span class="pre">AutotoolsPackage</span></code>
is to go through the typical process of:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./configure<span class="w"> </span>--prefix<span class="o">=</span>/path/to/installation/directory
make
make<span class="w"> </span>check
make<span class="w"> </span>install
</pre></div>
</div>
<p>For most Autotools packages, this is sufficient. If you need to add
additional arguments to the <code class="docutils literal notranslate"><span class="pre">./configure</span></code> call, add them via the
<code class="docutils literal notranslate"><span class="pre">configure_args</span></code> function.</p>
<p>In the generated package, the download <code class="docutils literal notranslate"><span class="pre">url</span></code> attribute is already
set. All the things you still need to change are marked with
<code class="docutils literal notranslate"><span class="pre">FIXME</span></code> labels. You can delete the commented instructions between
the license and the first import statement after reading them.
The rest of the tasks you need to do are as follows:</p>
<ol class="arabic">
<li><p>Add a description.</p>
<p>Immediately inside the package class is a <em>docstring</em> in
triple-quotes (<code class="docutils literal notranslate"><span class="pre">&quot;&quot;&quot;</span></code>).  It is used to generate the description
shown when users run <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">info</span></code>.</p>
</li>
<li><p>Change the <code class="docutils literal notranslate"><span class="pre">homepage</span></code> to a useful URL.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">homepage</span></code> is displayed when users run <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">info</span></code> so
that they can learn more about your package.</p>
</li>
<li><p>Add a comma-separated list of maintainers.</p>
<p>Add a list of Github accounts of people who want to be notified
any time the package is modified. See <a class="reference internal" href="#package-maintainers"><span class="std std-ref">Maintainers</span></a>.</p>
</li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">depends_on()</span></code> calls for the package’s dependencies.</p>
<p><code class="docutils literal notranslate"><span class="pre">depends_on</span></code> tells Spack that other packages need to be built
and installed before this one. See <a class="reference internal" href="#dependencies"><span class="std std-ref">Dependencies</span></a>.</p>
</li>
<li><p>Get the installation working.</p>
<p>Your new package may require specific flags during <code class="docutils literal notranslate"><span class="pre">configure</span></code>.
These can be added via <code class="docutils literal notranslate"><span class="pre">configure_args</span></code>. Specifics will differ
depending on the package and its build system.
<a class="reference internal" href="#installation-process"><span class="std std-ref">Overriding build system defaults</span></a> is
covered in detail later.</p>
</li>
</ol>
<section id="controlling-the-editor">
<span id="id2"></span><h3>Controlling the editor<a class="headerlink" href="#controlling-the-editor" title="Link to this heading"></a></h3>
<p>When Spack needs to open an editor for you (e.g., for commands like
<a class="reference internal" href="#cmd-spack-create"><span class="std std-ref">Creating new packages</span></a> or <a class="reference internal" href="#cmd-spack-edit"><span class="std std-ref">Editing existing packages</span></a>, it looks at several environment variables
to figure out what to use. The order of precedence is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SPACK_EDITOR</span></code>: highest precedence, in case you want something specific for Spack;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VISUAL</span></code>: standard environment variable for full-screen editors like <code class="docutils literal notranslate"><span class="pre">vim</span></code> or <code class="docutils literal notranslate"><span class="pre">emacs</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EDITOR</span></code>: older environment variable for your editor.</p></li>
</ul>
<p>You can set any of these to the command you want to run, e.g., in <code class="docutils literal notranslate"><span class="pre">bash</span></code> you might run
one of these:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">VISUAL</span><span class="o">=</span><span class="n">vim</span>
<span class="n">export</span> <span class="n">EDITOR</span><span class="o">=</span><span class="s2">&quot;emacs -nw&quot;</span>
<span class="n">export</span> <span class="n">SPACK_EDITOR</span><span class="o">=</span><span class="n">nano</span>
</pre></div>
</div>
<p>If Spack finds none of these variables set, it will look for <code class="docutils literal notranslate"><span class="pre">vim</span></code>, <code class="docutils literal notranslate"><span class="pre">vi</span></code>, <code class="docutils literal notranslate"><span class="pre">emacs</span></code>,
<code class="docutils literal notranslate"><span class="pre">nano</span></code>, and <code class="docutils literal notranslate"><span class="pre">notepad</span></code>, in that order.</p>
</section>
<section id="bundling-software">
<h3>Bundling software<a class="headerlink" href="#bundling-software" title="Link to this heading"></a></h3>
<p>If you have a collection of software expected to work well together with
no source code of its own, you can create a <a class="reference internal" href="build_systems/bundlepackage.html#bundlepackage"><span class="std std-ref">BundlePackage</span></a>.
Examples where bundle packages can be useful include defining suites of
applications (e.g, <a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/ecp-proxy-apps/package.py">EcpProxyApps</a>), commonly used libraries
(e.g., <a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/amd-aocl/package.py">AmdAocl</a>),
and software development kits (e.g., <a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/ecp-data-vis-sdk/package.py">EcpDataVisSdk</a>).</p>
<p>These versioned packages primarily consist of dependencies on the associated
software packages. They can include <a class="reference internal" href="#variants"><span class="std std-ref">variants</span></a> to ensure
common build options are consistently applied to dependencies. Known build
failures, such as not building on a platform or when certain compilers or
variants are used, can be flagged with <a class="reference internal" href="#packaging-conflicts"><span class="std std-ref">conflicts</span></a>.
Build requirements, such as only building with specific compilers, can similarly
be flagged with <a class="reference internal" href="#packaging-conflicts"><span class="std std-ref">requires</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">create</span> <span class="pre">--template</span> <span class="pre">bundle</span></code> command will create a skeleton
<code class="docutils literal notranslate"><span class="pre">BundlePackage</span></code> <code class="docutils literal notranslate"><span class="pre">package.py</span></code> for you:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>create<span class="w"> </span>--template<span class="w"> </span>bundle<span class="w"> </span>--name<span class="w"> </span>coolsdk
</pre></div>
</div>
<p>Now you can fill in the basic package documentation, version(s), and software
package dependencies along with any other relevant customizations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that bundle packages have no software of their own so there
is nothing to download.</p>
</div>
</section>
<section id="non-downloadable-software">
<h3>Non-downloadable software<a class="headerlink" href="#non-downloadable-software" title="Link to this heading"></a></h3>
<p>If your software cannot be downloaded from a URL you can still create a boilerplate
<code class="docutils literal notranslate"><span class="pre">package.py</span></code> by telling <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">create</span></code> what name you want to use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>intel
</pre></div>
</div>
<p>This will create a simple <code class="docutils literal notranslate"><span class="pre">intel</span></code> package with an <code class="docutils literal notranslate"><span class="pre">install()</span></code>
method that you can craft to install your package.
Likewise, you can force the build system to be used with <code class="docutils literal notranslate"><span class="pre">--template</span></code> and,
in case it’s needed, you can overwrite a package already in the repository
with <code class="docutils literal notranslate"><span class="pre">--force</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>gmp<span class="w"> </span>https://gmplib.org/download/gmp/gmp-6.1.2.tar.bz2
<span class="gp">$ </span>spack<span class="w"> </span>create<span class="w"> </span>--force<span class="w"> </span>--template<span class="w"> </span>autotools<span class="w"> </span>https://gmplib.org/download/gmp/gmp-6.1.2.tar.bz2
</pre></div>
</div>
<p>A complete list of available build system templates can be found by running
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">create</span> <span class="pre">--help</span></code>.</p>
</section>
</section>
<section id="editing-existing-packages">
<span id="cmd-spack-edit"></span><h2>Editing existing packages<a class="headerlink" href="#editing-existing-packages" title="Link to this heading"></a></h2>
<p>One of the easiest ways to learn how to write packages is to look at
existing ones.  You can edit a package file by name with the <code class="docutils literal notranslate"><span class="pre">spack</span>
<span class="pre">edit</span></code> command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>edit<span class="w"> </span>gmp
</pre></div>
</div>
<p>If you used <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">create</span></code> to create a package, you can get back to
it later with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">edit</span></code>. For instance, the <code class="docutils literal notranslate"><span class="pre">gmp</span></code> package actually
lives in:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>location<span class="w"> </span>-p<span class="w"> </span>gmp
<span class="gp">$</span><span class="o">{</span>SPACK_ROOT<span class="o">}</span>/var/spack/repos/builtin/packages/gmp/package.py
</pre></div>
</div>
<p>but <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">edit</span></code> provides a much simpler shortcut and saves you the
trouble of typing the full path.</p>
</section>
<section id="naming-directory-structure">
<h2>Naming &amp; directory structure<a class="headerlink" href="#naming-directory-structure" title="Link to this heading"></a></h2>
<p>This section describes how packages need to be named, and where they
live in Spack’s directory structure.  In general, <a class="reference internal" href="#cmd-spack-create"><span class="std std-ref">Creating new packages</span></a>
handles creating package files for you, so you can skip most of the
details here.</p>
<section id="var-spack-repos-builtin-packages">
<h3><code class="docutils literal notranslate"><span class="pre">var/spack/repos/builtin/packages</span></code><a class="headerlink" href="#var-spack-repos-builtin-packages" title="Link to this heading"></a></h3>
<p>A Spack installation directory is structured like a standard UNIX
install prefix (<code class="docutils literal notranslate"><span class="pre">bin</span></code>, <code class="docutils literal notranslate"><span class="pre">lib</span></code>, <code class="docutils literal notranslate"><span class="pre">include</span></code>, <code class="docutils literal notranslate"><span class="pre">var</span></code>, <code class="docutils literal notranslate"><span class="pre">opt</span></code>,
etc.).  Most of the code for Spack lives in <code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/lib/spack</span></code>.
Packages themselves live in <code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/var/spack/repos/builtin/packages</span></code>.</p>
<p>If you <code class="docutils literal notranslate"><span class="pre">cd</span></code> to that directory, you will see directories for each
package:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ cd $SPACK_ROOT/var/spack/repos/builtin/packages &amp;&amp; ls
3dtk
3proxy
7zip
abacus
abduco
abi-compliance-checker
abi-dumper
abinit
abseil-cpp
abyss
...
</pre></div>
</div>
<p>Each directory contains a file called <code class="docutils literal notranslate"><span class="pre">package.py</span></code>, which is where
all the python code for the package goes.  For example, the <code class="docutils literal notranslate"><span class="pre">libelf</span></code>
package lives in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$SPACK_ROOT/var/spack/repos/builtin/packages/libelf/package.py
</pre></div>
</div>
<p>Alongside the <code class="docutils literal notranslate"><span class="pre">package.py</span></code> file, a package may contain extra
directories or files (like patches) that it needs to build.</p>
</section>
<section id="package-names">
<h3>Package Names<a class="headerlink" href="#package-names" title="Link to this heading"></a></h3>
<p>Packages are named after the directory containing <code class="docutils literal notranslate"><span class="pre">package.py</span></code>. So,
<code class="docutils literal notranslate"><span class="pre">libelf</span></code>’s <code class="docutils literal notranslate"><span class="pre">package.py</span></code> lives in a directory called <code class="docutils literal notranslate"><span class="pre">libelf</span></code>.
The <code class="docutils literal notranslate"><span class="pre">package.py</span></code> file defines a class called <code class="docutils literal notranslate"><span class="pre">Libelf</span></code>, which
extends Spack’s <code class="docutils literal notranslate"><span class="pre">Package</span></code> class.  For example, here is
<code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/var/spack/repos/builtin/packages/libelf/package.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">Libelf</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; ... description ... &quot;&quot;&quot;</span>
<span class="linenos"> 5</span>    <span class="n">homepage</span> <span class="o">=</span> <span class="o">...</span>
<span class="linenos"> 6</span>    <span class="n">url</span> <span class="o">=</span> <span class="o">...</span>
<span class="linenos"> 7</span>    <span class="n">version</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="linenos"> 8</span>    <span class="n">depends_on</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="k">def</span> <span class="nf">install</span><span class="p">():</span>
<span class="linenos">11</span>        <span class="o">...</span>
</pre></div>
</div>
<p>The <strong>directory name</strong> (<code class="docutils literal notranslate"><span class="pre">libelf</span></code>) determines the package name that
users should provide on the command line. e.g., if you type any of
these:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>info<span class="w"> </span>libelf
<span class="gp">$ </span>spack<span class="w"> </span>versions<span class="w"> </span>libelf
<span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>libelf@0.8.13
</pre></div>
</div>
<p>Spack sees the package name in the spec and looks for
<code class="docutils literal notranslate"><span class="pre">libelf/package.py</span></code> in <code class="docutils literal notranslate"><span class="pre">var/spack/repos/builtin/packages</span></code>.
Likewise, if you run <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">py-numpy</span></code>, Spack looks for
<code class="docutils literal notranslate"><span class="pre">py-numpy/package.py</span></code>.</p>
<p>Spack uses the directory name as the package name in order to give
packagers more freedom in naming their packages. Package names can
contain letters, numbers, and dashes. Using a Python identifier
(e.g., a class name or a module name) would make it difficult to
support these options.  So, you can name a package <code class="docutils literal notranslate"><span class="pre">3proxy</span></code> or
<code class="docutils literal notranslate"><span class="pre">foo-bar</span></code> and Spack won’t care. It just needs to see that name
in the packages directory.</p>
</section>
<section id="package-class-names">
<h3>Package class names<a class="headerlink" href="#package-class-names" title="Link to this heading"></a></h3>
<p>Spack loads <code class="docutils literal notranslate"><span class="pre">package.py</span></code> files dynamically, and it needs to find a
special class name in the file for the load to succeed.  The <strong>class
name</strong> (<code class="docutils literal notranslate"><span class="pre">Libelf</span></code> in our example) is formed by converting words
separated by <code class="docutils literal notranslate"><span class="pre">-</span></code> in the file name to CamelCase. If the name
starts with a number, we prefix the class name with <code class="docutils literal notranslate"><span class="pre">_</span></code>. Here are
some examples:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Module Name</p></th>
<th class="head"><p>Class Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">foo-bar</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">FooBar</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">3proxy</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">_3proxy</span></code></p></td>
</tr>
</tbody>
</table>
<p>In general, you won’t have to remember this naming convention because
<a class="reference internal" href="#cmd-spack-create"><span class="std std-ref">Creating new packages</span></a> and <a class="reference internal" href="#cmd-spack-edit"><span class="std std-ref">Editing existing packages</span></a> handle the details for you.</p>
</section>
</section>
<section id="maintainers">
<span id="package-maintainers"></span><h2>Maintainers<a class="headerlink" href="#maintainers" title="Link to this heading"></a></h2>
<p>Each package in Spack may have one or more maintainers, i.e. one or more
GitHub accounts of people who want to be notified any time the package is
modified.</p>
<p>When a pull request is submitted that updates the package, these people will
be requested to review the PR. This is useful for developers who maintain a
Spack package for their own software, as well as users who rely on a piece of
software and want to ensure that the package doesn’t break. It also gives users
a list of people to contact for help when someone reports a build error with
the package.</p>
<p>To add maintainers to a package, simply declare them with the <code class="docutils literal notranslate"><span class="pre">maintainers</span></code> directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">maintainers</span><span class="p">(</span><span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;user2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The list of maintainers is additive, and includes all the accounts eventually declared in base classes.</p>
</section>
<section id="trusted-downloads">
<h2>Trusted Downloads<a class="headerlink" href="#trusted-downloads" title="Link to this heading"></a></h2>
<p>Spack verifies that the source code it downloads is not corrupted or
compromised; or at least, that it is the same version the author of
the Spack package saw when the package was created.  If Spack uses a
download method it can verify, we say the download method is
<em>trusted</em>.  Trust is important for <em>all downloads</em>: Spack
has no control over the security of the various sites from which it
downloads source code, and can never assume that any particular site
hasn’t been compromised.</p>
<p>Trust is established in different ways for different download methods.
For the most common download method — a single-file tarball — the
tarball is checksummed.  Git downloads using <code class="docutils literal notranslate"><span class="pre">commit=</span></code> are trusted
implicitly, as long as a hash is specified.</p>
<p>Spack also provides untrusted download methods: tarball URLs may be
supplied without a checksum, or Git downloads may specify a branch or
tag instead of a hash.  If the user does not control or trust the
source of an untrusted download, it is a security risk.  Unless otherwise
specified by the user for special cases, Spack should by default use
<em>only</em> trusted download methods.</p>
<p>Unfortunately, Spack does not currently provide that guarantee.  It
does provide the following mechanisms for safety:</p>
<ol class="arabic simple">
<li><p>By default, Spack will only install a tarball package if it has a
checksum and that checksum matches.  You can override this with
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">--no-checksum</span></code>.</p></li>
<li><p>Numeric versions are almost always tarball downloads, whereas
non-numeric versions not named <code class="docutils literal notranslate"><span class="pre">develop</span></code> frequently download
untrusted branches or tags from a version control system.  As long
as a package has at least one numeric version, and no non-numeric
version named <code class="docutils literal notranslate"><span class="pre">develop</span></code>, Spack will prefer it over any
non-numeric versions.</p></li>
</ol>
<section id="checksums">
<h3>Checksums<a class="headerlink" href="#checksums" title="Link to this heading"></a></h3>
<p>For tarball downloads, Spack can currently support checksums using the
MD5, SHA-1, SHA-224, SHA-256, SHA-384, and SHA-512 algorithms.  It
determines the algorithm to use based on the hash length.</p>
</section>
</section>
<section id="versions-and-fetching">
<span id="id3"></span><h2>Versions and fetching<a class="headerlink" href="#versions-and-fetching" title="Link to this heading"></a></h2>
<p>The most straightforward way to add new versions to your package is to
add a line like this in the package class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://example.com/foo-1.0.tar.gz&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;8.2.1&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;4136d7b4c04df68b686570afa26988ac&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;8.2.0&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;1c9f62f0778697a09d36121ead88e08e&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;8.1.2&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;d47dd09ed7ae6e7fd6f9a816d7f5fdf6&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By convention, we list versions in descending order, from newest to oldest.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="build_systems/bundlepackage.html#bundlepackage"><span class="std std-ref">Bundle packages</span></a> do not have source code so
there is nothing to fetch. Consequently, their version directives
consist solely of the version name (e.g., <code class="docutils literal notranslate"><span class="pre">version(&quot;202309&quot;)</span></code>).</p>
</div>
<section id="date-versions">
<h3>Date Versions<a class="headerlink" href="#date-versions" title="Link to this heading"></a></h3>
<p>If you wish to use dates as versions, it is best to use the format
<code class="docutils literal notranslate"><span class="pre">&#64;yyyy-mm-dd</span></code>.  This will ensure they sort in the correct order.</p>
<p>Alternately, you might use a hybrid release-version / date scheme.
For example, <code class="docutils literal notranslate"><span class="pre">&#64;1.3_2016-08-31</span></code> would mean the version from the
<code class="docutils literal notranslate"><span class="pre">1.3</span></code> branch, as of August 31, 2016.</p>
</section>
<section id="version-urls">
<h3>Version URLs<a class="headerlink" href="#version-urls" title="Link to this heading"></a></h3>
<p>By default, each version’s URL is extrapolated from the <code class="docutils literal notranslate"><span class="pre">url</span></code> field
in the package.  For example, Spack is smart enough to download
version <code class="docutils literal notranslate"><span class="pre">8.2.1</span></code> of the <code class="docutils literal notranslate"><span class="pre">Foo</span></code> package above from
<a class="reference external" href="http://example.com/foo-8.2.1.tar.gz">http://example.com/foo-8.2.1.tar.gz</a>.</p>
<p>If the URL is particularly complicated or changes based on the release,
you can override the default URL generation algorithm by defining your
own <code class="docutils literal notranslate"><span class="pre">url_for_version()</span></code> function. For example, the download URL for
OpenMPI contains the major.minor version in one spot and the
major.minor.patch version in another:</p>
<p><a class="reference external" href="https://www.open-mpi.org/software/ompi/v2.1/downloads/openmpi-2.1.1.tar.bz2">https://www.open-mpi.org/software/ompi/v2.1/downloads/openmpi-2.1.1.tar.bz2</a></p>
<p>In order to handle this, you can define a <code class="docutils literal notranslate"><span class="pre">url_for_version()</span></code> function
like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">url_for_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://download.open-mpi.org/release/open-mpi/v</span><span class="si">{0}</span><span class="s2">/openmpi-</span><span class="si">{1}</span><span class="s2">.tar.bz2&quot;</span>
        <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">up_to</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">version</span><span class="p">)</span>
</pre></div>
</div>
<p>With the use of this <code class="docutils literal notranslate"><span class="pre">url_for_version()</span></code>, Spack knows to download OpenMPI <code class="docutils literal notranslate"><span class="pre">2.1.1</span></code>
from <a class="reference external" href="http://www.open-mpi.org/software/ompi/v2.1/downloads/openmpi-2.1.1.tar.bz2">http://www.open-mpi.org/software/ompi/v2.1/downloads/openmpi-2.1.1.tar.bz2</a>
but download OpenMPI <code class="docutils literal notranslate"><span class="pre">1.10.7</span></code> from <a class="reference external" href="http://www.open-mpi.org/software/ompi/v1.10/downloads/openmpi-1.10.7.tar.bz2">http://www.open-mpi.org/software/ompi/v1.10/downloads/openmpi-1.10.7.tar.bz2</a>.</p>
<p>You’ll notice that OpenMPI’s <code class="docutils literal notranslate"><span class="pre">url_for_version()</span></code> function makes use of a special
<code class="docutils literal notranslate"><span class="pre">Version</span></code> function called <code class="docutils literal notranslate"><span class="pre">up_to()</span></code>. When you call <code class="docutils literal notranslate"><span class="pre">version.up_to(2)</span></code> on a
version like <code class="docutils literal notranslate"><span class="pre">1.10.0</span></code>, it returns <code class="docutils literal notranslate"><span class="pre">1.10</span></code>. <code class="docutils literal notranslate"><span class="pre">version.up_to(1)</span></code> would return
<code class="docutils literal notranslate"><span class="pre">1</span></code>. This can be very useful for packages that place all <code class="docutils literal notranslate"><span class="pre">X.Y.*</span></code> versions in
a single directory and then places all <code class="docutils literal notranslate"><span class="pre">X.Y.Z</span></code> versions in a sub-directory.</p>
<p>There are a few <code class="docutils literal notranslate"><span class="pre">Version</span></code> properties you should be aware of. We generally
prefer numeric versions to be separated by dots for uniformity, but not all
tarballs are named that way. For example, <code class="docutils literal notranslate"><span class="pre">icu4c</span></code> separates its major and minor
versions with underscores, like <code class="docutils literal notranslate"><span class="pre">icu4c-57_1-src.tgz</span></code>. The value <code class="docutils literal notranslate"><span class="pre">57_1</span></code> can be
obtained with the use of the <code class="docutils literal notranslate"><span class="pre">version.underscored</span></code> property. Note that Python
properties don’t need parentheses. There are other separator properties as well:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Result</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>version.dotted</p></td>
<td><p>1.2.3</p></td>
</tr>
<tr class="row-odd"><td><p>version.dashed</p></td>
<td><p>1-2-3</p></td>
</tr>
<tr class="row-even"><td><p>version.underscored</p></td>
<td><p>1_2_3</p></td>
</tr>
<tr class="row-odd"><td><p>version.joined</p></td>
<td><p>123</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Python properties don’t need parentheses. <code class="docutils literal notranslate"><span class="pre">version.dashed</span></code> is correct.
<code class="docutils literal notranslate"><span class="pre">version.dashed()</span></code> is incorrect.</p>
</div>
<p>In addition, these version properties can be combined with <code class="docutils literal notranslate"><span class="pre">up_to()</span></code>.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;1.2.3&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">version</span><span class="o">.</span><span class="n">up_to</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">dashed</span>
<span class="go">Version(&quot;1-2&quot;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">version</span><span class="o">.</span><span class="n">underscored</span><span class="o">.</span><span class="n">up_to</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">Version(&quot;1_2&quot;)</span>
</pre></div>
</div>
<p>As you can see, order is not important. Just keep in mind that <code class="docutils literal notranslate"><span class="pre">up_to()</span></code> and
the other version properties return <code class="docutils literal notranslate"><span class="pre">Version</span></code> objects, not strings.</p>
<p>If a URL cannot be derived systematically, or there is a special URL for one
of its versions, you can add an explicit URL for a particular version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;8.2.1&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;4136d7b4c04df68b686570afa26988ac&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://example.com/foo-8.2.1-special-version.tar.gz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When you supply a custom URL for a version, Spack uses that URL
<em>verbatim</em> and does not perform extrapolation. The order of precedence
of these methods is:</p>
<ol class="arabic simple">
<li><p>package-level <code class="docutils literal notranslate"><span class="pre">url</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">url_for_version()</span></code></p></li>
<li><p>version-specific <code class="docutils literal notranslate"><span class="pre">url</span></code></p></li>
</ol>
<p>so if your package contains a <code class="docutils literal notranslate"><span class="pre">url_for_version()</span></code>, it can be overridden
by a version-specific <code class="docutils literal notranslate"><span class="pre">url</span></code>.</p>
<p>If your package does not contain a package-level <code class="docutils literal notranslate"><span class="pre">url</span></code> or <code class="docutils literal notranslate"><span class="pre">url_for_version()</span></code>,
Spack can determine which URL to download from even if only some of the versions
specify their own <code class="docutils literal notranslate"><span class="pre">url</span></code>. Spack will use the nearest URL <em>before</em> the requested
version. This is useful for packages that have an easy to extrapolate URL, but
keep changing their URL format every few releases. With this method, you only
need to specify the <code class="docutils literal notranslate"><span class="pre">url</span></code> when the URL changes.</p>
<section id="mirrors-of-the-main-url">
<h4>Mirrors of the main URL<a class="headerlink" href="#mirrors-of-the-main-url" title="Link to this heading"></a></h4>
<p>Spack supports listing mirrors of the main URL in a package by defining
the <code class="docutils literal notranslate"><span class="pre">urls</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>

  <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">&quot;http://example.com/foo-1.0.tar.gz&quot;</span><span class="p">,</span>
      <span class="s2">&quot;http://mirror.com/foo-1.0.tar.gz&quot;</span>
  <span class="p">]</span>
</pre></div>
</div>
<p>instead of just a single <code class="docutils literal notranslate"><span class="pre">url</span></code>. This attribute is a list of possible URLs that
will be tried in order when fetching packages. Notice that either one of <code class="docutils literal notranslate"><span class="pre">url</span></code>
or <code class="docutils literal notranslate"><span class="pre">urls</span></code> can be present in a package, but not both at the same time.</p>
<p>A well-known case of packages that can be fetched from multiple mirrors is that
of GNU. For that, Spack goes a step further and defines a mixin class that
takes care of all of the plumbing and requires packagers to just define a proper
<code class="docutils literal notranslate"><span class="pre">gnu_mirror_path</span></code> attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>

<span class="k">class</span> <span class="nc">Autoconf</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">,</span> <span class="n">GNUMirrorPackage</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Autoconf -- system configuration part of autotools&quot;&quot;&quot;</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://www.gnu.org/software/autoconf/&quot;</span>
    <span class="n">gnu_mirror_path</span> <span class="o">=</span> <span class="s2">&quot;autoconf/autoconf-2.69.tar.gz&quot;</span>

    <span class="n">license</span><span class="p">(</span><span class="s2">&quot;GPL-3.0-or-later WITH Autoconf-exception-3.0&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2.62:&quot;</span><span class="p">,</span> <span class="n">checked_by</span><span class="o">=</span><span class="s2">&quot;tgamblin&quot;</span><span class="p">)</span>
    <span class="n">license</span><span class="p">(</span><span class="s2">&quot;GPL-2.0-or-later WITH Autoconf-exception-2.0&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:2.59&quot;</span><span class="p">,</span> <span class="n">checked_by</span><span class="o">=</span><span class="s2">&quot;tgamblin&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="skipping-the-expand-step">
<h3>Skipping the expand step<a class="headerlink" href="#skipping-the-expand-step" title="Link to this heading"></a></h3>
<p>Spack normally expands archives (e.g. <code class="docutils literal notranslate"><span class="pre">*.tar.gz</span></code> and <code class="docutils literal notranslate"><span class="pre">*.zip</span></code>) automatically
into a standard stage source directory (<code class="docutils literal notranslate"><span class="pre">self.stage.source_path</span></code>) after
downloading them. If you want to skip this step (e.g., for self-extracting
executables and other custom archive types), you can add <code class="docutils literal notranslate"><span class="pre">expand=False</span></code> to a
<code class="docutils literal notranslate"><span class="pre">version</span></code> directive.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;8.2.1&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;4136d7b4c04df68b686570afa26988ac&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://example.com/foo-8.2.1-special-version.sh&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">expand</span></code> is set to <code class="docutils literal notranslate"><span class="pre">False</span></code>, Spack sets the current working
directory to the directory containing the downloaded archive before it
calls your <code class="docutils literal notranslate"><span class="pre">install</span></code> method.  Within <code class="docutils literal notranslate"><span class="pre">install</span></code>, the path to the
downloaded archive is available as <code class="docutils literal notranslate"><span class="pre">self.stage.archive_file</span></code>.</p>
<p>Here is an example snippet for packages distributed as self-extracting
archives.  The example sets permissions on the downloaded file to make
it executable, then runs it with some arguments.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">set_executable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">archive_file</span><span class="p">)</span>
    <span class="n">installer</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">archive_file</span><span class="p">)</span>
    <span class="n">installer</span><span class="p">(</span><span class="s2">&quot;--prefix=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;arg1&quot;</span><span class="p">,</span> <span class="s2">&quot;arg2&quot;</span><span class="p">,</span> <span class="s2">&quot;etc.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="deprecating-old-versions">
<span id="deprecate"></span><h3>Deprecating old versions<a class="headerlink" href="#deprecating-old-versions" title="Link to this heading"></a></h3>
<p>There are many reasons to remove old versions of software:</p>
<ol class="arabic simple">
<li><p>Security vulnerabilities (most serious reason)</p></li>
<li><p>Changing build systems that increase package complexity</p></li>
<li><p>Changing dependencies/patches/resources/flags that increase package complexity</p></li>
<li><p>Maintainer/developer inability/unwillingness to support old versions</p></li>
<li><p>No longer available for download (right to be forgotten)</p></li>
<li><p>Package or version rename</p></li>
</ol>
<p>At the same time, there are many reasons to keep old versions of software:</p>
<ol class="arabic simple">
<li><p>Reproducibility</p></li>
<li><p>Requirements for older packages (e.g. some packages still rely on Qt 3)</p></li>
</ol>
<p>In general, you should not remove old versions from a <code class="docutils literal notranslate"><span class="pre">package.py</span></code>. Instead,
you should first deprecate them using the following syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.2.3&quot;</span><span class="p">,</span> <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This has two effects. First, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">info</span></code> will no longer advertise that
version. Second, commands like <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> that fetch the package will
require user approval:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>openssl@1.0.1e
<span class="go">==&gt; Warning: openssl@1.0.1e is deprecated and may be removed in a future Spack release.</span>
<span class="go">==&gt;   Fetch anyway? [y/N]</span>
</pre></div>
</div>
<p>If you use <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">--deprecated</span></code>, this check can be skipped.</p>
<p>This also applies to package recipes that are renamed or removed. You should
first deprecate all versions before removing a package. If you need to rename
it, you can deprecate the old package and create a new package at the same
time.</p>
<p>Version deprecations should always last at least one Spack minor release cycle
before the version is completely removed. For example, if a version is
deprecated in Spack 0.16.0, it should not be removed until Spack 0.17.0. No
version should be removed without such a deprecation process. This gives users
a chance to complain about the deprecation in case the old version is needed
for some application. If you require a deprecated version of a package, simply
submit a PR to remove <code class="docutils literal notranslate"><span class="pre">deprecated=True</span></code> from the package. However, you may be
asked to help maintain this version of the package if the current maintainers
are unwilling to support this older version.</p>
</section>
<section id="download-caching">
<h3>Download caching<a class="headerlink" href="#download-caching" title="Link to this heading"></a></h3>
<p>Spack maintains a cache (described <a class="reference internal" href="mirrors.html#caching"><span class="std std-ref">here</span></a>) which saves files
retrieved during package installations to avoid re-downloading in the case that
a package is installed with a different specification (but the same version) or
reinstalled on account of a change in the hashing scheme. It may (rarely) be
necessary to avoid caching for a particular version by adding <code class="docutils literal notranslate"><span class="pre">no_cache=True</span></code>
as an option to the <code class="docutils literal notranslate"><span class="pre">version()</span></code> directive. Example situations would be a
“snapshot”-like Version Control System (VCS) tag, a VCS branch such as
<code class="docutils literal notranslate"><span class="pre">v6-16-00-patches</span></code>, or a URL specifying a regularly updated snapshot tarball.</p>
</section>
<section id="version-comparison">
<span id="id4"></span><h3>Version comparison<a class="headerlink" href="#version-comparison" title="Link to this heading"></a></h3>
<p>Spack imposes a generic total ordering on the set of versions,
independently from the package they are associated with.</p>
<p>Most Spack versions are numeric, a tuple of integers; for example,
<code class="docutils literal notranslate"><span class="pre">0.1</span></code>, <code class="docutils literal notranslate"><span class="pre">6.96</span></code> or <code class="docutils literal notranslate"><span class="pre">1.2.3.1</span></code>. In this very basic case, version
comparison is lexicographical on the numeric components:
<code class="docutils literal notranslate"><span class="pre">1.2</span> <span class="pre">&lt;</span> <span class="pre">1.2.1</span> <span class="pre">&lt;</span> <span class="pre">1.2.2</span> <span class="pre">&lt;</span> <span class="pre">1.10</span></code>.</p>
<p>Spack can also supports string components such as <code class="docutils literal notranslate"><span class="pre">1.1.1a</span></code> and
<code class="docutils literal notranslate"><span class="pre">1.y.0</span></code>. String components are considered less than numeric
components, so <code class="docutils literal notranslate"><span class="pre">1.y.0</span> <span class="pre">&lt;</span> <span class="pre">1.0</span></code>. This is for consistency with
<a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=50977">RPM</a>. String
components do not have to be separated by dots or any other delimiter.
So, the contrived version <code class="docutils literal notranslate"><span class="pre">1y0</span></code> is identical to <code class="docutils literal notranslate"><span class="pre">1.y.0</span></code>.</p>
<p>Pre-release suffixes also contain string parts, but they are handled
in a special way. For example <code class="docutils literal notranslate"><span class="pre">1.2.3alpha1</span></code> is parsed as a pre-release
of the version <code class="docutils literal notranslate"><span class="pre">1.2.3</span></code>. This allows Spack to order it before the
actual release: <code class="docutils literal notranslate"><span class="pre">1.2.3alpha1</span> <span class="pre">&lt;</span> <span class="pre">1.2.3</span></code>. Spack supports alpha, beta and
release candidate suffixes: <code class="docutils literal notranslate"><span class="pre">1.2alpha1</span> <span class="pre">&lt;</span> <span class="pre">1.2beta1</span> <span class="pre">&lt;</span> <span class="pre">1.2rc1</span> <span class="pre">&lt;</span> <span class="pre">1.2</span></code>. Any
suffix not recognized as a pre-release is treated as an ordinary
string component, so <code class="docutils literal notranslate"><span class="pre">1.2</span> <span class="pre">&lt;</span> <span class="pre">1.2-mysuffix</span></code>.</p>
<p>Finally, there are a few special string components that are considered
“infinity versions”. They include <code class="docutils literal notranslate"><span class="pre">develop</span></code>, <code class="docutils literal notranslate"><span class="pre">main</span></code>, <code class="docutils literal notranslate"><span class="pre">master</span></code>,
<code class="docutils literal notranslate"><span class="pre">head</span></code>, <code class="docutils literal notranslate"><span class="pre">trunk</span></code>, and <code class="docutils literal notranslate"><span class="pre">stable</span></code>. For example: <code class="docutils literal notranslate"><span class="pre">1.2</span> <span class="pre">&lt;</span> <span class="pre">develop</span></code>.
These are useful for specifying the most recent development version of
a package (often a moving target like a git branch), without assigning
a specific version number. Infinity versions are not automatically used when determining the latest version of a package unless explicitly required by another package or user.</p>
<p>More formally, the order on versions is defined as follows. A version
string is split into a list of components based on delimiters such as
<code class="docutils literal notranslate"><span class="pre">.</span></code> and <code class="docutils literal notranslate"><span class="pre">-</span></code> and string boundaries. The components are split into
the <strong>release</strong> and a possible <strong>pre-release</strong> (if the last component
is numeric and the second to last is a string <code class="docutils literal notranslate"><span class="pre">alpha</span></code>, <code class="docutils literal notranslate"><span class="pre">beta</span></code> or <code class="docutils literal notranslate"><span class="pre">rc</span></code>).
The release components are ordered lexicographically, with comparsion
between different types of components as follows:</p>
<ol class="arabic simple">
<li><p>The following special strings are considered larger than any other
numeric or non-numeric version component, and satisfy the following
order between themselves:
<code class="docutils literal notranslate"><span class="pre">develop</span> <span class="pre">&gt;</span> <span class="pre">main</span> <span class="pre">&gt;</span> <span class="pre">master</span> <span class="pre">&gt;</span> <span class="pre">head</span> <span class="pre">&gt;</span> <span class="pre">trunk</span> <span class="pre">&gt;</span> <span class="pre">stable</span></code>.</p></li>
<li><p>Numbers are ordered numerically, are less than special strings, and
larger than other non-numeric components.</p></li>
<li><p>All other non-numeric components are less than numeric components,
and are ordered alphabetically.</p></li>
</ol>
<p>Finally, if the release components are equal, the pre-release components
are used to break the tie, in the obvious way.</p>
<p>The logic behind this sort order is two-fold:</p>
<ol class="arabic simple">
<li><p>Non-numeric versions are usually used for special cases while
developing or debugging a piece of software.  Keeping most of them
less than numeric versions ensures that Spack chooses numeric
versions by default whenever possible.</p></li>
<li><p>The most-recent development version of a package will usually be
newer than any released numeric versions.  This allows the
<code class="docutils literal notranslate"><span class="pre">&#64;develop</span></code> version to satisfy dependencies like <code class="docutils literal notranslate"><span class="pre">depends_on(abc,</span>
<span class="pre">when=&quot;&#64;x.y.z:&quot;)</span></code></p></li>
</ol>
</section>
<section id="version-selection">
<h3>Version selection<a class="headerlink" href="#version-selection" title="Link to this heading"></a></h3>
<p>When concretizing, many versions might match a user-supplied spec.
For example, the spec <code class="docutils literal notranslate"><span class="pre">python</span></code> matches all available versions of the
package <code class="docutils literal notranslate"><span class="pre">python</span></code>.  Similarly, <code class="docutils literal notranslate"><span class="pre">python&#64;3:</span></code> matches all versions of
Python 3 and above.  Given a set of versions that match a spec, Spack
concretization uses the following priorities to decide which one to
use:</p>
<ol class="arabic simple">
<li><p>If the user provided a list of versions in <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code>, the
first matching version in that list will be used.</p></li>
<li><p>If one or more versions is specified as <code class="docutils literal notranslate"><span class="pre">preferred=True</span></code>, in
either <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code> or <code class="docutils literal notranslate"><span class="pre">package.py</span></code>, the largest matching
version will be used.  (“Latest” is defined by the sort order
above).</p></li>
<li><p>If no preferences in particular are specified in the package or in
<code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code>, then the largest matching non-develop version
will be used.  By avoiding <code class="docutils literal notranslate"><span class="pre">&#64;develop</span></code>, this prevents users from
accidentally installing a <code class="docutils literal notranslate"><span class="pre">&#64;develop</span></code> version.</p></li>
<li><p>If all else fails and <code class="docutils literal notranslate"><span class="pre">&#64;develop</span></code> is the only matching version, it
will be used.</p></li>
</ol>
</section>
<section id="ranges-versus-specific-versions">
<h3>Ranges versus specific versions<a class="headerlink" href="#ranges-versus-specific-versions" title="Link to this heading"></a></h3>
<p>When specifying versions in Spack using the <code class="docutils literal notranslate"><span class="pre">pkg&#64;&lt;specifier&gt;</span></code> syntax,
you can use either ranges or specific versions. It is generally
recommended to use ranges instead of specific versions when packaging
to avoid overly constraining dependencies, patches, and conflicts.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">depends_on(&quot;python&#64;3&quot;)</span></code> denotes a range of versions,
allowing Spack to pick any <code class="docutils literal notranslate"><span class="pre">3.x.y</span></code> version for Python, while
<code class="docutils literal notranslate"><span class="pre">depends_on(&quot;python&#64;=3.10.1&quot;)</span></code> restricts it to a specific version.</p>
<p>Specific <code class="docutils literal notranslate"><span class="pre">&#64;=</span></code> versions should only be used in exceptional cases, such
as when the package has a versioning scheme that omits the zero in the
first patch release: <code class="docutils literal notranslate"><span class="pre">3.1</span></code>, <code class="docutils literal notranslate"><span class="pre">3.1.1</span></code>, <code class="docutils literal notranslate"><span class="pre">3.1.2</span></code>. In this example,
the specifier <code class="docutils literal notranslate"><span class="pre">&#64;=3.1</span></code> is the correct way to select only the <code class="docutils literal notranslate"><span class="pre">3.1</span></code>
version, whereas <code class="docutils literal notranslate"><span class="pre">&#64;3.1</span></code> would match all those versions.</p>
<p>Ranges are preferred even if they would only match a single version
defined in the package. This is because users can define custom versions
in <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code> that typically include a custom suffix. For example,
if the package defines the version <code class="docutils literal notranslate"><span class="pre">1.2.3</span></code>, the specifier <code class="docutils literal notranslate"><span class="pre">&#64;1.2.3</span></code>
will also match a user-defined version <code class="docutils literal notranslate"><span class="pre">1.2.3-custom</span></code>.</p>
</section>
<section id="spack-checksum">
<span id="cmd-spack-checksum"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">checksum</span></code><a class="headerlink" href="#spack-checksum" title="Link to this heading"></a></h3>
<p>If you want to add new versions to a package you’ve already created,
this is automated with the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">checksum</span></code> command.  Here’s an
example for <code class="docutils literal notranslate"><span class="pre">libelf</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>checksum<span class="w"> </span>libelf
<span class="go">==&gt; Found 16 versions of libelf.</span>
<span class="go">  0.8.13    http://www.mr511.de/software/libelf-0.8.13.tar.gz</span>
<span class="go">  0.8.12    http://www.mr511.de/software/libelf-0.8.12.tar.gz</span>
<span class="go">  0.8.11    http://www.mr511.de/software/libelf-0.8.11.tar.gz</span>
<span class="go">  0.8.10    http://www.mr511.de/software/libelf-0.8.10.tar.gz</span>
<span class="go">  0.8.9     http://www.mr511.de/software/libelf-0.8.9.tar.gz</span>
<span class="go">  0.8.8     http://www.mr511.de/software/libelf-0.8.8.tar.gz</span>
<span class="go">  0.8.7     http://www.mr511.de/software/libelf-0.8.7.tar.gz</span>
<span class="go">  0.8.6     http://www.mr511.de/software/libelf-0.8.6.tar.gz</span>
<span class="go">  0.8.5     http://www.mr511.de/software/libelf-0.8.5.tar.gz</span>
<span class="go">  ...</span>
<span class="go">  0.5.2     http://www.mr511.de/software/libelf-0.5.2.tar.gz</span>

<span class="go">How many would you like to checksum? (default is 1, q to abort)</span>
</pre></div>
</div>
<p>This does the same thing that <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">create</span></code> does, but it allows you
to go back and add new versions easily as you need them (e.g., as
they’re released).  It fetches the tarballs you ask for and prints out
a list of <code class="docutils literal notranslate"><span class="pre">version</span></code> commands ready to copy/paste into your package
file:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">==&gt; Checksummed new versions of libelf:</span>
<span class="go">    version(&quot;0.8.13&quot;, md5=&quot;4136d7b4c04df68b686570afa26988ac&quot;)</span>
<span class="go">    version(&quot;0.8.12&quot;, md5=&quot;e21f8273d9f5f6d43a59878dc274fec7&quot;)</span>
<span class="go">    version(&quot;0.8.11&quot;, md5=&quot;e931910b6d100f6caa32239849947fbf&quot;)</span>
<span class="go">    version(&quot;0.8.10&quot;, md5=&quot;9db4d36c283d9790d8fa7df1f4d7b4d9&quot;)</span>
</pre></div>
</div>
<p>By default, Spack will search for new tarball downloads by scraping
the parent directory of the tarball you gave it.  So, if your tarball
is at <code class="docutils literal notranslate"><span class="pre">http://example.com/downloads/foo-1.0.tar.gz</span></code>, Spack will look
in <code class="docutils literal notranslate"><span class="pre">http://example.com/downloads/</span></code> for links to additional versions.
If you need to search another path for download links, you can supply
some extra attributes that control how your package finds new
versions. See the documentation on <a class="reference internal" href="#attribute-list-url"><span class="std std-ref">list_url</span></a> and
<a class="reference internal" href="#attribute-list-depth"><span class="std std-ref">list_depth</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>This command assumes that Spack can extrapolate new URLs from an
existing URL in the package, and that Spack can find similar URLs
on a webpage.  If that’s not possible, e.g. if the package’s
developers don’t name their tarballs consistently, you’ll need to
manually add <code class="docutils literal notranslate"><span class="pre">version</span></code> calls yourself.</p></li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">checksum</span></code> to work, Spack needs to be able to
<code class="docutils literal notranslate"><span class="pre">import</span></code> your package in Python.  That means it can’t have any
syntax errors, or the <code class="docutils literal notranslate"><span class="pre">import</span></code> will fail.  Use this once you’ve
got your package in working order.</p></li>
</ul>
</div>
</section>
</section>
<section id="finding-new-versions">
<h2>Finding new versions<a class="headerlink" href="#finding-new-versions" title="Link to this heading"></a></h2>
<p>You’ve already seen the <code class="docutils literal notranslate"><span class="pre">homepage</span></code> and <code class="docutils literal notranslate"><span class="pre">url</span></code> package attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos">2</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="k">class</span> <span class="nc">Mpich</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos">5</span><span class="w">   </span><span class="sd">&quot;&quot;&quot;MPICH is a high performance and widely portable implementation of</span>
<span class="linenos">6</span><span class="sd">      the Message Passing Interface (MPI) standard.&quot;&quot;&quot;</span>
<span class="linenos">7</span>   <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;http://www.mpich.org&quot;</span>
<span class="linenos">8</span>   <span class="n">url</span>      <span class="o">=</span> <span class="s2">&quot;http://www.mpich.org/static/downloads/3.0.4/mpich-3.0.4.tar.gz&quot;</span>
</pre></div>
</div>
<p>These are class-level attributes used by Spack to show users
information about the package, and to determine where to download its
source code.</p>
<p>Spack uses the tarball URL to extrapolate where to find other tarballs
of the same package (e.g. in <a class="reference internal" href="#cmd-spack-checksum"><span class="std std-ref">spack checksum</span></a>, but
this does not always work.  This section covers ways you can tell
Spack to find tarballs elsewhere.</p>
<section id="list-url">
<span id="attribute-list-url"></span><h3><code class="docutils literal notranslate"><span class="pre">list_url</span></code><a class="headerlink" href="#list-url" title="Link to this heading"></a></h3>
<p>When spack tries to find available versions of packages (e.g. with
<a class="reference internal" href="#cmd-spack-checksum"><span class="std std-ref">spack checksum</span></a>), it spiders the parent directory
of the tarball in the <code class="docutils literal notranslate"><span class="pre">url</span></code> attribute.  For example, for libelf, the
url is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://www.mr511.de/software/libelf-0.8.13.tar.gz&quot;</span>
</pre></div>
</div>
<p>Here, Spack spiders <code class="docutils literal notranslate"><span class="pre">http://www.mr511.de/software/</span></code> to find similar
tarball links and ultimately to make a list of available versions of
<code class="docutils literal notranslate"><span class="pre">libelf</span></code>.</p>
<p>For many packages, the tarball’s parent directory may be unlistable,
or it may not contain any links to source code archives.  In fact,
many times additional package downloads aren’t even available in the
same directory as the download URL.</p>
<p>For these, you can specify a separate <code class="docutils literal notranslate"><span class="pre">list_url</span></code> indicating the page
to search for tarballs.  For example, <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> has the homepage as
the <code class="docutils literal notranslate"><span class="pre">list_url</span></code>, because that is where links to old versions are:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">Libdwarf</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;http://www.prevanders.net/dwarf.html&quot;</span>
<span class="linenos">3</span>    <span class="n">url</span>      <span class="o">=</span> <span class="s2">&quot;http://www.prevanders.net/libdwarf-20130729.tar.gz&quot;</span>
<span class="linenos">4</span>    <span class="n">list_url</span> <span class="o">=</span> <span class="n">homepage</span>
</pre></div>
</div>
</section>
<section id="list-depth">
<span id="attribute-list-depth"></span><h3><code class="docutils literal notranslate"><span class="pre">list_depth</span></code><a class="headerlink" href="#list-depth" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> and many other packages have a listing of available
versions on a single webpage, but not all do.  For example, <code class="docutils literal notranslate"><span class="pre">mpich</span></code>
has a tarball URL that looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://www.mpich.org/static/downloads/3.0.4/mpich-3.0.4.tar.gz&quot;</span>
</pre></div>
</div>
<p>But its downloads are in many different subdirectories of
<code class="docutils literal notranslate"><span class="pre">http://www.mpich.org/static/downloads/</span></code>.  So, we need to add a
<code class="docutils literal notranslate"><span class="pre">list_url</span></code> <em>and</em> a <code class="docutils literal notranslate"><span class="pre">list_depth</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">Mpich</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">homepage</span>   <span class="o">=</span> <span class="s2">&quot;http://www.mpich.org&quot;</span>
<span class="linenos">3</span>    <span class="n">url</span>        <span class="o">=</span> <span class="s2">&quot;http://www.mpich.org/static/downloads/3.0.4/mpich-3.0.4.tar.gz&quot;</span>
<span class="linenos">4</span>    <span class="n">list_url</span>   <span class="o">=</span> <span class="s2">&quot;http://www.mpich.org/static/downloads/&quot;</span>
<span class="linenos">5</span>    <span class="n">list_depth</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>By default, Spack only looks at the top-level page available at
<code class="docutils literal notranslate"><span class="pre">list_url</span></code>.  <code class="docutils literal notranslate"><span class="pre">list_depth</span> <span class="pre">=</span> <span class="pre">1</span></code> tells it to follow up to 1 level of
links from the top-level page.  Note that here, this implies 1
level of subdirectories, as the <code class="docutils literal notranslate"><span class="pre">mpich</span></code> website is structured much
like a filesystem.  But <code class="docutils literal notranslate"><span class="pre">list_depth</span></code> really refers to link depth
when spidering the page.</p>
</section>
</section>
<section id="fetching-from-code-repositories">
<span id="vcs-fetch"></span><h2>Fetching from code repositories<a class="headerlink" href="#fetching-from-code-repositories" title="Link to this heading"></a></h2>
<p>For some packages, source code is provided in a Version Control System
(VCS) repository rather than in a tarball.  Spack can fetch packages
from VCS repositories. Currently, Spack supports fetching with <a class="reference internal" href="#git-fetch">Git</a>, <a class="reference internal" href="#hg-fetch">Mercurial (hg)</a>, <a class="reference internal" href="#svn-fetch">Subversion (svn)</a>, <a class="reference internal" href="#cvs-fetch">CVS (cvs)</a>, and <a class="reference internal" href="#go-fetch">Go</a>.
In all cases, the destination
is the standard stage source path.</p>
<p>To fetch a package from a source repository, Spack needs to know which
VCS to use and where to download from. Much like with <code class="docutils literal notranslate"><span class="pre">url</span></code>, package
authors can specify a class-level <code class="docutils literal notranslate"><span class="pre">git</span></code>, <code class="docutils literal notranslate"><span class="pre">hg</span></code>, <code class="docutils literal notranslate"><span class="pre">svn</span></code>, <code class="docutils literal notranslate"><span class="pre">cvs</span></code>, or <code class="docutils literal notranslate"><span class="pre">go</span></code>
attribute containing the correct download location.</p>
<p>Many packages developed with Git have both a Git repository as well as
release tarballs available for download. Packages can define both a
class-level tarball URL and VCS. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Trilinos</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">):</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://trilinos.org/&quot;</span>
    <span class="n">url</span>      <span class="o">=</span> <span class="s2">&quot;https://github.com/trilinos/Trilinos/archive/trilinos-release-12-12-1.tar.gz&quot;</span>
    <span class="n">git</span>      <span class="o">=</span> <span class="s2">&quot;https://github.com/trilinos/Trilinos.git&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;develop&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s2">&quot;develop&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;master&quot;</span><span class="p">,</span>  <span class="n">branch</span><span class="o">=</span><span class="s2">&quot;master&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;12.12.1&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;ecd4606fa332212433c98bf950a69cc7&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;12.10.1&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;667333dbd7c0f031d47d7c5511fd0810&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;12.8.1&quot;</span><span class="p">,</span>  <span class="s2">&quot;9f37f683ee2b427b5540db8a20ed6b15&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If a package contains both a <code class="docutils literal notranslate"><span class="pre">url</span></code> and <code class="docutils literal notranslate"><span class="pre">git</span></code> class-level attribute,
Spack decides which to use based on the arguments to the <code class="docutils literal notranslate"><span class="pre">version()</span></code>
directive. Versions containing a specific branch, tag, or revision are
assumed to be for VCS download methods, while versions containing a
checksum are assumed to be for URL download methods.</p>
<p>Like <code class="docutils literal notranslate"><span class="pre">url</span></code>, if a specific version downloads from a different repository
than the default repo, it can be overridden with a version-specific argument.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order to reduce ambiguity, each package can only have a single VCS
top-level attribute in addition to <code class="docutils literal notranslate"><span class="pre">url</span></code>. In the rare case that a
package uses multiple VCS, a fetch strategy can be specified for each
version. For example, the <code class="docutils literal notranslate"><span class="pre">rockstar</span></code> package contains:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Rockstar</span><span class="p">(</span><span class="n">MakefilePackage</span><span class="p">):</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://bitbucket.org/gfcstanford/rockstar&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;develop&quot;</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="s2">&quot;https://bitbucket.org/gfcstanford/rockstar.git&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;yt&quot;</span><span class="p">,</span> <span class="n">hg</span><span class="o">=</span><span class="s2">&quot;https://bitbucket.org/MatthewTurk/rockstar&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="git">
<span id="git-fetch"></span><h3>Git<a class="headerlink" href="#git" title="Link to this heading"></a></h3>
<p>Git fetching supports the following parameters to <code class="docutils literal notranslate"><span class="pre">version</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">git</span></code>: URL of the git repository, if different than the class-level <code class="docutils literal notranslate"><span class="pre">git</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">branch</span></code>: Name of a branch to fetch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tag</span></code>: Name of a tag to fetch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">commit</span></code>: SHA hash (or prefix) of a commit to fetch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">submodules</span></code>: Also fetch submodules recursively when checking out this repository.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">submodules_delete</span></code>: A list of submodules to forcibly delete from the repository
after fetching. Useful if a version in the repository has submodules that
have disappeared/are no longer accessible.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_full_repo</span></code>: Ensure the full git history is checked out with all remote
branch information. Normally (<code class="docutils literal notranslate"><span class="pre">get_full_repo=False</span></code>, the default), the git
option <code class="docutils literal notranslate"><span class="pre">--depth</span> <span class="pre">1</span></code> will be used if the version of git and the specified
transport protocol support it, and <code class="docutils literal notranslate"><span class="pre">--single-branch</span></code> will be used if the
version of git supports it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git_sparse_paths</span></code>: Use <code class="docutils literal notranslate"><span class="pre">sparse-checkout</span></code> to only clone these relative paths.
This feature requires <code class="docutils literal notranslate"><span class="pre">git</span></code> to be version <code class="docutils literal notranslate"><span class="pre">2.25.0</span></code> or later but is useful for
large repositories that have separate portions that can be built independently.
If paths provided are directories then all the subdirectories and associated files
will also be cloned.</p></li>
</ul>
<p>Only one of <code class="docutils literal notranslate"><span class="pre">tag</span></code>, <code class="docutils literal notranslate"><span class="pre">branch</span></code>, or <code class="docutils literal notranslate"><span class="pre">commit</span></code> can be used at a time.</p>
<p>The destination directory for the clone is the standard stage source path.</p>
<dl>
<dt>Default branch</dt><dd><p>To fetch a repository’s default branch:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>

    <span class="n">git</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/example-project/example.git&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;develop&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This download method is untrusted, and is not recommended. Aside from HTTPS,
there is no way to verify that the repository has not been compromised, and
the commit you get when you install the package likely won’t be the same
commit that was used when the package was first written. Additionally, the
default branch may change. It is best to at least specify a branch name.</p>
</dd>
<dt>Branches</dt><dd><p>To fetch a particular branch, use the <code class="docutils literal notranslate"><span class="pre">branch</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;experimental&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This download method is untrusted, and is not recommended. Branches are
moving targets, so the commit you get when you install the package likely
won’t be the same commit that was used when the package was first written.</p>
</dd>
<dt>Tags</dt><dd><p>To fetch from a particular tag, use <code class="docutils literal notranslate"><span class="pre">tag</span></code> instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.0.1&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;v1.0.1&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This download method is untrusted, and is not recommended. Although tags
are generally more stable than branches, Git allows tags to be moved.
Many developers use tags to denote rolling releases, and may move the
tag when a bug is patched.</p>
</dd>
<dt>Commits</dt><dd><p>Finally, to fetch a particular commit, use <code class="docutils literal notranslate"><span class="pre">commit</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;2014-10-08&quot;</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="s2">&quot;9d38cd4e2c94c3cea97d0e2924814acc&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This doesn’t have to be a full hash; you can abbreviate it as you’d
expect with git:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;2014-10-08&quot;</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="s2">&quot;9d38cd&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This download method <em>is trusted</em>.  It is the recommended way to
securely download from a Git repository.</p>
<p>It may be useful to provide a saner version for commits like this,
e.g. you might use the date as the version, as done above. Or, if you
know the commit at which a release was cut, you can use the release
version. It’s up to the package author to decide what makes the most
sense. Although you can use the commit hash as the version number,
this is not recommended, as it won’t sort properly.</p>
</dd>
<dt>Submodules</dt><dd><p>You can supply <code class="docutils literal notranslate"><span class="pre">submodules=True</span></code> to cause Spack to fetch submodules
recursively along with the repository at fetch time.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.0.1&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;v1.0.1&quot;</span><span class="p">,</span> <span class="n">submodules</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If a package has needs more fine-grained control over submodules, define
<code class="docutils literal notranslate"><span class="pre">submodules</span></code> to be a callable function that takes the package instance as
its only argument.  The function should return a list of submodules to be fetched.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">submodules</span><span class="p">(</span><span class="n">package</span><span class="p">):</span>
    <span class="n">submodules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;+variant-1&quot;</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">spec</span><span class="p">:</span>
        <span class="n">submodules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;submodule_for_variant_1&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;+variant-2&quot;</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">spec</span><span class="p">:</span>
        <span class="n">submodules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;submodule_for_variant_2&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">submodules</span>


 <span class="k">class</span> <span class="nc">MyPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
     <span class="n">version</span><span class="p">(</span><span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span> <span class="n">submodules</span><span class="o">=</span><span class="n">submodules</span><span class="p">)</span>
</pre></div>
</div>
<p>For more information about git submodules see the manpage of git: <code class="docutils literal notranslate"><span class="pre">man</span>
<span class="pre">git-submodule</span></code>.</p>
</dd>
<dt>Sparse-Checkout</dt><dd><p>You can supply <code class="docutils literal notranslate"><span class="pre">git_sparse_paths</span></code> at the package or version level to utilize git’s
sparse-checkout feature. This will only clone the paths that are specified in the
<code class="docutils literal notranslate"><span class="pre">git_sparse_paths</span></code> attribute for the package along with the files in the top level directory.
This feature allows you to only clone what you need from a large repository.
Note that this is a newer feature in git and requries git <code class="docutils literal notranslate"><span class="pre">2.25.0</span></code> or greater.
If <code class="docutils literal notranslate"><span class="pre">git_sparse_paths</span></code> is supplied and the git version is too old
then a warning will be issued and that package will use the standard cloning operations instead.
<code class="docutils literal notranslate"><span class="pre">git_sparse_paths</span></code> should be supplied as a list of paths, a callable function for versions,
or a more complex package attribute using the <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> decorator. The return value should be
a list for a callable implementation of <code class="docutils literal notranslate"><span class="pre">git_sparse_paths</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sparse_path_function</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a callable function that can be used in side a version&quot;&quot;&quot;</span>
    <span class="c1"># paths can be directories or functions, all subdirectories and files are included</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;doe&quot;</span><span class="p">,</span> <span class="s2">&quot;rae&quot;</span><span class="p">,</span> <span class="s2">&quot;me/file.cpp&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span>  <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;1.2.0&quot;</span><span class="p">):</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;fae&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">paths</span>

<span class="k">class</span> <span class="nc">MyPackage</span><span class="p">(</span><span class="n">package</span><span class="p">):</span>
    <span class="c1"># can also be a package attribute that will be used if not specified in versions</span>
    <span class="n">git_sparse_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;doe&quot;</span><span class="p">,</span> <span class="s2">&quot;rae&quot;</span><span class="p">]</span>

    <span class="c1"># use the package attribute</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.1.0&quot;</span><span class="p">)</span>
    <span class="c1"># use the function</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.1.5&quot;</span><span class="p">,</span> <span class="n">git_sparse_paths</span><span class="o">=</span><span class="n">sparse_path_func</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.2.0&quot;</span><span class="p">,</span> <span class="n">git_sparse_paths</span><span class="o">=</span><span class="n">sparse_path_func</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.2.5&quot;</span><span class="p">,</span> <span class="n">git_sparse_paths</span><span class="o">=</span><span class="n">sparse_path_func</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.1.5&quot;</span><span class="p">,</span> <span class="n">git_sparse_paths</span><span class="o">=</span><span class="n">sparse_path_func</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="github">
<span id="github-fetch"></span><h3>GitHub<a class="headerlink" href="#github" title="Link to this heading"></a></h3>
<p>If a project is hosted on GitHub, <em>any</em> valid Git branch, tag, or hash
may be downloaded as a tarball.  This is accomplished simply by
constructing an appropriate URL.  Spack can checksum any package
downloaded this way, thereby producing a trusted download.  For
example, the following downloads a particular hash, and then applies a
checksum.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.9.5.1.1&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;d035e4bc704d136db79b43ab371b27d2&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://www.github.com/jswhit/pyproj/tarball/0be612cc9f972e38b50a90c946a9b353e2ab140f&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="mercurial">
<span id="hg-fetch"></span><h3>Mercurial<a class="headerlink" href="#mercurial" title="Link to this heading"></a></h3>
<p>Fetching with Mercurial works much like <a class="reference external" href="git-fetch">Git</a>, but you
use the <code class="docutils literal notranslate"><span class="pre">hg</span></code> parameter.
The destination directory is still the standard stage source path.</p>
<dl>
<dt>Default branch</dt><dd><p>Add the <code class="docutils literal notranslate"><span class="pre">hg</span></code> attribute with no <code class="docutils literal notranslate"><span class="pre">revision</span></code> passed to <code class="docutils literal notranslate"><span class="pre">version</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>

    <span class="n">hg</span> <span class="o">=</span> <span class="s2">&quot;https://bitbucket.org/example-project/example&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;develop&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This download method is untrusted, and is not recommended. As with
Git’s default fetching strategy, there is no way to verify the
integrity of the download.</p>
</dd>
<dt>Revisions</dt><dd><p>To fetch a particular revision, use the <code class="docutils literal notranslate"><span class="pre">revision</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="s2">&quot;v1.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">git</span></code>, which has special parameters for different types of
revisions, you can use <code class="docutils literal notranslate"><span class="pre">revision</span></code> for branches, tags, and commits
when you fetch with Mercurial. Like Git, fetching specific branches
or tags is an untrusted download method, and is not recommended.
The recommended fetch strategy is to specify a particular commit
hash as the revision.</p>
</dd>
</dl>
</section>
<section id="subversion">
<span id="svn-fetch"></span><h3>Subversion<a class="headerlink" href="#subversion" title="Link to this heading"></a></h3>
<p>To fetch with subversion, use the <code class="docutils literal notranslate"><span class="pre">svn</span></code> and <code class="docutils literal notranslate"><span class="pre">revision</span></code> parameters.
The destination directory will be the standard stage source path.</p>
<dl>
<dt>Fetching the head</dt><dd><p>Simply add an <code class="docutils literal notranslate"><span class="pre">svn</span></code> parameter to the package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>

    <span class="n">svn</span> <span class="o">=</span> <span class="s2">&quot;https://outreach.scidac.gov/svn/example/trunk&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;develop&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This download method is untrusted, and is not recommended for the
same reasons as mentioned above.</p>
</dd>
<dt>Fetching a revision</dt><dd><p>To fetch a particular revision, add a <code class="docutils literal notranslate"><span class="pre">revision</span></code> argument to the
version directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;develop&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
<p>This download method is untrusted, and is not recommended.</p>
<p>Unfortunately, Subversion has no commit hashing scheme like Git and
Mercurial do, so there is no way to guarantee that the download you
get is the same as the download used when the package was created.
Use at your own risk.</p>
</dd>
</dl>
<p>Subversion branches are handled as part of the directory structure, so
you can check out a branch or tag by changing the URL. If you want to
package multiple branches, simply add a <code class="docutils literal notranslate"><span class="pre">svn</span></code> argument to each
version directive.</p>
</section>
<section id="cvs">
<span id="cvs-fetch"></span><h3>CVS<a class="headerlink" href="#cvs" title="Link to this heading"></a></h3>
<p>CVS (Concurrent Versions System) is an old centralized version control
system. It is a predecessor of Subversion.</p>
<p>To fetch with CVS, use the <code class="docutils literal notranslate"><span class="pre">cvs</span></code>, branch, and <code class="docutils literal notranslate"><span class="pre">date</span></code> parameters.
The destination directory will be the standard stage source path.</p>
<dl>
<dt>Fetching the head</dt><dd><p>Simply add a <code class="docutils literal notranslate"><span class="pre">cvs</span></code> parameter to the package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>

    <span class="n">cvs</span> <span class="o">=</span> <span class="s2">&quot;:pserver:outreach.scidac.gov/cvsroot%module=modulename&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.1.2.4&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>CVS repository locations are described using an older syntax that
is different from today’s ubiquitous URL syntax. <code class="docutils literal notranslate"><span class="pre">:pserver:</span></code>
denotes the transport method. CVS servers can host multiple
repositories (called “modules”) at the same location, and one needs
to specify both the server location and the module name to access.
Spack combines both into one string using the <code class="docutils literal notranslate"><span class="pre">%module=modulename</span></code>
suffix shown above.</p>
<p>This download method is untrusted.</p>
</dd>
<dt>Fetching a date</dt><dd><p>Versions in CVS are commonly specified by date. To fetch a
particular branch or date, add a <code class="docutils literal notranslate"><span class="pre">branch</span></code> and/or <code class="docutils literal notranslate"><span class="pre">date</span></code> argument
to the version directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;2021.4.22&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s2">&quot;branchname&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s2">&quot;2021-04-22&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Unfortunately, CVS does not identify repository-wide commits via a
revision or hash like Subversion, Git, or Mercurial do. This makes
it impossible to specify an exact commit to check out.</p>
</dd>
</dl>
<p>CVS has more features, but since CVS is rarely used these days, Spack
does not support all of them.</p>
</section>
<section id="go">
<span id="go-fetch"></span><h3>Go<a class="headerlink" href="#go" title="Link to this heading"></a></h3>
<p>Go isn’t a VCS, it is a programming language with a builtin command,
<a class="reference external" href="https://pkg.go.dev/cmd/go#hdr-Add_dependencies_to_current_module_and_install_them">go get</a>,
that fetches packages and their dependencies automatically.
The destination directory will be the standard stage source path.</p>
<p>This strategy can clone a Git repository, or download from another source location.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ThePlatinumSearcher</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/monochromegane/the_platinum_searcher&quot;</span>
    <span class="n">go</span>       <span class="o">=</span> <span class="s2">&quot;github.com/monochromegane/the_platinum_searcher/...&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Go cannot be used to fetch a particular commit or branch, it always
downloads the head of the repository. This download method is untrusted,
and is not recommended. Use another fetch strategy whenever possible.</p>
</section>
<p id="variants">.. _variants:</p>
</section>
<section id="id6">
<h2>Variants<a class="headerlink" href="#id6" title="Link to this heading"></a></h2>
<p>Many software packages can be configured to enable optional
features, which often come at the expense of additional dependencies or
longer build times. To be flexible enough and support a wide variety of
use cases, Spack allows you to expose to the end-user the ability to choose
which features should be activated in a package at the time it is installed.
The mechanism to be employed is the <a class="reference internal" href="spack.html#spack.directives.variant" title="spack.directives.variant"><code class="xref py py-func docutils literal notranslate"><span class="pre">spack.directives.variant()</span></code></a> directive.</p>
<section id="boolean-variants">
<h3>Boolean variants<a class="headerlink" href="#boolean-variants" title="Link to this heading"></a></h3>
<p>In their simplest form variants are boolean options specified at the package
level:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hdf5</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span>
        <span class="s2">&quot;shared&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Builds a shared version of the library&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>with a default value and a description of their meaning / use in the package.
<em>Variants can be tested in any context where a spec constraint is expected.</em>
In the example above the <code class="docutils literal notranslate"><span class="pre">shared</span></code> variant is tied to the build of shared dynamic
libraries. To pass the right option at configure time we can branch depending on
its value:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">configure_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;+shared&quot;</span><span class="p">):</span>
        <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--enable-shared&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--disable-shared&quot;</span><span class="p">)</span>
        <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--enable-static-exec&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>As explained in <a class="reference internal" href="basic_usage.html#basic-variants"><span class="std std-ref">Variants</span></a> the constraint <code class="docutils literal notranslate"><span class="pre">+shared</span></code> means
that the boolean variant is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, while <code class="docutils literal notranslate"><span class="pre">~shared</span></code> means it is set
to <code class="docutils literal notranslate"><span class="pre">False</span></code>.
Another common example is the optional activation of an extra dependency
which requires to use the variant in the <code class="docutils literal notranslate"><span class="pre">when</span></code> argument of
<a class="reference internal" href="spack.html#spack.directives.depends_on" title="spack.directives.depends_on"><code class="xref py py-func docutils literal notranslate"><span class="pre">spack.directives.depends_on()</span></code></a>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hdf5</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;szip&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable szip support&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;szip&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+szip&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>as shown in the snippet above where <code class="docutils literal notranslate"><span class="pre">szip</span></code> is modeled to be an optional
dependency of <code class="docutils literal notranslate"><span class="pre">hdf5</span></code>.</p>
</section>
<section id="multi-valued-variants">
<h3>Multi-valued variants<a class="headerlink" href="#multi-valued-variants" title="Link to this heading"></a></h3>
<p>If need be, Spack can go beyond Boolean variants and permit an arbitrary
number of allowed values. This might be useful when modeling
options that are tightly related to each other.
The values in this case are passed to the <a class="reference internal" href="spack.html#spack.directives.variant" title="spack.directives.variant"><code class="xref py py-func docutils literal notranslate"><span class="pre">spack.directives.variant()</span></code></a>
directive as a tuple:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Blis</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span>
        <span class="s2">&quot;threads&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Multithreading support&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pthreads&quot;</span><span class="p">,</span> <span class="s2">&quot;openmp&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">),</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>In the example above the argument <code class="docutils literal notranslate"><span class="pre">multi</span></code> is set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to indicate
that only one among all the variant values can be active at any time. This
constraint is enforced by the parser and an error is emitted if a user
specifies two or more values at the same time:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>spec<span class="w"> </span>blis<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>openmp,pthreads
<span class="go">Input spec</span>
<span class="go">--------------------------------</span>
<span class="go">blis threads=openmp,pthreads</span>

<span class="go">Concretized</span>
<span class="go">--------------------------------</span>
<span class="go">==&gt; Error: multiple values are not allowed for variant &quot;threads&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Another useful note is that <em>Python’s</em> <code class="docutils literal notranslate"><span class="pre">None</span></code> <em>is not allowed as a default value</em>
and therefore it should not be used to denote that no feature was selected.
Users should instead select another value, like <code class="docutils literal notranslate"><span class="pre">&quot;none&quot;</span></code>, and handle it explicitly
within the package recipe if need be:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variants</span><span class="p">[</span><span class="s2">&quot;threads&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
   <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--no-threads&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>In cases where multiple values can be selected at the same time <code class="docutils literal notranslate"><span class="pre">multi</span></code> should
be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Gcc</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span>
        <span class="s2">&quot;languages&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;c,c++,fortran&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ada&quot;</span><span class="p">,</span> <span class="s2">&quot;brig&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;c++&quot;</span><span class="p">,</span> <span class="s2">&quot;fortran&quot;</span><span class="p">,</span>
                <span class="s2">&quot;go&quot;</span><span class="p">,</span> <span class="s2">&quot;java&quot;</span><span class="p">,</span> <span class="s2">&quot;jit&quot;</span><span class="p">,</span> <span class="s2">&quot;lto&quot;</span><span class="p">,</span> <span class="s2">&quot;objc&quot;</span><span class="p">,</span> <span class="s2">&quot;obj-c++&quot;</span><span class="p">),</span>
        <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Compilers and runtime libraries to build&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Within a package recipe a multi-valued variant is tested using a <code class="docutils literal notranslate"><span class="pre">key=value</span></code> syntax:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;languages=jit&quot;</span><span class="p">):</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--enable-host-shared&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<section id="complex-validation-logic-for-variant-values">
<h4>Complex validation logic for variant values<a class="headerlink" href="#complex-validation-logic-for-variant-values" title="Link to this heading"></a></h4>
<p>To cover complex use cases, the <a class="reference internal" href="spack.html#spack.directives.variant" title="spack.directives.variant"><code class="xref py py-func docutils literal notranslate"><span class="pre">spack.directives.variant()</span></code></a> directive
could accept as the <code class="docutils literal notranslate"><span class="pre">values</span></code> argument a full-fledged object which has
<code class="docutils literal notranslate"><span class="pre">default</span></code> and other arguments of the directive embedded as attributes.</p>
<p>An example, already implemented in Spack’s core, is <a class="reference internal" href="spack.html#spack.variant.DisjointSetsOfValues" title="spack.variant.DisjointSetsOfValues"><code class="xref py py-class docutils literal notranslate"><span class="pre">spack.variant.DisjointSetsOfValues</span></code></a>.
This class is used to implement a few convenience functions, like
<a class="reference internal" href="spack.html#spack.variant.any_combination_of" title="spack.variant.any_combination_of"><code class="xref py py-func docutils literal notranslate"><span class="pre">spack.variant.any_combination_of()</span></code></a>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Adios</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span>
        <span class="s2">&quot;staging&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="n">any_combination_of</span><span class="p">(</span><span class="s2">&quot;flexpath&quot;</span><span class="p">,</span> <span class="s2">&quot;dataspaces&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable dataspaces and/or flexpath staging transports&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>that allows any combination of the specified values, and also allows the
user to specify <code class="docutils literal notranslate"><span class="pre">&quot;none&quot;</span></code> (as a string) to choose none of them.
The objects returned by these functions can be modified at will by chaining
method calls to change the default value, customize the error message or
other similar operations:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mvapich2</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span>
        <span class="s2">&quot;process_managers&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;List of the process managers to activate&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="n">disjoint_sets</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;slurm&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;hydra&quot;</span><span class="p">,</span> <span class="s2">&quot;gforker&quot;</span><span class="p">,</span> <span class="s2">&quot;remshell&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">prohibit_empty_set</span><span class="p">()</span><span class="o">.</span><span class="n">with_error</span><span class="p">(</span>
            <span class="s2">&quot;&#39;slurm&#39; or &#39;auto&#39; cannot be activated along with &quot;</span>
            <span class="s2">&quot;other process managers&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_non_feature_values</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="conditional-possible-values">
<h4>Conditional Possible Values<a class="headerlink" href="#conditional-possible-values" title="Link to this heading"></a></h4>
<p>There are cases where a variant may take multiple values, and the list of allowed values
expand over time. Think for instance at the C++ standard with which we might compile
Boost, which can take one of multiple possible values with the latest standards
only available from a certain version on.</p>
<p>To model a similar situation we can use <em>conditional possible values</em> in the variant declaration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variant</span><span class="p">(</span>
    <span class="s2">&quot;cxxstd&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;98&quot;</span><span class="p">,</span>
    <span class="n">values</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;98&quot;</span><span class="p">,</span> <span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;14&quot;</span><span class="p">,</span>
        <span class="c1"># C++17 is not supported by Boost &lt; 1.63.0.</span>
        <span class="n">conditional</span><span class="p">(</span><span class="s2">&quot;17&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.63.0:&quot;</span><span class="p">),</span>
        <span class="c1"># C++20/2a is not support by Boost &lt; 1.73.0</span>
        <span class="n">conditional</span><span class="p">(</span><span class="s2">&quot;2a&quot;</span><span class="p">,</span> <span class="s2">&quot;2b&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.73.0:&quot;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Use the specified C++ standard when building.&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The snippet above allows <code class="docutils literal notranslate"><span class="pre">98</span></code>, <code class="docutils literal notranslate"><span class="pre">11</span></code> and <code class="docutils literal notranslate"><span class="pre">14</span></code> as unconditional possible values for the
<code class="docutils literal notranslate"><span class="pre">cxxstd</span></code> variant, while <code class="docutils literal notranslate"><span class="pre">17</span></code> requires a version greater or equal to <code class="docutils literal notranslate"><span class="pre">1.63.0</span></code>
and both <code class="docutils literal notranslate"><span class="pre">2a</span></code> and <code class="docutils literal notranslate"><span class="pre">2b</span></code> require a version greater or equal to <code class="docutils literal notranslate"><span class="pre">1.73.0</span></code>.</p>
</section>
</section>
<section id="conditional-variants">
<h3>Conditional Variants<a class="headerlink" href="#conditional-variants" title="Link to this heading"></a></h3>
<p>The variant directive accepts a <code class="docutils literal notranslate"><span class="pre">when</span></code> clause. The variant will only
be present on specs that otherwise satisfy the spec listed as the
<code class="docutils literal notranslate"><span class="pre">when</span></code> clause. For example, the following class has a variant
<code class="docutils literal notranslate"><span class="pre">bar</span></code> when it is at version 2.0 or higher.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2.0:&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;help message&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">when</span></code> clause follows the same syntax and accepts the same
values as the <code class="docutils literal notranslate"><span class="pre">when</span></code> argument of
<a class="reference internal" href="spack.html#spack.directives.depends_on" title="spack.directives.depends_on"><code class="xref py py-func docutils literal notranslate"><span class="pre">spack.directives.depends_on()</span></code></a></p>
</section>
<section id="sticky-variants">
<h3>Sticky Variants<a class="headerlink" href="#sticky-variants" title="Link to this heading"></a></h3>
<p>The variant directive can be marked as <code class="docutils literal notranslate"><span class="pre">sticky</span></code> by setting to <code class="docutils literal notranslate"><span class="pre">True</span></code> the
corresponding argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variant</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">sticky</span></code> variant differs from a regular one in that it is always set
to either:</p>
<ol class="arabic simple">
<li><p>An explicit value appearing in a spec literal or</p></li>
<li><p>Its default value</p></li>
</ol>
<p>The concretizer thus is not free to pick an alternate value to work
around conflicts, but will error out instead.
Setting this property on a variant is useful in cases where the
variant allows some dangerous or controversial options (e.g. using unsupported versions
of a compiler for a library) and the packager wants to ensure that
allowing these options is done on purpose by the user, rather than
automatically by the solver.</p>
</section>
<section id="overriding-variants">
<h3>Overriding Variants<a class="headerlink" href="#overriding-variants" title="Link to this heading"></a></h3>
<p>Packages may override variants for several reasons, most often to
change the default from a variant defined in a parent class or to
change the conditions under which a variant is present on the spec.</p>
<p>When a variant is defined multiple times, whether in the same package
file or in a subclass and a superclass, the last definition is used
for all attributes <strong>except</strong> for the <code class="docutils literal notranslate"><span class="pre">when</span></code> clauses. The <code class="docutils literal notranslate"><span class="pre">when</span></code>
clauses are accumulated through all invocations, and the variant is
present on the spec if any of the accumulated conditions are
satisfied.</p>
<p>For example, consider the following package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.0&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;help1&quot;</span><span class="p">)</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;platform=darwin&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;help2&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This package <code class="docutils literal notranslate"><span class="pre">foo</span></code> has a variant <code class="docutils literal notranslate"><span class="pre">bar</span></code> when the spec satisfies
either <code class="docutils literal notranslate"><span class="pre">&#64;1.0</span></code> or <code class="docutils literal notranslate"><span class="pre">platform=darwin</span></code>, but not for other platforms at
other versions. The default for this variant, when it is present, is
always <code class="docutils literal notranslate"><span class="pre">True</span></code>, regardless of which condition of the variant is
satisfied. This allows packages to override variants in packages or
build system classes from which they inherit, by modifying the variant
values without modifying the <code class="docutils literal notranslate"><span class="pre">when</span></code> clause. It also allows a package
to implement <code class="docutils literal notranslate"><span class="pre">or</span></code> semantics for a variant <code class="docutils literal notranslate"><span class="pre">when</span></code> clause by
duplicating the variant definition.</p>
</section>
</section>
<section id="resources-expanding-extra-tarballs">
<h2>Resources (expanding extra tarballs)<a class="headerlink" href="#resources-expanding-extra-tarballs" title="Link to this heading"></a></h2>
<p>Some packages (most notably compilers) provide optional features if additional
resources are expanded within their source tree before building. In Spack it is
possible to describe such a need with the <code class="docutils literal notranslate"><span class="pre">resource</span></code> directive :</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">resource</span><span class="p">(</span>
   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cargo&quot;</span><span class="p">,</span>
   <span class="n">git</span><span class="o">=</span><span class="s2">&quot;https://github.com/rust-lang/cargo.git&quot;</span><span class="p">,</span>
   <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;0.10.0&quot;</span><span class="p">,</span>
   <span class="n">destination</span><span class="o">=</span><span class="s2">&quot;cargo&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Based on the keywords present among the arguments the appropriate <code class="docutils literal notranslate"><span class="pre">FetchStrategy</span></code>
will be used for the resource. The keyword <code class="docutils literal notranslate"><span class="pre">destination</span></code> is relative to the source
root of the package and should point to where the resource is to be expanded.</p>
</section>
<section id="licensed-software">
<span id="license"></span><h2>Licensed software<a class="headerlink" href="#licensed-software" title="Link to this heading"></a></h2>
<p>In order to install licensed software, Spack needs to know a few more
details about a package. The following class attributes should be defined.</p>
<section id="license-required">
<h3><code class="docutils literal notranslate"><span class="pre">license_required</span></code><a class="headerlink" href="#license-required" title="Link to this heading"></a></h3>
<p>Boolean. If set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, this software requires a license. If set to
<code class="docutils literal notranslate"><span class="pre">False</span></code>, all of the following attributes will be ignored. Defaults to
<code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</section>
<section id="license-comment">
<h3><code class="docutils literal notranslate"><span class="pre">license_comment</span></code><a class="headerlink" href="#license-comment" title="Link to this heading"></a></h3>
<p>String. Contains the symbol used by the license manager to denote a comment.
Defaults to <code class="docutils literal notranslate"><span class="pre">#</span></code>.</p>
</section>
<section id="license-files">
<h3><code class="docutils literal notranslate"><span class="pre">license_files</span></code><a class="headerlink" href="#license-files" title="Link to this heading"></a></h3>
<p>List of strings. These are files that the software searches for when
looking for a license. All file paths must be relative to the installation
directory. More complex packages like Intel may require multiple
licenses for individual components. Defaults to the empty list.</p>
</section>
<section id="license-vars">
<h3><code class="docutils literal notranslate"><span class="pre">license_vars</span></code><a class="headerlink" href="#license-vars" title="Link to this heading"></a></h3>
<p>List of strings. Environment variables that can be set to tell the software
where to look for a license if it is not in the usual location. Defaults
to the empty list.</p>
</section>
<section id="license-url">
<h3><code class="docutils literal notranslate"><span class="pre">license_url</span></code><a class="headerlink" href="#license-url" title="Link to this heading"></a></h3>
<p>String. A URL pointing to license setup instructions for the software.
Defaults to the empty string.</p>
<p>For example, let’s take a look at the package for the PGI compilers.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Licensing</span>
<span class="n">license_required</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">license_comment</span>  <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
<span class="n">license_files</span>    <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;license.dat&quot;</span><span class="p">]</span>
<span class="n">license_vars</span>     <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PGROUPD_LICENSE_FILE&quot;</span><span class="p">,</span> <span class="s2">&quot;LM_LICENSE_FILE&quot;</span><span class="p">]</span>
<span class="n">license_url</span>      <span class="o">=</span> <span class="s2">&quot;http://www.pgroup.com/doc/pgiinstall.pdf&quot;</span>
</pre></div>
</div>
<p>As you can see, PGI requires a license. Its license manager, FlexNet, uses
the <code class="docutils literal notranslate"><span class="pre">#</span></code> symbol to denote a comment. It expects the license file to be
named <code class="docutils literal notranslate"><span class="pre">license.dat</span></code> and to be located directly in the installation prefix.
If you would like the installation file to be located elsewhere, simply set
<code class="docutils literal notranslate"><span class="pre">PGROUPD_LICENSE_FILE</span></code> or <code class="docutils literal notranslate"><span class="pre">LM_LICENSE_FILE</span></code> after installation. For
further instructions on installation and licensing, see the URL provided.</p>
<p>Let’s walk through a sample PGI installation to see exactly what Spack is
and isn’t capable of. Since PGI does not provide a download URL, it must
be downloaded manually. It can either be added to a mirror or located in
the current directory when <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">pgi</span></code> is run. See <a class="reference internal" href="mirrors.html#mirrors"><span class="std std-ref">Mirrors (mirrors.yaml)</span></a>
for instructions on setting up a mirror.</p>
<p>After running <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">pgi</span></code>, the first thing that will happen is
Spack will create a global license file located at
<code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/etc/spack/licenses/pgi/license.dat</span></code>. It will then open up the
file using <a class="reference internal" href="#controlling-the-editor"><span class="std std-ref">your favorite editor</span></a>. It will look like
this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># A license is required to use pgi.</span>
<span class="c1">#</span>
<span class="c1"># The recommended solution is to store your license key in this global</span>
<span class="c1"># license file. After installation, the following symlink(s) will be</span>
<span class="c1"># added to point to this file (relative to the installation prefix):</span>
<span class="c1">#</span>
<span class="c1">#   license.dat</span>
<span class="c1">#</span>
<span class="c1"># Alternatively, use one of the following environment variable(s):</span>
<span class="c1">#</span>
<span class="c1">#   PGROUPD_LICENSE_FILE</span>
<span class="c1">#   LM_LICENSE_FILE</span>
<span class="c1">#</span>
<span class="c1"># If you choose to store your license in a non-standard location, you may</span>
<span class="c1"># set one of these variable(s) to the full pathname to the license file, or</span>
<span class="c1"># port@host if you store your license keys on a dedicated license server.</span>
<span class="c1"># You will likely want to set this variable in a module file so that it</span>
<span class="c1"># gets loaded every time someone tries to use pgi.</span>
<span class="c1">#</span>
<span class="c1"># For further information on how to acquire a license, please refer to:</span>
<span class="c1">#</span>
<span class="c1">#   http://www.pgroup.com/doc/pgiinstall.pdf</span>
<span class="c1">#</span>
<span class="c1"># You may enter your license below.</span>
</pre></div>
</div>
<p>You can add your license directly to this file, or tell FlexNet to use a
license stored on a separate license server. Here is an example that
points to a license server called licman1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SERVER licman1.mcs.anl.gov 00163eb7fba5 27200
USE_SERVER
</pre></div>
</div>
<p>If your package requires the license to install, you can reference the
location of this global license using <code class="docutils literal notranslate"><span class="pre">self.global_license_file</span></code>.
After installation, symlinks for all of the files given in
<code class="docutils literal notranslate"><span class="pre">license_files</span></code> will be created, pointing to this global license.
If you install a different version or variant of the package, Spack
will automatically detect and reuse the already existing global license.</p>
<p>If the software you are trying to package doesn’t rely on license files,
Spack will print a warning message, letting the user know that they
need to set an environment variable or pointing them to installation
documentation.</p>
</section>
</section>
<section id="patches">
<span id="patching"></span><h2>Patches<a class="headerlink" href="#patches" title="Link to this heading"></a></h2>
<p>Depending on the host architecture, package version, known bugs, or
other issues, you may need to patch your software to get it to build
correctly.  Like many other package systems, spack allows you to store
patches alongside your package files and apply them to source code
after it’s downloaded.</p>
<section id="patch">
<h3><code class="docutils literal notranslate"><span class="pre">patch</span></code><a class="headerlink" href="#patch" title="Link to this heading"></a></h3>
<p>You can specify patches in your package file with the <code class="docutils literal notranslate"><span class="pre">patch()</span></code>
directive.  <code class="docutils literal notranslate"><span class="pre">patch</span></code> looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mvapich2</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;ad_lustre_rwcontig_open_source.patch&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.9:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument can be either a URL or a filename.  It specifies a
patch file that should be applied to your source.  If the patch you
supply is a filename, then the patch needs to live within the spack
source tree.  For example, the patch above lives in a directory
structure like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$SPACK_ROOT/var/spack/repos/builtin/packages/
    mvapich2/
        package.py
        ad_lustre_rwcontig_open_source.patch
</pre></div>
</div>
<p>If you supply a URL instead of a filename, you need to supply a
<code class="docutils literal notranslate"><span class="pre">sha256</span></code> checksum, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;http://www.nwchem-sw.org/images/Tddft_mxvec20.patch&quot;</span><span class="p">,</span>
      <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;252c0af58be3d90e5dc5e0d16658434c9efa5d20a5df6c10bf72c2d77f780866&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Spack includes the hashes of patches in its versioning information, so
that the same package with different patches applied will have different
hash identifiers.  To ensure that the hashing scheme is consistent, you
must use a <code class="docutils literal notranslate"><span class="pre">sha256</span></code> checksum for the patch.  Patches will be fetched
from their URLs, checked, and applied to your source code.  You can use
the GNU utils <code class="docutils literal notranslate"><span class="pre">sha256sum</span></code> or the macOS <code class="docutils literal notranslate"><span class="pre">shasum</span> <span class="pre">-a</span> <span class="pre">256</span></code> commands to
generate a checksum for a patch file.</p>
<p>Spack can also handle compressed patches.  If you use these, Spack needs
a little more help.  Specifically, it needs <em>two</em> checksums: the
<code class="docutils literal notranslate"><span class="pre">sha256</span></code> of the patch and <code class="docutils literal notranslate"><span class="pre">archive_sha256</span></code> for the compressed
archive.  <code class="docutils literal notranslate"><span class="pre">archive_sha256</span></code> helps Spack ensure that the downloaded
file is not corrupted or malicious, before running it through a tool like
<code class="docutils literal notranslate"><span class="pre">tar</span></code> or <code class="docutils literal notranslate"><span class="pre">zip</span></code>.  The <code class="docutils literal notranslate"><span class="pre">sha256</span></code> of the patch is still required so
that it can be included in specs.  Providing it in the package file
ensures that Spack won’t have to download and decompress patches it won’t
end up using at install time.  Both the archive and patch checksum are
checked when patch archives are downloaded.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;http://www.nwchem-sw.org/images/Tddft_mxvec20.patch.gz&quot;</span><span class="p">,</span>
      <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;252c0af58be3d90e5dc5e0d16658434c9efa5d20a5df6c10bf72c2d77f780866&quot;</span><span class="p">,</span>
      <span class="n">archive_sha256</span><span class="o">=</span><span class="s2">&quot;4e8092a161ec6c3a1b5253176fcf33ce7ba23ee2ff27c75dbced589dabacd06e&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">patch</span></code> keyword arguments are described below.</p>
<section id="sha256-archive-sha256">
<h4><code class="docutils literal notranslate"><span class="pre">sha256</span></code>, <code class="docutils literal notranslate"><span class="pre">archive_sha256</span></code><a class="headerlink" href="#sha256-archive-sha256" title="Link to this heading"></a></h4>
<p>Hashes of downloaded patch and compressed archive, respectively.  Only
needed for patches fetched from URLs.</p>
</section>
<section id="when">
<h4><code class="docutils literal notranslate"><span class="pre">when</span></code><a class="headerlink" href="#when" title="Link to this heading"></a></h4>
<p>If supplied, this is a spec that tells spack when to apply
the patch.  If the installed package spec matches this spec, the
patch will be applied.  In our example above, the patch is applied
when mvapich is at version <code class="docutils literal notranslate"><span class="pre">1.9</span></code> or higher.</p>
</section>
<section id="level">
<h4><code class="docutils literal notranslate"><span class="pre">level</span></code><a class="headerlink" href="#level" title="Link to this heading"></a></h4>
<p>This tells spack how to run the <code class="docutils literal notranslate"><span class="pre">patch</span></code> command.  By default,
the level is 1 and spack runs <code class="docutils literal notranslate"><span class="pre">patch</span> <span class="pre">-p</span> <span class="pre">1</span></code>.  If level is 2,
spack will run <code class="docutils literal notranslate"><span class="pre">patch</span> <span class="pre">-p</span> <span class="pre">2</span></code>, and so on.</p>
<p>A lot of people are confused by level, so here’s a primer.  If you
look in your patch file, you may see something like this:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="gd">--- a/src/mpi/romio/adio/ad_lustre/ad_lustre_rwcontig.c 2013-12-10 12:05:44.806417000 -0800</span>
<span class="linenos"> 2</span><span class="gi">+++ b/src/mpi/romio/adio/ad_lustre/ad_lustre_rwcontig.c 2013-12-10 11:53:03.295622000 -0800</span>
<span class="linenos"> 3</span><span class="gu">@@ -8,7 +8,7 @@</span>
<span class="linenos"> 4</span><span class="w"> </span> *   Copyright (C) 2008 Sun Microsystems, Lustre group
<span class="linenos"> 5</span><span class="w"> </span> \*/
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="gd">-#define _XOPEN_SOURCE 600</span>
<span class="linenos"> 8</span><span class="gi">+//#define _XOPEN_SOURCE 600</span>
<span class="linenos"> 9</span><span class="w"> </span>#include &lt;stdlib.h&gt;
<span class="linenos">10</span><span class="w"> </span>#include &lt;malloc.h&gt;
<span class="linenos">11</span><span class="w"> </span>#include &quot;ad_lustre.h&quot;
</pre></div>
</div>
<p>Lines 1-2 show paths with synthetic <code class="docutils literal notranslate"><span class="pre">a/</span></code> and <code class="docutils literal notranslate"><span class="pre">b/</span></code> prefixes.  These
are placeholders for the two <code class="docutils literal notranslate"><span class="pre">mvapich2</span></code> source directories that
<code class="docutils literal notranslate"><span class="pre">diff</span></code> compared when it created the patch file.  This is git’s
default behavior when creating patch files, but other programs may
behave differently.</p>
<p><code class="docutils literal notranslate"><span class="pre">-p1</span></code> strips off the first level of the prefix in both paths,
allowing the patch to be applied from the root of an expanded mvapich2
archive.  If you set level to <code class="docutils literal notranslate"><span class="pre">2</span></code>, it would strip off <code class="docutils literal notranslate"><span class="pre">src</span></code>, and
so on.</p>
<p>It’s generally easier to just structure your patch file so that it
applies cleanly with <code class="docutils literal notranslate"><span class="pre">-p1</span></code>, but if you’re using a patch you didn’t
create yourself, <code class="docutils literal notranslate"><span class="pre">level</span></code> can be handy.</p>
</section>
<section id="working-dir">
<h4><code class="docutils literal notranslate"><span class="pre">working_dir</span></code><a class="headerlink" href="#working-dir" title="Link to this heading"></a></h4>
<p>This tells spack where to run the <code class="docutils literal notranslate"><span class="pre">patch</span></code> command.  By default,
the working directory is the source path of the stage (<code class="docutils literal notranslate"><span class="pre">.</span></code>).
However, sometimes patches are made with respect to a subdirectory
and this is where the working directory comes in handy. Internally,
the working directory is given to <code class="docutils literal notranslate"><span class="pre">patch</span></code> via the <code class="docutils literal notranslate"><span class="pre">-d</span></code> option.
Let’s take the example patch from above and assume for some reason,
it can only be downloaded in the following form:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="gd">--- a/romio/adio/ad_lustre/ad_lustre_rwcontig.c 2013-12-10 12:05:44.806417000 -0800</span>
<span class="linenos"> 2</span><span class="gi">+++ b/romio/adio/ad_lustre/ad_lustre_rwcontig.c 2013-12-10 11:53:03.295622000 -0800</span>
<span class="linenos"> 3</span><span class="gu">@@ -8,7 +8,7 @@</span>
<span class="linenos"> 4</span><span class="w"> </span> *   Copyright (C) 2008 Sun Microsystems, Lustre group
<span class="linenos"> 5</span><span class="w"> </span> \*/
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="gd">-#define _XOPEN_SOURCE 600</span>
<span class="linenos"> 8</span><span class="gi">+//#define _XOPEN_SOURCE 600</span>
<span class="linenos"> 9</span><span class="w"> </span>#include &lt;stdlib.h&gt;
<span class="linenos">10</span><span class="w"> </span>#include &lt;malloc.h&gt;
<span class="linenos">11</span><span class="w"> </span>#include &quot;ad_lustre.h&quot;
</pre></div>
</div>
<p>Hence, the patch needs to applied in the <code class="docutils literal notranslate"><span class="pre">src/mpi</span></code> subdirectory, and the
<code class="docutils literal notranslate"><span class="pre">working_dir=&quot;src/mpi&quot;</span></code> option would exactly do that.</p>
</section>
</section>
<section id="patch-functions">
<h3>Patch functions<a class="headerlink" href="#patch-functions" title="Link to this heading"></a></h3>
<p>In addition to supplying patch files, you can write a custom function
to patch a package’s source.  For example, the <code class="docutils literal notranslate"><span class="pre">py-pyside</span></code> package
contains some custom code for tweaking the way the PySide build
handles <code class="docutils literal notranslate"><span class="pre">RPATH</span></code>:</p>
<div class="highlight-default notranslate" id="pyside-patch"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 2</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Undo PySide RPATH handling and add Spack RPATH.&quot;&quot;&quot;</span>
<span class="linenos"> 3</span>        <span class="c1"># Figure out the special RPATH</span>
<span class="linenos"> 4</span>        <span class="n">rpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpath</span>
<span class="linenos"> 5</span>        <span class="n">rpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">python_platlib</span><span class="p">,</span> <span class="s2">&quot;PySide&quot;</span><span class="p">))</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>        <span class="c1"># Fix subprocess.mswindows check for Python 3.5</span>
<span class="linenos"> 8</span>        <span class="c1"># https://github.com/pyside/pyside-setup/pull/55</span>
<span class="linenos"> 9</span>        <span class="n">filter_file</span><span class="p">(</span>
<span class="linenos">10</span>            <span class="s2">&quot;^if subprocess.mswindows:&quot;</span><span class="p">,</span>
<span class="linenos">11</span>            <span class="s1">&#39;mswindows = (sys.platform == &quot;win32&quot;)</span><span class="se">\r\n</span><span class="s1">if mswindows:&#39;</span><span class="p">,</span>
<span class="linenos">12</span>            <span class="s2">&quot;popenasync.py&quot;</span><span class="p">,</span>
<span class="linenos">13</span>        <span class="p">)</span>
<span class="linenos">14</span>        <span class="n">filter_file</span><span class="p">(</span><span class="s2">&quot;^    if subprocess.mswindows:&quot;</span><span class="p">,</span> <span class="s2">&quot;    if mswindows:&quot;</span><span class="p">,</span> <span class="s2">&quot;popenasync.py&quot;</span><span class="p">)</span>
<span class="linenos">15</span>
<span class="linenos">16</span>        <span class="c1"># Remove check for python version because the above patch adds support for newer versions</span>
<span class="linenos">17</span>        <span class="n">filter_file</span><span class="p">(</span><span class="s2">&quot;^check_allowed_python_version()&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;setup.py&quot;</span><span class="p">)</span>
<span class="linenos">18</span>
<span class="linenos">19</span>        <span class="c1"># Add Spack&#39;s standard CMake args to the sub-builds.</span>
<span class="linenos">20</span>        <span class="c1"># They&#39;re called BY setup.py so we have to patch it.</span>
<span class="linenos">21</span>        <span class="n">filter_file</span><span class="p">(</span>
<span class="linenos">22</span>            <span class="sa">r</span><span class="s2">&quot;OPTION_CMAKE,&quot;</span><span class="p">,</span>
<span class="linenos">23</span>            <span class="sa">r</span><span class="s2">&quot;OPTION_CMAKE, &quot;</span>
<span class="linenos">24</span>            <span class="o">+</span> <span class="p">(</span>
<span class="linenos">25</span>                <span class="s1">&#39;&quot;-DCMAKE_INSTALL_RPATH_USE_LINK_PATH=FALSE&quot;, &#39;</span>
<span class="linenos">26</span>                <span class="s1">&#39;&quot;-DCMAKE_INSTALL_RPATH=</span><span class="si">%s</span><span class="s1">&quot;,&#39;</span> <span class="o">%</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rpath</span><span class="p">)</span>
<span class="linenos">27</span>            <span class="p">),</span>
<span class="linenos">28</span>            <span class="s2">&quot;setup.py&quot;</span><span class="p">,</span>
<span class="linenos">29</span>        <span class="p">)</span>
<span class="linenos">30</span>
<span class="linenos">31</span>        <span class="c1"># PySide tries to patch ELF files to remove RPATHs</span>
<span class="linenos">32</span>        <span class="c1"># Disable this and go with the one we set.</span>
<span class="linenos">33</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;@1.2.4:&quot;</span><span class="p">):</span>
<span class="linenos">34</span>            <span class="n">rpath_file</span> <span class="o">=</span> <span class="s2">&quot;setup.py&quot;</span>
<span class="linenos">35</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">36</span>            <span class="n">rpath_file</span> <span class="o">=</span> <span class="s2">&quot;pyside_postinstall.py&quot;</span>
<span class="linenos">37</span>
<span class="linenos">38</span>        <span class="n">filter_file</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^\s*)(rpath_cmd\(.*\))&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1#\2&quot;</span><span class="p">,</span> <span class="n">rpath_file</span><span class="p">)</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">patch</span></code> function, if present, will be run after patch files are
applied and before <code class="docutils literal notranslate"><span class="pre">install()</span></code> is run.</p>
<p>You could put this logic in <code class="docutils literal notranslate"><span class="pre">install()</span></code>, but putting it in a patch
function gives you some benefits.  First, spack ensures that the
<code class="docutils literal notranslate"><span class="pre">patch()</span></code> function is run once per code checkout.  That means that
if you run install, hit ctrl-C, and run install again, the code in the
patch function is only run once.  Also, you can tell Spack to run only
the patching part of the build using the <a class="reference internal" href="#cmd-spack-patch"><span class="std std-ref">spack patch</span></a> command.</p>
</section>
<section id="dependency-patching">
<span id="patch-dependency-patching"></span><h3>Dependency patching<a class="headerlink" href="#dependency-patching" title="Link to this heading"></a></h3>
<p>So far we’ve covered how the <code class="docutils literal notranslate"><span class="pre">patch</span></code> directive can be used by a package
to patch <em>its own</em> source code. Packages can <em>also</em> specify patches to be
applied to their dependencies, if they require special modifications.  As
with all packages in Spack, a patched dependency library can coexist with
other versions of that library.  See the <a class="reference internal" href="#dependency-dependency-patching">section on depends_on</a> for more details.</p>
</section>
<section id="inspecting-patches">
<span id="patch-inspecting-patches"></span><h3>Inspecting patches<a class="headerlink" href="#inspecting-patches" title="Link to this heading"></a></h3>
<p>If you want to better understand the patches that Spack applies to your
packages, you can do that using <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">spec</span></code>, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">find</span></code>, and other
query commands.  Let’s look at <code class="docutils literal notranslate"><span class="pre">m4</span></code>.  If you run <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">spec</span> <span class="pre">m4</span></code>, you
can see the patches that would be applied to <code class="docutils literal notranslate"><span class="pre">m4</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ spack spec m4
Input spec
--------------------------------
m4

Concretized
--------------------------------
m4@1.4.18%apple-clang@9.0.0 patches=3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00,c0a408fbffb7255fcc75e26bd8edab116fc81d216bfd18b473668b7739a4158e,fc9b61654a3ba1a8d6cd78ce087e7c96366c290bc8d2c299f09828d793b853c8 +sigsegv arch=darwin-highsierra-x86_64
    ^libsigsegv@2.11%apple-clang@9.0.0 arch=darwin-highsierra-x86_64
</pre></div>
</div>
<p>You can also see patches that have been applied to installed packages
with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">find</span> <span class="pre">-v</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ spack find -v m4
==&gt; 1 installed package
-- darwin-highsierra-x86_64 / apple-clang@9.0.0 -----------------
m4@1.4.18 patches=3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00,c0a408fbffb7255fcc75e26bd8edab116fc81d216bfd18b473668b7739a4158e,fc9b61654a3ba1a8d6cd78ce087e7c96366c290bc8d2c299f09828d793b853c8 +sigsegv
</pre></div>
</div>
<p id="cmd-spack-resource">In both cases above, you can see that the patches’ sha256 hashes are
stored on the spec as a variant.  As mentioned above, this means that you
can have multiple, differently-patched versions of a package installed at
once.</p>
<p>You can look up a patch by its sha256 hash (or a short version of it)
using the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">resource</span> <span class="pre">show</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ spack resource show 3877ab54
3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00
    path:       /home/spackuser/src/spack/var/spack/repos/builtin/packages/m4/gnulib-pgi.patch
    applies to: builtin.m4
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">resource</span> <span class="pre">show</span></code> looks up downloadable resources from package
files by hash and prints out information about them.  Above, we see that
the <code class="docutils literal notranslate"><span class="pre">3877ab54</span></code> patch applies to the <code class="docutils literal notranslate"><span class="pre">m4</span></code> package.  The output also
tells us where to find the patch.</p>
<p>Things get more interesting if you want to know about dependency
patches. For example, when <code class="docutils literal notranslate"><span class="pre">dealii</span></code> is built with <code class="docutils literal notranslate"><span class="pre">boost&#64;1.68.0</span></code>, it
has to patch boost to work correctly.  If you didn’t know this, you might
wonder where the extra boost patches are coming from:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ spack spec dealii ^boost@1.68.0 ^hdf5+fortran | grep &quot;\^boost&quot;
    ^boost@1.68.0
        ^boost@1.68.0%apple-clang@9.0.0+atomic+chrono~clanglibcpp cxxstd=default +date_time~debug+exception+filesystem+graph~icu+iostreams+locale+log+math~mpi+multithreaded~numpy patches=2ab6c72d03dec6a4ae20220a9dfd5c8c572c5294252155b85c6874d97c323199,b37164268f34f7133cbc9a4066ae98fda08adf51e1172223f6a969909216870f ~pic+program_options~python+random+regex+serialization+shared+signals~singlethreaded+system~taggedlayout+test+thread+timer~versionedlayout+wave arch=darwin-highsierra-x86_64
$ spack resource show b37164268
b37164268f34f7133cbc9a4066ae98fda08adf51e1172223f6a969909216870f
    path:       /home/spackuser/src/spack/var/spack/repos/builtin/packages/dealii/boost_1.68.0.patch
    applies to: builtin.boost
    patched by: builtin.dealii
</pre></div>
</div>
<p>Here you can see that the patch is applied to <code class="docutils literal notranslate"><span class="pre">boost</span></code> by <code class="docutils literal notranslate"><span class="pre">dealii</span></code>,
and that it lives in <code class="docutils literal notranslate"><span class="pre">dealii</span></code>’s directory in Spack’s <code class="docutils literal notranslate"><span class="pre">builtin</span></code>
package repository.</p>
</section>
</section>
<section id="handling-rpaths">
<span id="id7"></span><h2>Handling RPATHs<a class="headerlink" href="#handling-rpaths" title="Link to this heading"></a></h2>
<p>Spack installs each package in a way that ensures that all of its
dependencies are found when it runs.  It does this using <a class="reference external" href="http://en.wikipedia.org/wiki/Rpath">RPATHs</a>.  An RPATH is a search
path, stored in a binary (an executable or library), that tells the
dynamic loader where to find its dependencies at runtime. You may be
familiar with <a class="reference external" href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">LD_LIBRARY_PATH</a>
on Linux or <a class="reference external" href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/dyld.3.html">DYLD_LIBRARY_PATH</a>
on Mac OS X.  RPATH is similar to these paths, in that it tells
the loader where to find libraries.  Unlike them, it is embedded in
the binary and not set in each user’s environment.</p>
<p>RPATHs in Spack are handled in one of three ways:</p>
<ol class="arabic">
<li><p>For most packages, RPATHs are handled automatically using Spack’s
<a class="reference internal" href="#compiler-wrappers"><span class="std std-ref">compiler wrappers</span></a>.  These wrappers are
set in standard variables like <code class="docutils literal notranslate"><span class="pre">CC</span></code>, <code class="docutils literal notranslate"><span class="pre">CXX</span></code>, <code class="docutils literal notranslate"><span class="pre">F77</span></code>, and <code class="docutils literal notranslate"><span class="pre">FC</span></code>,
so most build systems (autotools and many gmake systems) pick them
up and use them.</p></li>
<li><p>CMake also respects Spack’s compiler wrappers, but many CMake
builds have logic to overwrite RPATHs when binaries are
installed. Spack provides the <code class="docutils literal notranslate"><span class="pre">std_cmake_args</span></code> variable, which
includes parameters necessary for CMake build use the right
installation RPATH.  It can be used like this when <code class="docutils literal notranslate"><span class="pre">cmake</span></code> is
invoked:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">cmake</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">std_cmake_args</span><span class="p">)</span>
        <span class="n">make</span><span class="p">()</span>
        <span class="n">make</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>If you need to modify the build to add your own RPATHs, you can
use the <code class="docutils literal notranslate"><span class="pre">self.rpath</span></code> property of your package, which will
return a list of all the RPATHs that Spack will use when it
links.  You can see this how this is used in the <a class="reference internal" href="#pyside-patch"><span class="std std-ref">PySide
example</span></a> above.</p></li>
</ol>
</section>
<section id="parallel-builds">
<span id="attribute-parallel"></span><h2>Parallel builds<a class="headerlink" href="#parallel-builds" title="Link to this heading"></a></h2>
<p>Spack supports parallel builds on an individual package and at the
installation level.  Package-level parallelism is established by the
<code class="docutils literal notranslate"><span class="pre">--jobs</span></code> option and its configuration and package recipe equivalents.
Installation-level parallelism is driven by the DAG(s) of the requested
package or packages.</p>
<section id="package-level-build-parallelism">
<h3>Package-level build parallelism<a class="headerlink" href="#package-level-build-parallelism" title="Link to this heading"></a></h3>
<p>By default, Spack will invoke <code class="docutils literal notranslate"><span class="pre">make()</span></code>, or any other similar tool,
with a <code class="docutils literal notranslate"><span class="pre">-j</span> <span class="pre">&lt;njobs&gt;</span></code> argument, so those builds run in parallel.
The parallelism is determined by the value of the <code class="docutils literal notranslate"><span class="pre">build_jobs</span></code> entry
in <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code> (see <a class="reference internal" href="config_yaml.html#build-jobs"><span class="std std-ref">here</span></a> for more details on
how this value is computed).</p>
<p>If a package does not build properly in parallel, you can override
this setting by adding <code class="docutils literal notranslate"><span class="pre">parallel</span> <span class="pre">=</span> <span class="pre">False</span></code> to your package.  For
example, OpenSSL’s build does not work in parallel, so its package
looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">Openssl</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;http://www.openssl.org&quot;</span>
<span class="linenos">3</span>    <span class="n">url</span>      <span class="o">=</span> <span class="s2">&quot;http://www.openssl.org/source/openssl-1.0.1h.tar.gz&quot;</span>
<span class="linenos">4</span>
<span class="linenos">5</span>    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.0.1h&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;8d6d684a9430d5cc98a62a5d8fbda8cf&quot;</span><span class="p">)</span>
<span class="linenos">6</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;zlib-api&quot;</span><span class="p">)</span>
<span class="linenos">7</span>
<span class="hll"><span class="linenos">8</span>    <span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>
</div>
<p>Similarly, you can disable parallel builds only for specific make
commands, as <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> does:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Libelf</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="o">...</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="linenos"> 5</span>        <span class="n">configure</span><span class="p">(</span><span class="s2">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span>
<span class="linenos"> 6</span>                  <span class="s2">&quot;--enable-shared&quot;</span><span class="p">,</span>
<span class="linenos"> 7</span>                  <span class="s2">&quot;--disable-dependency-tracking&quot;</span><span class="p">,</span>
<span class="linenos"> 8</span>                  <span class="s2">&quot;--disable-debug&quot;</span><span class="p">)</span>
<span class="hll"><span class="linenos"> 9</span>        <span class="n">make</span><span class="p">()</span>
</span><span class="linenos">10</span>
<span class="linenos">11</span>        <span class="c1"># The mkdir commands in libelf&#39;s install can fail in parallel</span>
<span class="hll"><span class="linenos">12</span>        <span class="n">make</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>
</div>
<p>The first make will run in parallel here, but the second will not.  If
you set <code class="docutils literal notranslate"><span class="pre">parallel</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code> at the package level, then each call
to <code class="docutils literal notranslate"><span class="pre">make()</span></code> will be sequential by default, but packagers can call
<code class="docutils literal notranslate"><span class="pre">make(parallel=True)</span></code> to override it.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">--jobs</span></code> option works out of the box for all standard
build systems. If you are using a non-standard build system instead, you
can use the variable <code class="docutils literal notranslate"><span class="pre">make_jobs</span></code> to extract the number of jobs specified
by the <code class="docutils literal notranslate"><span class="pre">--jobs</span></code> option:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Xios</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos"> 2</span>   <span class="o">...</span>
<span class="linenos"> 3</span>   <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="linenos"> 4</span>      <span class="o">...</span>
<span class="linenos"> 5</span>      <span class="n">options</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 6</span>         <span class="o">...</span>
<span class="hll"><span class="linenos"> 7</span>         <span class="s1">&#39;--jobs&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">make_jobs</span><span class="p">),</span>
</span><span class="linenos"> 8</span>     <span class="p">]</span>
<span class="linenos"> 9</span>     <span class="o">...</span>
<span class="linenos">10</span>     <span class="n">make_xios</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="s2">&quot;./make_xios&quot;</span><span class="p">)</span>
<span class="hll"><span class="linenos">11</span>     <span class="n">make_xios</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="install-level-build-parallelism">
<h3>Install-level build parallelism<a class="headerlink" href="#install-level-build-parallelism" title="Link to this heading"></a></h3>
<p>Spack supports the concurrent installation of packages within a Spack
instance across multiple processes using file system locks.  This
parallelism is separate from the package-level achieved through build
systems’ use of the <code class="docutils literal notranslate"><span class="pre">-j</span> <span class="pre">&lt;njobs&gt;</span></code> option.  With install-level parallelism,
processes coordinate the installation of the dependencies of specs
provided on the command line and as part of an environment build with
only <strong>one process</strong> being allowed to install a given package at a time.
Refer to <a class="reference internal" href="#dependencies"><span class="std std-ref">Dependencies</span></a> for more information on dependencies and
<a class="reference internal" href="environments.html#installing-environment"><span class="std std-ref">Installing an Environment</span></a> for how to install an environment.</p>
<p>Concurrent processes may be any combination of interactive sessions and
batch jobs.  Which means a <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> can be running in a terminal
window while a batch job is running <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> on the same or
overlapping dependencies without any process trying to re-do the work of
another.</p>
<p>For example, if you are using Slurm, you could launch an installation
of <code class="docutils literal notranslate"><span class="pre">mpich</span></code> using the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>-N<span class="w"> </span><span class="m">2</span><span class="w"> </span>-n<span class="w"> </span><span class="m">8</span><span class="w"> </span>spack<span class="w"> </span>install<span class="w"> </span>-j<span class="w"> </span><span class="m">4</span><span class="w"> </span>mpich@3.3.2
</pre></div>
</div>
<p>This will create eight concurrent, four-job installs on two different
nodes.</p>
<p>Alternatively, you could run the same installs on one node by entering
the following at the command line of a bash shell:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..12<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>nohup<span class="w"> </span>spack<span class="w"> </span>install<span class="w"> </span>-j<span class="w"> </span><span class="m">4</span><span class="w"> </span>mpich@3.3.2<span class="w"> </span>&gt;&gt;<span class="w"> </span>mpich_install.txt<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The effective parallelism is based on the maximum number of packages
that can be installed at the same time, which is limited by the
number of packages with no (remaining) uninstalled dependencies.</p>
</div>
</section>
</section>
<section id="dependencies">
<span id="id8"></span><h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading"></a></h2>
<p>We’ve covered how to build a simple package, but what if one package
relies on another package to build?  How do you express that in a
package file?  And how do you refer to the other package in the build
script for your own package?</p>
<p>Spack makes this relatively easy.  Let’s take a look at the
<code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> package to see how it’s done:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Libdwarf</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;http://www.prevanders.net/dwarf.html&quot;</span>
<span class="linenos"> 3</span>    <span class="n">url</span>      <span class="o">=</span> <span class="s2">&quot;http://www.prevanders.net/libdwarf-20130729.tar.gz&quot;</span>
<span class="linenos"> 4</span>    <span class="n">list_url</span> <span class="o">=</span> <span class="n">homepage</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;20130729&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;4cc5e48693f7b93b7aa0261e63c0e21d&quot;</span><span class="p">)</span>
<span class="linenos"> 7</span>    <span class="o">...</span>
<span class="linenos"> 8</span>
<span class="hll"><span class="linenos"> 9</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;libelf&quot;</span><span class="p">)</span>
</span><span class="linenos">10</span>
<span class="linenos">11</span>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="linenos">12</span>        <span class="o">...</span>
</pre></div>
</div>
<section id="depends-on">
<h3><code class="docutils literal notranslate"><span class="pre">depends_on()</span></code><a class="headerlink" href="#depends-on" title="Link to this heading"></a></h3>
<p>The highlighted <code class="docutils literal notranslate"><span class="pre">depends_on(&quot;libelf&quot;)</span></code> call tells Spack that it
needs to build and install the <code class="docutils literal notranslate"><span class="pre">libelf</span></code> package before it builds
<code class="docutils literal notranslate"><span class="pre">libdwarf</span></code>.  This means that in your <code class="docutils literal notranslate"><span class="pre">install()</span></code> method, you are
guaranteed that <code class="docutils literal notranslate"><span class="pre">libelf</span></code> has been built and installed successfully,
so you can rely on it for your libdwarf build.</p>
</section>
<section id="dependency-specs">
<h3>Dependency specs<a class="headerlink" href="#dependency-specs" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">depends_on</span></code> doesn’t just take the name of another package. It can
take a full spec as well. This means that you can restrict the versions or
other configuration options of <code class="docutils literal notranslate"><span class="pre">libelf</span></code> that <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> will build
with. For example, suppose that in the <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> package you write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;libelf@0.8&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> will require <code class="docutils literal notranslate"><span class="pre">libelf</span></code> in the range <code class="docutils literal notranslate"><span class="pre">0.8</span></code>, which
includes patch versions <code class="docutils literal notranslate"><span class="pre">0.8.1</span></code>, <code class="docutils literal notranslate"><span class="pre">0.8.2</span></code>, etc. Apart from version
restrictions, you can also specify variants if this package requires
optional features of the dependency.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;libelf@0.8 +parser +pic&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Both users <em>and</em> package authors can use the same spec syntax to refer
to different package configurations. Users use the spec syntax on the
command line to find installed packages or to install packages with
particular constraints, and package authors can use specs to describe
relationships between packages.</p>
</section>
<section id="specifying-backward-and-forward-compatibility">
<h3>Specifying backward and forward compatibility<a class="headerlink" href="#specifying-backward-and-forward-compatibility" title="Link to this heading"></a></h3>
<p>Packages are often compatible with a range of versions of their
dependencies. This is typically referred to as backward and forward
compatibility. Spack allows you to specify this in the <code class="docutils literal notranslate"><span class="pre">depends_on</span></code>
directive using version ranges.</p>
<p><strong>Backwards compatibility</strong> means that the package requires at least a
certain version of its dependency:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3.10:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, the package requires Python 3.10 or newer.</p>
<p>Commonly, packages drop support for older versions of a dependency as
they release new versions. In Spack you can conveniently add every
backward compatibility rule as a separate line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># backward compatibility with Python</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3.8:&quot;</span><span class="p">)</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3.9:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.2:&quot;</span><span class="p">)</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3.10:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.4:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This means that in general we need Python 3.8 or newer; from version
1.2 onwards we need Python 3.9 or newer; from version 1.4 onwards we
need Python 3.10 or newer. Notice that it’s fine to have overlapping
ranges in the <code class="docutils literal notranslate"><span class="pre">when</span></code> clauses.</p>
<p><strong>Forward compatibility</strong> means that the package requires at most a
certain version of its dependency. Forward compatibility rules are
necessary when there are breaking changes in the dependency that the
package cannot handle. In Spack we often add forward compatibility
bounds only at the time a new, breaking version of a dependency is
released. As with backward compatibility, it is typical to see a list
of forward compatibility bounds in a package file as seperate lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># forward compatibility with Python</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@:3.12&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:1.10&quot;</span><span class="p">)</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@:3.13&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:1.12&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice how the <code class="docutils literal notranslate"><span class="pre">:</span></code> now appears before the version number both in the
dependency and in the <code class="docutils literal notranslate"><span class="pre">when</span></code> clause. This tells Spack that in general
we need Python 3.13 or older up to version <code class="docutils literal notranslate"><span class="pre">1.12.x</span></code>, and up to version
<code class="docutils literal notranslate"><span class="pre">1.10.x</span></code> we need Python 3.12 or older. Said differently, forward compatibility
with Python 3.13 was added in version 1.11, while version 1.13 added forward
compatibility with Python 3.14.</p>
<p>Notice that a version range <code class="docutils literal notranslate"><span class="pre">&#64;:3.12</span></code> includes <em>any</em> patch version
number <code class="docutils literal notranslate"><span class="pre">3.12.x</span></code>, which is often useful when specifying forward compatibility
bounds.</p>
<p>So far we have seen open-ended version ranges, which is by far the most
common use case. It is also possible to specify both a lower and an upper bound
on the version of a dependency, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3.10:3.12&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>There is short syntax to specify that a package is compatible with say any
<code class="docutils literal notranslate"><span class="pre">3.x</span></code> version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above is equivalent to <code class="docutils literal notranslate"><span class="pre">depends_on(&quot;python&#64;3:3&quot;)</span></code>, which means at least
Python version 3 and at most any version <code class="docutils literal notranslate"><span class="pre">3.x.y</span></code>.</p>
<p>In very rare cases, you may need to specify an exact version, for example
if you need to distinguish between <code class="docutils literal notranslate"><span class="pre">3.2</span></code> and <code class="docutils literal notranslate"><span class="pre">3.2.1</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;pkg@=3.2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>But in general, you should try to use version ranges as much as possible,
so that custom suffixes are included too. The above example can be
rewritten in terms of ranges as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;pkg@3.2:3.2.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A spec can contain a version list of ranges and individual versions
separated by commas. For example, if you need Boost 1.59.0 or newer,
but there are known issues with 1.64.0, 1.65.0, and 1.66.0, you can say:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;boost@1.59.0:1.63,1.65.1,1.67.0:&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dependency-types">
<span id="id9"></span><h3>Dependency types<a class="headerlink" href="#dependency-types" title="Link to this heading"></a></h3>
<p>Not all dependencies are created equal, and Spack allows you to specify
exactly what kind of a dependency you need. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;cmake&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-numpy&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">))</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;libelf&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">))</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-pytest&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The following dependency types are available:</p>
<ul class="simple">
<li><p><strong>“build”</strong>: the dependency will be added to the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> and
<code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> at build-time.</p></li>
<li><p><strong>“link”</strong>: the dependency will be added to Spack’s compiler
wrappers, automatically injecting the appropriate linker flags,
including <code class="docutils literal notranslate"><span class="pre">-I</span></code>, <code class="docutils literal notranslate"><span class="pre">-L</span></code>, and RPATH/RUNPATH handling.</p></li>
<li><p><strong>“run”</strong>: the dependency will be added to the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> and
<code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> at run-time. This is true for both <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">load</span></code>
and the module files Spack writes.</p></li>
<li><p><strong>“test”</strong>: the dependency will be added to the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> and
<code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> at build-time. The only difference between
“build” and “test” is that test dependencies are only built
if the user requests unit tests with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">--test</span></code>.</p></li>
</ul>
<p>One of the advantages of the <code class="docutils literal notranslate"><span class="pre">build</span></code> dependency type is that although the
dependency needs to be installed in order for the package to be built, it
can be uninstalled without concern afterwards. <code class="docutils literal notranslate"><span class="pre">link</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code> disallow
this because uninstalling the dependency would break the package.</p>
<p><code class="docutils literal notranslate"><span class="pre">build</span></code>, <code class="docutils literal notranslate"><span class="pre">link</span></code>, and <code class="docutils literal notranslate"><span class="pre">run</span></code> dependencies all affect the hash of Spack
packages (along with <code class="docutils literal notranslate"><span class="pre">sha256</span></code> sums of patches and archives used to build the
package, and a <a class="reference external" href="https://github.com/spack/spack/pull/28156">canonical hash</a> of
the <code class="docutils literal notranslate"><span class="pre">package.py</span></code> recipes). <code class="docutils literal notranslate"><span class="pre">test</span></code> dependencies do not affect the package
hash, as they are only used to construct a test environment <em>after</em> building and
installing a given package installation. Older versions of Spack did not include
build dependencies in the hash, but this has been
<a class="reference external" href="https://github.com/spack/spack/pull/28504">fixed</a> as of <a class="reference external" href="https://github.com/spack/spack/releases/tag/v0.18.0">Spack <code class="docutils literal notranslate"><span class="pre">v0.18</span></code></a>.</p>
<p>If the dependency type is not specified, Spack uses a default of
<code class="docutils literal notranslate"><span class="pre">(&quot;build&quot;,</span> <span class="pre">&quot;link&quot;)</span></code>. This is the common case for compiler languages.
Non-compiled packages like Python modules commonly use
<code class="docutils literal notranslate"><span class="pre">(&quot;build&quot;,</span> <span class="pre">&quot;run&quot;)</span></code>. This means that the compiler wrappers don’t need to
inject the dependency’s <code class="docutils literal notranslate"><span class="pre">prefix/lib</span></code> directory, but the package needs to
be in <code class="docutils literal notranslate"><span class="pre">PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> during the build process and later when
a user wants to run the package.</p>
</section>
<section id="conditional-dependencies">
<h3>Conditional dependencies<a class="headerlink" href="#conditional-dependencies" title="Link to this heading"></a></h3>
<p>You may have a package that only requires a dependency under certain
conditions. For example, you may have a package with optional MPI support.
You would then provide a variant to reflect that the feature is optional
and specify the MPI dependency only applies when MPI support is enabled.
In that case, you could say something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variant</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable MPI support&quot;</span><span class="p">)</span>

<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+mpi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose the above package also has, since version 3, optional <cite>Trilinos</cite>
support and you want them both to build either with or without MPI. Further
suppose you require a version of <cite>Trilinos</cite> no older than 12.6. In that case,
the <cite>trilinos</cite> variant and dependency directives would be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variant</span><span class="p">(</span><span class="s2">&quot;trilinos&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable Trilinos support&quot;</span><span class="p">)</span>

<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;trilinos@12.6:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@3: +trilinos&quot;</span><span class="p">)</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;trilinos@12.6: +mpi&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@3: +trilinos +mpi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, you could use the <cite>when</cite> context manager to equivalently specify
the <cite>trilinos</cite> variant dependencies as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">when</span><span class="p">(</span><span class="s2">&quot;@3: +trilinos&quot;</span><span class="p">):</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;trilinos@12.6:&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;trilinos +mpi&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+mpi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The argument to <code class="docutils literal notranslate"><span class="pre">when</span></code> in either case can include any Spec constraints that
are supported on the command line using the same <a class="reference internal" href="basic_usage.html#sec-specs"><span class="std std-ref">syntax</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a dependency isn’t typically used, you can save time by making it
conditional since Spack will not build the dependency unless it is
required for the Spec.</p>
</div>
</section>
<section id="dependency-dependency-patching">
<span id="id10"></span><h3>Dependency patching<a class="headerlink" href="#dependency-dependency-patching" title="Link to this heading"></a></h3>
<p>Some packages maintain special patches on their dependencies, either to
add new features or to fix bugs.  This typically makes a package harder
to maintain, and we encourage developers to upstream (contribute back)
their changes rather than maintaining patches.  However, in some cases
it’s not possible to upstream. Maybe the dependency’s developers don’t
accept changes, or maybe they just haven’t had time to integrate them.</p>
<p>For times like these, Spack’s <code class="docutils literal notranslate"><span class="pre">depends_on</span></code> directive can optionally
take a patch or list of patches:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpecialTool</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;binutils&quot;</span><span class="p">,</span> <span class="n">patches</span><span class="o">=</span><span class="s2">&quot;special-binutils-feature.patch&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">special-tool</span></code> package requires a special feature in
<code class="docutils literal notranslate"><span class="pre">binutils</span></code>, so it provides an extra <code class="docutils literal notranslate"><span class="pre">patches=&lt;filename&gt;</span></code> keyword
argument.  This is similar to the <a class="reference internal" href="#patching">patch directive</a>, with
one small difference.  Here, <code class="docutils literal notranslate"><span class="pre">special-tool</span></code> is responsible for the
patch, so it should live in <code class="docutils literal notranslate"><span class="pre">special-tool</span></code>’s directory in the package
repository, not the <code class="docutils literal notranslate"><span class="pre">binutils</span></code> directory.</p>
<p>If you need something more sophisticated than this, you can simply nest a
<code class="docutils literal notranslate"><span class="pre">patch()</span></code> directive inside of <code class="docutils literal notranslate"><span class="pre">depends_on</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpecialTool</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">depends_on</span><span class="p">(</span>
        <span class="s2">&quot;binutils&quot;</span><span class="p">,</span>
        <span class="n">patches</span><span class="o">=</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;special-binutils-feature.patch&quot;</span><span class="p">,</span>
                      <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                      <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:1.3&quot;</span><span class="p">),</span>   <span class="c1"># condition on binutils</span>
        <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2.0:&quot;</span><span class="p">)</span>                  <span class="c1"># condition on special-tool</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Note that there are two optional <code class="docutils literal notranslate"><span class="pre">when</span></code> conditions here – one on the
<code class="docutils literal notranslate"><span class="pre">patch</span></code> directive and the other on <code class="docutils literal notranslate"><span class="pre">depends_on</span></code>.  The condition in
the <code class="docutils literal notranslate"><span class="pre">patch</span></code> directive applies to <code class="docutils literal notranslate"><span class="pre">binutils</span></code> (the package being
patched), while the condition in <code class="docutils literal notranslate"><span class="pre">depends_on</span></code> applies to
<code class="docutils literal notranslate"><span class="pre">special-tool</span></code>.  See <a class="reference internal" href="#patching">patch directive</a> for details on all
the arguments the <code class="docutils literal notranslate"><span class="pre">patch</span></code> directive can take.</p>
<p>Finally, if you need <em>multiple</em> patches on a dependency, you can provide
a list for <code class="docutils literal notranslate"><span class="pre">patches</span></code>, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpecialTool</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">depends_on</span><span class="p">(</span>
        <span class="s2">&quot;binutils&quot;</span><span class="p">,</span>
        <span class="n">patches</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;binutils-bugfix1.patch&quot;</span><span class="p">,</span>
            <span class="s2">&quot;binutils-bugfix2.patch&quot;</span><span class="p">,</span>
            <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;https://example.com/special-binutils-feature.patch&quot;</span><span class="p">,</span>
                  <span class="n">sha256</span><span class="o">=</span><span class="s2">&quot;252c0af58be3d90e5dc5e0d16658434c9efa5d20a5df6c10bf72c2d77f780866&quot;</span><span class="p">,</span>
                  <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:1.3&quot;</span><span class="p">)],</span>
        <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2.0:&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>As with <code class="docutils literal notranslate"><span class="pre">patch</span></code> directives, patches are applied in the order they
appear in the package file (or in this case, in the list).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may wonder whether dependency patching will interfere with other
packages that depend on <code class="docutils literal notranslate"><span class="pre">binutils</span></code>.  It won’t.</p>
<p>As described in <a class="reference internal" href="#patching">patching</a>, Patching a package adds the <code class="docutils literal notranslate"><span class="pre">sha256</span></code> of
the patch to the package’s spec, which means it will have a
<em>different</em> unique hash than other versions without the patch.  The
patched version coexists with unpatched versions, and Spack’s support
for <a class="reference internal" href="#handling-rpaths">handling_rpaths</a> guarantees that each installation finds the
right version. If two packages depend on <code class="docutils literal notranslate"><span class="pre">binutils</span></code> patched <em>the
same</em> way, they can both use a single installation of <code class="docutils literal notranslate"><span class="pre">binutils</span></code>.</p>
</div>
</section>
</section>
<section id="conflicts-and-requirements">
<span id="packaging-conflicts"></span><h2>Conflicts and requirements<a class="headerlink" href="#conflicts-and-requirements" title="Link to this heading"></a></h2>
<p>Sometimes packages have known bugs, or limitations, that would prevent them
from building e.g. against other dependencies or with certain compilers. Spack
makes it possible to express such constraints with the <code class="docutils literal notranslate"><span class="pre">conflicts</span></code> directive.</p>
<p>Adding the following to a package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conflicts</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">%i</span><span class="s2">ntel&quot;</span><span class="p">,</span>
     <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:1.2&quot;</span><span class="p">,</span>
     <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&lt;myNicePackage&gt; &lt;= v1.2 cannot be built with Intel ICC, &quot;</span>
         <span class="s2">&quot;please use a newer release.&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>we express the fact that the current package <em>cannot be built</em> with the Intel
compiler when we are trying to install a version “&lt;=1.2”.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">when</span></code> argument can be omitted, in which case the conflict will always be active.</p>
<p>An optional custom error message can be added via the <code class="docutils literal notranslate"><span class="pre">msg=</span></code> parameter, and will be printed
by Spack in case the conflict cannot be avoided and leads to a concretization error.</p>
<p>Sometimes, packages allow only very specific choices and they can’t use the rest. In those cases
the <code class="docutils literal notranslate"><span class="pre">requires</span></code> directive can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">%a</span><span class="s2">pple-clang&quot;</span><span class="p">,</span>
    <span class="n">when</span><span class="o">=</span><span class="s2">&quot;platform=darwin&quot;</span><span class="p">,</span>
    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&lt;myNicePackage&gt; builds only with Apple-Clang on Darwin&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In the example above, our package can only be built with Apple-Clang on Darwin.
The <code class="docutils literal notranslate"><span class="pre">requires</span></code> directive is effectively the opposite of the <code class="docutils literal notranslate"><span class="pre">conflicts</span></code> directive, and takes
the same optional <code class="docutils literal notranslate"><span class="pre">when</span></code> and <code class="docutils literal notranslate"><span class="pre">msg</span></code> arguments.</p>
<p>If a package needs to express more complex requirements, involving more than a single spec,
that can also be done using the <code class="docutils literal notranslate"><span class="pre">requires</span></code> directive. To express that a package can be built
either with GCC or with Clang we can write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">cc&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">lang&quot;</span><span class="p">,</span>
    <span class="n">policy</span><span class="o">=</span><span class="s2">&quot;one_of&quot;</span>
    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&lt;myNicePackage&gt; builds only with GCC or Clang&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>When using multiple specs in a <code class="docutils literal notranslate"><span class="pre">requires</span></code> directive, it is advised to set the <code class="docutils literal notranslate"><span class="pre">policy=</span></code>
argument explicitly. That argument can take either the value <code class="docutils literal notranslate"><span class="pre">any_of</span></code> or the value <code class="docutils literal notranslate"><span class="pre">one_of</span></code>,
and the semantic is the same as for <a class="reference internal" href="packages_yaml.html#package-requirements"><span class="std std-ref">Package Requirements</span></a>.</p>
</section>
<section id="extensions">
<span id="packaging-extensions"></span><h2>Extensions<a class="headerlink" href="#extensions" title="Link to this heading"></a></h2>
<p>Spack’s support for package extensions is documented extensively in
<a class="reference internal" href="basic_usage.html#extensions"><span class="std std-ref">Python packages and virtual environments</span></a>.  This section documents how to make your own
extendable packages and extensions.</p>
<p>To support extensions, a package needs to set its <code class="docutils literal notranslate"><span class="pre">extendable</span></code>
property to <code class="docutils literal notranslate"><span class="pre">True</span></code>, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Python</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">extendable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>To make a package into an extension, simply add an
<code class="docutils literal notranslate"><span class="pre">extends</span></code> call in the package definition, and pass it the name of an
extendable package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PyNumpy</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">extends</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This accomplishes a few things. Firstly, the Python package can set special
variables such as <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> for all extensions when the run or build
environment is set up. Secondly, filesystem views can ensure that extensions
are put in the same prefix as their extendee. This ensures that Python in
a view can always locate its Python packages, even without environment
variables set.</p>
<p>A package can only extend one other package at a time.  To support packages
that may extend one of a list of other packages, Spack supports multiple
<code class="docutils literal notranslate"><span class="pre">extends</span></code> directives as long as at most one of them is selected as
a dependency during concretization.  For example, a lua package could extend
either lua or luajit, but not both:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LuaLpeg</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;use_lua&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">extends</span><span class="p">(</span><span class="s2">&quot;lua&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+use_lua&quot;</span><span class="p">)</span>
    <span class="n">extends</span><span class="p">(</span><span class="s2">&quot;lua-luajit&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;~use_lua&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Now, a user can install, and activate, the <code class="docutils literal notranslate"><span class="pre">lua-lpeg</span></code> package for either
lua or luajit.</p>
<section id="adding-additional-constraints">
<h3>Adding additional constraints<a class="headerlink" href="#adding-additional-constraints" title="Link to this heading"></a></h3>
<p>Some packages produce a Python extension, but are only compatible with
Python 3, or with Python 2.  In those cases, a <code class="docutils literal notranslate"><span class="pre">depends_on()</span></code>
declaration should be made in addition to the <code class="docutils literal notranslate"><span class="pre">extends()</span></code>
declaration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Icebin</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">extends</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+python&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+python&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Many packages produce Python extensions for <em>some</em> variants, but not
others: they should extend <code class="docutils literal notranslate"><span class="pre">python</span></code> only if the appropriate
variant(s) are selected.  This may be accomplished with conditional
<code class="docutils literal notranslate"><span class="pre">extends()</span></code> declarations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FooLib</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Build the Python extension Module&quot;</span><span class="p">)</span>
    <span class="n">extends</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+python&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="runtime-and-build-time-environment-variables">
<span id="setup-environment"></span><h2>Runtime and build time environment variables<a class="headerlink" href="#runtime-and-build-time-environment-variables" title="Link to this heading"></a></h2>
<p>Spack provides a few methods to help package authors set up the required environment variables for
their package. Environment variables typically depend on how the package is used: variables that
make sense during the build phase may not be needed at runtime, and vice versa. Further, sometimes
it makes sense to let a dependency set the environment variables for its dependents. To allow all
this, Spack provides four different methods that can be overridden in a package:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="spack.html#spack.builder.Builder.setup_build_environment" title="spack.builder.Builder.setup_build_environment"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup_build_environment</span></code></a></p></li>
<li><p><a class="reference internal" href="spack.html#spack.package_base.PackageBase.setup_run_environment" title="spack.package_base.PackageBase.setup_run_environment"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup_run_environment</span></code></a></p></li>
<li><p><a class="reference internal" href="spack.html#spack.builder.Builder.setup_dependent_build_environment" title="spack.builder.Builder.setup_dependent_build_environment"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup_dependent_build_environment</span></code></a></p></li>
<li><p><a class="reference internal" href="spack.html#spack.package_base.PackageBase.setup_dependent_run_environment" title="spack.package_base.PackageBase.setup_dependent_run_environment"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup_dependent_run_environment</span></code></a></p></li>
</ol>
<p>The Qt package, for instance, uses this call:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>    <span class="k">def</span> <span class="nf">setup_dependent_build_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">dependent_spec</span><span class="p">):</span>
<span class="linenos">2</span>        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;QTDIR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
<span class="linenos">3</span>        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;QTINC&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">inc</span><span class="p">)</span>
<span class="linenos">4</span>        <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;QTLIB&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
<span class="linenos">5</span>        <span class="n">env</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="s2">&quot;QT_PLUGIN_PATH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">plugins</span><span class="p">)</span>
<span class="linenos">6</span>        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
<span class="linenos">7</span>            <span class="c1"># Force Qt to use the desktop provided GL</span>
<span class="linenos">8</span>            <span class="c1"># on Windows when dependencies are building against Qt</span>
<span class="linenos">9</span>            <span class="n">env</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;QT_OPENGL&quot;</span><span class="p">,</span> <span class="s2">&quot;desktop&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>to set the <code class="docutils literal notranslate"><span class="pre">QTDIR</span></code> environment variable so that packages that depend on a particular Qt
installation will find it.</p>
<p>The following diagram will give you an idea when each of these methods is called in a build
context:</p>
<img alt="_images/setup_env.png" class="align-center" src="_images/setup_env.png" />
<p>Notice that <code class="docutils literal notranslate"><span class="pre">setup_dependent_run_environment</span></code> can be called multiple times, once for each
dependent package, whereas <code class="docutils literal notranslate"><span class="pre">setup_run_environment</span></code> is called only once for the package itself.
This means that the former should only be used if the environment variables depend on the dependent
package, whereas the latter should be used if the environment variables depend only on the package
itself.</p>
</section>
<section id="setting-package-module-variables">
<h2>Setting package module variables<a class="headerlink" href="#setting-package-module-variables" title="Link to this heading"></a></h2>
<p>Apart from modifying environment variables of the dependent package, you can also define Python
variables to be used by the dependent. This is done by implementing
<a class="reference internal" href="spack.html#spack.package_base.PackageBase.setup_dependent_package" title="spack.package_base.PackageBase.setup_dependent_package"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup_dependent_package</span></code></a>. An
example of this can be found in the <code class="docutils literal notranslate"><span class="pre">Python</span></code> package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>    <span class="k">def</span> <span class="nf">setup_dependent_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">dependent_spec</span><span class="p">):</span>
<span class="linenos">2</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Called before python modules&#39; install() methods.&quot;&quot;&quot;</span>
<span class="linenos">3</span>        <span class="n">module</span><span class="o">.</span><span class="n">python</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span>
<span class="linenos">4</span>        <span class="n">module</span><span class="o">.</span><span class="n">python_include</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="n">dependent_spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>
<span class="linenos">5</span>        <span class="n">module</span><span class="o">.</span><span class="n">python_platlib</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="n">dependent_spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platlib</span><span class="p">)</span>
<span class="linenos">6</span>        <span class="n">module</span><span class="o">.</span><span class="n">python_purelib</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="n">dependent_spec</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">purelib</span><span class="p">)</span>
</pre></div>
</div>
<p>This allows Python packages to directly use these variables:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">install</span><span class="p">(</span><span class="s2">&quot;script.py&quot;</span><span class="p">,</span> <span class="n">python_platlib</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We recommend using <code class="docutils literal notranslate"><span class="pre">setup_dependent_package</span></code> sparingly, as it is not always clear where
global variables are coming from when editing a <code class="docutils literal notranslate"><span class="pre">package.py</span></code> file.</p>
</div>
</section>
<section id="views">
<h2>Views<a class="headerlink" href="#views" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">view</span></code> command can be
used to symlink a number of packages into a merged prefix. The methods of
<code class="docutils literal notranslate"><span class="pre">PackageViewMixin</span></code> can be overridden to customize how packages are added
to views. Generally this can be used to create copies of specific files rather
than symlinking them when symlinking does not work. For example, <code class="docutils literal notranslate"><span class="pre">Python</span></code>
overrides <code class="docutils literal notranslate"><span class="pre">add_files_to_view</span></code> in order to create a copy of the <code class="docutils literal notranslate"><span class="pre">python</span></code>
binary since the real path of the Python executable is used to detect
extensions; as a consequence python extension packages (those inheriting from
<code class="docutils literal notranslate"><span class="pre">PythonPackage</span></code>) likewise override <code class="docutils literal notranslate"><span class="pre">add_files_to_view</span></code> in order to rewrite
shebang lines which point to the Python interpreter.</p>
</section>
<section id="virtual-dependencies">
<span id="id11"></span><h2>Virtual dependencies<a class="headerlink" href="#virtual-dependencies" title="Link to this heading"></a></h2>
<p>In some cases, more than one package can satisfy another package’s
dependency.  One way this can happen is if a package depends on a
particular <em>interface</em>, but there are multiple <em>implementations</em> of
the interface, and the package could be built with any of them.  A
<em>very</em> common interface in HPC is the <a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/">Message Passing Interface (MPI)</a>, which is used in
many large-scale parallel applications.</p>
<p>MPI has several different implementations (e.g., <a class="reference external" href="http://www.mpich.org">MPICH</a>, <a class="reference external" href="http://www.open-mpi.org">OpenMPI</a>, and
<a class="reference external" href="http://mvapich.cse.ohio-state.edu">MVAPICH</a>) and scientific
applications can be built with any one of them.  Complicating matters,
MPI does not have a standardized ABI, so a package built with one
implementation cannot simply be relinked with another implementation.
Many package managers handle interfaces like this by requiring many
similar package files, e.g., <code class="docutils literal notranslate"><span class="pre">foo</span></code>, <code class="docutils literal notranslate"><span class="pre">foo-mvapich</span></code>, <code class="docutils literal notranslate"><span class="pre">foo-mpich</span></code>,
but Spack avoids this explosion of package files by providing support
for <em>virtual dependencies</em>.</p>
<section id="provides">
<h3><code class="docutils literal notranslate"><span class="pre">provides</span></code><a class="headerlink" href="#provides" title="Link to this heading"></a></h3>
<p>In Spack, <code class="docutils literal notranslate"><span class="pre">mpi</span></code> is handled as a <em>virtual package</em>.  A package like
<code class="docutils literal notranslate"><span class="pre">mpileaks</span></code> can depend on it just like any other package, by
supplying a <code class="docutils literal notranslate"><span class="pre">depends_on</span></code> call in the package definition.  For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">Mpileaks</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/hpc/mpileaks&quot;</span>
<span class="linenos">3</span>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/hpc/mpileaks/releases/download/v1.0/mpileaks-1.0.tar.gz&quot;</span>
<span class="linenos">4</span>
<span class="linenos">5</span>    <span class="n">version</span><span class="p">(</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">md5</span><span class="o">=</span><span class="s2">&quot;8838c574b39202a57d7c2d68692718aa&quot;</span><span class="p">)</span>
<span class="linenos">6</span>
<span class="hll"><span class="linenos">7</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">)</span>
</span><span class="linenos">8</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;adept-utils&quot;</span><span class="p">)</span>
<span class="linenos">9</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;callpath&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">callpath</span></code> and <code class="docutils literal notranslate"><span class="pre">adept-utils</span></code> are concrete packages, but
there is no actual package file for <code class="docutils literal notranslate"><span class="pre">mpi</span></code>, so we say it is a
<em>virtual</em> package.  The syntax of <code class="docutils literal notranslate"><span class="pre">depends_on</span></code>, is the same for
both.  If we look inside the package file of an MPI implementation,
say MPICH, we’ll see something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mpich</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">provides</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">provides(&quot;mpi&quot;)</span></code> call tells Spack that the <code class="docutils literal notranslate"><span class="pre">mpich</span></code> package
can be used to satisfy the dependency of any package that
<code class="docutils literal notranslate"><span class="pre">depends_on(&quot;mpi&quot;)</span></code>.</p>
</section>
<section id="providing-multiple-virtuals-simultaneously">
<h3>Providing multiple virtuals simultaneously<a class="headerlink" href="#providing-multiple-virtuals-simultaneously" title="Link to this heading"></a></h3>
<p>Packages can provide more than one virtual dependency. Sometimes, due to implementation details,
there are subsets of those virtuals that need to be provided together by the same package.</p>
<p>A well-known example is <code class="docutils literal notranslate"><span class="pre">openblas</span></code>, which provides both the <code class="docutils literal notranslate"><span class="pre">lapack</span></code> and <code class="docutils literal notranslate"><span class="pre">blas</span></code> API in a single <code class="docutils literal notranslate"><span class="pre">libopenblas</span></code>
library. A package that needs <code class="docutils literal notranslate"><span class="pre">lapack</span></code> and <code class="docutils literal notranslate"><span class="pre">blas</span></code> must either use <code class="docutils literal notranslate"><span class="pre">openblas</span></code> to provide both, or not use
<code class="docutils literal notranslate"><span class="pre">openblas</span></code> at all. It cannot pick one or the other.</p>
<p>To express this constraint in a package, the two virtual dependencies must be listed in the same <code class="docutils literal notranslate"><span class="pre">provides</span></code> directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">provides</span><span class="p">(</span><span class="s1">&#39;blas&#39;</span><span class="p">,</span> <span class="s1">&#39;lapack&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This makes it impossible to select <code class="docutils literal notranslate"><span class="pre">openblas</span></code> as a provider for one of the two
virtual dependencies and not for the other. If you try to, Spack will report an error:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>spec<span class="w"> </span>netlib-scalapack<span class="w">  </span>^<span class="o">[</span><span class="nv">virtuals</span><span class="o">=</span>lapack<span class="o">]</span><span class="w"> </span>openblas<span class="w"> </span>^<span class="o">[</span><span class="nv">virtuals</span><span class="o">=</span>blas<span class="o">]</span><span class="w"> </span>atlas
<span class="go">==&gt; Error: concretization failed for the following reasons:</span>

<span class="go">   1. Package &#39;openblas&#39; needs to provide both &#39;lapack&#39; and &#39;blas&#39; together, but provides only &#39;lapack&#39;</span>
</pre></div>
</div>
</section>
<section id="versioned-interfaces">
<h3>Versioned Interfaces<a class="headerlink" href="#versioned-interfaces" title="Link to this heading"></a></h3>
<p>Just as you can pass a spec to <code class="docutils literal notranslate"><span class="pre">depends_on</span></code>, so can you pass a spec
to <code class="docutils literal notranslate"><span class="pre">provides</span></code> to add constraints.  This allows Spack to support the
notion of <em>versioned interfaces</em>.  The MPI standard has gone through
many revisions, each with new functions added, and each revision of
the standard has a version number.  Some packages may require a recent
implementation that supports MPI-3 functions, but some MPI versions may
only provide up to MPI-2.  Others may need MPI 2.1 or higher.  You can
indicate this by adding a version constraint to the spec passed to
<code class="docutils literal notranslate"><span class="pre">provides</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">provides</span><span class="p">(</span><span class="s2">&quot;mpi@:2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose that the above <code class="docutils literal notranslate"><span class="pre">provides</span></code> call is in the <code class="docutils literal notranslate"><span class="pre">mpich2</span></code> package.
This says that <code class="docutils literal notranslate"><span class="pre">mpich2</span></code> provides MPI support <em>up to</em> version 2, but
if a package <code class="docutils literal notranslate"><span class="pre">depends_on(&quot;mpi&#64;3&quot;)</span></code>, then Spack will <em>not</em> build that
package with <code class="docutils literal notranslate"><span class="pre">mpich2</span></code>.</p>
</section>
<section id="provides-when">
<h3><code class="docutils literal notranslate"><span class="pre">provides</span> <span class="pre">when</span></code><a class="headerlink" href="#provides-when" title="Link to this heading"></a></h3>
<p>The same package may provide different versions of an interface
depending on <em>its</em> version.  Above, we simplified the <code class="docutils literal notranslate"><span class="pre">provides</span></code>
call in <code class="docutils literal notranslate"><span class="pre">mpich</span></code> to make the explanation easier.  In reality, this is
how <code class="docutils literal notranslate"><span class="pre">mpich</span></code> calls <code class="docutils literal notranslate"><span class="pre">provides</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">provides</span><span class="p">(</span><span class="s2">&quot;mpi@:3&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@3:&quot;</span><span class="p">)</span>
<span class="n">provides</span><span class="p">(</span><span class="s2">&quot;mpi@:1&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">when</span></code> argument to <code class="docutils literal notranslate"><span class="pre">provides</span></code> allows you to specify optional
constraints on the <em>providing</em> package, or the <em>provider</em>.  The
provider only provides the declared virtual spec when <em>it</em> matches
the constraints in the when clause.  Here, when <code class="docutils literal notranslate"><span class="pre">mpich</span></code> is at
version 3 or higher, it provides MPI up to version 3.  When <code class="docutils literal notranslate"><span class="pre">mpich</span></code>
is at version 1 or higher, it provides the MPI virtual package at
version 1.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">when</span></code> qualifier ensures that Spack selects a suitably high
version of <code class="docutils literal notranslate"><span class="pre">mpich</span></code> to satisfy some other package that <code class="docutils literal notranslate"><span class="pre">depends_on</span></code>
a particular version of MPI.  It will also prevent a user from
building with too low a version of <code class="docutils literal notranslate"><span class="pre">mpich</span></code>.  For example, suppose
the package <code class="docutils literal notranslate"><span class="pre">foo</span></code> declares this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;mpi@2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose a user invokes <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>foo<span class="w"> </span>^mpich@1.0
</pre></div>
</div>
<p>Spack will fail with a constraint violation, because the version of
MPICH requested is too low for the <code class="docutils literal notranslate"><span class="pre">mpi</span></code> requirement in <code class="docutils literal notranslate"><span class="pre">foo</span></code>.</p>
</section>
</section>
<section id="custom-attributes">
<span id="id12"></span><h2>Custom attributes<a class="headerlink" href="#custom-attributes" title="Link to this heading"></a></h2>
<p>Often a package will need to provide attributes for dependents to query
various details about what it provides.  While any number of custom defined
attributes can be implemented by a package, the four specific attributes
described below are always available on every package with default
implementations and the ability to customize with alternate implementations
in the case of virtual packages provided:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Purpose</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">home</span></code></p></td>
<td><p>The installation path for the package</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">spec.prefix</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">command</span></code></p></td>
<td><p>An executable command for the package</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">spec.name</span></code> found
in</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">.home.bin</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">headers</span></code></p></td>
<td><p>A list of headers provided by the package</p></td>
<td><div class="line-block">
<div class="line">All headers
searched</div>
<div class="line">recursively in
<code class="docutils literal notranslate"><span class="pre">.home.include</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">libs</span></code></p></td>
<td><p>A list of libraries provided by the package</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">lib{spec.name}</span></code>
searched</div>
<div class="line">recursively in
<code class="docutils literal notranslate"><span class="pre">.home</span></code> starting</div>
<div class="line">with <code class="docutils literal notranslate"><span class="pre">lib</span></code>,
<code class="docutils literal notranslate"><span class="pre">lib64</span></code>, then the</div>
<div class="line">rest of <code class="docutils literal notranslate"><span class="pre">.home</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Each of these can be customized by implementing the relevant attribute
as a <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> in the package’s class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="o">...</span>
<span class="linenos">3</span>    <span class="nd">@property</span>
<span class="linenos">4</span>    <span class="k">def</span> <span class="nf">libs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">5</span>        <span class="c1"># The library provided by Foo is libMyFoo.so</span>
<span class="linenos">6</span>        <span class="k">return</span> <span class="n">find_libraries</span><span class="p">(</span><span class="s2">&quot;libMyFoo&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>A package may also provide a custom implementation of each attribute
for the virtual packages it provides by implementing the
<code class="docutils literal notranslate"><span class="pre">virtualpackagename_attributename</span></code> property in the package’s class.
The implementation used is the first one found from:</p>
<ol class="arabic simple">
<li><p>Specialized virtual: <code class="docutils literal notranslate"><span class="pre">Package.virtualpackagename_attributename</span></code></p></li>
<li><p>Generic package: <code class="docutils literal notranslate"><span class="pre">Package.attributename</span></code></p></li>
<li><p>Default</p></li>
</ol>
<p>The use of customized attributes is demonstrated in the next example.</p>
<section id="example-customized-attributes-for-virtual-packages">
<h3>Example: Customized attributes for virtual packages<a class="headerlink" href="#example-customized-attributes-for-virtual-packages" title="Link to this heading"></a></h3>
<p>Consider a package <code class="docutils literal notranslate"><span class="pre">foo</span></code> that can optionally provide two virtual
packages <code class="docutils literal notranslate"><span class="pre">bar</span></code> and <code class="docutils literal notranslate"><span class="pre">baz</span></code>.  When both are enabled the installation tree
appears as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">include/foo.h</span>
<span class="go">include/bar/bar.h</span>
<span class="go">lib64/libFoo.so</span>
<span class="go">lib64/libFooBar.so</span>
<span class="go">baz/include/baz/baz.h</span>
<span class="go">baz/lib/libFooBaz.so</span>
</pre></div>
</div>
<p>The install tree shows that <code class="docutils literal notranslate"><span class="pre">foo</span></code> is providing the header <code class="docutils literal notranslate"><span class="pre">include/foo.h</span></code>
and library <code class="docutils literal notranslate"><span class="pre">lib64/libFoo.so</span></code> in its install prefix.  The virtual
package <code class="docutils literal notranslate"><span class="pre">bar</span></code> is providing <code class="docutils literal notranslate"><span class="pre">include/bar/bar.h</span></code> and library
<code class="docutils literal notranslate"><span class="pre">lib64/libFooBar.so</span></code>, also in <code class="docutils literal notranslate"><span class="pre">foo</span></code>’s install prefix.  The <code class="docutils literal notranslate"><span class="pre">baz</span></code>
package, however, is provided in the <code class="docutils literal notranslate"><span class="pre">baz</span></code> subdirectory of <code class="docutils literal notranslate"><span class="pre">foo</span></code>’s
prefix with the <code class="docutils literal notranslate"><span class="pre">include/baz/baz.h</span></code> header and <code class="docutils literal notranslate"><span class="pre">lib/libFooBaz.so</span></code>
library.  Such a package could implement the optional attributes as
follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="o">...</span>
<span class="linenos"> 3</span>    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable the Foo implementation of bar&quot;</span><span class="p">)</span>
<span class="linenos"> 4</span>    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable the Foo implementation of baz&quot;</span><span class="p">)</span>
<span class="linenos"> 5</span>    <span class="o">...</span>
<span class="linenos"> 6</span>    <span class="n">provides</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+bar&quot;</span><span class="p">)</span>
<span class="linenos"> 7</span>    <span class="n">provides</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+baz&quot;</span><span class="p">)</span>
<span class="linenos"> 8</span>    <span class="o">....</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="c1"># Just the foo headers</span>
<span class="linenos">11</span>    <span class="nd">@property</span>
<span class="linenos">12</span>    <span class="k">def</span> <span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">13</span>        <span class="k">return</span> <span class="n">find_headers</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">include</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">14</span>
<span class="linenos">15</span>    <span class="c1"># Just the foo libraries</span>
<span class="linenos">16</span>    <span class="nd">@property</span>
<span class="linenos">17</span>    <span class="k">def</span> <span class="nf">libs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">18</span>        <span class="k">return</span> <span class="n">find_libraries</span><span class="p">(</span><span class="s2">&quot;libFoo&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">19</span>
<span class="linenos">20</span>    <span class="c1"># The header provided by the bar virtual package</span>
<span class="linenos">21</span>    <span class="nd">@property</span>
<span class="linenos">22</span>    <span class="k">def</span> <span class="nf">bar_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">23</span>        <span class="k">return</span> <span class="n">find_headers</span><span class="p">(</span><span class="s2">&quot;bar/bar.h&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">include</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">24</span>
<span class="linenos">25</span>    <span class="c1"># The library provided by the bar virtual package</span>
<span class="linenos">26</span>    <span class="nd">@property</span>
<span class="linenos">27</span>    <span class="k">def</span> <span class="nf">bar_libs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">28</span>        <span class="k">return</span> <span class="n">find_libraries</span><span class="p">(</span><span class="s2">&quot;libFooBar&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">29</span>
<span class="linenos">30</span>    <span class="c1"># The baz virtual package home</span>
<span class="linenos">31</span>    <span class="nd">@property</span>
<span class="linenos">32</span>    <span class="k">def</span> <span class="nf">baz_home</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">33</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">baz</span>
<span class="linenos">34</span>
<span class="linenos">35</span>    <span class="c1"># The header provided by the baz virtual package</span>
<span class="linenos">36</span>    <span class="nd">@property</span>
<span class="linenos">37</span>    <span class="k">def</span> <span class="nf">baz_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">38</span>        <span class="k">return</span> <span class="n">find_headers</span><span class="p">(</span><span class="s2">&quot;baz/baz&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baz_home</span><span class="o">.</span><span class="n">include</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">39</span>
<span class="linenos">40</span>    <span class="c1"># The library provided by the baz virtual package</span>
<span class="linenos">41</span>    <span class="nd">@property</span>
<span class="linenos">42</span>    <span class="k">def</span> <span class="nf">baz_libs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">43</span>        <span class="k">return</span> <span class="n">find_libraries</span><span class="p">(</span><span class="s2">&quot;libFooBaz&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baz_home</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Now consider another package, <code class="docutils literal notranslate"><span class="pre">foo-app</span></code>, depending on all three:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">FooApp</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="o">...</span>
<span class="linenos">3</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="linenos">4</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
<span class="linenos">5</span>    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The resulting spec objects for it’s dependencies shows the result of
the above attribute implementations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The core headers and libraries of the foo package</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span>
<span class="n">foo</span><span class="o">@</span><span class="mf">1.0</span><span class="o">%</span><span class="n">gcc</span><span class="o">@</span><span class="mf">11.3.1</span><span class="o">+</span><span class="n">bar</span><span class="o">+</span><span class="n">baz</span> <span class="n">arch</span><span class="o">=</span><span class="n">linux</span><span class="o">-</span><span class="n">fedora35</span><span class="o">-</span><span class="n">haswell</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span>
<span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6&quot;</span>

<span class="c1"># home defaults to the package install prefix without an explicit implementation</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">home</span>
<span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6&quot;</span>

<span class="c1"># foo headers from the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">headers</span>
<span class="n">HeaderList</span><span class="p">([</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/include/foo.h&quot;</span><span class="p">,</span>
<span class="p">])</span>

<span class="c1"># foo include directories from the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">directories</span>
<span class="p">[</span><span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/include&quot;</span><span class="p">]</span>

<span class="c1"># foo libraries from the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span>
<span class="n">LibraryList</span><span class="p">([</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/lib64/libFoo.so&quot;</span><span class="p">,</span>
<span class="p">])</span>

<span class="c1"># foo library directories from the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">directories</span>
<span class="p">[</span><span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/lib64&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The virtual bar package in the same prefix as foo</span>

<span class="c1"># bar resolves to the foo package</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span>
<span class="n">foo</span><span class="o">@</span><span class="mf">1.0</span><span class="o">%</span><span class="n">gcc</span><span class="o">@</span><span class="mf">11.3.1</span><span class="o">+</span><span class="n">bar</span><span class="o">+</span><span class="n">baz</span> <span class="n">arch</span><span class="o">=</span><span class="n">linux</span><span class="o">-</span><span class="n">fedora35</span><span class="o">-</span><span class="n">haswell</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span>
<span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6&quot;</span>

<span class="c1"># home defaults to the foo prefix without either a Foo.bar_home</span>
<span class="c1"># or Foo.home implementation</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">home</span>
<span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6&quot;</span>

<span class="c1"># bar header in the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">headers</span>
<span class="n">HeaderList</span><span class="p">([</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/include/bar/bar.h&quot;</span>
<span class="p">])</span>

<span class="c1"># bar include dirs from the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">directories</span>
<span class="p">[</span><span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/include&quot;</span><span class="p">]</span>

<span class="c1"># bar library from the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span>
<span class="n">LibraryList</span><span class="p">([</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/lib64/libFooBar.so&quot;</span>
<span class="p">])</span>

<span class="c1"># bar library directories from the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">directories</span>
<span class="p">[</span><span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/lib64&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The virtual baz package in a subdirectory of foo&#39;s prefix</span>

<span class="c1"># baz resolves to the foo package</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">]</span>
<span class="n">foo</span><span class="o">@</span><span class="mf">1.0</span><span class="o">%</span><span class="n">gcc</span><span class="o">@</span><span class="mf">11.3.1</span><span class="o">+</span><span class="n">bar</span><span class="o">+</span><span class="n">baz</span> <span class="n">arch</span><span class="o">=</span><span class="n">linux</span><span class="o">-</span><span class="n">fedora35</span><span class="o">-</span><span class="n">haswell</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span>
<span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6&quot;</span>

<span class="c1"># baz_home implementation provides the subdirectory inside the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">home</span>
<span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/baz&quot;</span>

<span class="c1"># baz headers in the baz subdirectory of the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">headers</span>
<span class="n">HeaderList</span><span class="p">([</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/baz/include/baz/baz.h&quot;</span>
<span class="p">])</span>

<span class="c1"># baz include directories in the baz subdirectory of the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">directories</span>
<span class="p">[</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/baz/include&quot;</span>
<span class="p">]</span>

<span class="c1"># baz libraries in the baz subdirectory of the foo prefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span>
<span class="n">LibraryList</span><span class="p">([</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/baz/lib/libFooBaz.so&quot;</span>
<span class="p">])</span>

<span class="c1"># baz library directories in the baz subdirectory of the foo porefix</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">directories</span>
<span class="p">[</span>
    <span class="s2">&quot;/opt/spack/linux-fedora35-haswell/gcc-11.3.1/foo-1.0-ca3rczp5omy7dfzoqw4p7oc2yh3u7lt6/baz/lib&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="abstract-concrete-specs">
<span id="abstract-and-concrete"></span><h2>Abstract &amp; concrete specs<a class="headerlink" href="#abstract-concrete-specs" title="Link to this heading"></a></h2>
<p>Now that we’ve seen how spec constraints can be specified <a class="reference internal" href="basic_usage.html#sec-specs"><span class="std std-ref">on the
command line</span></a> and within package definitions, we can talk
about how Spack puts all of this information together.  When you run
this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>mpileaks<span class="w"> </span>^callpath@1.0+debug<span class="w"> </span>^libelf@0.8.11
</pre></div>
</div>
<p>Spack parses the command line and builds a spec from the description.
The spec says that <code class="docutils literal notranslate"><span class="pre">mpileaks</span></code> should be built with the <code class="docutils literal notranslate"><span class="pre">callpath</span></code>
library at 1.0 and with the debug option enabled, and with <code class="docutils literal notranslate"><span class="pre">libelf</span></code>
version 0.8.11.  Spack will also look at the <code class="docutils literal notranslate"><span class="pre">depends_on</span></code> calls in
all of these packages, and it will build a spec from that.  The specs
from the command line and the specs built from package descriptions
are then combined, and the constraints are checked against each other
to make sure they’re satisfiable.</p>
<p>What we have after this is done is called an <em>abstract spec</em>.  An
abstract spec is partially specified.  In other words, it could
describe more than one build of a package.  Spack does this to make
things easier on the user: they should only have to specify as much of
the package spec as they care about.  Here’s an example partial spec
DAG, based on the constraints above:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mpileaks
    ^callpath@1.0+debug
        ^dyninst
            ^libdwarf
                ^libelf@0.8.11
        ^mpi
</pre></div>
</div>
digraph {
    mpileaks -&gt; mpi
    mpileaks -&gt; &quot;callpath&#64;1.0+debug&quot; -&gt; mpi
    &quot;callpath&#64;1.0+debug&quot; -&gt; dyninst
    dyninst  -&gt; libdwarf -&gt; &quot;libelf&#64;0.8.11&quot;
    dyninst  -&gt; &quot;libelf&#64;0.8.11&quot;
}<p>This diagram shows a spec DAG output as a tree, where successive
levels of indentation represent a depends-on relationship.  In the
above DAG, we can see some packages annotated with their constraints,
and some packages with no annotations at all.  When there are no
annotations, it means the user doesn’t care what configuration of that
package is built, just so long as it works.</p>
<section id="concretization">
<h3>Concretization<a class="headerlink" href="#concretization" title="Link to this heading"></a></h3>
<p>An abstract spec is useful for the user, but you can’t install an
abstract spec.  Spack has to take the abstract spec and “fill in” the
remaining unspecified parts in order to install.  This process is
called <strong>concretization</strong>.  Concretization happens in between the time
the user runs <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> and the time the <code class="docutils literal notranslate"><span class="pre">install()</span></code> method
is called.  The concretized version of the spec above might look like
this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mpileaks@2.3%gcc@4.7.3 arch=linux-debian7-x86_64
    ^callpath@1.0%gcc@4.7.3+debug arch=linux-debian7-x86_64
        ^dyninst@8.1.2%gcc@4.7.3 arch=linux-debian7-x86_64
            ^libdwarf@20130729%gcc@4.7.3 arch=linux-debian7-x86_64
                ^libelf@0.8.11%gcc@4.7.3 arch=linux-debian7-x86_64
        ^mpich@3.0.4%gcc@4.7.3 arch=linux-debian7-x86_64
</pre></div>
</div>
digraph {
    &quot;mpileaks&#64;2.3\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot; -&gt; &quot;mpich&#64;3.0.4\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot;
    &quot;mpileaks&#64;2.3\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot; -&gt; &quot;callpath&#64;1.0\n%gcc&#64;4.7.3+debug\n arch=linux-debian7-x86_64&quot; -&gt; &quot;mpich&#64;3.0.4\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot;
    &quot;callpath&#64;1.0\n%gcc&#64;4.7.3+debug\n arch=linux-debian7-x86_64&quot; -&gt; &quot;dyninst&#64;8.1.2\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot;
    &quot;dyninst&#64;8.1.2\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot; -&gt; &quot;libdwarf&#64;20130729\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot; -&gt; &quot;libelf&#64;0.8.11\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot;
    &quot;dyninst&#64;8.1.2\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot; -&gt; &quot;libelf&#64;0.8.11\n%gcc&#64;4.7.3\n arch=linux-debian7-x86_64&quot;
}<p>Here, all versions, compilers, and platforms are filled in, and there
is a single version (no version ranges) for each package.  All
decisions about configuration have been made, and only after this
point will Spack call the <code class="docutils literal notranslate"><span class="pre">install()</span></code> method for your package.</p>
<p>Concretization in Spack is based on certain selection policies that
tell Spack how to select, e.g., a version, when one is not specified
explicitly.  Concretization policies are discussed in more detail in
<a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">Configuration Files</span></a>.  Sites using Spack can customize them to match
the preferences of their own users.</p>
</section>
<section id="spack-spec">
<span id="cmd-spack-spec"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">spec</span></code><a class="headerlink" href="#spack-spec" title="Link to this heading"></a></h3>
<p>For an arbitrary spec, you can see the result of concretization by
running <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">spec</span></code>.  For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>spec<span class="w"> </span>dyninst@8.0.1
<span class="go">dyninst@8.0.1</span>
<span class="go">    ^libdwarf</span>
<span class="go">        ^libelf</span>

<span class="gp">dyninst@8.0.1%</span>gcc@4.7.3<span class="w"> </span><span class="nv">arch</span><span class="o">=</span>linux-debian7-x86_64
<span class="go">    ^libdwarf@20130729%gcc@4.7.3 arch=linux-debian7-x86_64</span>
<span class="go">        ^libelf@0.8.13%gcc@4.7.3 arch=linux-debian7-x86_64</span>
</pre></div>
</div>
<p>This is useful when you want to know exactly what Spack will do when
you ask for a particular spec.</p>
</section>
<section id="concretization-policies">
<span id="id13"></span><h3><code class="docutils literal notranslate"><span class="pre">Concretization</span> <span class="pre">Policies</span></code><a class="headerlink" href="#concretization-policies" title="Link to this heading"></a></h3>
<p>A user may have certain preferences for how packages should
be concretized on their system.  For example, one user may prefer packages
built with OpenMPI and the Intel compiler.  Another user may prefer
packages be built with MVAPICH and GCC.</p>
<p>See the <a class="reference internal" href="packages_yaml.html#package-preferences"><span class="std std-ref">Package Preferences</span></a> section for more details.</p>
</section>
</section>
<section id="common-when-constraints">
<span id="group-when-spec"></span><h2>Common <code class="docutils literal notranslate"><span class="pre">when=</span></code> constraints<a class="headerlink" href="#common-when-constraints" title="Link to this heading"></a></h2>
<p>In case a package needs many directives to share the whole <code class="docutils literal notranslate"><span class="pre">when=</span></code>
argument, or just part of it, Spack allows you to group the common part
under a context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Gcc</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">when</span><span class="p">(</span><span class="s2">&quot;+nvptx&quot;</span><span class="p">):</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
        <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;@:6&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;NVPTX only supported in gcc 7 and above&quot;</span><span class="p">)</span>
        <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;languages=ada&quot;</span><span class="p">)</span>
        <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;languages=brig&quot;</span><span class="p">)</span>
        <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;languages=go&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The snippet above is equivalent to the more verbose:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Gcc</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>

    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+nvptx&quot;</span><span class="p">)</span>
    <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;@:6&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+nvptx&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;NVPTX only supported in gcc 7 and above&quot;</span><span class="p">)</span>
    <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;languages=ada&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+nvptx&quot;</span><span class="p">)</span>
    <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;languages=brig&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+nvptx&quot;</span><span class="p">)</span>
    <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;languages=go&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+nvptx&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Constraints stemming from the context are added to what is explicitly present in the
<code class="docutils literal notranslate"><span class="pre">when=</span></code> argument of a directive, so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">when</span><span class="p">(</span><span class="s2">&quot;+elpa&quot;</span><span class="p">):</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;elpa+openmp&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+openmp&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;elpa+openmp&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+openmp+elpa&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Constraints from nested context managers are also combined together, but they are rarely
needed or recommended.</p>
</section>
<section id="common-default-arguments">
<span id="default-args"></span><h2>Common default arguments<a class="headerlink" href="#common-default-arguments" title="Link to this heading"></a></h2>
<p>Similarly, if directives have a common set of default arguments, you can
group them together in a <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">default_args()</span></code> block:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PyExample</span><span class="p">(</span><span class="n">PythonPackage</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">default_args</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)):</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-foo&quot;</span><span class="p">)</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-foo@2:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2:&quot;</span><span class="p">)</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-bar&quot;</span><span class="p">)</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-bz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above is short for:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PyExample</span><span class="p">(</span><span class="n">PythonPackage</span><span class="p">):</span>

    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-foo&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">))</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-foo@2:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2:&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">))</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-bar&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">))</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;py-bz&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">when()</span></code> context manager is composable, while <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">default_args()</span></code>
merely overrides the default. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">default_args</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="s2">&quot;+feature&quot;</span><span class="p">):</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+baz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+feature&quot;</span><span class="p">)</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+feature&quot;</span><span class="p">)</span>
<span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+baz&quot;</span><span class="p">)</span>  <span class="c1"># Note: not when=&quot;+feature+baz&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="conflicting-specs">
<span id="install-method"></span><h2>Conflicting Specs<a class="headerlink" href="#conflicting-specs" title="Link to this heading"></a></h2>
<p>Suppose a user needs to install package C, which depends on packages A
and B.  Package A builds a library with a Python2 extension, and
package B builds a library with a Python3 extension.  Packages A and B
cannot be loaded together in the same Python runtime:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;enable python bindings&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@2.7&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+python&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c1"># do whatever is necessary to enable/disable python</span>
        <span class="c1"># bindings according to variant</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;enable python bindings&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;python@3.2:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;+python&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c1"># do whatever is necessary to enable/disable python</span>
        <span class="c1"># bindings according to variant</span>
</pre></div>
</div>
<p>Package C needs to use the libraries from packages A and B, but does
not need either of the Python extensions.  In this case, package C
should simply depend on the <code class="docutils literal notranslate"><span class="pre">~python</span></code> variant of A and B:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;A~python&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;B~python&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This may require that A or B be built twice, if the user wishes to use
the Python extensions provided by them: once for <code class="docutils literal notranslate"><span class="pre">+python</span></code> and once
for <code class="docutils literal notranslate"><span class="pre">~python</span></code>.  Other than using a little extra disk space, that
solution has no serious problems.</p>
</section>
<section id="overriding-build-system-defaults">
<span id="installation-process"></span><h2>Overriding build system defaults<a class="headerlink" href="#overriding-build-system-defaults" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you code a single class in <code class="docutils literal notranslate"><span class="pre">package.py</span></code> all the functions shown in the table below
can be implemented with the same signature on the <code class="docutils literal notranslate"><span class="pre">*Package</span></code> instead of the corresponding builder.</p>
</div>
<p>Most of the time the default implementation of methods or attributes in build system base classes
is what a packager needs, and just a very few entities need to be overwritten. Typically we just
need to override methods like <code class="docutils literal notranslate"><span class="pre">configure_args</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">configure_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--enable-cxx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_or_disable</span><span class="p">(</span><span class="s2">&quot;libs&quot;</span><span class="p">)</span>
     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;libs=static&quot;</span><span class="p">):</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--with-pic&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">args</span>
</pre></div>
</div>
<p>The actual set of entities available for overriding in <code class="docutils literal notranslate"><span class="pre">package.py</span></code> depend on
the build system. The build systems currently supported by Spack are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>API docs</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.generic" title="spack.build_systems.generic"><code class="xref py py-class docutils literal notranslate"><span class="pre">generic</span></code></a></p></td>
<td><p>Generic build system without any
base implementation</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.makefile" title="spack.build_systems.makefile"><code class="xref py py-class docutils literal notranslate"><span class="pre">makefile</span></code></a></p></td>
<td><p>Specialized build system for
software built invoking
hand-written Makefiles</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.autotools" title="spack.build_systems.autotools"><code class="xref py py-class docutils literal notranslate"><span class="pre">autotools</span></code></a></p></td>
<td><p>Specialized build system for
software built using
GNU Autotools</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.cmake" title="spack.build_systems.cmake"><code class="xref py py-class docutils literal notranslate"><span class="pre">cmake</span></code></a></p></td>
<td><p>Specialized build system for
software built using CMake</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.maven" title="spack.build_systems.maven"><code class="xref py py-class docutils literal notranslate"><span class="pre">maven</span></code></a></p></td>
<td><p>Specialized build system for
software built using Maven</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.meson" title="spack.build_systems.meson"><code class="xref py py-class docutils literal notranslate"><span class="pre">meson</span></code></a></p></td>
<td><p>Specialized build system for
software built using Meson</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.nmake" title="spack.build_systems.nmake"><code class="xref py py-class docutils literal notranslate"><span class="pre">nmake</span></code></a></p></td>
<td><p>Specialized build system for
software built using NMake</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.qmake" title="spack.build_systems.qmake"><code class="xref py py-class docutils literal notranslate"><span class="pre">qmake</span></code></a></p></td>
<td><p>Specialized build system for
software built using QMake</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.scons" title="spack.build_systems.scons"><code class="xref py py-class docutils literal notranslate"><span class="pre">scons</span></code></a></p></td>
<td><p>Specialized build system for
software built using SCons</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.waf" title="spack.build_systems.waf"><code class="xref py py-class docutils literal notranslate"><span class="pre">waf</span></code></a></p></td>
<td><p>Specialized build system for
software built using Waf</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.r" title="spack.build_systems.r"><code class="xref py py-class docutils literal notranslate"><span class="pre">r</span></code></a></p></td>
<td><p>Specialized build system for
R extensions</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.octave" title="spack.build_systems.octave"><code class="xref py py-class docutils literal notranslate"><span class="pre">octave</span></code></a></p></td>
<td><p>Specialized build system for
Octave packages</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.python" title="spack.build_systems.python"><code class="xref py py-class docutils literal notranslate"><span class="pre">python</span></code></a></p></td>
<td><p>Specialized build system for
Python extensions</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.perl" title="spack.build_systems.perl"><code class="xref py py-class docutils literal notranslate"><span class="pre">perl</span></code></a></p></td>
<td><p>Specialized build system for
Perl extensions</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.ruby" title="spack.build_systems.ruby"><code class="xref py py-class docutils literal notranslate"><span class="pre">ruby</span></code></a></p></td>
<td><p>Specialized build system for
Ruby extensions</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.intel" title="spack.build_systems.intel"><code class="xref py py-class docutils literal notranslate"><span class="pre">intel</span></code></a></p></td>
<td><p>Specialized build system for
licensed Intel software</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.oneapi" title="spack.build_systems.oneapi"><code class="xref py py-class docutils literal notranslate"><span class="pre">oneapi</span></code></a></p></td>
<td><p>Specialized build system for
Intel oneAPI software</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#module-spack.build_systems.aspell_dict" title="spack.build_systems.aspell_dict"><code class="xref py py-class docutils literal notranslate"><span class="pre">aspell_dict</span></code></a></p></td>
<td><p>Specialized build system for
Aspell dictionaries</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>Choice of the appropriate base class for a package</dt><dd><p>In most cases packagers don’t have to worry about the selection of the right base class
for a package, as <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">create</span></code> will make the appropriate choice on their behalf. In those
rare cases where manual intervention is needed we need to stress that a
package base class depends on the <em>build system</em> being used, not the language of the package.
For example, a Python extension installed with CMake would <code class="docutils literal notranslate"><span class="pre">extends(&quot;python&quot;)</span></code> and
subclass from <a class="reference internal" href="spack.build_systems.html#spack.build_systems.cmake.CMakePackage" title="spack.build_systems.cmake.CMakePackage"><code class="xref py py-class docutils literal notranslate"><span class="pre">CMakePackage</span></code></a>.</p>
</dd>
</dl>
</div>
<section id="overriding-builder-methods">
<h3>Overriding builder methods<a class="headerlink" href="#overriding-builder-methods" title="Link to this heading"></a></h3>
<p>Build-system “phases” have default implementations that fit most of the common cases:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="linenos"> 2</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run &quot;configure&quot;, with the arguments specified by the builder and an</span>
<span class="linenos"> 3</span><span class="sd">        appropriately set prefix.</span>
<span class="linenos"> 4</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 5</span>        <span class="n">options</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg</span><span class="p">,</span> <span class="s2">&quot;configure_flag_args&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="linenos"> 6</span>        <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--prefix=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
<span class="linenos"> 7</span>        <span class="n">options</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_args</span><span class="p">()</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">working_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_directory</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos">10</span>            <span class="n">pkg</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>It is usually sufficient for a packager to override a few
build system specific helper methods or attributes to provide, for instance,
configure arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>    <span class="k">def</span> <span class="nf">configure_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 2</span>        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
<span class="linenos"> 3</span>        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--enable-c++&quot;</span><span class="p">]</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2">ce@9:&quot;</span><span class="p">):</span>
<span class="linenos"> 6</span>            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LDFLAGS=-rtlib=compiler-rt&quot;</span><span class="p">)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>        <span class="k">if</span> <span class="p">(</span>
<span class="linenos"> 9</span>            <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2">lang&quot;</span><span class="p">)</span>
<span class="linenos">10</span>            <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">occ&quot;</span><span class="p">)</span>
<span class="linenos">11</span>            <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">rm&quot;</span><span class="p">)</span>
<span class="linenos">12</span>            <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">j&quot;</span><span class="p">)</span>
<span class="linenos">13</span>        <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;platform=darwin&quot;</span><span class="p">):</span>
<span class="linenos">14</span>            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LDFLAGS=-rtlib=compiler-rt&quot;</span><span class="p">)</span>
<span class="linenos">15</span>
<span class="linenos">16</span>        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">ntel@:18&quot;</span><span class="p">):</span>
<span class="linenos">17</span>            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;CFLAGS=-no-gcc&quot;</span><span class="p">)</span>
<span class="linenos">18</span>
<span class="linenos">19</span>        <span class="k">if</span> <span class="s2">&quot;+sigsegv&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
<span class="linenos">20</span>            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--with-libsigsegv-prefix=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;libsigsegv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
<span class="linenos">21</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">22</span>            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--without-libsigsegv-prefix&quot;</span><span class="p">)</span>
<span class="linenos">23</span>
<span class="linenos">24</span>        <span class="c1"># https://lists.gnu.org/archive/html/bug-m4/2016-09/msg00002.html</span>
<span class="linenos">25</span>        <span class="n">arch</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span>
<span class="linenos">26</span>        <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span> <span class="ow">and</span> <span class="n">arch</span><span class="o">.</span><span class="n">os</span> <span class="o">==</span> <span class="s2">&quot;sierra&quot;</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">cc&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
<span class="linenos">27</span>            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ac_cv_type_struct_sched_param=yes&quot;</span><span class="p">)</span>
<span class="linenos">28</span>
<span class="linenos">29</span>        <span class="k">return</span> <span class="n">args</span>
</pre></div>
</div>
<p>Each specific build system has a list of attributes and methods that can be overridden to
fine-tune the installation of a package without overriding an entire phase. To
have more information on them the place to go is the API docs of the <a class="reference internal" href="spack.build_systems.html#module-spack.build_systems" title="spack.build_systems"><code class="xref py py-mod docutils literal notranslate"><span class="pre">build_systems</span></code></a>
module.</p>
</section>
<section id="overriding-an-entire-phase">
<h3>Overriding an entire phase<a class="headerlink" href="#overriding-an-entire-phase" title="Link to this heading"></a></h3>
<p>Sometimes it is necessary to override an entire phase. If the <code class="docutils literal notranslate"><span class="pre">package.py</span></code> contains
a single class recipe, see <a class="reference internal" href="#package-class-structure"><span class="std std-ref">Package class architecture</span></a>, then the signature for a
phase is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Openjpeg</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>regardless of the build system. The arguments for the phase are:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self</span></code></dt><dd><p>This is the package object, which extends <code class="docutils literal notranslate"><span class="pre">CMakePackage</span></code>.
For API docs on Package objects, see
<a class="reference internal" href="spack.html#spack.package_base.PackageBase" title="spack.package_base.PackageBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">Package</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">spec</span></code></dt><dd><p>This is the concrete spec object created by Spack from an
abstract spec supplied by the user.  It describes what should be
installed.  It will be of type <a class="reference internal" href="spack.html#spack.spec.Spec" title="spack.spec.Spec"><code class="xref py py-class docutils literal notranslate"><span class="pre">Spec</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">prefix</span></code></dt><dd><p>This is the path that your install method should copy build
targets into.  It acts like a string, but it’s actually its own
special type, <a class="reference internal" href="spack.util.html#spack.util.prefix.Prefix" title="spack.util.prefix.Prefix"><code class="xref py py-class docutils literal notranslate"><span class="pre">Prefix</span></code></a>.</p>
</dd>
</dl>
<p>The arguments <code class="docutils literal notranslate"><span class="pre">spec</span></code> and <code class="docutils literal notranslate"><span class="pre">prefix</span></code> are passed only for convenience, as they always
correspond to <code class="docutils literal notranslate"><span class="pre">self.spec</span></code> and <code class="docutils literal notranslate"><span class="pre">self.spec.prefix</span></code> respectively.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">package.py</span></code> has build instructions in a separate
<a class="reference internal" href="#multiple-build-systems"><span class="std std-ref">builder class</span></a>, the signature for a phase changes slightly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CMakeBuilder</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">cmake</span><span class="o">.</span><span class="n">CMakeBuilder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>In this case the package is passed as the second argument, and <code class="docutils literal notranslate"><span class="pre">self</span></code> is the builder instance.</p>
</section>
<section id="mixin-base-classes">
<h3>Mixin base classes<a class="headerlink" href="#mixin-base-classes" title="Link to this heading"></a></h3>
<p>Besides build systems, there are other cases where common metadata and behavior can be extracted
and reused by many packages. For instance, packages that depend on <code class="docutils literal notranslate"><span class="pre">Cuda</span></code> or <code class="docutils literal notranslate"><span class="pre">Rocm</span></code>, share
common dependencies and constraints. To factor these attributes into a single place, Spack provides
a few mixin classes in the <code class="docutils literal notranslate"><span class="pre">spack.build_systems</span></code> module:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>API docs</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#spack.build_systems.cuda.CudaPackage" title="spack.build_systems.cuda.CudaPackage"><code class="xref py py-class docutils literal notranslate"><span class="pre">CudaPackage</span></code></a></p></td>
<td><p>A helper class for packages that
use CUDA</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#spack.build_systems.rocm.ROCmPackage" title="spack.build_systems.rocm.ROCmPackage"><code class="xref py py-class docutils literal notranslate"><span class="pre">ROCmPackage</span></code></a></p></td>
<td><p>A helper class for packages that
use ROCm</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#spack.build_systems.gnu.GNUMirrorPackage" title="spack.build_systems.gnu.GNUMirrorPackage"><code class="xref py py-class docutils literal notranslate"><span class="pre">GNUMirrorPackage</span></code></a></p></td>
<td><p>A helper class for GNU packages</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#spack.build_systems.python.PythonExtension" title="spack.build_systems.python.PythonExtension"><code class="xref py py-class docutils literal notranslate"><span class="pre">PythonExtension</span></code></a></p></td>
<td><p>A helper class for Python
extensions</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#spack.build_systems.sourceforge.SourceforgePackage" title="spack.build_systems.sourceforge.SourceforgePackage"><code class="xref py py-class docutils literal notranslate"><span class="pre">SourceforgePackage</span></code></a></p></td>
<td><p>A helper class for packages
from sourceforge.org</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="spack.build_systems.html#spack.build_systems.sourceware.SourcewarePackage" title="spack.build_systems.sourceware.SourcewarePackage"><code class="xref py py-class docutils literal notranslate"><span class="pre">SourcewarePackage</span></code></a></p></td>
<td><p>A helper class for packages
from sourceware.org</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="spack.build_systems.html#spack.build_systems.xorg.XorgPackage" title="spack.build_systems.xorg.XorgPackage"><code class="xref py py-class docutils literal notranslate"><span class="pre">XorgPackage</span></code></a></p></td>
<td><p>A helper class for x.org
packages</p></td>
</tr>
</tbody>
</table>
<p>These classes should be used by adding them to the inheritance tree of the package that needs them,
for instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Cp2k</span><span class="p">(</span><span class="n">MakefilePackage</span><span class="p">,</span> <span class="n">CudaPackage</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CP2K is a quantum chemistry and solid state physics software package</span>
<span class="sd">    that can perform atomistic simulations of solid state, liquid, molecular,</span>
<span class="sd">    periodic, material, crystal, and biological systems</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>In the example above <code class="docutils literal notranslate"><span class="pre">Cp2k</span></code> inherits all the conflicts and variants that <code class="docutils literal notranslate"><span class="pre">CudaPackage</span></code> defines.</p>
</section>
</section>
<section id="multiple-build-systems">
<span id="id14"></span><h2>Multiple build systems<a class="headerlink" href="#multiple-build-systems" title="Link to this heading"></a></h2>
<p>There are cases where a package actively supports two build systems, or changes build systems
as it evolves, or needs different build systems on different platforms. Spack allows dealing with
these cases by splitting the build instructions into separate builder classes.</p>
<p>For instance, software that supports two build systems unconditionally should derive from
both <code class="docutils literal notranslate"><span class="pre">*Package</span></code> base classes, and declare the possible use of multiple build systems using
a directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">,</span> <span class="n">AutotoolsPackage</span><span class="p">):</span>

    <span class="n">variant</span><span class="p">(</span><span class="s2">&quot;my_feature&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">build_system</span><span class="p">(</span><span class="s2">&quot;cmake&quot;</span><span class="p">,</span> <span class="s2">&quot;autotools&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;cmake&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case the software can be built with both <code class="docutils literal notranslate"><span class="pre">autotools</span></code> and <code class="docutils literal notranslate"><span class="pre">cmake</span></code>. Since the package
supports multiple build systems, it is necessary to declare which one is the default.</p>
<p>Additional build instructions are split into separate builder classes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CMakeBuilder</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">cmake</span><span class="o">.</span><span class="n">CMakeBuilder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cmake_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define_from_variant</span><span class="p">(</span><span class="s2">&quot;MY_FEATURE&quot;</span><span class="p">,</span> <span class="s2">&quot;my_feature&quot;</span><span class="p">)</span>
        <span class="p">]</span>

<span class="k">class</span> <span class="nc">AutotoolsBuilder</span><span class="p">(</span><span class="n">spack</span><span class="o">.</span><span class="n">build_systems</span><span class="o">.</span><span class="n">autotools</span><span class="o">.</span><span class="n">AutotoolsBuilder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">configure_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_or_without</span><span class="p">(</span><span class="s2">&quot;my-feature&quot;</span><span class="p">,</span> <span class="n">variant</span><span class="o">=</span><span class="s2">&quot;my_feature&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">example</span> <span class="pre">+feature</span> <span class="pre">build_sytem=cmake</span></code>  will
pick the <code class="docutils literal notranslate"><span class="pre">CMakeBuilder</span></code> and invoke <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">-DMY_FEATURE:BOOL=ON</span></code>.</p>
<p>Similarly, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">example</span> <span class="pre">+feature</span> <span class="pre">build_system=autotools</span></code> will pick
the  <code class="docutils literal notranslate"><span class="pre">AutotoolsBuilder</span></code> and invoke <code class="docutils literal notranslate"><span class="pre">./configure</span> <span class="pre">--with-my-feature</span></code>.</p>
<p>Dependencies are always specified in the package class. When some dependencies
depend on the choice of the build system, it is possible to use when conditions as
usual:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">,</span> <span class="n">AutotoolsPackage</span><span class="p">):</span>

    <span class="n">build_system</span><span class="p">(</span><span class="s2">&quot;cmake&quot;</span><span class="p">,</span> <span class="s2">&quot;autotools&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;cmake&quot;</span><span class="p">)</span>

    <span class="c1"># Runtime dependencies</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;ncurses&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;libxml2&quot;</span><span class="p">)</span>

    <span class="c1"># Lowerbounds for cmake only apply when using cmake as the build system</span>
    <span class="k">with</span> <span class="n">when</span><span class="p">(</span><span class="s2">&quot;build_system=cmake&quot;</span><span class="p">):</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;cmake@3.18:&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2.0:&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;cmake@3:&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>

    <span class="c1"># Specify extra build dependencies used only in the configure script</span>
    <span class="k">with</span> <span class="n">when</span><span class="p">(</span><span class="s2">&quot;build_system=autotools&quot;</span><span class="p">):</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;perl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>
        <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;pkgconfig&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Very often projects switch from one build system to another, or add support
for a new build system from a certain version, which means that the choice
of the build system typically depends on a version range. Those situations can
be handled by using conditional values in the <code class="docutils literal notranslate"><span class="pre">build_system</span></code> directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">,</span> <span class="n">AutotoolsPackage</span><span class="p">):</span>

    <span class="n">build_system</span><span class="p">(</span>
        <span class="n">conditional</span><span class="p">(</span><span class="s2">&quot;cmake&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@0.64:&quot;</span><span class="p">),</span>
        <span class="n">conditional</span><span class="p">(</span><span class="s2">&quot;autotools&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:0.63&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;cmake&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>In the example the directive impose a change from <code class="docutils literal notranslate"><span class="pre">Autotools</span></code> to <code class="docutils literal notranslate"><span class="pre">CMake</span></code> going
from <code class="docutils literal notranslate"><span class="pre">v0.63</span></code> to <code class="docutils literal notranslate"><span class="pre">v0.64</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">build_system</span></code> can be used as an ordinary variant, which also means that it can
be used in <code class="docutils literal notranslate"><span class="pre">depends_on</span></code> statements. This can be useful when a package <em>requires</em> that
its dependency has a CMake config file, meaning that the dependent can only build when the
dependency is built with CMake, and not Autotools. In that case, you can force the choice
of the build system in the dependent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Dependent</span><span class="p">(</span><span class="n">CMakePackage</span><span class="p">):</span>

    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;example build_system=cmake&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-build-environment">
<span id="install-environment"></span><h2>The build environment<a class="headerlink" href="#the-build-environment" title="Link to this heading"></a></h2>
<p>In general, you should not have to do much differently in your install
method than you would when installing a package on the command line.
In fact, you may need to do <em>less</em> than you would on the command line.</p>
<p>Spack tries to set environment variables and modify compiler calls so
that it <em>appears</em> to the build system that you’re building with a
standard system install of everything.  Obviously that’s not going to
cover <em>all</em> build systems, but it should make it easy to port packages
to Spack if they use a standard build system.  Usually with autotools
or cmake, building and installing is easy.  With builds that use
custom Makefiles, you may need to add logic to modify the makefiles.</p>
<p>The remainder of the section covers the way Spack’s build environment
works.</p>
<section id="forking-install">
<h3>Forking <code class="docutils literal notranslate"><span class="pre">install()</span></code><a class="headerlink" href="#forking-install" title="Link to this heading"></a></h3>
<p>To give packagers free reign over their install environment, Spack forks
a new process each time it invokes a package’s <code class="docutils literal notranslate"><span class="pre">install()</span></code> method.
This allows packages to have a sandboxed build environment, without
impacting the environments ofother jobs that the main Spack process runs.
Packages are free to change the environment or to modify Spack internals,
because each <code class="docutils literal notranslate"><span class="pre">install()</span></code> call has its own dedicated process.</p>
</section>
<section id="environment-variables">
<h3>Environment variables<a class="headerlink" href="#environment-variables" title="Link to this heading"></a></h3>
<p>Spack sets a number of standard environment variables that serve two
purposes:</p>
<ol class="arabic simple">
<li><p>Make build systems use Spack’s compiler wrappers for their builds.</p></li>
<li><p>Allow build systems to find dependencies more easily</p></li>
</ol>
<p>The Compiler environment variables that Spack sets are:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CC</span></code></p></td>
<td><p>C compiler</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CXX</span></code></p></td>
<td><p>C++ compiler</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">F77</span></code></p></td>
<td><p>Fortran 77 compiler</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">FC</span></code></p></td>
<td><p>Fortran 90 and above compiler</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Spack sets these variables so that they point to <em>compiler
wrappers</em>. These are covered in <a class="reference internal" href="#compiler-wrappers"><span class="std std-ref">their own section</span></a> below.</p>
<p>All of these are standard variables respected by most build systems.
If your project uses <code class="docutils literal notranslate"><span class="pre">Autotools</span></code> or <code class="docutils literal notranslate"><span class="pre">CMake</span></code>, then it should pick
them up automatically when you run <code class="docutils literal notranslate"><span class="pre">configure</span></code> or <code class="docutils literal notranslate"><span class="pre">cmake</span></code> in the
<code class="docutils literal notranslate"><span class="pre">install()</span></code> function.  Many traditional builds using GNU Make and
BSD make also respect these variables, so they may work with these
systems.</p>
<p>If your build system does <em>not</em> automatically pick these variables up
from the environment, then you can simply pass them on the command
line or use a patch as part of your build process to get the correct
compilers into the project’s build system.  There are also some file
editing commands you can use – these are described later in the
<a class="reference internal" href="#file-manipulation">section on file manipulation</a>.</p>
<p>In addition to the compiler variables, these variables are set before
entering <code class="docutils literal notranslate"><span class="pre">install()</span></code> so that packages can locate dependencies
easily:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">PATH</span></code></p></td>
<td><p>Set to point to <code class="docutils literal notranslate"><span class="pre">/bin</span></code> directories of dependencies</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code></p></td>
<td><p>Path to dependency prefixes for CMake</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">PKG_CONFIG_PATH</span></code></p></td>
<td><p>Path to any pkgconfig directories for dependencies</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></p></td>
<td><p>Path to site-packages dir of any python dependencies</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">PATH</span></code> is set up to point to dependencies <code class="docutils literal notranslate"><span class="pre">/bin</span></code> directories so
that you can use tools installed by dependency packages at build time.
For example, <code class="docutils literal notranslate"><span class="pre">$MPICH_ROOT/bin/mpicc</span></code> is frequently used by dependencies of
<code class="docutils literal notranslate"><span class="pre">mpich</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code> contains a colon-separated list of prefixes
where <code class="docutils literal notranslate"><span class="pre">cmake</span></code> will search for dependency libraries and headers.
This causes all standard CMake find commands to look in the paths of
your dependencies, so you <em>do not</em> have to manually specify arguments
like <code class="docutils literal notranslate"><span class="pre">-DDEPENDENCY_DIR=/path/to/dependency</span></code> to <code class="docutils literal notranslate"><span class="pre">cmake</span></code>.  More on
this is <a class="reference external" href="http://www.cmake.org/cmake/help/v3.0/variable/CMAKE_PREFIX_PATH.html">in the CMake documentation</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">PKG_CONFIG_PATH</span></code> is for packages that attempt to discover
dependencies using the GNU <code class="docutils literal notranslate"><span class="pre">pkg-config</span></code> tool.  It is similar to
<code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code> in that it allows a build to automatically
discover its dependencies.</p>
<p>If you want to see the environment that a package will build with, or
if you want to run commands in that environment to test them out, you
can use the <a class="reference internal" href="#cmd-spack-build-env"><span class="std std-ref">spack build-env</span></a> command, documented
below.</p>
</section>
<section id="failing-the-build">
<h3>Failing the build<a class="headerlink" href="#failing-the-build" title="Link to this heading"></a></h3>
<p>Sometimes you don’t want a package to successfully install unless some
condition is true.  You can explicitly cause the build to fail from
<code class="docutils literal notranslate"><span class="pre">install()</span></code> by raising an <code class="docutils literal notranslate"><span class="pre">InstallError</span></code>, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;darwin&quot;</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">InstallError</span><span class="p">(</span><span class="s2">&quot;This package does not build on Mac OS X!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="shell-command-functions">
<span id="shell-wrappers"></span><h3>Shell command functions<a class="headerlink" href="#shell-command-functions" title="Link to this heading"></a></h3>
<p>Recall the install method from <code class="docutils literal notranslate"><span class="pre">libelf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="linenos">2</span>        <span class="n">make</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Normally in Python, you’d have to write something like this in order
to execute shell commands:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;--prefix=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
</pre></div>
</div>
<p>We’ve tried to make this a bit easier by providing callable wrapper
objects for some shell commands.  By default, <code class="docutils literal notranslate"><span class="pre">configure</span></code>,
<code class="docutils literal notranslate"><span class="pre">cmake</span></code>, and <code class="docutils literal notranslate"><span class="pre">make</span></code> wrappers are are provided, so you can call
them more naturally in your package files.</p>
<p>If you need other commands, you can use <code class="docutils literal notranslate"><span class="pre">which</span></code> to get them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sed</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;sed&quot;</span><span class="p">)</span>
<span class="n">sed</span><span class="p">(</span><span class="s2">&quot;s/foo/bar/&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">which</span></code> function will search the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> for the application.</p>
<p>Callable wrappers also allow spack to provide some special features.
For example, in Spack, <code class="docutils literal notranslate"><span class="pre">make</span></code> is parallel by default, and Spack
figures out the number of cores on your machine and passes an
appropriate value for <code class="docutils literal notranslate"><span class="pre">-j&lt;numjobs&gt;</span></code> when it calls <code class="docutils literal notranslate"><span class="pre">make</span></code> (see the
<code class="docutils literal notranslate"><span class="pre">parallel</span></code> <cite>package attribute &lt;attribute_parallel&gt;</cite>).  In
a package file, you can supply a keyword argument, <code class="docutils literal notranslate"><span class="pre">parallel=False</span></code>,
to the <code class="docutils literal notranslate"><span class="pre">make</span></code> wrapper to disable parallel make.  In the <code class="docutils literal notranslate"><span class="pre">libelf</span></code>
package, this allows us to avoid race conditions in the library’s
build system.</p>
</section>
<section id="compiler-flags">
<h3>Compiler flags<a class="headerlink" href="#compiler-flags" title="Link to this heading"></a></h3>
<p>Compiler flags set by the user through the Spec object can be passed
to the build in one of three ways. By default, the build environment
injects these flags directly into the compiler commands using Spack’s
compiler wrappers. In cases where the build system requires knowledge
of the compiler flags, they can be registered with the build system by
alternatively passing them through environment variables or as build
system arguments. The flag_handler method can be used to change this
behavior.</p>
<p>Packages can override the flag_handler method with one of three
built-in flag_handlers. The built-in flag_handlers are named
<code class="docutils literal notranslate"><span class="pre">inject_flags</span></code>, <code class="docutils literal notranslate"><span class="pre">env_flags</span></code>, and <code class="docutils literal notranslate"><span class="pre">build_system_flags</span></code>. The
<code class="docutils literal notranslate"><span class="pre">inject_flags</span></code> method is the default. The <code class="docutils literal notranslate"><span class="pre">env_flags</span></code> method puts
all of the flags into the environment variables that <code class="docutils literal notranslate"><span class="pre">make</span></code> uses as
implicit variables (“CFLAGS”, “CXXFLAGS”, etc.). The
<code class="docutils literal notranslate"><span class="pre">build_system_flags</span></code> method adds the flags as
arguments to the invocation of <code class="docutils literal notranslate"><span class="pre">configure</span></code> or <code class="docutils literal notranslate"><span class="pre">cmake</span></code>,
respectively.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Passing compiler flags using build system arguments is only
supported for CMake and Autotools packages. Individual packages may
also differ in whether they properly respect these arguments.</p>
</div>
<p>Individual packages may also define their own <code class="docutils literal notranslate"><span class="pre">flag_handler</span></code>
methods. The <code class="docutils literal notranslate"><span class="pre">flag_handler</span></code> method takes the package instance
(<code class="docutils literal notranslate"><span class="pre">self</span></code>), the name of the flag, and a list of the values of the
flag. It will be called on each of the six compiler flags supported in
Spack. It should return a triple of <code class="docutils literal notranslate"><span class="pre">(injf,</span> <span class="pre">envf,</span> <span class="pre">bsf)</span></code> where
<code class="docutils literal notranslate"><span class="pre">injf</span></code> is a list of flags to inject via the Spack compiler wrappers,
<code class="docutils literal notranslate"><span class="pre">envf</span></code> is a list of flags to set in the appropriate environment
variables, and <code class="docutils literal notranslate"><span class="pre">bsf</span></code> is a list of flags to pass to the build system
as arguments.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Passing a non-empty list of flags to <code class="docutils literal notranslate"><span class="pre">bsf</span></code> for a build system
that does not support build system arguments will result in an
error.</p>
</div>
<p>Here are the definitions of the three built-in flag handlers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inject_flags</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">env_flags</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build_system_flags</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Returning <code class="docutils literal notranslate"><span class="pre">[]</span></code> and <code class="docutils literal notranslate"><span class="pre">None</span></code> are equivalent in a <code class="docutils literal notranslate"><span class="pre">flag_handler</span></code>
method.</p>
</div>
<p>Packages can override the default behavior either by specifying one of
the built-in flag handlers,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">flag_handler</span> <span class="o">=</span> <span class="n">env_flags</span>
</pre></div>
</div>
<p>or by implementing the flag_handler method. Suppose for a package
<code class="docutils literal notranslate"><span class="pre">Foo</span></code> we need to pass <code class="docutils literal notranslate"><span class="pre">cflags</span></code>, <code class="docutils literal notranslate"><span class="pre">cxxflags</span></code>, and <code class="docutils literal notranslate"><span class="pre">cppflags</span></code>
through the environment, the rest of the flags through compiler
wrapper injection, and we need to add <code class="docutils literal notranslate"><span class="pre">-lbar</span></code> to <code class="docutils literal notranslate"><span class="pre">ldlibs</span></code>. The
following flag handler method accomplishes that.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flag_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cflags&quot;</span><span class="p">,</span> <span class="s2">&quot;cxxflags&quot;</span><span class="p">,</span> <span class="s2">&quot;cppflags&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;ldlibs&quot;</span><span class="p">:</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-lbar&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Because these methods can pass values through environment variables,
it is important not to override these variables unnecessarily
(E.g. setting <code class="docutils literal notranslate"><span class="pre">env[&quot;CFLAGS&quot;]</span></code>) in other package methods when using
non-default flag handlers. In the <code class="docutils literal notranslate"><span class="pre">setup_environment</span></code> and
<code class="docutils literal notranslate"><span class="pre">setup_dependent_environment</span></code> methods, use the <code class="docutils literal notranslate"><span class="pre">append_flags</span></code>
method of the <code class="docutils literal notranslate"><span class="pre">EnvironmentModifications</span></code> class to append values to a
list of flags whenever the flag handler is <code class="docutils literal notranslate"><span class="pre">env_flags</span></code>. If the
package passes flags through the environment or the build system
manually (in the install method, for example), we recommend using the
default flag handler, or removing manual references and implementing a
custom flag handler method that adds the desired flags to export as
environment variables or pass to the build system. Manual flag passing
is likely to interfere with the <code class="docutils literal notranslate"><span class="pre">env_flags</span></code> and
<code class="docutils literal notranslate"><span class="pre">build_system_flags</span></code> methods.</p>
<p>In rare circumstances such as compiling and running small unit tests, a
package developer may need to know what are the appropriate compiler
flags to enable features like <code class="docutils literal notranslate"><span class="pre">OpenMP</span></code>, <code class="docutils literal notranslate"><span class="pre">c++11</span></code>, <code class="docutils literal notranslate"><span class="pre">c++14</span></code> and
alike. To that end the compiler classes in <code class="docutils literal notranslate"><span class="pre">spack</span></code> implement the
following <strong>properties</strong>: <code class="docutils literal notranslate"><span class="pre">openmp_flag</span></code>, <code class="docutils literal notranslate"><span class="pre">cxx98_flag</span></code>, <code class="docutils literal notranslate"><span class="pre">cxx11_flag</span></code>,
<code class="docutils literal notranslate"><span class="pre">cxx14_flag</span></code>, and <code class="docutils literal notranslate"><span class="pre">cxx17_flag</span></code>, which can be accessed in a package by
<code class="docutils literal notranslate"><span class="pre">self.compiler.cxx11_flag</span></code> and alike. Note that the implementation is
such that if a given compiler version does not support this feature, an
error will be produced. Therefore package developers can also use these
properties to assert that a compiler supports the requested feature. This
is handy when a package supports additional variants like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variant</span><span class="p">(</span><span class="s2">&quot;openmp&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable OpenMP support.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="blas-lapack-and-scalapack-libraries">
<span id="blas-lapack-scalapack"></span><h3>Blas, Lapack and ScaLapack libraries<a class="headerlink" href="#blas-lapack-and-scalapack-libraries" title="Link to this heading"></a></h3>
<p>Multiple packages provide implementations of <code class="docutils literal notranslate"><span class="pre">Blas</span></code>, <code class="docutils literal notranslate"><span class="pre">Lapack</span></code> and <code class="docutils literal notranslate"><span class="pre">ScaLapack</span></code>
routines.  The names of the resulting static and/or shared libraries
differ from package to package. In order to make the <code class="docutils literal notranslate"><span class="pre">install()</span></code> method
independent of the choice of <code class="docutils literal notranslate"><span class="pre">Blas</span></code> implementation, each package which
provides it implements <code class="docutils literal notranslate"><span class="pre">&#64;property</span> <span class="pre">def</span> <span class="pre">blas_libs(self):</span></code> to return an object
of
<a class="reference external" href="https://spack.readthedocs.io/en/latest/llnl.util.html#llnl.util.filesystem.LibraryList">LibraryList</a>
type which simplifies usage of a set of libraries.
The same applies to packages which provide <code class="docutils literal notranslate"><span class="pre">Lapack</span></code> and <code class="docutils literal notranslate"><span class="pre">ScaLapack</span></code>.
Package developers are requested to use this interface. Common usage cases are:</p>
<ol class="arabic simple">
<li><p>Space separated list of full paths</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lapack_blas</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;lapack&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span> <span class="o">+</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;blas&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span>
<span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
   <span class="s2">&quot;--with-blas-lapack-lib=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lapack_blas</span><span class="o">.</span><span class="n">joined</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Names of libraries and directories which contain them</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">blas</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;blas&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span>
<span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
  <span class="s2">&quot;-DBLAS_LIBRARY_NAMES=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blas</span><span class="o">.</span><span class="n">names</span><span class="p">)),</span>
  <span class="s2">&quot;-DBLAS_LIBRARY_DIRS=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blas</span><span class="o">.</span><span class="n">directories</span><span class="p">))</span>
<span class="p">])</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Search and link flags</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">math_libs</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;scalapack&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span> <span class="o">+</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;lapack&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span> <span class="o">+</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;blas&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">libs</span>
<span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
  <span class="s2">&quot;-DMATH_LIBS:STRING=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">math_libs</span><span class="o">.</span><span class="n">ld_flags</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>For more information, see documentation of
<a class="reference external" href="https://spack.readthedocs.io/en/latest/llnl.util.html#llnl.util.filesystem.LibraryList">LibraryList</a>
class.</p>
</section>
<section id="prefix-objects">
<span id="id16"></span><h3>Prefix objects<a class="headerlink" href="#prefix-objects" title="Link to this heading"></a></h3>
<p>Spack passes the <code class="docutils literal notranslate"><span class="pre">prefix</span></code> parameter to the install method so that
you can pass it to <code class="docutils literal notranslate"><span class="pre">configure</span></code>, <code class="docutils literal notranslate"><span class="pre">cmake</span></code>, or some other installer,
e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;--prefix=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
</pre></div>
</div>
<p>For the most part, prefix objects behave exactly like strings.  For
packages that do not have their own install target, or for those that
implement it poorly (like <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code>), you may need to manually copy
things into particular directories under the prefix.  For this, you
can refer to standard subdirectories without having to construct paths
yourself, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">mkdirp</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">)</span>
    <span class="n">install</span><span class="p">(</span><span class="s2">&quot;foo-tool&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">)</span>

    <span class="n">mkdirp</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>
    <span class="n">install</span><span class="p">(</span><span class="s2">&quot;foo.h&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>

    <span class="n">mkdirp</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
    <span class="n">install</span><span class="p">(</span><span class="s2">&quot;libfoo.a&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
</pre></div>
</div>
<p>Attributes of this object are created on the fly when you request them,
so any of the following will work:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Prefix Attribute</p></th>
<th class="head"><p>Location</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">prefix.bin</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">$prefix/bin</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">prefix.lib64</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">$prefix/lib64</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">prefix.share.man</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">$prefix/share/man</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">prefix.foo.bar.baz</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">$prefix/foo/bar/baz</span></code></p></td>
</tr>
</tbody>
</table>
<p>Of course, this only works if your file or directory is a valid Python
variable name. If your file or directory contains dashes or dots, use
<code class="docutils literal notranslate"><span class="pre">join</span></code> instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;libz.a&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="spec-objects">
<span id="id17"></span><h2>Spec objects<a class="headerlink" href="#spec-objects" title="Link to this heading"></a></h2>
<p>When <code class="docutils literal notranslate"><span class="pre">install</span></code> is called, most parts of the build process are set up
for you.  The correct version’s tarball has been downloaded and
expanded.  Environment variables like <code class="docutils literal notranslate"><span class="pre">CC</span></code> and <code class="docutils literal notranslate"><span class="pre">CXX</span></code> are set to
point to the correct compiler and version.  An install prefix has
already been selected and passed in as <code class="docutils literal notranslate"><span class="pre">prefix</span></code>.  In most cases this
is all you need to get <code class="docutils literal notranslate"><span class="pre">configure</span></code>, <code class="docutils literal notranslate"><span class="pre">cmake</span></code>, or another install
working correctly.</p>
<p>There will be times when you need to know more about the build
configuration.  For example, some software requires that you pass
special parameters to <code class="docutils literal notranslate"><span class="pre">configure</span></code>, like
<code class="docutils literal notranslate"><span class="pre">--with-libelf=/path/to/libelf</span></code> or <code class="docutils literal notranslate"><span class="pre">--with-mpich</span></code>.  You might also
need to supply special compiler flags depending on the compiler.  All
of this information is available in the spec.</p>
<section id="testing-spec-constraints">
<span id="testing-specs"></span><h3>Testing spec constraints<a class="headerlink" href="#testing-spec-constraints" title="Link to this heading"></a></h3>
<p>You can test whether your spec is configured a certain way by using
the <code class="docutils literal notranslate"><span class="pre">satisfies</span></code> method.  For example, if you want to check whether
the package’s version is in a particular range, you can use specs to
do that, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configure_args</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;--prefix=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;@1.2:1.4&quot;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;CXXFLAGS=&#39;-DWITH_FEATURE&#39;&quot;</span><span class="p">)</span>

<span class="n">configure</span><span class="p">(</span><span class="o">*</span><span class="n">configure_args</span><span class="p">)</span>
</pre></div>
</div>
<p>This works for compilers, too:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">cc&quot;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;CXXFLAGS=&#39;-g3 -O3&#39;&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">ntel&quot;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;CXXFLAGS=&#39;-xSSE2 -fast&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or for combinations of spec constraints:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;@1.2</span><span class="si">%i</span><span class="s2">ntel&quot;</span><span class="p">):</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Version 1.2 breaks when using Intel compiler!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also do similar satisfaction tests for dependencies:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;^dyninst@8.0&quot;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;CXXFLAGS=-DSPECIAL_DYNINST_FEATURE&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This could allow you to easily work around a bug in a particular
dependency version.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">satisfies()</span></code> to test for particular dependencies,
e.g. <code class="docutils literal notranslate"><span class="pre">foo.satisfies(&quot;^openmpi&#64;1.2&quot;)</span></code> or <code class="docutils literal notranslate"><span class="pre">foo.satisfies(&quot;^mpich&quot;)</span></code>,
or you can use Python’s built-in <code class="docutils literal notranslate"><span class="pre">in</span></code> operator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;libelf&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;this package depends on libelf&quot;</span>
</pre></div>
</div>
<p>This is useful for virtual dependencies, as you can easily see what
implementation was selected for this build:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;openmpi&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--with-openmpi&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="s2">&quot;mpich&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--with-mpich&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="s2">&quot;mvapich&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--with-mvapich&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>It’s also a bit more concise than satisfies.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">satisfies()</span></code> method tests whether this spec has, at least, all the constraints of the argument spec,
while <code class="docutils literal notranslate"><span class="pre">in</span></code> tests whether a spec or any of its dependencies satisfy the provided spec.</p>
<p>If the provided spec is anonymous (e.g., “:1.2:”, “+shared”) or has the
same name as the spec being checked, then <code class="docutils literal notranslate"><span class="pre">in</span></code> works the same as
<code class="docutils literal notranslate"><span class="pre">satisfies()</span></code>; however, use of <code class="docutils literal notranslate"><span class="pre">satisfies()</span></code> is more intuitive.</p>
</div>
</section>
<section id="architecture-specifiers">
<h3>Architecture specifiers<a class="headerlink" href="#architecture-specifiers" title="Link to this heading"></a></h3>
<p>As mentioned in <a class="reference internal" href="basic_usage.html#support-for-microarchitectures"><span class="std std-ref">Support for specific microarchitectures</span></a> each node in a concretized spec
object has an architecture attribute which is a triplet of <code class="docutils literal notranslate"><span class="pre">platform</span></code>, <code class="docutils literal notranslate"><span class="pre">os</span></code> and <code class="docutils literal notranslate"><span class="pre">target</span></code>.
Each of these three items can be queried to take decisions when configuring, building or
installing a package.</p>
<section id="querying-the-platform-and-the-operating-system">
<h4>Querying the platform and the operating system<a class="headerlink" href="#querying-the-platform-and-the-operating-system" title="Link to this heading"></a></h4>
<p>Sometimes the actions to be taken to install a package might differ depending on the
platform we are installing for. If that is the case we can use conditionals:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
    <span class="c1"># Actions that are specific to Darwin</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--darwin-specific-flag&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and branch based on the current spec platform. If we need to make a package directive
conditional on the platform we can instead employ the usual spec syntax and pass the
corresponding constraint to the appropriate argument of that directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Libnl</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>

    <span class="n">conflicts</span><span class="p">(</span><span class="s2">&quot;platform=darwin&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;libnl requires FreeBSD or Linux&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Similar considerations are also valid for the <code class="docutils literal notranslate"><span class="pre">os</span></code> part of a spec’s architecture.
For instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Glib</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">)</span>

    <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;old-kernels.patch&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;os=centos6&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>will apply the patch only when the operating system is Centos 6.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even though experienced Python programmers might recognize that there are other ways
to retrieve information on the platform:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
    <span class="c1"># Actions that are specific to Darwin</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--darwin-specific-flag&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>querying the spec architecture’s platform should be considered the preferred. The key difference
is that a query on <code class="docutils literal notranslate"><span class="pre">sys.platform</span></code>, or anything similar, is always bound to the host on which the
interpreter running Spack is located and as such it won’t work correctly in environments where
cross-compilation is required.</p>
</div>
</section>
<section id="querying-the-target-microarchitecture">
<h4>Querying the target microarchitecture<a class="headerlink" href="#querying-the-target-microarchitecture" title="Link to this heading"></a></h4>
<p>The third item of the architecture tuple is the <code class="docutils literal notranslate"><span class="pre">target</span></code> which abstracts the information on the
CPU microarchitecture. A list of all the targets known to Spack can be obtained via the
command line:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack arch --known-targets
Generic architectures (families)
    aarch64  armv8.1a  armv8.3a  armv8.5a  ppc    ppc64le  riscv64  sparc64  x86_64     x86_64_v3
    arm      armv8.2a  armv8.4a  armv9.0a  ppc64  ppcle    sparc    x86      x86_64_v2  x86_64_v4

GenuineIntel - x86
    i686  pentium2  pentium3  pentium4  prescott

GenuineIntel - x86_64
    nocona  nehalem   sandybridge  haswell    skylake  cannonlake      cascadelake  sapphirerapids
    core2   westmere  ivybridge    broadwell  mic_knl  skylake_avx512  icelake

AuthenticAMD - x86_64
    k10  bulldozer  piledriver  zen  steamroller  zen2  zen3  excavator  zen4  zen5

IBM - ppc64
    power7  power8  power9  power10

IBM - ppc64le
    power8le  power9le  power10le

Cavium - aarch64
    thunderx2

Fujitsu - aarch64
    a64fx

ARM - aarch64
    cortex_a72  neoverse_n1  neoverse_v1  neoverse_v2  neoverse_n2

Apple - aarch64
    m1  m2

SiFive - riscv64
    u74mc
</pre></div>
</div>
<p>Within directives each of the names above can be used to match a particular target:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Julia</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="c1"># This patch is only applied on icelake microarchitectures</span>
    <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;icelake.patch&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;target=icelake&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>It’s also possible to select all the architectures belonging to the same family
using an open range:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Julia</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="c1"># This patch is applied on all x86_64 microarchitectures.</span>
    <span class="c1"># The trailing colon that denotes an open range of targets</span>
    <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;generic_x86_64.patch&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;target=x86_64:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>in a way that resembles what was shown in <a class="reference internal" href="#versions-and-fetching"><span class="std std-ref">Versions and fetching</span></a> for versions.
Where <code class="docutils literal notranslate"><span class="pre">target</span></code> objects really shine though is when they are used in methods
called at configure, build or install time. In that case we can test targets
for supported features, for instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;target=avx512&quot;</span><span class="p">):</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--with-avx512&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The snippet above will append the <code class="docutils literal notranslate"><span class="pre">--with-avx512</span></code> item to a list of arguments only if the corresponding
feature is supported by the current target. Sometimes we need to take different actions based
on the architecture family and not on the specific microarchitecture. In those cases
we can check the <code class="docutils literal notranslate"><span class="pre">family</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;ppc64le&quot;</span><span class="p">:</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--enable-power&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Possible values for the <code class="docutils literal notranslate"><span class="pre">family</span></code> attribute are displayed by <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">arch</span> <span class="pre">--known-targets</span></code>
under the “Generic architectures (families)” header.
Finally it’s possible to perform actions based on whether the current microarchitecture
is compatible with a known one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">target</span> <span class="o">&gt;</span> <span class="s2">&quot;haswell&quot;</span><span class="p">:</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--needs-at-least-haswell&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The snippet above will add an item to a list of configure options only if the current
architecture is a superset of <code class="docutils literal notranslate"><span class="pre">haswell</span></code> or, said otherwise, only if the current
architecture is a later microarchitecture still compatible with <code class="docutils literal notranslate"><span class="pre">haswell</span></code>.</p>
<div class="admonition-using-spack-on-unknown-microarchitectures admonition">
<p class="admonition-title">Using Spack on unknown microarchitectures</p>
<p>If Spack is used on an unknown microarchitecture it will try to perform a best match
of the features it detects and will select the closest microarchitecture it has
information for. In case nothing matches, it will create on the fly a new generic
architecture. This is done to allow users to still be able to use Spack
for their work. The software built won’t be probably as optimized as it could but just
as you need a newer compiler to build for newer architectures, you may need newer
versions of Spack for new architectures to be correctly labeled.</p>
</div>
</section>
</section>
<section id="accessing-dependencies">
<h3>Accessing Dependencies<a class="headerlink" href="#accessing-dependencies" title="Link to this heading"></a></h3>
<p>You may need to get at some file or binary that’s in the installation
prefix of one of your dependencies. You can do that by sub-scripting
the spec:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The value in the brackets needs to be some package name, and spec
needs to depend on that package, or the operation will fail.  For
example, the above code will fail if the <code class="docutils literal notranslate"><span class="pre">spec</span></code> doesn’t depend on
<code class="docutils literal notranslate"><span class="pre">mpi</span></code>.  The value returned is itself just another <code class="docutils literal notranslate"><span class="pre">Spec</span></code> object,
so you can do all the same things you would do with the package’s
own spec:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">version</span>
</pre></div>
</div>
</section>
<section id="multimethods-and-when">
<span id="multimethods"></span><h3>Multimethods and <code class="docutils literal notranslate"><span class="pre">&#64;when</span></code><a class="headerlink" href="#multimethods-and-when" title="Link to this heading"></a></h3>
<p>Spack allows you to make multiple versions of instance functions in
packages, based on whether the package’s spec satisfies particular
criteria.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;when</span></code> annotation lets packages declare multiple versions of
methods like <code class="docutils literal notranslate"><span class="pre">install()</span></code> that depend on the package’s spec.  For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomePackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c1"># Do default install</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s2">&quot;arch=chaos_5_x86_64_ib&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c1"># This will be executed instead of the default install if</span>
        <span class="c1"># the package&#39;s sys_type() is chaos_5_x86_64_ib.</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s2">&quot;arch=linux-debian7-x86_64&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c1"># This will be executed if the package&#39;s sys_type() is</span>
        <span class="c1"># linux-debian7-x86_64.</span>
</pre></div>
</div>
<p>In the above code there are three versions of <code class="docutils literal notranslate"><span class="pre">install()</span></code>, two of which
are specialized for particular platforms.  The version that is called
depends on the architecture of the package spec.</p>
<p>Note that this works for methods other than install, as well.  So,
if you only have part of the install that is platform specific, you
could do something more like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomePackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
   <span class="o">...</span>
    <span class="c1"># virtual dependence on MPI.</span>
    <span class="c1"># could resolve to mpich, mpich2, OpenMPI</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># do nothing in the default case</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s2">&quot;^openmpi&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># do something special when this is built with OpenMPI for</span>
        <span class="c1"># its MPI implementations.</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c1"># Do common install stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="c1"># Do more common install stuff</span>
</pre></div>
</div>
<p>You can write multiple <code class="docutils literal notranslate"><span class="pre">&#64;when</span></code> specs that satisfy the package’s spec,
for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomePackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># the default, called when no @when specs match</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s2">&quot;^mpi@3:&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this will be called when mpi is version 3 or higher</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s2">&quot;^mpi@2:&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this will be called when mpi is version 2 or higher</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s2">&quot;^mpi@1:&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this will be called when mpi is version 1 or higher</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>In situations like this, the first matching spec, in declaration order
will be called.  As before, if no <code class="docutils literal notranslate"><span class="pre">&#64;when</span></code> spec matches, the default
method (the one without the <code class="docutils literal notranslate"><span class="pre">&#64;when</span></code> decorator) will be called.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The default version of decorated methods must <strong>always</strong> come
first.  Otherwise it will override all of the platform-specific
versions.  There’s not much we can do to get around this because of
the way decorators work.</p>
</div>
</section>
</section>
<section id="compiler-wrappers">
<span id="id18"></span><h2>Compiler wrappers<a class="headerlink" href="#compiler-wrappers" title="Link to this heading"></a></h2>
<p>As mentioned, <code class="docutils literal notranslate"><span class="pre">CC</span></code>, <code class="docutils literal notranslate"><span class="pre">CXX</span></code>, <code class="docutils literal notranslate"><span class="pre">F77</span></code>, and <code class="docutils literal notranslate"><span class="pre">FC</span></code> are set to point to
Spack’s compiler wrappers.  These are simply called <code class="docutils literal notranslate"><span class="pre">cc</span></code>, <code class="docutils literal notranslate"><span class="pre">c++</span></code>,
<code class="docutils literal notranslate"><span class="pre">f77</span></code>, and <code class="docutils literal notranslate"><span class="pre">f90</span></code>, and they live in <code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/lib/spack/env</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">$SPACK_ROOT/lib/spack/env</span></code> is added first in the <code class="docutils literal notranslate"><span class="pre">PATH</span></code>
environment variable when <code class="docutils literal notranslate"><span class="pre">install()</span></code> runs so that system compilers
are not picked up instead.</p>
<p>All of these compiler wrappers point to a single compiler wrapper
script that figures out which <em>real</em> compiler it should be building
with.  This comes either from spec <a class="reference external" href="abstract-and-concrete">concretization</a> or from a user explicitly asking for a
particular compiler using, e.g., <code class="docutils literal notranslate"><span class="pre">%intel</span></code> on the command line.</p>
<p>In addition to invoking the right compiler, the compiler wrappers add
flags to the compile line so that dependencies can be easily found.
These flags are added for each dependency, if they exist:</p>
<ul class="simple">
<li><p>Compile-time library search paths: <code class="docutils literal notranslate"><span class="pre">-L$dep_prefix/lib</span></code>, <code class="docutils literal notranslate"><span class="pre">-L$dep_prefix/lib64</span></code></p></li>
<li><p>Runtime library search paths (RPATHs): <code class="docutils literal notranslate"><span class="pre">$rpath_flag$dep_prefix/lib</span></code>, <code class="docutils literal notranslate"><span class="pre">$rpath_flag$dep_prefix/lib64</span></code></p></li>
<li><p>Include search paths: <code class="docutils literal notranslate"><span class="pre">-I$dep_prefix/include</span></code></p></li>
</ul>
<p>An example of this would be the <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> build, which has one
dependency: <code class="docutils literal notranslate"><span class="pre">libelf</span></code>.  Every call to <code class="docutils literal notranslate"><span class="pre">cc</span></code> in the <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code>
build will have <code class="docutils literal notranslate"><span class="pre">-I$LIBELF_PREFIX/include</span></code>,
<code class="docutils literal notranslate"><span class="pre">-L$LIBELF_PREFIX/lib</span></code>, and <code class="docutils literal notranslate"><span class="pre">$rpath_flag$LIBELF_PREFIX/lib</span></code>
inserted on the command line.  This is done transparently to the
project’s build system, which will just think it’s using a system
where <code class="docutils literal notranslate"><span class="pre">libelf</span></code> is readily available.  Because of this, you <strong>do
not</strong> have to insert extra <code class="docutils literal notranslate"><span class="pre">-I</span></code>, <code class="docutils literal notranslate"><span class="pre">-L</span></code>, etc. on the command line.</p>
<p>Another useful consequence of this is that you often do <em>not</em> have to
add extra parameters on the <code class="docutils literal notranslate"><span class="pre">configure</span></code> line to get autotools to
find dependencies.  The <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> install method just calls
configure like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>
</pre></div>
</div>
<p>Because of the <code class="docutils literal notranslate"><span class="pre">-L</span></code> and <code class="docutils literal notranslate"><span class="pre">-I</span></code> arguments, configure will
successfully find <code class="docutils literal notranslate"><span class="pre">libdwarf.h</span></code> and <code class="docutils literal notranslate"><span class="pre">libdwarf.so</span></code>, without the
packager having to provide <code class="docutils literal notranslate"><span class="pre">--with-libdwarf=/path/to/libdwarf</span></code> on
the command line.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For most compilers, <code class="docutils literal notranslate"><span class="pre">$rpath_flag</span></code> is <code class="docutils literal notranslate"><span class="pre">-Wl,-rpath,</span></code>. However, NAG
passes its flags to GCC instead of passing them directly to the linker.
Therefore, its <code class="docutils literal notranslate"><span class="pre">$rpath_flag</span></code> is doubly wrapped: <code class="docutils literal notranslate"><span class="pre">-Wl,-Wl,,-rpath,</span></code>.
<code class="docutils literal notranslate"><span class="pre">$rpath_flag</span></code> can be overridden on a compiler specific basis in
<code class="docutils literal notranslate"><span class="pre">lib/spack/spack/compilers/$compiler.py</span></code>.</p>
</div>
<p>The compiler wrappers also pass the compiler flags specified by the user from
the command line (<code class="docutils literal notranslate"><span class="pre">cflags</span></code>, <code class="docutils literal notranslate"><span class="pre">cxxflags</span></code>, <code class="docutils literal notranslate"><span class="pre">fflags</span></code>, <code class="docutils literal notranslate"><span class="pre">cppflags</span></code>, <code class="docutils literal notranslate"><span class="pre">ldflags</span></code>,
and/or <code class="docutils literal notranslate"><span class="pre">ldlibs</span></code>). They do not override the canonical autotools flags with the
same names (but in ALL-CAPS) that may be passed into the build by particularly
challenging package scripts.</p>
</section>
<section id="mpi-support-in-spack">
<h2>MPI support in Spack<a class="headerlink" href="#mpi-support-in-spack" title="Link to this heading"></a></h2>
<p>It is common for high performance computing software/packages to use the
Message Passing Interface ( <code class="docutils literal notranslate"><span class="pre">MPI</span></code>).  As a result of conretization, a
given package can be built using different implementations of MPI such as
<code class="docutils literal notranslate"><span class="pre">Openmpi</span></code>, <code class="docutils literal notranslate"><span class="pre">MPICH</span></code> or <code class="docutils literal notranslate"><span class="pre">IntelMPI</span></code>.  That is, when your package
declares that it <code class="docutils literal notranslate"><span class="pre">depends_on(&quot;mpi&quot;)</span></code>, it can be built with any of these
<code class="docutils literal notranslate"><span class="pre">mpi</span></code> implementations. In some scenarios, to configure a package, one
has to provide it with appropriate MPI compiler wrappers such as
<code class="docutils literal notranslate"><span class="pre">mpicc</span></code>, <code class="docutils literal notranslate"><span class="pre">mpic++</span></code>.  However different implementations of <code class="docutils literal notranslate"><span class="pre">MPI</span></code> may
have different names for those wrappers.</p>
<p>Spack provides an idiomatic way to use MPI compilers in your package.  To
use MPI wrappers to compile your whole build, do this in your
<code class="docutils literal notranslate"><span class="pre">install()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;CC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpicc</span>
<span class="n">env</span><span class="p">[</span><span class="s2">&quot;CXX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpicxx</span>
<span class="n">env</span><span class="p">[</span><span class="s2">&quot;F77&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpif77</span>
<span class="n">env</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpifc</span>
</pre></div>
</div>
<p>That’s all.  A longer explanation of why this works is below.</p>
<p>We don’t try to force any particular build method on packagers.  The
decision to use MPI wrappers depends on the way the package is written,
on common practice, and on “what works”.  Loosely, There are three types
of MPI builds:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Some build systems work well without the wrappers and can treat MPI
as an external library, where the person doing the build has to
supply includes/libs/etc.  This is fairly uncommon.</p></li>
<li><p>Others really want the wrappers and assume you’re using an MPI
“compiler” – i.e., they have no mechanism to add MPI
includes/libraries/etc.</p></li>
<li><p>CMake’s <code class="docutils literal notranslate"><span class="pre">FindMPI</span></code> needs the compiler wrappers, but it uses them to
extract <code class="docutils literal notranslate"><span class="pre">–I</span></code> / <code class="docutils literal notranslate"><span class="pre">-L</span></code> / <code class="docutils literal notranslate"><span class="pre">-D</span></code> arguments, then treats MPI like a
regular library.</p></li>
</ol>
</div></blockquote>
<p>Note that some CMake builds fall into case 2 because they either don’t
know about or don’t like CMake’s <code class="docutils literal notranslate"><span class="pre">FindMPI</span></code> support – they just assume
an MPI compiler. Also, some autotools builds fall into case 3 (e.g. <a class="reference external" href="https://github.com/tgamblin/libra/blob/master/m4/lx_find_mpi.m4">here
is an autotools version of CMake’s FindMPI</a>).</p>
<p>Given all of this, we leave the use of the wrappers up to the packager.
Spack will support all three ways of building MPI packages.</p>
<section id="packaging-conventions">
<h3>Packaging Conventions<a class="headerlink" href="#packaging-conventions" title="Link to this heading"></a></h3>
<p>As mentioned above, in the <code class="docutils literal notranslate"><span class="pre">install()</span></code> method, <code class="docutils literal notranslate"><span class="pre">CC</span></code>, <code class="docutils literal notranslate"><span class="pre">CXX</span></code>,
<code class="docutils literal notranslate"><span class="pre">F77</span></code>, and <code class="docutils literal notranslate"><span class="pre">FC</span></code> point to Spack’s wrappers around the chosen compiler.
Spack’s wrappers are not the MPI compiler wrappers, though they do
automatically add <code class="docutils literal notranslate"><span class="pre">–I</span></code>, <code class="docutils literal notranslate"><span class="pre">–L</span></code>, and <code class="docutils literal notranslate"><span class="pre">–Wl,-rpath</span></code> args for
dependencies in a similar way.  The MPI wrappers are a bit different in
that they also add <code class="docutils literal notranslate"><span class="pre">-l</span></code> arguments for the MPI libraries, and some add
special <code class="docutils literal notranslate"><span class="pre">-D</span></code> arguments to trigger build options in MPI programs.</p>
<p>For case 1 above, you generally don’t need to do more than patch your
Makefile or add configure args as you normally would.</p>
<p>For case 3, you don’t need to do much of anything, as Spack puts the MPI
compiler wrappers in the PATH, and the build will find them and
interrogate them.</p>
<p>For case 2, things are a bit more complicated, as you’ll need to tell the
build to use the MPI compiler wrappers instead of Spack’s compiler
wrappers.  All it takes some lines like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;CC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpicc</span>
<span class="n">env</span><span class="p">[</span><span class="s2">&quot;CXX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpicxx</span>
<span class="n">env</span><span class="p">[</span><span class="s2">&quot;F77&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpif77</span>
<span class="n">env</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpifc</span>
</pre></div>
</div>
<p>Or, if you pass CC, CXX, etc. directly to your build with, e.g.,
<cite>–with-cc=&lt;path&gt;</cite>, you’ll want to substitute <cite>spec[“mpi”].mpicc</cite> in
there instead, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;—prefix=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">,</span>
          <span class="s2">&quot;—with-cc=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpicc</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, you may think that doing this will lose the includes, library paths,
and RPATHs that Spack’s compiler wrapper get you, but we’ve actually set
things up so that the MPI compiler wrappers use Spack’s compiler wrappers
when run from within Spack. So using the MPI wrappers should really be as
simple as the code above.</p>
</section>
<section id="spec-mpi">
<h3><code class="docutils literal notranslate"><span class="pre">spec[&quot;mpi&quot;]</span></code><a class="headerlink" href="#spec-mpi" title="Link to this heading"></a></h3>
<p>Ok, so how does all this work?</p>
<p>If your package has a virtual dependency like <code class="docutils literal notranslate"><span class="pre">mpi</span></code>, then referring to
<code class="docutils literal notranslate"><span class="pre">spec[&quot;mpi&quot;]</span></code> within <code class="docutils literal notranslate"><span class="pre">install()</span></code> will get you the concrete <code class="docutils literal notranslate"><span class="pre">mpi</span></code>
implementation in your dependency DAG.  That is a spec object just like
the one passed to install, only the MPI implementations all set some
additional properties on it to help you out.  E.g., in mvapich2, you’ll
find this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">setup_dependent_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">dependent_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">mpicc</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="s2">&quot;mpicc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">mpicxx</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="s2">&quot;mpicxx&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">mpifc</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="s2">&quot;mpif90&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">mpif77</span> <span class="o">=</span> <span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="s2">&quot;mpif77&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">mpicxx_shared_libs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="s2">&quot;libmpicxx.</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dso_suffix</span><span class="p">)),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="s2">&quot;libmpi.</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dso_suffix</span><span class="p">)),</span>
        <span class="p">]</span>
</pre></div>
</div>
<p>That code allows the mvapich2 package to associate an <code class="docutils literal notranslate"><span class="pre">mpicc</span></code> property
with the <code class="docutils literal notranslate"><span class="pre">mvapich2</span></code> node in the DAG, so that dependents can access it.
<code class="docutils literal notranslate"><span class="pre">openmpi</span></code> and <code class="docutils literal notranslate"><span class="pre">mpich</span></code> do similar things.  So, no matter what MPI
you’re using, spec[“mpi”].mpicc gets you the location of the MPI
compilers. This allows us to have a fairly simple polymorphic interface
for information about virtual dependencies like MPI.</p>
</section>
<section id="wrapping-wrappers">
<h3>Wrapping wrappers<a class="headerlink" href="#wrapping-wrappers" title="Link to this heading"></a></h3>
<p>Spack likes to use its own compiler wrappers to make it easy to add
<code class="docutils literal notranslate"><span class="pre">RPATHs</span></code> to builds, and to try hard to ensure that your builds use the
right dependencies.  This doesn’t play nicely by default with MPI, so we
have to do a couple tricks.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>If we build MPI with Spack’s wrappers, mpicc and friends will be
installed with hard-coded paths to Spack’s wrappers, and using them
from outside of Spack will fail because they only work within Spack.
To fix this, we patch mpicc and friends to use the regular
compilers.  Look at the filter_compilers method in mpich, openmpi,
or mvapich2 for details.</p></li>
<li><p>We still want to use the Spack compiler wrappers when Spack is
calling mpicc. Luckily, wrappers in all mainstream MPI
implementations provide environment variables that allow us to
dynamically set the compiler to be used by mpicc, mpicxx, etc.
Denis pasted some code from this below – Spack’s build environment
sets <code class="docutils literal notranslate"><span class="pre">MPICC</span></code>, <code class="docutils literal notranslate"><span class="pre">MPICXX</span></code>, etc. for mpich derivatives and
<code class="docutils literal notranslate"><span class="pre">OMPI_CC</span></code>, <code class="docutils literal notranslate"><span class="pre">OMPI_CXX</span></code>, etc. for OpenMPI. This makes the MPI
compiler wrappers use the Spack compiler wrappers so that your
dependencies still get proper RPATHs even if you use the MPI
wrappers.</p></li>
</ol>
</div></blockquote>
</section>
<section id="mpi-on-cray-machines">
<h3>MPI on Cray machines<a class="headerlink" href="#mpi-on-cray-machines" title="Link to this heading"></a></h3>
<p>The Cray programming environment notably uses ITS OWN compiler wrappers,
which function like MPI wrappers.  On Cray systems, the <code class="docutils literal notranslate"><span class="pre">CC</span></code>, <code class="docutils literal notranslate"><span class="pre">cc</span></code>,
and <code class="docutils literal notranslate"><span class="pre">ftn</span></code> wrappers ARE the MPI compiler wrappers, and it’s assumed that
you’ll use them for all of your builds.  So on Cray we don’t bother with
<code class="docutils literal notranslate"><span class="pre">mpicc</span></code>, <code class="docutils literal notranslate"><span class="pre">mpicxx</span></code>, etc, Spack MPI implementations set
<code class="docutils literal notranslate"><span class="pre">spec[&quot;mpi&quot;].mpicc</span></code> to point to Spack’s wrappers, which wrap the Cray
wrappers, which wrap the regular compilers and include MPI flags.  That
may seem complicated, but for packagers, that means the same code for
using MPI wrappers will work, even on even on a Cray:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;CC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mpicc</span>
</pre></div>
</div>
<p>This is because on Cray, <code class="docutils literal notranslate"><span class="pre">spec[&quot;mpi&quot;].mpicc</span></code> is just <code class="docutils literal notranslate"><span class="pre">spack_cc</span></code>.</p>
</section>
</section>
<section id="checking-an-installation">
<span id="id20"></span><h2>Checking an installation<a class="headerlink" href="#checking-an-installation" title="Link to this heading"></a></h2>
<p>A package that <em>appears</em> to install successfully does not mean
it is actually installed correctly or will continue to work indefinitely.
There are a number of possible points of failure so Spack provides
features for checking the software along the way.</p>
<p>Failures can occur during and after the installation process. The
build may start but the software not end up fully installed. The
installed software may not work at all or as expected. The software
may work after being installed but, due to changes on the system,
may stop working days, weeks, or months after being installed.</p>
<p>This section describes Spack’s support for checks that can be performed
during and after its installation. The former checks are referred to as
<code class="docutils literal notranslate"><span class="pre">build-time</span> <span class="pre">tests</span></code> and the latter as <code class="docutils literal notranslate"><span class="pre">stand-alone</span> <span class="pre">(or</span> <span class="pre">smoke)</span> <span class="pre">tests</span></code>.</p>
<section id="build-time-tests">
<span id="id21"></span><h3>Build-time tests<a class="headerlink" href="#build-time-tests" title="Link to this heading"></a></h3>
<p>Spack infers the status of a build based on the contents of the install
prefix. Success is assumed if anything (e.g., a file, directory) is
written after <code class="docutils literal notranslate"><span class="pre">install()</span></code> completes. Otherwise, the build is assumed
to have failed. However, the presence of install prefix contents
is not a sufficient indicator of success so Spack supports the addition
of tests that can be performed during <cite>spack install</cite> processing.</p>
<p>Consider a simple autotools build using the following commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./configure<span class="w"> </span>--prefix<span class="o">=</span>/path/to/installation/prefix
<span class="gp">$ </span>make
<span class="gp">$ </span>make<span class="w"> </span>install
</pre></div>
</div>
<p>Standard Autotools and CMake do not write anything to the prefix from
the <code class="docutils literal notranslate"><span class="pre">configure</span></code> and <code class="docutils literal notranslate"><span class="pre">make</span></code> commands. Files are only written from
the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> after the build completes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to learn more about <code class="docutils literal notranslate"><span class="pre">Autotools</span></code> and <code class="docutils literal notranslate"><span class="pre">CMake</span></code> packages
in Spack, refer to <a class="reference internal" href="build_systems/autotoolspackage.html#autotoolspackage"><span class="std std-ref">AutotoolsPackage</span></a> and
<a class="reference internal" href="build_systems/cmakepackage.html#cmakepackage"><span class="std std-ref">CMakePackage</span></a>, respectively.</p>
</div>
<p>What can you do to check that the build is progressing satisfactorily?
If there are specific files and or directories expected of a successful
installation, you can add basic, fast <code class="docutils literal notranslate"><span class="pre">sanity</span> <span class="pre">checks</span></code>. You can also add
checks to be performed after one or more installation phases.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build-time tests are performed when the <code class="docutils literal notranslate"><span class="pre">--test</span></code> option is passed
to <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Build-time test failures result in a failed installation of the software.</p>
</div>
<section id="adding-sanity-checks">
<span id="sanity-checks"></span><h4>Adding sanity checks<a class="headerlink" href="#adding-sanity-checks" title="Link to this heading"></a></h4>
<p>Unfortunately, many builds of scientific software modify the installation
prefix <strong>before</strong> <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code>. Builds like this can falsely report
success when an error occurs before the installation is complete. Simple
sanity checks can be used to identify files and or directories that are
required of a successful installation. Spack checks for the presence of
the files and directories after <code class="docutils literal notranslate"><span class="pre">install()</span></code> runs.</p>
<p>If any of the listed files or directories are missing, then the build will
fail and the install prefix will be removed. If they all exist, then Spack
considers the build successful from a sanity check perspective and keeps
the prefix in place.</p>
<p>For example, the sanity checks for the <code class="docutils literal notranslate"><span class="pre">reframe</span></code> package below specify
that eight paths must exist within the installation prefix after the
<code class="docutils literal notranslate"><span class="pre">install</span></code> method completes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Reframe</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="c1"># sanity check</span>
    <span class="n">sanity_check_is_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">join_path</span><span class="p">(</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;reframe&quot;</span><span class="p">)]</span>
    <span class="n">sanity_check_is_dir</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">,</span> <span class="s2">&quot;reframe&quot;</span><span class="p">,</span> <span class="s2">&quot;tutorials&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;unittests&quot;</span><span class="p">,</span> <span class="s2">&quot;cscs-checks&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>When you run <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> with tests enabled, Spack will ensure that
a successfully installed package has the required files and or directories.</p>
<p>For example, running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--test<span class="o">=</span>root<span class="w"> </span>reframe
</pre></div>
</div>
<p>results in spack checking that the installation created the following <strong>file</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.bin.reframe</span></code></p></li>
</ul>
<p>and the following <strong>directories</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.bin</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.config</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.docs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.reframe</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.tutorials</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.unittests</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.prefix.cscs-checks</span></code></p></li>
</ul>
<p>If <strong>any</strong> of these paths are missing, then Spack considers the installation
to have failed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You <strong>MUST</strong> use <code class="docutils literal notranslate"><span class="pre">sanity_check_is_file</span></code> to specify required
files and <code class="docutils literal notranslate"><span class="pre">sanity_check_is_dir</span></code> for required directories.</p>
</div>
</section>
<section id="adding-installation-phase-tests">
<span id="install-phase-tests"></span><h4>Adding installation phase tests<a class="headerlink" href="#adding-installation-phase-tests" title="Link to this heading"></a></h4>
<p>Sometimes packages appear to build “correctly” only to have run-time
behavior issues discovered at a later stage, such as after a full
software stack relying on them has been built. Checks can be performed
at different phases of the package installation to possibly avoid
these types of problems. Some checks are built-in to different build
systems, while others will need to be added to the package.</p>
<p>Built-in installation phase tests are provided by packages inheriting
from select <a class="reference internal" href="build_systems.html#build-systems"><span class="std std-ref">build systems</span></a>, where naming conventions
are used to identify typical test identifiers for those systems. In
general, you won’t need to add anything to your package to take advantage
of these tests if your software’s build system complies with the convention;
otherwise, you’ll want or need to override the post-phase method to perform
other checks.</p>
<table class="docutils align-default" id="id27">
<caption><span class="caption-text">Built-in installation phase tests</span><a class="headerlink" href="#id27" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Build System Class</p></th>
<th class="head"><p>Post-Build Phase Method (Runs)</p></th>
<th class="head"><p>Post-Install Phase Method (Runs)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="build_systems/autotoolspackage.html#autotoolspackage"><span class="std std-ref">AutotoolsPackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">check</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code>)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">installcheck</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">installcheck</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="build_systems/cachedcmakepackage.html#cachedcmakepackage"><span class="std std-ref">CachedCMakePackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">check</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code>, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>)</p></td>
<td><p>Not applicable</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="build_systems/cmakepackage.html#cmakepackage"><span class="std std-ref">CMakePackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">check</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code>, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>)</p></td>
<td><p>Not applicable</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="build_systems/makefilepackage.html#makefilepackage"><span class="std std-ref">MakefilePackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">check</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code>)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">installcheck</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">installcheck</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="build_systems/mesonpackage.html#mesonpackage"><span class="std std-ref">MesonPackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">check</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code>)</p></td>
<td><p>Not applicable</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="build_systems/perlpackage.html#perlpackage"><span class="std std-ref">PerlPackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">check</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>)</p></td>
<td><p>Not applicable</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="build_systems/pythonpackage.html#pythonpackage"><span class="std std-ref">PythonPackage</span></a></p></td>
<td><p>Not applicable</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">test</span></code> (module imports)</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="build_systems/qmakepackage.html#qmakepackage"><span class="std std-ref">QMakePackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">check</span></code> (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code>)</p></td>
<td><p>Not applicable</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="build_systems/sconspackage.html#sconspackage"><span class="std std-ref">SConsPackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">build_test</span></code> (must be overridden)</p></td>
<td><p>Not applicable</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="build_systems/sippackage.html#sippackage"><span class="std std-ref">SIPPackage</span></a></p></td>
<td><p>Not applicable</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">test</span></code> (module imports)</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="build_systems/wafpackage.html#wafpackage"><span class="std std-ref">WafPackage</span></a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">build_test</span></code> (must be overridden)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">install_test</span></code> (must be overridden)</p></td>
</tr>
</tbody>
</table>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">Libelf</span></code> package inherits from <code class="docutils literal notranslate"><span class="pre">AutotoolsPackage</span></code>
and its <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> has a standard <code class="docutils literal notranslate"><span class="pre">check</span></code> target. So Spack will
automatically run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code> after the <code class="docutils literal notranslate"><span class="pre">build</span></code> phase when it
is installed using the <code class="docutils literal notranslate"><span class="pre">--test</span></code> option, such as:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--test<span class="o">=</span>root<span class="w"> </span>libelf
</pre></div>
</div>
<p>In addition to overriding any built-in build system installation
phase tests, you can write your own install phase tests. You will
need to use two decorators for each phase test method:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">run_after</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_package_attributes</span></code></p></li>
</ul>
<p>The first decorator tells Spack when in the installation process to
run your test method installation process; namely <em>after</em> the provided
installation phase. The second decorator tells Spack to only run the
checks when the <code class="docutils literal notranslate"><span class="pre">--test</span></code> option is provided on the command line.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be sure to place the directives above your test method in the order
<code class="docutils literal notranslate"><span class="pre">run_after</span></code> <em>then</em> <code class="docutils literal notranslate"><span class="pre">on_package_attributes</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You also want to be sure the package supports the phase you use
in the <code class="docutils literal notranslate"><span class="pre">run_after</span></code> directive. For example, <code class="docutils literal notranslate"><span class="pre">PackageBase</span></code> only
supports the <code class="docutils literal notranslate"><span class="pre">install</span></code> phase while the <code class="docutils literal notranslate"><span class="pre">AutotoolsPackage</span></code> and
<code class="docutils literal notranslate"><span class="pre">MakefilePackage</span></code> support both <code class="docutils literal notranslate"><span class="pre">install</span></code> and <code class="docutils literal notranslate"><span class="pre">build</span></code> phases.</p>
</div>
<p>Assuming both <code class="docutils literal notranslate"><span class="pre">build</span></code> and <code class="docutils literal notranslate"><span class="pre">install</span></code> phases are available to you,
you could add additional checks to be performed after each of those
phases based on the skeleton provided below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YourMakefilePackage</span><span class="p">(</span><span class="n">MakefilePackage</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="nd">@run_after</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>
    <span class="nd">@on_package_attributes</span><span class="p">(</span><span class="n">run_tests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">check_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="c1"># Add your custom post-build phase tests</span>
         <span class="k">pass</span>

    <span class="nd">@run_after</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">)</span>
    <span class="nd">@on_package_attributes</span><span class="p">(</span><span class="n">run_tests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">check_install</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="c1"># Add your custom post-install phase tests</span>
         <span class="k">pass</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You could also schedule work to be done <strong>before</strong> a given phase
using the <code class="docutils literal notranslate"><span class="pre">run_before</span></code> decorator.</p>
</div>
<p>By way of a concrete example, the <code class="docutils literal notranslate"><span class="pre">reframe</span></code> package mentioned
previously has a simple installation phase check that runs the
installed executable. The check is implemented as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Reframe</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="c1"># check if we can run reframe</span>
    <span class="nd">@run_after</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">)</span>
    <span class="nd">@on_package_attributes</span><span class="p">(</span><span class="n">run_tests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">check_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">source_path</span><span class="p">):</span>
             <span class="n">reframe</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">reframe</span><span class="p">)</span>
             <span class="n">reframe</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="checking-build-time-test-results">
<h4>Checking build-time test results<a class="headerlink" href="#checking-build-time-test-results" title="Link to this heading"></a></h4>
<p>Checking the results of these tests after running <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">--test</span></code>
can be done by viewing the spec’s <code class="docutils literal notranslate"><span class="pre">install-time-test-log.txt</span></code> file whose
location will depend on whether the spec installed successfully.</p>
<p>A successful installation results in the build and stage logs being copied
to the <code class="docutils literal notranslate"><span class="pre">.spack</span></code> subdirectory of the spec’s prefix. For example,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--test<span class="o">=</span>root<span class="w"> </span>zlib@1.2.13
<span class="go">...</span>
<span class="go">[+] /home/user/spack/opt/spack/linux-rhel8-broadwell/gcc-10.3.1/zlib-1.2.13-tehu6cbsujufa2tb6pu3xvc6echjstv6</span>
<span class="gp">$ </span>cat<span class="w"> </span>/home/user/spack/opt/spack/linux-rhel8-broadwell/gcc-10.3.1/zlib-1.2.13-tehu6cbsujufa2tb6pu3xvc6echjstv6/.spack/install-time-test-log.txt
</pre></div>
</div>
<p>If the installation fails due to build-time test failures, then both logs will
be left in the build stage directory as illustrated below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--test<span class="o">=</span>root<span class="w"> </span>zlib@1.2.13
<span class="go">...</span>
<span class="go">See build log for details:</span>
<span class="go">  /var/tmp/user/spack-stage/spack-stage-zlib-1.2.13-lxfsivs4htfdewxe7hbi2b3tekj4make/spack-build-out.txt</span>

<span class="gp">$ </span>cat<span class="w"> </span>/var/tmp/user/spack-stage/spack-stage-zlib-1.2.13-lxfsivs4htfdewxe7hbi2b3tekj4make/install-time-test-log.txt
</pre></div>
</div>
</section>
</section>
<section id="stand-alone-tests">
<span id="cmd-spack-test"></span><h3>Stand-alone tests<a class="headerlink" href="#stand-alone-tests" title="Link to this heading"></a></h3>
<p>While build-time tests are integrated with the installation process, stand-alone
tests are expected to run days, weeks, even months after the software is
installed. The goal is to provide a mechanism for gaining confidence that
packages work as installed <strong>and</strong> <em>continue</em> to work as the underlying
software evolves. Packages can add and inherit stand-alone tests. The
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span></code> command is used for stand-alone testing.</p>
<div class="admonition-stand-alone-test-methods-should-complete-within-a-few-minutes admonition">
<p class="admonition-title">Stand-alone test methods should complete within a few minutes.</p>
<p>Execution speed is important since these tests are intended to quickly
assess whether installed specs work on the system. Spack cannot spare
resources for more extensive testing of packages included in CI stacks.</p>
<p>Consequently, stand-alone tests should run relatively quickly – as in
on the order of at most a few minutes – while testing at least key aspects
of the installed software. Save more extensive testing for other tools.</p>
</div>
<p>Tests are defined in the package using methods with names beginning <code class="docutils literal notranslate"><span class="pre">test_</span></code>.
This allows Spack to support multiple independent checks, or parts. Files
needed for testing, such as source, data, and expected outputs, may be saved
from the build and or stored with the package in the repository. Regardless
of origin, these files are automatically copied to the spec’s test stage
directory prior to execution of the test method(s). Spack also provides helper
functions to facilitate common processing.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>The status of stand-alone tests can be used to guide follow-up testing efforts.</strong></p>
<p>Passing stand-alone tests justify performing more thorough testing, such
as running extensive unit or regression tests or tests that run at scale,
when available. These tests are outside of the scope of Spack packaging.</p>
<p>Failing stand-alone tests indicate problems with the installation and,
therefore, no reason to proceed with more resource-intensive tests until
the failures have been investigated.</p>
</div>
<section id="configuring-the-test-stage-directory">
<span id="configure-test-stage"></span><h4>Configuring the test stage directory<a class="headerlink" href="#configuring-the-test-stage-directory" title="Link to this heading"></a></h4>
<p>Stand-alone tests utilize a test stage directory to build, run, and track
tests in the same way Spack uses a build stage directory to install software.
The default test stage root directory, <code class="docutils literal notranslate"><span class="pre">$HOME/.spack/test</span></code>, is defined in
<a class="reference internal" href="config_yaml.html#config-yaml"><span class="std std-ref">config.yaml</span></a>. This location is customizable by adding or
changing the <code class="docutils literal notranslate"><span class="pre">test_stage</span></code> path such that:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test_stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/test/stage</span>
</pre></div>
</div>
<p>Packages can use the <code class="docutils literal notranslate"><span class="pre">self.test_suite.stage</span></code> property to access the path.</p>
<div class="admonition-each-spec-being-tested-has-its-own-test-stage-directory admonition">
<p class="admonition-title">Each spec being tested has its own test stage directory.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">config:test_stage</span></code> option is the path to the root of a
<strong>test suite</strong>’s stage directories.</p>
<p>Other package properties that provide paths to spec-specific subdirectories
and files are described in <a class="reference internal" href="#accessing-files"><span class="std std-ref">Finding package- and test-related files</span></a>.</p>
</div>
</section>
<section id="adding-stand-alone-tests">
<span id="adding-standalone-tests"></span><h4>Adding stand-alone tests<a class="headerlink" href="#adding-stand-alone-tests" title="Link to this heading"></a></h4>
<p>Test recipes are defined in the package using methods with names beginning
<code class="docutils literal notranslate"><span class="pre">test_</span></code>. This allows for the implementation of multiple independent tests.
Each method has access to the information Spack tracks on the package, such
as options, compilers, and dependencies, supporting the customization of tests
to the build. Standard python <code class="docutils literal notranslate"><span class="pre">assert</span></code> statements and other error reporting
mechanisms can be used. These exceptions are automatically caught and reported
as test failures.</p>
<p>Each test method is an <em>implicit test part</em> named by the method. Its purpose
is the method’s docstring. Providing a meaningful purpose for the test gives
context that can aid debugging. Spack outputs both the name and purpose at the
start of test execution so it’s also important that the docstring/purpose be
brief.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We recommend naming test methods so it is clear <em>what</em> is being tested.
For example, if a test method is building and or running an executable
called <code class="docutils literal notranslate"><span class="pre">example</span></code>, then call the method <code class="docutils literal notranslate"><span class="pre">test_example</span></code>. This, together
with a similarly meaningful test purpose, will aid test comprehension,
debugging, and maintainability.</p>
</div>
<p>Stand-alone tests run in an environment that provides access to information
on the installed software, such as build options, dependencies, and compilers.
Build options and dependencies are accessed using the same spec checks used
by build recipes. Examples of checking <a class="reference internal" href="#variants"><span class="std std-ref">variant settings</span></a> and
<a class="reference internal" href="#testing-specs"><span class="std std-ref">spec constraints</span></a> can be found at the provided links.</p>
<div class="admonition-spack-automatically-sets-up-the-test-stage-directory-and-environment admonition">
<p class="admonition-title">Spack automatically sets up the test stage directory and environment.</p>
<p>Spack automatically creates the test stage directory and copies
relevant files <em>prior to</em> running tests. It can also ensure build
dependencies are available <strong>if</strong> necessary.</p>
<p>The path to the test stage is configurable (see <a class="reference internal" href="#configure-test-stage"><span class="std std-ref">Configuring the test stage directory</span></a>).</p>
<p>Files that Spack knows to copy are those saved from the build (see
<a class="reference internal" href="#cache-extra-test-sources"><span class="std std-ref">Saving build- and install-time files</span></a>) and those added to the package repository
(see <a class="reference internal" href="#cache-custom-files"><span class="std std-ref">Adding custom files</span></a>).</p>
<p>Spack will use the value of the <code class="docutils literal notranslate"><span class="pre">test_requires_compiler</span></code> property to
determine whether it needs to also set up build dependencies (see
<a class="reference internal" href="#test-build-tests"><span class="std std-ref">Building and running test executables</span></a>).</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">MyPackage</span></code> package below provides two basic test examples:
<code class="docutils literal notranslate"><span class="pre">test_example</span></code> and <code class="docutils literal notranslate"><span class="pre">test_example2</span></code>.  The first runs the installed
<code class="docutils literal notranslate"><span class="pre">example</span></code> and ensures its output contains an expected string. The second
runs <code class="docutils literal notranslate"><span class="pre">example2</span></code> without checking output so is only concerned with confirming
the executable runs successfully. If the installed spec is not expected to have
<code class="docutils literal notranslate"><span class="pre">example2</span></code>, then the check at the top of the method will raise a special
<code class="docutils literal notranslate"><span class="pre">SkipTest</span></code> exception, which is captured to facilitate reporting skipped test
parts to tools like CDash.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ensure installed example works&quot;&quot;&quot;</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;Done.&quot;</span>
        <span class="n">example</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">example</span><span class="p">)</span>

        <span class="c1"># Capture stdout and stderr from running the Executable</span>
        <span class="c1"># and check that the expected output was produced.</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">example</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">out</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Expected &#39;</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">&#39; in the output&quot;</span>

    <span class="k">def</span> <span class="nf">test_example2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;run installed example2&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s2">&quot;@:1.0&quot;</span><span class="p">):</span>
            <span class="c1"># Raise SkipTest to ensure flagging the test as skipped for</span>
            <span class="c1"># test reporting purposes.</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Test is only available for v1.1 on&quot;</span><span class="p">)</span>

        <span class="n">example2</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">example2</span><span class="p">)</span>
        <span class="n">example2</span><span class="p">()</span>
</pre></div>
</div>
<p>Output showing the identification of each test part after running the tests
is illustrated below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span><span class="nb">test</span><span class="w"> </span>run<span class="w"> </span>--alias<span class="w"> </span>mypackage<span class="w"> </span>mypackage@2.0
<span class="go">==&gt; Spack test mypackage</span>
<span class="go">...</span>
<span class="gp">$ </span>spack<span class="w"> </span><span class="nb">test</span><span class="w"> </span>results<span class="w"> </span>-l<span class="w"> </span>mypackage
<span class="go">==&gt; Results for test suite &#39;mypackage&#39;:</span>
<span class="go">...</span>
<span class="go">==&gt; [2024-03-10-16:03:56.625439] test: test_example: ensure installed example works</span>
<span class="go">...</span>
<span class="go">PASSED: MyPackage::test_example</span>
<span class="go">==&gt; [2024-03-10-16:03:56.625439] test: test_example2: run installed example2</span>
<span class="go">...</span>
<span class="go">PASSED: MyPackage::test_example2</span>
</pre></div>
</div>
<div class="admonition-do-not-implement-tests-that-must-run-in-the-installation-prefix admonition">
<p class="admonition-title">Do NOT implement tests that must run in the installation prefix.</p>
<p>Use of the package spec’s installation prefix for building and running
tests is <strong>strongly discouraged</strong>. Doing so causes permission errors for
shared spack instances <em>and</em> facilities that install the software in
read-only file systems or directories.</p>
<p>Instead, start these test methods by explicitly copying the needed files
from the installation prefix to the test stage directory. Note the test
stage directory is the current directory when the test is executed with
the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">run</span></code> command.</p>
</div>
<div class="admonition-test-methods-for-library-packages-should-build-test-executables admonition">
<p class="admonition-title">Test methods for library packages should build test executables.</p>
<p>Stand-alone tests for library packages <em>should</em> build test executables
that utilize the <em>installed</em> library. Doing so ensures the tests follow
a similar build process that users of the library would follow.</p>
<p>For more information on how to do this, see <a class="reference internal" href="#test-build-tests"><span class="std std-ref">Building and running test executables</span></a>.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want to see more examples from packages with stand-alone tests, run
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">pkg</span> <span class="pre">grep</span> <span class="pre">&quot;def\stest&quot;</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">&quot;s/\/package.py.*//g&quot;</span> <span class="pre">|</span> <span class="pre">sort</span> <span class="pre">-u</span></code>
from the command line to get a list of the packages.</p>
</div>
</section>
<section id="adding-stand-alone-test-parts">
<span id="adding-standalone-test-parts"></span><h4>Adding stand-alone test parts<a class="headerlink" href="#adding-stand-alone-test-parts" title="Link to this heading"></a></h4>
<p>Sometimes dependencies between steps of a test lend themselves to being
broken into parts. Tracking the pass/fail status of each part may aid
debugging. Spack provides a <code class="docutils literal notranslate"><span class="pre">test_part</span></code> context manager for use within
test methods.</p>
<p>Each test part is independently run, tracked, and reported. Test parts are
executed in the order they appear. If one fails, subsequent test parts are
still performed even if they would also fail. This allows tools like CDash
to track and report the status of test parts across runs. The pass/fail status
of the enclosing test is derived from the statuses of the embedded test parts.</p>
<div class="admonition-test-method-and-test-part-names-must-be-unique admonition">
<p class="admonition-title">Test method and test part names <strong>must</strong> be unique.</p>
<p>Test results reporting requires that test methods and embedded test parts
within a package have unique names.</p>
</div>
<p>The signature for <code class="docutils literal notranslate"><span class="pre">test_part</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_part</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">purpose</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</pre></div>
</div>
<p>where each argument has the following meaning:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">pkg</span></code> is an instance of the package for the spec under test.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_name</span></code> is the name of the test part, which must start with <code class="docutils literal notranslate"><span class="pre">test_</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">purpose</span></code> is a brief description used as a heading for the test part.</p>
<p>Output from the test is written to a test log file allowing the test name
and purpose to be searched for test part confirmation and debugging.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">work_dir</span></code> is the path to the directory in which the test will run.</p>
<p>The default of <code class="docutils literal notranslate"><span class="pre">None</span></code>, or <code class="docutils literal notranslate"><span class="pre">&quot;.&quot;</span></code>, corresponds to the the spec’s test
stage (i.e., <code class="docutils literal notranslate"><span class="pre">self.test_suite.test_dir_for_spec(self.spec)</span></code>).</p>
</li>
</ul>
<div class="admonition-start-test-part-names-with-the-name-of-the-enclosing-test admonition">
<p class="admonition-title">Start test part names with the name of the enclosing test.</p>
<p>We <strong>highly recommend</strong> starting the names of test parts with the name
of the enclosing test. Doing so helps with the comprehension, readability
and debugging of test results.</p>
</div>
<p>Suppose <code class="docutils literal notranslate"><span class="pre">MyPackage</span></code> installs multiple executables that need to run in a
specific order since the outputs from one are inputs of others. Further suppose
we want to add an integration test that runs the executables in order. We can
accomplish this goal by implementing a stand-alone test method consisting of
test parts for each executable as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;run setup, perform, and report&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">test_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;test_series_setup&quot;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;setup operation&quot;</span><span class="p">):</span>
             <span class="n">exe</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">setup</span><span class="p">))</span>
             <span class="n">exe</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">test_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;test_series_run&quot;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;perform operation&quot;</span><span class="p">):</span>
             <span class="n">exe</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
             <span class="n">exe</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">test_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;test_series_report&quot;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;generate report&quot;</span><span class="p">):</span>
             <span class="n">exe</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">report</span><span class="p">))</span>
             <span class="n">exe</span><span class="p">()</span>
</pre></div>
</div>
<p>The result is <code class="docutils literal notranslate"><span class="pre">test_series</span></code> runs the following executable in order: <code class="docutils literal notranslate"><span class="pre">setup</span></code>,
<code class="docutils literal notranslate"><span class="pre">run</span></code>, and <code class="docutils literal notranslate"><span class="pre">report</span></code>. In this case no options are passed to any of the
executables and no outputs from running them are checked. Consequently, the
implementation could be simplified with a for-loop as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;execute series setup, run, and report&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">exe</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">,</span> <span class="s2">&quot;setup operation&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;perform operation&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;report&quot;</span><span class="p">,</span> <span class="s2">&quot;generate report&quot;</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="k">with</span> <span class="n">test_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;test_series_</span><span class="si">{</span><span class="n">exe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="n">reason</span><span class="p">):</span>
                <span class="n">exe</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exe</span><span class="p">))</span>
                <span class="n">exe</span><span class="p">()</span>
</pre></div>
</div>
<p>In both cases, since we’re using a context manager, each test part in
<code class="docutils literal notranslate"><span class="pre">test_series</span></code> will execute regardless of the status of the other test
parts.</p>
<p>Now let’s look at the output from running the stand-alone tests where
the second test part, <code class="docutils literal notranslate"><span class="pre">test_series_run</span></code>, fails.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span><span class="nb">test</span><span class="w"> </span>run<span class="w"> </span>--alias<span class="w"> </span>mypackage<span class="w"> </span>mypackage@1.0
<span class="go">==&gt; Spack test mypackage</span>
<span class="go">...</span>
<span class="gp">$ </span>spack<span class="w"> </span><span class="nb">test</span><span class="w"> </span>results<span class="w"> </span>-l<span class="w"> </span>mypackage
<span class="go">==&gt; Results for test suite &#39;mypackage&#39;:</span>
<span class="go">...</span>
<span class="go">==&gt; [2024-03-10-16:03:56.625204] test: test_series: execute series setup, run, and report</span>
<span class="go">==&gt; [2024-03-10-16:03:56.625439] test: test_series_setup: setup operation</span>
<span class="go">...</span>
<span class="go">PASSED: MyPackage::test_series_setup</span>
<span class="go">==&gt; [2024-03-10-16:03:56.625555] test: test_series_run: perform operation</span>
<span class="go">...</span>
<span class="go">FAILED: MyPackage::test_series_run</span>
<span class="go">==&gt; [2024-03-10-16:03:57.003456] test: test_series_report: generate report</span>
<span class="go">...</span>
<span class="go">FAILED: MyPackage::test_series_report</span>
<span class="go">FAILED: MyPackage::test_series</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Since test parts depended on the success of previous parts, we see that the
failure of one results in the failure of subsequent checks and the overall
result of the test method, <code class="docutils literal notranslate"><span class="pre">test_series</span></code>, is failure.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want to see more examples from packages using <code class="docutils literal notranslate"><span class="pre">test_part</span></code>, run
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">pkg</span> <span class="pre">grep</span> <span class="pre">&quot;test_part(&quot;</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">&quot;s/\/package.py.*//g&quot;</span> <span class="pre">|</span> <span class="pre">sort</span> <span class="pre">-u</span></code>
from the command line to get a list of the packages.</p>
</div>
</section>
<section id="building-and-running-test-executables">
<span id="test-build-tests"></span><h4>Building and running test executables<a class="headerlink" href="#building-and-running-test-executables" title="Link to this heading"></a></h4>
<div class="admonition-re-use-build-time-sources-and-small-input-data-sets-when-possible admonition">
<p class="admonition-title">Re-use build-time sources and (small) input data sets when possible.</p>
<p>We <strong>highly recommend</strong> re-using build-time test sources and pared down
input files for testing installed software. These files are easier
to keep synchronized with software capabilities when they reside
within the software’s repository. More information on saving files from
the installation process can be found at <a class="reference internal" href="#cache-extra-test-sources"><span class="std std-ref">Saving build- and install-time files</span></a>.</p>
<p>If that is not possible, you can add test-related files to the package
repository (see <a class="reference internal" href="#cache-custom-files"><span class="std std-ref">Adding custom files</span></a>). It will be important to
remember to maintain them so they work across listed or supported versions
of the package.</p>
</div>
<p>Packages that build libraries are good examples of cases where you’ll want
to build test executables from the installed software before running them.
Doing so requires you to let Spack know it needs to load the package’s
compiler configuration. This is accomplished by setting the package’s
<code class="docutils literal notranslate"><span class="pre">test_requires_compiler</span></code> property to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<div class="admonition-test-requires-compiler-true-is-required-to-build-test-executables admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">test_requires_compiler</span> <span class="pre">=</span> <span class="pre">True</span></code> is required to build test executables.</p>
<p>Setting the property to <code class="docutils literal notranslate"><span class="pre">True</span></code> ensures access to the compiler through
canonical environment variables (e.g., <code class="docutils literal notranslate"><span class="pre">CC</span></code>, <code class="docutils literal notranslate"><span class="pre">CXX</span></code>, <code class="docutils literal notranslate"><span class="pre">FC</span></code>, <code class="docutils literal notranslate"><span class="pre">F77</span></code>).
It also gives access to build dependencies like <code class="docutils literal notranslate"><span class="pre">cmake</span></code> through their
<code class="docutils literal notranslate"><span class="pre">spec</span> <span class="pre">objects</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">self.spec[&quot;cmake&quot;].prefix.bin.cmake</span></code> for the
path or <code class="docutils literal notranslate"><span class="pre">self.spec[&quot;cmake&quot;].command</span></code> for the <code class="docutils literal notranslate"><span class="pre">Executable</span></code> instance).</p>
<p>Be sure to add the property at the top of the package class under other
properties like the <code class="docutils literal notranslate"><span class="pre">homepage</span></code>.</p>
</div>
<p>The example below, which ignores how <code class="docutils literal notranslate"><span class="pre">cxx-example.cpp</span></code> is acquired,
illustrates the basic process of compiling a test executable using the
installed library before running it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyLibrary</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="n">test_requires_compiler</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_cxx_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;build and run cxx-example&quot;&quot;&quot;</span>
        <span class="n">exe</span> <span class="o">=</span> <span class="s2">&quot;cxx-example&quot;</span>
        <span class="o">...</span>
        <span class="n">cxx</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CXX&quot;</span><span class="p">])</span>
        <span class="n">cxx</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;-L</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;-I</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exe</span><span class="si">}</span><span class="s2">.cpp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">exe</span>
        <span class="p">)</span>
        <span class="n">cxx_example</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
        <span class="n">cxx_example</span><span class="p">()</span>
</pre></div>
</div>
<p>Typically the files used to build and or run test executables are either
cached from the installation (see <a class="reference internal" href="#cache-extra-test-sources"><span class="std std-ref">Saving build- and install-time files</span></a>) or added
to the package repository (see <a class="reference internal" href="#cache-custom-files"><span class="std std-ref">Adding custom files</span></a>). There is nothing
preventing the use of both.</p>
</section>
<section id="saving-build-and-install-time-files">
<span id="cache-extra-test-sources"></span><h4>Saving build- and install-time files<a class="headerlink" href="#saving-build-and-install-time-files" title="Link to this heading"></a></h4>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">cache_extra_test_sources</span></code> helper routine to copy
directories and or files from the source build stage directory to the
package’s installation directory. Spack will automatically copy these
files for you when it sets up the test stage directory and before it
begins running the tests.</p>
<p>The signature for <code class="docutils literal notranslate"><span class="pre">cache_extra_test_sources</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cache_extra_test_sources</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">srcs</span><span class="p">):</span>
</pre></div>
</div>
<p>where each argument has the following meaning:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pkg</span></code> is an instance of the package for the spec under test.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">srcs</span></code> is a string <em>or</em> a list of strings corresponding to the
paths of subdirectories and or files needed for stand-alone testing.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Paths provided in the <code class="docutils literal notranslate"><span class="pre">srcs</span></code> argument <strong>must be relative</strong> to the
staged source directory. They will be copied to the equivalent relative
location under the test stage directory prior to test execution.</p>
</div>
<p>Contents of subdirectories and files are copied to a special test cache
subdirectory of the installation prefix. They are automatically copied to
the appropriate relative paths under the test stage directory prior to
executing stand-alone tests.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><em>Perform test-related conversions once when copying files.</em></p>
<p>If one or more of the copied files needs to be modified to reference
the installed software, it is recommended that those changes be made
to the cached files <strong>once</strong> in the post-<code class="docutils literal notranslate"><span class="pre">install</span></code> copy method
<strong>after</strong> the call to <code class="docutils literal notranslate"><span class="pre">cache_extra_test_sources</span></code>. This will reduce
the amount of unnecessary work in the test method <strong>and</strong> avoid problems
running stand-alone tests in shared instances and facility deployments.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">filter_file</span></code> function can be quite useful for such changes
(see <a class="reference internal" href="#file-filtering"><span class="std std-ref">Filtering functions</span></a>).</p>
</div>
<p>Below is a basic example of a test that relies on files from the installation.
This package method re-uses the contents of the <code class="docutils literal notranslate"><span class="pre">examples</span></code> subdirectory,
which is assumed to have all of the files implemented to allow <code class="docutils literal notranslate"><span class="pre">make</span></code> to
compile and link <code class="docutils literal notranslate"><span class="pre">foo.c</span></code> and <code class="docutils literal notranslate"><span class="pre">bar.c</span></code> against the package’s installed
library.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyLibPackage</span><span class="p">(</span><span class="n">MakefilePackage</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="nd">@run_after</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy_test_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cache_extra_test_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;examples&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;build and run the examples&quot;&quot;&quot;</span>
        <span class="n">examples_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_suite</span><span class="o">.</span><span class="n">current_test_cache_dir</span><span class="o">.</span><span class="n">examples</span>
        <span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="n">examples_dir</span><span class="p">):</span>
            <span class="n">make</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;make&quot;</span><span class="p">)</span>
            <span class="n">make</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">program</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">]:</span>
                <span class="k">with</span> <span class="n">test_part</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;test_example_</span><span class="si">{</span><span class="n">program</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">purpose</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ensure </span><span class="si">{</span><span class="n">program</span><span class="si">}</span><span class="s2"> runs&quot;</span>
                <span class="p">):</span>
                    <span class="n">exe</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
                    <span class="n">exe</span><span class="p">()</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">copy_test_files</span></code> copies the associated files from the
build stage to the package’s test cache directory under the installation
prefix. Running <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">run</span></code> for the package results in Spack copying
the directory and its contents to the the test stage directory. The
<code class="docutils literal notranslate"><span class="pre">working_dir</span></code> context manager ensures the commands within it are executed
from the <code class="docutils literal notranslate"><span class="pre">examples_dir</span></code>. The test builds the software using <code class="docutils literal notranslate"><span class="pre">make</span></code> before
running each executable, <code class="docutils literal notranslate"><span class="pre">foo</span></code> and <code class="docutils literal notranslate"><span class="pre">bar</span></code>, as independent test parts.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The method name <code class="docutils literal notranslate"><span class="pre">copy_test_files</span></code> here is for illustration purposes.
You are free to use a name that is more suited to your package.</p>
<p>The key to copying files for stand-alone testing at build time is use
of the <code class="docutils literal notranslate"><span class="pre">run_after</span></code> directive, which ensures the associated files are
copied <strong>after</strong> the provided build stage (<code class="docutils literal notranslate"><span class="pre">install</span></code>) when the installation
prefix <strong>and</strong> files are available.</p>
<p>The test method uses the path contained in the package’s
<code class="docutils literal notranslate"><span class="pre">self.test_suite.current_test_cache_dir</span></code> property for the root directory
of the copied files. In this case, that’s the <code class="docutils literal notranslate"><span class="pre">examples</span></code> subdirectory.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want to see more examples from packages that cache build files, run
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">pkg</span> <span class="pre">grep</span> <span class="pre">cache_extra_test_sources</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">&quot;s/\/package.py.*//g&quot;</span> <span class="pre">|</span> <span class="pre">sort</span> <span class="pre">-u</span></code>
from the command line to get a list of the packages.</p>
</div>
</section>
<section id="adding-custom-files">
<span id="cache-custom-files"></span><h4>Adding custom files<a class="headerlink" href="#adding-custom-files" title="Link to this heading"></a></h4>
<p>Sometimes it is helpful or necessary to include custom files for building and
or checking the results of tests as part of the package. Examples of the types
of files that might be useful are:</p>
<ul class="simple">
<li><p>test source files</p></li>
<li><p>test input files</p></li>
<li><p>test build scripts</p></li>
<li><p>expected test outputs</p></li>
</ul>
<p>While obtaining such files from the software repository is preferred (see
<a class="reference internal" href="#cache-extra-test-sources"><span class="std std-ref">Saving build- and install-time files</span></a>), there are circumstances where doing so is not
feasible such as when the software is not being actively maintained. When test
files cannot be obtained from the repository or there is a need to supplement
files that can, Spack supports the inclusion of additional files under the
<code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectory of the package in the Spack repository.</p>
<p>The following example assumes a <code class="docutils literal notranslate"><span class="pre">custom-example.c</span></code> is saved in <code class="docutils literal notranslate"><span class="pre">MyLibary</span></code>
package’s <code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectory. It also assumes the program simply needs to
be compiled and linked against the installed <code class="docutils literal notranslate"><span class="pre">MyLibrary</span></code> software.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyLibrary</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="n">test_requires_compiler</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_custom_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;build and run custom-example&quot;&quot;&quot;</span>
        <span class="n">src_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_suite</span><span class="o">.</span><span class="n">current_test_data_dir</span>
        <span class="n">exe</span> <span class="o">=</span> <span class="s2">&quot;custom-example&quot;</span>

        <span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="n">src_dir</span><span class="p">):</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CC&quot;</span><span class="p">])</span>
            <span class="n">cc</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;-L</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;-I</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exe</span><span class="si">}</span><span class="s2">.cpp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">exe</span>
            <span class="p">)</span>

            <span class="n">custom_example</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
            <span class="n">custom_example</span><span class="p">()</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">run</span></code> for the package results in Spack copying
the contents of the <code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectory to the test stage directory path
in <code class="docutils literal notranslate"><span class="pre">self.test_suite.current_test_data_dir</span></code> before calling
<code class="docutils literal notranslate"><span class="pre">test_custom_example</span></code>. Use of the <code class="docutils literal notranslate"><span class="pre">working_dir</span></code> context manager
ensures the commands to build and run the program are performed from
within the appropriate subdirectory of the test stage.</p>
</section>
<section id="reading-expected-output-from-a-file">
<span id="expected-test-output-from-file"></span><h4>Reading expected output from a file<a class="headerlink" href="#reading-expected-output-from-a-file" title="Link to this heading"></a></h4>
<p>The helper function <code class="docutils literal notranslate"><span class="pre">get_escaped_text_output</span></code> is available for packages
to retrieve properly formatted text from a file potentially containing
special characters.</p>
<p>The signature for <code class="docutils literal notranslate"><span class="pre">get_escaped_text_output</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_escaped_text_output</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">filename</span></code> is the path to the file containing the expected output.</p>
<p>The path provided to <code class="docutils literal notranslate"><span class="pre">filename</span></code> for one of the copied custom files
(<a class="reference internal" href="#cache-custom-files"><span class="std std-ref">custom file</span></a>) is in the path rooted at
<code class="docutils literal notranslate"><span class="pre">self.test_suite.current_test_data_dir</span></code>.</p>
<p>The example below shows how to reference both the custom database
(<code class="docutils literal notranslate"><span class="pre">packages.db</span></code>) and expected output (<code class="docutils literal notranslate"><span class="pre">dump.out</span></code>) files Spack copies
to the test stage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">Sqlite</span><span class="p">(</span><span class="n">AutotoolsPackage</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check example table dump&quot;&quot;&quot;</span>
        <span class="n">test_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_suite</span><span class="o">.</span><span class="n">current_test_data_dir</span>
        <span class="n">db_filename</span> <span class="o">=</span> <span class="n">test_data_dir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;packages.db&quot;</span><span class="p">)</span>
        <span class="o">..</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">get_escaped_text_output</span><span class="p">(</span><span class="n">test_data_dir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;dump.out&quot;</span><span class="p">))</span>
        <span class="n">sqlite3</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">sqlite3</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">(</span>
            <span class="n">db_filename</span><span class="p">,</span> <span class="s2">&quot;.dump&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">out</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected &#39;</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">&#39; in output&quot;</span>
</pre></div>
</div>
<p>If the files were instead cached from installing the software, the paths to the
two files would be found under the <code class="docutils literal notranslate"><span class="pre">self.test_suite.current_test_cache_dir</span></code>
directory as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check example table dump&quot;&quot;&quot;</span>
    <span class="n">test_cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_suite</span><span class="o">.</span><span class="n">current_test_cache_dir</span>
    <span class="n">db_filename</span> <span class="o">=</span> <span class="n">test_cache_dir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;packages.db&quot;</span><span class="p">)</span>
    <span class="o">..</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">get_escaped_text_output</span><span class="p">(</span><span class="n">test_cache_dir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;dump.out&quot;</span><span class="p">))</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Alternatively, if both files had been installed by the software into the
<code class="docutils literal notranslate"><span class="pre">share/tests</span></code> subdirectory of the installation prefix, the paths to the
two files would be referenced as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check example table dump&quot;&quot;&quot;</span>
    <span class="n">db_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">share</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;packages.db&quot;</span><span class="p">)</span>
    <span class="o">..</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">get_escaped_text_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">share</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;dump.out&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="comparing-expected-to-actual-outputs">
<span id="check-outputs"></span><h4>Comparing expected to actual outputs<a class="headerlink" href="#comparing-expected-to-actual-outputs" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">check_outputs</span></code> helper routine is available for packages to ensure
multiple expected outputs from running an executable are contained within
the actual outputs.</p>
<p>The signature for <code class="docutils literal notranslate"><span class="pre">check_outputs</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_outputs</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
</pre></div>
</div>
<p>where each argument has the expected type and meaning:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">expected</span></code> is a string or list of strings containing the expected (raw)
output.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">actual</span></code> is a string containing the actual output from executing the command</p></li>
</ul>
<p>Invoking the method is the equivalent of:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected &#39;</span><span class="si">{</span><span class="n">check</span><span class="si">}</span><span class="s2">&#39; in output &#39;</span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want to see more examples from packages that use this helper, run
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">pkg</span> <span class="pre">grep</span> <span class="pre">check_outputs</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">&quot;s/\/package.py.*//g&quot;</span> <span class="pre">|</span> <span class="pre">sort</span> <span class="pre">-u</span></code>
from the command line to get a list of the packages.</p>
</div>
</section>
<section id="finding-package-and-test-related-files">
<span id="accessing-files"></span><h4>Finding package- and test-related files<a class="headerlink" href="#finding-package-and-test-related-files" title="Link to this heading"></a></h4>
<p>You may need to access files from one or more locations when writing
stand-alone tests. This can happen if the software’s repository does not
include test source files or includes them but has no way to build the
executables using the installed headers and libraries. In these cases
you may need to reference the files relative to one or more root directory.
The table below lists relevant path properties and provides additional
examples of their use. See <a class="reference internal" href="#expected-test-output-from-file"><span class="std std-ref">Reading expected output from a file</span></a> for
examples of accessing files saved from the software repository, package
repository, and installation.</p>
<table class="docutils align-default" id="id28">
<caption><span class="caption-text">Directory-to-property mapping</span><a class="headerlink" href="#id28" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Root Directory</p></th>
<th class="head"><p>Package Property</p></th>
<th class="head"><p>Example(s)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Package (Spec) Installation</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.prefix</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.prefix.include</span></code>, <code class="docutils literal notranslate"><span class="pre">self.prefix.lib</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Dependency Installation</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.spec[&quot;&lt;dependency-package&gt;&quot;].prefix</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.spec[&quot;trilinos&quot;].prefix.include</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Test Suite Stage</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.test_suite.stage</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">join_path(self.test_suite.stage,</span> <span class="pre">&quot;results.txt&quot;)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Spec’s Test Stage</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.test_suite.test_dir_for_spec(&lt;spec&gt;)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.test_suite.test_dir_for_spec(self.spec)</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Current Spec’s Build-time Files</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.test_suite.current_test_cache_dir</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">join_path(self.test_suite.current_test_cache_dir.examples,</span> <span class="pre">&quot;foo.c&quot;)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Current Spec’s Custom Test Files</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">self.test_suite.current_test_data_dir</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">join_path(self.test_suite.current_test_data_dir,</span> <span class="pre">&quot;hello.f90&quot;)</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="inheriting-stand-alone-tests">
<span id="inheriting-tests"></span><h4>Inheriting stand-alone tests<a class="headerlink" href="#inheriting-stand-alone-tests" title="Link to this heading"></a></h4>
<p>Stand-alone tests defined in parent (.e.g., <a class="reference internal" href="build_systems.html#build-systems"><span class="std std-ref">Build Systems</span></a>) and
virtual (e.g., <a class="reference internal" href="#virtual-dependencies"><span class="std std-ref">Virtual dependencies</span></a>) packages are executed by
packages that inherit from or provide interface implementations for those
packages, respectively.</p>
<p>The table below summarizes the stand-alone tests that will be executed along
with those implemented in the package itself.</p>
<table class="docutils align-default" id="id29">
<caption><span class="caption-text">Inherited/provided stand-alone tests</span><a class="headerlink" href="#id29" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Parent/Provider Package</p></th>
<th class="head"><p>Stand-alone Tests</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/c">C</a></p></td>
<td><p>Compiles <code class="docutils literal notranslate"><span class="pre">hello.c</span></code> and runs it</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/cxx">Cxx</a></p></td>
<td><p>Compiles and runs several <code class="docutils literal notranslate"><span class="pre">hello</span></code> programs</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/fortran">Fortran</a></p></td>
<td><p>Compiles and runs <code class="docutils literal notranslate"><span class="pre">hello</span></code> programs (<code class="docutils literal notranslate"><span class="pre">F</span></code> and <code class="docutils literal notranslate"><span class="pre">f90</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/mpi">Mpi</a></p></td>
<td><p>Compiles and runs <code class="docutils literal notranslate"><span class="pre">mpi_hello</span></code> (<code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">fortran</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="build_systems/pythonpackage.html#pythonpackage"><span class="std std-ref">PythonPackage</span></a></p></td>
<td><p>Imports modules listed in the <code class="docutils literal notranslate"><span class="pre">self.import_modules</span></code> property with defaults derived from the tarball</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="build_systems/sippackage.html#sippackage"><span class="std std-ref">SipPackage</span></a></p></td>
<td><p>Imports modules listed in the <code class="docutils literal notranslate"><span class="pre">self.import_modules</span></code> property with defaults derived from the tarball</p></td>
</tr>
</tbody>
</table>
<p>These tests are very basic so it is important that package developers and
maintainers provide additional stand-alone tests customized to the package.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Any package that implements a test method with the same name as an
inherited method will override the inherited method. If that is not the
goal and you are not explicitly calling and adding functionality to
the inherited method for the test, then make sure that all test methods
and embedded test parts have unique test names.</p>
</div>
<p>One example of a package that adds its own stand-alone tests to those
“inherited” by the virtual package it provides an implementation for is
the <a class="reference external" href="https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/openmpi/package.py">Openmpi package</a>.</p>
<p>Below are snippets from running and viewing the stand-alone test results
for <code class="docutils literal notranslate"><span class="pre">openmpi</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span><span class="nb">test</span><span class="w"> </span>run<span class="w"> </span>--alias<span class="w"> </span>openmpi<span class="w"> </span>openmpi@4.1.4
<span class="go">==&gt; Spack test openmpi</span>
<span class="go">==&gt; Testing package openmpi-4.1.4-ubmrigj</span>
<span class="go">============================== 1 passed of 1 spec ==============================</span>

<span class="gp">$ </span>spack<span class="w"> </span><span class="nb">test</span><span class="w"> </span>results<span class="w"> </span>-l<span class="w"> </span>openmpi
<span class="go">==&gt; Results for test suite &#39;openmpi&#39;:</span>
<span class="go">==&gt; test specs:</span>
<span class="go">==&gt;   openmpi-4.1.4-ubmrigj PASSED</span>
<span class="go">==&gt; Testing package openmpi-4.1.4-ubmrigj</span>
<span class="go">==&gt; [2023-03-10-16:03:56.160361] Installing $spack/opt/spack/linux-rhel7-broadwell/gcc-8.3.1/openmpi-4.1.4-ubmrigjrqcafh3hffqcx7yz2nc5jstra/.spack/test to $test_stage/xez37ekynfbi4e7h4zdndfemzufftnym/openmpi-4.1.4-ubmrigj/cache/openmpi</span>
<span class="go">==&gt; [2023-03-10-16:03:56.625204] test: test_bin: test installed binaries</span>
<span class="go">==&gt; [2023-03-10-16:03:56.625439] test: test_bin_mpirun: run and check output of mpirun</span>
<span class="go">==&gt; [2023-03-10-16:03:56.629807] &#39;$spack/opt/spack/linux-rhel7-broadwell/gcc-8.3.1/openmpi-4.1.4-ubmrigjrqcafh3hffqcx7yz2nc5jstra/bin/mpirun&#39; &#39;-n&#39; &#39;1&#39; &#39;ls&#39; &#39;..&#39;</span>
<span class="go">openmpi-4.1.4-ubmrigj            repo</span>
<span class="go">openmpi-4.1.4-ubmrigj-test-out.txt  test_suite.lock</span>
<span class="go">PASSED: test_bin_mpirun</span>
<span class="go">...</span>
<span class="go">==&gt; [2023-03-10-16:04:01.486977] test: test_version_oshcc: ensure version of oshcc is 8.3.1</span>
<span class="go">SKIPPED: test_version_oshcc: oshcc is not installed</span>
<span class="go">...</span>
<span class="go">==&gt; [2023-03-10-16:04:02.215227] Completed testing</span>
<span class="go">==&gt; [2023-03-10-16:04:02.215597]</span>
<span class="go">======================== SUMMARY: openmpi-4.1.4-ubmrigj ========================</span>
<span class="go">Openmpi::test_bin_mpirun .. PASSED</span>
<span class="go">Openmpi::test_bin_ompi_info .. PASSED</span>
<span class="go">Openmpi::test_bin_oshmem_info .. SKIPPED</span>
<span class="go">Openmpi::test_bin_oshrun .. SKIPPED</span>
<span class="go">Openmpi::test_bin_shmemrun .. SKIPPED</span>
<span class="go">Openmpi::test_bin .. PASSED</span>
<span class="go">...</span>
<span class="go">============================== 1 passed of 1 spec ==============================</span>
</pre></div>
</div>
</section>
<section id="spack-test-list">
<span id="cmd-spack-test-list"></span><h4><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">list</span></code><a class="headerlink" href="#spack-test-list" title="Link to this heading"></a></h4>
<p>Packages available for install testing can be found using the
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">list</span></code> command. The command outputs all installed
packages that have defined stand-alone test methods.</p>
<p>Alternatively you can use the <code class="docutils literal notranslate"><span class="pre">--all</span></code> option to get a list of
all packages that have stand-alone test methods even if the packages
are not installed.</p>
<p>For more information, refer to <a class="reference external" href="https://spack.readthedocs.io/en/latest/command_index.html#spack-test-list">spack test list</a>.</p>
</section>
<section id="spack-test-run">
<span id="cmd-spack-test-run"></span><h4><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">run</span></code><a class="headerlink" href="#spack-test-run" title="Link to this heading"></a></h4>
<p>Install tests can be run for one or more installed packages using
the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">run</span></code> command. A <code class="docutils literal notranslate"><span class="pre">test</span> <span class="pre">suite</span></code> is created for all
of the provided specs. The command accepts the same arguments provided
to <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> (see <a class="reference internal" href="basic_usage.html#sec-specs"><span class="std std-ref">Specs &amp; dependencies</span></a>). If no specs are provided
the command tests all specs in the active environment or all specs
installed in the Spack instance if no environment is active.</p>
<p>Test suites can be named using the <code class="docutils literal notranslate"><span class="pre">--alias</span></code> option. Unaliased
test suites use the content hash of their specs as their name.</p>
<p>Some of the more commonly used debugging options are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--fail-fast</span></code> stops testing each package after the first failure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--fail-first</span></code> stops testing packages after the first failure</p></li>
</ul>
<p>Test output is written to a text log file by default though <code class="docutils literal notranslate"><span class="pre">junit</span></code>
and <code class="docutils literal notranslate"><span class="pre">cdash</span></code> are outputs available through the <code class="docutils literal notranslate"><span class="pre">--log-format</span></code> option.</p>
<p>For more information, refer to <a class="reference external" href="https://spack.readthedocs.io/en/latest/command_index.html#spack-test-run">spack test run</a>.</p>
</section>
<section id="spack-test-results">
<span id="cmd-spack-test-results"></span><h4><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">results</span></code><a class="headerlink" href="#spack-test-results" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">results</span></code> command shows results for all completed
test suites by default. The alias or content hash can be provided to
limit reporting to the corresponding test suite.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--logs</span></code> option includes the output generated by the associated
test(s) to facilitate debugging.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--failed</span></code> option limits results shown to that of the failed
tests, if any, of matching packages.</p>
<p>For more information, refer to <a class="reference external" href="https://spack.readthedocs.io/en/latest/command_index.html#spack-test-results">spack test results</a>.</p>
</section>
<section id="spack-test-find">
<span id="cmd-spack-test-find"></span><h4><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">find</span></code><a class="headerlink" href="#spack-test-find" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">find</span></code> command lists the aliases or content hashes
of all test suites whose results are available.</p>
<p>For more information, refer to <a class="reference external" href="https://spack.readthedocs.io/en/latest/command_index.html#spack-test-find">spack test find</a>.</p>
</section>
<section id="spack-test-remove">
<span id="cmd-spack-test-remove"></span><h4><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">remove</span></code><a class="headerlink" href="#spack-test-remove" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">test</span> <span class="pre">remove</span></code> command removes test suites to declutter
the test stage directory. You are prompted to confirm the removal
of each test suite <strong>unless</strong> you use the <code class="docutils literal notranslate"><span class="pre">--yes-to-all</span></code> option.</p>
<p>For more information, refer to <a class="reference external" href="https://spack.readthedocs.io/en/latest/command_index.html#spack-test-remove">spack test remove</a>.</p>
</section>
</section>
</section>
<section id="file-manipulation-functions">
<span id="file-manipulation"></span><h2>File manipulation functions<a class="headerlink" href="#file-manipulation-functions" title="Link to this heading"></a></h2>
<p>Many builds are not perfect. If a build lacks an install target, or if
it does not use systems like CMake or autotools, which have standard
ways of setting compilers and options, you may need to edit files or
install some files yourself to get them working with Spack.</p>
<p>You can do this with standard Python code, and Python has rich
libraries with functions for file manipulation and filtering. Spack
also provides a number of convenience functions of its own to make
your life even easier. These functions are described in this section.</p>
<p>All of the functions in this section can be included by simply
running:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>This is already part of the boilerplate for packages created with
<code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">create</span></code>.</p>
<section id="filtering-functions">
<span id="file-filtering"></span><h3>Filtering functions<a class="headerlink" href="#filtering-functions" title="Link to this heading"></a></h3>
<dl>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.filter_file" title="llnl.util.filesystem.filter_file"><code class="xref py py-func docutils literal notranslate"><span class="pre">filter_file(regex,</span> <span class="pre">repl,</span> <span class="pre">*filenames,</span> <span class="pre">**kwargs)</span></code></a></dt><dd><p>Works like <code class="docutils literal notranslate"><span class="pre">sed</span></code> but with Python regular expression syntax.  Takes
a regular expression, a replacement, and a set of files.  <code class="docutils literal notranslate"><span class="pre">repl</span></code>
can be a raw string or a callable function.  If it is a raw string,
it can contain <code class="docutils literal notranslate"><span class="pre">\1</span></code>, <code class="docutils literal notranslate"><span class="pre">\2</span></code>, etc. to refer to capture groups in
the regular expression.  If it is a callable, it is passed the
Python <code class="docutils literal notranslate"><span class="pre">MatchObject</span></code> and should return a suitable replacement
string for the particular match.</p>
<p>Examples:</p>
<ol class="arabic">
<li><p>Filtering a Makefile to force it to use Spack’s compiler wrappers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">filter_file</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*CC\s*=.*&quot;</span><span class="p">,</span>  <span class="s2">&quot;CC = &quot;</span>  <span class="o">+</span> <span class="n">spack_cc</span><span class="p">,</span>  <span class="s2">&quot;Makefile&quot;</span><span class="p">)</span>
<span class="n">filter_file</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*CXX\s*=.*&quot;</span><span class="p">,</span> <span class="s2">&quot;CXX = &quot;</span> <span class="o">+</span> <span class="n">spack_cxx</span><span class="p">,</span> <span class="s2">&quot;Makefile&quot;</span><span class="p">)</span>
<span class="n">filter_file</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*F77\s*=.*&quot;</span><span class="p">,</span> <span class="s2">&quot;F77 = &quot;</span> <span class="o">+</span> <span class="n">spack_f77</span><span class="p">,</span> <span class="s2">&quot;Makefile&quot;</span><span class="p">)</span>
<span class="n">filter_file</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*FC\s*=.*&quot;</span><span class="p">,</span>  <span class="s2">&quot;FC = &quot;</span>  <span class="o">+</span> <span class="n">spack_fc</span><span class="p">,</span>  <span class="s2">&quot;Makefile&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Replacing <code class="docutils literal notranslate"><span class="pre">#!/usr/bin/perl</span></code> with <code class="docutils literal notranslate"><span class="pre">#!/usr/bin/env</span> <span class="pre">perl</span></code> in <code class="docutils literal notranslate"><span class="pre">bib2xhtml</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">filter_file</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#!/usr/bin/perl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#!/usr/bin/env perl&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">bib2xhtml</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Switching the compilers used by <code class="docutils literal notranslate"><span class="pre">mpich</span></code>’s MPI wrapper scripts from
<code class="docutils literal notranslate"><span class="pre">cc</span></code>, etc. to the compilers used by the Spack build:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">filter_file</span><span class="p">(</span><span class="s2">&quot;CC=&#39;cc&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;CC=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">mpicc</span><span class="p">)</span>

<span class="n">filter_file</span><span class="p">(</span><span class="s2">&quot;CXX=&#39;c++&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;CXX=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">cxx</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">mpicxx</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</dd>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.change_sed_delimiter" title="llnl.util.filesystem.change_sed_delimiter"><code class="xref py py-func docutils literal notranslate"><span class="pre">change_sed_delimiter(old_delim,</span> <span class="pre">new_delim,</span> <span class="pre">*filenames)</span></code></a></dt><dd><p>Some packages, like TAU, have a build system that can’t install
into directories with, e.g. “&#64;” in the name, because they use
hard-coded <code class="docutils literal notranslate"><span class="pre">sed</span></code> commands in their build.</p>
<p><code class="docutils literal notranslate"><span class="pre">change_sed_delimiter</span></code> finds all <code class="docutils literal notranslate"><span class="pre">sed</span></code> search/replace commands
and change the delimiter.  e.g., if the file contains commands
that look like <code class="docutils literal notranslate"><span class="pre">s///</span></code>, you can use this to change them to
<code class="docutils literal notranslate"><span class="pre">s&#64;&#64;&#64;</span></code>.</p>
<p>Example of changing <code class="docutils literal notranslate"><span class="pre">s///</span></code> to <code class="docutils literal notranslate"><span class="pre">s&#64;&#64;&#64;</span></code> in TAU:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">change_sed_delimiter</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;configure&quot;</span><span class="p">)</span>
<span class="n">change_sed_delimiter</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;utils/FixMakefile&quot;</span><span class="p">)</span>
<span class="n">change_sed_delimiter</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;utils/FixMakefile.sed.default&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="file-functions">
<h3>File functions<a class="headerlink" href="#file-functions" title="Link to this heading"></a></h3>
<dl>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.ancestor" title="llnl.util.filesystem.ancestor"><code class="xref py py-func docutils literal notranslate"><span class="pre">ancestor(dir,</span> <span class="pre">n=1)</span></code></a></dt><dd><p>Get the n<sup>th</sup> ancestor of the directory <code class="docutils literal notranslate"><span class="pre">dir</span></code>.</p>
</dd>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.can_access" title="llnl.util.filesystem.can_access"><code class="xref py py-func docutils literal notranslate"><span class="pre">can_access(path)</span></code></a></dt><dd><p>True if we can read and write to the file at <code class="docutils literal notranslate"><span class="pre">path</span></code>.  Same as
native python <code class="docutils literal notranslate"><span class="pre">os.access(file_name,</span> <span class="pre">os.R_OK|os.W_OK)</span></code>.</p>
</dd>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.install" title="llnl.util.filesystem.install"><code class="xref py py-func docutils literal notranslate"><span class="pre">install(src,</span> <span class="pre">dest)</span></code></a></dt><dd><p>Install a file to a particular location.  For example, install a
header into the <code class="docutils literal notranslate"><span class="pre">include</span></code> directory under the install <code class="docutils literal notranslate"><span class="pre">prefix</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">install</span><span class="p">(</span><span class="s2">&quot;my-header.h&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.join_path" title="llnl.util.filesystem.join_path"><code class="xref py py-func docutils literal notranslate"><span class="pre">join_path(*paths)</span></code></a></dt><dd><p>An alias for <code class="docutils literal notranslate"><span class="pre">os.path.join</span></code>. This joins paths using the OS path separator.</p>
</dd>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.mkdirp" title="llnl.util.filesystem.mkdirp"><code class="xref py py-func docutils literal notranslate"><span class="pre">mkdirp(*paths)</span></code></a></dt><dd><p>Create each of the directories in <code class="docutils literal notranslate"><span class="pre">paths</span></code>, creating any parent
directories if they do not exist.</p>
</dd>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.working_dir" title="llnl.util.filesystem.working_dir"><code class="xref py py-func docutils literal notranslate"><span class="pre">working_dir(dirname,</span> <span class="pre">kwargs)</span></code></a></dt><dd><p>This is a Python <a class="reference external" href="https://docs.python.org/2/library/contextlib.html">Context Manager</a> that makes it
easier to work with subdirectories in builds.  You use this with the
Python <code class="docutils literal notranslate"><span class="pre">with</span></code> statement to change into a working directory, and
when the with block is done, you change back to the original
directory.  Think of it as a safe <code class="docutils literal notranslate"><span class="pre">pushd</span></code> / <code class="docutils literal notranslate"><span class="pre">popd</span></code> combination,
where <code class="docutils literal notranslate"><span class="pre">popd</span></code> is guaranteed to be called at the end, even if
exceptions are thrown.</p>
<p>Example usage:</p>
<ol class="arabic">
<li><p>The <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code> build first runs <code class="docutils literal notranslate"><span class="pre">configure</span></code> and <code class="docutils literal notranslate"><span class="pre">make</span></code> in a
subdirectory called <code class="docutils literal notranslate"><span class="pre">libdwarf</span></code>.  It then implements the
installation code itself.  This is natural with <code class="docutils literal notranslate"><span class="pre">working_dir</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="s2">&quot;libdwarf&quot;</span><span class="p">):</span>
    <span class="n">configure</span><span class="p">(</span><span class="s2">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;--enable-shared&quot;</span><span class="p">)</span>
    <span class="n">make</span><span class="p">()</span>
    <span class="n">install</span><span class="p">(</span><span class="s2">&quot;libdwarf.a&quot;</span><span class="p">,</span>  <span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Many CMake builds require that you build “out of source”, that
is, in a subdirectory.  You can handle creating and <code class="docutils literal notranslate"><span class="pre">cd</span></code>’ing to
the subdirectory like the LLVM package does:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="s2">&quot;spack-build&quot;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">cmake</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span>
          <span class="s2">&quot;-DLLVM_REQUIRES_RTTI=1&quot;</span><span class="p">,</span>
          <span class="s2">&quot;-DPYTHON_EXECUTABLE=/usr/bin/python&quot;</span><span class="p">,</span>
          <span class="s2">&quot;-DPYTHON_INCLUDE_DIR=/usr/include/python2.6&quot;</span><span class="p">,</span>
          <span class="s2">&quot;-DPYTHON_LIBRARY=/usr/lib64/libpython2.6.so&quot;</span><span class="p">,</span>
          <span class="o">*</span><span class="n">std_cmake_args</span><span class="p">)</span>
    <span class="n">make</span><span class="p">()</span>
    <span class="n">make</span><span class="p">(</span><span class="s2">&quot;install&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">create=True</span></code> keyword argument causes the command to create
the directory if it does not exist.</p>
</li>
</ol>
</dd>
<dt><a class="reference internal" href="llnl.util.html#llnl.util.filesystem.touch" title="llnl.util.filesystem.touch"><code class="xref py py-func docutils literal notranslate"><span class="pre">touch(path)</span></code></a></dt><dd><p>Create an empty file at <code class="docutils literal notranslate"><span class="pre">path</span></code>.</p>
</dd>
</dl>
</section>
</section>
<section id="making-a-package-discoverable-with-spack-external-find">
<span id="make-package-findable"></span><h2>Making a package discoverable with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">external</span> <span class="pre">find</span></code><a class="headerlink" href="#making-a-package-discoverable-with-spack-external-find" title="Link to this heading"></a></h2>
<p>The simplest way to make a package discoverable with
<a class="reference internal" href="packages_yaml.html#cmd-spack-external-find"><span class="std std-ref">spack external find</span></a> is to:</p>
<ol class="arabic simple">
<li><p>Define the executables associated with the package</p></li>
<li><p>Implement a method to determine the versions of these executables</p></li>
</ol>
<section id="minimal-detection">
<h3>Minimal detection<a class="headerlink" href="#minimal-detection" title="Link to this heading"></a></h3>
<p>The first step is fairly simple, as it requires only to
specify a package level <code class="docutils literal notranslate"><span class="pre">executables</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="c1"># Each string provided here is treated as a regular expression, and</span>
    <span class="c1"># would match for example &quot;foo&quot;, &quot;foobar&quot;, and &quot;bazfoo&quot;.</span>
    <span class="n">executables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This attribute must be a list of strings. Each string is a regular
expression (e.g. “gcc” would match “gcc”, “gcc-8.3”, “my-weird-gcc”, etc.) to
determine a set of system executables that might be part or this package. Note
that to match only executables named “gcc” the regular expression <code class="docutils literal notranslate"><span class="pre">&quot;^gcc$&quot;</span></code>
must be used.</p>
<p>Finally to determine the version of each executable the <code class="docutils literal notranslate"><span class="pre">determine_version</span></code>
method must be implemented:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">determine_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exe</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return either the version of the executable passed as argument</span>
<span class="sd">    or ``None`` if the version cannot be determined.</span>

<span class="sd">    Args:</span>
<span class="sd">        exe (str): absolute path to the executable being examined</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>This method receives as input the path to a single executable and must return
as output its version as a string; if the user cannot determine the version
or determines that the executable is not an instance of the package, they can
return None and the exe will be discarded as a candidate.
Implementing the two steps above is mandatory, and gives the package the
basic ability to detect if a spec is present on the system at a given version.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any executable for which the <code class="docutils literal notranslate"><span class="pre">determine_version</span></code> method returns <code class="docutils literal notranslate"><span class="pre">None</span></code>
will be discarded and won’t appear in later stages of the workflow described below.</p>
</div>
</section>
<section id="additional-functionality">
<h3>Additional functionality<a class="headerlink" href="#additional-functionality" title="Link to this heading"></a></h3>
<p>Besides the two mandatory steps described above, there are also optional
methods that can be implemented to either increase the amount of details
being detected or improve the robustness of the detection logic in a package.</p>
<section id="variants-and-custom-attributes">
<h4>Variants and custom attributes<a class="headerlink" href="#variants-and-custom-attributes" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">determine_variants</span></code> method can be optionally implemented in a package
to detect additional details of the spec:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">determine_variants</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exes</span><span class="p">,</span> <span class="n">version_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return either a variant string, a tuple of a variant string</span>
<span class="sd">    and a dictionary of extra attributes that will be recorded in</span>
<span class="sd">    packages.yaml or a list of those items.</span>

<span class="sd">    Args:</span>
<span class="sd">        exes (list of str): list of executables (absolute paths) that</span>
<span class="sd">            live in the same prefix and share the same version</span>
<span class="sd">        version_str (str): version associated with the list of</span>
<span class="sd">            executables, as detected by ``determine_version``</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>This method takes as input a list of executables that live in the same prefix and
share the same version string, and returns either:</p>
<ol class="arabic simple">
<li><p>A variant string</p></li>
<li><p>A tuple of a variant string and a dictionary of extra attributes</p></li>
<li><p>A list of items matching either 1 or 2 (if multiple specs are detected
from the set of executables)</p></li>
</ol>
<p>If extra attributes are returned, they will be recorded in <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code>
and be available for later reuse. As an example, the <code class="docutils literal notranslate"><span class="pre">gcc</span></code> package will record
by default the different compilers found and an entry in <code class="docutils literal notranslate"><span class="pre">packages.yaml</span></code>
would look like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">packages</span><span class="p">:</span>
<span class="w">  </span><span class="nt">gcc</span><span class="p">:</span>
<span class="w">    </span><span class="nt">externals</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gcc@9.0.1</span><span class="nv"> </span><span class="s">languages=c,c++,fortran&quot;</span>
<span class="w">      </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr</span>
<span class="w">      </span><span class="nt">extra_attributes</span><span class="p">:</span>
<span class="w">        </span><span class="nt">compilers</span><span class="p">:</span>
<span class="w">          </span><span class="nt">c</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/x86_64-linux-gnu-gcc-9</span>
<span class="w">          </span><span class="nt">c++</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/x86_64-linux-gnu-g++-9</span>
<span class="w">          </span><span class="nt">fortran</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/x86_64-linux-gnu-gfortran-9</span>
</pre></div>
</div>
<p>This allows us, for instance, to keep track of executables that would be named
differently if built by Spack (e.g. <code class="docutils literal notranslate"><span class="pre">x86_64-linux-gnu-gcc-9</span></code>
instead of just <code class="docutils literal notranslate"><span class="pre">gcc</span></code>).</p>
</section>
<section id="filter-matching-executables">
<h4>Filter matching executables<a class="headerlink" href="#filter-matching-executables" title="Link to this heading"></a></h4>
<p>Sometimes defining the appropriate regex for the <code class="docutils literal notranslate"><span class="pre">executables</span></code>
attribute might prove to be difficult, especially if one has to
deal with corner cases or exclude “red herrings”. To help keeping
the regular expressions as simple as possible, each package can
optionally implement a <code class="docutils literal notranslate"><span class="pre">filter_executables</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">filter_detected_exes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">exes_in_prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a filtered list of the executables in prefix&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>which takes as input a prefix and a list of matching executables and
returns a filtered list of said executables.</p>
<p>Using this method has the advantage of allowing custom logic for
filtering, and does not restrict the user to regular expressions
only.  Consider the case of detecting the GNU C++ compiler. If we
try to search for executables that match <code class="docutils literal notranslate"><span class="pre">g++</span></code>, that would have
the unwanted side effect of selecting also <code class="docutils literal notranslate"><span class="pre">clang++</span></code> - which is
a C++ compiler provided by another package - if present on the system.
Trying to select executables that contain <code class="docutils literal notranslate"><span class="pre">g++</span></code> but not <code class="docutils literal notranslate"><span class="pre">clang</span></code>
would be quite complicated to do using regex only. Employing the
<code class="docutils literal notranslate"><span class="pre">filter_detected_exes</span></code> method it becomes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Gcc</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
   <span class="n">executables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;g++&quot;</span><span class="p">]</span>

   <span class="k">def</span> <span class="nf">filter_detected_exes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">exes_in_prefix</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exes_in_prefix</span> <span class="k">if</span> <span class="s2">&quot;clang&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
<p>Another possibility that this method opens is to apply certain
filtering logic when specific conditions are met (e.g. take some
decisions on an OS and not on another).</p>
</section>
</section>
<section id="validate-detection">
<h3>Validate detection<a class="headerlink" href="#validate-detection" title="Link to this heading"></a></h3>
<p>To increase detection robustness, packagers may also implement a method
to validate the detected Spec objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_detected_spec</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">extra_attributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate a detected spec. Raise an exception if validation fails.&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>This method receives a detected spec along with its extra attributes and can be
used to check that certain conditions are met by the spec. Packagers can either
use assertions or raise an <code class="docutils literal notranslate"><span class="pre">InvalidSpecDetected</span></code> exception when the check fails.
In case the conditions are not honored the spec will be discarded and any message
associated with the assertion or the exception will be logged as the reason for
discarding it.</p>
<p>As an example, a package that wants to check that the <code class="docutils literal notranslate"><span class="pre">compilers</span></code> attribute is
in the extra attributes can implement this method like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_detected_spec</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">extra_attributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that &quot;compilers&quot; is in the extra attributes.&quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;the extra attribute &#39;compilers&#39; must be set for &quot;</span>
           <span class="s2">&quot;the detected spec &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
    <span class="k">assert</span> <span class="s2">&quot;compilers&quot;</span> <span class="ow">in</span> <span class="n">extra_attributes</span><span class="p">,</span> <span class="n">msg</span>
</pre></div>
</div>
<p>or like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_detected_spec</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">extra_attributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that &quot;compilers&quot; is in the extra attributes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;compilers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_attributes</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;the extra attribute &#39;compilers&#39; must be set for &quot;</span>
               <span class="s2">&quot;the detected spec &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">InvalidSpecDetected</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="custom-detection-workflow">
<span id="determine-spec-details"></span><h3>Custom detection workflow<a class="headerlink" href="#custom-detection-workflow" title="Link to this heading"></a></h3>
<p>In the rare case when the mechanisms described so far don’t fit the
detection of a package, the implementation of all the methods above
can be disregarded and instead a custom <code class="docutils literal notranslate"><span class="pre">determine_spec_details</span></code>
method can be implemented directly in the package class (note that
the definition of the <code class="docutils literal notranslate"><span class="pre">executables</span></code> attribute is still required):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">determine_spec_details</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">exes_in_prefix</span><span class="p">):</span>
    <span class="c1"># exes_in_prefix = a set of paths, each path is an executable</span>
    <span class="c1"># prefix = a prefix that is common to each path in exes_in_prefix</span>

    <span class="c1"># return None or [] if none of the exes represent an instance of</span>
    <span class="c1"># the package. Return one or more Specs for each instance of the</span>
    <span class="c1"># package which is thought to be installed in the provided prefix</span>
</pre></div>
</div>
<p>This method takes as input a set of discovered executables (which match
those specified by the user) as well as a common prefix shared by all
of those executables. The function must return one or more <a class="reference internal" href="spack.html#spack.spec.Spec" title="spack.spec.Spec"><code class="xref py py-class docutils literal notranslate"><span class="pre">spack.spec.Spec</span></code></a> associated
with the executables (it can also return <code class="docutils literal notranslate"><span class="pre">None</span></code> to indicate that no
provided executables are associated with the package).</p>
<p>As an example, consider a made-up package called <code class="docutils literal notranslate"><span class="pre">foo-package</span></code> which
builds an executable called <code class="docutils literal notranslate"><span class="pre">foo</span></code>. <code class="docutils literal notranslate"><span class="pre">FooPackage</span></code> would appear as
follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FooPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="c1"># Each string provided here is treated as a regular expression, and</span>
    <span class="c1"># would match for example &quot;foo&quot;, &quot;foobar&quot;, and &quot;bazfoo&quot;.</span>
    <span class="n">executables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">determine_spec_details</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">exes_in_prefix</span><span class="p">):</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exes_in_prefix</span>
                          <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;foo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># This implementation is lazy and only checks the first candidate</span>
        <span class="n">exe_path</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">exe</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">exe_path</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">exe</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">version_str</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># parse output for version string</span>
        <span class="k">return</span> <span class="n">Spec</span><span class="o">.</span><span class="n">from_detection</span><span class="p">(</span>
            <span class="s2">&quot;foo-package@</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version_str</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="add-detection-tests-to-packages">
<h3>Add detection tests to packages<a class="headerlink" href="#add-detection-tests-to-packages" title="Link to this heading"></a></h3>
<p>To ensure that software is detected correctly for multiple configurations
and on different systems users can write a <code class="docutils literal notranslate"><span class="pre">detection_test.yaml</span></code> file and
put it in the package directory alongside the <code class="docutils literal notranslate"><span class="pre">package.py</span></code> file.
This YAML file contains enough information for Spack to mock an environment
and try to check if the detection logic yields the results that are expected.</p>
<p>As a general rule, attributes at the top-level of <code class="docutils literal notranslate"><span class="pre">detection_test.yaml</span></code>
represent search mechanisms and they each map to a list of tests that should confirm
the validity of the package’s detection logic.</p>
<p>The detection tests can be run with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>audit<span class="w"> </span>externals
</pre></div>
</div>
<p>Errors that have been detected are reported to screen.</p>
<section id="tests-for-path-inspections">
<h4>Tests for PATH inspections<a class="headerlink" href="#tests-for-path-inspections" title="Link to this heading"></a></h4>
<p>Detection tests insisting on <code class="docutils literal notranslate"><span class="pre">PATH</span></code> inspections are listed under
the <code class="docutils literal notranslate"><span class="pre">paths</span></code> attribute:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">paths</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">layout</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">executables</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bin/clang-3.9&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bin/clang++-3.9&quot;</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">echo &quot;clang version 3.9.1-19ubuntu1 (tags/RELEASE_391/rc2)&quot;</span>
<span class="w">      </span><span class="no">echo &quot;Target: x86_64-pc-linux-gnu&quot;</span>
<span class="w">      </span><span class="no">echo &quot;Thread model: posix&quot;</span>
<span class="w">      </span><span class="no">echo &quot;InstalledDir: /usr/bin&quot;</span>
<span class="w">  </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;linux&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;darwin&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">results</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;llvm@3.9.1</span><span class="nv"> </span><span class="s">+clang~lld~lldb&#39;</span>
</pre></div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">platforms</span></code> attribute is present, tests are run only if the current host
matches one of the listed platforms.
Each test is performed by first creating a temporary directory structure as
specified in the corresponding <code class="docutils literal notranslate"><span class="pre">layout</span></code> and by then running
package detection and checking that the outcome matches the expected
<code class="docutils literal notranslate"><span class="pre">results</span></code>. The exact details on how to specify both the <code class="docutils literal notranslate"><span class="pre">layout</span></code> and the
<code class="docutils literal notranslate"><span class="pre">results</span></code> are reported in the table below:</p>
<table class="docutils align-default" id="id30">
<caption><span class="caption-text">Test based on PATH inspections</span><a class="headerlink" href="#id30" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Option Name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Allowed Values</p></th>
<th class="head"><p>Required Field</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">layout</span></code></p></td>
<td><p>Specifies the filesystem tree used for the test</p></td>
<td><p>List of objects</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">layout:[0]:executables</span></code></p></td>
<td><p>Relative paths for the mock executables to be created</p></td>
<td><p>List of strings</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">layout:[0]:script</span></code></p></td>
<td><p>Mock logic for the executable</p></td>
<td><p>Any valid shell script</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">results</span></code></p></td>
<td><p>List of expected results</p></td>
<td><p>List of objects (empty if no result is expected)</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">results:[0]:spec</span></code></p></td>
<td><p>A spec that is expected from detection</p></td>
<td><p>Any valid spec</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">results:[0]:extra_attributes</span></code></p></td>
<td><p>Extra attributes expected on the associated Spec</p></td>
<td><p>Nested dictionary with string as keys, and regular expressions as leaf values</p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
</section>
<section id="reuse-tests-from-other-packages">
<h4>Reuse tests from other packages<a class="headerlink" href="#reuse-tests-from-other-packages" title="Link to this heading"></a></h4>
<p>When using a custom repository, it is possible to customize a package that already exists in <code class="docutils literal notranslate"><span class="pre">builtin</span></code>
and reuse its external tests. To do so, just write a <code class="docutils literal notranslate"><span class="pre">detection_tests.yaml</span></code> alongside the customized
<code class="docutils literal notranslate"><span class="pre">package.py</span></code> with an <code class="docutils literal notranslate"><span class="pre">includes</span></code> attribute. For instance the <code class="docutils literal notranslate"><span class="pre">detection_tests.yaml</span></code> for
<code class="docutils literal notranslate"><span class="pre">myrepo.llvm</span></code> might look like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">includes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;builtin.llvm&quot;</span>
</pre></div>
</div>
<p>This YAML file instructs Spack to run the detection tests defined in <code class="docutils literal notranslate"><span class="pre">builtin.llvm</span></code> in addition to
those locally defined in the file.</p>
</section>
</section>
</section>
<section id="style-guidelines-for-packages">
<h2>Style guidelines for packages<a class="headerlink" href="#style-guidelines-for-packages" title="Link to this heading"></a></h2>
<p>The following guidelines are provided, in the interests of making
Spack packages work in a consistent manner:</p>
<section id="variant-names">
<h3>Variant Names<a class="headerlink" href="#variant-names" title="Link to this heading"></a></h3>
<p>Spack packages with variants similar to already-existing Spack
packages should use the same name for their variants.  Standard
variant names are:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>shared</p></td>
<td><p>True</p></td>
<td><p>Build shared libraries</p></td>
</tr>
<tr class="row-odd"><td><p>mpi</p></td>
<td><p>True</p></td>
<td><p>Use MPI</p></td>
</tr>
<tr class="row-even"><td><p>python</p></td>
<td><p>False</p></td>
<td><p>Build Python extension</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>If specified in this table, the corresponding default should be used
when declaring a variant.</p>
<p>The semantics of the <cite>shared</cite> variant are important. When a package is
built <cite>~shared</cite>, the package guarantees that no shared libraries are
built. When a package is built <cite>+shared</cite>, the package guarantees that
shared libraries are built, but it makes no guarantee about whether
static libraries are built.</p>
</section>
<section id="version-lists">
<h3>Version Lists<a class="headerlink" href="#version-lists" title="Link to this heading"></a></h3>
<p>Spack packages should list supported versions with the newest first.</p>
</section>
<section id="using-home-vs-prefix">
<h3>Using <code class="docutils literal notranslate"><span class="pre">home</span></code> vs <code class="docutils literal notranslate"><span class="pre">prefix</span></code><a class="headerlink" href="#using-home-vs-prefix" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">home</span></code> and <code class="docutils literal notranslate"><span class="pre">prefix</span></code> are both attributes that can be queried on a
package’s dependencies, often when passing configure arguments pointing to the
location of a dependency.  The difference is that while <code class="docutils literal notranslate"><span class="pre">prefix</span></code> is the
location on disk where a concrete package resides, <code class="docutils literal notranslate"><span class="pre">home</span></code> is the <cite>logical</cite>
location that a package resides, which may be different than <code class="docutils literal notranslate"><span class="pre">prefix</span></code> in
the case of virtual packages or other special circumstances.  For most use
cases inside a package, its dependency locations can be accessed via either
<code class="docutils literal notranslate"><span class="pre">self.spec[&quot;foo&quot;].home</span></code> or <code class="docutils literal notranslate"><span class="pre">self.spec[&quot;foo&quot;].prefix</span></code>.  Specific packages
that should be consumed by dependents via <code class="docutils literal notranslate"><span class="pre">.home</span></code> instead of <code class="docutils literal notranslate"><span class="pre">.prefix</span></code>
should be noted in their respective documentation.</p>
<p>See <a class="reference internal" href="#custom-attributes"><span class="std std-ref">Custom attributes</span></a> for more details and an example implementing
a custom <code class="docutils literal notranslate"><span class="pre">home</span></code> attribute.</p>
</section>
</section>
<section id="packaging-workflow-commands">
<h2>Packaging workflow commands<a class="headerlink" href="#packaging-workflow-commands" title="Link to this heading"></a></h2>
<p>When you are building packages, you will likely not get things
completely right the first time.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> command performs a number of tasks before it
finally installs each package.  It downloads an archive, expands it in
a temporary directory, and only then gives control to the package’s
<code class="docutils literal notranslate"><span class="pre">install()</span></code> method.  If the build doesn’t go as planned, you may
want to clean up the temporary directory, or if the package isn’t
downloading properly, you might want to run <em>only</em> the <code class="docutils literal notranslate"><span class="pre">fetch</span></code> stage
of the build.</p>
<p>Spack performs best-effort installation of package dependencies by default,
which means it will continue to install as many dependencies as possible
after detecting failures.  If you are trying to install a package with a
lot of dependencies where one or more may fail to build, you might want to
try the <code class="docutils literal notranslate"><span class="pre">--fail-fast</span></code> option to stop the installation process on the first
failure.</p>
<p>A typical package workflow might look like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>edit<span class="w"> </span>mypackage
<span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--fail-fast<span class="w"> </span>mypackage
<span class="go">... build breaks! ...</span>
<span class="gp">$ </span>spack<span class="w"> </span>clean<span class="w"> </span>mypackage
<span class="gp">$ </span>spack<span class="w"> </span>edit<span class="w"> </span>mypackage
<span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--fail-fast<span class="w"> </span>mypackage
<span class="go">... repeat clean/install until install works ...</span>
</pre></div>
</div>
<p>Below are some commands that will allow you some finer-grained
control over the install process.</p>
<section id="spack-fetch">
<span id="cmd-spack-fetch"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">fetch</span></code><a class="headerlink" href="#spack-fetch" title="Link to this heading"></a></h3>
<p>The first step of <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code>.  Takes a spec and determines the
correct download URL to use for the requested package version, then
downloads the archive, checks it against an MD5 checksum, and stores
it in a staging directory if the check was successful.  The staging
directory will be located under the first writable directory in the
<code class="docutils literal notranslate"><span class="pre">build_stage</span></code> configuration setting.</p>
<p>When run after the archive has already been downloaded, <code class="docutils literal notranslate"><span class="pre">spack</span>
<span class="pre">fetch</span></code> is idempotent and will not download the archive again.</p>
</section>
<section id="spack-stage">
<span id="cmd-spack-stage"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">stage</span></code><a class="headerlink" href="#spack-stage" title="Link to this heading"></a></h3>
<p>The second step in <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> after <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">fetch</span></code>.  Expands
the downloaded archive in its temporary directory, where it will be
built by <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code>.  Similar to <code class="docutils literal notranslate"><span class="pre">fetch</span></code>, if the archive has
already been expanded,  <code class="docutils literal notranslate"><span class="pre">stage</span></code> is idempotent.</p>
</section>
<section id="spack-patch">
<span id="cmd-spack-patch"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">patch</span></code><a class="headerlink" href="#spack-patch" title="Link to this heading"></a></h3>
<p>After staging, Spack applies patches to downloaded packages, if any
have been specified in the package file.  This command will run the
install process through the fetch, stage, and patch phases.  Spack
keeps track of whether patches have already been applied and skips
this step if they have been.  If Spack discovers that patches didn’t
apply cleanly on some previous run, then it will restage the entire
package before patching.</p>
</section>
<section id="spack-restage">
<span id="cmd-spack-restage"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">restage</span></code><a class="headerlink" href="#spack-restage" title="Link to this heading"></a></h3>
<p>Restores the source code to pristine state, as it was before building.</p>
<p>Does this in one of two ways:</p>
<ol class="arabic simple">
<li><p>If the source was fetched as a tarball, deletes the entire build
directory and re-expands the tarball.</p></li>
<li><p>If the source was checked out from a repository, this deletes the
build directory and checks it out again.</p></li>
</ol>
</section>
<section id="spack-clean">
<span id="cmd-spack-clean"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">clean</span></code><a class="headerlink" href="#spack-clean" title="Link to this heading"></a></h3>
<p>Cleans up Spack’s temporary and cached files.  This command can be used to
recover disk space if temporary files from interrupted or failed installs
accumulate.</p>
<p>When called with <code class="docutils literal notranslate"><span class="pre">--stage</span></code> or without arguments this removes all staged
files.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--downloads</span></code> option removes cached <a class="reference internal" href="mirrors.html#caching"><span class="std std-ref">cached</span></a> downloads.</p>
<p>You can force the removal of all install failure tracking markers using the
<code class="docutils literal notranslate"><span class="pre">--failures</span></code> option.  Note that <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> will automatically clear
relevant failure markings prior to performing the requested installation(s).</p>
<p>Long-lived caches, like the virtual package index, are removed using the
<code class="docutils literal notranslate"><span class="pre">--misc-cache</span></code> option.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--python-cache</span></code> option removes <cite>.pyc</cite>, <cite>.pyo</cite>, and <cite>__pycache__</cite>
folders.</p>
<p>To remove all of the above, the command can be called with <code class="docutils literal notranslate"><span class="pre">--all</span></code>.</p>
<p>When called with positional arguments, this command cleans up temporary files
only for a particular package. If <code class="docutils literal notranslate"><span class="pre">fetch</span></code>, <code class="docutils literal notranslate"><span class="pre">stage</span></code>, or <code class="docutils literal notranslate"><span class="pre">install</span></code>
are run again after this, Spack’s build process will start from scratch.</p>
</section>
<section id="keeping-the-stage-directory-on-success">
<h3>Keeping the stage directory on success<a class="headerlink" href="#keeping-the-stage-directory-on-success" title="Link to this heading"></a></h3>
<p>By default, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> will delete the staging area once a
package has been successfully built and installed.  Use
<code class="docutils literal notranslate"><span class="pre">--keep-stage</span></code> to leave the build directory intact:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--keep-stage<span class="w"> </span>&lt;spec&gt;
</pre></div>
</div>
<p>This allows you to inspect the build directory and potentially debug
the build.  You can use <code class="docutils literal notranslate"><span class="pre">clean</span></code> later to get rid of the
unwanted temporary files.</p>
</section>
<section id="keeping-the-install-prefix-on-failure">
<h3>Keeping the install prefix on failure<a class="headerlink" href="#keeping-the-install-prefix-on-failure" title="Link to this heading"></a></h3>
<p>By default, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> will delete any partially constructed
install prefix if anything fails during <code class="docutils literal notranslate"><span class="pre">install()</span></code>.  If you want to
keep the prefix anyway (e.g. to diagnose a bug), you can use
<code class="docutils literal notranslate"><span class="pre">--keep-prefix</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>--keep-prefix<span class="w"> </span>&lt;spec&gt;
</pre></div>
</div>
<p>Note that this may confuse Spack into thinking that the package has
been installed properly, so you may need to use <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">uninstall</span> <span class="pre">--force</span></code>
to get rid of the install prefix before you build again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>uninstall<span class="w"> </span>--force<span class="w"> </span>&lt;spec&gt;
</pre></div>
</div>
</section>
</section>
<section id="graphing-dependencies">
<h2>Graphing dependencies<a class="headerlink" href="#graphing-dependencies" title="Link to this heading"></a></h2>
<section id="spack-graph">
<span id="cmd-spack-graph"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">graph</span></code><a class="headerlink" href="#spack-graph" title="Link to this heading"></a></h3>
<p>Spack provides the <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">graph</span></code> command for graphing dependencies.
The command by default generates an ASCII rendering of a spec’s
dependency graph.  For example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack graph hdf5
o hdf5@1.14.5/3xa4j2n
|\
| |\
| | |\
| | | |\
| | | | |\
| | | | | |\
| | o | | | | openmpi@5.0.5/y6e4nso
| |/| | | | | 
|/|/| | | | | 
| | |\| | | | 
| | |\ \ \ \ \
| | | |\ \ \ \ \
| | | | |\ \ \ \ \
| | | | | |\ \ \ \ \
| | | | | | |\ \ \ \ \
| | | | | | | |\ \ \ \ \
| | | | | | | | |\ \ \ \ \
| | | | | | | | | |\ \ \ \ \
| | | | | | | | | | |_|/ / /
| | | | | | | | | |/| | | | 
| | | | | | | | | | |\ \ \ \
| | | | | | | | | | | |_|/ /
| | | | | | | | | | |/| | | 
| | | | | | | | | | | |\ \ \
| | o | | | | | | | | | | | | pmix@5.0.3/zoxh654
| |/| | | | | | | | | | | | | 
|/|/| | | | | | | | | | | | | 
| | |\ \ \ \ \ \ \ \ \ \ \ \ \
| | | |_|_|_|_|/ / / / / / / /
| | |/| | | | | | | | | | | | 
| | | |\ \ \ \ \ \ \ \ \ \ \ \
| | | | |_|_|_|_|/ / / / / / /
| | | |/| | | | | | | | | | | 
| | | | |\ \ \ \ \ \ \ \ \ \ \
| | | | | |_|_|_|_|_|_|_|_|/ /
| | | | |/| | | | | | | | | | 
| | | | | |\ \ \ \ \ \ \ \ \ \
| | | | | | |_|_|_|_|/ / / / /
| | | | | |/| | | | | | | | | 
| | | | | | | |_|_|/ / / / /
| | | | | | |/| | | | | | | 
| | | | | | | | o | | | | | openssh@9.9p1/hdmt67n
| |_|_|_|_|_|_|/| | | | | | 
|/| | | | |_|_|/| | | | | | 
| | | | |/| |_|/| | | | | | 
| | | | | |/| |/| | | | | | 
| | | | | | |/| | | | | | | 
| | | | | | | | |\ \ \ \ \ \
| | | | | | | | | |\ \ \ \ \ \
| | | | | | | | | | |\ \ \ \ \ \
| | | | | | | | | | | |\ \ \ \ \ \
| | | | | | | | | | o | | | | | | | libxcrypt@4.4.35/bqfx45a
| | | | | |_|_|_|_|/| | | | | | | | 
| | | | |/| |_|_|_|/| | | | | | | | 
| | | | | |/| |_|_|/| | | | | | | | 
| | | | | | |/| |_|/ / / / / / / /
| | | | | | | |/| | | | | | | | | 
| | | | | | | | | | o | | | | | | libedit@3.1-20240808/22aex3e
| | |_|_|_|_|_|_|_|/| | | | | | | 
| |/| | | |_|_|_|_|/| | | | | | | 
| | | | |/| |_|_|_|/| | | | | | | 
| | | | | |/| |_|_|/| | | | | | | 
| | | | | | |/| | |/ / / / / / /
| | | | | | | | | | o | | | | | krb5@1.21.3/nj7nyc2
| | |_|_|_|_|_|_|_|/| | | | | | 
| |/| | | |_|_|_|_|/| | | | | | 
| | | | |/| |_|_|_|/| | | | | | 
| | | | | |/| |_|_|/| | | | | | 
| | | | | | |/| |_|/| | | | | | 
| | | | | | | |/| |/| | | | | | 
| | | | | | | | |/| | | | | | | 
| | | | | | | | | | |\ \ \ \ \ \
| | | | | | | | | | | |\ \ \ \ \ \
| | | | | | | | | | | | |\ \ \ \ \ \
| | | | | | | | | | o | | | | | | | | gettext@0.22.5/rk2kv5q
| | | | | |_|_|_|_|/| | | | | | | | | 
| | | | |/| |_|_|_|/| | | | | | | | | 
| | | | | |/| |_|_|/| | | | | | | | | 
| | | | | | |/| | |/| | | | | | | | | 
| | | | | | | | | | |\ \ \ \ \ \ \ \ \
| | | | | | | | | | | |\ \ \ \ \ \ \ \ \
| | | | | | | | | | | | |\ \ \ \ \ \ \ \ \
| | | | | | | | | | | | | |\ \ \ \ \ \ \ \ \
| | | | | | | | | | | o | | | | | | | | | | | tar@1.34/bqowyzl
| | | | | |_|_|_|_|_|/| | | | | | | | | | | | 
| | | | |/| |_|_|_|_|/| | | | | | | | | | | | 
| | | | | |/| |_|_|_|/| | | | | | | | | | | | 
| | | | | | |/| | | |/| | | | | | | | | | | | 
| | | | | | | | | | | |\ \ \ \ \ \ \ \ \ \ \ \
| | | | | | | | | | | | |\ \ \ \ \ \ \ \ \ \ \ \
| | | | | | | | | | | | | |\ \ \ \ \ \ \ \ \ \ \ \
| | | | | | | | | | | | | | |_|/ / / / / / / / / /
| | | | | | | | | | | | | |/| | | | | | | | | | | 
| | | | | | | | | | | | | | |/ / / / / / / / / /
| | | | | | | | | | | o | | | | | | | | | | | | zstd@1.5.6/mratvkn
| | | | | |_|_|_|_|_|/| | | | | | | | | | | | | 
| | | | |/| |_|_|_|_|/| | | | | | | | | | | | | 
| | | | | |/| |_|_|_|/ / / / / / / / / / / / /
| | | | | | |/| | | | | | | | | | | | | | | | 
| | | | | | | | | | | o | | | | | | | | | | | pigz@2.8/hprrocg
| |_|_|_|_|_|_|_|_|_|/| | | | | | | | | | | | 
|/| | | | |_|_|_|_|_|/| | | | | | | | | | | | 
| | | | |/| |_|_|_|_|/| | | | | | | | | | | | 
| | | | | |/| |_|_|_|/ / / / / / / / / / / /
| | | | | | |/| | | | | | | | | | | | | | | 
| | | | | | | | | | | | | | | | o | | | | | bison@3.8.2/xwaivym
| | | | | |_|_|_|_|_|_|_|_|_|_|/| | | | | | 
| | | | |/| |_|_|_|_|_|_|_|_|_|/| | | | | | 
| | | | | |/| |_|_|_|_|_|_|_|_|/| | | | | | 
| | | | | | |/| | | | | | | | |/| | | | | | 
| | | | | | | | | | | | | | | | | o | | | | numactl@2.0.18/ekkauhe
| | | | | |_|_|_|_|_|_|_|_|_|_|_|/| | | | | 
| | | | |/| |_|_|_|_|_|_|_|_|_|_|/| | | | | 
| | | | | |/| |_|_|_|_|_|_|_|_|_|/| | | | | 
| | | | | | |/| | | | | | | | | |/| | | | | 
| | | | | | | | | | | | | | | | | |\| | | | 
| | | | | | | | | | | | | | | | | |\ \ \ \ \
| | | | | | | | | | | | | | | | | | |_|/ / /
| | | | | | | | | | | | | | | | | |/| | | | 
| | | | | | | | | | | | | | | | | | |/ / /
| | | | | | | | | | | | | | | | | | | o | libtool@2.4.7/rtc6l4l
| | | | | |_|_|_|_|_|_|_|_|_|_|_|_|_|/| | 
| | | | |/| |_|_|_|_|_|_|_|_|_|_|_|_|/| | 
| | | | | |/| |_|_|_|_|_|_|_|_|_|_|_|/| | 
| | | | | | |/| | | | | | | | |_|_|_|/| | 
| | | | | | | | | | | | | | |/| | |_|/ /
| | | | | | | | | | | | | | | | |/| | | 
| | | | | | | | | | | | | | o | | | | | findutils@4.9.0/uebccbg
| | | | | |_|_|_|_|_|_|_|_|/| | | | | | 
| | | | |/| |_|_|_|_|_|_|_|/| | | | | | 
| | | | | |/| |_|_|_|_|_|_|/ / / / / /
| | | | | | |/| | | | | | | | | | | | 
| | o | | | | | | | | | | | | | | | | libevent@2.1.12/vheoxfb
| | |\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \
| | | |_|_|_|_|_|/ / / / / / / / / / /
| | |/| | | | | | | | | | | | | | | | 
| | | |\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \
| | | | |_|/ / / / / / / / / / / / / /
| | | |/| | | | | | | | | | | | | | | 
| | | | |\ \ \ \ \ \ \ \ \ \ \ \ \ \ \
| | | | | |_|/ / / / / / / / / / / / /
| | | | |/| | | | | | | | | | | | | | 
| | | | | |/ / / / / / / / / / / / /
| | | | | | o | | | | | | | | | | | hwloc@2.11.1/jos53cy
| | |_|_|_|/| | | | | | | | | | | | 
| |/| | |_|/| | | | | | | | | | | | 
| | | |/| |/| | | | | | | | | | | | 
| | | | |/|/| | | | | | | | | | | | 
| | | | | | |\ \ \ \ \ \ \ \ \ \ \ \
| | | | | | | |_|/ / / / / / / / / /
| | | | | | |/| | | | | | | | | | | 
| | | | | | | |\ \ \ \ \ \ \ \ \ \ \
| | | | | | | | |_|_|_|_|/ / / / / /
| | | | | | | |/| | | | | | | | | | 
| | | | | | | o | | | | | | | | | | libxml2@2.13.4/6kybx6b
| |_|_|_|_|_|/| | | | | | | | | | | 
|/| |_|_|_|_|/| | | | | | | | | | | 
| |/| | |_|_|/| | | | | | | | | | | 
| | | |/| |_|/| | | | | | | | | | | 
| | | | |/| |/| | | | | | | | | | | 
| | | | | |/| | | | | | | | | | | | 
| | | | | | | |\ \ \ \ \ \ \ \ \ \ \
| | | | | | | | |_|_|/ / / / / / / /
| | | | | | | |/| | | | | | | | | | 
| | | | | | | | | |/ / / / / / / /
| | | | | | | | |/| | | | | | | | 
| | | | | | | o | | | | | | | | | xz@5.4.6/63gap6v
| | | | |_|_|/| | | | | | | | | | 
| | | |/| |_|/| | | | | | | | | | 
| | | | |/| |/ / / / / / / / / /
| | | | | |/| | | | | | | | | | 
| | | | | | | | o | | | | | | | libpciaccess@0.17/kq3rfij
| | |_|_|_|_|_|/| | | | | | | | 
| |/| | |_|_|_|/| | | | | | | | 
| | | |/| |_|_|/| | | | | | | | 
| | | | |/| |_|/| | | | | | | | 
| | | | | |/| | | | | | | | | | 
| | | | | | | | o | | | | | | | util-macros@1.20.1/qsekmpr
| | | | |_|_|_|/| | | | | | | | 
| | | |/| |_|_|/| | | | | | | | 
| | | | |/| |_|/ / / / / / / /
| | | | | |/| | | | | | | | | 
| | | | | | | | | | | | o | | automake@1.16.5/zqxst36
| | | | |_|_|_|_|_|_|_|/| | | 
| | | |/| |_|_|_|_|_|_|/| | | 
| | | | |/| |_|_|_|_|_|/| | | 
| | | | | |/| | | |_|_|/| | | 
| | | | | | | | |/| | | | | | 
| | | | | | | | | | | | |/ /
| | | | | | | | | | | | o | autoconf@2.72/gtwt2yv
| | | | |_|_|_|_|_|_|_|/| | 
| | | |/| |_|_|_|_|_|_|/| | 
| | | | |/| |_|_|_|_|_|/| | 
| | | | | |/| | | |_|_|/| | 
| | | | | | | | |/| | |/ /
| | | | | | | | | | | o | m4@1.4.19/rndyocu
| | | | |_|_|_|_|_|_|/| | 
| | | |/| |_|_|_|_|_|/| | 
| | | | |/| |_|_|_|_|/| | 
| | | | | |/| | | | |/| | 
| | | | | | | | | | | o | libsigsegv@2.14/oqjcv7v
| | | | |_|_|_|_|_|_|/| | 
| | | |/| |_|_|_|_|_|/| | 
| | | | |/| |_|_|_|_|/ /
| | | | | |/| | | | | | 
| | | | | | | | | | | o cmake@3.30.5/waqqngz
| |_|_|_|_|_|_|_|_|_|/| 
|/| | | |_|_|_|_|_|_|/| 
| | | |/| |_|_|_|_|_|/| 
| | | | |/| |_|_|_|_|/| 
| | | | | |/| |_|_|_|/| 
| | | | | | |/| | | | | 
| | | | | | | | | | | o curl@8.10.1/7juqacd
| |_|_|_|_|_|_|_|_|_|/| 
|/| |_|_|_|_|_|_|_|_|/| 
| |/| |_|_|_|_|_|_|_|/| 
| | |/| |_|_|_|_|_|_|/| 
| | | |/| |_|_|_|_|_|/| 
| | | | |/| |_|_|_|_|/| 
| | | | | |/| | | | | | 
| | o | | | | | | | | | openssl@3.4.0/rurjepz
| |/| | | | | | | | | | 
|/| | | | | | | | | | | 
| | |\| | | | | | | | | 
| | |\ \ \ \ \ \ \ \ \ \
| | | |_|_|_|_|_|/ / / /
| | |/| | | | | | | | | 
| | | |\ \ \ \ \ \ \ \ \
| | | | |_|/ / / / / / /
| | | |/| | | | | | | | 
| | | | |\ \ \ \ \ \ \ \
| | | | | |_|/ / / / / /
| | | | |/| | | | | | | 
| | o | | | | | | | | | perl@5.40.0/hydwfvq
| |/| | | | | | | | | | 
|/| | | | | | | | | | | 
| | |\| | | | | | | | | 
| | |\ \ \ \ \ \ \ \ \ \
| | | |_|_|_|/ / / / / /
| | |/| | | | | | | | | 
| | | |\ \ \ \ \ \ \ \ \
| | | | |\ \ \ \ \ \ \ \ \
| | | | | |_|/ / / / / / /
| | | | |/| | | | | | | | 
| | | | | |\ \ \ \ \ \ \ \
| | | | | | |_|_|_|_|/ / /
| | | | | |/| | | | | | | 
o | | | | | | | | | | | | zlib-ng@2.2.1/5f2j4la
|\ \ \ \ \ \ \ \ \ \ \ \ \
| |_|/ / / / / / / / / / /
|/| | | | | | | | | | | | 
| |\ \ \ \ \ \ \ \ \ \ \ \
| | |_|_|_|_|_|/ / / / / /
| |/| | | | | | | | | | | 
| | | |/ / / / / / / / /
| | |/| | | | | | | | | 
| | | | o | | | | | | | gdbm@1.23/mt2zasm
| |_|_|/| | | | | | | | 
|/| |_|/| | | | | | | | 
| |/| |/| | | | | | | | 
| | |/| | | | | | | | | 
| | | | o | | | | | | | readline@8.2/f5zgaz5
| |_|_|/| | | | | | | | 
|/| |_|/| | | | | | | | 
| |/| |/| | | | | | | | 
| | |/| | | | | | | | | 
| | | | | |_|_|/ / / /
| | | | |/| | | | | | 
| | | | o | | | | | | ncurses@6.5/y7tmbwn
| |_|_|/| | | | | | | 
|/| |_|/| | | | | | | 
| |/| |/| | | | | | | 
| | |/|/ / / / / / /
| | | | o | | | | | bzip2@1.0.8/kucl3bp
| |_|_|/| | | | | | 
|/| |_|/| | | | | | 
| |/| |/| | | | | | 
| | |/| | | | | | | 
| | | | | |_|_|/ /
| | | | |/| | | | 
| | | | | o | | | berkeley-db@18.1.40/swbcisl
| |_|_|_|/| | | | 
|/| |_|_|/| | | | 
| |/| |_|/ / / /
| | |/| | | | | 
| | | | | o | | ca-certificates-mozilla@2023-05-30/fiyfoue
| | |_|_|/| | | 
| |/| |_|/ / /
| | |/| | | | 
| | | | | | o nghttp2@1.63.0/yibguy5
| |_|_|_|_|/| 
|/| |_|_|_|/| 
| |/| |_|_|/| 
| | |/| |_|/| 
| | | |/| |/
| | | | |/| 
| | | o | | pkgconf@2.2.0/2s2fcky
| |_|/| | | 
|/| |/| | | 
| |/|/ / /
| | | o | diffutils@3.10/t2urhi7
| |_|/| | 
|/| |/| | 
| |/|/| | 
| | | |/
| | | o libiconv@1.17/74gluth
| |_|/| 
|/| |/| 
| |/|/
o | | gmake@4.4.1/5s4jmbz
|\| | 
| |/
|/| 
o | gcc-runtime@14.2.0/oe3t54k
|/
o glibc@2.39/zcm2goi
</pre></div>
</div>
<p>At the top is the root package in the DAG, with dependency edges emerging
from it.  On a color terminal, the edges are colored by which dependency
they lead to.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack graph --deptype=link hdf5
o hdf5@1.14.5/3xa4j2n
|\
| |\
| | |\
| o | | openmpi@5.0.5/y6e4nso
|/| | | 
| |\| | 
| |\ \ \
| | |\ \ \
| | | |\ \ \
| | | | |\ \ \
| | | | | | |/
| | | | | |/| 
| o | | | | | pmix@5.0.3/zoxh654
|/| | | | | | 
| |\ \ \ \ \ \
| | |_|/ / / /
| |/| | | | | 
| | |\ \ \ \ \
| | | |_|/ / /
| | |/| | | | 
| | | |\ \ \ \
| | | | |_|_|/
| | | |/| | | 
| | | | |/ /
| | | | | o numactl@2.0.18/ekkauhe
| | | | |/| 
| | | |/|/
| o | | | libevent@2.1.12/vheoxfb
| |\ \ \ \
| | |\ \ \ \
| | | |_|/ /
| | |/| | | 
| | | |/ /
| o | | | openssl@3.4.0/rurjepz
|/| | | | 
| |\| | | 
| | |/ /
| |/| | 
| | | o hwloc@2.11.1/jos53cy
| | |/| 
| |/|/| 
| | | |\
| | | | |\
| | | o | | ncurses@6.5/y7tmbwn
| | |/| | | 
| |/|/ / /
| | | o | libxml2@2.13.4/6kybx6b
| |_|/| | 
|/| |/| | 
| |/|/| | 
| | | |\ \
o | | | | | zlib-ng@2.2.1/5f2j4la
|\| | | | | 
| |/ / / /
|/| | | | 
| | o | | xz@5.4.6/63gap6v
| |/| | | 
|/|/ / /
| | o | libiconv@1.17/74gluth
| |/| | 
|/|/ /
| | o libpciaccess@0.17/kq3rfij
| |/| 
|/|/
| o gcc-runtime@14.2.0/oe3t54k
|/
o glibc@2.39/zcm2goi
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">deptype</span></code> argument tells Spack what types of dependencies to graph.
By default it includes link and run dependencies but not build
dependencies.  Supplying <code class="docutils literal notranslate"><span class="pre">--deptype=link</span></code> will show only link
dependencies.  The default is <code class="docutils literal notranslate"><span class="pre">--deptype=all</span></code>, which is equivalent to
<code class="docutils literal notranslate"><span class="pre">--deptype=build,link,run,test</span></code>.  Options for <code class="docutils literal notranslate"><span class="pre">deptype</span></code> include:</p>
<ul class="simple">
<li><p>Any combination of <code class="docutils literal notranslate"><span class="pre">build</span></code>, <code class="docutils literal notranslate"><span class="pre">link</span></code>, <code class="docutils literal notranslate"><span class="pre">run</span></code>, and <code class="docutils literal notranslate"><span class="pre">test</span></code> separated
by commas.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all</span></code> for all types of dependencies.</p></li>
</ul>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">graph</span></code> to generate graphs in the widely used
<a class="reference external" href="http://www.graphviz.org/doc/info/lang.html">Dot</a> format.  For example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack graph --dot hdf5
digraph G {
  labelloc = &quot;b&quot;
  rankdir = &quot;TB&quot;
  ranksep = &quot;1&quot;
  edge[
     penwidth=2
  ]
  node[
     fontname=Monaco,
     penwidth=4,
     fontsize=24,
     margin=.4,
     shape=box,
     fillcolor=lightblue,
     style=&quot;rounded,filled&quot;
  ]

  &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot; [label=&quot;automake@1.16.5%gcc@=14.2.0/zqxst36&quot;]
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; [label=&quot;gettext@0.22.5%gcc@=14.2.0/rk2kv5q&quot;]
  &quot;f5zgaz576a2zojjyuaz3ymnzvstzborx&quot; [label=&quot;readline@8.2%gcc@=14.2.0/f5zgaz5&quot;]
  &quot;hprrocgasm6bja7tgccshpywn6pcazyl&quot; [label=&quot;pigz@2.8%gcc@=14.2.0/hprrocg&quot;]
  &quot;swbcislx4vo7mlyfmry6m2gd2frhinba&quot; [label=&quot;berkeley-db@18.1.40%gcc@=14.2.0/swbcisl&quot;]
  &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot; [label=&quot;openssl@3.4.0%gcc@=14.2.0/rurjepz&quot;]
  &quot;63gap6vc37lccrqq66f5jjnnbteqngun&quot; [label=&quot;xz@5.4.6%gcc@=14.2.0/63gap6v&quot;]
  &quot;bqfx45amenwrxfajcm4rfnfw2yao7z44&quot; [label=&quot;libxcrypt@4.4.35%gcc@=14.2.0/bqfx45a&quot;]
  &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot; [label=&quot;libiconv@1.17%gcc@=14.2.0/74gluth&quot;]
  &quot;mt2zasm5w6tjup32zrzyn2nv7txrjp2j&quot; [label=&quot;gdbm@1.23%gcc@=14.2.0/mt2zasm&quot;]
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; [label=&quot;openssh@9.9p1%gcc@=14.2.0/hdmt67n&quot;]
  &quot;kq3rfij4vufcj2ef3dkwtqw37cs6zwfm&quot; [label=&quot;libpciaccess@0.17%gcc@=14.2.0/kq3rfij&quot;]
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; [label=&quot;openmpi@5.0.5%gcc@=14.2.0/y6e4nso&quot;]
  &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot; [label=&quot;bzip2@1.0.8%gcc@=14.2.0/kucl3bp&quot;]
  &quot;vheoxfbu5djx4pkkuvyjtf64ozjzaowr&quot; [label=&quot;libevent@2.1.12%gcc@=14.2.0/vheoxfb&quot;]
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; [label=&quot;numactl@2.0.18%gcc@=14.2.0/ekkauhe&quot;]
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; [label=&quot;pmix@5.0.3%gcc@=14.2.0/zoxh654&quot;]
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; [label=&quot;hdf5@1.14.5%gcc@=14.2.0/3xa4j2n&quot;]
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; [label=&quot;hwloc@2.11.1%gcc@=14.2.0/jos53cy&quot;]
  &quot;22aex3evxghc7zlrd4ii72vecl3fhwsi&quot; [label=&quot;libedit@3.1-20240808%gcc@=14.2.0/22aex3e&quot;]
  &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot; [label=&quot;zlib-ng@2.2.1%gcc@=14.2.0/5f2j4la&quot;]
  &quot;oqjcv7vqlpbrpfemlhmharylgbareu32&quot; [label=&quot;libsigsegv@2.14%gcc@=14.2.0/oqjcv7v&quot;]
  &quot;uebccbglvbxb22jkaw2htmo4s7ameqtr&quot; [label=&quot;findutils@4.9.0%gcc@=14.2.0/uebccbg&quot;]
  &quot;mratvknhe7mq5zfgzugmy2u2rk7g4prl&quot; [label=&quot;zstd@1.5.6%gcc@=14.2.0/mratvkn&quot;]
  &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot; [label=&quot;libtool@2.4.7%gcc@=14.2.0/rtc6l4l&quot;]
  &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot; [label=&quot;ncurses@6.5%gcc@=14.2.0/y7tmbwn&quot;]
  &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot; [label=&quot;cmake@3.30.5%gcc@=14.2.0/waqqngz&quot;]
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; [label=&quot;perl@5.40.0%gcc@=14.2.0/hydwfvq&quot;]
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; [label=&quot;krb5@1.21.3%gcc@=14.2.0/nj7nyc2&quot;]
  &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot; [label=&quot;m4@1.4.19%gcc@=14.2.0/rndyocu&quot;]
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; [label=&quot;libxml2@2.13.4%gcc@=14.2.0/6kybx6b&quot;]
  &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot; [label=&quot;gcc-runtime@14.2.0%gcc@=14.2.0/oe3t54k&quot;]
  &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot; [label=&quot;autoconf@2.72%gcc@=14.2.0/gtwt2yv&quot;]
  &quot;xwaivymsb2r5rxvppl565uoye5snr3es&quot; [label=&quot;bison@3.8.2%gcc@=14.2.0/xwaivym&quot;]
  &quot;yibguy5rkzdozonc3m4biqqs5ywgp5ty&quot; [label=&quot;nghttp2@1.63.0%gcc@=14.2.0/yibguy5&quot;]
  &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot; [label=&quot;glibc@2.39%gcc@=14.2.0/zcm2goi&quot;]
  &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot; [label=&quot;gmake@4.4.1%gcc@=14.2.0/5s4jmbz&quot;]
  &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot; [label=&quot;pkgconf@2.2.0%gcc@=14.2.0/2s2fcky&quot;]
  &quot;qsekmpr3jz5cs3lzbsfthonkdwt6ed26&quot; [label=&quot;util-macros@1.20.1%gcc@=14.2.0/qsekmpr&quot;]
  &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot; [label=&quot;diffutils@3.10%gcc@=14.2.0/t2urhi7&quot;]
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; [label=&quot;tar@1.34%gcc@=14.2.0/bqowyzl&quot;]
  &quot;fiyfoue3cksmftnl2u72ckgjisqe7a3u&quot; [label=&quot;ca-certificates-mozilla@2023-05-30%gcc@=14.2.0/fiyfoue&quot;]
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; [label=&quot;curl@8.10.1%gcc@=14.2.0/7juqacd&quot;]
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; -&gt; &quot;kq3rfij4vufcj2ef3dkwtqw37cs6zwfm&quot;
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;yibguy5rkzdozonc3m4biqqs5ywgp5ty&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot; -&gt; &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot;
  &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;fiyfoue3cksmftnl2u72ckgjisqe7a3u&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; -&gt; &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot;
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; -&gt; &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot;
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot;
  &quot;hprrocgasm6bja7tgccshpywn6pcazyl&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; -&gt; &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot;
  &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;yibguy5rkzdozonc3m4biqqs5ywgp5ty&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;mratvknhe7mq5zfgzugmy2u2rk7g4prl&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; -&gt; &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot;
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;bqfx45amenwrxfajcm4rfnfw2yao7z44&quot;
  &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;mt2zasm5w6tjup32zrzyn2nv7txrjp2j&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;hprrocgasm6bja7tgccshpywn6pcazyl&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot;
  &quot;mratvknhe7mq5zfgzugmy2u2rk7g4prl&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;mratvknhe7mq5zfgzugmy2u2rk7g4prl&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot;
  &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;xwaivymsb2r5rxvppl565uoye5snr3es&quot;
  &quot;hprrocgasm6bja7tgccshpywn6pcazyl&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;63gap6vc37lccrqq66f5jjnnbteqngun&quot;
  &quot;yibguy5rkzdozonc3m4biqqs5ywgp5ty&quot; -&gt; &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot;
  &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;kq3rfij4vufcj2ef3dkwtqw37cs6zwfm&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot; -&gt; &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot;
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; -&gt; &quot;mt2zasm5w6tjup32zrzyn2nv7txrjp2j&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot;
  &quot;xwaivymsb2r5rxvppl565uoye5snr3es&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; -&gt; &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot;
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; -&gt; &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot;
  &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;fiyfoue3cksmftnl2u72ckgjisqe7a3u&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot;
  &quot;xwaivymsb2r5rxvppl565uoye5snr3es&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;xwaivymsb2r5rxvppl565uoye5snr3es&quot; -&gt; &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot;
  &quot;f5zgaz576a2zojjyuaz3ymnzvstzborx&quot; -&gt; &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot;
  &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot;
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;63gap6vc37lccrqq66f5jjnnbteqngun&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot; -&gt; &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot;
  &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot; -&gt; &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot;
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot; -&gt; &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot;
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; -&gt; &quot;63gap6vc37lccrqq66f5jjnnbteqngun&quot;
  &quot;mt2zasm5w6tjup32zrzyn2nv7txrjp2j&quot; -&gt; &quot;f5zgaz576a2zojjyuaz3ymnzvstzborx&quot;
  &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;22aex3evxghc7zlrd4ii72vecl3fhwsi&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot; -&gt; &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot;
  &quot;63gap6vc37lccrqq66f5jjnnbteqngun&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot; -&gt; &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot;
  &quot;bqfx45amenwrxfajcm4rfnfw2yao7z44&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;mt2zasm5w6tjup32zrzyn2nv7txrjp2j&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot;
  &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;zqxst36kwhj3wiiumkqs42gveclftzhq&quot;
  &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;22aex3evxghc7zlrd4ii72vecl3fhwsi&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;63gap6vc37lccrqq66f5jjnnbteqngun&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;bqfx45amenwrxfajcm4rfnfw2yao7z44&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;63gap6vc37lccrqq66f5jjnnbteqngun&quot;
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; -&gt; &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot;
  &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;22aex3evxghc7zlrd4ii72vecl3fhwsi&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot; -&gt; &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot;
  &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; -&gt; &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot;
  &quot;uebccbglvbxb22jkaw2htmo4s7ameqtr&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;gtwt2yvmnz5bs6k34vhxez6cwsoh6jxo&quot;
  &quot;bqfx45amenwrxfajcm4rfnfw2yao7z44&quot; -&gt; &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot;
  &quot;swbcislx4vo7mlyfmry6m2gd2frhinba&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;qsekmpr3jz5cs3lzbsfthonkdwt6ed26&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;22aex3evxghc7zlrd4ii72vecl3fhwsi&quot;
  &quot;uebccbglvbxb22jkaw2htmo4s7ameqtr&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;qsekmpr3jz5cs3lzbsfthonkdwt6ed26&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;swbcislx4vo7mlyfmry6m2gd2frhinba&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;hprrocgasm6bja7tgccshpywn6pcazyl&quot;
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;ekkauhemcjnbznl4pwso3ujxqx3osr5y&quot;
  &quot;uebccbglvbxb22jkaw2htmo4s7ameqtr&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;uebccbglvbxb22jkaw2htmo4s7ameqtr&quot;
  &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot; -&gt; &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot;
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; -&gt; &quot;vheoxfbu5djx4pkkuvyjtf64ozjzaowr&quot;
  &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;xwaivymsb2r5rxvppl565uoye5snr3es&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot; -&gt; &quot;fiyfoue3cksmftnl2u72ckgjisqe7a3u&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot;
  &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;bqfx45amenwrxfajcm4rfnfw2yao7z44&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot;
  &quot;yibguy5rkzdozonc3m4biqqs5ywgp5ty&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; -&gt; &quot;yibguy5rkzdozonc3m4biqqs5ywgp5ty&quot;
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot; -&gt; &quot;oqjcv7vqlpbrpfemlhmharylgbareu32&quot;
  &quot;22aex3evxghc7zlrd4ii72vecl3fhwsi&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;hydwfvqvkg3wsulz3n7wdjljlpewu5f4&quot; -&gt; &quot;swbcislx4vo7mlyfmry6m2gd2frhinba&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;vheoxfbu5djx4pkkuvyjtf64ozjzaowr&quot;
  &quot;kq3rfij4vufcj2ef3dkwtqw37cs6zwfm&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;xwaivymsb2r5rxvppl565uoye5snr3es&quot; -&gt; &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot;
  &quot;qsekmpr3jz5cs3lzbsfthonkdwt6ed26&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;swbcislx4vo7mlyfmry6m2gd2frhinba&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;kq3rfij4vufcj2ef3dkwtqw37cs6zwfm&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot;
  &quot;f5zgaz576a2zojjyuaz3ymnzvstzborx&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;rk2kv5qjnszkza3q6karx6mncxr2y4pe&quot; -&gt; &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot;
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; -&gt; &quot;6kybx6b5xuco3gfby63eak3vlmczclxa&quot;
  &quot;f5zgaz576a2zojjyuaz3ymnzvstzborx&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;rtc6l4l63xyonwbip6i7dgwx4hk3z3zh&quot; -&gt; &quot;uebccbglvbxb22jkaw2htmo4s7ameqtr&quot;
  &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot; -&gt; &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot;
  &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;vheoxfbu5djx4pkkuvyjtf64ozjzaowr&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot; -&gt; &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot;
  &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;vheoxfbu5djx4pkkuvyjtf64ozjzaowr&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot; -&gt; &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;mratvknhe7mq5zfgzugmy2u2rk7g4prl&quot;
  &quot;vheoxfbu5djx4pkkuvyjtf64ozjzaowr&quot; -&gt; &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot;
  &quot;yibguy5rkzdozonc3m4biqqs5ywgp5ty&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; -&gt; &quot;waqqngzzlwxunprncvsrvmmso6son4pz&quot;
  &quot;vheoxfbu5djx4pkkuvyjtf64ozjzaowr&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;jos53cymz7mginqnuvkcsk5uc5afykws&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot; -&gt; &quot;74gluthbsesw5q2imbzrf55ije5mxqcb&quot;
  &quot;mt2zasm5w6tjup32zrzyn2nv7txrjp2j&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;rurjepz5om6xoylu65zf7ozyctzozycs&quot;
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;zoxh6545m7h4larv4rsrlcmu3grqruww&quot;
  &quot;kq3rfij4vufcj2ef3dkwtqw37cs6zwfm&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;y6e4nsodrkxfxokkw63k5dav7f4kvcsc&quot; -&gt; &quot;hdmt67nugbjb6v6fhqpqsw24byvyp5ed&quot;
  &quot;bqowyzlrevd32b25a55lnw4nwkw5ahjg&quot; -&gt; &quot;kucl3bpkfsh22pdkpmpbxk26j36klp22&quot;
  &quot;oqjcv7vqlpbrpfemlhmharylgbareu32&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;nj7nyc2ijmzwyikqhpdhizcjd4lzvvfb&quot; -&gt; &quot;t2urhi7txzjmos5jn52vfdtd5qejh3kf&quot;
  &quot;f5zgaz576a2zojjyuaz3ymnzvstzborx&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;oqjcv7vqlpbrpfemlhmharylgbareu32&quot; -&gt; &quot;5s4jmbz2ec75kuj4qvuqvvrfyewtr5ox&quot;
  &quot;3xa4j2nb7sydvhezrjt57ojdam2qd42h&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;
  &quot;kq3rfij4vufcj2ef3dkwtqw37cs6zwfm&quot; -&gt; &quot;qsekmpr3jz5cs3lzbsfthonkdwt6ed26&quot;
  &quot;22aex3evxghc7zlrd4ii72vecl3fhwsi&quot; -&gt; &quot;y7tmbwnu672wuqqfw4uovwblnu7uylgh&quot;
  &quot;rndyocuaisleuhf4kqk5fnpdjlz4sxnj&quot; -&gt; &quot;zcm2goisve7xqbb553kkeyn2crvogkyg&quot;
  &quot;7juqacd3dlis2wj6jp46r2ouziz3ikaf&quot; -&gt; &quot;2s2fckyulkorykt5zhnx3n7uahob2b6i&quot;
  &quot;hprrocgasm6bja7tgccshpywn6pcazyl&quot; -&gt; &quot;5f2j4latd4nlimjrabgzryrwiy46qubh&quot;
  &quot;oqjcv7vqlpbrpfemlhmharylgbareu32&quot; -&gt; &quot;oe3t54k6mqrokqfretfi4a5kfazpli5c&quot;

}
</pre></div>
</div>
<p>This graph can be provided as input to other graphing tools, such as
those in <a class="reference external" href="http://www.graphviz.org">Graphviz</a>.  If you have graphviz
installed, you can write straight to PDF like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>graph<span class="w"> </span>--dot<span class="w"> </span>hdf5<span class="w"> </span><span class="p">|</span><span class="w"> </span>dot<span class="w"> </span>-Tpdf<span class="w"> </span>&gt;<span class="w"> </span>hdf5.pdf
</pre></div>
</div>
</section>
</section>
<section id="interactive-shell-support">
<span id="packaging-shell-support"></span><h2>Interactive shell support<a class="headerlink" href="#interactive-shell-support" title="Link to this heading"></a></h2>
<p>Spack provides some limited shell support to make life easier for
packagers.  You can enable these commands by sourcing a setup file in
the <code class="docutils literal notranslate"><span class="pre">share/spack</span></code> directory.  For <code class="docutils literal notranslate"><span class="pre">bash</span></code> or <code class="docutils literal notranslate"><span class="pre">ksh</span></code>, run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">SPACK_ROOT</span><span class="o">=</span>/path/to/spack
.<span class="w"> </span><span class="nv">$SPACK_ROOT</span>/share/spack/setup-env.sh
</pre></div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">csh</span></code> and <code class="docutils literal notranslate"><span class="pre">tcsh</span></code> run:</p>
<div class="highlight-csh notranslate"><div class="highlight"><pre><span></span><span class="nb">setenv </span>SPACK_ROOT /path/to/spack
<span class="nb">source</span> <span class="nv">$SPACK_ROOT</span>/share/spack/setup-env.csh
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">cd</span></code> will then be available.</p>
<section id="spack-cd">
<span id="cmd-spack-cd"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">cd</span></code><a class="headerlink" href="#spack-cd" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">cd</span></code> allows you to quickly cd to pertinent directories in Spack.
Suppose you’ve staged a package but you want to modify it before you
build it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>stage<span class="w"> </span>libelf
<span class="go">==&gt; Trying to fetch from http://www.mr511.de/software/libelf-0.8.13.tar.gz</span>
<span class="gp">#</span><span class="c1">####################################################################### 100.0%</span>
<span class="go">==&gt; Staging archive: ~/spack/var/spack/stage/libelf@0.8.13%gcc@4.8.3 arch=linux-debian7-x86_64/libelf-0.8.13.tar.gz</span>
<span class="go">==&gt; Created stage in ~/spack/var/spack/stage/libelf@0.8.13%gcc@4.8.3 arch=linux-debian7-x86_64.</span>
<span class="gp">$ </span>spack<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>libelf
<span class="gp">$ </span><span class="nb">pwd</span>
<span class="go">~/spack/var/spack/stage/libelf@0.8.13%gcc@4.8.3 arch=linux-debian7-x86_64/libelf-0.8.13</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">cd</span></code> here changed the current working directory to the
directory containing the expanded <code class="docutils literal notranslate"><span class="pre">libelf</span></code> source code.  There are a
number of other places you can cd to in the spack directory hierarchy:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ spack cd --help
usage: spack cd [-h] [-m | -r | -i | -p | -P | -s | -S | -c | -b | -e [name]] [--first] ...

cd to spack directories in the shell

positional arguments:
  spec               package spec

options:
  --first            use the first match if multiple packages match the spec
  -P, --packages     top-level packages directory for Spack
  -S, --stages       top level stage directory
  -b, --build-dir    build directory for a spec (requires it to be staged first)
  -c, --source-dir   source directory for a spec (requires it to be staged first)
  -e, --env [name]   location of the named or current environment
  -h, --help         show this help message and exit
  -i, --install-dir  install prefix for spec (spec need not be installed)
  -m, --module-dir   spack python module directory
  -p, --package-dir  directory enclosing a spec&#39;s package.py file
  -r, --spack-root   spack installation root
  -s, --stage-dir    stage directory for a spec
</pre></div>
</div>
<p>Some of these change directory into package-specific locations (stage
directory, install directory, package directory) and others change to
core spack locations.  For example, <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">cd</span> <span class="pre">--module-dir</span></code> will take you to
the main python source directory of your spack install.</p>
</section>
<section id="spack-build-env">
<span id="cmd-spack-build-env"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">build-env</span></code><a class="headerlink" href="#spack-build-env" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">build-env</span></code> functions much like the standard unix <code class="docutils literal notranslate"><span class="pre">build-env</span></code>
command, but it takes a spec as an argument.  You can use it to see the
environment variables that will be set when a particular build runs,
for example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>build-env<span class="w"> </span>mpileaks@1.1%intel
</pre></div>
</div>
<p>This will display the entire environment that will be set when the
<code class="docutils literal notranslate"><span class="pre">mpileaks&#64;1.1%intel</span></code> build runs.</p>
<p>To run commands in a package’s build environment, you can simply
provide them after the spec argument to <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">build-env</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>mpileaks@1.1%intel
<span class="gp">$ </span>spack<span class="w"> </span>build-env<span class="w"> </span>mpileaks@1.1%intel<span class="w"> </span>./configure
</pre></div>
</div>
<p>This will cd to the build directory and then run <code class="docutils literal notranslate"><span class="pre">configure</span></code> in the
package’s build environment.</p>
</section>
<section id="spack-location">
<span id="cmd-spack-location"></span><h3><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">location</span></code><a class="headerlink" href="#spack-location" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">location</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">cd</span></code> but it does not require
shell support.  It simply prints out the path you ask for, rather than
cd’ing to it.  In bash, this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="k">$(</span>spack<span class="w"> </span>location<span class="w"> </span>--build-dir<span class="w"> </span>&lt;spec&gt;<span class="k">)</span>
</pre></div>
</div>
<p>is the same as:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>--build-dir<span class="w"> </span>&lt;spec&gt;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">location</span></code> is intended for use in scripts or makefiles that
need to know where packages are installed.  e.g., in a makefile you
might write:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">DWARF_PREFIX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>spack<span class="w"> </span>location<span class="w"> </span>--install-dir<span class="w"> </span>libdwarf<span class="k">)</span>
<span class="nv">CXXFLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-I<span class="nv">$DWARF_PREFIX</span>/include
<span class="nv">CXXFLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-L<span class="nv">$DWARF_PREFIX</span>/lib
</pre></div>
</div>
</section>
</section>
<section id="specifying-abi-compatibility">
<span id="abi-compatibility"></span><h2>Specifying ABI Compatibility<a class="headerlink" href="#specifying-abi-compatibility" title="Link to this heading"></a></h2>
<p>Packages can include ABI-compatibility information using the
<code class="docutils literal notranslate"><span class="pre">can_splice</span></code> directive. For example, if <code class="docutils literal notranslate"><span class="pre">Foo</span></code> version 1.1 can
always replace version 1.0, then the package could have:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">can_splice</span><span class="p">(</span><span class="s2">&quot;foo@1.0&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.1&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For virtual packages, packages can also specify ABI-compabitiliby with
other packages providing the same virtual. For example, <code class="docutils literal notranslate"><span class="pre">zlib-ng</span></code>
could specify:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">can_splice</span><span class="p">(</span><span class="s2">&quot;zlib@1.3.1&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@2.2+compat&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Some packages have ABI-compatibility that is dependent on matching
variant values, either for all variants or for some set of
ABI-relevant variants. In those cases, it is not necessary to specify
the full combinatorial explosion. The <code class="docutils literal notranslate"><span class="pre">match_variants</span></code> keyword can
cover all single-value variants.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">can_splice</span><span class="p">(</span><span class="s2">&quot;foo@1.1&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.2&quot;</span><span class="p">,</span> <span class="n">match_variants</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">])</span>  <span class="c1"># any value for bar as long as they&#39;re the same</span>
<span class="n">can_splice</span><span class="p">(</span><span class="s2">&quot;foo@1.2&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@1.3&quot;</span><span class="p">,</span> <span class="n">match_variants</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>  <span class="c1"># any variant values if all single-value variants match</span>
</pre></div>
</div>
<p>The concretizer will use ABI compatibility to determine automatic
splices when <a class="reference internal" href="build_settings.html#automatic-splicing"><span class="std std-ref">automatic splicing</span></a> is enabled.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">can_splice</span></code> directive is experimental, and may be replaced
by a higher-level interface in future versions of Spack.</p>
</div>
</section>
<section id="package-class-architecture">
<span id="package-class-structure"></span><h2>Package class architecture<a class="headerlink" href="#package-class-architecture" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section aims to provide a high-level knowledge of how the package class architecture evolved
in Spack, and provides some insights on the current design.</p>
</div>
<p>Packages in Spack were originally designed to support only a single build system. The overall
class structure for a package looked like:</p>
<a class="reference internal image-reference" href="_images/original_package_architecture.png"><img alt="_images/original_package_architecture.png" class="align-center" src="_images/original_package_architecture.png" style="width: 531.0px; height: 203.4px;" />
</a>
<p>In this architecture the base class <code class="docutils literal notranslate"><span class="pre">AutotoolsPackage</span></code> was responsible for both the metadata
related to the <code class="docutils literal notranslate"><span class="pre">autotools</span></code> build system (e.g. dependencies or variants common to all packages
using it), and for encoding the default installation procedure.</p>
<p>In reality, a non-negligible number of packages are either changing their build system during the evolution of the
project, or using different build systems for different platforms. An architecture based on a single class
requires hacks or other workarounds to deal with these cases.</p>
<p>To support a model more adherent to reality, Spack v0.19 changed its internal design by extracting
the attributes and methods related to building a software into a separate hierarchy:</p>
<a class="reference internal image-reference" href="_images/builder_package_architecture.png"><img alt="_images/builder_package_architecture.png" class="align-center" src="_images/builder_package_architecture.png" style="width: 599.4px; height: 276.0px;" />
</a>
<p>In this new format each <code class="docutils literal notranslate"><span class="pre">package.py</span></code> contains one <code class="docutils literal notranslate"><span class="pre">*Package</span></code> class that gathers all the metadata,
and one or more <code class="docutils literal notranslate"><span class="pre">*Builder</span></code> classes that encode the installation procedure. A specific builder object
is created just before the software is built, so at a time where Spack knows which build system needs
to be used for the current installation, and receives a <code class="docutils literal notranslate"><span class="pre">package</span></code> object during initialization.</p>
<section id="build-system-variant">
<h3><code class="docutils literal notranslate"><span class="pre">build_system</span></code> variant<a class="headerlink" href="#build-system-variant" title="Link to this heading"></a></h3>
<p>To allow imposing conditions based on the build system, each package must a have <code class="docutils literal notranslate"><span class="pre">build_system</span></code> variant,
which is usually inherited from base classes. This variant allows for writing metadata that is conditional
on the build system:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">when</span><span class="p">(</span><span class="s2">&quot;build_system=cmake&quot;</span><span class="p">):</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s2">&quot;cmake&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and also for selecting a specific build system from a spec literal, like in the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spack<span class="w"> </span>install<span class="w"> </span>arpack-ng<span class="w"> </span><span class="nv">build_system</span><span class="o">=</span>autotools
</pre></div>
</div>
</section>
<section id="compatibility-with-single-class-format">
<h3>Compatibility with single-class format<a class="headerlink" href="#compatibility-with-single-class-format" title="Link to this heading"></a></h3>
<p>Internally, Spack always uses builders to perform operations related to the installation of a specific software.
The builders are created in the <code class="docutils literal notranslate"><span class="pre">spack.builder.create</span></code> function</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a package object with an associated concrete spec,</span>
<span class="sd">    return the builder object that can install it.</span>

<span class="sd">    Args:</span>
<span class="sd">         pkg (spack.package_base.PackageBase): package for which we want the builder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_BUILDERS</span><span class="p">:</span>
        <span class="n">_BUILDERS</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">pkg</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_create</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_BUILDERS</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">pkg</span><span class="p">)]</span>
</pre></div>
</div>
<p>To achieve backward compatibility with the single-class format Spack creates in this function a special
“adapter builder”, if no custom builder is detected in the recipe:</p>
<a class="reference internal image-reference" href="_images/adapter.png"><img alt="_images/adapter.png" class="align-center" src="_images/adapter.png" style="width: 634.1999999999999px; height: 487.2px;" />
</a>
<p>Overall the role of the adapter is to route access to attributes of methods first through the <code class="docutils literal notranslate"><span class="pre">*Package</span></code>
hierarchy, and then back to the base class builder. This is schematically shown in the diagram above, where
the adapter role is to “emulate” a method resolution order like the one represented by the red arrows.</p>
</section>
</section>
<section id="specifying-license-information">
<h2>Specifying License Information<a class="headerlink" href="#specifying-license-information" title="Link to this heading"></a></h2>
<p>Most of the software in Spack is open source, and most open source software is released
under one or more <a class="reference external" href="https://opensource.org/licenses/">common open source licenses</a>.
Specifying the license that a package is released under in a project’s
<cite>package.py</cite> is good practice. To specify a license, find the <a class="reference external" href="https://spdx.org/licenses/">SPDX identifier</a> for a project and then add it using the license
directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">license</span><span class="p">(</span><span class="s2">&quot;&lt;SPDX Identifier HERE&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, the SPDX ID for the Apache Software License, version 2.0 is <code class="docutils literal notranslate"><span class="pre">Apache-2.0</span></code>,
so you’d write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">license</span><span class="p">(</span><span class="s2">&quot;Apache-2.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or, for a dual-licensed package like Spack, you would use an <a class="reference external" href="https://spdx.github.io/spdx-spec/v2-draft/SPDX-license-expressions/">SPDX Expression</a> with both of its
licenses:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">license</span><span class="p">(</span><span class="s2">&quot;Apache-2.0 OR MIT&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that specifying a license without a when clause makes it apply to all
versions and variants of the package, which might not actually be the case.
For example, a project might have switched licenses at some point or have
certain build configurations that include files that are licensed differently.
Spack itself used to be under the <code class="docutils literal notranslate"><span class="pre">LGPL-2.1</span></code> license, until it was relicensed
in version <code class="docutils literal notranslate"><span class="pre">0.12</span></code> in 2018.</p>
<p>You can specify when a <code class="docutils literal notranslate"><span class="pre">license()</span></code> directive applies using with a <code class="docutils literal notranslate"><span class="pre">when=</span></code>
clause, just like other directives. For example, to specify that a specific
license identifier should only apply to versions up to <code class="docutils literal notranslate"><span class="pre">0.11</span></code>, but another
license should apply for later versions, you could write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">license</span><span class="p">(</span><span class="s2">&quot;LGPL-2.1&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@:0.11&quot;</span><span class="p">)</span>
<span class="n">license</span><span class="p">(</span><span class="s2">&quot;Apache-2.0 OR MIT&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;@0.12:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that unlike for most other directives, the <code class="docutils literal notranslate"><span class="pre">when=</span></code> constraints in the
<code class="docutils literal notranslate"><span class="pre">license()</span></code> directive can’t intersect. Spack needs to be able to resolve
exactly one license identifier expression for any given version. To specify
<em>multiple</em> licenses, use SPDX expressions and operators as above. The operators
you probably care most about are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OR</span></code>: user chooses one license to adhere to; and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AND</span></code>: user has to adhere to all the licenses.</p></li>
</ul>
<p>You may also care about <a class="reference external" href="https://spdx.org/licenses/exceptions-index.html">license exceptions</a> that use the <code class="docutils literal notranslate"><span class="pre">WITH</span></code> operator,
e.g. <code class="docutils literal notranslate"><span class="pre">Apache-2.0</span> <span class="pre">WITH</span> <span class="pre">LLVM-exception</span></code>.</p>
<p>Many of the licenses that are currently in the spack repositories have been
automatically determined. While this is great for bulk adding license
information and is most likely correct, there are sometimes edge cases that
require manual intervention. To determine which licenses are validated and
which are not, there is the <cite>checked_by</cite> parameter in the license directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">license</span><span class="p">(</span><span class="s2">&quot;&lt;license&gt;&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;&lt;when&gt;&quot;</span><span class="p">,</span> <span class="n">checked_by</span><span class="o">=</span><span class="s2">&quot;&lt;github username&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When you have validated a github license, either when doing so explicitly or
as part of packaging a new package, please set the <cite>checked_by</cite> parameter
to your Github username to signal that the license has been manually
verified.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="contribution_guide.html" class="btn btn-neutral float-left" title="Contribution Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="build_systems.html" class="btn btn-neutral float-right" title="Build Systems" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2023, Lawrence Livermore National Laboratory..
      <span class="lastupdated">Last updated on Sep 20, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>